<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Year 9 Python Programming</title>
    
    <!-- CodeMirror CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
    
    <!-- CodeMirror JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/matchbrackets.min.js"></script>
    
    <style>
        :root {
            --primary-color: #0d6efd;
            --primary-dark: #0a58ca;
            --primary-light: #cfe2ff;
            --success-color: #198754;
            --warning-color: #ffc107;
            --error-color: #dc3545;
            --xp-color: #ffc107;
            --bg-primary: #f8f9fa;
            --bg-secondary: white;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        /* Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* Allow selection for specific elements */
        .CodeMirror, textarea, input, .allow-select {
            -webkit-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }

        /* Header */
        .header {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            padding: 1rem 2rem;
            box-shadow: var(--shadow-md);
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 { font-size: 1.75rem; }
        .header p { color: var(--text-secondary); margin: 0; }
        
        .xp-display {
            background-color: var(--xp-color);
            color: var(--text-primary);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 1.1rem;
            box-shadow: var(--shadow-sm);
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .modal-overlay.show .modal-content {
            transform: scale(1);
        }
        .modal-content h2 {
            margin-bottom: 1rem;
        }
        .modal-content p {
            margin-bottom: 1.5rem;
            color: var(--text-secondary);
            text-align: left;
        }
         .modal-content ul {
            text-align: left;
            margin-left: 1.5rem;
            margin-bottom: 1.5rem;
        }

        /* Main Container */
        .main-container {
            max-width: 1600px;
            margin: 1.5rem auto;
            padding: 0 1.5rem;
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 1.5rem;
            align-items: flex-start;
        }

        /* Sidebar */
        .sidebar {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 1rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            position: sticky;
            top: 100px;
            max-height: calc(100vh - 120px);
            overflow-y: auto;
        }

        .section-header {
            font-size: 1.2rem;
            font-weight: 600;
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .section-header:hover { background-color: #e9ecef; }
        .section-arrow { transition: transform 0.2s ease-in-out; }
        .section-arrow.open { transform: rotate(90deg); }

        .task-list {
            list-style: none;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }

        .task-list.open {
            max-height: 1000px;
        }
        
        .task-item {
            padding: 0.6rem 1rem;
            margin-left: 1rem;
            margin-bottom: 0.25rem;
            border-left: 3px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.95rem;
        }

        .task-item:hover { background: var(--primary-light); }
        .task-item.active {
            background: var(--primary-color);
            color: white;
            border-left-color: var(--primary-dark);
            font-weight: 500;
        }
        .task-item-status { font-size: 0.8rem; }
        .task-item.completed .task-item-status::before { content: '✔'; color: var(--success-color); }
        
        .export-button-container {
            padding: 1rem;
            border-top: 1px solid var(--border-color);
            margin-top: 1rem;
        }

        /* Content Area */
        .content {
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
            min-height: 600px;
            padding: 1.5rem 2rem;
        }

        .task-header {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .task-title { font-size: 1.5rem; font-weight: 600; }
        
        .instructions h3 {
            font-size: 1.1rem;
            margin: 1.25rem 0 0.5rem 0;
            color: var(--text-primary);
        }
        .instructions ul { margin-left: 1.5rem; }
        .instructions code {
            background-color: #e9ecef;
            padding: 0.2em 0.4em;
            margin: 0;
            font-size: 85%;
            border-radius: 3px;
            font-family: 'Courier New', Courier, monospace;
        }

        .editor-container { margin: 1.5rem 0; }
        .editor-header {
            background: #343a40;
            color: white;
            padding: 0.5rem 1rem;
            border-top-left-radius: 6px;
            border-top-right-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .CodeMirror { 
            height: 300px; 
            border: 1px solid #343a40; 
            border-bottom-left-radius: 6px; 
            border-bottom-right-radius: 6px;
        }

        .output-panel { margin-top: 1rem; }
        .output-header { font-weight: 500; margin-bottom: 0.5rem; }
        .output-content {
            padding: 1rem;
            font-family: 'Courier New', monospace;
            min-height: 100px;
            background: #212529;
            color: #f8f9fa;
            border-radius: 6px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .output-content.error { color: #ff8a8a; }
        .loading { color: var(--text-secondary); }

        .controls { display: flex; gap: 0.75rem; margin-top: 1.5rem; flex-wrap: wrap; }
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            color: white;
            border: 1px solid transparent;
        }
        .btn-primary { background-color: var(--primary-color); border-color: var(--primary-color); }
        .btn-primary:hover { background-color: var(--primary-dark); border-color: var(--primary-dark); }
        .btn-secondary { background-color: #6c757d; border-color: #6c757d; color: white; }
        .btn-secondary:hover { background-color: #5c636a; }
        .btn-success { background-color: var(--success-color); border-color: var(--success-color); }
        .btn-success:hover { background-color: #157347; }
        .btn-warning { background-color: var(--warning-color); border-color: var(--warning-color); color: var(--text-primary); }
        .btn-warning:hover { background-color: #ffca2c; }

        .hint-box {
            background: #fff3cd;
            border: 1px solid #ffeeba;
            color: #664d03;
            border-radius: 6px;
            padding: 1rem;
            margin: 1.5rem 0;
            display: none;
        }
        .hint-box.show { display: block; }
        .hint-box h4 { margin: 0 0 0.5rem 0; }

        .checks-container { margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color); }
        .check-item {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding: 1rem;
            border-radius: 6px;
            border-left: 5px solid;
        }
        .check-item.passed { background-color: #d1e7dd; border-left-color: var(--success-color); }
        .check-item.failed { background-color: #f8d7da; border-left-color: var(--error-color); }
        
        .check-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 600;
        }
        .check-icon { width: 20px; height: 20px; font-weight: bold; text-align: center; }
        .check-icon.passed { color: var(--success-color); }
        .check-icon.failed { color: var(--error-color); }
        .check-description { flex-grow: 1; }
        
        .check-details {
            width: 100%;
            padding-left: 27px; /* Align with header text */
            font-size: 0.9em;
            display: none; /* Hidden by default */
        }
        .check-details code {
             background-color: #e9ecef;
            padding: 0.2em 0.4em;
            border-radius: 3px;
            font-family: 'Courier New', Courier, monospace;
            white-space: pre-wrap;
            display: block;
            margin-top: 0.5rem;
        }
        .check-details strong {
            display: block;
            margin-top: 0.5rem;
        }

        
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background-color: #343a40;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 6px;
            box-shadow: var(--shadow-md);
            opacity: 0;
            visibility: hidden;
            transform: translateY(20px);
            transition: all 0.3s ease-in-out;
            z-index: 2000;
        }
        .toast.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .test-info-box {
            background-color: #e3f2fd;
            border: 1px solid #90caf9;
            color: #0d47a1;
            border-radius: 6px;
            padding: 1rem;
            margin: 1rem 0;
            font-size: 0.9rem;
        }
        
        .test-info-box h4 {
            margin: 0 0 0.5rem 0;
            font-size: 1rem;
        }
        
        .section-header.challenge {
            background-color: #e9d8fd;
            border-color: #9b59b6;
        }
        
        .section-header.challenge:hover { 
            background-color: #d7bde2; 
        }

        /* Loading spinner */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 992px) {
            .header {
                flex-direction: column;
                gap: 0.5rem;
            }
            .main-container {
                grid-template-columns: 1fr;
            }
            .sidebar {
                position: static;
                max-height: none;
                margin-bottom: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div id="loading-message" style="text-align: center; padding: 2rem;">
        <h2>Loading Year 9 Programming Project...</h2>
        <div class="spinner"></div>
        <p>Please wait while we set up the environment.</p>
    </div>

    <div id="welcome-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>Welcome to the Python Challenge!</h2>
            <p>Here’s how to get started:</p>
            <ul>
                <li><strong>Select a task</strong> from the sidebar on the left.</li>
                <li><strong>Write your code</strong> in the editor panel.</li>
                <li><strong>Click 'Run'</strong> to see your code's output.</li>
                <li><strong>Click 'Check Solution'</strong> to test your code and earn XP!</li>
            </ul>
            <button id="modal-close-btn" class="btn btn-primary">Let's Go!</button>
        </div>
    </div>
    
    <header class="header" style="display: none;">
        <div>
            <h1>Year 9 Summer Term Programming</h1>
            <p id="header-subtitle">A series of tasks to build your Python skills. Complete them in order!</p>
        </div>
        <div id="xp-display" class="xp-display">XP: 0</div>
    </header>

    <div class="main-container" style="display: none;">
        <aside class="sidebar">
            <div id="sidebar-nav">
                <!-- Navigation will be generated by JavaScript -->
            </div>
        </aside>
        
        <main class="content" id="mainContent">
             <!-- This area is now populated by JavaScript, not with innerHTML replacement -->
        </main>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        'use strict';
        (function() {
            // --- CONSTANTS ---
            const CONSTANTS = {
                LOCAL_STORAGE_KEY: 'y9PythonProgrammingProgress',
                WELCOME_MODAL_SHOWN_KEY: 'y9PythonWelcomeShown',
                CLASS_ACTIVE: 'active',
                CLASS_COMPLETED: 'completed',
                CLASS_OPEN: 'open'
            };

            // --- DATA: Year 9 Programming Tasks ---
            const TASKS = {
                // SECTION 1: The Basics
                '1-1': {
                    section: 1,
                    title: 'Hello, World!',
                    xp: 10,
                    instructions: '<h3>Task: Print a Message</h3><p>The first step in any programming journey is to print "Hello, World!".</p><p>Write a single line of Python code that displays the exact text <code>Hello, World!</code> on the screen.</p><h3>Example Output:</h3><pre>Hello, World!</pre>',
                    starterCode: '',
                    hints: ['You will need to use the print() function.', 'The text you want to print should be inside the parentheses and enclosed in quote marks (e.g. "text").'],
                    testCases: [{ inputs: [], expectedOutput: 'Hello, World!\n' }]
                },
                '1-2': {
                    section: 1,
                    title: 'Personal Greeting',
                    xp: 10,
                    instructions: '<h3>Task: Get User Input</h3><p>Write a program that asks the user for their name and then prints a personalised greeting.</p><h3>Example Interaction:</h3><pre>What is your name? Alice\nHello, Alice!</pre>',
                    starterCode: '',
                    hints: ['Store the result of the input() function in a variable.', 'Use the + operator or an f-string to join "Hello, " with the user\'s name and an exclamation mark.'],
                    testCases: [{ inputs: ['Bob'], expectedOutput: 'Hello, Bob!\n' }]
                },
                '1-3': {
                    section: 1,
                    title: 'Rectangle Area',
                    xp: 10,
                    instructions: '<h3>Task: Simple Area Calculator</h3><p>Write a program that calculates the area of a rectangle.</p><ol><li>Ask the user for the width.</li><li>Ask the user for the height.</li><li>Convert the inputs to integers.</li><li>Calculate the area (width * height).</li><li>Print the result in the format "The area is: [area]".</li></ol><h3>Example Output:</h3><pre>The area is: 50</pre>',
                    starterCode: '',
                    hints: ['The input() function returns text (a string). You must convert it to a number using int().', 'Create a new variable for the area, e.g., area = width * height.'],
                    testCases: [{ inputs: ['5', '10'], expectedOutput: 'The area is: 50\n' }]
                },
                '1-4': {
                    section: 1,
                    title: 'Sharing Sweets',
                    xp: 10,
                    instructions: '<h3>Task: Division and Remainders</h3><p>You have 40 sweets to share equally among 6 friends.</p><p>Calculate and print two things:</p><ol><li>How many whole sweets each friend gets.</li><li>How many sweets are left over.</li></ol><h3>Example Output:</h3><pre>Each friend gets 6 sweets.\nThere are 4 sweets left over.</pre>',
                    starterCode: '',
                    hints: ['Integer division // gives only the whole number part (e.g., 10 // 3 is 3).', 'The modulus operator % gives the remainder (e.g., 10 % 3 is 1).'],
                    testCases: [{ inputs: [], expectedOutput: 'Each friend gets 6 sweets.\nThere are 4 sweets left over.\n' }]
                },
                '1-5': {
                    section: 1,
                    title: 'Tip Calculator',
                    xp: 10,
                    instructions: '<h3>Task: Working with Floats</h3><p>Write a program to calculate a 20% tip on a restaurant bill.</p><ol><li>Ask the user for the total bill amount.</li><li>Convert the input to a float (a number with decimals).</li><li>Calculate the tip (bill * 0.20).</li><li>Print the tip amount.</li></ol><h3>Example Output:</h3><pre>The tip is: 10.0</pre>',
                    starterCode: '',
                    hints: ['Use float() to handle decimal numbers.', 'To calculate 20%, you multiply by 0.20.'],
                    testCases: [{ inputs: ['50.00'], expectedOutput: 'The tip is: 10.0\n' }]
                },
                '1-6': {
                    section: 1,
                    title: 'Story Time',
                    xp: 10,
                    instructions: '<h3>Task: Build a Story</h3><p>Create a simple story generator. Ask the user for:</p><ul><li>A person\'s name</li><li>A place</li><li>An adjective (a describing word)</li></ul><p>Then, use their inputs to print a sentence, like: "[Name] went to [Place] and saw a [adjective] monster!".</p><h3>Example Output:</h3><pre>Ada went to the moon and saw a sparkly monster!</pre>',
                    starterCode: '',
                    hints: ['You will need three variables to store the user\'s inputs.', 'Use string concatenation (+) or an f-string to form the final sentence.'],
                    testCases: [{ inputs: ['Ada', 'the moon', 'sparkly'], expectedOutput: 'Ada went to the moon and saw a sparkly monster!\n' }]
                },
                 '1-7': {
                    section: 1,
                    title: 'Powers',
                    xp: 10,
                    instructions: '<h3>Task: To the Power Of</h3><p>Ask the user for a number. Calculate and print the square of that number (the number multiplied by itself).</p><p>Use the exponentiation operator <code>**</code>.</p><h3>Example:</h3><p>If the user enters <code>5</code>, the program should output: <code>25</code>.</p>',
                    starterCode: '',
                    hints: ['The operator for exponentiation (raising to a power) is **.', '`number ** 2` calculates the square.'],
                    testCases: [{ inputs: ['5'], expectedOutput: '25\n' }]
                },
                '1-8': {
                    section: 1,
                    title: 'String Repetition',
                    xp: 10,
                    instructions: '<h3>Task: Repeat a Word</h3><p>Ask the user for a word, and then ask for a number. Repeat the word that many times and print the result.</p><p>You can "multiply" a string by a number in Python!</p><h3>Example:</h3><p>If the user enters <code>Hi</code> and <code>3</code>, it should print <code>HiHiHi</code>.</p>',
                    starterCode: '',
                    hints: ['You can multiply a string by an integer to repeat it.', '`"word" * 3` will result in `"wordwordword"`.'],
                    testCases: [{ inputs: ['Hi', '3'], expectedOutput: 'HiHiHi\n' }]
                },
                // SECTION 2: Selection
                '2-1': {
                    section: 2,
                    title: 'Positive or Negative',
                    xp: 10,
                    instructions: '<h3>Task: Number Check</h3><p>Ask the user to enter a number. Your program should then print "Positive" if the number is greater than 0, "Negative" if it\'s less than 0, and "Zero" if it is exactly 0.</p><h3>Example Output (if user enters 10):</h3><pre>Positive</pre>',
                    starterCode: '',
                    hints: ['You will need an if for the first condition, an elif for the second, and an else for the final case.', 'The condition for checking equality is ==.'],
                    testCases: [
                        { inputs: ['10'], expectedOutput: 'Positive\n' },
                        { inputs: ['-5'], expectedOutput: 'Negative\n' },
                        { inputs: ['0'], expectedOutput: 'Zero\n' }
                    ]
                },
                '2-2': {
                    section: 2,
                    title: 'Rollercoaster Age Check',
                    xp: 10,
                    instructions: '<h3>Task: Are you tall enough?</h3><p>A rollercoaster has an age restriction: you must be 12 or older to ride. Write a program that asks for a user\'s age and prints "Access granted" or "Access denied".</p><h3>Example Output (if user is 15):</h3><pre>Access granted</pre>',
                    starterCode: '',
                    hints: ['The condition is "age is greater than or equal to 12".', 'The operator for "greater than or equal to" is >=.'],
                    testCases: [
                        { inputs: ['15'], expectedOutput: 'Access granted\n' },
                        { inputs: ['12'], expectedOutput: 'Access granted\n' },
                        { inputs: ['11'], expectedOutput: 'Access denied\n' }
                    ]
                },
                '2-3': {
                    section: 2,
                    title: 'Simple Password',
                    xp: 10,
                    instructions: '<h3>Task: Password Checker</h3><p>Write a program that asks for a password. If the user enters the correct password, "python", it should print "Welcome". Otherwise, it should print "Wrong password".</p><h3>Example Output (if password is correct):</h3><pre>Welcome</pre>',
                    starterCode: '',
                    hints: ['You are comparing two strings for equality.', 'The == operator works for strings as well as numbers.'],
                    testCases: [
                        { inputs: ['python'], expectedOutput: 'Welcome\n' },
                        { inputs: ['password'], expectedOutput: 'Wrong password\n' }
                    ]
                },
                '2-4': {
                    section: 2,
                    title: 'Even or Odd',
                    xp: 10,
                    instructions: '<h3>Task: Even or Odd Checker</h3><p>Ask the user for a whole number and determine if it is even or odd.</p><p><strong>Hint:</strong> An even number can be divided by 2 with no remainder. Use the modulus operator (<code>%</code>).</p><h3>Example Output (if user enters 10):</h3><pre>Even</pre>',
                    starterCode: '',
                    hints: ['If number % 2 is equal to 0, the number is even.', 'Otherwise, the number is odd.'],
                    testCases: [
                        { inputs: ['10'], expectedOutput: 'Even\n' },
                        { inputs: ['7'], expectedOutput: 'Odd\n' }
                    ]
                },
                '2-5': {
                    section: 2,
                    title: 'Grading Program',
                    xp: 10,
                    instructions: '<h3>Task: Assign a Grade</h3><p>Write a program that takes a test score (out of 100) and prints the corresponding grade:</p><ul><li>Over 80: "Distinction"</li><li>Over 60: "Merit"</li><li>Over 40: "Pass"</li><li>40 or below: "Fail"</li></ul><h3>Example Output (if score is 95):</h3><pre>Distinction</pre>',
                    starterCode: '',
                    hints: ['Use an if/elif/elif/else structure.', 'The order of your checks is important. Start by checking for the highest grade first.'],
                    testCases: [
                        { inputs: ['95'], expectedOutput: 'Distinction\n' },
                        { inputs: ['72'], expectedOutput: 'Merit\n' },
                        { inputs: ['50'], expectedOutput: 'Pass\n' },
                        { inputs: ['30'], expectedOutput: 'Fail\n' }
                    ]
                },
                 '2-6': {
                    section: 2,
                    title: 'Weekend Check',
                    xp: 10,
                    instructions: '<h3>Task: Weekend or Weekday</h3><p>Ask the user for the day of the week. If the day is "Saturday" OR "Sunday", print "It\'s the weekend!". Otherwise, print "It\'s a weekday."</p><p>This program should work even if the user types "saturday" or "SUNDAY".</p><h3>Example Output (if day is Sunday):</h3><pre>It\'s the weekend!</pre>',
                    starterCode: '',
                    hints: ['Convert the user\'s input to lowercase using `.lower()` before you check it.', 'The condition will look like: if day.lower() == "saturday" or day.lower() == "sunday":'],
                    testCases: [
                        { inputs: ['Sunday'], expectedOutput: "It's the weekend!\n" },
                        { inputs: ['monday'], expectedOutput: "It's a weekday.\n" }
                    ]
                },
                '2-7': {
                    section: 2,
                    title: 'Cinema Entry',
                    xp: 10,
                    instructions: '<h3>Task: AND Operator</h3><p>To watch a scary movie, you must be 15 or older AND have a ticket. Ask the user for their age and if they have a ticket ("yes" or "no"). Grant entry only if BOTH conditions are true.</p><h3>Example Output (if age 16 and has ticket):</h3><pre>Access granted</pre>',
                    starterCode: '',
                    hints: ['You will need two conditions joined by the `and` keyword.', 'The condition will look something like: `if age >= 15 and has_ticket == "yes":`'],
                    testCases: [
                        { inputs: ['16', 'yes'], expectedOutput: 'Access granted\n' },
                        { inputs: ['16', 'no'], expectedOutput: 'Access denied\n' },
                        { inputs: ['14', 'yes'], expectedOutput: 'Access denied\n' }
                    ]
                },
                '2-8': {
                    section: 2,
                    title: 'Theme Park Ride',
                    xp: 10,
                    instructions: '<h3>Task: Nested Selection</h3><p>A theme park ride costs £5. If you have a special wristband, you get £2 off. Ask the user if they have a wristband. Then, ask them how many tickets they want. Calculate the total cost.</p><h3>Example Output (if has wristband and wants 3 tickets):</h3><pre>Total cost: £9</pre>',
                    starterCode: '',
                    hints: ['Start with a base price, e.g., `price = 5`.', 'Use an `if` statement to check for the wristband and adjust the price.', 'Get the number of tickets *after* you know the price per ticket.'],
                    testCases: [
                        { inputs: ['yes', '3'], expectedOutput: 'Total cost: £9\n' },
                        { inputs: ['no', '2'], expectedOutput: 'Total cost: £10\n' }
                    ]
                },
                // SECTION 3: Iteration (Loops)
                '3-1': {
                    section: 3,
                    title: 'FOR Loop: Count to 10',
                    xp: 10,
                    instructions: '<h3>Task: Counting Up</h3><p>Using a <code>for</code> loop and the <code>range()</code> function, write a program that prints the numbers from 1 to 10, each on a new line.</p><h3>Example Output:</h3><pre>1\n2\n3\n4\n5\n6\n7\n8\n9\n10</pre>',
                    starterCode: '',
                    hints: ['range(1, 11) will generate numbers from 1 up to (but not including) 11.', 'The variable in your loop (e.g., i) will hold the current number on each pass.'],
                    testCases: [{ inputs: [], expectedOutput: '1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n' }]
                },
                '3-2': {
                    section: 3,
                    title: 'FOR Loop: Times Table',
                    xp: 10,
                    instructions: '<h3>Task: Create a Times Table</h3><p>Ask the user for a number. Then, using a <code>for</code> loop, print the times table for that number from 1 to 10.</p><h3>Example (for number 5):</h3><pre>5 x 1 = 5\n5 x 2 = 10\n...\n5 x 10 = 50</pre>',
                    starterCode: '',
                    hints: ['Your loop should run from 1 to 10 (use range(1, 11)).', 'Inside the loop, calculate result = num * i and then print all the parts using an f-string or +.'],
                    testCases: [{ inputs: ['3'], expectedOutput: '3 x 1 = 3\n3 x 2 = 6\n3 x 3 = 9\n3 x 4 = 12\n3 x 5 = 15\n3 x 6 = 18\n3 x 7 = 21\n3 x 8 = 24\n3 x 9 = 27\n3 x 10 = 30\n' }]
                },
                '3-3': {
                    section: 3,
                    title: 'FOR Loop: Countdown',
                    xp: 10,
                    instructions: '<h3>Task: Blast Off!</h3><p>The <code>range()</code> function can take a third argument: a "step". A negative step makes it count backwards.</p><p>Use a <code>for</code> loop to print a countdown from 10 down to 1, followed by "Blast off!".</p><h3>Example Output:</h3><pre>10\n9\n8\n7\n6\n5\n4\n3\n2\n1\nBlast off!</pre>',
                    starterCode: '',
                    hints: ['Try using range(10, 0, -1). This starts at 10, stops before 0, and steps by -1.', 'The final print statement should be outside/after the loop.'],
                    testCases: [{ inputs: [], expectedOutput: '10\n9\n8\n7\n6\n5\n4\n3\n2\n1\nBlast off!\n' }]
                },
                 '3-4': {
                    section: 3,
                    title: 'FOR Loop: Summation',
                    xp: 10,
                    instructions: '<h3>Task: Sum of Numbers</h3><p>Using a <code>for</code> loop, calculate the sum of all numbers from 1 to 50 inclusive. Print the final total.</p><h3>Example Output:</h3><pre>1275</pre>',
                    starterCode: '',
                    hints: ['Create a variable called total and set it to 0 before the loop starts.', 'Inside the loop, use total = total + i (or total += i) to accumulate the sum.'],
                    testCases: [{ inputs: [], expectedOutput: '1275\n' }]
                },
                '3-5': {
                    section: 3,
                    title: 'WHILE Loop: Repeater',
                    xp: 10,
                    instructions: '<h3>Task: Repeating Message</h3><p>Use a <code>while</code> loop to print the message "Looping..." 5 times.</p><h3>Example Output:</h3><pre>Looping...\nLooping...\nLooping...\nLooping...\nLooping...</pre>',
                    starterCode: '',
                    hints: ['Create a counter variable and set it to 0 before the loop.', 'The loop condition could be: while counter < 5:', 'Don\'t forget to increase the counter by 1 inside the loop (counter = counter + 1) to avoid an infinite loop!'],
                    testCases: [{ inputs: [], expectedOutput: 'Looping...\nLooping...\nLooping...\nLooping...\nLooping...\n' }]
                },
                '3-6': {
                    section: 3,
                    title: 'WHILE Loop: User Stop',
                    xp: 10,
                    instructions: '<h3>Task: Loop Until "stop"</h3><p>Write a program that repeatedly asks the user for a word and prints it back to them. The loop should only stop when the user types the word "stop".</p><p>Make sure the final "stop" command is not printed.</p><h3>Example Interaction:</h3><pre>Enter a word (or stop): hello\nhello\nEnter a word (or stop): world\nworld\nEnter a word (or stop): stop\n</pre>',
                    starterCode: '',
                    hints: ['The loop condition is: while command != "stop":', 'Inside the loop, get new input from the user.', 'Add an if statement so you don\'t print the final "stop" command: if command != "stop": print(command)'],
                    testCases: [{ inputs: ['hello', 'world', 'stop'], expectedOutput: 'hello\nworld\n' }]
                },
                '3-7': {
                    section: 3,
                    title: 'FizzBuzz Challenge',
                    xp: 10,
                    instructions: '<h3>Task: The FizzBuzz Game</h3><p>This is a classic programming challenge. Write a program that prints the numbers from 1 to 20, but with a twist:</p><ul><li>For multiples of 3, print "Fizz" instead of the number.</li><li>For multiples of 5, print "Buzz" instead of the number.</li><li>For numbers which are multiples of both 3 and 5, print "FizzBuzz".</li></ul><h3>Example Output (first 5 lines):</h3><pre>1\n2\nFizz\n4\nBuzz</pre>',
                    starterCode: '',
                    hints: ['Use the modulus operator % to check for multiples.', 'The condition for "FizzBuzz" (i % 3 == 0 and i % 5 == 0) must be checked FIRST, otherwise it will never run.'],
                    testCases: [{ inputs: [], expectedOutput: '1\n2\nFizz\n4\nBuzz\nFizz\n7\n8\nFizz\nBuzz\n11\nFizz\n13\n14\nFizzBuzz\n16\n17\nFizz\n19\nBuzz\n' }]
                },
                 '3-8': {
                    section: 3,
                    title: 'Guess the Number',
                    xp: 10,
                    instructions: '<h3>Task: Guess the Number Game</h3><p>Create a simple "Guess the Number" game.</p><ol><li>Set a secret number in your code (e.g., 7).</li><li>Use a <code>while</code> loop to let the user keep guessing.</li><li>After each guess, tell the user if their guess was "Too high", "Too low", or "Correct!".</li><li>The loop should end when they guess correctly.</li></ol><h3>Example Interaction (secret number is 7):</h3><pre>Guess a number: 10\nToo high\nGuess a number: 5\nToo low\nGuess a number: 7\nCorrect!</pre>',
                    starterCode: '',
                    hints: ['The while loop condition should be: while guess != secret_number:', 'Inside the loop, get the user\'s input and convert it to an integer.', 'Use an if/elif/else block inside the loop to provide feedback.'],
                    testCases: [{ inputs: ['10', '5', '7'], expectedOutput: 'Too high\nToo low\nCorrect!\n' }]
                },
                '3-9': {
                    section: 3,
                    title: 'Spell It Out',
                    xp: 10,
                    instructions: '<h3>Task: Loop Through a String</h3><p>Ask the user for their name. Using a <code>for</code> loop, print each character of their name on a new line, with each character in uppercase.</p><h3>Example Interaction:</h3><pre>What is your name? Ben\nB\nE\nN</pre>',
                    starterCode: '',
                    hints: ['A `for` loop can iterate directly over a string: `for letter in name:`', 'Inside the loop, use the `.upper()` method on the letter.'],
                    testCases: [{ inputs: ['Ben'], expectedOutput: 'B\nE\nN\n' }]
                },
                '3-10': {
                    section: 3,
                    title: 'Input Validation',
                    xp: 10,
                    instructions: '<h3>Task: Get a Valid Number</h3><p>Write a program that asks the user to enter a number between 1 and 10. The program must keep asking until the user enters a valid number.</p><p>Once a valid number is entered, print "Thank you".</p><h3>Example Interaction:</h3><pre>Enter a number between 1 and 10: 15\nEnter a number between 1 and 10: 0\nEnter a number between 1 and 10: 5\nThank you</pre>',
                    starterCode: '',
                    hints: ['Initialize your number variable to an invalid value (e.g., 0).', 'The `while` loop condition should check if the number is outside the valid range: `while num < 1 or num > 10:`'],
                    testCases: [{ inputs: ['15', '0', '5'], expectedOutput: 'Thank you\n' }]
                },
                // SECTION 4: Lists and Strings
                '4-1': {
                    section: 4,
                    title: 'Creating a List',
                    xp: 10,
                    instructions: '<h3>Task: Favourite Hobbies</h3><p>Create a list containing three of your favourite hobbies. Then, print the entire list. After that, on a new line, print only the *first* item from the list.</p><p>Remember, list indexing starts at 0.</p><h3>Example Output:</h3><pre>[\'Gaming\', \'Reading\', \'Football\']\nGaming</pre>',
                    starterCode: '',
                    hints: ['Lists are created with square brackets [], with items separated by commas.', 'To access the first item, use the index [0].'],
                    testCases: [{ inputs: [], expectedOutput: '[\'Gaming\', \'Reading\', \'Football\']\nGaming\n' }]
                },
                '4-2': {
                    section: 4,
                    title: 'Looping Through a List',
                    xp: 10,
                    instructions: '<h3>Task: Greeting Guests</h3><p>Create a list of names. Use a <code>for</code> loop to iterate through the list and print a greeting for each person (e.g., "Hello, Alice").</p><h3>Example Output:</h3><pre>Hello, Alice\nHello, Bob\nHello, Charlie</pre>',
                    starterCode: '',
                    hints: ['You can loop directly over a list: for name in guests:', 'Inside the loop, the name variable will hold the current name from the list.'],
                    testCases: [{ inputs: [], expectedOutput: 'Hello, Alice\nHello, Bob\nHello, Charlie\n' }]
                },
                '4-3': {
                    section: 4,
                    title: 'Adding to a List',
                    xp: 10,
                    instructions: '<h3>Task: Shopping List</h3><p>Start with a list containing "milk" and "bread". Ask the user for another item to add to the shopping list. Use the <code>.append()</code> method to add it. Finally, print the updated list.</p><h3>Example Interaction:</h3><pre>Add an item: eggs\n[\'milk\', \'bread\', \'eggs\']</pre>',
                    starterCode: '',
                    hints: ['The syntax to add an item is list_name.append(item_to_add).', 'The new item will be added to the end of the list.'],
                    testCases: [{ inputs: ['eggs'], expectedOutput: '[\'milk\', \'bread\', \'eggs\']\n' }]
                },
                '4-4': {
                    section: 4,
                    title: 'Getting List Length',
                    xp: 10,
                    instructions: '<h3>Task: How Many Items?</h3><p>Create a list of colours. Use the <code>len()</code> function to find out how many items are in the list and print a message like "The list has 4 items.".</p><h3>Example Output:</h3><pre>The list has 4 items.</pre>',
                    starterCode: '',
                    hints: ['len(list_name) returns the number of items in the list.', 'You will need to convert the length to a string using str() to print it with other text.'],
                    testCases: [{ inputs: [], expectedOutput: 'The list has 4 items.\n' }]
                },
                '4-5': {
                    section: 4,
                    title: 'String Length',
                    xp: 10,
                    instructions: '<h3>Task: Character Count</h3><p>Ask the user to enter their favourite food. Use the <code>len()</code> function to count how many characters are in the word and print the result, like "Pizza has 5 characters."</p>',
                    starterCode: '',
                    hints: ['The len() function works on strings as well as lists.', 'Use an f-string or string concatenation to build the output message.'],
                    testCases: [{ inputs: ['Pizza'], expectedOutput: 'Pizza has 5 characters.\n' }]
                },
                '4-6': {
                    section: 4,
                    title: 'String Slicing',
                    xp: 10,
                    instructions: '<h3>Task: First and Last Letter</h3><p>Ask the user for a word. Print the first letter of the word and the last letter of the word, each on a new line.</p><p>Remember, the first character is at index <code>[0]</code> and the last is at index <code>[-1]</code>.</p><h3>Example Interaction:</h3><pre>Enter a word: Python\nP\nn</pre>',
                    starterCode: '',
                    hints: ['word[0] will give you the first character.', 'Python has a handy feature where index [-1] gives you the last character.'],
                    testCases: [{ inputs: ['Python'], expectedOutput: 'P\nn\n' }]
                },
                '4-7': {
                    section: 4,
                    title: 'Changing Case',
                    xp: 10,
                    instructions: '<h3>Task: Shouting and Whispering</h3><p>Ask the user for a sentence. Print the sentence back to them in all uppercase letters, and then on a new line, print it in all lowercase letters.</p><p>Use the <code>.upper()</code> and <code>.lower()</code> string methods.</p><h3>Example Interaction:</h3><pre>Enter a sentence: Hello World\nHELLO WORLD\nhello world</pre>',
                    starterCode: '',
                    hints: ['sentence.upper() will return the uppercase version.', 'sentence.lower() will return the lowercase version.'],
                    testCases: [{ inputs: ['Hello World'], expectedOutput: 'HELLO WORLD\nhello world\n' }]
                },
                '4-8': {
                    section: 4,
                    title: 'Finding an Item',
                    xp: 10,
                    instructions: '<h3>Task: Is the fruit in the basket?</h3><p>You have a list of fruits. Ask the user for a fruit and check if their fruit is in the list.</p><p>The <code>in</code> keyword is a shortcut for searching in a list. Print "Yes" or "No".</p><h3>Example Interaction:</h3><pre>What fruit are you looking for? banana\nYes</pre>',
                    starterCode: '',
                    hints: ['You can write a condition like: if fruit_to_find in fruit_basket:', 'This is a simpler way to do a linear search.'],
                    testCases: [
                        { inputs: ['banana'], expectedOutput: 'Yes\n' },
                        { inputs: ['grape'], expectedOutput: 'No\n' }
                    ]
                },
                '4-9': {
                    section: 4,
                    title: 'Starts With',
                    xp: 10,
                    instructions: '<h3>Task: Check the Start</h3><p>Ask the user for their email address. Check if it starts with "student". Print `True` or `False`.</p><p>Use the `.startswith()` string method.</p><h3>Example Interaction:</h3><pre>Enter your email: student@school.com\nTrue</pre>',
                    starterCode: '',
                    hints: ['The method is `your_string.startswith("text_to_check")`', 'This method returns a boolean value (`True` or `False`), which you can print directly.'],
                    testCases: [
                        { inputs: ['student@school.com'], expectedOutput: 'True\n' },
                        { inputs: ['teacher@school.com'], expectedOutput: 'False\n' }
                    ]
                },
                '4-10': {
                    section: 4,
                    title: 'Split a Sentence',
                    xp: 10,
                    instructions: '<h3>Task: Words in a List</h3><p>Ask the user to type a short sentence. Use the `.split()` method to turn the sentence into a list of words. Print the resulting list.</p><h3>Example Interaction:</h3><pre>Enter a sentence: I love Python programming\n[\'I\', \'love\', \'Python\', \'programming\']</pre>',
                    starterCode: '',
                    hints: ['The `.split()` method, when used with no arguments, splits a string by spaces.', '`"Hello world".split()` results in `[\'Hello\', \'world\']`.'],
                    testCases: [{ inputs: ['I love Python programming'], expectedOutput: '[\'I\', \'love\', \'Python\', \'programming\']\n' }]
                },
                 // SECTION 5: Challenge Tasks
                '5-1': {
                    section: 5,
                    title: 'Simple Calculator',
                    xp: 20,
                    instructions: '<h3>Challenge: Simple Calculator</h3><p>Create a calculator that can add or subtract two numbers.</p><ol><li>Ask the user for the first number.</li><li>Ask for the second number.</li><li>Ask for the operation ("add" or "subtract").</li><li>Perform the calculation and print the result.</li></ol><h3>Example Interaction:</h3><pre>Enter first number: 10\nEnter second number: 5\nEnter operation (add/subtract): add\n15</pre>',
                    starterCode: '',
                    hints: ['Use an `if` statement to check if the operation is "add".', 'Use an `elif` statement to check if it is "subtract".', 'Handle the case where the user types something else with an `else`.'],
                    testCases: [
                        { inputs: ['10', '5', 'add'], expectedOutput: '15\n' },
                        { inputs: ['20', '8', 'subtract'], expectedOutput: '12\n' }
                    ]
                },
                '5-2': {
                    section: 5,
                    title: 'Dice Roll Simulator',
                    xp: 20,
                    instructions: '<h3>Challenge: Dice Roll</h3><p>Simulate rolling a six-sided die.</p><p>To do this, you will need to import Python\'s built-in <code>random</code> library. Then, use <code>random.randint(1, 6)</code> to get a random number between 1 and 6 (inclusive). Print the result.</p><h3>Example Output (will vary):</h3><pre>You rolled a 4!</pre>',
                    starterCode: '',
                    hints: ['The first line of your code must be `import random`.', 'The function to use is `random.randint(min, max)`.', 'Store the result in a variable before printing it.'],
                    testCases: [{ inputs: [], expectedOutput: 'You rolled a 4!\n', isRandom: true }]
                },
                '5-3': {
                    section: 5,
                    title: 'Shopping List Manager',
                    xp: 20,
                    instructions: '<h3>Challenge: Shopping List</h3><p>Create a program that lets a user build a shopping list.</p><p>The program should repeatedly ask the user to enter an item. Each item should be added to a list. If the user types "done", the loop should stop, and the program should print the complete list.</p><h3>Example Interaction:</h3><pre>Enter an item (or done): milk\nEnter an item (or done): bread\nEnter an item (or done): done\n[\'milk\', \'bread\']</pre>',
                    starterCode: '',
                    hints: ['Create an empty list `[]` before the loop.', 'Use a `while` loop that continues as long as the user\'s input is not "done".', 'Inside the loop, use `.append()` to add the item to the list, but only if it\'s not "done".'],
                    testCases: [{ inputs: ['milk', 'bread', 'eggs', 'done'], expectedOutput: '[\'milk\', \'bread\', \'eggs\']\n' }]
                },
                '5-4': {
                    section: 5,
                    title: 'Password Attempts',
                    xp: 20,
                    instructions: '<h3>Challenge: 3 Password Attempts</h3><p>Create a password checker that gives the user 3 attempts to get it right. The password is "magic".</p><p>Use a `for` loop that runs 3 times (`range(3)`). Inside the loop, ask for the password. If it\'s correct, print "Welcome" and `break` the loop. If they fail all 3 times, print "Access denied".</p><h3>Example Interaction (correct on 2nd try):</h3><pre>Attempt 1 - Enter password: hello\nAttempt 2 - Enter password: magic\nWelcome</pre>',
                    starterCode: '',
                    hints: ['A `for` loop can have an `else` block. The `else` block only runs if the loop completes normally (i.e., it was not ended by a `break`).', 'Put `print("Access denied")` in the `for/else` block.'],
                    testCases: [
                        { inputs: ['hello', 'magic'], expectedOutput: 'Welcome\n' },
                        { inputs: ['a', 'b', 'c'], expectedOutput: 'Access denied\n' }
                    ]
                },
                '5-5': {
                    section: 5,
                    title: 'Mini Adventure Game',
                    xp: 20,
                    instructions: '<h3>Challenge: Text Adventure</h3><p>Create a tiny choice-based adventure game.</p><p>Ask the user if they want to go "left" or "right".</p><ul><li>If they go "left", print "You find a treasure chest!".</li><li>If they go "right", print "You meet a friendly dragon!".</li><li>If they type anything else, print "You are lost!".</li></ul><h3>Example Interaction:</h3><pre>You are at a crossroads. Go left or right? left\nYou find a treasure chest!</pre>',
                    starterCode: '',
                    hints: ['Make sure to compare the user\'s input exactly, or use `.lower()` to make it case-insensitive.', 'Use `if` for the first choice, `elif` for the second, and `else` to catch all other possibilities.'],
                    testCases: [
                        { inputs: ['left'], expectedOutput: 'You find a treasure chest!\n' },
                        { inputs: ['right'], expectedOutput: 'You meet a friendly dragon!\n' },
                        { inputs: ['forward'], expectedOutput: 'You are lost!\n' }
                    ]
                },
                '5-6': {
                    section: 5,
                    title: 'Highest Score',
                    xp: 20,
                    instructions: '<h3>Challenge: Find the Highest Score</h3><p>You are given a list of test scores. Without using the built-in <code>max()</code> function, write a program to find the highest score in the list and print it.</p><p>Iterate through the list and keep track of the highest score you have seen so far.</p><h3>Example Output:</h3><pre>The highest score is: 99</pre>',
                    starterCode: 'scores = [78, 92, 56, 88, 99, 67]\n# Your code here',
                    hints: ['Initialize a variable `highest_score` to the first item in the list or to 0.', 'Loop through the scores. If the current score is higher than `highest_score`, update `highest_score`.'],
                    testCases: [{ inputs: [], expectedOutput: 'The highest score is: 99\n' }]
                },
                '5-7': {
                    section: 5,
                    title: 'Vowel Counter',
                    xp: 20,
                    instructions: '<h3>Challenge: Count the Vowels</h3><p>Ask the user for a sentence. Count how many vowels (a, e, i, o, u) are in the sentence and print the total.</p><p>Your check should be case-insensitive (it should count "A" as well as "a").</p><h3>Example Interaction:</h3><pre>Enter a sentence: This is a test sentence\nThere are 6 vowels.</pre>',
                    starterCode: '',
                    hints: ['Create a counter variable, initialized to 0.', 'Loop through each character in the user\'s sentence.', 'To handle both upper and lower case, you can convert each character to lowercase before you check it.'],
                    testCases: [{ inputs: ['This is a test sentence'], expectedOutput: 'There are 6 vowels.\n' }]
                }
            };

            // --- APPLICATION STATE ---
            const appState = {
                pyodide: null,
                pyodideLoadPromise: null,
                isPyodideReady: false,
                editor: null,
                currentTaskId: null,
                userProgress: {},
                eventListeners: new Map(),
                // A cache for DOM elements that are frequently accessed
                domCache: {}
            };
            
            // --- STATE MANAGEMENT ---
            /**
             * Centralized state update function.
             * @param {object} newState - An object with keys to update in the appState.
             */
            function setState(newState) {
                Object.assign(appState, newState);
            }

            // --- ERROR HANDLING ---
            function handleError(error, context = 'general') {
                console.error(`Error (${context}):`, error);
                let userMessage = 'An unexpected error occurred. Please try refreshing the page.';
                if (error.message.includes('Pyodide')) {
                    userMessage = 'A Python environment error occurred. Refreshing might fix it.';
                } else if (context === 'run-code') {
                    userMessage = `Error in your code: ${error.message}`;
                }
                showToast(userMessage, 'error');
                if (appState.domCache.output) {
                   appState.domCache.output.textContent = `Error: ${error.message}`;
                   appState.domCache.output.classList.add('error');
                }
            }

            // --- UI/DOM FUNCTIONS ---

            /**
             * Caches frequently accessed DOM elements.
             */
            function cacheDOMElements() {
                appState.domCache = {
                    headerSubtitle: document.getElementById('header-subtitle'),
                    xpDisplay: document.getElementById('xp-display'),
                    sidebarNav: document.getElementById('sidebar-nav'),
                    mainContent: document.getElementById('mainContent'),
                    toast: document.getElementById('toast'),
                    welcomeModal: document.getElementById('welcome-modal'),
                    modalCloseBtn: document.getElementById('modal-close-btn'),
                    loadingMessage: document.getElementById('loading-message'),
                    header: document.querySelector('.header'),
                    mainContainer: document.querySelector('.main-container')
                };
            }

            /**
             * Displays a short-lived notification message.
             * @param {string} message - The message to display.
             * @param {string} type - The type of message ('info', 'success', 'warning', 'error').
             */
            function showToast(message, type = 'info') {
                const { toast } = appState.domCache;
                if (!toast) return;
                
                toast.textContent = message;
                toast.className = `toast show toast-${type}`;
                
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }

            /**
             * Updates the total XP display in the header.
             */
            function updateTotalXP() {
                let totalXP = 0;
                for (const taskId in appState.userProgress) {
                    if (appState.userProgress[taskId]?.xpAwarded && TASKS[taskId]) {
                        totalXP += TASKS[taskId].xp;
                    }
                }
                if(appState.domCache.xpDisplay) appState.domCache.xpDisplay.textContent = `XP: ${totalXP}`;
            }
            
            /**
             * Generates the task navigation sidebar.
             */
            function generateSidebar() {
                const { sidebarNav } = appState.domCache;
                if (!sidebarNav) return;
                
                sidebarNav.innerHTML = '';
                
                const sections = {};
                for (const taskId in TASKS) {
                    const task = TASKS[taskId];
                    if (!sections[task.section]) sections[task.section] = [];
                    sections[task.section].push(taskId);
                }

                const sectionNames = {
                    1: "Section 1: The Basics",
                    2: "Section 2: Selection",
                    3: "Section 3: Iteration (Loops)",
                    4: "Section 4: Lists & Strings",
                    5: "Section 5: Challenge Tasks"
                };

                for (const sectionNum in sections) {
                    const sectionDiv = document.createElement('div');
                    sectionDiv.className = 'section-container';

                    const header = document.createElement('div');
                    header.className = 'section-header';
                    if (sectionNum == '5') header.classList.add('challenge');

                    const headerText = document.createElement('span');
                    headerText.textContent = sectionNames[sectionNum] || `Section ${sectionNum}`;
                    const arrow = document.createElement('span');
                    arrow.className = 'section-arrow';
                    arrow.textContent = '▶';
                    header.appendChild(headerText);
                    header.appendChild(arrow);
                    
                    const taskList = document.createElement('ul');
                    taskList.className = 'task-list';
                    taskList.id = `section-list-${sectionNum}`;
                    
                    sections[sectionNum].forEach(taskId => {
                        const task = TASKS[taskId];
                        const li = document.createElement('li');
                        li.className = 'task-item';
                        li.id = `task-item-${taskId}`;
                        
                        if (appState.userProgress[taskId]?.completed) {
                            li.classList.add(CONSTANTS.CLASS_COMPLETED);
                        }
                        
                        const status = document.createElement('span');
                        status.className = 'task-item-status';
                        const title = document.createElement('span');
                        title.textContent = task.title;
                        
                        li.appendChild(status);
                        li.appendChild(title);
                        addManagedEventListener(li, 'click', () => switchTask(taskId));
                        taskList.appendChild(li);
                    });
                    
                    addManagedEventListener(header, 'click', () => {
                        taskList.classList.toggle(CONSTANTS.CLASS_OPEN);
                        arrow.classList.toggle(CONSTANTS.CLASS_OPEN);
                    });
                    
                    sectionDiv.appendChild(header);
                    sectionDiv.appendChild(taskList);
                    sidebarNav.appendChild(sectionDiv);
                }
            }

            /**
             * Renders the main content area for the first time.
             */
            function buildMainContentShell() {
                 const { mainContent } = appState.domCache;
                 if (!mainContent) return;

                 mainContent.innerHTML = `
                    <div id="task-view">
                        <div class="task-header">
                            <h2 class="task-title" id="task-title-element"></h2>
                        </div>
                        <div class="instructions allow-select" id="task-instructions-element"></div>
                        <div class="editor-container">
                            <div class="editor-header">
                                <span>student_code.py</span>
                                <button id="copy-btn" class="btn btn-secondary btn-sm">Copy Code</button>
                            </div>
                            <textarea id="editor"></textarea>
                        </div>
                        <div class="controls">
                            <button id="run-btn" class="btn btn-primary">▶ Run</button>
                            <button id="check-btn" class="btn btn-success">✔ Check Solution</button>
                            <button id="hint-btn" class="btn btn-warning">💡 Show Hint</button>
                            <button id="reset-btn" class="btn btn-secondary">↺ Reset</button>
                        </div>
                        <div id="hint-box" class="hint-box"></div>
                        <div class="output-panel">
                            <div class="output-header">Console Output</div>
                            <div id="output" class="output-content"></div>
                        </div>
                        <div id="checks-container" class="checks-container" style="display: none;"></div>
                    </div>
                     <div id="welcome-view" style="display: none;">
                        <h2>Welcome to the Year 9 Programming Project!</h2>
                        <p class="allow-select">This project contains several sections with tasks to help you practice your Python programming skills.</p>
                        <p class="allow-select">Complete tasks to earn XP and watch your total grow! Each task shows how much XP it is worth.</p>
                        <p class="allow-select">Select a task from the sidebar on the left to begin. Your progress is automatically saved in your browser.</p>
                        <p id="python-status" class="allow-select">The Python environment will load when you run your first piece of code.</p>
                    </div>
                 `;
                 // Cache newly created elements
                 Object.assign(appState.domCache, {
                     taskView: document.getElementById('task-view'),
                     welcomeView: document.getElementById('welcome-view'),
                     taskTitle: document.getElementById('task-title-element'),
                     taskInstructions: document.getElementById('task-instructions-element'),
                     editor: document.getElementById('editor'),
                     output: document.getElementById('output'),
                     checksContainer: document.getElementById('checks-container'),
                     hintBox: document.getElementById('hint-box')
                 });

                 // Add event listeners
                addManagedEventListener(document.getElementById('run-btn'), 'click', runCode);
                addManagedEventListener(document.getElementById('check-btn'), 'click', checkSolution);
                addManagedEventListener(document.getElementById('hint-btn'), 'click', showHint);
                addManagedEventListener(document.getElementById('reset-btn'), 'click', resetCode);
                addManagedEventListener(document.getElementById('copy-btn'), 'click', copyCode);
            }

            /**
             * Switches the view to a new task without rebuilding the DOM.
             * @param {string} taskId - The ID of the task to switch to.
             */
            function switchTask(taskId) {
                try {
                    setState({ currentTaskId: taskId });
                    const task = TASKS[taskId];
                    const { domCache } = appState;

                    domCache.taskView.style.display = 'block';
                    domCache.welcomeView.style.display = 'none';

                    // Update dynamic content
                    domCache.taskTitle.textContent = `${task.section}.${taskId.split('-')[1]} - ${task.title} (+${task.xp} XP)`;
                    domCache.taskInstructions.innerHTML = task.instructions;
                    domCache.checksContainer.style.display = 'none';
                    domCache.hintBox.style.display = 'none';

                    // Update sidebar active state
                    document.querySelectorAll('.task-item').forEach(item => item.classList.remove(CONSTANTS.CLASS_ACTIVE));
                    const taskItem = document.getElementById(`task-item-${taskId}`);
                    if (taskItem) taskItem.classList.add(CONSTANTS.CLASS_ACTIVE);

                    // Ensure section is open
                    const taskList = document.getElementById(`section-list-${task.section}`);
                    if (taskList && !taskList.classList.contains(CONSTANTS.CLASS_OPEN)) {
                        taskList.classList.add(CONSTANTS.CLASS_OPEN);
                        const arrow = taskList.previousElementSibling.querySelector('.section-arrow');
                        if(arrow) arrow.classList.add(CONSTANTS.CLASS_OPEN);
                    }
                    
                    initializeEditor(task.starterCode);

                } catch (error) {
                    handleError(error, 'switch-task');
                }
            }

            function initializeEditor(starterCode) {
                if (appState.editor) {
                    appState.editor.toTextArea();
                }
                appState.editor = CodeMirror.fromTextArea(appState.domCache.editor, {
                    mode: 'python',
                    theme: 'monokai',
                    lineNumbers: true,
                    autoCloseBrackets: true,
                    matchBrackets: true,
                    indentUnit: 4
                });
                
                appState.editor.on('beforeChange', (cm, change) => {
                    if (change.origin === 'paste') {
                        change.cancel();
                    }
                });
                
                const savedCode = appState.userProgress[appState.currentTaskId]?.code || starterCode;
                appState.editor.setValue(savedCode);

                appState.editor.on('change', () => {
                    if (!appState.userProgress[appState.currentTaskId]) {
                        appState.userProgress[appState.currentTaskId] = { code: '', completed: false, xpAwarded: false };
                    }
                    appState.userProgress[appState.currentTaskId].code = appState.editor.getValue();
                    saveProgress();
                });
            }

            function showWelcomeMessage() {
                const { taskView, welcomeView } = appState.domCache;
                if(taskView) taskView.style.display = 'none';
                if(welcomeView) welcomeView.style.display = 'block';
            }

            // --- PYODIDE LOGIC ---

            async function ensurePyodideLoaded() {
                if (appState.isPyodideReady) return;
                if (appState.pyodideLoadPromise) return appState.pyodideLoadPromise;

                const loadPromise = async () => {
                    try {
                        appState.domCache.headerSubtitle.textContent = 'Loading Python environment...';
                        
                        if (typeof loadPyodide === 'undefined') {
                            await new Promise((resolve, reject) => {
                                const script = document.createElement('script');
                                script.src = 'https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js';
                                script.onload = resolve;
                                script.onerror = reject;
                                document.head.appendChild(script);
                            });
                        }
                        
                        const pyodide = await loadPyodide({ indexURL: "https://cdn.jsdelivr.net/pyodide/v0.24.1/full/" });
                        setState({ pyodide: pyodide, isPyodideReady: true });
                        appState.domCache.headerSubtitle.textContent = 'A series of tasks to build your Python skills. Complete them in order!';
                        
                    } catch (error) {
                        handleError(error, 'pyodide-load');
                        appState.domCache.headerSubtitle.textContent = 'Failed to load Python environment. Please refresh.';
                        throw error;
                    }
                };

                setState({ pyodideLoadPromise: loadPromise() });
                return appState.pyodideLoadPromise;
            }

            async function runCode() {
                const { output } = appState.domCache;
                try {
                    await ensurePyodideLoaded();
                    const code = appState.editor.getValue();
                    
                    output.textContent = 'Running...';
                    output.classList.remove('error');

                    appState.pyodide.runPython(`
                        import sys, io
                        from js import prompt
                        sys.stdout = io.StringIO()
                        
                        def custom_input(prompt_text=""):
                            return prompt(prompt_text) or ""

                        __builtins__.input = custom_input
                    `);

                    await appState.pyodide.runPythonAsync(code);
                    const result = appState.pyodide.runPython(`sys.stdout.getvalue()`);
                    output.textContent = result || '(No output)';
                } catch (error) {
                    handleError(error, 'run-code');
                }
            }
            
            async function checkSolution() {
                 const { checksContainer } = appState.domCache;
                 try {
                    await ensurePyodideLoaded();
                    const task = TASKS[appState.currentTaskId];
                    const studentCode = appState.editor.getValue();

                    checksContainer.style.display = 'block';
                    checksContainer.innerHTML = `
                        <div class="test-info-box">
                           <h4>🧪 How Your Code is Tested</h4>
                           <p>Your code is run with automated inputs. The checker ignores differences in capitalization and spacing, so focus on getting the logic right!</p>
                        </div>
                        <h3>Solution Checks:</h3>
                    `;
                    
                    let allPassed = true;

                    for (const testCase of task.testCases) {
                        const mockInput = testCase.inputs.slice();
                        
                        if (task.isRandom) {
                             checksContainer.innerHTML += `<div class="check-item passed"><div class="check-header"><div class="check-icon passed">✔</div><div class="check-description">Random task: Manually verified. Well done!</div></div></div>`;
                             continue;
                        }

                        let actualOutput = '';
                        let passed = false;

                        appState.pyodide.globals.set('mock_inputs', mockInput);
                        appState.pyodide.runPython(`
                            import sys, io
                            sys.stdout = io.StringIO()
                            _mock_input_list = mock_inputs.to_py()
                            
                            def _test_input(prompt=""):
                                if not _mock_input_list: return ""
                                return _mock_input_list.pop(0)
                            
                            __builtins__.input = _test_input
                        `);

                        try {
                            await appState.pyodide.runPythonAsync(studentCode);
                            actualOutput = appState.pyodide.runPython(`sys.stdout.getvalue()`);
                            
                            const normalize = (str) => (str || '').toLowerCase().trim().replace(/\s+/g, ' ');
                            if (normalize(actualOutput) === normalize(testCase.expectedOutput)) {
                                passed = true;
                            }
                        } catch (err) {
                           actualOutput = err.toString();
                           passed = false;
                        }

                        const checkItem = document.createElement('div');
                        checkItem.className = `check-item ${passed ? 'passed' : 'failed'}`;
                        const checkHeader = document.createElement('div');
                        checkHeader.className = 'check-header';
                        
                        checkHeader.innerHTML = `
                            <div class="check-icon ${passed ? 'passed' : 'failed'}">${passed ? '✔' : '✖'}</div>
                            <div class="check-description">Test with input(s): <code>[${testCase.inputs.join(', ')}]</code></div>`;
                        
                        checkItem.appendChild(checkHeader);

                        if (!passed) {
                             allPassed = false;
                             const details = document.createElement('div');
                             details.className = 'check-details';
                             details.style.display = 'block';
                             details.innerHTML = `
                                <strong>Your Output:</strong><code>${actualOutput || '(No output)'}</code>
                                <strong>Expected Output:</strong><code>${testCase.expectedOutput}</code>
                             `;
                             checkItem.appendChild(details);
                        }
                        checksContainer.appendChild(checkItem);
                    }
                    
                    if (allPassed) {
                        const currentProgress = appState.userProgress[appState.currentTaskId];
                        if (!currentProgress.xpAwarded) {
                            showToast(`All tests passed! +${task.xp} XP!`, 'success');
                            currentProgress.xpAwarded = true;
                            updateTotalXP();
                        } else {
                            showToast('All tests passed! Well done!', 'success');
                        }
                        
                        if (!currentProgress.completed) {
                            currentProgress.completed = true;
                            document.getElementById(`task-item-${appState.currentTaskId}`).classList.add(CONSTANTS.CLASS_COMPLETED);
                        }
                        saveProgress();
                    } else {
                        showToast('Some tests failed. Check the details below!', 'warning');
                    }

                 } catch(error) {
                    handleError(error, 'check-solution');
                 }
            }

            function showHint() {
                const { hintBox } = appState.domCache;
                const task = TASKS[appState.currentTaskId];
                
                if (!task.hints || task.hints.length === 0) {
                    hintBox.innerHTML = '<p>No hints available for this task.</p>';
                } else {
                    const hintIndex = (appState.userProgress[appState.currentTaskId]?.hintIndex || -1) + 1;
                    const currentHint = task.hints[hintIndex % task.hints.length];
                    hintBox.innerHTML = `<h4>💡 Hint</h4><p class="allow-select">${currentHint}</p>`;
                    if(!appState.userProgress[appState.currentTaskId]) {
                        appState.userProgress[appState.currentTaskId] = {};
                    }
                    appState.userProgress[appState.currentTaskId].hintIndex = hintIndex;
                }
                hintBox.style.display = 'block';
            }

            // --- LOCAL STORAGE & EVENT MANAGEMENT ---
            function resetCode() {
                if (confirm('Are you sure you want to reset your code for this task? This cannot be undone.')) {
                    appState.editor.setValue(TASKS[appState.currentTaskId].starterCode);
                }
            }

            function copyCode() {
                navigator.clipboard.writeText(appState.editor.getValue()).then(
                    () => showToast('Code copied to clipboard!', 'success'),
                    () => showToast('Failed to copy code.', 'error')
                );
            }

            function saveProgress() {
                try {
                    localStorage.setItem(CONSTANTS.LOCAL_STORAGE_KEY, JSON.stringify(appState.userProgress));
                } catch (e) {
                    console.error('Could not save progress.', e);
                }
            }

            function loadProgress() {
                try {
                    const saved = localStorage.getItem(CONSTANTS.LOCAL_STORAGE_KEY);
                    if (saved) {
                        const progress = JSON.parse(saved);
                        // Ensure new properties exist for backward compatibility
                        for(const taskId in progress) {
                            if (!('xpAwarded' in progress[taskId])) {
                                progress[taskId].xpAwarded = progress[taskId].completed;
                            }
                        }
                        setState({ userProgress: progress });
                    }
                } catch (e) {
                    console.error('Could not load progress.', e);
                    setState({ userProgress: {} });
                }
            }
            
            function addManagedEventListener(element, event, handler) {
                element.addEventListener(event, handler);
                if (!appState.eventListeners.has(element)) {
                    appState.eventListeners.set(element, []);
                }
                appState.eventListeners.get(element).push({ event, handler });
            }

            function removeAllEventListeners() {
                appState.eventListeners.forEach((listeners, element) => {
                    listeners.forEach(({ event, handler }) => {
                        element.removeEventListener(event, handler);
                    });
                });
                appState.eventListeners.clear();
            }

            function showWelcomeModal() {
                if(localStorage.getItem(CONSTANTS.WELCOME_MODAL_SHOWN_KEY)) {
                    return;
                }
                const { welcomeModal, modalCloseBtn } = appState.domCache;
                
                welcomeModal.classList.add('show');

                const closeModal = () => {
                    welcomeModal.classList.remove('show');
                    localStorage.setItem(CONSTANTS.WELCOME_MODAL_SHOWN_KEY, 'true');
                };
                
                addManagedEventListener(modalCloseBtn, 'click', closeModal);
                addManagedEventListener(welcomeModal, 'click', (e) => {
                    if (e.target === welcomeModal) {
                        closeModal();
                    }
                });
            }

            // --- INITIALIZATION ---
            function main() {
                try {
                    cacheDOMElements();
                    const { loadingMessage, header, mainContainer } = appState.domCache;
                    loadingMessage.style.display = 'none';
                    header.style.display = 'flex';
                    mainContainer.style.display = 'grid';
                    
                    loadProgress();
                    buildMainContentShell();
                    generateSidebar();
                    updateTotalXP();
                    showWelcomeModal();
                    
                    const urlParams = new URLSearchParams(window.location.search);
                    const taskIdFromUrl = urlParams.get('task');
                    
                    if (taskIdFromUrl && TASKS[taskIdFromUrl]) {
                        switchTask(taskIdFromUrl);
                    } else {
                        const firstIncomplete = Object.keys(TASKS).find(id => !appState.userProgress[id]?.completed);
                        if(firstIncomplete) {
                            switchTask(firstIncomplete);
                        } else {
                            showWelcomeMessage();
                        }
                    }
                } catch (error) {
                    handleError(error, 'initialization');
                }
            }
            
            window.addEventListener('beforeunload', () => {
                removeAllEventListeners();
                if (appState.editor) appState.editor.toTextArea();
            });

            document.addEventListener('DOMContentLoaded', main);
        })();
    </script>
</body>
</html>
