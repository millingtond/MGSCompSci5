<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Layer Laboratory - Network Layers Explorer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            animation: fadeIn 0.3s;
        }

        .modal-content {
            background-color: #fff;
            margin: 5% auto;
            padding: 30px;
            border: 3px solid #667eea;
            width: 90%;
            max-width: 600px;
            border-radius: 15px;
            box-shadow: 0 5px 30px rgba(0,0,0,0.3);
            animation: slideIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Header Styles */
        .header {
            background: #fff;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
            position: relative;
        }

        .header h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header .subtitle {
            color: #888;
            font-size: 1.2em;
        }

        .reset-btn {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .reset-btn:hover {
            background: #c0392b;
            transform: translateY(-50%) scale(1.05);
        }
        
        .task-reset-btn {
            background: #f39c12;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            margin-left: 15px;
        }
        .task-reset-btn:hover {
            background: #e67e22;
        }

        /* Progress Bar */
        .progress-container {
            width: 90%;
            max-width: 800px;
            height: 35px;
            background: rgba(255,255,255,0.3);
            border: 2px solid #fff;
            border-radius: 20px;
            margin: 20px auto;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #8bc34a);
            width: 0%;
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: bold;
            font-size: 1.1em;
        }

        /* Lab Container */
        .lab-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            padding-bottom: 150px; /* Space for lab assistant */
        }

        .lab-section {
            display: none;
            background: #fff;
            border-radius: 20px;
            padding: 30px;
            margin: 20px 0;
            box-shadow: 0 5px 25px rgba(0,0,0,0.1);
            animation: fadeIn 0.5s;
        }

        .lab-section.active {
            display: block;
        }

        .lab-section h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 2em;
        }
        
        .instructions {
            background: #eef;
            border-left: 5px solid #667eea;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            line-height: 1.6;
        }

        /* Layer Stack Visualization */
        .layer-stack {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-width: 800px;
            margin: 30px auto;
        }

        .layer-block {
            background: #f8f9fa;
            border: 3px solid #dee2e6;
            border-radius: 15px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .layer-block:hover, .layer-block:focus {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border-color: #667eea;
            outline: none;
        }

        .layer-block.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        /* Encapsulation & Analogy Demo */
        .demo-area {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
            position: relative;
            min-height: 450px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        
        .demo-visual {
             width: 100%;
        }

        .data-packet, .analogy-item {
            background: #fff;
            border: 3px solid #333;
            border-radius: 10px;
            padding: 15px;
            margin: 10px auto;
            max-width: 600px;
            transition: all 0.5s;
            text-align: center;
            position: relative;
        }

        .data-core, .analogy-core {
            background: #ffd700;
            border: 2px solid #ffa500;
            border-radius: 8px;
            padding: 15px;
            margin: 10px;
            font-weight: bold;
        }

        .header-wrapper, .analogy-wrapper {
            border: 2px dashed;
            border-radius: 10px;
            padding: 10px;
            margin: 5px;
            position: relative;
            transition: all 0.5s;
        }

        .header-label, .analogy-label {
            position: absolute;
            top: -12px;
            left: 10px;
            background: #f8f9fa;
            padding: 0 10px;
            font-size: 0.8em;
            font-weight: bold;
        }
        .info-text {
            padding: 10px 5px 5px;
            font-size: 0.9em;
            margin-top: 5px;
            font-style: italic;
        }

        /* Interactive Demo */
        .interactive-area {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            margin: 30px 0;
        }

        .control-panel {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
        }

        .control-panel h3 {
            color: #667eea;
            margin-bottom: 15px;
        }
        
        .action-btn {
            width: 100%;
            background: #667eea;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            margin: 8px 0;
            font-size: 1em;
            font-weight: 500;
            transition: all 0.3s;
        }

        .action-btn:hover:not(:disabled) {
            background: #764ba2;
            transform: scale(1.05);
        }

        .action-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .visualization-area {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        /* Benefits Cards */
        .benefits-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .benefit-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            border: 3px solid transparent;
        }

        .benefit-card:hover, .benefit-card:focus {
            transform: translateY(-10px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            border-color: #667eea;
            outline: none;
        }
        .benefit-card h4 {
            color: #667eea;
            margin-bottom: 10px;
        }
        .benefit-detail {
            display: none;
            margin-top: 15px;
            font-size: 0.9em;
            text-align: left;
        }
        .benefit-detail.show {
            display: block;
        }

        /* Troubleshooting Game */
        .troubleshoot-scenario {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
        }

        .layer-diagnostic {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .diagnostic-layer {
            background: #f8f9fa;
            border: 3px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .diagnostic-layer:hover:not(.disabled), .diagnostic-layer:focus {
            transform: scale(1.05);
            outline: none;
        }
        
        .diagnostic-layer.disabled {
            background: #eee;
            color: #aaa;
            cursor: not-allowed;
            transform: none;
        }

        .diagnostic-layer.working {
            border-color: #4caf50;
            background: #e8f5e9;
        }

        .diagnostic-layer.faulty {
            border-color: #f44336;
            background: #ffebee;
        }

        .diagnostic-layer.checking {
            border-color: #2196f3;
            background: #e3f2fd;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Question Box */
        .question-box {
            background: #e3f2fd;
            border: 2px solid #2196f3;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
        }

        .question-box h3 {
            color: #1976d2;
            margin-bottom: 15px;
        }

        .answer-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 15px;
        }

        .answer-btn {
            background: #fff;
            border: 2px solid #2196f3;
            color: #1976d2;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1em;
            font-weight: 500;
        }

        .answer-btn:hover:not(:disabled) {
            background: #2196f3;
            color: white;
            transform: scale(1.05);
        }

        .answer-btn.correct, .answer-feedback.correct {
            background-color: #e8f5e9;
            border-color: #4caf50;
            color: #1b5e20;
        }
        .answer-btn.correct { animation: pulse 0.5s; }


        .answer-btn.incorrect, .answer-feedback.incorrect {
            background-color: #ffebee;
            border-color: #f44336;
            color: #c62828;
        }
        .answer-btn.incorrect { animation: shake 0.5s; }

        .answer-feedback {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            border-left: 5px solid;
            display: none;
        }
        .answer-feedback.show {
            display: block;
        }
        
        /* General Button Styles */
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 500;
            transition: all 0.3s;
            margin: 10px 5px;
        }

        .btn:hover:not(:disabled) {
            background: #764ba2;
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }

        /* Lab Assistant */
        #lab-assistant {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            align-items: flex-end;
            z-index: 999;
        }
        #assistant-icon {
            width: 80px;
            height: 80px;
            cursor: pointer;
            transition: transform 0.3s;
        }
        #assistant-icon:hover {
            transform: scale(1.1);
        }
        #assistant-hint {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            max-width: 300px;
            margin-right: 15px;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.4s;
            visibility: hidden;
        }
        #assistant-hint.show {
            opacity: 1;
            transform: translateY(0);
            visibility: visible;
        }
        #assistant-hint p {
            line-height: 1.6;
            font-size: 0.95em;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header h1 { font-size: 1.8em; }
            .reset-btn { position: static; transform: none; margin-top: 10px; }
            .interactive-area { grid-template-columns: 1fr; }
            .layer-diagnostic { grid-template-columns: repeat(2, 1fr); }
            .benefits-grid { grid-template-columns: 1fr; }
            #lab-assistant {
                right: 5px;
                bottom: 5px;
            }
            #assistant-icon {
                width: 60px;
                height: 60px;
            }
            #assistant-hint {
                max-width: calc(100vw - 100px);
            }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
    </style>
</head>
<body>
    <!-- Instructions Modal -->
    <div id="instructionsModal" class="modal" role="dialog" aria-labelledby="modalTitle" aria-describedby="modalDescription">
        <div class="modal-content">
            <h2 id="modalTitle" style="color: #667eea; margin-bottom: 20px;">🔬 Welcome to the Layer Laboratory!</h2>
            <p id="modalDescription" style="line-height: 1.8; margin-bottom: 15px;">
                Follow the instructions in each experiment carefully to learn the concepts of network layers.
            </p>
            
            <div style="background-color: #fff3cd; border-left: 5px solid #ffc107; padding: 15px; border-radius: 5px; margin: 20px 0;">
                <p><strong>A quick note for GCSE Computer Science students:</strong></p>
                <p style="margin-top: 5px; line-height: 1.6;">
                    This lab goes into extra detail to help you understand <em>how</em> networks function. For your exams, the most important information is in the main descriptions in Experiment 1 and Experiment 4 - think of these as your key revision flashcards!
                </p>
            </div>

            <h3 style="color: #667eea; margin: 20px 0 10px;">Your Lab Experiments:</h3>
            <ul style="list-style: none; padding-left: 0;">
                <li style="margin: 10px 0;">🏗️ <strong>Experiments 1-5:</strong> Core Learning Path</li>
                <li style="margin: 10px 0;">📮 <strong>Bonus Lab:</strong> Interactive Analogy</li>
            </ul>
            <p style="margin: 20px 0; color: #764ba2; font-weight: bold;">
                Complete all experiments to become a Network Layer Expert! If you get stuck, click the Lab Assistant in the bottom right corner for a hint.
            </p>
            <button class="btn" id="closeInstructionsBtn">Enter Laboratory</button>
        </div>
    </div>

    <!-- Header -->
    <div class="header">
        <h1>🔬 Layer Laboratory</h1>
        <p class="subtitle">Network Architecture Research Center</p>
        <button class="reset-btn" id="resetBtn" aria-label="Reset all progress">🔄 Reset All</button>
    </div>

    <!-- Progress Bar -->
    <div class="progress-container" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
        <div id="progressBar" class="progress-bar">0%</div>
    </div>

    <!-- Lab Container -->
    <div class="lab-container">
        <!-- Experiment 1: Layer Overview -->
        <div id="experiment1" class="lab-section active">
            <h2>🏗️ Experiment 1: The 4-Layer Model <button class="task-reset-btn" data-exp="1">🔄 Reset Task</button></h2>
            <div class="instructions">
                <p><strong>Click on each of the four layers below</strong> to learn about its function. You must explore all four before the quiz appears.</p>
            </div>
            <div class="layer-stack">
                <div class="layer-block" data-layer="4"><h3>Application Layer</h3><p>Where user applications communicate - web browsers, email clients.</p></div>
                <div class="layer-block" data-layer="3"><h3>Transport Layer</h3><p>Breaks data into packets and ensures reliable delivery.</p></div>
                <div class="layer-block" data-layer="2"><h3>Internet Layer</h3><p>Routes packets across networks using IP addresses.</p></div>
                <div class="layer-block" data-layer="1"><h3>Network Access Layer</h3><p>Handles physical transmission over cables or Wi-Fi.</p></div>
            </div>
            <div class="question-box" id="experiment1Question" style="display: none;">
                <h3>Layer Knowledge: Which layer breaks data into packets?</h3>
                <div class="answer-options">
                    <button class="answer-btn" data-answer="Application">Application Layer</button>
                    <button class="answer-btn" data-answer="Transport">Transport Layer</button>
                    <button class="answer-btn" data-answer="Internet">Internet Layer</button>
                    <button class="answer-btn" data-answer="Network">Network Access Layer</button>
                </div>
                <div class="answer-feedback"></div>
            </div>
            <div style="text-align: center; margin-top: 30px;"><button id="nextBtn1" class="btn">Next Experiment →</button></div>
        </div>

        <!-- Experiment 2: Encapsulation Demo -->
        <div id="experiment2" class="lab-section">
            <h2>📦 Experiment 2: Encapsulation Process</h2>
            <div class="instructions"><p><strong>Use the 'Step Forward' button to watch the process one step at a time, or press 'Auto Play'.</strong></p></div>
            <div class="demo-area">
                <div class="demo-visual" id="encapsulationVisual">
                    <div class="data-packet" id="dataPacket"><div class="data-core">"Hello, Server!"</div></div>
                </div>
            </div>
            <div style="text-align: center; margin: 20px 0;">
                <button class="btn" id="stepForwardBtn">Step Forward ➡️</button>
                <button class="btn" id="autoPlayBtn">▶️ Auto Play</button>
                <button class="task-reset-btn" data-exp="2">🔄 Reset</button>
            </div>
            <div class="question-box" id="experiment2Question" style="display: none;">
                <h3>Encapsulation: What is this process?</h3>
                <div class="answer-options">
                    <button class="answer-btn" data-answer="wrap">Wrapping data with protocol headers</button>
                    <button class="answer-btn" data-answer="compress">Compressing data to save space</button>
                    <button class="answer-btn" data-answer="encrypt">Encrypting data for security</button>
                </div>
                <div class="answer-feedback"></div>
            </div>
            <div style="text-align: center; margin-top: 30px;"><button id="nextBtn2" class="btn">Next Experiment →</button></div>
        </div>

        <!-- Experiment 3: Build Your Own Packet -->
        <div id="experiment3" class="lab-section">
            <h2>🎯 Experiment 3: Packet Assembly Workshop</h2>
            <div class="instructions">
                 <p>Time to build your own packet! On the left are the four headers you need. <strong>Click the header buttons in the correct order of encapsulation (from the inside out)</strong> to wrap the Email Data. The order of buttons has been shuffled for a challenge! If you make a mistake, use the 'Reset' button.</p>
            </div>
            <div class="interactive-area">
                <div class="control-panel" id="exp3-control-panel">
                    <h3>Available Headers:</h3>
                </div>
                <div class="visualization-area">
                    <h3>Your Packet:</h3>
                    <div id="packetBuilder" style="width: 100%;">
                         <div class="data-packet" id="dataPacketBuilder">
                            <div class="data-core">Email Message Data</div>
                        </div>
                    </div>
                    <p id="buildFeedback" style="margin-top: 20px; text-align: center; font-weight: bold;" role="status" aria-live="polite"></p>
                </div>
            </div>
            <div class="question-box" id="experiment3Question" style="display: none;">
                <h3>Packet Building: In which order are headers added during encapsulation?</h3>
                <div class="answer-options">
                    <button class="answer-btn" data-answer="top-down">Application → Transport → Internet → Network</button>
                    <button class="answer-btn" data-answer="bottom-up">Network → Internet → Transport → Application</button>
                    <button class="answer-btn" data-answer="random">Random order</button>
                </div>
                <div class="answer-feedback"></div>
            </div>
            <div style="text-align: center; margin-top: 30px;"><button id="nextBtn3" class="btn">Next Experiment →</button></div>
        </div>

        <!-- Experiment 4: Benefits of Layering -->
        <div id="experiment4" class="lab-section">
            <h2>💡 Experiment 4: Why Layers Matter</h2>
            <div class="instructions"><p><strong>Click on each of the four benefit cards below</strong> to understand why this layered model is so useful. Read all four to unlock the quiz.</p></div>
            <div class="benefits-grid">
                <div class="benefit-card" data-benefit="independence"><h4>Independence</h4><p>Each layer works independently</p><div class="benefit-detail"><strong>Example:</strong> When Wi-Fi 6 was developed, web browsers didn't need any updates. The new Network Access Layer technology worked with existing upper layers!</div></div>
                <div class="benefit-card" data-benefit="development"><h4>Parallel Development</h4><p>Different teams work on different layers</p><div class="benefit-detail"><strong>Example:</strong> Mozilla develops Firefox (Application Layer) while Cisco develops routers (Internet Layer). They don't need to coordinate!</div></div>
                <div class="benefit-card" data-benefit="troubleshooting"><h4>Easy Troubleshooting</h4><p>Problems isolated to specific layers</p><div class="benefit-detail"><strong>Example:</strong> Website won't load? Check: Can you ping? (Layer 2-3 OK) Can you connect to other sites? (Layer 4 issue with that server)</div></div>
                <div class="benefit-card" data-benefit="compatibility"><h4>Universal Compatibility</h4><p>Standards ensure everything works together</p><div class="benefit-detail"><strong>Example:</strong> Your iPhone can browse websites hosted on Linux servers through Windows routers - all thanks to layered standards!</div></div>
            </div>
            <div class="question-box" id="experiment4Question" style="display: none;">
                <h3>Benefits: Why can one layer be changed without affecting others?</h3>
                <div class="answer-options">
                    <button class="answer-btn" data-answer="independent">Layers are self-contained with defined interfaces</button>
                    <button class="answer-btn" data-answer="speed">It makes networks faster</button>
                    <button class="answer-btn" data-answer="security">It improves security</button>
                </div>
                <div class="answer-feedback"></div>
            </div>
            <div style="text-align: center; margin-top: 30px;"><button id="nextBtn4" class="btn">Next Experiment →</button></div>
        </div>
        
        <!-- Experiment 5: Troubleshooting Game -->
        <div id="experiment5" class="lab-section">
            <h2>🔧 Experiment 5: Network Troubleshooting Challenge</h2>
            <div class="instructions">
                <p>You are now a network technician! A problem has been reported. Your job is to find the broken layer.</p>
                <p><strong>The golden rule of troubleshooting is to always start at the bottom (Layer 1) and test each layer going up.</strong> Click on a layer to 'test' it. Read the result in the box below to see if it's working.</p>
            </div>
            <div class="troubleshoot-scenario">
                <h3>🚨 Problem Report:</h3><p id="problemDescription"></p>
            </div>
            <div class="layer-diagnostic">
                <div class="diagnostic-layer" data-layer="1"><h4>Layer 1</h4><p>Network Access</p></div>
                <div class="diagnostic-layer" data-layer="2"><h4>Layer 2</h4><p>Internet</p></div>
                <div class="diagnostic-layer" data-layer="3"><h4>Layer 3</h4><p>Transport</p></div>
                <div class="diagnostic-layer" data-layer="4"><h4>Layer 4</h4><p>Application</p></div>
            </div>
            <div id="diagnosticResult" style="padding: 20px; background: #f8f9fa; border-radius: 10px; display: none;" role="status" aria-live="polite">
                <h3 style="margin-bottom: 10px;">Diagnostic Result:</h3><p id="diagnosticText"></p>
            </div>
            <div style="margin-top: 20px; text-align: center;">
                <button class="task-reset-btn" data-exp="5">🎲 New Problem</button>
                <button class="btn" id="solutionBtn" style="display: none;">💡 Show Solution</button>
            </div>
            <div class="question-box" id="experiment5Question" style="display: none;">
                <h3>Final Challenge: Which statement about layers is NOT true?</h3>
                <div class="answer-options">
                    <button class="answer-btn" data-answer="speed">Layers make data transfer faster</button>
                    <button class="answer-btn" data-answer="independent">Layers can be developed independently</button>
                    <button class="answer-btn" data-answer="troubleshoot">Layers help isolate network problems</button>
                </div>
                <div class="answer-feedback"></div>
            </div>
            <div style="text-align: center; margin-top: 30px;"><button id="completeBtn" class="btn">Complete Lab 🏆</button></div>
        </div>

        <!-- Experiment 6: Bonus Interactive Analogy -->
        <div id="experiment6" class="lab-section">
            <h2>📮 Bonus Lab: The Postal Service Analogy</h2>
             <div class="instructions">
                <p>This is another way to think about encapsulation. Imagine sending a letter. <strong>Click the buttons in order</strong> to see how sending a letter is like sending data across a network.</p>
            </div>
            <div class="demo-area">
                <div class="demo-visual" id="analogyVisual">
                    <div class="analogy-item" id="analogyItem"><div class="analogy-core">Your Letter</div></div>
                </div>
            </div>
            <div style="text-align: center; margin: 20px 0;" id="analogy-controls"></div>
        </div>

        <div style="text-align: center; margin-top: 40px; border-top: 2px solid #fff; padding-top: 20px;">
             <button id="showBonusLabBtn" class="btn" style="background-color: #16a085;">Try the Bonus Analogy Lab 📮</button>
        </div>

    </div>
    
    <!-- Lab Assistant -->
    <div id="lab-assistant">
        <div id="assistant-hint"><p id="hint-text">Click me for a hint!</p></div>
        <svg id="assistant-icon" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><g><circle cx="50" cy="50" r="45" fill="#f0f0f0" stroke="#333" stroke-width="3"/><circle cx="35" cy="40" r="8" fill="#fff" stroke="#333" stroke-width="2"/><circle cx="65" cy="40" r="8" fill="#fff" stroke="#333" stroke-width="2"/><circle cx="35" cy="40" r="3" fill="#333"/><circle cx="65"cy="40" r="3" fill="#333"/><path d="M 30 65 Q 50 75 70 65" stroke="#333" stroke-width="3" fill="none"/><rect x="47" y="20" width="6" height="10" fill="#f0f0f0" stroke="#333" stroke-width="2"/></g></svg>
    </div>

    <script>
        'use strict';
        // --- STATE AND CONFIG ---
        const CONFIG = {
            TOTAL_EXPERIMENTS: 5,
            ANIMATION_DELAY: 1500,
        };
        const SimulationState = {
            progress: {
                layersExplored: new Set(),
                benefitsExplored: new Set(),
                experimentScores: {1: false, 2: false, 3: false, 4: false, 5: false}
            },
            packet: { headers: [] },
            encapsulation: { step: 0, timeouts: [], isAutoPlaying: false },
            analogy: { step: 0 },
            troubleshooting: { problem: null, layersTested: new Set() },
            currentExperiment: 1
        };

        // --- HINTS AND QUIZ FEEDBACK ---
        const assistantHints = {
            1: "The goal here is to learn what each layer does. Click on each of the four grey blocks to read about them.",
            2: "Encapsulation is like wrapping a present. Each layer adds its own wrapper. Watch the animation to see how it works.",
            3: "You need to add the headers in the correct order of encapsulation: from the Application layer (HTTP) down to the Network Access layer (Ethernet).",
            4: "Just like with Experiment 1, you need to click on all four of the benefit cards to see why layering is so useful in networking.",
            5: "The golden rule for troubleshooting is to start from the bottom (Layer 1) and work your way up. You can't test Layer 3 if Layer 1 is broken!",
            6: "This is just like the encapsulation demo, but with a real-world example. Follow the steps in order to see how sending a letter relates to sending data.",
            default: "Select an experiment to get started. I'm here to help!"
        };

        const quizFeedback = {
            1: { T: "That's right! The Transport Layer (using TCP) is responsible for breaking data into smaller packets for sending.", F: "Not quite. That layer has a different job. It's the **Transport Layer** that breaks data into packets. Try to remember that for next time!" },
            2: { T: "Exactly! Encapsulation is the process of wrapping data with the necessary headers for transmission.", F: "Think about the animation. Each layer adds a 'wrapper' or 'header' to the data. This process is called **wrapping**." },
            3: { T: "Correct! Data is encapsulated from the top down, starting with the Application layer.", F: "Not quite right. Data starts at the Application layer and has headers added as it moves **down** the stack." },
            4: { T: "That's it! Because each layer is self-contained and communicates through defined interfaces, they can be changed independently.", F: "Think about how a car is built. You can change the brand of tyres (Network Access Layer) without having to redesign the engine (Transport Layer). They are **independent**." },
            5: { T: "You got it! While layering makes networks more organized and reliable, it doesn't inherently make them faster. In fact, the process of encapsulation adds a tiny bit of overhead.", F: "Think carefully. Layering is all about organization, compatibility, and troubleshooting. Does it directly affect the **speed** of the data transfer itself?" }
        };

        const problems = [
            { d: "User reports: 'I can't access any websites at all!'", f: 1, s: "A problem with the physical connection, like a disconnected network cable or faulty Wi-Fi adapter." },
            { d: "User reports: 'I can access local network devices, but I can't get to the internet!'", f: 2, s: "A problem with the router or IP address configuration. The device can't find a path to the internet." },
            { d: "User reports: 'Websites load very slowly with frequent timeouts and connection errors.'", f: 3, s: "A problem with the TCP connection. Packets might be getting lost, causing constant retransmissions." },
            { d: "User reports: 'I can get to google.com, but I can't access our company's website by name!'", f: 4, s: "A problem at the application layer, most likely a DNS issue where the website's name can't be translated into an IP address." }
        ];

        // --- DOM ELEMENTS CACHE ---
        const DOMElements = {};

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            // Cache all frequently used DOM elements
            DOMElements.progressBar = document.getElementById('progressBar');
            DOMElements.labContainer = document.querySelector('.lab-container');
            DOMElements.assistantIcon = document.getElementById('assistant-icon');
            DOMElements.assistantHint = document.getElementById('assistant-hint');
            DOMElements.hintText = document.getElementById('hint-text');
            
            initializeApp();
        });

        function initializeApp() {
            attachEventListeners();
            showInstructions();
            resetAllExperiments();
            updateAssistantHint();
        }

        function attachEventListeners() {
            document.getElementById('closeInstructionsBtn').addEventListener('click', closeInstructions);
            document.getElementById('resetBtn').addEventListener('click', () => { if (confirm('Reset all lab progress?')) location.reload(); });
            DOMElements.assistantIcon.addEventListener('click', () => DOMElements.assistantHint.classList.toggle('show'));
            document.getElementById('showBonusLabBtn').addEventListener('click', () => showExperiment(6));
            DOMElements.labContainer.addEventListener('click', handleLabClick);
        }

        // --- UI & NAVIGATION ---
        function showInstructions() { document.getElementById('instructionsModal').style.display = 'block'; }
        function closeInstructions() { document.getElementById('instructionsModal').style.display = 'none'; }
        
        function updateProgress() {
            const completed = Object.values(SimulationState.progress.experimentScores).filter(v => v).length;
            const progress = (completed / CONFIG.TOTAL_EXPERIMENTS) * 100;
            DOMElements.progressBar.style.width = `${progress}%`;
            DOMElements.progressBar.textContent = `${Math.round(progress)}%`;
        }

        function showExperiment(expNum) {
            document.querySelectorAll('.lab-section').forEach(sec => sec.classList.remove('active'));
            const targetSection = document.getElementById(`experiment${expNum}`);
            if (targetSection) {
                targetSection.classList.add('active');
                SimulationState.currentExperiment = expNum;
                updateAssistantHint();
            }
        }
        
        function updateAssistantHint() {
            DOMElements.hintText.textContent = assistantHints[SimulationState.currentExperiment] || assistantHints.default;
            DOMElements.assistantHint.classList.remove('show');
        }

        // --- EVENT HANDLER ---
        function handleLabClick(e) {
            const target = e.target;
            const expNum = SimulationState.currentExperiment;
            
            // Task Resets
            if (target.classList.contains('task-reset-btn')) {
                const expToReset = target.dataset.exp;
                if(window[`resetExperiment${expToReset}`]) window[`resetExperiment${expToReset}`]();
                return;
            }

            // Next Buttons
            if (target.id === `nextBtn${expNum}` || target.id === 'completeBtn') {
                if (expNum < 6) {
                    showExperiment(expNum + 1);
                }
                return;
            }

            // Quiz Answers
            if (target.classList.contains('answer-btn')) {
                handleAnswerClick(target, expNum);
                return;
            }

            // Experiment-specific clicks
            switch(expNum) {
                case 1: if (target.closest('.layer-block')) exploreLayer(target.closest('.layer-block')); break;
                case 2: 
                    if (target.id === 'stepForwardBtn') stepEncapsulation();
                    if (target.id === 'autoPlayBtn') autoPlayEncapsulation();
                    break;
                case 3:
                    if(target.classList.contains('header-btn')) addHeader(target.dataset.header, target);
                    if(target.id === 'checkPacketBtn') checkPacketOrder();
                    break;
                case 4: if (target.closest('.benefit-card')) showBenefit(target.closest('.benefit-card')); break;
                case 5:
                    if (target.closest('.diagnostic-layer') && !target.closest('.diagnostic-layer').classList.contains('disabled')) testLayer(parseInt(target.closest('.diagnostic-layer').dataset.layer));
                    if (target.id === 'solutionBtn') alert(`Problem Cause: ${SimulationState.troubleshooting.problem.s}`);
                    break;
            }
        }

        function resetAllExperiments() {
            for(let i=1; i<=6; i++) {
                if(window[`resetExperiment${i}`]) window[`resetExperiment${i}`]();
            }
            showExperiment(1);
        }

        // --- EXPERIMENT LOGIC ---
        function resetExperiment1() {
            SimulationState.progress.layersExplored.clear();
            document.querySelectorAll('#experiment1 .layer-block').forEach(b => b.classList.remove('active'));
            resetQuiz(1);
        }
        function exploreLayer(layerDiv) {
            layerDiv.classList.add('active');
            SimulationState.progress.layersExplored.add(parseInt(layerDiv.dataset.layer));
            if (SimulationState.progress.layersExplored.size === 4) {
                document.getElementById('experiment1Question').style.display = 'block';
            }
        }

        const encapsulationSteps = [
            { h: 'HTTP Header', c: '#e91e63', i: 'Adds info about the data (e.g. GET request)' }, 
            { h: 'TCP Header', c: '#9c27b0', i: 'Adds Port Numbers to ensure data reaches the correct application' },
            { h: 'IP Header', c: '#3f51b5', i: 'Adds IP Addresses for routing across the internet' }, 
            { h: 'Ethernet Header', c: '#009688', i: 'Adds MAC Addresses for delivery on the local network' }
        ];
        function resetExperiment2() {
            const state = SimulationState.encapsulation;
            state.timeouts.forEach(clearTimeout);
            Object.assign(state, { step: 0, timeouts: [], isAutoPlaying: false });
            document.getElementById('dataPacket').innerHTML = '<div class="data-core">"Hello, Server!"</div>';
            document.getElementById('autoPlayBtn').disabled = false;
            document.getElementById('stepForwardBtn').disabled = false;
            resetQuiz(2);
        }
        function stepEncapsulation() {
            const state = SimulationState.encapsulation;
            if (state.step >= encapsulationSteps.length) return;
            const stepData = encapsulationSteps[state.step];
            const visualElement = document.getElementById('dataPacket');
            visualElement.innerHTML = createWrapper(stepData.h, stepData.c, stepData.i, visualElement.innerHTML);
            state.step++;
            if (state.step >= encapsulationSteps.length) {
                document.getElementById('experiment2Question').style.display = 'block';
                document.getElementById('autoPlayBtn').disabled = true;
                document.getElementById('stepForwardBtn').disabled = true;
            }
        }
        function autoPlayEncapsulation() {
            const state = SimulationState.encapsulation;
            if (state.isAutoPlaying) return;
            state.isAutoPlaying = true;
            document.getElementById('autoPlayBtn').disabled = true;
            document.getElementById('stepForwardBtn').disabled = true;
            const runNextStep = () => {
                if (state.step < encapsulationSteps.length) {
                    stepEncapsulation();
                    state.timeouts.push(setTimeout(runNextStep, CONFIG.ANIMATION_DELAY));
                } else { state.isAutoPlaying = false; }
            };
            runNextStep();
        }

        function resetExperiment3() {
            SimulationState.packet.headers = [];
            document.getElementById('dataPacketBuilder').innerHTML = '<div class="data-core">Email Message Data</div>';
            document.getElementById('buildFeedback').textContent = '';
            
            const panel = document.getElementById('exp3-control-panel');
            panel.innerHTML = '<h3>Available Headers:</h3>';
            let headers = [...encapsulationSteps];
            // Shuffle
            for (let i = headers.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [headers[i], headers[j]] = [headers[j], headers[i]];
            }
            headers.forEach(h => {
                const btn = document.createElement('button');
                btn.className = 'action-btn header-btn';
                btn.textContent = `Add ${h.h}`;
                btn.dataset.header = h.h.split(' ')[0];
                panel.appendChild(btn);
            });
            const checkBtn = document.createElement('button');
            checkBtn.className = 'btn';
            checkBtn.id = 'checkPacketBtn';
            checkBtn.textContent = '✓ Check Order';
            const resetBtn = document.createElement('button');
            resetBtn.className = 'task-reset-btn';
            resetBtn.dataset.exp = 3;
            resetBtn.textContent = '🔄 Reset';
            const div = document.createElement('div');
            div.style.marginTop = '20px';
            div.append(checkBtn, resetBtn);
            panel.appendChild(div);

            resetQuiz(3);
        }
        function addHeader(type, btn) {
            const builder = document.getElementById('dataPacketBuilder');
            const stepData = encapsulationSteps.find(s => s.h.startsWith(type));
            builder.innerHTML = createWrapper(stepData.h, stepData.c, stepData.i, builder.innerHTML);
            SimulationState.packet.headers.push(type);
            btn.disabled = true;
        }
        function checkPacketOrder() {
            const correctOrder = ['HTTP', 'TCP', 'IP', 'Ethernet'];
            const isCorrect = JSON.stringify(SimulationState.packet.headers) === JSON.stringify(correctOrder);
            const feedback = document.getElementById('buildFeedback');
            if (isCorrect) {
                feedback.textContent = '✓ Perfect! Headers added in correct encapsulation order!';
                feedback.style.color = '#4caf50';
                document.getElementById('experiment3Question').style.display = 'block';
            } else {
                feedback.textContent = '✗ Incorrect order. Remember to build from the inside out (Application -> Network). Try resetting.';
                feedback.style.color = '#f44336';
            }
        }

        function resetExperiment4() {
            SimulationState.progress.benefitsExplored.clear();
            document.querySelectorAll('.benefit-detail').forEach(d => d.classList.remove('show'));
            document.querySelectorAll('.benefit-card').forEach(c => c.setAttribute('aria-expanded', 'false'));
            resetQuiz(4);
        }
        function showBenefit(card) {
            const detail = card.querySelector('.benefit-detail');
            const benefitName = card.dataset.benefit;
            const isVisible = detail.classList.contains('show');
            document.querySelectorAll('.benefit-detail').forEach(d => d.classList.remove('show'));
            if (!isVisible) {
                detail.classList.add('show');
                SimulationState.progress.benefitsExplored.add(benefitName);
                if (SimulationState.progress.benefitsExplored.size === 4) {
                    document.getElementById('experiment4Question').style.display = 'block';
                }
            }
        }
        
        function resetExperiment5() {
            const state = SimulationState.troubleshooting;
            state.problem = problems[Math.floor(Math.random() * problems.length)];
            state.layersTested.clear();
            document.getElementById('problemDescription').textContent = state.problem.d;
            
            document.querySelectorAll('.diagnostic-layer').forEach(layer => {
                layer.className = 'diagnostic-layer'; // Reset classes
                const layerNum = parseInt(layer.dataset.layer);
                if (layerNum !== 1) {
                    layer.classList.add('disabled');
                }
            });
            
            document.getElementById('diagnosticResult').style.display = 'none';
            document.getElementById('solutionBtn').style.display = 'none';
            resetQuiz(5);
        }

        function testLayer(layerNum) {
            const state = SimulationState.troubleshooting;
            const resultDiv = document.getElementById('diagnosticResult');
            const resultText = document.getElementById('diagnosticText');
            
            const expectedLayer = state.layersTested.size + 1;
            if (layerNum !== expectedLayer) {
                resultDiv.style.display = 'block';
                resultText.innerHTML = `<strong>Sequence Error:</strong> Please test the layers from bottom to top. The next layer to test is Layer ${expectedLayer}.`;
                return;
            }

            const layerDiv = document.querySelector(`.diagnostic-layer[data-layer="${layerNum}"]`);
            layerDiv.classList.add('checking');
            resultDiv.style.display = 'block';
            resultText.innerHTML = `Running diagnostics on Layer ${layerNum}...`;
            
            setTimeout(() => {
                layerDiv.classList.remove('checking');
                state.layersTested.add(layerNum); 

                if (layerNum < state.problem.f) {
                    layerDiv.classList.add('working');
                    resultText.innerHTML = `<strong>Layer ${layerNum} Test:</strong> <span style="color:green;">PASSED</span>. Components at this layer are working. You should test the next layer up.`;
                    
                    const nextLayer = document.querySelector(`.diagnostic-layer[data-layer="${layerNum + 1}"]`);
                    if (nextLayer) {
                        nextLayer.classList.remove('disabled');
                    }
                } else {
                    layerDiv.classList.add('faulty');
                    resultText.innerHTML = `<strong>Layer ${layerNum} Test:</strong> <span style="color:red;">FAILED</span>. A fault was detected. You've found the problem!`;
                    document.getElementById('solutionBtn').style.display = 'inline-block';
                    document.getElementById('experiment5Question').style.display = 'block';
                    document.querySelectorAll('.diagnostic-layer').forEach(l => {
                        if (!state.layersTested.has(parseInt(l.dataset.layer))) {
                            l.classList.add('disabled');
                        }
                    });
                }
            }, CONFIG.ANIMATION_DELAY);
        }

        function resetExperiment6() {
            SimulationState.analogy.step = 0;
            document.getElementById('analogyItem').innerHTML = '<div class="analogy-core">Your Letter</div>';
            document.querySelectorAll('#analogy-controls .btn').forEach(b => b.disabled = false);
        }
        const analogySteps = [ 
            { a: "Put in Envelope", l: "Envelope (TCP)", c: "#9c27b0", i: "Adds the recipient's door number (Port)"}, 
            { a: "Put in Shipping Box", l: "Box (IP)", c: "#3f51b5", i: "Adds the street address (IP Address)"}, 
            { a: "Add Shipping Label", l: "Label (Ethernet)", c: "#009688", i: "Adds the specific person's name (MAC Address)" }
        ];
        function setupAnalogyLab() {
            const controls = document.getElementById('analogy-controls');
            controls.innerHTML = '';
            analogySteps.forEach((step, index) => {
                const btn = document.createElement('button');
                btn.className = 'btn';
                btn.textContent = step.a;
                btn.dataset.step = index;
                btn.addEventListener('click', runAnalogyStep);
                controls.appendChild(btn);
            });
            controls.innerHTML += `<button class="task-reset-btn" data-exp="6">🔄 Reset</button>`;
        }
        function runAnalogyStep(e) {
            const stepIndex = parseInt(e.target.dataset.step);
            if (stepIndex !== SimulationState.analogy.step) { alert("Whoops! Please follow the steps in order."); return; }
            const stepData = analogySteps[stepIndex];
            const visualElement = document.getElementById('analogyItem');
            visualElement.innerHTML = createWrapper(stepData.l, stepData.c, stepData.i, visualElement.innerHTML, 'analogy-wrapper', 'analogy-label');
            e.target.disabled = true;
            SimulationState.analogy.step++;
        }

        // --- QUIZ & HELPERS ---
        const correctAnswers = { 1: 'Transport', 2: 'wrap', 3: 'top-down', 4: 'independent', 5: 'speed' };
        function handleAnswerClick(btn, expNum) {
            const feedbackData = quizFeedback[expNum];
            if (!feedbackData) return;
            const questionBox = btn.closest('.question-box');
            const feedbackDiv = questionBox.querySelector('.answer-feedback');
            const isCorrect = btn.dataset.answer === correctAnswers[expNum];

            feedbackDiv.innerHTML = isCorrect ? feedbackData.T : feedbackData.F;
            feedbackDiv.className = `answer-feedback show ${isCorrect ? 'correct' : 'incorrect'}`;
            
            if (isCorrect) {
                SimulationState.progress.experimentScores[expNum] = true;
                updateProgress();
            }
            questionBox.querySelectorAll('.answer-btn').forEach(b => {
                if(b !== btn) b.disabled = true;
                b.classList.add(b === btn && isCorrect ? 'correct' : 'incorrect');
            });
        }
        
        function resetQuiz(expNum) {
            const questionBox = document.getElementById(`experiment${expNum}Question`);
            if(!questionBox) return;
            questionBox.style.display = 'none';
            const feedbackDiv = questionBox.querySelector('.answer-feedback');
            feedbackDiv.className = 'answer-feedback';
            questionBox.querySelectorAll('.answer-btn').forEach(btn => {
                btn.disabled = false;
                btn.className = 'answer-btn';
            });
        }

        function createWrapper(labelText, color, infoText, content, wrapperClass = 'header-wrapper', labelClass = 'header-label') {
            return `<div class="${wrapperClass}" style="border-color: ${color};">
                        <span class="${labelClass}" style="color: ${color};">${labelText}</span>
                        <div class="info-text" style="color:${color};">${infoText}</div>
                        ${content}
                    </div>`;
        }
    </script>
</body>
</html>
