<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sound Binary Encoding Simulation (Improved)</title>
    <style>
        :root {
            --primary: #00d9ff;
            --primary-dark: #00a8cc;
            --secondary: #00f5ff;
            --accent: #ff00ff;
            --bg-dark: #0a0e27;
            --bg-medium: #151935;
            --bg-light: #1e2547;
            --text-primary: #ffffff;
            --text-secondary: #a8b2d1;
            --success: #00ff88;
            --warning: #ffaa00;
            --error: #ff4444;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, var(--bg-medium) 50%, var(--bg-light) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            font-synthesis: none;
            text-rendering: optimizeLegibility;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 40px 0;
            animation: fadeInDown 0.8s ease;
        }

        h1 {
            font-size: clamp(2em, 5vw, 3em);
            margin-bottom: 10px;
            background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 50%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent;
        }

        .subtitle {
            font-size: 1.2em;
            color: var(--text-secondary);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        .tabs { display: flex; justify-content: center; margin: 30px 0; flex-wrap: wrap; gap: 10px; }
        .tab { padding: 12px 24px; background: rgba(255, 255, 255, 0.1); border: 2px solid transparent; border-radius: 30px; cursor: pointer; transition: all 0.3s ease; font-weight: 500; position: relative; overflow: hidden; }
        .tab::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent); transition: left 0.5s; }
        .tab:hover::before { left: 100%; }
        .tab:hover { background: rgba(255, 255, 255, 0.2); transform: translateY(-2px); }
        .tab.active { background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%); box-shadow: 0 4px 20px rgba(0, 217, 255, 0.3); }
        .section { display: none; background: rgba(255, 255, 255, 0.05); border-radius: 20px; padding: 40px; backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); animation: slideIn 0.5s ease; }
        .section.active { display: block; }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 20px 0; }
        .result-box { background: rgba(0, 0, 0, 0.3); border-radius: 15px; padding: 20px; margin: 20px 0; border: 1px solid rgba(255, 255, 255, 0.1); transition: all 0.3s ease; }
        .result-box:hover { border-color: rgba(255, 255, 255, 0.2); box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2); }
        .info-card { background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%); border-radius: 15px; padding: 20px; margin: 20px 0; border: 1px solid rgba(255, 255, 255, 0.2); position: relative; overflow: hidden; }
        .info-card::after { content: ''; position: absolute; top: -50%; right: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(0,217,255,0.1) 0%, transparent 70%); animation: pulse 4s ease-in-out infinite; }
        .button { padding: 12px 30px; background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%); border: none; border-radius: 25px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s ease; margin: 10px 5px; position: relative; overflow: hidden; }
        .button::after { content: ''; position: absolute; top: 50%; left: 50%; width: 0; height: 0; border-radius: 50%; background: rgba(255, 255, 255, 0.3); transform: translate(-50%, -50%); transition: width 0.6s, height 0.6s; }
        .button:active::after { width: 300px; height: 300px; }
        .button:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(0, 217, 255, 0.4); }
        .button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; box-shadow: none; }
        .button.recording { background: linear-gradient(90deg, #ff4444 0%, #ff6666 100%); animation: recordPulse 1s ease-in-out infinite; }
        .slider-container { margin: 20px 0; }
        .slider-container label { display: block; margin-bottom: 10px; font-weight: 500; color: var(--primary); }
        input[type="range"] { width: 100%; height: 8px; background: rgba(255, 255, 255, 0.1); border-radius: 5px; outline: none; -webkit-appearance: none; appearance: none;}
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 25px; height: 25px; background: var(--primary); border-radius: 50%; cursor: pointer; box-shadow: 0 0 20px rgba(0, 217, 255, 0.5); transition: all 0.2s ease; }
        input[type="range"]::-moz-range-thumb { width: 25px; height: 25px; background: var(--primary); border-radius: 50%; cursor: pointer; box-shadow: 0 0 20px rgba(0, 217, 255, 0.5); border: none; }
        input[type="range"]::-webkit-slider-thumb:hover { transform: scale(1.2); }
        input[type="range"]::-moz-range-thumb:hover { transform: scale(1.2); }
        .waveform-container { position: relative; background: rgba(0, 0, 0, 0.5); border-radius: 10px; padding: 20px; margin: 20px 0; overflow: hidden; }
        canvas { display: block; width: 100%; height: auto; border-radius: 5px; cursor: crosshair; }
        .binary-display { font-family: 'Courier New', monospace; background: rgba(0, 0, 0, 0.5); padding: 15px; border-radius: 10px; margin: 10px 0; word-break: break-all; font-size: 14px; line-height: 1.6; position: relative; overflow: hidden; max-height: 200px; overflow-y: auto; }
        .binary-display::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(0, 217, 255, 0.1), transparent); animation: scan 3s linear infinite; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 20px 0; }
        .stat-card { background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 15px; text-align: center; transition: all 0.3s ease; cursor: pointer; }
        .stat-card:hover { transform: translateY(-5px); background: rgba(255, 255, 255, 0.08); box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2); }
        .stat-value { font-size: 2em; font-weight: bold; color: var(--primary); margin-bottom: 5px; }
        .comparison-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 20px 0; }
        .sample-card { background: rgba(255, 255, 255, 0.05); border-radius: 15px; padding: 20px; text-align: center; transition: all 0.3s ease; }
        .sample-card:hover { transform: translateY(-3px); box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2); }
        .visualizer { width: 100%; height: 100px; background: rgba(0, 0, 0, 0.3); border-radius: 10px; margin: 10px 0; position: relative; overflow: hidden; display: flex; align-items: flex-end; gap: 1%; padding: 0 1%; }
        .visualizer-bar { flex-grow: 1; height: 0%; background: var(--primary); transition: height 0.1s ease; }
        .progress-bar { width: 100%; height: 10px; background: rgba(255, 255, 255, 0.1); border-radius: 5px; overflow: hidden; margin: 20px 0; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%); transition: width 0.3s ease; box-shadow: 0 0 10px rgba(0, 217, 255, 0.5); }
        .tooltip { position: relative; display: inline-block; cursor: help; color: var(--primary); }
        .tooltip::after { content: attr(data-tooltip); position: absolute; bottom: 125%; left: 50%; transform: translateX(-50%); background: rgba(0, 0, 0, 0.9); color: white; padding: 8px 12px; border-radius: 8px; white-space: nowrap; font-size: 14px; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 10; }
        .tooltip:hover::after { opacity: 1; }
        /* Improved Dropdown Styling */
        select {
            color: var(--text-primary);
            background-color: var(--bg-medium); /* Dark background for the select */
            -webkit-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%2300d9ff%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: .65em auto;
            width: 100%; padding: 12px; border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 10px; font-size: 16px; cursor: pointer; transition: all 0.3s ease;
        }
        select:focus { outline: none; border-color: var(--primary); }
        /* Style for the options in the dropdown */
        select option {
            background-color: var(--bg-dark);
            color: var(--text-primary);
        }
        .quiz-option { padding: 15px; background: rgba(255, 255, 255, 0.1); border: 2px solid transparent; border-radius: 10px; margin: 10px 0; cursor: pointer; transition: all 0.3s ease; }
        .quiz-option:hover { border-color: var(--primary); background: rgba(255, 255, 255, 0.15); transform: translateX(5px); }
        .quiz-option.selected { background-color: rgba(0, 217, 255, 0.2); border-color: var(--primary); }
        .quiz-option.correct { background: rgba(0, 255, 136, 0.2); border-color: var(--success); }
        .quiz-option.incorrect { background: rgba(255, 68, 68, 0.2); border-color: var(--error); }
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes pulse { 0%, 100% { transform: scale(0.8); opacity: 0.5; } 50% { transform: scale(1.2); opacity: 0.8; } }
        @keyframes recordPulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(255, 68, 68, 0.7); } 50% { box-shadow: 0 0 0 10px rgba(255, 68, 68, 0); } }
        @keyframes scan { 0% { left: -100%; } 100% { left: 100%; } }
        @media (max-width: 768px) { .container { padding: 10px; } .section { padding: 20px; } .grid-container { grid-template-columns: 1fr; } .tabs { flex-direction: column; align-items: center; } .tab { width: 80%; text-align: center; } }
        @media (prefers-reduced-motion: reduce) { *, *::before, *::after { animation: none !important; transition: none !important; } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Sound Binary Encoding</h1>
            <p class="subtitle">Learn how analog sound becomes digital data</p>
        </header>

        <div class="tabs">
            <div class="tab active" data-section="basics">Sound Basics</div>
            <div class="tab" data-section="sampling">Sampling</div>
            <div class="tab" data-section="bitdepth">Bit Depth</div>
            <div class="tab" data-section="comparison">Quality Comparison</div>
            <div class="tab" data-section="recorder">Sound Recorder</div>
            <div class="tab" data-section="binary">Binary Viewer</div>
            <div class="tab" data-section="quiz">Quiz</div>
        </div>

        <div class="content">
            <!-- Sound Basics Section -->
            <div id="basics" class="section active">
                <h2>Understanding Sound Waves</h2>
                <p style="margin-bottom: 20px;">Sound is a continuous analog wave that must be converted to digital form</p>
                <div class="grid-container">
                    <div>
                        <h3>Analog Sound Wave</h3>
                        <div class="waveform-container"><canvas id="analogWave" width="400" height="200"></canvas></div>
                    </div>
                    <div>
                        <h3>Digital Representation</h3>
                        <div class="waveform-container"><canvas id="digitalWave" width="400" height="200"></canvas></div>
                    </div>
                </div>
                <div class="result-box">
                    <h3>Try Different Wave Types</h3>
                    <div style="text-align: center;">
                        <button class="button" data-wave="sine">Sine</button>
                        <button class="button" data-wave="square">Square</button>
                        <button class="button" data-wave="sawtooth">Sawtooth</button>
                        <button class="button" data-wave="triangle">Triangle</button>
                    </div>
                </div>
            </div>

            <!-- Sampling Section -->
            <div id="sampling" class="section">
                 <h2>Sample Rate</h2>
                <p style="margin-bottom: 20px;">How often we measure the sound wave per second (measured in Hz)</p>
                <div class="result-box">
                    <div class="slider-container">
                        <label>Sample Rate: <span id="sampleRateValue">44100</span> Hz <span class="tooltip" data-tooltip="44.1 kHz is CD quality">ℹ️</span></label>
                        <input type="range" id="sampleRateSlider" min="1000" max="48000" value="44100" step="1000">
                    </div>
                    <div class="waveform-container"><canvas id="samplingCanvas" width="800" height="300"></canvas></div>
                    <div class="stats">
                        <div class="stat-card"><div class="stat-value" id="samplesPerSecond">44,100</div><p>Samples/Sec</p></div>
                        <div class="stat-card"><div class="stat-value" id="maxFrequency">22.05 kHz</div><p>Max Frequency</p></div>
                        <div class="stat-card"><div class="stat-value" id="quality">CD Quality</div><p>Quality Level</p></div>
                    </div>
                </div>
            </div>

            <!-- Bit Depth Section -->
            <div id="bitdepth" class="section">
                <h2>Bit Depth</h2>
                <p style="margin-bottom: 20px;">How precisely we measure each sample (number of bits per sample)</p>
                <div class="result-box">
                    <div class="slider-container">
                        <label>Bit Depth: <span id="bitDepthValue">16</span> bits</label>
                        <input type="range" id="bitDepthSlider" min="1" max="24" value="16">
                    </div>
                    <div class="waveform-container"><canvas id="bitDepthCanvas" width="800" height="400"></canvas></div>
                    <div class="stats">
                        <div class="stat-card"><div class="stat-value" id="possibleValues">65,536</div><p>Possible Values</p></div>
                        <div class="stat-card"><div class="stat-value" id="dynamicRange">96 dB</div><p>Dynamic Range</p></div>
                        <div class="stat-card"><div class="stat-value" id="noiseFloor">-96 dB</div><p>Noise Floor</p></div>
                    </div>
                </div>
            </div>

            <!-- Quality Comparison Section -->
            <div id="comparison" class="section">
                 <h2>Quality vs File Size</h2>
                <p style="margin-bottom: 20px;">See how different settings affect quality and storage requirements</p>
                <div class="grid-container">
                     <div>
                        <h3>Settings</h3>
                        <div class="result-box">
                            <div class="slider-container">
                                <label>Duration: <span id="durationValue">10</span> seconds</label>
                                <input type="range" id="durationSlider" min="1" max="60" value="10">
                            </div>
                            <label>Sample Rate:</label>
                            <select id="comparisonSampleRate">
                                <option value="8000">8,000 Hz (Phone)</option>
                                <option value="22050">22,050 Hz (AM Radio)</option>
                                <option value="44100" selected>44,100 Hz (CD)</option>
                                <option value="48000">48,000 Hz (Studio)</option>
                            </select>
                            <label style="margin-top: 15px;">Bit Depth:</label>
                            <select id="comparisonBitDepth">
                                <option value="8">8-bit</option>
                                <option value="16" selected>16-bit</option>
                                <option value="24">24-bit</option>
                            </select>
                            <label style="margin-top: 15px;">Channels:</label>
                            <select id="comparisonChannels">
                                <option value="1">Mono</option>
                                <option value="2" selected>Stereo</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <h3>Results</h3>
                        <div class="result-box">
                             <div class="stats">
                                <div class="stat-card"><div class="stat-value" id="fileSize">1.76 MB</div><p>File Size</p></div>
                                <div class="stat-card"><div class="stat-value" id="bitRate">1,411 kbps</div><p>Bit Rate</p></div>
                            </div>
                            <div class="progress-bar"><div class="progress-fill" id="sizeBar" style="width: 1.76%;"></div></div>
                            <p style="text-align: center;">Storage used: <span id="storagePercent">1.76%</span> of 100 MB</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sound Recorder Section -->
            <div id="recorder" class="section">
                <h2>Record & Analyze</h2>
                <p style="margin-bottom: 20px;">Record your own sound and see it converted to digital</p>
                 <div class="grid-container">
                    <div>
                        <h3>Recorder Controls</h3>
                        <div class="result-box">
                            <div style="text-align: center;">
                                <button class="button" id="recordButton">🎤 Start Recording</button>
                                <button class="button" id="playButton" disabled>▶️ Play Recording</button>
                            </div>
                            <div class="visualizer" id="liveVisualizer" style="margin-top: 20px; height: 150px;"></div>
                            <div id="recordingInfo" style="margin-top: 20px; display: none;">
                                <p>Duration: <span id="recordDuration">0.0</span> seconds</p>
                                <p>File Size: <span id="recordSize">0 KB</span></p>
                            </div>
                        </div>
                    </div>
                     <div>
                        <h3>Waveform Analysis</h3>
                        <div class="result-box">
                            <div class="waveform-container"><canvas id="recordedWaveform" width="400" height="200"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Binary Viewer Section -->
            <div id="binary" class="section">
                <h2>Binary Data Viewer</h2>
                <p style="margin-bottom: 20px;">See how sound samples are stored as binary data</p>
                <div class="grid-container">
                    <div>
                        <h3>Sample Values</h3>
                        <div class="result-box">
                            <p>Click on the waveform to select a sample:</p>
                            <div class="waveform-container"><canvas id="binaryWaveform" width="400" height="200"></canvas></div>
                            <div id="sampleInfo" style="margin-top: 20px;">
                                <p><strong>Amplitude:</strong> <span id="sampleAmplitude">-</span></p>
                                <p><strong>Decimal (16-bit):</strong> <span id="decimalValue">-</span></p>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h3>Binary Representation (16-bit)</h3>
                        <div class="result-box">
                            <div class="binary-display" id="sampleBinary">Select a sample...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quiz Section -->
            <div id="quiz" class="section">
                <h2>Test Your Knowledge</h2>
                <div class="result-box" id="quizContainer"></div>
                <div style="text-align: center; margin: 20px 0;">
                    <button class="button" id="startQuiz">🎯 Start Quiz</button>
                    <button class="button" id="submitQuiz" style="display: none;">📊 Submit Quiz</button>
                </div>
                <div class="result-box" id="quizResults" style="display: none;">
                    <h3>Quiz Results</h3>
                    <p style="text-align: center; font-size: 1.5em; margin: 20px 0;">Score: <span id="quizScore">0</span>%</p>
                    <div id="quizFeedback"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // =================================================================================
        // IMPROVED JAVASCRIPT (FIXED)
        // =================================================================================
        
        const appState = {
            audioContext: null,
            analyser: null,
            microphone: null,
            mediaRecorder: null, // Using MediaRecorder API now
            recordedBuffer: null,
            isRecording: false,
            currentWaveType: 'sine',
            recordedChunks: [],
            animationFrameId: null,
            quizAnswers: {},
            selectedBinarySampleIndex: -1, 
        };

        const constants = {
            FFT_SIZE: 2048,
            DB_PER_BIT: 6,
            MAX_STORAGE_MB: 100
        };

        const quizQuestions = [
            { question: "What does sample rate measure?", options: ["The volume of the sound", "How many times per second the sound is measured", "The bit depth of each sample", "The file size of the audio"], correct: 1, explanation: "Sample rate (Hz) is the number of samples taken per second." },
            { question: "What is the standard sample rate for CD-quality audio?", options: ["22,050 Hz", "32,000 Hz", "44,100 Hz", "48,000 Hz"], correct: 2, explanation: "CDs use 44,100 Hz to capture frequencies up to 22.05 kHz, covering the range of human hearing." },
            { question: "How many possible amplitude values can a 16-bit sample represent?", options: ["256", "1,024", "32,768", "65,536"], correct: 3, explanation: "A 16-bit number can represent 2^16 = 65,536 distinct values." },
            { question: "What is the main consequence of reducing audio bit depth?", options: ["The file gets larger", "The dynamic range is reduced and noise increases", "The sample rate increases", "The audio plays faster"], correct: 1, explanation: "Lower bit depth reduces the number of possible amplitude levels, decreasing dynamic range and increasing quantization noise." },
            { question: "According to the Nyquist theorem, what's the maximum frequency a 48 kHz sample rate can accurately capture?", options: ["12 kHz", "24 kHz", "48 kHz", "96 kHz"], correct: 1, explanation: "The Nyquist theorem states you must sample at least twice the maximum frequency. Therefore, a 48 kHz sample rate can capture frequencies up to 24 kHz." }
        ];

        // ---------------------------------------------------------------------------------
        // CORE LOGIC & DEFINITIONS
        // ---------------------------------------------------------------------------------
        
        function initAudio() {
            if (!appState.audioContext) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                appState.audioContext = new AudioContext();
                appState.analyser = appState.audioContext.createAnalyser();
                appState.analyser.fftSize = constants.FFT_SIZE;
            }
            if (appState.audioContext.state === 'suspended') {
                appState.audioContext.resume();
            }
        }

        function showSection(sectionId) {
            console.log('showSection called with:', sectionId);
            // Deactivate all tabs and sections first
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));

            // Activate the correct one
            const tabToActivate = document.querySelector(`.tab[data-section="${sectionId}"]`);
            const sectionToActivate = document.getElementById(sectionId);
            
            console.log('Tab to activate:', tabToActivate);
            console.log('Section to activate:', sectionToActivate);

            if (tabToActivate) {
                tabToActivate.classList.add('active');
            }
            if (sectionToActivate) {
                sectionToActivate.classList.add('active');
            }
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const units = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return `${parseFloat((bytes / Math.pow(1024, i)).toFixed(2))} ${units[i]}`;
        }
        
        function drawGridAndAxes(ctx, width, height, options = {}) {
            const { xGridLines = 10, yGridLines = 8 } = options;
            ctx.save();
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.15)';
            ctx.lineWidth = 0.5;
            
            for (let i = 1; i < xGridLines; i++) {
                const x = (i / xGridLines) * width;
                ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, height); ctx.stroke();
            }
            if (yGridLines > 1) {
                for (let i = 1; i < yGridLines; i++) {
                    const y = (i / yGridLines) * height;
                    ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(width, y); ctx.stroke();
                }
            }

            ctx.strokeStyle = 'rgba(255, 255, 255, 0.4)';
            ctx.lineWidth = 1;
            ctx.beginPath(); ctx.moveTo(0, height / 2); ctx.lineTo(width, height / 2); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(0, height); ctx.stroke();
            ctx.restore();
        }

        function drawWaveforms() {
            drawAnalogWave();
            drawDigitalWave();
        }

        function drawAnalogWave() {
            const canvas = document.getElementById('analogWave');
            const ctx = canvas.getContext('2d');
            const { width, height } = canvas;
            ctx.clearRect(0, 0, width, height);
            drawGridAndAxes(ctx, width, height, {yGridLines: 4});
            ctx.strokeStyle = '#00d9ff';
            ctx.lineWidth = 2;
            ctx.beginPath();
            for (let x = 0; x < width; x++) {
                const t = x / width * 4 * Math.PI;
                let y;
                switch (appState.currentWaveType) {
                    case 'sine': y = Math.sin(t); break;
                    case 'square': y = Math.sign(Math.sin(t)); break;
                    case 'sawtooth': y = (t % (2 * Math.PI)) / Math.PI - 1; break;
                    case 'triangle': y = (2 / Math.PI) * Math.asin(Math.sin(t)); break;
                    default: y = 0;
                }
                const plotY = height / 2 - y * height / 3;
                x === 0 ? ctx.moveTo(x, plotY) : ctx.lineTo(x, plotY);
            }
            ctx.stroke();
        }

        function drawDigitalWave() {
            const canvas = document.getElementById('digitalWave');
            const ctx = canvas.getContext('2d');
            const { width, height } = canvas;
            const sampleRate = 20;
            ctx.clearRect(0, 0, width, height);
            drawGridAndAxes(ctx, width, height, { yGridLines: 4 });

            const samples = [];
            for (let i = 0; i <= sampleRate; i++) {
                const t = i / sampleRate * 4 * Math.PI;
                let value;
                switch (appState.currentWaveType) {
                    case 'sine': value = Math.sin(t); break;
                    case 'square': value = Math.sign(Math.sin(t)); break;
                    case 'sawtooth': value = (t % (2 * Math.PI)) / Math.PI - 1; break;
                    case 'triangle': value = (2 / Math.PI) * Math.asin(Math.sin(t)); break;
                    default: value = 0;
                }
                samples.push(height / 2 - value * height / 3);
            }
            
            ctx.strokeStyle = '#00d9ff';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(0, samples[0]);
            for (let i = 1; i < samples.length; i++) {
                const x = (i / sampleRate) * width;
                const prevX = ((i-1) / sampleRate) * width;
                const y = samples[i];
                const prevY = samples[i-1];
                
                ctx.moveTo(prevX, prevY);
                ctx.lineTo(x, prevY);
                ctx.lineTo(x, y);
            }
            ctx.stroke();

            samples.forEach((y, i) => {
                const x = (i / sampleRate) * width;
                
                ctx.save();
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(x, height / 2);
                ctx.lineTo(x, y);
                ctx.stroke();
                ctx.restore();
                
                ctx.fillStyle = '#ff00ff';
                ctx.beginPath();
                ctx.arc(x, y, 4, 0, Math.PI * 2);
                ctx.fill();
            });
        }
        
        function updateBitDepth() {
            const bitDepth = parseInt(document.getElementById('bitDepthSlider').value);
            const possibleValues = Math.pow(2, bitDepth);
            document.getElementById('bitDepthValue').textContent = bitDepth;
            document.getElementById('possibleValues').textContent = possibleValues.toLocaleString();
            document.getElementById('dynamicRange').textContent = `${bitDepth * constants.DB_PER_BIT} dB`;
            document.getElementById('noiseFloor').textContent = `-${bitDepth * constants.DB_PER_BIT} dB`;
            drawBitDepthDemo(bitDepth);
        }

        function drawBitDepthDemo(bitDepth, options = {}) {
            const { hoverX = null } = options;
            const canvas = document.getElementById('bitDepthCanvas');
            const ctx = canvas.getContext('2d');
            const { width, height } = canvas;
            ctx.clearRect(0, 0, width, height);
            const levels = Math.pow(2, bitDepth);
            
            const gridLines = (levels <= 64) ? levels : 0;
            drawGridAndAxes(ctx, width, height, { yGridLines: gridLines });

            ctx.strokeStyle = 'rgba(0, 217, 255, 0.4)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            for (let x = 0; x < width; x++) {
                const t = (x / width) * 2 * Math.PI;
                const y = height / 2 - Math.sin(t) * (height / 2 - 20);
                x === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
            }
            ctx.stroke();

            ctx.strokeStyle = '#00d9ff';
            ctx.lineWidth = 3;
            ctx.beginPath();
            for (let x = 0; x < width; x++) {
                const t = (x / width) * 2 * Math.PI;
                const originalValue = Math.sin(t);
                const normalized = (originalValue + 1) / 2;
                const quantizedNormalized = Math.round(normalized * (levels - 1)) / (levels - 1);
                const y = height - (quantizedNormalized * (height-40) + 20);
                x === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
            }
            ctx.stroke();
            
            if (hoverX !== null) {
                const t = (hoverX / width) * 2 * Math.PI;
                const originalValue = Math.sin(t);
                const analogY = height / 2 - originalValue * (height / 2 - 20);

                const normalized = (originalValue + 1) / 2;
                const quantizedNormalized = Math.round(normalized * (levels - 1)) / (levels - 1);
                const quantizedY = height - (quantizedNormalized * (height-40) + 20);
                
                ctx.save();
                ctx.fillStyle = 'yellow';
                ctx.beginPath();
                ctx.arc(hoverX, analogY, 5, 0, Math.PI * 2);
                ctx.fill();

                ctx.strokeStyle = 'yellow';
                ctx.lineWidth = 1.5;
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.moveTo(hoverX, analogY);
                ctx.lineTo(hoverX, quantizedY);
                ctx.stroke();
                
                ctx.beginPath();
                ctx.moveTo(0, quantizedY);
                ctx.lineTo(width, quantizedY);
                ctx.stroke();

                ctx.restore();
            }
        }

        function updateComparison() {
            const duration = parseInt(document.getElementById('durationSlider').value);
            const sampleRate = parseInt(document.getElementById('comparisonSampleRate').value);
            const bitDepth = parseInt(document.getElementById('comparisonBitDepth').value);
            const channels = parseInt(document.getElementById('comparisonChannels').value);
            document.getElementById('durationValue').textContent = duration;
            const bytesTotal = (sampleRate * bitDepth * channels * duration) / 8;
            const bitRate = (sampleRate * bitDepth * channels);
            document.getElementById('fileSize').textContent = formatFileSize(bytesTotal);
            document.getElementById('bitRate').textContent = `${(bitRate / 1000).toFixed(0)} kbps`;
            const maxSize = constants.MAX_STORAGE_MB * 1024 * 1024;
            const percentage = Math.min((bytesTotal / maxSize) * 100, 100);
            document.getElementById('sizeBar').style.width = `${percentage}%`;
            document.getElementById('storagePercent').textContent = `${percentage.toFixed(2)}%`;
        }
        
        async function toggleRecording() {
            if (appState.isRecording) {
                stopRecording();
            } else {
                await startRecording();
            }
        }
        
        async function startRecording() {
            try {
                initAudio();
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                appState.microphone = appState.audioContext.createMediaStreamSource(stream);
                
                // Connect analyser for live visualization
                appState.microphone.connect(appState.analyser);
                
                appState.recordedChunks = [];
                const options = { mimeType: 'audio/webm' };
                appState.mediaRecorder = new MediaRecorder(stream, options);

                appState.mediaRecorder.ondataavailable = e => {
                    if (e.data.size > 0) {
                        appState.recordedChunks.push(e.data);
                    }
                };

                appState.mediaRecorder.onstop = async () => {
                    // Stop the source stream tracks now that recording is complete
                    if (appState.microphone && appState.microphone.stream) {
                        appState.microphone.stream.getTracks().forEach(track => track.stop());
                    }
                    
                    // Disconnect nodes
                    if (appState.analyser) appState.analyser.disconnect();
                    if (appState.microphone) appState.microphone.disconnect();

                    // Process the recorded data
                    const blob = new Blob(appState.recordedChunks, { type: 'audio/webm' });
                    
                    if (blob.size === 0) {
                        console.warn("Recording resulted in an empty blob.");
                        alert("Recording failed, please try again. No audio data was captured.");
                        return;
                    }
                    
                    const arrayBuffer = await blob.arrayBuffer();

                    try {
                        appState.recordedBuffer = await appState.audioContext.decodeAudioData(arrayBuffer);
                        
                        document.getElementById('recordDuration').textContent = appState.recordedBuffer.duration.toFixed(1);
                        document.getElementById('recordSize').textContent = formatFileSize(blob.size);
                        document.getElementById('playButton').disabled = false;
                        drawRecordedWaveform();
                    } catch (e) {
                        console.error("Error decoding audio data:", e);
                        alert("Failed to process recorded audio. The format might not be supported or the data is corrupted.");
                    }
                };

                appState.mediaRecorder.start();
                appState.isRecording = true;

                const recordButton = document.getElementById('recordButton');
                recordButton.textContent = '⏹️ Stop Recording';
                recordButton.classList.add('recording');
                document.getElementById('playButton').disabled = true;
                document.getElementById('recordingInfo').style.display = 'block';
                document.getElementById('recordDuration').textContent = '0.0';
                document.getElementById('recordSize').textContent = '0 KB';
                visualizeLive();
            } catch (err) {
                console.error("Error accessing microphone:", err);
                alert("Could not access microphone. Please grant permission and try again.");
            }
        }

        function stopRecording() {
            if (!appState.isRecording || !appState.mediaRecorder || appState.mediaRecorder.state === 'inactive') return;
            
            appState.mediaRecorder.stop();
            appState.isRecording = false;
            cancelAnimationFrame(appState.animationFrameId);
            
            const recordButton = document.getElementById('recordButton');
            recordButton.textContent = '🎤 Start Recording';
            recordButton.classList.remove('recording');
        }
        
        function playRecording() {
            if (appState.recordedBuffer) {
                const source = appState.audioContext.createBufferSource();
                source.buffer = appState.recordedBuffer;
                source.connect(appState.audioContext.destination);
                source.start();
            }
        }

        function setupLiveVisualizer() {
            const viz = document.getElementById('liveVisualizer');
            viz.innerHTML = '';
            const BAR_COUNT = 50;
            for (let i = 0; i < BAR_COUNT; i++) {
                const bar = document.createElement('div');
                bar.className = 'visualizer-bar';
                viz.appendChild(bar);
            }
        }

        function visualizeLive() {
            if (!appState.isRecording) return;
            const bufferLength = appState.analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            appState.analyser.getByteTimeDomainData(dataArray);
            const bars = document.querySelectorAll('#liveVisualizer .visualizer-bar');
            bars.forEach((bar, i) => {
                const index = Math.floor((i / bars.length) * bufferLength);
                const value = dataArray[index] / 128.0 - 1.0;
                bar.style.height = `${Math.abs(value) * 100}%`;
                bar.style.backgroundColor = `hsl(${180 + Math.abs(value) * 80}, 100%, 50%)`;
            });
            appState.animationFrameId = requestAnimationFrame(visualizeLive);
        }
        
        function drawRecordedWaveform() {
            const canvas = document.getElementById('recordedWaveform');
            if (!appState.recordedBuffer) {
                 const ctx = canvas.getContext('2d');
                 ctx.clearRect(0, 0, canvas.width, canvas.height);
                 ctx.fillStyle = "rgba(255,255,255,0.7)";
                 ctx.textAlign = "center";
                 ctx.font = "16px sans-serif";
                 ctx.fillText("No recording data. Click record to begin.", canvas.width/2, canvas.height/2);
                 return;
            }
            drawWaveformOnCanvas(canvas, appState.recordedBuffer.getChannelData(0));
        }
        
        function drawBinaryWaveform() {
            const canvas = document.getElementById('binaryWaveform');
            const sampleCount = 50;
            const sampleData = new Float32Array(sampleCount).map((_, i) => {
                const t = (i / sampleCount) * 4 * Math.PI;
                return Math.sin(t) * 0.8 * Math.cos(t * 0.5);
            });
            drawWaveformOnCanvas(canvas, sampleData, { pointRadius: 4, highlightedIndex: appState.selectedBinarySampleIndex });
            canvas.dataset.sampleData = JSON.stringify(Array.from(sampleData));
        }

        function handleBinaryWaveformClick(e) {
            const canvas = e.target;
            const sampleData = JSON.parse(canvas.dataset.sampleData);
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const sampleIndex = Math.floor((x / rect.width) * sampleData.length);
            if (sampleIndex >= 0 && sampleIndex < sampleData.length) {
                appState.selectedBinarySampleIndex = sampleIndex;
                const value = sampleData[sampleIndex];
                const int16Value = Math.round(value * 32767);
                const binary = (int16Value < 0 ? int16Value + 65536 : int16Value).toString(2).padStart(16, '0');
                document.getElementById('sampleAmplitude').textContent = value.toFixed(4);
                document.getElementById('decimalValue').textContent = int16Value;
                document.getElementById('sampleBinary').innerHTML = binary
                    .match(/.{1,4}/g)
                    .map((part, i) => `<span style="color: ${['#ff00ff', '#00d9ff', '#00f5ff', '#ff00ff'][i]}">${part}</span>`)
                    .join(' ');
                drawBinaryWaveform();
            }
        }
        
        function drawWaveformOnCanvas(canvas, data, options = {}) {
            const { pointRadius = 0, highlightedIndex = -1 } = options;
            const ctx = canvas.getContext('2d');
            const { width, height } = canvas;
            ctx.clearRect(0, 0, width, height);
            ctx.strokeStyle = '#00d9ff';
            ctx.lineWidth = 1;
            ctx.beginPath();
            const sliceWidth = width * 1.0 / data.length;
            let x = 0;
            for(let i = 0; i < data.length; i++) {
                const v = data[i];
                const y = (height / 2) - (v * height / 2.2);
                i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
                x += sliceWidth;
            }
            ctx.stroke();
            if (pointRadius > 0) {
                x = 0;
                for(let i = 0; i < data.length; i++) {
                    const v = data[i];
                    const y = (height / 2) - (v * height / 2.2);
                    if (i === highlightedIndex) {
                        ctx.fillStyle = 'yellow';
                        ctx.beginPath();
                        ctx.arc(x, y, pointRadius + 3, 0, Math.PI * 2);
                        ctx.fill();
                    }
                    ctx.fillStyle = '#ff00ff';
                    ctx.beginPath();
                    ctx.arc(x, y, pointRadius, 0, Math.PI * 2);
                    ctx.fill();
                    x += sliceWidth;
                }
            }
        }

        function startQuiz() {
            const container = document.getElementById('quizContainer');
            container.innerHTML = quizQuestions.map((q, index) => `
                <div class="quiz-question" id="question${index}">
                    <h3>Question ${index + 1}</h3>
                    <p>${q.question}</p>
                    ${q.options.map((opt, i) => `
                        <div class="quiz-option" data-question="${index}" data-option="${i}">${opt}</div>
                    `).join('')}
                </div>
            `).join('');
            document.querySelectorAll('.quiz-option').forEach(opt => {
                opt.addEventListener('click', (e) => selectQuizAnswer(e.currentTarget));
            });
            document.getElementById('submitQuiz').style.display = 'inline-block';
            document.getElementById('quizResults').style.display = 'none';
            appState.quizAnswers = {};
        }
        
        function selectQuizAnswer(selectedOption) {
            const qIndex = selectedOption.dataset.question;
            const oIndex = selectedOption.dataset.option;
            appState.quizAnswers[qIndex] = parseInt(oIndex);
            document.querySelectorAll(`#question${qIndex} .quiz-option`).forEach(opt => {
                opt.classList.remove('selected');
            });
            selectedOption.classList.add('selected');
        }
        
        function showQuizResults() {
            let correctCount = 0;
            let feedbackHTML = '<h4>Detailed Results:</h4>';
            quizQuestions.forEach((q, index) => {
                const userAnswer = appState.quizAnswers[index];
                const isCorrect = userAnswer === q.correct;
                if (isCorrect) correctCount++;
                const options = document.querySelectorAll(`#question${index} .quiz-option`);
                options.forEach((opt, i) => {
                    opt.classList.remove('selected');
                    if (i === q.correct) opt.classList.add('correct');
                    if (i === userAnswer && !isCorrect) opt.classList.add('incorrect');
                });
                feedbackHTML += `<p><strong>Q${index + 1}: ${isCorrect ? '✅ Correct' : '❌ Incorrect'}</strong><br><small>${q.explanation}</small></p>`;
            });
            const score = Math.round((correctCount / quizQuestions.length) * 100);
            document.getElementById('quizScore').textContent = score;
            document.getElementById('quizFeedback').innerHTML = feedbackHTML;
            document.getElementById('quizResults').style.display = 'block';
            document.getElementById('quizResults').scrollIntoView({ behavior: 'smooth' });
        }
        
        function updateSampleRate() {
            const slider = document.getElementById('sampleRateSlider');
            const sampleRate = parseInt(slider.value);
            document.getElementById('sampleRateValue').textContent = sampleRate.toLocaleString();
            document.getElementById('samplesPerSecond').textContent = sampleRate.toLocaleString();
            document.getElementById('maxFrequency').textContent = `${(sampleRate / 2000).toFixed(2)} kHz`;
            let quality = 'Low';
            if (sampleRate >= 48000) quality = 'Studio';
            else if (sampleRate >= 44100) quality = 'CD';
            else if (sampleRate >= 22050) quality = 'Radio';
            else if (sampleRate >= 8000) quality = 'Phone';
            document.getElementById('quality').textContent = `${quality} Quality`;
            drawSamplingDemo(sampleRate);
        }
        
        function drawSamplingDemo(sampleRate) {
            const canvas = document.getElementById('samplingCanvas');
            const ctx = canvas.getContext('2d');
            const { width, height } = canvas;
            ctx.clearRect(0, 0, width, height);
            const frequency = 440;
            const duration = 0.01;
            
            ctx.strokeStyle = 'rgba(0, 217, 255, 0.3)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            for (let x = 0; x < width; x++) {
                const t = (x / width) * duration;
                const y = height / 2 - Math.sin(2 * Math.PI * frequency * t) * height / 3;
                x === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
            }
            ctx.stroke();

            const samplesInWindow = Math.floor(sampleRate * duration);
            ctx.fillStyle = '#ff00ff';
            ctx.strokeStyle = '#00d9ff';
            ctx.lineWidth = 2;
            ctx.beginPath();
            for (let i = 0; i < samplesInWindow; i++) {
                const t = i / sampleRate;
                const x = (t / duration) * width;
                const y = height / 2 - Math.sin(2 * Math.PI * frequency * t) * height / 3;
                ctx.beginPath();
                ctx.arc(x, y, 3, 0, Math.PI * 2);
                ctx.fill();
            }
        }


        // ---------------------------------------------------------------------------------
        // INITIALIZATION & ENTRY POINT
        // ---------------------------------------------------------------------------------
        
        function initialize() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => showSection(tab.dataset.section));
            });
            document.querySelectorAll('[data-wave]').forEach(button => {
                button.addEventListener('click', () => {
                    appState.currentWaveType = button.dataset.wave;
                    drawWaveforms();
                });
            });
            document.getElementById('sampleRateSlider').addEventListener('input', updateSampleRate);
            
            const bitDepthCanvas = document.getElementById('bitDepthCanvas');
            document.getElementById('bitDepthSlider').addEventListener('input', updateBitDepth);
            bitDepthCanvas.addEventListener('mousemove', e => {
                const rect = bitDepthCanvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const bitDepth = parseInt(document.getElementById('bitDepthSlider').value);
                drawBitDepthDemo(bitDepth, { hoverX: x });
            });
            bitDepthCanvas.addEventListener('mouseleave', () => updateBitDepth());

            document.getElementById('durationSlider').addEventListener('input', updateComparison);
            document.getElementById('comparisonSampleRate').addEventListener('change', updateComparison);
            document.getElementById('comparisonBitDepth').addEventListener('change', updateComparison);
            document.getElementById('comparisonChannels').addEventListener('change', updateComparison);
            document.getElementById('recordButton').addEventListener('click', toggleRecording);
            document.getElementById('playButton').addEventListener('click', playRecording);
            document.getElementById('binaryWaveform').addEventListener('click', handleBinaryWaveformClick);
            document.getElementById('startQuiz').addEventListener('click', startQuiz);
            document.getElementById('submitQuiz').addEventListener('click', showQuizResults);

            drawWaveforms();
            updateSampleRate();
            updateBitDepth();
            updateComparison();
            drawBinaryWaveform();
            setupLiveVisualizer();
        }

        document.addEventListener('DOMContentLoaded', initialize);

    </script>
</body>
</html>
