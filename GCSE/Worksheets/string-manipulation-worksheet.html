<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>String Manipulation - GCSE Computer Science</title>
    <!-- Load Ace Editor with fallbacks -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.3/ace.min.js" crossorigin="anonymous"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .navigation {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            background-color: #34495e;
            padding: 10px;
            border-radius: 5px;
        }

        .nav-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        .nav-btn:hover {
            background-color: #2980b9;
        }

        .nav-btn.active {
            background-color: #e74c3c;
        }

        .section {
            display: none;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .section.active {
            display: block;
        }

        .xp-achievement {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #2c3e50;
            color: white;
            padding: 15px;
            border-radius: 10px;
            z-index: 1000;
        }

        .achievement-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #f39c12;
            color: white;
            padding: 20px;
            border-radius: 10px;
            display: none;
            z-index: 2000;
            animation: popup 0.5s ease-out;
        }

        @keyframes popup {
            0% { transform: translate(-50%, -50%) scale(0); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        .task-box {
            background-color: #ecf0f1;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
            border-left: 5px solid #3498db;
        }

        .code-editor {
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
            white-space: pre-wrap;
        }

        .input-field {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 2px solid #bdc3c7;
            border-radius: 5px;
            font-size: 16px;
        }

        .submit-btn {
            background-color: #27ae60;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }

        .submit-btn:hover {
            background-color: #229954;
        }

        .reset-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }

        .reset-btn:hover {
            background-color: #c0392b;
        }

        .drag-container {
            display: flex;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .drag-item {
            background-color: #3498db;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: move;
            transition: transform 0.2s;
        }

        .drag-item:hover {
            transform: scale(1.05);
        }

        .drop-zone {
            min-height: 50px;
            border: 2px dashed #95a5a6;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            background-color: #ecf0f1;
        }

        .drop-zone.drag-over {
            background-color: #3498db;
            border-color: #2980b9;
        }

        .drop-zone .drag-item {
            display: inline-block;
            margin: 2px;
            background-color: #e74c3c;
        }

        .feedback {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .feedback.correct {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .feedback.incorrect {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .hint-btn {
            background-color: #f39c12;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
        }

        .string-visualization {
            display: flex;
            gap: 5px;
            margin: 20px 0;
            justify-content: center;
        }

        .char-box {
            width: 40px;
            height: 40px;
            border: 2px solid #34495e;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            position: relative;
        }

        .index-label {
            position: absolute;
            top: -20px;
            font-size: 12px;
            color: #e74c3c;
        }

        .nav-arrows {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
        }

        .arrow-btn {
            background-color: #95a5a6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        .arrow-btn:hover {
            background-color: #7f8c8d;
        }

        .arrow-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .quiz-option {
            display: block;
            width: 100%;
            text-align: left;
            padding: 10px;
            margin: 5px 0;
            background-color: #ecf0f1;
            border: 2px solid #bdc3c7;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .quiz-option:hover {
            background-color: #d5dbdb;
        }

        .quiz-option.selected {
            background-color: #3498db;
            color: white;
            border-color: #2980b9;
        }

        .drawing-canvas {
            border: 2px solid #34495e;
            border-radius: 5px;
            margin: 10px 0;
            cursor: crosshair;
            touch-action: none;
        }

        .paste-shame {
            display: none;
            background-color: #e74c3c;
            color: white;
            padding: 20px;
            border-radius: 5px;
            text-align: center;
            font-size: 20px;
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .feedback-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #95a5a6;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            width: 50px;
            height: 50px;
            font-size: 20px;
            z-index: 1000;
        }

        .feedback-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 2000;
            max-width: 500px;
            width: 90%;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 1999;
        }

        .accessibility-controls {
            position: fixed;
            top: 20px;
            left: 20px;
            background-color: #2c3e50;
            padding: 10px;
            border-radius: 5px;
            z-index: 1000;
        }

        .font-size-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 5px 10px;
            margin: 2px;
            border-radius: 3px;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .xp-achievement {
                position: static;
                margin-bottom: 10px;
            }
            
            .accessibility-controls {
                position: static;
                margin-bottom: 10px;
            }
        }

        .high-contrast {
            background-color: #000;
            color: #fff;
        }

        .high-contrast .section {
            background-color: #111;
            color: #fff;
        }

        .high-contrast .task-box {
            background-color: #222;
            border-left-color: #ff0;
        }

        .high-contrast .code-editor {
            background-color: #000;
            border: 2px solid #fff;
        }

        /* Python Editor Styles */
        .python-editor-container {
            margin: 20px 0;
            border: 1px solid #343a40;
            border-radius: 8px;
            overflow: hidden;
            background-color: #272822;
        }

        .editor-header {
            background-color: #1e1e1e;
            color: #f8f8f2;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #343a40;
        }

        .editor-header span {
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        .run-button {
            background-color: #27ae60;
            color: white;
            border: none;
            padding: 6px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .run-button:hover {
            background-color: #229954;
        }

        .run-button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }

        .python-editor {
            height: 300px;
            font-size: 14px;
        }

        .output-panel {
            margin-top: 20px;
            border: 1px solid #343a40;
            border-radius: 8px;
            overflow: hidden;
        }

        .output-header {
            background-color: #2c3e50;
            color: white;
            padding: 10px 15px;
            font-size: 14px;
            font-weight: bold;
        }

        .output-content {
            padding: 1rem;
            font-family: 'Courier New', monospace;
            min-height: 100px;
            background: #212529;
            color: #f8f9fa;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-x: auto;
        }

        .output-content.error {
            color: #ff8a8a;
        }

        .input-panel {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            display: none;
        }

        .input-panel.active {
            display: block;
        }

        .input-prompt {
            font-family: 'Courier New', monospace;
            margin-bottom: 0.5rem;
            color: #6c757d;
        }

        .input-panel .input-field {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }

        .input-submit {
            margin-top: 0.5rem;
            padding: 0.5rem 1rem;
            background-color: #0d6efd;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .test-cases-container {
            margin-top: 20px;
            padding: 15px;
            background-color: #ecf0f1;
            border-radius: 5px;
        }

        .test-case {
            margin: 10px 0;
            padding: 10px;
            background-color: white;
            border-radius: 4px;
            border-left: 4px solid #3498db;
        }

        .test-case.passed {
            border-left-color: #27ae60;
            background-color: #d4edda;
        }

        .test-case.failed {
            border-left-color: #e74c3c;
            background-color: #f8d7da;
        }

        .loading-message {
            text-align: center;
            padding: 20px;
            color: #6c757d;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="accessibility-controls">
        <button class="font-size-btn" onclick="changeFontSize(-2)">A-</button>
        <button class="font-size-btn" onclick="changeFontSize(2)">A+</button>
        <button class="font-size-btn" onclick="toggleHighContrast()">🌓</button>
    </div>

    <div class="xp-achievement">
        <div>Level: <span id="level">0</span>/5</div>
        <div>XP: <span id="xp">0</span></div>
        <div>Achievements: <span id="achievements">0</span></div>
    </div>

    <div class="achievement-popup" id="achievementPopup"></div>

    <div class="container">
        <div class="header">
            <h1>String Manipulation</h1>
            <p>GCSE Computer Science - OCR J277</p>
        </div>

        <nav class="navigation" role="navigation" aria-label="Main navigation">
            <button class="nav-btn active" onclick="showSection(0)" aria-label="Starter Activity">Starter</button>
            <button class="nav-btn" onclick="showSection(1)" aria-label="Learning Outcomes">Outcomes</button>
            <button class="nav-btn" onclick="showSection(2)" aria-label="Introduction">Introduction</button>
            <button class="nav-btn" onclick="showSection(3)" aria-label="String Indexing">Indexing</button>
            <button class="nav-btn" onclick="showSection(4)" aria-label="Substrings">Substrings</button>
            <button class="nav-btn" onclick="showSection(5)" aria-label="Practice Tasks">Tasks</button>
            <button class="nav-btn" onclick="showSection(6)" aria-label="Common Mistakes">Mistakes</button>
            <button class="nav-btn" onclick="showSection(7)" aria-label="Real World">Real World</button>
            <button class="nav-btn" onclick="showSection(8)" aria-label="Exam Questions">Exam Q's</button>
            <button class="nav-btn" onclick="showSection(9)" aria-label="Extension">Extension</button>
            <button class="nav-btn" onclick="showSection(10)" aria-label="Summary Quiz">Summary</button>
            <button class="nav-btn" onclick="showSection(11)" aria-label="Videos">Videos</button>
        </nav>

        <!-- Section 0: Starter Activity -->
        <section class="section active" id="section0">
            <h2>Starter Activity: String Basics Review</h2>
            <p>Let's warm up with a quick quiz about strings!</p>
            
            <div class="task-box">
                <h3>Question 1: What is a string in programming?</h3>
                <button class="quiz-option" onclick="checkQuizAnswer(this, false, 'q1')">A type of number</button>
                <button class="quiz-option" onclick="checkQuizAnswer(this, true, 'q1')">A sequence of characters</button>
                <button class="quiz-option" onclick="checkQuizAnswer(this, false, 'q1')">A mathematical operation</button>
                <button class="quiz-option" onclick="checkQuizAnswer(this, false, 'q1')">A loop structure</button>
                <div id="feedback-q1"></div>
            </div>

            <div class="task-box">
                <h3>Question 2: How do we create a string in Python?</h3>
                <button class="quiz-option" onclick="checkQuizAnswer(this, false, 'q2')">Using square brackets []</button>
                <button class="quiz-option" onclick="checkQuizAnswer(this, false, 'q2')">Using curly braces {}</button>
                <button class="quiz-option" onclick="checkQuizAnswer(this, false, 'q2')">Using parentheses ()</button>
                <button class="quiz-option" onclick="checkQuizAnswer(this, true, 'q2')">Using quotes "" or ''</button>
                <div id="feedback-q2"></div>
            </div>

            <div class="task-box">
                <h3>Interactive: Build a String</h3>
                <p>Click the characters in the correct order to build "HELLO":</p>
                <div class="drag-container" id="charContainer">
                    <button class="quiz-option" onclick="addCharToBuilder('H')">H</button>
                    <button class="quiz-option" onclick="addCharToBuilder('E')">E</button>
                    <button class="quiz-option" onclick="addCharToBuilder('L')">L</button>
                    <button class="quiz-option" onclick="addCharToBuilder('L')">L</button>
                    <button class="quiz-option" onclick="addCharToBuilder('O')">O</button>
                </div>
                <div style="margin: 20px 0;">
                    <p><strong>Your string:</strong></p>
                    <div style="background-color: white; border: 2px solid #3498db; padding: 15px; font-size: 24px; font-family: monospace; min-height: 40px;" id="stringBuilder"></div>
                </div>
                <button class="submit-btn" onclick="checkStringBuilder()">Check</button>
                <button class="reset-btn" onclick="resetStringBuilder()">Reset</button>
                <div id="builderFeedback"></div>
            </div>

            <div class="nav-arrows">
                <button class="arrow-btn" disabled>← Previous</button>
                <button class="arrow-btn" onclick="showSection(1)">Next →</button>
            </div>
        </section>

        <!-- Section 1: Learning Outcomes -->
        <section class="section" id="section1">
            <h2>Learning Outcomes</h2>
            <p>By the end of this lesson, you will be able to:</p>
            
            <div class="task-box">
                <ul>
                    <li>✓ Understand how strings are indexed starting from 0</li>
                    <li>✓ Use positive and negative indexing to access characters</li>
                    <li>✓ Extract substrings using slicing notation [start:end]</li>
                    <li>✓ Apply string operations to solve programming problems</li>
                    <li>✓ Convert between OCR Reference Language and Python syntax</li>
                    <li>✓ Identify and avoid common string manipulation errors</li>
                </ul>
            </div>

            <div class="task-box">
                <h3>Key Terms</h3>
                <p><strong>Index:</strong> The position of a character in a string (starting from 0)</p>
                <p><strong>Substring:</strong> A portion of a string extracted from the original</p>
                <p><strong>Slicing:</strong> The process of extracting a substring using indices</p>
                <p><strong>Concatenation:</strong> Joining two or more strings together</p>
            </div>

            <div class="nav-arrows">
                <button class="arrow-btn" onclick="showSection(0)">← Previous</button>
                <button class="arrow-btn" onclick="showSection(2)">Next →</button>
            </div>
        </section>

        <!-- Section 2: Introduction to String Manipulation -->
        <section class="section" id="section2">
            <h2>Introduction to String Manipulation</h2>
            
            <div class="task-box">
                <h3>Understanding Strings</h3>
                <p>Strings are sequences of characters. Each character has a position called an index.</p>
                
                <div class="string-visualization" id="stringViz">
                    <div class="char-box">
                        <span class="index-label">0</span>
                        H
                    </div>
                    <div class="char-box">
                        <span class="index-label">1</span>
                        e
                    </div>
                    <div class="char-box">
                        <span class="index-label">2</span>
                        l
                    </div>
                    <div class="char-box">
                        <span class="index-label">3</span>
                        l
                    </div>
                    <div class="char-box">
                        <span class="index-label">4</span>
                        o
                    </div>
                </div>
                
                <p>Click on any character to see its index:</p>
                <div id="indexDisplay"></div>
            </div>

            <div class="task-box">
                <h3>Try It Yourself</h3>
                <label for="userString">Enter a string:</label>
                <input type="text" id="userString" class="input-field" placeholder="Type any word..." maxlength="10">
                <button class="submit-btn" onclick="visualizeUserString()">Visualize</button>
                <div id="userStringViz"></div>
            </div>

            <div class="nav-arrows">
                <button class="arrow-btn" onclick="showSection(1)">← Previous</button>
                <button class="arrow-btn" onclick="showSection(3)">Next →</button>
            </div>
        </section>

        <!-- Section 3: String Indexing -->
        <section class="section" id="section3">
            <h2>String Indexing</h2>
            
            <div class="task-box">
                <h3>Positive and Negative Indexing</h3>
                <p>Python allows both positive (from start) and negative (from end) indexing:</p>
                
                <div class="code-editor">
text = "PYTHON"
# Positive:  0  1  2  3  4  5
# Letters:   P  Y  T  H  O  N
# Negative: -6 -5 -4 -3 -2 -1
                </div>
                
                <h4>Interactive Exercise</h4>
                <p>Given the string "COMPUTER", what character is at index 3?</p>
                <input type="text" id="indexAnswer1" class="input-field" placeholder="Enter single character">
                <button class="submit-btn" onclick="checkIndexing('indexAnswer1', 'P', 'indexFeedback1')">Check</button>
                <button class="hint-btn" onclick="showHint('indexHint1')">Hint (-5 XP)</button>
                <div id="indexHint1" style="display:none;" class="feedback">Remember: indexing starts at 0!</div>
                <div id="indexFeedback1"></div>
            </div>

            <div class="task-box">
                <h3>Negative Indexing Practice</h3>
                <p>What is the index -2 in the string "SCIENCE"?</p>
                <input type="text" id="indexAnswer2" class="input-field" placeholder="Enter single character">
                <button class="submit-btn" onclick="checkIndexing('indexAnswer2', 'C', 'indexFeedback2')">Check</button>
                <div id="indexFeedback2"></div>
            </div>

            <div class="nav-arrows">
                <button class="arrow-btn" onclick="showSection(2)">← Previous</button>
                <button class="arrow-btn" onclick="showSection(4)">Next →</button>
            </div>
        </section>

        <!-- Section 4: Substrings and Slicing -->
        <section class="section" id="section4">
            <h2>Substrings and Slicing</h2>
            
            <div class="task-box">
                <h3>String Slicing Syntax</h3>
                <div class="code-editor">
string[start:end]     # From start to end-1
string[start:]        # From start to the end
string[:end]          # From beginning to end-1
string[start:end:step] # With step size
                </div>
                
                <h4>Interactive Slicing Simulator</h4>
                <p>Try different slice operations on "PROGRAMMING":</p>
                <input type="text" id="sliceInput" class="input-field" value="PROGRAMMING" readonly>
                <div>
                    <label>Start: <input type="number" id="sliceStart" min="-11" max="10" value="0"></label>
                    <label>End: <input type="number" id="sliceEnd" min="-11" max="11" value="4"></label>
                    <button class="submit-btn" onclick="simulateSlice()">Slice</button>
                </div>
                <div class="code-editor" id="sliceResult">Result will appear here...</div>
            </div>

            <div class="task-box">
                <h3>Fill in the Blanks</h3>
                <p>Complete the code to extract "GOOD" from "GOODMORNING":</p>
                <p>text = "GOODMORNING"</p>
                <p>result = text[
                    <select id="blank1">
                        <option value="">Choose...</option>
                        <option value="1">1</option>
                        <option value="0">0</option>
                        <option value="2">2</option>
                        <option value="-1">-1</option>
                    </select>
                    :
                    <select id="blank2">
                        <option value="">Choose...</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                    </select>
                    ]
                </p>
                <button class="submit-btn" onclick="checkSliceFill()">Check</button>
                <div id="sliceFillFeedback"></div>
            </div>

            <div class="nav-arrows">
                <button class="arrow-btn" onclick="showSection(3)">← Previous</button>
                <button class="arrow-btn" onclick="showSection(5)">Next →</button>
            </div>
        </section>

        <!-- Section 5: Practice Tasks -->
        <section class="section" id="section5">
            <h2>String Operations Practice Tasks</h2>
            
            <div class="task-box" style="background-color: #fff3cd; border-left-color: #f39c12;">
                <h3>⚠️ Important: OCR Reference Language vs Python</h3>
                <p>The OCR exam uses a different syntax from Python. Study this comparison carefully:</p>
                
                <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                    <tr style="background-color: #3498db; color: white;">
                        <th style="padding: 10px; border: 1px solid #2980b9;">Operation</th>
                        <th style="padding: 10px; border: 1px solid #2980b9;">OCR Reference Language</th>
                        <th style="padding: 10px; border: 1px solid #2980b9;">Python</th>
                    </tr>
                    <tr>
                        <td style="padding: 10px; border: 1px solid #ddd;">String length</td>
                        <td style="padding: 10px; border: 1px solid #ddd; font-family: monospace;">subject.length</td>
                        <td style="padding: 10px; border: 1px solid #ddd; font-family: monospace;">len(subject)</td>
                    </tr>
                    <tr style="background-color: #ecf0f1;">
                        <td style="padding: 10px; border: 1px solid #ddd;">Substring (from x, i chars)</td>
                        <td style="padding: 10px; border: 1px solid #ddd; font-family: monospace;">subject.substring(3,5)</td>
                        <td style="padding: 10px; border: 1px solid #ddd; font-family: monospace;">subject[3:8]</td>
                    </tr>
                    <tr>
                        <td style="padding: 10px; border: 1px solid #ddd;">First i characters</td>
                        <td style="padding: 10px; border: 1px solid #ddd; font-family: monospace;">subject.left(4)</td>
                        <td style="padding: 10px; border: 1px solid #ddd; font-family: monospace;">subject[:4]</td>
                    </tr>
                    <tr style="background-color: #ecf0f1;">
                        <td style="padding: 10px; border: 1px solid #ddd;">Last i characters</td>
                        <td style="padding: 10px; border: 1px solid #ddd; font-family: monospace;">subject.right(3)</td>
                        <td style="padding: 10px; border: 1px solid #ddd; font-family: monospace;">subject[-3:]</td>
                    </tr>
                    <tr>
                        <td style="padding: 10px; border: 1px solid #ddd;">Uppercase</td>
                        <td style="padding: 10px; border: 1px solid #ddd; font-family: monospace;">subject.upper</td>
                        <td style="padding: 10px; border: 1px solid #ddd; font-family: monospace;">subject.upper()</td>
                    </tr>
                    <tr style="background-color: #ecf0f1;">
                        <td style="padding: 10px; border: 1px solid #ddd;">Lowercase</td>
                        <td style="padding: 10px; border: 1px solid #ddd; font-family: monospace;">subject.lower</td>
                        <td style="padding: 10px; border: 1px solid #ddd; font-family: monospace;">subject.lower()</td>
                    </tr>
                    <tr>
                        <td style="padding: 10px; border: 1px solid #ddd;">ASCII value</td>
                        <td style="padding: 10px; border: 1px solid #ddd; font-family: monospace;">ASC('A')</td>
                        <td style="padding: 10px; border: 1px solid #ddd; font-family: monospace;">ord('A')</td>
                    </tr>
                    <tr style="background-color: #ecf0f1;">
                        <td style="padding: 10px; border: 1px solid #ddd;">Character from ASCII</td>
                        <td style="padding: 10px; border: 1px solid #ddd; font-family: monospace;">CHR(97)</td>
                        <td style="padding: 10px; border: 1px solid #ddd; font-family: monospace;">chr(97)</td>
                    </tr>
                </table>
            </div>

            <div class="task-box">
                <h3>Practice Set 1: String Length</h3>
                
                <h4>Question 1.1 (OCR Reference Language)</h4>
                <p>What is the output of this code?</p>
                <div class="code-editor">
subject = "ComputerScience"
OUTPUT subject.length</div>
                <input type="text" id="length-ocr-1" class="input-field" placeholder="Enter the output">
                <button class="submit-btn" onclick="checkAnswer('length-ocr-1', '15', 'length-ocr-1-feedback')">Check</button>
                <div id="length-ocr-1-feedback"></div>
                
                <h4>Question 1.2 (Python)</h4>
                <p>Write the Python equivalent to get the length of "HelloWorld":</p>
                <input type="text" id="length-py-1" class="input-field" placeholder="Enter Python code">
                <button class="submit-btn" onclick="checkAnswer('length-py-1', 'len(&quot;HelloWorld&quot;)', 'length-py-1-feedback', true)">Check</button>
                <div id="length-py-1-feedback"></div>
            </div>

            <div class="task-box">
                <h3>Practice Set 2: Substrings with .substring()</h3>
                
                <h4>Question 2.1 (OCR Reference Language)</h4>
                <p>Given: <code>subject = "Programming"</code></p>
                <p>What does <code>subject.substring(3, 4)</code> return?</p>
                <p style="color: #e74c3c;"><em>Remember: substring(start, numberOfCharacters)</em></p>
                <input type="text" id="substring-ocr-1" class="input-field" placeholder="Enter the result">
                <button class="submit-btn" onclick="checkAnswer('substring-ocr-1', 'gram', 'substring-ocr-1-feedback')">Check</button>
                <div id="substring-ocr-1-feedback"></div>
                
                <h4>Question 2.2 (Python Equivalent)</h4>
                <p>Write Python code to get the same result as <code>subject.substring(3, 4)</code>:</p>
                <input type="text" id="substring-py-1" class="input-field" placeholder="Enter Python code">
                <button class="submit-btn" onclick="checkAnswer('substring-py-1', 'subject[3:7]', 'substring-py-1-feedback', true)">Check</button>
                <div id="substring-py-1-feedback"></div>
            </div>

            <div class="task-box">
                <h3>Practice Set 3: .left() and .right() Functions</h3>
                
                <h4>Question 3.1 (OCR Reference Language)</h4>
                <p>Given: <code>word = "EXAMINATION"</code></p>
                <p>What does <code>word.left(5)</code> return?</p>
                <input type="text" id="left-ocr-1" class="input-field" placeholder="Enter the result">
                <button class="submit-btn" onclick="checkAnswer('left-ocr-1', 'EXAMI', 'left-ocr-1-feedback')">Check</button>
                <div id="left-ocr-1-feedback"></div>
                
                <h4>Question 3.2 (OCR Reference Language)</h4>
                <p>What does <code>word.right(4)</code> return?</p>
                <input type="text" id="right-ocr-1" class="input-field" placeholder="Enter the result">
                <button class="submit-btn" onclick="checkAnswer('right-ocr-1', 'TION', 'right-ocr-1-feedback')">Check</button>
                <div id="right-ocr-1-feedback"></div>
                
                <h4>Question 3.3 (Python Equivalents)</h4>
                <p>Write Python code for <code>word.left(5)</code>:</p>
                <input type="text" id="left-py-1" class="input-field" placeholder="Enter Python code">
                <button class="submit-btn" onclick="checkAnswer('left-py-1', 'word[:5]', 'left-py-1-feedback', true)">Check</button>
                <div id="left-py-1-feedback"></div>
                
                <p>Write Python code for <code>word.right(4)</code>:</p>
                <input type="text" id="right-py-1" class="input-field" placeholder="Enter Python code">
                <button class="submit-btn" onclick="checkAnswer('right-py-1', 'word[-4:]', 'right-py-1-feedback', true)">Check</button>
                <div id="right-py-1-feedback"></div>
            </div>

            <div class="task-box">
                <h3>Practice Set 4: Case Conversion</h3>
                
                <h4>Question 4.1 (OCR Reference Language)</h4>
                <p>Given: <code>text = "Hello World"</code></p>
                <p>What is the output?</p>
                <div class="code-editor">
OUTPUT text.upper
OUTPUT text.lower</div>
                <input type="text" id="case-ocr-1" class="input-field" placeholder="First output">
                <input type="text" id="case-ocr-2" class="input-field" placeholder="Second output">
                <button class="submit-btn" onclick="checkCaseAnswers()">Check</button>
                <div id="case-feedback"></div>
            </div>

            <div class="task-box">
                <h3>Practice Set 5: ASCII Conversion</h3>
                
                <h4>Question 5.1 (OCR Reference Language)</h4>
                <p>What does <code>ASC('Z')</code> return?</p>
                <input type="text" id="asc-ocr-1" class="input-field" placeholder="Enter the ASCII value">
                <button class="submit-btn" onclick="checkAnswer('asc-ocr-1', '90', 'asc-ocr-1-feedback')">Check</button>
                <div id="asc-ocr-1-feedback"></div>
                
                <h4>Question 5.2 (OCR Reference Language)</h4>
                <p>What does <code>CHR(65)</code> return?</p>
                <input type="text" id="chr-ocr-1" class="input-field" placeholder="Enter the character">
                <button class="submit-btn" onclick="checkAnswer('chr-ocr-1', 'A', 'chr-ocr-1-feedback')">Check</button>
                <div id="chr-ocr-1-feedback"></div>
                
                <h4>Question 5.3 (Python Equivalents)</h4>
                <p>Write the Python equivalent of <code>ASC('Z')</code>:</p>
                <input type="text" id="asc-py-1" class="input-field" placeholder="Enter Python code">
                <button class="submit-btn" onclick="checkAnswer('asc-py-1', 'ord(&apos;Z&apos;)', 'asc-py-1-feedback', true)">Check</button>
                <div id="asc-py-1-feedback"></div>
            </div>

            <div class="task-box">
                <h3>Task 1: Extract Username (Mixed Syntax Practice)</h3>
                <p>A system stores emails in the format "username@domain.com"</p>
                
                <h4>Part A: OCR Reference Language</h4>
                <p>Complete the code to extract the username:</p>
                <div class="code-editor">
email = "student@school.edu"
atPosition = _______________  // Find position of '@'
username = email.____________  // Extract everything before '@'
OUTPUT username</div>
                <textarea class="input-field" id="task1-ocr" rows="4" placeholder="Write the complete OCR Reference code"></textarea>
                <button class="submit-btn" onclick="checkTask1OCR()">Check OCR Solution</button>
                <div id="task1-ocr-feedback"></div>
                
                <h4>Part B: Python Implementation</h4>
                <div id="task1-editor-container" class="python-editor-container">
                    <div class="editor-header">
                        <span>task1.py</span>
                        <button class="run-button" onclick="runPythonCode('task1-editor')">▶ Run</button>
                    </div>
                    <div id="task1-editor" class="python-editor"></div>
                    <div class="loading-message">Preparing Python editor...</div>
                </div>
                
                <div class="output-panel">
                    <div class="output-header">Console Output</div>
                    <div id="task1-editor-output" class="output-content"></div>
                </div>
                
                <button class="reset-btn" onclick="resetPythonEditor('task1-editor')">Reset Code</button>
            </div>

            <div class="task-box">
                <h3>Task 2: Password Validator (Mixed Syntax Practice)</h3>
                <p>Check if a password meets these requirements:</p>
                <ul>
                    <li>At least 8 characters long</li>
                    <li>First character must be uppercase</li>
                    <li>Last 3 characters must be digits</li>
                </ul>
                
                <h4>Part A: OCR Reference Language</h4>
                <p>Fill in the blanks:</p>
                <div class="code-editor">
password = USERINPUT
IF password.______ >= 8 THEN
    firstChar = password._______(1)
    IF ASC(firstChar) >= ____ AND ASC(firstChar) <= ____ THEN
        lastThree = password._______(3)
        OUTPUT "Valid start, checking end..."
    ENDIF
ENDIF</div>
                <textarea class="input-field" id="task2-ocr" rows="6" placeholder="Write the complete OCR Reference code"></textarea>
                <button class="submit-btn" onclick="checkTask2OCR()">Check OCR Solution</button>
                <div id="task2-ocr-feedback"></div>
                
                <h4>Part B: Python Implementation</h4>
                <div id="task2-editor-container" class="python-editor-container">
                    <div class="editor-header">
                        <span>task2.py</span>
                        <button class="run-button" onclick="runPythonCode('task2-editor')">▶ Run</button>
                    </div>
                    <div id="task2-editor" class="python-editor"></div>
                    <div class="loading-message">Preparing Python editor...</div>
                </div>
                
                <div class="output-panel">
                    <div class="output-header">Console Output</div>
                    <div id="task2-editor-output" class="output-content"></div>
                </div>
            </div>

            <div class="task-box">
                <h3>Task 3: Name Formatter (Advanced Practice)</h3>
                <p>Format a full name from "firstname lastname" to "Lastname, F."</p>
                <p>Example: "john smith" → "Smith, J."</p>
                
                <h4>Drawing Canvas for Planning:</h4>
                <canvas id="drawingCanvas" class="drawing-canvas" width="600" height="200"></canvas>
                <button class="reset-btn" onclick="clearCanvas()">Clear Canvas</button>
                
                <h4>Part A: OCR Reference Language Solution</h4>
                <textarea class="input-field" id="task3-ocr" rows="8" placeholder="Write your complete OCR Reference solution"></textarea>
                <button class="submit-btn" onclick="checkTask3OCR()">Check OCR Solution</button>
                <div id="task3-ocr-feedback"></div>
                
                <h4>Part B: Python Implementation</h4>
                <div id="task3-editor-container" class="python-editor-container">
                    <div class="editor-header">
                        <span>task3.py</span>
                        <button class="run-button" onclick="runPythonCode('task3-editor')">▶ Run</button>
                    </div>
                    <div id="task3-editor" class="python-editor"></div>
                    <div class="loading-message">Preparing Python editor...</div>
                </div>
                
                <div class="output-panel">
                    <div class="output-header">Console Output</div>
                    <div id="task3-editor-output" class="output-content"></div>
                </div>
                
                <div class="test-cases-container">
                    <h4>Test Your Solution:</h4>
                    <button class="submit-btn" onclick="runTask3Tests()">Run Test Cases</button>
                    <div id="task3-tests"></div>
                </div>
            </div>

            <div class="nav-arrows">
                <button class="arrow-btn" onclick="showSection(4)">← Previous</button>
                <button class="arrow-btn" onclick="showSection(6)">Next →</button>
            </div>
        </section>

        <!-- Section 6: Common Mistakes -->
        <section class="section" id="section6">
            <h2>Common Mistakes to Avoid</h2>
            
            <div class="task-box">
                <h3>Mistake 1: Off-by-One Errors</h3>
                <p>Remember: string slicing excludes the end index!</p>
                
                <div class="code-editor">
text = "HELLO"
# WRONG: text[0:5] gives "HELLO" (index 5 doesn't exist!)
# RIGHT: text[0:4] gives "HELL"
# RIGHT: text[0:] gives "HELLO" (to the end)
                </div>
                
                <h4>Quick Check:</h4>
                <p>To get "PYT" from "PYTHON", which slice is correct?</p>
                <button class="quiz-option" onclick="checkMistake(this, false, 'm1')">text[0:2]</button>
                <button class="quiz-option" onclick="checkMistake(this, true, 'm1')">text[0:3]</button>
                <button class="quiz-option" onclick="checkMistake(this, false, 'm1')">text[1:3]</button>
                <button class="quiz-option" onclick="checkMistake(this, false, 'm1')">text[0:4]</button>
                <div id="feedback-m1"></div>
            </div>

            <div class="task-box">
                <h3>Mistake 2: String Immutability</h3>
                <p>Strings cannot be changed directly!</p>
                
                <div class="code-editor">
text = "HELLO"
# WRONG: text[0] = "J"  # This will cause an error!
# RIGHT: text = "J" + text[1:]  # Creates new string "JELLO"
                </div>
            </div>

            <div class="nav-arrows">
                <button class="arrow-btn" onclick="showSection(5)">← Previous</button>
                <button class="arrow-btn" onclick="showSection(7)">Next →</button>
            </div>
        </section>

        <!-- Section 7: Real-World Applications -->
        <section class="section" id="section7">
            <h2>Real-World Applications</h2>
            
            <div class="task-box">
                <h3>Password Validation</h3>
                <p>Many websites check password strength using string operations:</p>
                
                <div class="code-editor">
password = input("Enter password: ")
if len(password) < 8:
    print("Too short!")
if password[0].isdigit():
    print("Cannot start with number!")
                </div>
                
                <h4>Try It:</h4>
                <input type="password" id="passwordCheck" class="input-field" placeholder="Enter a password...">
                <button class="submit-btn" onclick="validatePassword()">Validate</button>
                <div id="passwordFeedback"></div>
            </div>

            <div class="task-box">
                <h3>Email Processing</h3>
                <p>Extract username from email address:</p>
                <input type="email" id="emailInput" class="input-field" placeholder="Enter email address...">
                <button class="submit-btn" onclick="extractUsername()">Extract Username</button>
                <div id="emailResult"></div>
            </div>

            <div class="nav-arrows">
                <button class="arrow-btn" onclick="showSection(6)">← Previous</button>
                <button class="arrow-btn" onclick="showSection(8)">Next →</button>
            </div>
        </section>

        <!-- Section 8: Practice Exam Questions -->
        <section class="section" id="section8">
            <h2>Practice Exam Questions</h2>
            
            <div class="task-box">
                <h3>Question 1 (4 marks)</h3>
                <p>A program stores user IDs in the format "DEPT-YEAR-NUMBER", e.g., "COMP-2024-1234".</p>
                <p>Write a function that extracts and returns the department code from a user ID.</p>
                
                <textarea class="input-field" id="examQ1" rows="6" placeholder="Write your answer here..."></textarea>
                
                <div>
                    <label>Predicted marks: <input type="number" id="marks1" min="0" max="4" style="width: 50px;"></label>
                    <button class="submit-btn" onclick="checkExamQ1()">Show Mark Scheme</button>
                </div>
                <div id="examQ1feedback"></div>
            </div>

            <div class="task-box">
                <h3>Question 2 (6 marks)</h3>
                <p>Write a program that checks if a string is a palindrome (reads the same forwards and backwards).</p>
                <p>The program should ignore case and spaces.</p>
                
                <textarea class="input-field" id="examQ2" rows="8" placeholder="Write your answer here..."></textarea>
                
                <div>
                    <label>Predicted marks: <input type="number" id="marks2" min="0" max="6" style="width: 50px;"></label>
                    <button class="submit-btn" onclick="checkExamQ2()">Show Mark Scheme</button>
                </div>
                <div id="examQ2feedback"></div>
            </div>

            <div class="nav-arrows">
                <button class="arrow-btn" onclick="showSection(7)">← Previous</button>
                <button class="arrow-btn" onclick="showSection(9)">Next →</button>
            </div>
        </section>

        <!-- Section 9: Extension Activities -->
        <section class="section" id="section9">
            <h2>Extension Activities</h2>
            
            <div class="task-box">
                <h3>Challenge 1: Caesar Cipher</h3>
                <p>Implement a Caesar cipher that shifts each letter by a given amount.</p>
                
                <div class="code-editor">
# Example: shift("ABC", 1) → "BCD"
# Example: shift("XYZ", 1) → "YZA"
                </div>
                
                <textarea class="input-field" id="extension1" rows="10" placeholder="Write your implementation here..."></textarea>
                <button class="submit-btn" onclick="testCaesarCipher()">Test Solution</button>
                <div id="extension1feedback"></div>
            </div>

            <div class="task-box">
                <h3>Challenge 2: Word Reverser</h3>
                <p>Write a function that reverses the order of words in a sentence while keeping each word intact.</p>
                <p>Example: "Hello World Python" → "Python World Hello"</p>
                
                <textarea class="input-field" id="extension2" rows="8" placeholder="Write your solution here..."></textarea>
                <button class="submit-btn" onclick="testWordReverser()">Test Solution</button>
                <div id="extension2feedback"></div>
            </div>

            <div class="nav-arrows">
                <button class="arrow-btn" onclick="showSection(8)">← Previous</button>
                <button class="arrow-btn" onclick="showSection(10)">Next →</button>
            </div>
        </section>

        <!-- Section 10: Summary Quiz -->
        <section class="section" id="section10">
            <h2>Summary Quiz</h2>
            <p>Test your understanding of string manipulation!</p>
            
            <div class="task-box">
                <h3>Question 1: What does text[-1] return?</h3>
                <button class="quiz-option" onclick="checkSummary(this, false, 's1')">The first character</button>
                <button class="quiz-option" onclick="checkSummary(this, true, 's1')">The last character</button>
                <button class="quiz-option" onclick="checkSummary(this, false, 's1')">An error</button>
                <button class="quiz-option" onclick="checkSummary(this, false, 's1')">The second last character</button>
                <div id="feedback-s1"></div>
            </div>

            <div class="task-box">
                <h3>Question 2: What is the result of "HELLO"[1:4]?</h3>
                <button class="quiz-option" onclick="checkSummary(this, false, 's2')">"HELL"</button>
                <button class="quiz-option" onclick="checkSummary(this, false, 's2')">"ELLO"</button>
                <button class="quiz-option" onclick="checkSummary(this, true, 's2')">"ELL"</button>
                <button class="quiz-option" onclick="checkSummary(this, false, 's2')">"LLO"</button>
                <div id="feedback-s2"></div>
            </div>

            <div class="task-box">
                <h3>Question 3: How do you get the length of a string in Python?</h3>
                <button class="quiz-option" onclick="checkSummary(this, false, 's3')">string.length()</button>
                <button class="quiz-option" onclick="checkSummary(this, false, 's3')">length(string)</button>
                <button class="quiz-option" onclick="checkSummary(this, true, 's3')">len(string)</button>
                <button class="quiz-option" onclick="checkSummary(this, false, 's3')">string.size()</button>
                <div id="feedback-s3"></div>
            </div>

            <div class="task-box">
                <h3>Question 4: Which slice gets "COMP" from "COMPUTER"?</h3>
                <button class="quiz-option" onclick="checkSummary(this, false, 's4')">[0:3]</button>
                <button class="quiz-option" onclick="checkSummary(this, true, 's4')">[0:4]</button>
                <button class="quiz-option" onclick="checkSummary(this, false, 's4')">[1:4]</button>
                <button class="quiz-option" onclick="checkSummary(this, false, 's4')">[0:5]</button>
                <div id="feedback-s4"></div>
            </div>

            <div class="task-box">
                <h3>Question 5: True or False: Strings can be modified directly</h3>
                <button class="quiz-option" onclick="checkSummary(this, false, 's5')">True</button>
                <button class="quiz-option" onclick="checkSummary(this, true, 's5')">False</button>
                <div id="feedback-s5"></div>
            </div>

            <div class="task-box">
                <h3>Question 6: What does string[:3] mean?</h3>
                <button class="quiz-option" onclick="checkSummary(this, false, 's6')">Last 3 characters</button>
                <button class="quiz-option" onclick="checkSummary(this, true, 's6')">First 3 characters</button>
                <button class="quiz-option" onclick="checkSummary(this, false, 's6')">Skip first 3 characters</button>
                <button class="quiz-option" onclick="checkSummary(this, false, 's6')">Every 3rd character</button>
                <div id="feedback-s6"></div>
            </div>

            <div class="nav-arrows">
                <button class="arrow-btn" onclick="showSection(9)">← Previous</button>
                <button class="arrow-btn" onclick="showSection(11)">Next →</button>
            </div>
        </section>

        <!-- Section 11: Videos -->
        <section class="section" id="section11">
            <h2>Video Resources</h2>
            
            <div class="task-box">
                <h3>Recommended Videos</h3>
                <p>Watch these videos to reinforce your learning:</p>
                
                <div style="background-color: #ecf0f1; padding: 20px; margin: 10px 0; border-radius: 5px;">
                    <p>📹 <strong>Video 1:</strong> Introduction to String Indexing</p>
                    <p><em>Duration: 8 minutes</em></p>
                    <p>[Video placeholder - Link to be added]</p>
                </div>
                
                <div style="background-color: #ecf0f1; padding: 20px; margin: 10px 0; border-radius: 5px;">
                    <p>📹 <strong>Video 2:</strong> String Slicing Explained</p>
                    <p><em>Duration: 12 minutes</em></p>
                    <p>[Video placeholder - Link to be added]</p>
                </div>
                
                <div style="background-color: #ecf0f1; padding: 20px; margin: 10px 0; border-radius: 5px;">
                    <p>📹 <strong>Video 3:</strong> Common String Methods in Python</p>
                    <p><em>Duration: 15 minutes</em></p>
                    <p>[Video placeholder - Link to be added]</p>
                </div>
            </div>

            <div class="task-box">
                <h3>Additional Resources</h3>
                <ul>
                    <li>Python Documentation on Strings</li>
                    <li>OCR J277 Specification Guide</li>
                    <li>Practice Problems Repository</li>
                </ul>
            </div>

            <div class="nav-arrows">
                <button class="arrow-btn" onclick="showSection(10)">← Previous</button>
                <button class="arrow-btn" disabled>Next →</button>
            </div>
        </section>
    </div>

    <button class="feedback-button" onclick="openFeedbackModal()" aria-label="Send Feedback">💬</button>

    <div class="modal-overlay" id="modalOverlay" onclick="closeFeedbackModal()"></div>
    <div class="feedback-modal" id="feedbackModal">
        <h3>Send Feedback</h3>
        <p>Found a bug or have a suggestion? Let us know!</p>
        <textarea id="feedbackText" class="input-field" rows="5" placeholder="Describe the issue or suggestion..."></textarea>
        <button class="submit-btn" onclick="sendFeedback()">Send</button>
        <button class="reset-btn" onclick="closeFeedbackModal()">Cancel</button>
    </div>

    <div class="paste-shame" id="pasteShame">
        🚫 No pasting allowed! Type it yourself! 🚫
    </div>

    <script>
        // Global variables
        let currentSection = 0;
        let xp = 0;
        let level = 0;
        let achievements = 0;
        let completedTasks = new Set();
        let draggedItem = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            initializeCanvas();
            updateXPDisplay();
        });

        // Navigation
        function showSection(index) {
            const sections = document.querySelectorAll('.section');
            const navBtns = document.querySelectorAll('.nav-btn');
            
            sections.forEach(section => section.classList.remove('active'));
            navBtns.forEach(btn => btn.classList.remove('active'));
            
            sections[index].classList.add('active');
            navBtns[index].classList.add('active');
            currentSection = index;
            
            // Scroll to top
            window.scrollTo(0, 0);
        }

        // XP and Achievements System
        function addXP(amount, taskId) {
            if (!completedTasks.has(taskId)) {
                completedTasks.add(taskId);
                xp += amount;
                updateLevel();
                updateXPDisplay();
                
                // Check for achievements
                checkAchievements();
            }
        }

        function updateLevel() {
            const oldLevel = level;
            level = Math.min(Math.floor(xp / 100), 5);
            
            if (level > oldLevel) {
                showAchievement(`Level ${level} Reached! 🎉`);
            }
        }

        function updateXPDisplay() {
            document.getElementById('xp').textContent = xp;
            document.getElementById('level').textContent = level;
            document.getElementById('achievements').textContent = achievements;
        }

        function showAchievement(message) {
            achievements++;
            const popup = document.getElementById('achievementPopup');
            popup.textContent = message;
            popup.style.display = 'block';
            
            setTimeout(() => {
                popup.style.display = 'none';
            }, 3000);
            
            updateXPDisplay();
        }

        function checkAchievements() {
            if (xp >= 50 && !completedTasks.has('first50')) {
                completedTasks.add('first50');
                showAchievement('Quick Learner! 50 XP earned! 🌟');
            }
            
            if (completedTasks.size >= 5 && !completedTasks.has('fiveTasks')) {
                completedTasks.add('fiveTasks');
                showAchievement('Task Master! 5 tasks completed! 🏆');
            }
        }

        // Quiz functionality
        function checkQuizAnswer(button, isCorrect, questionId) {
            const options = button.parentElement.querySelectorAll('.quiz-option');
            options.forEach(opt => opt.disabled = true);
            
            button.classList.add('selected');
            
            const feedback = document.getElementById(`feedback-${questionId}`);
            if (isCorrect) {
                feedback.className = 'feedback correct';
                feedback.textContent = 'Correct! Well done!';
                addXP(10, questionId);
            } else {
                feedback.className = 'feedback incorrect';
                feedback.textContent = 'Not quite. Try again!';
                setTimeout(() => {
                    options.forEach(opt => opt.disabled = false);
                    button.classList.remove('selected');
                }, 2000);
            }
        }

        // Drag and Drop functionality
        function setupEventListeners() {
            const dragItems = document.querySelectorAll('.drag-item');
            dragItems.forEach(item => {
                item.addEventListener('dragstart', dragStart);
                item.addEventListener('dragend', dragEnd);
                
                // Touch events for mobile
                item.addEventListener('touchstart', touchStart, {passive: false});
                item.addEventListener('touchmove', touchMove, {passive: false});
                item.addEventListener('touchend', touchEnd);
            });
            
            // Prevent paste
            document.addEventListener('paste', function(e) {
                e.preventDefault();
                showPasteShame();
                return false;
            });
            
            // Add click listeners to string visualization
            const charBoxes = document.querySelectorAll('.char-box');
            charBoxes.forEach((box, index) => {
                box.addEventListener('click', () => {
                    document.getElementById('indexDisplay').textContent = 
                        `Character '${box.textContent.trim()}' is at index ${index}`;
                });
            });
        }

        function dragStart(e) {
            draggedItem = e.target;
            e.target.style.opacity = '0.5';
        }

        function dragEnd(e) {
            e.target.style.opacity = '';
        }

        function allowDrop(e) {
            e.preventDefault();
            e.target.classList.add('drag-over');
        }

        function drop(e) {
            e.preventDefault();
            e.target.classList.remove('drag-over');
            
            if (draggedItem) {
                const newItem = draggedItem.cloneNode(true);
                e.target.appendChild(newItem);
                draggedItem.style.display = 'none';
            }
        }

        // Touch events for mobile
        let touchItem = null;
        let touchOffset = {x: 0, y: 0};

        function touchStart(e) {
            touchItem = e.target;
            const touch = e.touches[0];
            touchOffset.x = touch.clientX - touchItem.offsetLeft;
            touchOffset.y = touch.clientY - touchItem.offsetTop;
        }

        function touchMove(e) {
            if (!touchItem) return;
            e.preventDefault();
            
            const touch = e.touches[0];
            touchItem.style.position = 'fixed';
            touchItem.style.left = (touch.clientX - touchOffset.x) + 'px';
            touchItem.style.top = (touch.clientY - touchOffset.y) + 'px';
        }

        function touchEnd(e) {
            if (!touchItem) return;
            
            const dropZone = document.getElementById('stringBuilder');
            const rect = dropZone.getBoundingClientRect();
            const touch = e.changedTouches[0];
            
            if (touch.clientX >= rect.left && touch.clientX <= rect.right &&
                touch.clientY >= rect.top && touch.clientY <= rect.bottom) {
                const newItem = touchItem.cloneNode(true);
                dropZone.appendChild(newItem);
                touchItem.style.display = 'none';
            }
            
            touchItem.style.position = '';
            touchItem.style.left = '';
            touchItem.style.top = '';
            touchItem = null;
        }

        // String builder check
        function addCharToBuilder(char) {
            const builder = document.getElementById('stringBuilder');
            builder.textContent += char;
        }

        function checkStringBuilder() {
            const builder = document.getElementById('stringBuilder');
            const result = builder.textContent;
            
            const feedback = document.getElementById('builderFeedback');
            if (result === 'HELLO') {
                feedback.className = 'feedback correct';
                feedback.textContent = 'Excellent! You built the word correctly!';
                addXP(15, 'stringBuilder');
            } else {
                feedback.className = 'feedback incorrect';
                feedback.textContent = `Not quite. You built "${result}". Try again!`;
            }
        }

        function resetStringBuilder() {
            document.getElementById('stringBuilder').textContent = '';
            document.getElementById('builderFeedback').textContent = '';
        }

        // String visualization
        function visualizeUserString() {
            const input = document.getElementById('userString').value;
            const viz = document.getElementById('userStringViz');
            
            if (!input) {
                viz.innerHTML = '<p style="color: #e74c3c;">Please enter a string!</p>';
                return;
            }
            
            let html = '<div class="string-visualization">';
            for (let i = 0; i < input.length; i++) {
                html += `
                    <div class="char-box">
                        <span class="index-label">${i}</span>
                        ${input[i]}
                    </div>
                `;
            }
            html += '</div>';
            
            viz.innerHTML = html;
            addXP(5, 'visualize');
        }

        // Indexing exercises
        function checkIndexing(inputId, expected, feedbackId) {
            const answer = document.getElementById(inputId).value.toUpperCase();
            const feedback = document.getElementById(feedbackId);
            
            if (answer === expected) {
                feedback.className = 'feedback correct';
                feedback.textContent = 'Correct! Well done!';
                addXP(15, inputId);
            } else {
                feedback.className = 'feedback incorrect';
                feedback.textContent = `Not quite. Try counting from 0!`;
            }
        }

        function showHint(hintId) {
            document.getElementById(hintId).style.display = 'block';
            xp = Math.max(0, xp - 5);
            updateXPDisplay();
        }

        // Slicing simulator
        function simulateSlice() {
            const text = document.getElementById('sliceInput').value;
            const start = parseInt(document.getElementById('sliceStart').value) || 0;
            const end = parseInt(document.getElementById('sliceEnd').value);
            
            let result;
            if (isNaN(end)) {
                result = text.slice(start);
            } else {
                result = text.slice(start, end);
            }
            
            document.getElementById('sliceResult').textContent = 
                `text[${start}:${end || ''}] = "${result}"`;
            
            addXP(5, 'sliceSimulator');
        }

        // Fill in the blanks
        function checkSliceFill() {
            const blank1 = document.getElementById('blank1').value;
            const blank2 = document.getElementById('blank2').value;
            const feedback = document.getElementById('sliceFillFeedback');
            
            if (blank1 === '0' && blank2 === '4') {
                feedback.className = 'feedback correct';
                feedback.textContent = 'Perfect! text[0:4] gives "GOOD"';
                addXP(20, 'sliceFill');
            } else {
                feedback.className = 'feedback incorrect';
                feedback.textContent = 'Not quite. Remember: slicing excludes the end index!';
            }
        }

        // Canvas functionality
        let canvas, ctx;
        let isDrawing = false;

        function initializeCanvas() {
            canvas = document.getElementById('drawingCanvas');
            if (!canvas) return;
            
            ctx = canvas.getContext('2d');
            ctx.strokeStyle = '#34495e';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            // Touch events
            canvas.addEventListener('touchstart', handleTouch);
            canvas.addEventListener('touchmove', handleTouch);
            canvas.addEventListener('touchend', stopDrawing);
        }

        function startDrawing(e) {
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            ctx.beginPath();
            ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        }

        function draw(e) {
            if (!isDrawing) return;
            
            const rect = canvas.getBoundingClientRect();
            ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
            ctx.stroke();
        }

        function handleTouch(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 
                                            e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        }

        function stopDrawing() {
            isDrawing = false;
        }

        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        // Common mistakes section
        function checkMistake(button, isCorrect, mistakeId) {
            checkQuizAnswer(button, isCorrect, mistakeId);
        }

        // Real-world applications
        function validatePassword() {
            const password = document.getElementById('passwordCheck').value;
            const feedback = document.getElementById('passwordFeedback');
            let messages = [];
            
            if (password.length < 8) {
                messages.push('❌ Too short (minimum 8 characters)');
            } else {
                messages.push('✅ Good length');
            }
            
            if (password[0] && password[0].match(/[0-9]/)) {
                messages.push('❌ Cannot start with a number');
            } else {
                messages.push('✅ Good start');
            }
            
            if (password.match(/[A-Z]/)) {
                messages.push('✅ Contains uppercase');
            } else {
                messages.push('❌ Add uppercase letter');
            }
            
            feedback.innerHTML = messages.join('<br>');
            feedback.className = 'feedback';
            
            if (messages.filter(m => m.startsWith('✅')).length === 3) {
                addXP(15, 'passwordValidation');
            }
        }

        function extractUsername() {
            const email = document.getElementById('emailInput').value;
            const result = document.getElementById('emailResult');
            
            if (!email.includes('@')) {
                result.textContent = 'Please enter a valid email address';
                result.className = 'feedback incorrect';
                return;
            }
            
            const atIndex = email.indexOf('@');
            const username = email.slice(0, atIndex);
            
            result.textContent = `Username: ${username}`;
            result.className = 'feedback correct';
            addXP(10, 'emailExtract');
        }

        // Exam questions
        function checkExamQ1() {
            const answer = document.getElementById('examQ1').value;
            const marks = document.getElementById('marks1').value;
            const feedback = document.getElementById('examQ1feedback');
            
            if (!marks || answer.length < 50) {
                feedback.className = 'feedback incorrect';
                feedback.textContent = 'Please predict your marks and write a complete answer first.';
                return;
            }
            
            const keywords = ['split', 'index', '[0]', 'return', 'function', 'def'];
            const score = keywords.filter(kw => answer.toLowerCase().includes(kw)).length;
            
            feedback.className = 'feedback';
            feedback.innerHTML = `
                <h4>Mark Scheme (4 marks):</h4>
                <ul>
                    <li>1 mark: Function definition with parameter</li>
                    <li>1 mark: Using split() method with '-' delimiter</li>
                    <li>1 mark: Accessing first element [0]</li>
                    <li>1 mark: Returning the result</li>
                </ul>
                <p>Your answer shows understanding of ${score}/4 key concepts.</p>
            `;
            
            addXP(20, 'examQ1');
        }

        function checkExamQ2() {
            const answer = document.getElementById('examQ2').value;
            const marks = document.getElementById('marks2').value;
            const feedback = document.getElementById('examQ2feedback');
            
            if (!marks || answer.length < 80) {
                feedback.className = 'feedback incorrect';
                feedback.textContent = 'Please predict your marks and write a complete answer first.';
                return;
            }
            
            feedback.className = 'feedback';
            feedback.innerHTML = `
                <h4>Mark Scheme (6 marks):</h4>
                <ul>
                    <li>1 mark: Input handling</li>
                    <li>1 mark: Converting to same case (upper/lower)</li>
                    <li>1 mark: Removing spaces</li>
                    <li>1 mark: Reversing the string</li>
                    <li>1 mark: Comparison logic</li>
                    <li>1 mark: Appropriate output</li>
                </ul>
            `;
            
            addXP(25, 'examQ2');
        }

        // Extension activities
        function testCaesarCipher() {
            const code = document.getElementById('extension1').value;
            const feedback = document.getElementById('extension1feedback');
            
            if (code.length < 100) {
                feedback.className = 'feedback incorrect';
                feedback.textContent = 'Please write a complete implementation.';
                return;
            }
            
            feedback.className = 'feedback correct';
            feedback.textContent = 'Great implementation! Consider edge cases like wrapping from Z to A.';
            addXP(40, 'caesarCipher');
        }

        function testWordReverser() {
            const code = document.getElementById('extension2').value;
            const feedback = document.getElementById('extension2feedback');
            
            const hasCorrectApproach = code.includes('split') && 
                                      (code.includes('reverse') || code.includes('[::-1]'));
            
            if (hasCorrectApproach) {
                feedback.className = 'feedback correct';
                feedback.textContent = 'Excellent! Using split() and reverse is the right approach!';
                addXP(35, 'wordReverser');
            } else {
                feedback.className = 'feedback incorrect';
                feedback.textContent = 'Hint: Try splitting the string into words first.';
            }
        }

        // Summary quiz
        function checkSummary(button, isCorrect, summaryId) {
            checkQuizAnswer(button, isCorrect, summaryId);
        }

        // Accessibility
        function changeFontSize(delta) {
            const body = document.body;
            const currentSize = parseInt(window.getComputedStyle(body).fontSize);
            body.style.fontSize = (currentSize + delta) + 'px';
        }

        function toggleHighContrast() {
            document.body.classList.toggle('high-contrast');
        }

        // Paste prevention
        function showPasteShame() {
            const shame = document.getElementById('pasteShame');
            shame.style.display = 'block';
            
            setTimeout(() => {
                shame.style.display = 'none';
            }, 3000);
        }

        // Feedback system
        function openFeedbackModal() {
            document.getElementById('feedbackModal').style.display = 'block';
            document.getElementById('modalOverlay').style.display = 'block';
        }

        function closeFeedbackModal() {
            document.getElementById('feedbackModal').style.display = 'none';
            document.getElementById('modalOverlay').style.display = 'none';
        }

        function sendFeedback() {
            const feedbackText = document.getElementById('feedbackText').value;
            const sectionTitle = document.querySelector('.section.active h2').textContent;
            
            if (!feedbackText) {
                alert('Please enter your feedback!');
                return;
            }
            
            // Prepare email content
            const subject = `String Manipulation Worksheet Feedback - ${sectionTitle}`;
            const body = `Section: ${sectionTitle}\n\nFeedback: ${feedbackText}\n\nUser Agent: ${navigator.userAgent}`;
            
            // Create mailto link
            const mailtoLink = `mailto:millingtond@mgs.org?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.location.href = mailtoLink;
            
            closeFeedbackModal();
            document.getElementById('feedbackText').value = '';
            
            showAchievement('Thanks for your feedback! 💌');
        }

        // Keyboard navigation
        document.addEventListener('keydown', function(e) {
            if (e.key === 'ArrowLeft' && currentSection > 0) {
                showSection(currentSection - 1);
            } else if (e.key === 'ArrowRight' && currentSection < 11) {
                showSection(currentSection + 1);
            }
        });

        // Python Editor Implementation
        let pythonEditors = {};
        let skulptLoaded = false;

        // Load Skulpt with multiple CDN fallbacks
        async function loadSkulptWithFallbacks() {
            const skulptSources = [
                {
                    name: 'CDNjs (Latest)',
                    main: 'https://cdnjs.cloudflare.com/ajax/libs/skulpt/1.2.0/skulpt.min.js',
                    stdlib: 'https://cdnjs.cloudflare.com/ajax/libs/skulpt/1.2.0/skulpt-stdlib.js'
                },
                {
                    name: 'jsDelivr CDN',
                    main: 'https://cdn.jsdelivr.net/npm/skulpt@1.2.0/dist/skulpt.min.js',
                    stdlib: 'https://cdn.jsdelivr.net/npm/skulpt@1.2.0/dist/skulpt-stdlib.js'
                },
                {
                    name: 'Unpkg CDN',
                    main: 'https://unpkg.com/skulpt@1.2.0/dist/skulpt.min.js',
                    stdlib: 'https://unpkg.com/skulpt@1.2.0/dist/skulpt-stdlib.js'
                },
                {
                    name: 'cdnjs (Stable 0.11.0)',
                    main: 'https://cdnjs.cloudflare.com/ajax/libs/skulpt/0.11.0/skulpt.min.js',
                    stdlib: 'https://cdnjs.cloudflare.com/ajax/libs/skulpt/0.11.0/skulpt-stdlib.js'
                }
            ];

            for (const source of skulptSources) {
                try {
                    await loadScript(source.main);
                    await loadScript(source.stdlib);
                    if (typeof Sk !== 'undefined') {
                        console.log(`Skulpt loaded from ${source.name}`);
                        skulptLoaded = true;
                        return true;
                    }
                } catch (e) {
                    console.warn(`Failed to load from ${source.name}:`, e);
                }
            }
            return false;
        }

        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.crossOrigin = 'anonymous';
                script.async = true;
                
                const timeoutId = setTimeout(() => {
                    script.remove();
                    reject(new Error(`Timeout loading ${src}`));
                }, 15000);
                
                script.onload = () => {
                    clearTimeout(timeoutId);
                    resolve();
                };
                
                script.onerror = () => {
                    clearTimeout(timeoutId);
                    reject(new Error(`Failed to load ${src}`));
                };
                
                document.head.appendChild(script);
            });
        }

        // Initialize Python editor with Ace or fallback
        function initializePythonEditor(editorId, starterCode = '') {
            const editorDiv = document.getElementById(editorId);
            if (!editorDiv) return null;
            
            let editor;
            
            // Check if Ace is available
            if (typeof ace === 'undefined') {
                console.warn('Ace Editor not loaded, using fallback textarea');
                
                // Create fallback textarea
                editorDiv.innerHTML = `<textarea id="${editorId}-fallback"
                    style="width: 100%; height: 100%; background: #272822;
                    color: #f8f8f2; font-family: monospace; font-size: 14px;
                    padding: 10px; border: none; resize: none;"></textarea>`;
                
                const textarea = document.getElementById(`${editorId}-fallback`);
                textarea.value = starterCode;
                
                // Create fallback editor object
                editor = {
                    getValue: () => textarea.value,
                    setValue: (val) => { textarea.value = val; },
                    destroy: () => {},
                    focus: () => { textarea.focus(); },
                    editorId: editorId
                };
                
                // Add keyboard shortcut
                textarea.addEventListener('keydown', (e) => {
                    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                        e.preventDefault();
                        runPythonCode(editorId);
                    }
                });
                
                // Prevent paste
                textarea.addEventListener('paste', (e) => {
                    e.preventDefault();
                    showPasteShame();
                });
            } else {
                // Initialize Ace Editor
                editor = ace.edit(editorId);
                editor.setTheme('ace/theme/monokai');
                editor.session.setMode('ace/mode/python');
                editor.setOptions({
                    enableBasicAutocompletion: true,
                    enableLiveAutocompletion: true,
                    enableSnippets: true,
                    showLineNumbers: true,
                    tabSize: 4,
                    useSoftTabs: true,
                    fontSize: '14px',
                    fontFamily: 'Consolas, Monaco, "Courier New", monospace',
                    showPrintMargin: false,
                    highlightActiveLine: true,
                    wrap: false
                });
                
                // Set initial code
                editor.setValue(starterCode, -1);
                
                // Disable paste
                editor.on('paste', function(e) {
                    if (e.text !== undefined) {
                        e.text = '';
                    }
                    showPasteShame();
                    return false;
                });
                
                // Add keyboard shortcut for running code
                editor.commands.addCommand({
                    name: 'runCode',
                    bindKey: {win: 'Ctrl-Enter', mac: 'Command-Enter'},
                    exec: function() {
                        runPythonCode(editorId);
                    },
                    readOnly: true
                });
                
                editor.editorId = editorId;
            }
            
            pythonEditors[editorId] = editor;
            return editor;
        }

        // Configure Skulpt
        function configureSkulpt(outputFunc, inputFunc) {
            try {
                Sk.configure({
                    output: outputFunc,
                    read: function(x) {
                        if (Sk.builtinFiles === undefined || Sk.builtinFiles["files"][x] === undefined) {
                            throw "File not found: '" + x + "'";
                        }
                        return Sk.builtinFiles["files"][x];
                    },
                    inputfun: inputFunc,
                    inputfunTakesPrompt: true,
                    __future__: Sk.python3 || Sk.python2
                });
                
                // Set execution limit to prevent infinite loops
                Sk.execLimit = 10000; // 10 seconds
            } catch (e) {
                console.error('Skulpt configuration error:', e);
                // Fallback to minimal configuration
                Sk.configure({
                    output: outputFunc,
                    inputfun: inputFunc
                });
            }
        }

        // Create visual input panel
        function createInputPanel() {
            const panel = document.createElement('div');
            panel.className = 'input-panel active';
            
            const prompt = document.createElement('div');
            prompt.className = 'input-prompt';
            
            const inputField = document.createElement('input');
            inputField.className = 'input-field';
            inputField.type = 'text';
            
            const submitBtn = document.createElement('button');
            submitBtn.className = 'input-submit';
            submitBtn.textContent = 'Submit';
            
            panel.appendChild(prompt);
            panel.appendChild(inputField);
            panel.appendChild(submitBtn);
            
            return { panel, prompt, inputField, submitBtn };
        }

        // Format Python errors for students
        function formatPythonError(err) {
            let errorStr = err.toString();
            
            // Remove internal Skulpt traceback info
            errorStr = errorStr.replace(/on line \d+ of <stdin>/g, '');
            errorStr = errorStr.replace(/File "<stdin>",/g, '');
            
            // Make common errors more student-friendly
            if (errorStr.includes('SyntaxError')) {
                errorStr = 'SyntaxError: Check your code syntax (missing colons, brackets, quotes, etc.)';
            } else if (errorStr.includes('IndentationError')) {
                errorStr = 'IndentationError: Check your code indentation (use consistent spaces)';
            } else if (errorStr.includes('NameError')) {
                const match = errorStr.match(/name '(\w+)' is not defined/);
                if (match) {
                    errorStr = `NameError: '${match[1]}' is not defined. Check spelling or define it first.`;
                }
            } else if (errorStr.includes('TimeLimitError')) {
                errorStr = 'Your code took too long to run. Check for infinite loops.';
            }
            
            return errorStr;
        }

        // Run Python code
        async function runPythonCode(editorId) {
            if (!skulptLoaded) {
                alert('Python environment is still loading. Please wait a moment and try again.');
                return;
            }
            
            const editor = pythonEditors[editorId];
            if (!editor) return;
            
            const outputElement = document.getElementById(`${editorId}-output`);
            const runButton = document.querySelector(`#${editorId}-container .run-button`);
            
            if (runButton) runButton.disabled = true;
            outputElement.textContent = 'Running...';
            outputElement.classList.remove('error');
            
            const code = editor.getValue();
            let fullOutput = "";
            const outputPanel = outputElement.parentElement;
            let inputPanelData = null;
            
            // Configure Skulpt with visual input handling
            configureSkulpt(
                // Output function
                (text) => {
                    fullOutput += text;
                    outputElement.textContent = fullOutput;
                },
                // Input function with visual panel
                (promptText) => {
                    return new Promise((resolve) => {
                        // Add prompt to output
                        fullOutput += promptText;
                        outputElement.textContent = fullOutput;
                        
                        // Create and show input panel
                        inputPanelData = createInputPanel();
                        inputPanelData.prompt.textContent = promptText;
                        outputPanel.parentNode.insertBefore(inputPanelData.panel, outputPanel.nextSibling);
                        
                        // Focus input field
                        inputPanelData.inputField.focus();
                        
                        // Handle submit
                        const submitHandler = () => {
                            const value = inputPanelData.inputField.value;
                            fullOutput += value + '\n';
                            outputElement.textContent = fullOutput;
                            inputPanelData.panel.remove();
                            resolve(value);
                        };
                        
                        inputPanelData.submitBtn.addEventListener('click', submitHandler);
                        inputPanelData.inputField.addEventListener('keypress', (e) => {
                            if (e.key === 'Enter') {
                                submitHandler();
                            }
                        });
                    });
                }
            );
            
            try {
                // Execute the Python code
                await Sk.misceval.asyncToPromise(() =>
                    Sk.importMainWithBody("<stdin>", false, code, true)
                );
                
                outputElement.textContent = fullOutput || '(No output)';
                
                // Check if this is a task and award XP
                if (editorId.includes('task') && fullOutput.trim()) {
                    addXP(20, `python-${editorId}`);
                }
            } catch (err) {
                // Clean up any open input panel
                if (inputPanelData && inputPanelData.panel.parentNode) {
                    inputPanelData.panel.remove();
                }
                
                outputElement.textContent = formatPythonError(err);
                outputElement.classList.add('error');
            }
            
            if (runButton) runButton.disabled = false;
        }

        // Run test cases
        async function runTestCase(code, inputs, expectedOutput) {
            let mockInputs = [...inputs];
            let output = "";
            
            configureSkulpt(
                (text) => { output += text; },
                (promptText) => {
                    if (mockInputs.length > 0) {
                        return Promise.resolve(mockInputs.shift());
                    }
                    return Promise.resolve("");
                }
            );
            
            try {
                await Sk.misceval.asyncToPromise(() =>
                    Sk.importMainWithBody("<stdin>", false, code, true)
                );
                
                const passed = output.trim() === expectedOutput.trim();
                return { success: true, output: output, passed: passed };
            } catch (err) {
                return { success: false, output: formatPythonError(err), passed: false };
            }
        }

        // Initialize Python editors when section becomes active
        let pythonEditorsInitialized = false;
        const originalShowSection = showSection;
        showSection = function(index) {
            originalShowSection(index);
            
            // Initialize Python editors when Practice Tasks section is shown
            if (index === 5 && !pythonEditorsInitialized) {
                initializePythonEditorsInSection();
                pythonEditorsInitialized = true;
            }
        };

        // Initialize all Python editors in the practice section
        async function initializePythonEditorsInSection() {
            // First, ensure Skulpt is loaded
            if (!skulptLoaded) {
                const loadingMessages = document.querySelectorAll('.loading-message');
                loadingMessages.forEach(msg => msg.textContent = 'Loading Python environment...');
                
                const loaded = await loadSkulptWithFallbacks();
                if (!loaded) {
                    loadingMessages.forEach(msg => {
                        msg.textContent = 'Failed to load Python environment. Please refresh the page.';
                        msg.style.color = '#e74c3c';
                    });
                    return;
                }
                
                loadingMessages.forEach(msg => msg.style.display = 'none');
            }
            
            // Load Ace Editor extensions if available
            if (typeof ace !== 'undefined') {
                // Load Python mode
                const pythonMode = document.createElement('script');
                pythonMode.src = 'https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.3/mode-python.min.js';
                pythonMode.crossOrigin = 'anonymous';
                document.head.appendChild(pythonMode);
                
                // Load Monokai theme
                const monokaiTheme = document.createElement('script');
                monokaiTheme.src = 'https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.3/theme-monokai.min.js';
                monokaiTheme.crossOrigin = 'anonymous';
                document.head.appendChild(monokaiTheme);
                
                // Load language tools for autocomplete
                const langTools = document.createElement('script');
                langTools.src = 'https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.3/ext-language_tools.min.js';
                langTools.crossOrigin = 'anonymous';
                document.head.appendChild(langTools);
            }
            
            // Initialize editors with starter code
            setTimeout(() => {
                initializePythonEditor('task1-editor', '# Task 1: Extract username from email\n# Example: "student@school.edu" → "student"\n\nemail = input("Enter email: ")\n# Find the position of @ and extract username\n');
                initializePythonEditor('task2-editor', '# Task 2: Password validator\n# Check: 8+ chars, first char uppercase, last 3 digits\n\npassword = input("Enter password: ")\n# Your validation code here\n');
                initializePythonEditor('task3-editor', '# Task 3: Name formatter\n# Example: "john smith" → "Smith, J."\n\nfullname = input("Enter full name: ")\n# Your formatting code here\n');
            }, 1000);
        }

        // Python editor specific functions
        function resetPythonEditor(editorId) {
            const editor = pythonEditors[editorId];
            if (!editor) return;
            
            const starterCode = {
                'task1-editor': '# Task 1: Extract username from email\n# Example: "student@school.edu" → "student"\n\nemail = input("Enter email: ")\n# Find the position of @ and extract username\n',
                'task2-editor': '# Task 2: Password validator\n# Check: 8+ chars, first char uppercase, last 3 digits\n\npassword = input("Enter password: ")\n# Your validation code here\n',
                'task3-editor': '# Task 3: Name formatter\n# Example: "john smith" → "Smith, J."\n\nfullname = input("Enter full name: ")\n# Your formatting code here\n'
            };
            
            editor.setValue(starterCode[editorId] || '# Write your Python code here\n', -1);
            document.getElementById(`${editorId}-output`).textContent = '';
            const testsDiv = document.getElementById(`${editorId.replace('-editor', '-tests')}`);
            if (testsDiv) testsDiv.innerHTML = '';
        }

        // New check functions for OCR Reference Language
        function checkAnswer(inputId, expected, feedbackId, allowVariations = false) {
            const answer = document.getElementById(inputId).value.trim();
            const feedback = document.getElementById(feedbackId);
            
            let isCorrect = false;
            if (allowVariations) {
                // For code answers, remove spaces and quotes variations
                const normalizedAnswer = answer.replace(/\s/g, '').replace(/['"]/g, '');
                const normalizedExpected = expected.replace(/\s/g, '').replace(/&quot;/g, '').replace(/&apos;/g, '');
                isCorrect = normalizedAnswer === normalizedExpected;
            } else {
                isCorrect = answer === expected;
            }
            
            if (isCorrect) {
                feedback.className = 'feedback correct';
                feedback.textContent = 'Correct! Well done!';
                addXP(10, inputId);
            } else {
                feedback.className = 'feedback incorrect';
                feedback.textContent = `Not quite. Expected: ${expected}`;
            }
        }

        function checkCaseAnswers() {
            const answer1 = document.getElementById('case-ocr-1').value.trim();
            const answer2 = document.getElementById('case-ocr-2').value.trim();
            const feedback = document.getElementById('case-feedback');
            
            if (answer1 === 'HELLO WORLD' && answer2 === 'hello world') {
                feedback.className = 'feedback correct';
                feedback.textContent = 'Both correct! Well done!';
                addXP(15, 'case-conversion');
            } else {
                feedback.className = 'feedback incorrect';
                let msg = 'Not quite. ';
                if (answer1 !== 'HELLO WORLD') msg += 'First should be "HELLO WORLD". ';
                if (answer2 !== 'hello world') msg += 'Second should be "hello world".';
                feedback.textContent = msg;
            }
        }

        function checkTask1OCR() {
            const code = document.getElementById('task1-ocr').value;
            const feedback = document.getElementById('task1-ocr-feedback');
            
            // Check for key OCR Reference Language elements
            const hasLeftFunction = code.includes('.left(');
            const hasAtPosition = code.includes('atPosition') || code.includes('at_position');
            
            if (hasLeftFunction || (hasAtPosition && code.includes('substring'))) {
                feedback.className = 'feedback correct';
                feedback.textContent = 'Good OCR Reference Language solution! The .left() function or substring approach works well here.';
                addXP(25, 'task1-ocr');
            } else {
                feedback.className = 'feedback incorrect';
                feedback.textContent = 'Remember to use OCR Reference Language syntax: email.left(atPosition) or email.substring(0, atPosition)';
            }
        }

        function checkTask2OCR() {
            const code = document.getElementById('task2-ocr').value;
            const feedback = document.getElementById('task2-ocr-feedback');
            
            const hasLength = code.includes('.length');
            const hasLeft = code.includes('.left(1)');
            const hasRight = code.includes('.right(3)');
            const hasASC = code.includes('ASC(');
            
            if (hasLength && (hasLeft || code.includes('substring')) && hasRight) {
                feedback.className = 'feedback correct';
                feedback.textContent = 'Excellent OCR Reference Language solution! You correctly used .length, character extraction, and possibly ASC() for validation.';
                addXP(30, 'task2-ocr');
            } else {
                feedback.className = 'feedback incorrect';
                let missing = [];
                if (!hasLength) missing.push('.length');
                if (!hasLeft) missing.push('.left() or .substring()');
                if (!hasRight) missing.push('.right()');
                feedback.textContent = `Missing OCR Reference Language elements: ${missing.join(', ')}`;
            }
        }

        function checkTask3OCR() {
            const code = document.getElementById('task3-ocr').value;
            const feedback = document.getElementById('task3-ocr-feedback');
            
            const hasSpaceFinding = code.includes('POSITION(') || code.includes('position of space');
            const hasSubstring = code.includes('.substring(') || code.includes('.left(') || code.includes('.right(');
            const hasUpper = code.includes('.upper');
            const hasConcatenation = code.includes('+');
            
            if (hasSubstring && hasUpper) {
                feedback.className = 'feedback correct';
                feedback.textContent = 'Great OCR Reference Language solution! You used string extraction and case conversion correctly.';
                addXP(35, 'task3-ocr');
            } else {
                feedback.className = 'feedback incorrect';
                feedback.textContent = 'Remember to use OCR functions like .substring(), .upper, and string concatenation with +';
            }
        }

        // Test case functions
        async function runTask1Tests() {
            // This function is not needed for the new tasks structure
            alert('Please use the Run button to test your code with different inputs.');
        }

        async function runTask2Tests() {
            // This function is not needed for the new tasks structure
            alert('Please use the Run button to test your code with different inputs.');
        }

        async function runTask3Tests() {
            if (!skulptLoaded) {
                alert('Python environment is still loading. Please wait a moment.');
                return;
            }
            
            const editor = pythonEditors['task3-editor'];
            if (!editor) return;
            
            const code = editor.getValue();
            const testCases = [
                { inputs: ['john smith'], expected: 'Smith, J.' },
                { inputs: ['mary jones'], expected: 'Jones, M.' },
                { inputs: ['david brown'], expected: 'Brown, D.' },
                { inputs: ['susan davis'], expected: 'Davis, S.' }
            ];
            
            const resultsDiv = document.getElementById('task3-tests');
            resultsDiv.innerHTML = '';
            
            let allPassed = true;
            
            for (let i = 0; i < testCases.length; i++) {
                const testCase = testCases[i];
                const result = await runTestCase(code, testCase.inputs, testCase.expected);
                
                const testDiv = document.createElement('div');
                testDiv.className = `test-case ${result.passed ? 'passed' : 'failed'}`;
                testDiv.innerHTML = `
                    <strong>Test ${i + 1}:</strong> Input: "${testCase.inputs[0]}"<br>
                    Expected: "${testCase.expected}"<br>
                    Got: "${result.output.trim()}"<br>
                    ${result.passed ? '✅ Passed' : '❌ Failed'}
                `;
                resultsDiv.appendChild(testDiv);
                
                if (!result.passed) allPassed = false;
            }
            
            if (allPassed) {
                addXP(50, 'task3-tests');
                showAchievement('All Name Formatter Tests Passed! 🏅');
            }
        }

        // Initialize Skulpt on page load
        window.addEventListener('load', async () => {
            // Start loading Skulpt in the background
            loadSkulptWithFallbacks();
        });
    </script>
</body>
</html>