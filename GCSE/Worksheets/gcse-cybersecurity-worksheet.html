<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GCSE CS Worksheet: Security Threats</title>
    
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <!-- Google Fonts: Inter for general use, OpenDyslexic for accessibility -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=OpenDyslexic:wght@400;700&display=swap" rel="stylesheet">

    <!-- Custom Styles & Overrides -->
    <style>
        /* Base styling using a modern font */
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }

        /* Accessibility: Dyslexia-friendly font toggle */
        body.dyslexia-font {
            font-family: 'OpenDyslexic', sans-serif;
        }

        /* High Contrast Mode Toggle */
        body.high-contrast {
            @apply bg-black text-white;
        }
        body.high-contrast header, 
        body.high-contrast .task-container,
        body.high-contrast .feedback-modal-content {
            @apply bg-gray-900 border-white;
        }
        body.high-contrast button, body.high-contrast .btn {
            @apply bg-yellow-300 text-black;
        }
        body.high-contrast .nav-btn.active {
            @apply bg-yellow-400 text-black ring-2 ring-white;
        }
        body.high-contrast input, body.high-contrast textarea, body.high-contrast select {
             @apply bg-gray-800 border-gray-500 text-white;
        }
        body.high-contrast .brute-force-sim-body {
            @apply bg-black;
        }

        /* Custom animation for achievement popups */
        @keyframes slide-in-out {
            0%, 100% { transform: translateX(100%); opacity: 0; }
            10%, 90% { transform: translateX(0); opacity: 1; }
        }
        .achievement-popup-animate {
            animation: slide-in-out 4s ease-in-out forwards;
        }

        /* Custom animation for page content fade-in */
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .page-content-animate {
            animation: fade-in 0.5s ease-out;
        }
        
        /* Drag & Drop Styling */
        .drop-zone.over {
            @apply ring-2 ring-blue-500 bg-blue-100;
        }
        .draggable.dragging {
            @apply opacity-50 shadow-2xl;
        }

        /* Writing Scorer styles based on spec */
        .scoreCircle { @apply w-24 h-24 rounded-full flex justify-center items-center border-4; }
        .scoreValue { @apply text-4xl font-bold; }
        .successList li::before { content: '‚úîÔ∏è'; @apply mr-2; }
        .improvementList li::before { content: '‚ùå'; @apply mr-2; }
        .improvementList li.suggestion::before { content: 'üí°'; }
        
        /* ### NEW BRUTE FORCE SIMULATOR STYLES ### */
        .brute-force-sim-body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
            background-color: #111827; 
            color: white;
            padding: 1.5rem; 
            border-radius: 0.5rem; 
            margin-top: 1rem;
        }
        .brute-force-sim-log-entry { animation: bruteForceFadeInLog 0.3s ease-out; }
        @keyframes bruteForceFadeInLog {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        #bruteForceAdv_eventLog::-webkit-scrollbar { width: 8px; }
        #bruteForceAdv_eventLog::-webkit-scrollbar-track { background: #1f2937; } 
        #bruteForceAdv_eventLog::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; } 
        .brute-force-sim-info-box h3 { color: #fbbf24; } 
        .brute-force-target-system {
            transition: border-color 0.5s ease, box-shadow 0.5s ease;
        }
        .brute-force-target-locked {
            border-color: #ef4444; 
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.5);
        }
        .brute-force-target-unlocked {
            border-color: #22c55e; 
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.5);
        }
        .brute-force-target-lockout { 
            border-color: #f97316; 
            box-shadow: 0 0 15px rgba(249, 115, 22, 0.6);
        }
        .brute-force-attempt-display {
            min-height: 2.5em; 
            font-family: 'Courier New', Courier, monospace;
            word-break: break-all;
        }
        .brute-force-sim-body input[type="text"]:disabled, 
        .brute-force-sim-body input[type="number"]:disabled, 
        .brute-force-sim-body select:disabled, 
        .brute-force-sim-body input[type="checkbox"]:disabled + span {
            opacity: 0.7;
            cursor: not-allowed;
        }
        .brute-force-sim-body input[type="checkbox"]:disabled {
            cursor: not-allowed;
        }
        .brute-force-sim-body button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .brute-force-mode-button {
            transition: all 0.2s ease-in-out;
        }
        .brute-force-mode-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Header: Contains navigation, user stats, and accessibility controls -->
    <header class="bg-white border-b border-gray-200 p-4 shadow-md sticky top-0 z-50">
        <div class="max-w-5xl mx-auto flex justify-between items-center flex-wrap gap-4">
            <h1 class="text-2xl font-bold text-blue-800">Cybersecurity Threats</h1>
            <div id="user-stats" class="flex items-center gap-4">
                <div class="text-sm font-medium">Level: <span id="level-display" class="font-bold text-lg">1</span></div>
                <div class="text-sm font-medium">XP: <span id="xp-display" class="font-bold text-lg">0</span></div>
                <div class="w-24 h-2.5 bg-gray-200 rounded-full overflow-hidden">
                    <div id="xp-bar" class="h-full bg-green-500 transition-all duration-500" style="width: 0%;"></div>
                </div>
            </div>
            <div id="accessibility-controls" class="flex items-center gap-2">
                <button id="font-size-decrease" class="p-2 bg-gray-200 rounded-md hover:bg-gray-300" aria-label="Decrease font size">A-</button>
                <button id="font-size-increase" class="p-2 bg-gray-200 rounded-md hover:bg-gray-300" aria-label="Increase font size">A+</button>
                <button id="contrast-toggle" class="p-2 bg-gray-200 rounded-md hover:bg-gray-300" aria-label="Toggle high contrast mode">Contrast</button>
                <button id="dyslexia-toggle" class="p-2 bg-gray-200 rounded-md hover:bg-gray-300" aria-label="Toggle dyslexia-friendly font">Dyslexic</button>
            </div>
        </div>
        <nav id="quick-nav" class="max-w-5xl mx-auto mt-4 pt-4 border-t border-gray-200 flex flex-wrap gap-2">
            <!-- Quick navigation buttons are inserted here by JavaScript -->
        </nav>
    </header>

    <!-- Main Content Area: Pages are injected here -->
    <main id="content-container" class="p-4 md:p-8 max-w-5xl mx-auto w-full">
        <!-- JS will render page content here -->
    </main>

    <!-- Footer: Main navigation arrows -->
    <footer class="bg-white border-t border-gray-200 p-4 shadow-inner">
        <div class="max-w-5xl mx-auto flex justify-between items-center">
            <button id="prev-btn" class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed">‚óÑ Previous</button>
            <button id="next-btn" class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed">Next ‚ñ∫</button>
        </div>
    </footer>

    <!-- Popups & Modals -->
    <div id="achievement-popup" class="fixed top-8 right-0 bg-green-500 text-white p-4 rounded-l-lg shadow-xl hidden z-50">
        <h3 class="font-bold text-lg">Achievement Unlocked!</h3>
        <p id="achievement-title"></p>
    </div>
    <div id="paste-shame-popup" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-red-600 text-white p-6 rounded-lg shadow-2xl text-center hidden z-50">
        <p class="font-bold">Pasting is disabled.</p>
        <p>Please type your answer to encourage your own thinking.</p>
    </div>
    <div id="feedback-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="feedback-modal-content bg-white p-6 rounded-lg shadow-xl max-w-md w-full">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Submit Feedback</h3>
                <button id="close-feedback" class="text-2xl">&times;</button>
            </div>
            <p class="text-sm mb-4">Your feedback will help improve this worksheet. Please be as detailed as possible.</p>
            <textarea id="feedback-textarea" rows="6" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Describe the issue or your suggestion..."></textarea>
            <button id="send-feedback-btn" class="w-full mt-4 px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700">Send Feedback</button>
        </div>
    </div>
    <button id="feedback-btn" class="fixed bottom-6 right-6 w-14 h-14 bg-blue-600 text-white text-2xl font-bold rounded-full shadow-lg hover:bg-blue-700 z-40" aria-label="Open feedback form">?</button>

    <!-- #################### PAGE TEMPLATES #################### -->
    <!-- These templates hold the HTML for each section. JS clones them into the main content area. -->

    <template id="template-0">
        <div class="task-container bg-white p-8 rounded-lg shadow-lg">
            <h2 class="text-3xl font-bold mb-4 text-blue-800">Welcome & Learning Outcomes</h2>
            <p class="mb-4">In this lesson, you will explore two common but dangerous cybersecurity threats. By the end, you will be able to:</p>
            <ul class="list-disc list-inside space-y-2 mb-6">
                <li>Define 'brute force attack' and 'social engineering'.</li>
                <li>Explain how a brute force attack works and what makes a password strong.</li>
                <li>Identify the tell-tale signs of a phishing email.</li>
                <li>Describe ways to protect yourself from these attacks.</li>
            </ul>
            <hr class="my-6">
            <h3 class="text-2xl font-bold mb-3">Starter Activity</h3>
            <p class="mb-3">Without searching online, what do you think are the biggest threats on the internet? List as many as you can in the box below and briefly explain what each one means.</p>
            <textarea id="starter-input" rows="8" class="w-full p-2 border border-gray-300 rounded-md"></textarea>
            <div class="flex items-center gap-4 mt-4">
                <button id="starter-submit" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700">Submit Answer</button>
                <p class="text-sm font-medium">XP Earned: <span id="starter-xp" class="font-bold">0</span></p>
                <button id="starter-reset" class="ml-auto px-4 py-2 bg-yellow-500 text-white font-semibold rounded-lg hover:bg-yellow-600">Reset</button>
            </div>
        </div>
    </template>

    <template id="template-1">
        <div class="task-container bg-white p-8 rounded-lg shadow-lg">
            <h2 class="text-3xl font-bold mb-4 text-blue-800">Task 1: Brute Force Attacks</h2>
            <p class="mb-4">A <strong>brute force attack</strong> is a trial-and-error method where software tries to guess information like a password. It systematically checks all possible combinations until the correct one is found. The interactive simulator below demonstrates how this works and how defenses like account lockouts can stop an attack.</p>
            
            <!-- ### NEW BRUTE FORCE SIMULATOR HTML ### -->
            <div class="brute-force-sim-body mt-4">
                <div id="bruteForceAdv_modeSelectionScreen" class="text-center p-4 md:p-8 bg-gray-800 rounded-lg shadow-xl">
                    <h3 class="text-xl md:text-2xl font-semibold text-amber-300 mb-6">Brute Force Attack Simulator: Choose Mode</h3>
                    <div class="flex flex-col sm:flex-row justify-center gap-4">
                        <button id="bruteForceAdv_selectSimpleModeBtn" class="brute-force-mode-button bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md text-lg">
                            <i class="fas fa-mouse-pointer mr-2"></i>Simple Mode
                            <p class="text-xs font-normal mt-1">(Quick 3-letter lowercase demo)</p>
                        </button>
                        <button id="bruteForceAdv_selectAdvancedModeBtn" class="brute-force-mode-button bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg shadow-md text-lg">
                            <i class="fas fa-cogs mr-2"></i>Advanced Mode
                            <p class="text-xs font-normal mt-1">(Configure password & defenses)</p>
                        </button>
                    </div>
                </div>
        
                <div id="bruteForceAdv_simulatorInterface" class="hidden">
                    <p id="bruteForceAdv_modeDisplay" class="text-center text-amber-300 font-semibold mb-4"></p>
                    
                    <div id="bruteForceAdv_simpleModeConfig" class="bg-gray-800 p-6 rounded-lg shadow-xl mb-6 hidden">
                        <h4 class="text-xl font-semibold mb-3 text-blue-300">Set Target Password (Simple Mode)</h4>
                        <div class="flex items-center space-x-3">
                            <input type="text" id="bruteForceAdv_simpleUserPasswordInput" maxlength="3" placeholder="e.g. abc" class="flex-grow p-2 rounded-md bg-gray-700 border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-white">
                            <button id="bruteForceAdv_simpleSetPasswordBtn" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition-colors shadow-md">
                                Set Password
                            </button>
                        </div>
                        <p id="bruteForceAdv_simplePasswordValidationError" class="text-red-400 text-xs mt-2 h-4"></p>
                    </div>
        
                    <div id="bruteForceAdv_advancedModeConfig" class="bg-gray-800 p-6 rounded-lg shadow-xl mb-6 hidden">
                        <h4 class="text-xl font-semibold mb-3 text-purple-300">Configure Attack (Advanced Mode)</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="bruteForceAdv_advPasswordLength" class="block text-sm font-medium text-gray-300 mb-1">Password Length (1-6):</label>
                                <input type="number" id="bruteForceAdv_advPasswordLength" min="1" max="6" value="3" class="w-full p-2 rounded-md bg-gray-700 border border-gray-600 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none text-white">
                                <label for="bruteForceAdv_advPasswordInput" class="block text-sm font-medium text-gray-300 mt-3 mb-1">Target Password:</label>
                                <input type="text" id="bruteForceAdv_advPasswordInput" placeholder="Set password" class="w-full p-2 rounded-md bg-gray-700 border border-gray-600 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none text-white">
                                <p class="text-xs text-gray-500 mt-1">Must match selected length & charsets.</p>
                            </div>
                            <div>
                                <p class="block text-sm font-medium text-gray-300 mb-2">Character Sets:</p>
                                <div class="space-y-2">
                                    <label class="flex items-center"><input type="checkbox" id="bruteForceAdv_charLowercase" class="form-checkbox h-5 w-5 text-purple-600 rounded mr-2" checked> <span class="text-gray-200">Lowercase (a-z)</span></label>
                                    <label class="flex items-center"><input type="checkbox" id="bruteForceAdv_charUppercase" class="form-checkbox h-5 w-5 text-purple-600 rounded mr-2"> <span class="text-gray-200">Uppercase (A-Z)</span></label>
                                    <label class="flex items-center"><input type="checkbox" id="bruteForceAdv_charNumbers" class="form-checkbox h-5 w-5 text-purple-600 rounded mr-2"> <span class="text-gray-200">Numbers (0-9)</span></label>
                                    <label class="flex items-center"><input type="checkbox" id="bruteForceAdv_charSymbols" class="form-checkbox h-5 w-5 text-purple-600 rounded mr-2"> <span class="text-gray-200">Symbols (!@#$...)</span></label>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4">
                            <label for="bruteForceAdv_attackSpeed" class="block text-sm font-medium text-gray-300 mb-1">Attack Speed:</label>
                            <select id="bruteForceAdv_attackSpeed" class="w-full p-2 rounded-md bg-gray-700 border border-gray-600 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none text-white">
                                <option value="normal">Normal</option>
                                <option value="fast">Fast</option>
                                <option value="very_fast">Very Fast</option>
                            </select>
                        </div>
                         <div class="mt-4">
                            <p class="block text-sm font-medium text-gray-300 mb-1">Estimated Time to Crack:</p>
                            <p id="bruteForceAdv_estimatedTimeText" class="text-lg text-amber-400 font-semibold">-</p>
                        </div>
                        <div class="mt-4 border-t border-gray-700 pt-4">
                             <label class="flex items-center">
                                <input type="checkbox" id="bruteForceAdv_enableAccountLockout" class="form-checkbox h-5 w-5 text-purple-600 rounded mr-2"> <span class="text-gray-200">Enable Account Lockout</span>
                            </label>
                            <div id="bruteForceAdv_accountLockoutOptions" class="ml-7 mt-2 hidden">
                                <label for="bruteForceAdv_lockoutAttemptsInput" class="text-sm text-gray-400">Lockout after 
                                <input type="number" id="bruteForceAdv_lockoutAttemptsInput" value="100" min="1" class="w-20 p-1 rounded-md bg-gray-700 border border-gray-600 text-sm mx-1 text-white"> attempts.</label>
                            </div>
                        </div>
                        <button id="bruteForceAdv_advSetupAttackBtn" class="mt-6 w-full bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition-colors shadow-md">
                            Prepare Attack
                        </button>
                         <p id="bruteForceAdv_advConfigError" class="text-red-400 text-xs mt-2 h-4"></p>
                    </div>
        
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div class="md:col-span-1 bg-gray-800 p-6 rounded-lg shadow-xl flex flex-col items-center justify-center brute-force-target-system brute-force-target-locked">
                            <i id="bruteForceAdv_lockIcon" class="fas fa-lock text-6xl text-red-400 mb-4 transition-colors duration-500"></i>
                            <p id="bruteForceAdv_systemStatus" class="text-xl font-semibold text-red-400 transition-colors duration-500">SYSTEM LOCKED</p>
                            <p class="text-xs text-gray-500 mt-1">Target: <span id="bruteForceAdv_targetPasswordDisplay" class="font-mono">***</span></p>
                        </div>
        
                        <div class="md:col-span-2 bg-gray-800 p-6 rounded-lg shadow-xl">
                            <h4 class="text-xl font-semibold mb-3 text-amber-300">Attack Monitor</h4>
                            <div class="mb-3">
                                <p class="text-sm text-gray-400">Current Attempt:</p>
                                <p id="bruteForceAdv_currentAttemptText" class="text-2xl text-yellow-400 brute-force-attempt-display">-</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-400">Attempts Made:</p>
                                <p id="bruteForceAdv_attemptsCountText" class="text-2xl text-yellow-400">0</p>
                            </div>
                             <div class="mt-6 flex space-x-3">
                                <button id="bruteForceAdv_startAttackBtn" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg transition-colors shadow-md" disabled>
                                    <i class="fas fa-play mr-2"></i>Start Attack
                                </button>
                                <button id="bruteForceAdv_resetSimulationBtn" class="flex-1 bg-sky-600 hover:bg-sky-700 text-white font-medium py-2 px-4 rounded-lg transition-colors shadow-md" disabled>
                                    <i class="fas fa-undo mr-2"></i>Reset
                                </button>
                            </div>
                        </div>
                    </div>
        
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="md:col-span-2 bg-gray-800 p-4 rounded-lg shadow-xl">
                            <h4 class="text-xl font-semibold mb-3 text-amber-300 border-b border-gray-700 pb-2">Event Log</h4>
                            <div id="bruteForceAdv_eventLog" class="h-48 overflow-y-auto space-y-1 text-xs pr-2">
                                <!-- Brute force log entries -->
                            </div>
                        </div>
                        <div class="md:col-span-1 bg-gray-800 p-4 rounded-lg shadow-xl brute-force-sim-info-box">
                            <h3 class="text-lg font-semibold mb-2 border-b border-gray-700 pb-1"><i class="fas fa-info-circle mr-1"></i>What is This?</h3>
                            <p id="bruteForceAdv_infoBoxText" class="text-xs text-gray-300 leading-relaxed">
                                A <strong class="text-amber-300">brute-force attack</strong> tries many passwords hoping to eventually guess correctly.
                            </p>
                        </div>
                    </div>
                    <button id="bruteForceAdv_backToModeSelectionBtn" class="mt-6 bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-lg transition-colors shadow-md w-full md:w-auto">
                        <i class="fas fa-arrow-left mr-2"></i>Back to Mode Selection
                    </button>
                </div>
            </div>
        </div>
    </template>
    
    <template id="template-2">
        <div class="task-container bg-white p-8 rounded-lg shadow-lg">
            <h2 class="text-3xl font-bold mb-4 text-blue-800">Task 2: Brute Force with Smarts</h2>
            <p class="mb-4">Attackers often use logic and context to make their dictionary attacks more effective.</p>
    
            <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-500 mb-6">
                <h4 class="font-bold mb-2">Did you know?</h4>
                <ul>
                    <li>PINs starting with '19' or '20' are popular because people use years of birth.</li>
                    <li>'2580' is common because it's a straight line down a phone keypad.</li>
                </ul>
            </div>
    
            <h3 class="text-2xl font-bold mb-3">Contextual Passwords Quiz</h3>
            <p class="mb-4">What might be a common password guess for the following targets?</p>
            <div id="context-quiz" class="space-y-4"></div>
            <div class="flex items-center gap-4 mt-6">
                <button id="context-submit" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700">Check Answers</button>
                <p id="context-feedback" class="font-medium"></p>
                <button id="smarts-reset" class="ml-auto px-4 py-2 bg-yellow-500 text-white font-semibold rounded-lg hover:bg-yellow-600">Reset</button>
            </div>
    
            <hr class="my-8">
    
            <h3 class="text-2xl font-bold mb-3">External Quiz</h3>
            <p class="mb-3">Test your knowledge further with this password security quiz.</p>
            <a href="https://view.ceros.com/fidelity-interactive/password-security-quiz/p/1" target="_blank" class="inline-block px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700">Take the Fidelity Password Quiz</a>
        </div>
    </template>
    
    <template id="template-3">
        <div class="task-container bg-white p-8 rounded-lg shadow-lg">
            <h2 class="text-3xl font-bold mb-4 text-blue-800">Task 3: Social Engineering</h2>
            <p class="mb-4"><strong>Social engineering</strong> is the art of manipulating people to give up confidential information. It relies on human psychology rather than technical hacking.</p>
    
            <h3 class="text-2xl font-bold mb-3">Match the Threat to its Definition</h3>
            <p class="mb-4">Drag the terms on the left into the correct definition boxes on the right.</p>
    
            <div class="flex flex-col md:flex-row gap-8">
                <div id="draggable-items" class="md:w-1/3 flex flex-col gap-3"></div>
                <div id="drop-zones-container" class="md:w-2/3 space-y-4"></div>
            </div>
            <div class="flex items-center gap-4 mt-6">
                <div id="matching-feedback" class="font-bold text-lg"></div>
                <button id="matching-reset" class="ml-auto px-4 py-2 bg-yellow-500 text-white font-semibold rounded-lg hover:bg-yellow-600">Reset</button>
            </div>
        </div>
    </template>

    <template id="template-4">
        <div class="task-container bg-white p-8 rounded-lg shadow-lg">
            <h2 class="text-3xl font-bold mb-4 text-blue-800">Task 4: Phishing Simulator</h2>
            <p class="mb-4">Now that you know the theory behind phishing, it's time to put your skills to the test in a real-world scenario. The following link will take you to a phishing simulator page. Your goal is to see if you can spot the fake website.</p>
            <p class="mb-6">Pay close attention to the URL, the content on the page, and any requests for information.</p>
            <a href="gcse-sec-threats-phishing.html" target="_blank" class="inline-block px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700">
                <i class="fas fa-fish mr-2"></i>Launch Phishing Simulator
            </a>
        </div>
    </template>

    <template id="template-5">
        <div class="task-container bg-white p-8 rounded-lg shadow-lg">
            <h2 class="text-3xl font-bold mb-4 text-blue-800">Exam Style Questions</h2>
            <p class="mb-6">Apply your knowledge to answer the following questions. Write in full sentences. Your answer will be checked for structure and key terms.</p>
    
            <div class="border-t pt-6 mb-8">
                <h4 class="font-bold text-lg">Question 1</h4>
                <p class="my-2">A software company has been targeted by a cyber attacker attempting to gain unauthorized access using a brute force attack with a dictionary of common passwords.</p>
                <p class="font-semibold mb-2">(a) Explain what a brute force attack is. [2]</p>
                <div id="writingScorer1" class="writingScorer p-4 border rounded-lg bg-gray-50"></div>
                <div class="mt-2 text-right">
                    <button class="mark-scheme-toggle px-4 py-2 bg-gray-200 text-sm rounded-md hover:bg-gray-300" data-target="mark-scheme-1">Show/Hide Mark Scheme</button>
                </div>
                <div id="mark-scheme-1" class="mark-scheme hidden mt-2 p-4 bg-gray-100 rounded-md text-sm">
                    <h5 class="font-bold">Mark Scheme (a)</h5>
                    <ul class="list-disc list-inside mt-1">
                        <li>An attempt to gain access to a system/data. (1)</li>
                        <li>By trying every possible combination/password/key until successful. (1)</li>
                    </ul>
                </div>
            </div>
    
            <div class="border-t pt-6">
                <p class="font-semibold mb-2">(b) Describe two security measures the company can implement to defend against brute force attacks. [4]</p>
                <div id="writingScorer2" class="writingScorer p-4 border rounded-lg bg-gray-50"></div>
                <div class="mt-2 text-right">
                    <button class="mark-scheme-toggle px-4 py-2 bg-gray-200 text-sm rounded-md hover:bg-gray-300" data-target="mark-scheme-2">Show/Hide Mark Scheme</button>
                </div>
                <div id="mark-scheme-2" class="mark-scheme hidden mt-2 p-4 bg-gray-100 rounded-md text-sm">
                    <h5 class="font-bold">Mark Scheme (b)</h5>
                    <p>Award one mark for identifying a measure and one for a linked description (x2).</p>
                    <ul class="list-disc list-inside mt-1 space-y-1">
                        <li><strong>Account Lockout:</strong> After a set number of failed attempts, the account is locked.</li>
                        <li><strong>CAPTCHA:</strong> Requires a test that is difficult for automated scripts to solve.</li>
                        <li><strong>Strong Password Policy:</strong> Enforcing length/complexity makes guessing infeasible.</li>
                    </ul>
                </div>
            </div>
             <div class="flex justify-end mt-6">
                <button id="exam-reset" class="px-4 py-2 bg-yellow-500 text-white font-semibold rounded-lg hover:bg-yellow-600">Reset Questions</button>
            </div>
        </div>
    </template>
    
    <template id="template-6">
        <div class="task-container bg-white p-8 rounded-lg shadow-lg">
            <h2 class="text-3xl font-bold mb-4 text-blue-800">Lesson Summary & Quiz</h2>
            <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-500 mb-6">
                <h3 class="font-bold text-lg mb-2">Key Takeaways</h3>
                <ul class="list-disc list-inside space-y-1">
                    <li>A <strong>Brute Force Attack</strong> tries every password combination. Defend with account lockouts, CAPTCHA, and strong passwords.</li>
                    <li><strong>Social Engineering</strong> tricks people into revealing information. <strong>Phishing</strong> uses fake emails to do this.</li>
                    <li>To spot phishing, check the sender address, greeting, tone of urgency, links, and for spelling/grammar errors.</li>
                </ul>
            </div>
            
            <hr class="my-6">
            <h3 class="text-2xl font-bold mb-3">Check Your Understanding</h3>
            <div id="final-quiz" class="space-y-4"></div>
            <div class="flex items-center gap-4 mt-6">
                <button id="quiz-submit" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700">Submit Quiz</button>
                <div id="quiz-results" class="font-bold text-lg"></div>
                <button id="quiz-reset" class="ml-auto px-4 py-2 bg-yellow-500 text-white font-semibold rounded-lg hover:bg-yellow-600">Reset Quiz</button>
            </div>
        </div>
    </template>

    <template id="template-7">
        <div class="task-container bg-white p-8 rounded-lg shadow-lg">
            <h2 class="text-3xl font-bold mb-4 text-blue-800">Extension & Achievements</h2>
            
            <h3 class="text-2xl font-bold mb-3">Extension Task: Other Social Engineering</h3>
            <p class="mb-4">Research <strong>ONE</strong> of the following: Pretexting, Baiting, Quid Pro Quo, or Tailgating. In the box below, explain how it works and give an example.</p>
            <textarea id="extension-answer" rows="5" class="w-full p-2 border border-gray-300 rounded-md"></textarea>
            <button id="extension-submit" class="mt-2 px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700">Submit for XP</button>
            
            <hr class="my-8">

            <h3 class="text-2xl font-bold mb-3">Further Practice: Phishing Quizzes</h3>
             <p class="mb-4">Test your skills with these excellent real-world phishing simulators. Remember the key checks:</p>
            <ul class="list-disc list-inside space-y-2 mb-4 bg-blue-50 p-4 rounded-lg border-l-4 border-blue-500">
                <li><strong>Sender Address:</strong> Does it look legitimate?</li>
                <li><strong>Generic Greeting:</strong> Does it say "Dear Customer"?</li>
                <li><strong>Urgency & Threats:</strong> Does it create a sense of panic?</li>
            </ul>
            <div class="flex gap-4">
                <a href="https://phishingquiz.withgoogle.com/" target="_blank" class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700">Take Google's Phishing Quiz</a>
                <a href="https://www.phishingbox.com/phishing-iq-test/quiz.php?reset=1" target="_blank" class="px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700">Take the PhishingBox IQ Test</a>
            </div>

            <hr class="my-8">

            <h3 class="text-2xl font-bold mb-3">Achievements</h3>
            <p class="mb-4">Track your progress and unlocked achievements here.</p>
            <ul id="achievements-list" class="space-y-2"></ul>
        </div>
    </template>

    <!-- #################### JAVASCRIPT #################### -->
    <script>
    // Self-executing function to encapsulate all logic and avoid polluting the global scope
    (() => {
        // ### BRUTE FORCE ADVANCED SIMULATOR SCRIPT (bruteForceAdv_ prefix) ###
        let bruteForceAdv_TARGET_PASSWORD = ""; 
        let bruteForceAdv_CURRENT_CHARSET_STRING = "";
        const bruteForceAdv_BASE_CHARSETS = {
            lowercase: "abcdefghijklmnopqrstuvwxyz",
            uppercase: "ABCDEFGHIJKLMNOPQRSTUVWXYZ",
            numbers: "0123456789",
            symbols: "!@#$%^&*()-=_+[]{}|;:',.<>/?" 
        };
        let bruteForceAdv_PASSWORD_LENGTH = 3; 
        let bruteForceAdv_SIMULATION_MODE = 'simple'; 
        let bruteForceAdv_CURRENT_ATTACK_SPEED = 'normal';
        let bruteForceAdv_accountLockoutEnabled = false;
        let bruteForceAdv_lockoutAfterAttempts = 100; 
        let bruteForceAdv_currentGeneratedPassword = "";
        let bruteForceAdv_attemptsCount = 0;
        let bruteForceAdv_isAttackRunning = false;
        let bruteForceAdv_passwordFound = false;
        let bruteForceAdv_attackLoopId = null; 
        let bruteForceAdv_lastLogTime = 0;
        let bruteForceAdv_isPasswordSet = false;

        function bruteForceAdv_logEvent(message, type = 'info') {
            const eventLog = document.getElementById('bruteForceAdv_eventLog');
            if (!eventLog) return;
            const logEntry = document.createElement('p');
            logEntry.textContent = `[${new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit',second:'2-digit'})}] ${message}`;
            logEntry.classList.add('brute-force-sim-log-entry'); // Use specific class for this sim's log
            if (type === 'success') logEntry.classList.add('text-green-400');
            else if (type === 'failure') logEntry.classList.add('text-red-400');
            else if (type === 'emphasis') logEntry.classList.add('text-amber-300', 'font-semibold');
            else if (type === 'lockout') logEntry.classList.add('text-orange-400', 'font-semibold');
            else logEntry.classList.add('text-gray-400');
            
            eventLog.insertBefore(logEntry, eventLog.firstChild);
            if (eventLog.children.length > 150) { // MAX_LOG_ENTRIES
                eventLog.removeChild(eventLog.lastChild);
            }
        }

        function bruteForceAdv_updateSystemVisualState() {
            const targetSystemDiv = document.querySelector('#bruteForceAdv_simulatorInterface .brute-force-target-system');
            const lockIcon = document.getElementById('bruteForceAdv_lockIcon');
            const systemStatus = document.getElementById('bruteForceAdv_systemStatus');
            if (!targetSystemDiv || !lockIcon || !systemStatus) return;

            if (bruteForceAdv_passwordFound) {
                targetSystemDiv.classList.remove('brute-force-target-locked', 'brute-force-target-lockout');
                targetSystemDiv.classList.add('brute-force-target-unlocked');
                lockIcon.className = 'fas fa-lock-open text-6xl text-green-400 mb-4 transition-colors duration-500';
                systemStatus.textContent = "SYSTEM UNLOCKED";
                systemStatus.classList.remove('text-red-400', 'text-orange-400');
                systemStatus.classList.add('text-green-400');
            } else if (bruteForceAdv_accountLockoutEnabled && bruteForceAdv_attemptsCount >= bruteForceAdv_lockoutAfterAttempts && bruteForceAdv_isAttackRunning) { 
                targetSystemDiv.classList.remove('brute-force-target-locked', 'brute-force-target-unlocked');
                targetSystemDiv.classList.add('brute-force-target-lockout');
                lockIcon.className = 'fas fa-user-lock text-6xl text-orange-400 mb-4 transition-colors duration-500';
                systemStatus.textContent = "ACCOUNT LOCKED";
                systemStatus.classList.remove('text-red-400', 'text-green-400');
                systemStatus.classList.add('text-orange-400');
            } else { 
                targetSystemDiv.classList.remove('brute-force-target-unlocked', 'brute-force-target-lockout');
                targetSystemDiv.classList.add('brute-force-target-locked');
                lockIcon.className = 'fas fa-lock text-6xl text-red-400 mb-4 transition-colors duration-500';
                systemStatus.textContent = "SYSTEM LOCKED";
                systemStatus.classList.remove('text-green-400', 'text-orange-400');
                systemStatus.classList.add('text-red-400');
            }
        }

        function bruteForceAdv_updateAttackMonitorDisplay() {
            const currentAttemptText = document.getElementById('bruteForceAdv_currentAttemptText');
            const attemptsCountText = document.getElementById('bruteForceAdv_attemptsCountText');
            if (currentAttemptText) currentAttemptText.textContent = bruteForceAdv_currentGeneratedPassword || "-";
            if (attemptsCountText) attemptsCountText.textContent = bruteForceAdv_attemptsCount.toLocaleString();
        }

        function bruteForceAdv_generateNextPasswordAdvanced(current) {
            if (bruteForceAdv_CURRENT_CHARSET_STRING.length === 0) return null; 

            if (current === "") { 
                return bruteForceAdv_CURRENT_CHARSET_STRING[0].repeat(bruteForceAdv_PASSWORD_LENGTH);
            }

            let passArray = current.split('');
            let i = bruteForceAdv_PASSWORD_LENGTH - 1; 

            while (i >= 0) {
                const charIndex = bruteForceAdv_CURRENT_CHARSET_STRING.indexOf(passArray[i]);
                if (charIndex === bruteForceAdv_CURRENT_CHARSET_STRING.length - 1) { 
                    passArray[i] = bruteForceAdv_CURRENT_CHARSET_STRING[0]; 
                    i--; 
                } else {
                    passArray[i] = bruteForceAdv_CURRENT_CHARSET_STRING[charIndex + 1]; 
                    return passArray.join(''); 
                }
            }
            return null; 
        }

        function bruteForceAdv_getBatchSize() {
            if (bruteForceAdv_SIMULATION_MODE === 'simple') return 100;
            switch (bruteForceAdv_CURRENT_ATTACK_SPEED) {
                case 'fast': return 1000;
                case 'very_fast': return 5000;
                case 'normal':
                default: return 300;
            }
        }

        function bruteForceAdv_attackStep() {
            const startAttackBtn = document.getElementById('bruteForceAdv_startAttackBtn');
            const resetSimulationBtn = document.getElementById('bruteForceAdv_resetSimulationBtn');

            if (!bruteForceAdv_isAttackRunning || bruteForceAdv_passwordFound) {
                if (bruteForceAdv_attackLoopId) cancelAnimationFrame(bruteForceAdv_attackLoopId);
                bruteForceAdv_isAttackRunning = false;
                if(startAttackBtn) startAttackBtn.disabled = bruteForceAdv_passwordFound || (bruteForceAdv_accountLockoutEnabled && bruteForceAdv_attemptsCount >= bruteForceAdv_lockoutAfterAttempts);
                if(resetSimulationBtn) resetSimulationBtn.disabled = false;
                return;
            }

            if (bruteForceAdv_accountLockoutEnabled && bruteForceAdv_attemptsCount >= bruteForceAdv_lockoutAfterAttempts) {
                bruteForceAdv_isAttackRunning = false;
                bruteForceAdv_logEvent(`ACCOUNT LOCKED OUT after ${bruteForceAdv_attemptsCount.toLocaleString()} failed attempts.`, 'lockout');
                bruteForceAdv_updateSystemVisualState();
                bruteForceAdv_updateAttackMonitorDisplay();
                if (bruteForceAdv_attackLoopId) cancelAnimationFrame(bruteForceAdv_attackLoopId);
                if(startAttackBtn) startAttackBtn.disabled = true;
                if(resetSimulationBtn) resetSimulationBtn.disabled = false;
                return;
            }

            const batchSize = bruteForceAdv_getBatchSize();
            for(let j=0; j<batchSize; j++) {
                if (bruteForceAdv_passwordFound || (bruteForceAdv_accountLockoutEnabled && bruteForceAdv_attemptsCount >= bruteForceAdv_lockoutAfterAttempts)) break;

                bruteForceAdv_currentGeneratedPassword = bruteForceAdv_generateNextPasswordAdvanced(bruteForceAdv_currentGeneratedPassword);
                
                if (bruteForceAdv_currentGeneratedPassword === null) {
                    bruteForceAdv_logEvent(`Attack stopped: All ${bruteForceAdv_PASSWORD_LENGTH}-character combinations tried. Password not found.`, 'failure');
                    bruteForceAdv_isAttackRunning = false;
                    if (bruteForceAdv_attackLoopId) cancelAnimationFrame(bruteForceAdv_attackLoopId);
                    if(startAttackBtn) startAttackBtn.disabled = true; 
                    if(resetSimulationBtn) resetSimulationBtn.disabled = false;
                    break; 
                }
                bruteForceAdv_attemptsCount++;

                if (bruteForceAdv_currentGeneratedPassword === bruteForceAdv_TARGET_PASSWORD) {
                    bruteForceAdv_passwordFound = true;
                    bruteForceAdv_isAttackRunning = false; 
                    bruteForceAdv_logEvent(`SUCCESS! Password '${bruteForceAdv_TARGET_PASSWORD}' found after ${bruteForceAdv_attemptsCount.toLocaleString()} attempts.`, 'success');
                    if (bruteForceAdv_attackLoopId) cancelAnimationFrame(bruteForceAdv_attackLoopId);
                    if(startAttackBtn) startAttackBtn.disabled = true;
                    if(resetSimulationBtn) resetSimulationBtn.disabled = false;
                    break; 
                }
            }
            
            bruteForceAdv_updateAttackMonitorDisplay();
            bruteForceAdv_updateSystemVisualState();

            const now = performance.now();
            if (now - bruteForceAdv_lastLogTime > 100 && !bruteForceAdv_passwordFound && bruteForceAdv_isAttackRunning) { 
                bruteForceAdv_logEvent(`Attempt #${bruteForceAdv_attemptsCount.toLocaleString()}: Trying '${bruteForceAdv_currentGeneratedPassword}'`);
                bruteForceAdv_lastLogTime = now;
            }
            
            if(bruteForceAdv_isAttackRunning) {
                bruteForceAdv_attackLoopId = requestAnimationFrame(bruteForceAdv_attackStep);
            }
        }

        function bruteForceAdv_calculateEstimatedTime() {
            const estimatedTimeText = document.getElementById('bruteForceAdv_estimatedTimeText');
            const advPasswordLength = document.getElementById('bruteForceAdv_advPasswordLength');
            const attackSpeedSelect = document.getElementById('bruteForceAdv_attackSpeed');
            const advConfigError = document.getElementById('bruteForceAdv_advConfigError');

            if (bruteForceAdv_SIMULATION_MODE !== 'advanced' || !estimatedTimeText || !advPasswordLength || !attackSpeedSelect || !advConfigError) {
                if(estimatedTimeText) estimatedTimeText.textContent = "- (Simple mode)";
                return;
            }
            if(advConfigError) advConfigError.textContent = ""; // Clear previous errors
            bruteForceAdv_buildCharset(); 
            const currentLength = parseInt(advPasswordLength.value) || 0;
            const selectedSpeed = attackSpeedSelect.value;

            if (bruteForceAdv_CURRENT_CHARSET_STRING.length === 0) {
                estimatedTimeText.textContent = "Select character sets."; return;
            }
            if (currentLength <= 0) {
                estimatedTimeText.textContent = "Set password length > 0."; return;
            }
            
            const combinations = Math.pow(bruteForceAdv_CURRENT_CHARSET_STRING.length, currentLength);
            
            let tempBatchSize;
            switch (selectedSpeed) {
                case 'fast': tempBatchSize = 1000; break;
                case 'very_fast': tempBatchSize = 5000; break;
                case 'normal': default: tempBatchSize = 300; break;
            }
            const estimatedBatchesPerSecond = 30; 
            const attacksPerSecond = estimatedBatchesPerSecond * tempBatchSize;
            
            if (combinations === Infinity || isNaN(combinations) || combinations > Number.MAX_SAFE_INTEGER) {
                   estimatedTimeText.textContent = "Extremely vast (effectively infinite for demo)."; return;
            }

            const seconds = combinations / attacksPerSecond;

            if (seconds < 0.001) estimatedTimeText.textContent = "< 0.001 seconds";
            else if (seconds < 60) estimatedTimeText.textContent = `~${seconds.toFixed(3)} seconds`;
            else if (seconds < 3600) estimatedTimeText.textContent = `~${(seconds / 60).toFixed(2)} minutes`;
            else if (seconds < 86400) estimatedTimeText.textContent = `~${(seconds / 3600).toFixed(2)} hours`;
            else if (seconds < 31536000) estimatedTimeText.textContent = `~${(seconds / 86400).toFixed(2)} days`;
            else estimatedTimeText.textContent = `~${(seconds / 31536000).toFixed(2)} years`;
        }

        function bruteForceAdv_buildCharset() {
            const charLowercase = document.getElementById('bruteForceAdv_charLowercase');
            const charUppercase = document.getElementById('bruteForceAdv_charUppercase');
            const charNumbers = document.getElementById('bruteForceAdv_charNumbers');
            const charSymbols = document.getElementById('bruteForceAdv_charSymbols');
            if(!charLowercase || !charUppercase || !charNumbers || !charSymbols) return;

            bruteForceAdv_CURRENT_CHARSET_STRING = "";
            if (charLowercase.checked) bruteForceAdv_CURRENT_CHARSET_STRING += bruteForceAdv_BASE_CHARSETS.lowercase;
            if (charUppercase.checked) bruteForceAdv_CURRENT_CHARSET_STRING += bruteForceAdv_BASE_CHARSETS.uppercase;
            if (charNumbers.checked) bruteForceAdv_CURRENT_CHARSET_STRING += bruteForceAdv_BASE_CHARSETS.numbers;
            if (charSymbols.checked) bruteForceAdv_CURRENT_CHARSET_STRING += bruteForceAdv_BASE_CHARSETS.symbols;
        }

        function bruteForceAdv_validateAdvancedConfig() {
            const advConfigError = document.getElementById('bruteForceAdv_advConfigError');
            const advPasswordInput = document.getElementById('bruteForceAdv_advPasswordInput');
            const advPasswordLength = document.getElementById('bruteForceAdv_advPasswordLength');
            if(!advConfigError || !advPasswordInput || !advPasswordLength) return false;

            advConfigError.textContent = "";
            let targetPasswordValue = advPasswordInput.value; 
            let chosenLength = parseInt(advPasswordLength.value);

            if (isNaN(chosenLength) || chosenLength < 1 || chosenLength > 6) {
                advConfigError.textContent = "Password length must be between 1 and 6."; return false;
            }
            if (!targetPasswordValue) {
                advConfigError.textContent = "Target password cannot be empty."; return false;
            }
            if (targetPasswordValue.length !== chosenLength) {
                advConfigError.textContent = `Target password must be exactly ${chosenLength} characters long.`; return false;
            }
            
            bruteForceAdv_buildCharset(); 
            if (bruteForceAdv_CURRENT_CHARSET_STRING.length === 0) {
                advConfigError.textContent = "At least one character set must be selected."; return false;
            }
            for(let char of targetPasswordValue) {
                if(bruteForceAdv_CURRENT_CHARSET_STRING.indexOf(char) === -1) {
                    advConfigError.textContent = `Target password contains character '${char}' not in the selected charsets.`; return false;
                }
            }
            
            bruteForceAdv_TARGET_PASSWORD = targetPasswordValue; 
            bruteForceAdv_PASSWORD_LENGTH = chosenLength; 
            return true;
        }

        function bruteForceAdv_prepareAttackAdvanced() {
            const targetPasswordDisplay = document.getElementById('bruteForceAdv_targetPasswordDisplay');
            const attackSpeedSelect = document.getElementById('bruteForceAdv_attackSpeed');
            const enableAccountLockout = document.getElementById('bruteForceAdv_enableAccountLockout');
            const lockoutAttemptsInput = document.getElementById('bruteForceAdv_lockoutAttemptsInput');
            const advSetupAttackBtn = document.getElementById('bruteForceAdv_advSetupAttackBtn');
            const advPasswordInput = document.getElementById('bruteForceAdv_advPasswordInput');
            const advPasswordLength = document.getElementById('bruteForceAdv_advPasswordLength');
            const startAttackBtn = document.getElementById('bruteForceAdv_startAttackBtn');
            const resetSimulationBtn = document.getElementById('bruteForceAdv_resetSimulationBtn');


            if (!bruteForceAdv_validateAdvancedConfig() || !targetPasswordDisplay || !attackSpeedSelect || !enableAccountLockout || !lockoutAttemptsInput || !advSetupAttackBtn) return;

            targetPasswordDisplay.textContent = bruteForceAdv_TARGET_PASSWORD;
            bruteForceAdv_logEvent(`Target password set to '${bruteForceAdv_TARGET_PASSWORD}'. Length: ${bruteForceAdv_PASSWORD_LENGTH}. Charset size: ${bruteForceAdv_CURRENT_CHARSET_STRING.length}.`, "emphasis");
            
            bruteForceAdv_CURRENT_ATTACK_SPEED = attackSpeedSelect.value;
            bruteForceAdv_logEvent(`Attack speed set to: ${bruteForceAdv_CURRENT_ATTACK_SPEED}.`, "emphasis");

            bruteForceAdv_accountLockoutEnabled = enableAccountLockout.checked;
            if(bruteForceAdv_accountLockoutEnabled) {
                bruteForceAdv_lockoutAfterAttempts = parseInt(lockoutAttemptsInput.value);
                if (isNaN(bruteForceAdv_lockoutAfterAttempts) || bruteForceAdv_lockoutAfterAttempts < 1) {
                    document.getElementById('bruteForceAdv_advConfigError').textContent = "Lockout attempts must be a positive number.";
                    return;
                }
                bruteForceAdv_logEvent(`Account lockout enabled after ${bruteForceAdv_lockoutAfterAttempts.toLocaleString()} attempts.`, "emphasis");
            } else {
                bruteForceAdv_logEvent(`Account lockout disabled.`, "emphasis");
            }

            bruteForceAdv_isPasswordSet = true;
            startAttackBtn.disabled = false;
            resetSimulationBtn.disabled = false;
            
            advPasswordInput.disabled = true;
            advPasswordLength.disabled = true;
            attackSpeedSelect.disabled = true;
            [document.getElementById('bruteForceAdv_charLowercase'), document.getElementById('bruteForceAdv_charUppercase'), document.getElementById('bruteForceAdv_charNumbers'), document.getElementById('bruteForceAdv_charSymbols'), enableAccountLockout, lockoutAttemptsInput, advSetupAttackBtn].forEach(el => { if(el) el.disabled = true; });
        }

        function bruteForceAdv_handleSimpleSetPassword() {
            const simpleUserPasswordInput = document.getElementById('bruteForceAdv_simpleUserPasswordInput');
            const simplePasswordValidationError = document.getElementById('bruteForceAdv_simplePasswordValidationError');
            const simpleSetPasswordBtn = document.getElementById('bruteForceAdv_simpleSetPasswordBtn');
            const targetPasswordDisplay = document.getElementById('bruteForceAdv_targetPasswordDisplay');
            const startAttackBtn = document.getElementById('bruteForceAdv_startAttackBtn');
            const resetSimulationBtn = document.getElementById('bruteForceAdv_resetSimulationBtn');


            if(!simpleUserPasswordInput || !simplePasswordValidationError || !simpleSetPasswordBtn || !targetPasswordDisplay || !startAttackBtn || !resetSimulationBtn) return;

            simplePasswordValidationError.textContent = ""; 
            const userInput = simpleUserPasswordInput.value.trim().toLowerCase();

            if (userInput.length !== 3) {
                simplePasswordValidationError.textContent = `Password must be exactly 3 letters.`; return;
            }
            for (let char of userInput) {
                if (bruteForceAdv_BASE_CHARSETS.lowercase.indexOf(char) === -1) {
                    simplePasswordValidationError.textContent = "Password must contain only lowercase letters (a-z)."; return;
                }
            }
            bruteForceAdv_TARGET_PASSWORD = userInput;
            bruteForceAdv_PASSWORD_LENGTH = 3;
            bruteForceAdv_CURRENT_CHARSET_STRING = bruteForceAdv_BASE_CHARSETS.lowercase;
            bruteForceAdv_CURRENT_ATTACK_SPEED = 'normal'; 
            targetPasswordDisplay.textContent = bruteForceAdv_TARGET_PASSWORD;
            bruteForceAdv_logEvent(`Target password set to '${bruteForceAdv_TARGET_PASSWORD}'. Ready to attack.`, "emphasis");
            
            simpleUserPasswordInput.disabled = true;
            simpleSetPasswordBtn.disabled = true;
            bruteForceAdv_isPasswordSet = true;
            startAttackBtn.disabled = false;
            resetSimulationBtn.disabled = false;
        }

        function bruteForceAdv_startAttack() {
            const startAttackBtn = document.getElementById('bruteForceAdv_startAttackBtn');
            const resetSimulationBtn = document.getElementById('bruteForceAdv_resetSimulationBtn');

            if (bruteForceAdv_isAttackRunning || !bruteForceAdv_isPasswordSet) return;

            bruteForceAdv_currentGeneratedPassword = ""; 
            bruteForceAdv_attemptsCount = 0;
            bruteForceAdv_passwordFound = false;
            bruteForceAdv_isAttackRunning = true;
            bruteForceAdv_lastLogTime = performance.now();

            bruteForceAdv_logEvent(`Brute force attack started. Target: '${bruteForceAdv_TARGET_PASSWORD}'.`, 'emphasis');
            bruteForceAdv_updateSystemVisualState(); 
            bruteForceAdv_updateAttackMonitorDisplay();

            startAttackBtn.disabled = true;
            resetSimulationBtn.disabled = false; 
            
            if (bruteForceAdv_attackLoopId) cancelAnimationFrame(bruteForceAdv_attackLoopId);
            bruteForceAdv_attackLoopId = requestAnimationFrame(bruteForceAdv_attackStep);
        }

        function bruteForceAdv_resetSimulation() {
            const startAttackBtn = document.getElementById('bruteForceAdv_startAttackBtn');
            const resetSimulationBtn = document.getElementById('bruteForceAdv_resetSimulationBtn');
            const eventLog = document.getElementById('bruteForceAdv_eventLog');
            const targetPasswordDisplay = document.getElementById('bruteForceAdv_targetPasswordDisplay');
            const simpleUserPasswordInput = document.getElementById('bruteForceAdv_simpleUserPasswordInput');
            const advPasswordInput = document.getElementById('bruteForceAdv_advPasswordInput');

            bruteForceAdv_isAttackRunning = false;
            if (bruteForceAdv_attackLoopId) {
                cancelAnimationFrame(bruteForceAdv_attackLoopId);
                bruteForceAdv_attackLoopId = null;
            }
            
            bruteForceAdv_TARGET_PASSWORD = "";
            bruteForceAdv_currentGeneratedPassword = "";
            bruteForceAdv_attemptsCount = 0;
            bruteForceAdv_passwordFound = false;
            bruteForceAdv_isPasswordSet = false;
            
            if(eventLog) eventLog.innerHTML = ''; 
            bruteForceAdv_logEvent("Simulation Reset.", "emphasis");
            if(targetPasswordDisplay) targetPasswordDisplay.textContent = "***";
            
            bruteForceAdv_updateSystemVisualState();
            bruteForceAdv_updateAttackMonitorDisplay();

            if(startAttackBtn) startAttackBtn.disabled = true; 
            if(resetSimulationBtn) resetSimulationBtn.disabled = true;

            if (bruteForceAdv_SIMULATION_MODE === 'simple') {
                const simpleConfig = document.getElementById('bruteForceAdv_simpleModeConfig');
                if(simpleConfig) {
                    simpleConfig.querySelector('#bruteForceAdv_simplePasswordValidationError').textContent = "";
                    simpleConfig.querySelector('#bruteForceAdv_simpleUserPasswordInput').value = "";
                    simpleConfig.querySelector('#bruteForceAdv_simpleUserPasswordInput').disabled = false;
                    simpleConfig.querySelector('#bruteForceAdv_simpleSetPasswordBtn').disabled = false;
                }
                bruteForceAdv_logEvent("Set a 3-letter lowercase password.", "emphasis");
            } else {
                 const advConfig = document.getElementById('bruteForceAdv_advancedModeConfig');
                 if(advConfig) {
                    advConfig.querySelector('#bruteForceAdv_advConfigError').textContent = "";
                    advConfig.querySelector('#bruteForceAdv_advPasswordInput').value = "";
                    const lengthInput = advConfig.querySelector('#bruteForceAdv_advPasswordLength');
                    lengthInput.value = "3";
                    advConfig.querySelector('#bruteForceAdv_advPasswordInput').maxLength = 3;
                    
                    const elementsToEnable = advConfig.querySelectorAll('input, select, button');
                    elementsToEnable.forEach(el => el.disabled = false);
                 }
                bruteForceAdv_logEvent("Configure advanced attack parameters.", "emphasis");
                bruteForceAdv_calculateEstimatedTime(); 
            }
        }

        function bruteForceAdv_switchToMode(mode) {
            const modeSelectionScreen = document.getElementById('bruteForceAdv_modeSelectionScreen');
            const simulatorInterface = document.getElementById('bruteForceAdv_simulatorInterface');
            const simpleModeConfigDiv = document.getElementById('bruteForceAdv_simpleModeConfig');
            const advancedModeConfigDiv = document.getElementById('bruteForceAdv_advancedModeConfig');
            const modeDisplay = document.getElementById('bruteForceAdv_modeDisplay');
            const infoBoxText = document.getElementById('bruteForceAdv_infoBoxText');

            if(!modeSelectionScreen || !simulatorInterface || !simpleModeConfigDiv || !advancedModeConfigDiv || !modeDisplay || !infoBoxText) return;

            bruteForceAdv_SIMULATION_MODE = mode;
            modeSelectionScreen.classList.add('hidden');
            simulatorInterface.classList.remove('hidden');
            bruteForceAdv_resetSimulation(); 

            if (mode === 'simple') {
                modeDisplay.textContent = "Simple Mode Activated";
                simpleModeConfigDiv.classList.remove('hidden');
                advancedModeConfigDiv.classList.add('hidden');
                infoBoxText.innerHTML = `A <strong class="text-amber-300">brute-force attack</strong> tries many passwords. This mode uses a 3-letter lowercase password.`;
            } else { 
                modeDisplay.textContent = "Advanced Mode Activated";
                simpleModeConfigDiv.classList.add('hidden');
                advancedModeConfigDiv.classList.remove('hidden');
                infoBoxText.innerHTML = `A <strong class="text-amber-300">brute-force attack</strong> tries password combinations. Configure length, character sets, and defenses.`;
                bruteForceAdv_calculateEstimatedTime(); 
            }
        }

        function bruteForceAdv_handleAdvPasswordLengthChange() {
            const advPasswordLength = document.getElementById('bruteForceAdv_advPasswordLength');
            const advPasswordInput = document.getElementById('bruteForceAdv_advPasswordInput');
            if(!advPasswordLength || !advPasswordInput) return;

            const newLength = parseInt(advPasswordLength.value);
            if (!isNaN(newLength) && newLength >= 1 && newLength <= 6) {
                advPasswordInput.maxLength = newLength;
                if (advPasswordInput.value.length > newLength) {
                    advPasswordInput.value = advPasswordInput.value.substring(0, newLength);
                }
            }
            bruteForceAdv_calculateEstimatedTime(); 
        }

        function bruteForceAdv_init() { 
            const selectSimpleModeBtn = document.getElementById('bruteForceAdv_selectSimpleModeBtn');
            const selectAdvancedModeBtn = document.getElementById('bruteForceAdv_selectAdvancedModeBtn');
            const backToModeSelectionBtn = document.getElementById('bruteForceAdv_backToModeSelectionBtn');
            const simpleSetPasswordBtn = document.getElementById('bruteForceAdv_simpleSetPasswordBtn');
            const advPasswordLength = document.getElementById('bruteForceAdv_advPasswordLength');
            const enableAccountLockout = document.getElementById('bruteForceAdv_enableAccountLockout');
            const advSetupAttackBtn = document.getElementById('bruteForceAdv_advSetupAttackBtn');
            const startAttackBtn = document.getElementById('bruteForceAdv_startAttackBtn');
            const resetSimulationBtn = document.getElementById('bruteForceAdv_resetSimulationBtn');
            
            bruteForceAdv_updateSystemVisualState(); 
            bruteForceAdv_updateAttackMonitorDisplay();
            if(startAttackBtn) startAttackBtn.disabled = true;
            if(resetSimulationBtn) resetSimulationBtn.disabled = true; 
            
            if(selectSimpleModeBtn) selectSimpleModeBtn.addEventListener('click', () => bruteForceAdv_switchToMode('simple'));
            if(selectAdvancedModeBtn) selectAdvancedModeBtn.addEventListener('click', () => bruteForceAdv_switchToMode('advanced'));
            if(backToModeSelectionBtn) backToModeSelectionBtn.addEventListener('click', () => {
                if(bruteForceAdv_isAttackRunning) {
                    bruteForceAdv_isAttackRunning = false; 
                    if (bruteForceAdv_attackLoopId) cancelAnimationFrame(bruteForceAdv_attackLoopId);
                }
                document.getElementById('bruteForceAdv_modeSelectionScreen').classList.remove('hidden');
                document.getElementById('bruteForceAdv_simulatorInterface').classList.add('hidden');
            });

            if(simpleSetPasswordBtn) simpleSetPasswordBtn.addEventListener('click', bruteForceAdv_handleSimpleSetPassword);
            if(advPasswordLength) advPasswordLength.addEventListener('input', bruteForceAdv_handleAdvPasswordLengthChange);
            
            const advConfigInputs = document.querySelectorAll('#bruteForceAdv_advPasswordInput, #bruteForceAdv_charLowercase, #bruteForceAdv_charUppercase, #bruteForceAdv_charNumbers, #bruteForceAdv_charSymbols, #bruteForceAdv_attackSpeed');
            advConfigInputs.forEach(el => { 
                if(el) {
                    el.addEventListener('input', bruteForceAdv_calculateEstimatedTime);
                    el.addEventListener('change', bruteForceAdv_calculateEstimatedTime); 
                }
            });
            if(enableAccountLockout) enableAccountLockout.addEventListener('change', () => {
                document.getElementById('bruteForceAdv_accountLockoutOptions').classList.toggle('hidden', !enableAccountLockout.checked);
            });
            if(advSetupAttackBtn) advSetupAttackBtn.addEventListener('click', bruteForceAdv_prepareAttackAdvanced);
            
            if(startAttackBtn) startAttackBtn.addEventListener('click', bruteForceAdv_startAttack);
            if(resetSimulationBtn) resetSimulationBtn.addEventListener('click', bruteForceAdv_resetSimulation);
        }

        // Main application object
        const App = {
            // STATE: Centralized state management for the entire application
            state: {
                currentPageIndex: 0,
                pages: [
                    { nav: 'Starter', init: 'initStarter' },
                    { nav: 'Task 1: Brute Force', init: 'initBruteForceBasics' },
                    { nav: 'Task 2: Smart Attacks', init: 'initBruteForceSmarts' },
                    { nav: 'Task 3: Social Eng.', init: 'initSocialEngineering' },
                    { nav: 'Task 4: Phishing Sim', init: 'initPhishingSim' },
                    { nav: 'Task 5: Exam Practice', init: 'initExamPractice' },
                    { nav: 'Task 6: Summary Quiz', init: 'initSummaryQuiz' },
                    { nav: 'Task 7: Extension', init: 'initExtension' },
                ],
                userData: {
                    xp: 0,
                    level: 1,
                    achievements: [],
                    completedActions: [],
                },
                xpLevels: [0, 100, 250, 500, 1000], // XP thresholds for levels 1-5
            },

            // INIT: Kicks off the entire application
            init() {
                this.loadState();
                this.setupEventListeners();
                this.renderPage();
                this.updateQuickNav();
            },

            // RENDER: Handles displaying the correct page content
            renderPage() {
                const pageIndex = this.state.currentPageIndex;
                const pageConfig = this.state.pages[pageIndex];
                
                // Adjust template index based on new page structure
                const templateIndexMap = [0, 1, 2, 3, 4, 6, 7, 8];
                const templateId = `template-${templateIndexMap[pageIndex]}`;

                const contentContainer = document.getElementById('content-container');
                const template = document.getElementById(templateId);
                
                if (!template) {
                    console.error(`Template ${templateId} for page ${pageIndex} not found.`);
                    return;
                }

                // Clear previous content and render the new page from its template
                contentContainer.innerHTML = '';
                const pageContent = template.content.cloneNode(true);
                const wrapper = document.createElement('div');
                wrapper.classList.add('page-content-animate');
                wrapper.appendChild(pageContent);
                contentContainer.appendChild(wrapper);
                
                // Run the specific initialization function for that page's interactive elements
                if (pageConfig.init && typeof this.pageInitializers[pageConfig.init] === 'function') {
                    this.pageInitializers[pageConfig.init]();
                }

                this.updateNavUI();
            },

            // NAVIGATION & UI UPDATES
            changePage(direction) {
                const newIndex = this.state.currentPageIndex + direction;
                if (newIndex >= 0 && newIndex < this.state.pages.length) {
                    this.state.currentPageIndex = newIndex;
                    this.renderPage();
                }
            },
            goToPage(index) {
                if (index >= 0 && index < this.state.pages.length) {
                    this.state.currentPageIndex = index;
                    this.renderPage();
                }
            },
            updateNavUI() {
                document.getElementById('prev-btn').disabled = this.state.currentPageIndex === 0;
                document.getElementById('next-btn').disabled = this.state.currentPageIndex === this.state.pages.length - 1;
                document.querySelectorAll('.nav-btn').forEach((btn, index) => {
                    btn.classList.toggle('bg-blue-600', index === this.state.currentPageIndex);
                    btn.classList.toggle('text-white', index === this.state.currentPageIndex);
                });
                window.scrollTo(0, 0);
            },
            updateQuickNav() {
                const navContainer = document.getElementById('quick-nav');
                navContainer.innerHTML = '';
                this.state.pages.forEach((page, index) => {
                    const btn = document.createElement('button');
                    btn.textContent = page.nav;
                    btn.classList.add('nav-btn', 'px-3', 'py-1', 'text-sm', 'font-medium', 'rounded-md', 'hover:bg-blue-100');
                    btn.addEventListener('click', () => this.goToPage(index));
                    navContainer.appendChild(btn);
                });
            },

            // EVENT LISTENERS: Central setup for all persistent listeners
            setupEventListeners() {
                // Main Navigation
                document.getElementById('prev-btn').addEventListener('click', () => this.changePage(-1));
                document.getElementById('next-btn').addEventListener('click', () => this.changePage(1));

                // Accessibility
                document.getElementById('contrast-toggle').addEventListener('click', () => document.body.classList.toggle('high-contrast'));
                document.getElementById('dyslexia-toggle').addEventListener('click', () => document.body.classList.toggle('dyslexia-font'));
                document.getElementById('font-size-increase').addEventListener('click', () => {
                    const currentSize = parseFloat(getComputedStyle(document.body).fontSize);
                    document.body.style.fontSize = `${currentSize + 1}px`;
                });
                document.getElementById('font-size-decrease').addEventListener('click', () => {
                    const currentSize = parseFloat(getComputedStyle(document.body).fontSize);
                    document.body.style.fontSize = `${Math.max(12, currentSize - 1)}px`;
                });

                // Feedback Modal
                const feedbackModal = document.getElementById('feedback-modal');
                document.getElementById('feedback-btn').addEventListener('click', () => feedbackModal.classList.remove('hidden'));
                document.getElementById('close-feedback').addEventListener('click', () => feedbackModal.classList.add('hidden'));
                document.getElementById('send-feedback-btn').addEventListener('click', () => {
                    const text = document.getElementById('feedback-textarea').value;
                    if (!text.trim()) { alert('Please enter some feedback.'); return; }
                    const subject = 'GCSE Worksheet Feedback';
                    const body = `Feedback regarding page: ${this.state.pages[this.state.currentPageIndex].nav}\n\n${text}`;
                    window.location.href = `mailto:millingtond@mgs.org?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                    feedbackModal.classList.add('hidden');
                });
                
                // Mobile Gesture Navigation
                let touchstartX = 0;
                document.addEventListener('touchstart', e => { touchstartX = e.changedTouches[0].screenX; }, { passive: true });
                document.addEventListener('touchend', e => {
                    const touchendX = e.changedTouches[0].screenX;
                    if (touchendX < touchstartX - 50) this.changePage(1); // Swipe Left
                    if (touchendX > touchstartX + 50) this.changePage(-1); // Swipe Right
                });
            },

            // GAMIFICATION & STATE
            addXP(amount, actionId) {
                if (this.state.userData.completedActions.includes(actionId)) return;
                this.state.userData.xp += amount;
                this.state.userData.completedActions.push(actionId);
                if (navigator.vibrate) navigator.vibrate(50);
                this.updateXPDisplay();
                this.saveState();
            },
            updateXPDisplay() {
                const { xp, level } = this.state.userData;
                const nextLvlXP = this.state.xpLevels[level];
                const prevLvlXP = this.state.xpLevels[level - 1] || 0;
                
                document.getElementById('xp-display').textContent = xp;
                document.getElementById('level-display').textContent = level;
                const xpForLevel = nextLvlXP - prevLvlXP;
                const xpIntoLevel = xp - prevLvlXP;
                document.getElementById('xp-bar').style.width = `${Math.min(100, (xpIntoLevel / xpForLevel) * 100)}%`;

                // Check for level up
                if (xp >= nextLvlXP && level < this.state.xpLevels.length) {
                    this.state.userData.level++;
                    this.unlockAchievement(`level_${this.state.userData.level}`, `Reached Level ${this.state.userData.level}!`);
                    this.updateXPDisplay(); // Recalculate bar for new level
                }
            },
            unlockAchievement(id, title) {
                if (this.state.userData.achievements.includes(id)) return;
                this.state.userData.achievements.push(id);
                
                const popup = document.getElementById('achievement-popup');
                document.getElementById('achievement-title').textContent = title;
                popup.classList.remove('hidden');
                popup.classList.add('achievement-popup-animate');
                
                setTimeout(() => {
                    popup.classList.remove('achievement-popup-animate');
                    popup.classList.add('hidden');
                }, 4000);
                
                this.saveState();
            },
            saveState() {
                localStorage.setItem('gcseCyberWorksheetData', JSON.stringify(this.state.userData));
            },
            loadState() {
                const savedData = localStorage.getItem('gcseCyberWorksheetData');
                if (savedData) {
                    this.state.userData = JSON.parse(savedData);
                }
            },

            // UTILITIES
            setupGlobalInputProtection(container) {
                container.querySelectorAll('textarea, input').forEach(el => {
                    el.addEventListener('paste', e => {
                        e.preventDefault();
                        const popup = document.getElementById('paste-shame-popup');
                        popup.classList.remove('hidden');
                        setTimeout(() => popup.classList.add('hidden'), 2500);
                    });
                });
            },
            
            // This object holds all the functions that initialize the interactive elements on each page
            pageInitializers: {
                initStarter() {
                    App.setupGlobalInputProtection(document.getElementById('content-container'));
                    const submitBtn = document.getElementById('starter-submit');
                    const input = document.getElementById('starter-input');
                    const xpDisplay = document.getElementById('starter-xp');
                    submitBtn.addEventListener('click', () => {
                        const keywords = ['virus', 'phishing', 'brute force', 'ddos', 'malware', 'spyware'];
                        const found = keywords.filter(kw => input.value.toLowerCase().includes(kw));
                        const xp = found.length * 5;
                        xpDisplay.textContent = xp;
                        App.addXP(xp, 'starter_activity');
                        if (xp > 10) App.unlockAchievement('starter_complete', 'Cyber Aware');
                        submitBtn.disabled = true;
                    });
                    document.getElementById('starter-reset').addEventListener('click', () => {
                        input.value = ''; xpDisplay.textContent = '0'; submitBtn.disabled = false;
                    });
                },
                initBruteForceBasics() {
                    App.setupGlobalInputProtection(document.getElementById('content-container'));
                    // Initialize the new brute force simulator
                    if (typeof bruteForceAdv_init === 'function') {
                        bruteForceAdv_init();
                    }
                },
                initBruteForceSmarts() {
                    const quizData = [
                        { q: 'A Church', a: 'amen', o: ['football', 'algorithm', 'mitre'] },
                        { q: 'MGS (a school)', a: 'homework', o: ['password', 'spartans', 'lion'] },
                        { q: 'English Football fans', a: 'england', o: ['science', 'learning', 'qwerty'] },
                        { q: 'British Governments', a: 'downing', o: ['america', 'paris', 'cobra'] }
                    ];
                    const setup = () => {
                        const quizContainer = document.getElementById('context-quiz');
                        quizContainer.innerHTML = '';
                        document.getElementById('context-feedback').textContent = '';
                        document.getElementById('context-submit').disabled = false;
                        quizData.sort(() => Math.random() - 0.5).forEach((item, index) => {
                            const options = [...item.o, item.a].sort(() => Math.random() - 0.5);
                            const optionsHTML = options.map(opt => `<option value="${opt}">${opt}</option>`).join('');
                            quizContainer.innerHTML += `<div class="mb-2">
                                <label for="context-q-${index}" class="block text-sm font-medium text-gray-700">What is a likely password for: ${item.q}?</label>
                                <select id="context-q-${index}" data-answer="${item.a}" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                                    <option value="">Select...</option>${optionsHTML}
                                </select></div>`;
                        });
                    };
                    document.getElementById('context-submit').addEventListener('click', () => {
                        let correct = 0;
                        quizData.forEach((item, index) => {
                            const sel = document.getElementById(`context-q-${index}`);
                            if (sel.value === sel.dataset.answer) {
                                correct++;
                                sel.classList.add('border-green-500', 'ring-green-500');
                            } else {
                                sel.classList.add('border-red-500', 'ring-red-500');
                            }
                        });
                        App.addXP(correct * 5, 'context_quiz');
                        document.getElementById('context-feedback').textContent = `You got ${correct}/${quizData.length} correct.`;
                        if (correct === quizData.length) App.unlockAchievement('context_master', 'Think Like a Hacker');
                        document.getElementById('context-submit').disabled = true;
                    });
                    document.getElementById('smarts-reset').addEventListener('click', setup);
                    setup();
                },
                initSocialEngineering() {
                    const terms = [
                        { id: 't1', term: 'Phishing', def: 'Using fake emails from reputable sources to trick users into revealing info.' },
                        { id: 't2', term: 'Brute Force', def: 'Trying every possible password combination until one works.' },
                        { id: 't3', term: 'Social Engineering', def: 'The art of manipulating people to give up confidential information.' },
                        { id: 't4', term: 'Malware', def: 'Software intentionally designed to cause damage to a computer or network.' }
                    ];
                    const setup = () => {
                        const draggablesContainer = document.getElementById('draggable-items');
                        const dropZonesContainer = document.getElementById('drop-zones-container');
                        draggablesContainer.innerHTML = '';
                        dropZonesContainer.innerHTML = '';
                        document.getElementById('matching-feedback').textContent = '';

                        const shuffledTerms = [...terms].sort(() => Math.random() - 0.5);
                        shuffledTerms.forEach(item => {
                            draggablesContainer.innerHTML += `<div class="draggable p-3 bg-blue-100 border border-blue-300 rounded-md cursor-grab text-center" draggable="true" id="${item.id}">${item.term}</div>`;
                        });
                        const shuffledDefs = [...terms].sort(() => Math.random() - 0.5);
                        shuffledDefs.forEach(item => {
                            dropZonesContainer.innerHTML += `<div class="flex items-center gap-4">
                                <p class="flex-grow">${item.def}</p>
                                <div class="drop-zone w-48 h-16 p-2 border-2 border-dashed border-gray-300 rounded-md flex items-center justify-center" data-id="${item.id}"></div>
                            </div>`;
                        });
                        
                        let draggedItem = null;
                        document.querySelectorAll('.draggable').forEach(d => {
                            d.addEventListener('dragstart', (e) => {
                                draggedItem = e.target;
                                e.target.classList.add('dragging');
                            });
                            d.addEventListener('dragend', (e) => e.target.classList.remove('dragging'));
                        });
                        document.querySelectorAll('.drop-zone').forEach(dz => {
                            dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('over'); });
                            dz.addEventListener('dragleave', e => dz.classList.remove('over'));
                            dz.addEventListener('drop', (e) => {
                                e.preventDefault();
                                dz.classList.remove('over');
                                if (dz.hasChildNodes()) draggablesContainer.appendChild(dz.firstChild);
                                dz.appendChild(draggedItem);
                                checkMatches();
                            });
                        });
                    };
                    const checkMatches = () => {
                        let correctCount = 0;
                        document.querySelectorAll('.drop-zone').forEach(dz => {
                            if (dz.firstChild && dz.firstChild.id === dz.dataset.id) {
                                correctCount++;
                                dz.classList.add('bg-green-100', 'border-green-400');
                            } else {
                                dz.classList.remove('bg-green-100', 'border-green-400');
                            }
                        });
                        if (correctCount === terms.length) {
                            document.getElementById('matching-feedback').textContent = 'Excellent! All matched correctly.';
                            App.addXP(20, 'matching_game_complete');
                            App.unlockAchievement('definer', 'Master of Definitions');
                        }
                    };
                    document.getElementById('matching-reset').addEventListener('click', setup);
                    setup();
                },
                initPhishingSim() {
                    // No JS needed for a simple link page, but the init function must exist.
                },
                initExamPractice() {
                    new WritingScorer('writingScorer1', 'studentAnswer1', 'keywords1');
                    new WritingScorer('writingScorer2', 'studentAnswer2', 'keywords2');

                    document.querySelectorAll('.mark-scheme-toggle').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const targetId = btn.dataset.target;
                            const textareaId = targetId.includes('1') ? 'studentAnswer1' : 'studentAnswer2';
                            const answer = document.getElementById(textareaId).value;
                            if (answer.trim().split(' ').length < 10) {
                                alert("Please provide a more detailed answer (at least 10 words) before viewing the mark scheme.");
                                return;
                            }
                            document.getElementById(targetId).classList.toggle('hidden');
                        });
                    });
                },
                initSummaryQuiz() {
                    const questions = [
                        { q: "Which attack involves trying every possible password?", a: "Brute Force", o: ["Phishing", "DDoS", "Malware"] },
                        { q: "What is the main goal of a phishing email?", a: "To trick the user into revealing sensitive information", o: ["To improve your computer's performance", "To sell you a product", "To update your software"] },
                        { q: "Which of these is the STRONGEST defence against brute force attacks?", a: "Multi-factor authentication", o: ["A simple CAPTCHA", "Email notifications", "Using a common password"] },
                        { q: "What does social engineering rely on?", a: "Human psychology and deception", o: ["Complex algorithms", "Exploiting software bugs", "Powerful hardware"] }
                    ];
                    const setup = () => {
                        const quizContainer = document.getElementById('final-quiz');
                        quizContainer.innerHTML = '';
                        document.getElementById('quiz-results').textContent = '';
                        document.getElementById('quiz-submit').disabled = false;
                        questions.sort(() => Math.random() - 0.5).forEach((item, index) => {
                            const options = [...item.o, item.a].sort(() => Math.random() - 0.5);
                            const optionsHTML = options.map(opt => `<label class="flex items-center gap-2 p-2 border rounded-md hover:bg-gray-100"><input type="radio" name="q${index}" value="${opt}" class="form-radio h-4 w-4 text-blue-600">${opt}</label>`).join('');
                            quizContainer.innerHTML += `<div class="quiz-question"><p class="font-semibold mb-2">${index + 1}. ${item.q}</p><div class="space-y-2">${optionsHTML}</div></div>`;
                        });
                    };
                    document.getElementById('quiz-submit').addEventListener('click', () => {
                        let score = 0;
                        questions.forEach((item, index) => {
                            const selected = document.querySelector(`input[name="q${index}"]:checked`);
                            if (selected && selected.value === item.a) score++;
                        });
                        const percentage = Math.round((score / questions.length) * 100);
                        document.getElementById('quiz-results').textContent = `You scored ${score} out of ${questions.length} (${percentage}%)`;
                        App.addXP(score * 10, 'final_quiz');
                        if (percentage === 100) App.unlockAchievement('quiz_master', 'Quiz Master');
                        document.getElementById('quiz-submit').disabled = true;
                    });
                    document.getElementById('quiz-reset').addEventListener('click', setup);
                    setup();
                },
                 initExtension() {
                    this.updateAchievementsList();
                    document.getElementById('extension-submit').addEventListener('click', () => {
                        if (document.getElementById('extension-answer').value.length > 50) {
                            App.addXP(25, 'extension_task');
                            alert('Thank you for your research! 25 XP awarded.');
                            document.getElementById('extension-submit').disabled = true;
                        } else {
                            alert('Please write a more detailed paragraph to earn XP.');
                        }
                    });
                },
                updateAchievementsList() {
                    const list = document.getElementById('achievements-list');
                    if(!list) return;
                    list.innerHTML = '';
                    const allAchievements = {
                        'starter_complete': 'Cyber Aware: Completed the starter activity.', 'used_password_simulator': 'Password Cracker: Used the password strength simulator.', 'context_master': 'Think Like a Hacker: Aced the contextual password quiz.', 'definer': 'Master of Definitions: Correctly matched all security terms.', 'super_sleuth': 'Super Sleuth: Found all the red flags.', 'quiz_master': 'Quiz Master: Scored 100% on the final quiz.', 'easter_egg': 'Explorer: Found the hidden Easter Egg!', 'level_2': 'Level 2 Reached!', 'level_3': 'Level 3 Reached!', 'level_4': 'Level 4 Reached!', 'level_5': 'Level 5 Guru: Reached the maximum level!',
                    };
                    const unlocked = App.state.userData.achievements;
                    for (const id in allAchievements) {
                        const li = document.createElement('li');
                        li.className = 'flex items-center gap-2';
                        if (unlocked.includes(id)) {
                            li.innerHTML = `<span class="text-green-500 font-bold">‚úîÔ∏è</span> ${allAchievements[id]}`;
                        } else {
                            li.innerHTML = `<span class="text-gray-400 font-bold">üîí</span> <span class="text-gray-400">Locked Achievement</span>`;
                        }
                        list.appendChild(li);
                    }
                }
            },

        };
        
        // Writing Scorer Class, as per technical specification
        class WritingScorer {
            constructor(containerId, textareaId, keywordsId) {
                this.container = document.getElementById(containerId);
                if (!this.container) return;
                
                // Build the required HTML structure
                this.container.innerHTML = `<div>
                    <textarea id="${textareaId}" rows="6" class="w-full p-2 border border-gray-300 rounded-md"></textarea>
                    <input type="hidden" id="${keywordsId}" value="osmosis,membrane,concentration"> <!-- Example -->
                    <button id="analyzeBtn-${containerId}" class="mt-2 px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 text-sm">Check My Writing</button>
                </div>
                <div id="resultsDashboard-${containerId}" class="hidden mt-4">
                    <h3 class="font-bold text-lg mb-2">Your Writing Feedback</h3>
                    <div class="flex flex-col md:flex-row gap-4 items-start">
                        <div class="text-center">
                            <p class="text-sm font-medium">Overall Score</p>
                            <div class="scoreCircle mx-auto mt-1"><span class="scoreValue">0</span></div>
                        </div>
                        <div class="flex-grow">
                            <div><h4 class="font-semibold text-green-600">Successes:</h4><ul class="successList list-inside text-sm"></ul></div>
                            <div class="mt-2"><h4 class="font-semibold text-red-600">Areas for Improvement:</h4><ul class="improvementList list-inside text-sm"></ul></div>
                        </div>
                    </div>
                </div>`;
                
                this.textarea = document.getElementById(textareaId);
                this.keywords = document.getElementById(keywordsId); // This will be set by the initializer
                this.button = document.getElementById(`analyzeBtn-${containerId}`);
                this.dashboard = document.getElementById(`resultsDashboard-${containerId}`);
                
                this.scoreCircle = this.dashboard.querySelector('.scoreCircle');
                this.scoreValue = this.dashboard.querySelector('.scoreValue');
                this.successList = this.dashboard.querySelector('.successList');
                this.improvementList = this.dashboard.querySelector('.improvementList');

                this.button.addEventListener('click', () => this.analyzeWriting());
            }

            analyzeWriting() {
                const text = this.textarea.value;
                if (text.trim() === '') { alert('Please enter some text.'); return; }
                
                let score = 100;
                let successes = [];
                let improvements = [];
                const cleanedText = text.trim().replace(/\s+/g, ' ');
                const sentences = cleanedText.match(/[^.!?]+[.!?]+/g) || [];

                // Run checks as per spec
                const capResult = this.checkFirstLetterCapital(cleanedText);
                if (capResult.scoreChange < 0) { score += capResult.scoreChange; improvements.push(capResult.message); } else { successes.push(capResult.message); }
                
                if(sentences) {
                    sentences.forEach(s => {
                        const sentence = s.trim();
                        if (this.checkSentenceCapitalization(sentence).scoreChange < 0) score -= 5;
                        if (this.checkPunctuation(sentence).scoreChange < 0) { score -= 10; improvements.push(`Ensure sentences like "${sentence.substring(0,20)}..." have end punctuation.`); }
                        if (this.checkSentenceLength(sentence).scoreChange < 0) { score -= 10; improvements.push(`The sentence "${sentence}" seems too short. Write in full sentences.`); }
                    });
                } else {
                    score -= 10; improvements.push('Try to write in full sentences ending with punctuation.');
                }
                
                if (this.checkIThink(cleanedText).message) improvements.push({ text: this.checkIThink(cleanedText).message, type: 'suggestion'});
                
                score = Math.max(0, score);
                this.displayResults(score, successes, improvements);
            }

            checkFirstLetterCapital(text) { return (text.charAt(0) === text.charAt(0).toUpperCase() && isNaN(text.charAt(0))) ? { scoreChange: 0, message: 'Started with a capital letter.' } : { scoreChange: -15, message: 'Your answer should begin with a capital letter.' }; }
            checkSentenceCapitalization(s) { return s.charAt(0) !== s.charAt(0).toUpperCase() ? { scoreChange: -5 } : {}; }
            checkPunctuation(s) { return !['.','!','?'].includes(s.slice(-1)) ? { scoreChange: -10 } : {}; }
            checkSentenceLength(s) { return s.split(' ').length < 4 ? { scoreChange: -10 } : {}; }
            checkIThink(text) { return /\bi think\b/i.test(text) ? { message: 'For formal answers, try to avoid "I think..." to sound more confident.' } : {}; }

            displayResults(score, successes, improvements) {
                this.scoreValue.textContent = score;
                this.scoreCircle.className = 'scoreCircle ' + (score > 75 ? 'border-green-500' : score > 50 ? 'border-yellow-500' : 'border-red-500');
                
                this.successList.innerHTML = successes.map(msg => `<li>${msg}</li>`).join('');
                this.improvementList.innerHTML = improvements.map(msg => `<li class="${msg.type === 'suggestion' ? 'suggestion' : ''}">${typeof msg === 'string' ? msg : msg.text}</li>`).join('');
                if (improvements.length === 0) this.improvementList.innerHTML = `<li>Great work! No major issues found.</li>`;
                
                this.dashboard.classList.remove('hidden');
            }
        }
        
        // Start the application once the DOM is ready
        App.init();
    })();
    </script>
</body>
</html>
