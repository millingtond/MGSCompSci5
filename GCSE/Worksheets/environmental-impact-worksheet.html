<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GCSE CS: Environmental Issues</title>
    <style>
        /* OCR J277 - Environmental Issues Worksheet -- CSS */
        /* Generated by Google Gemini (v2) */

        /* FONT IMPORT */
        @import url('https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Open+Sans:wght@400;700&display=swap');
        @font-face {
            font-family: 'OpenDyslexic';
            src: url('https://cdn.jsdelivr.net/npm/opendyslexic@2.0.2/build/font/OpenDyslexic-Regular.otf') format('opentype');
        }

        /* GENERAL STYLING */
        :root {
            --primary-color: #005A9C;
            --secondary-color: #003A65;
            --accent-color: #4CAF50;
            --accent-dark: #388E3C;
            --danger-color: #D32F2F;
            --warning-color: #FBC02D;
            --light-grey: #f4f4f4;
            --medium-grey: #ccc;
            --dark-grey: #333;
            --text-color: #212121;
            --bg-color: #ffffff;
            --font-size: 16px;
        }

        body {
            font-family: 'Lato', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            line-height: 1.6;
            font-size: var(--font-size);
            transition: background-color 0.3s, color 0.3s;
        }

        h1, h2, h3, h4 {
            font-family: 'Open Sans', sans-serif;
            color: var(--primary-color);
            margin-top: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            overflow-x: hidden;
        }

        .page {
            display: none; /* Hidden by default, managed by JS */
            animation: fadeIn 0.5s;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* HEADER & NAVIGATION */
        .main-header {
            background-color: var(--primary-color);
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .main-nav ul {
            padding: 0;
            margin: 0;
            list-style: none;
            display: flex;
            flex-wrap: wrap;
        }
        .main-nav li {
            margin: 5px 10px;
        }
        .main-nav a {
            color: white;
            text-decoration: none;
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .main-nav a:hover, .main-nav a.active-nav {
            background-color: var(--secondary-color);
        }

        .status-bar {
            display: flex;
            align-items: center;
            color: white;
        }
        .xp-bar-container {
            width: 120px;
            height: 20px;
            background-color: var(--secondary-color);
            border-radius: 10px;
            margin-left: 10px;
            overflow: hidden;
            border: 1px solid white;
        }
        .xp-bar {
            width: 0%;
            height: 100%;
            background-color: var(--accent-color);
            transition: width 0.5s ease-in-out;
        }
        #xp-text {
            font-size: 0.9em;
            margin-left: 10px;
        }
        #level-badge {
            background-color: var(--warning-color);
            color: var(--dark-grey);
            padding: 3px 8px;
            border-radius: 50%;
            font-weight: bold;
            margin-left: 10px;
        }

        /* ACCESSIBILITY CONTROLS */
        .accessibility-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            background-color: var(--light-grey);
            padding: 10px 20px;
            border-bottom: 1px solid var(--medium-grey);
            justify-content: center;
        }

        .control-group { display: flex; align-items: center; gap: 5px; }

        .accessibility-controls button {
            background: none;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 5px;
        }
        .accessibility-controls button:hover { background-color: #e0e0e0; }

        /* HIGH CONTRAST MODE */
        body.high-contrast {
            --primary-color: #FFFF00; /* Yellow */
            --secondary-color: #0000FF; /* Blue */
            --accent-color: #FF00FF; /* Magenta */
            --danger-color: #FF0000; /* Red */
            --text-color: #FFFFFF;
            --bg-color: #000000;
        }
        body.high-contrast .main-header { background-color: black; border-bottom: 2px solid yellow; }
        body.high-contrast h1, body.high-contrast h2, body.high-contrast h3, body.high-contrast h4 { color: var(--primary-color); }
        body.high-contrast .main-nav a { border: 1px solid yellow; }
        body.high-contrast .main-nav a.active-nav, body.high-contrast .main-nav a:hover { background-color: var(--secondary-color); color: yellow; }
        body.high-contrast .task-box { border-color: yellow; }
        body.high-contrast button, body.high-contrast .btn { background-color: black; color: yellow; border: 1px solid yellow; }
        body.high-contrast input, body.high-contrast textarea, body.high-contrast select { background-color: #333; color: white; border-color: yellow; }

        /* DYSLEXIA FONT */
        body.dyslexia-friendly { font-family: 'OpenDyslexic', sans-serif; }

        /* PAGE NAVIGATION */
        .page-nav { display: flex; justify-content: space-between; margin-top: 30px; border-top: 1px solid var(--medium-grey); padding-top: 20px; }
        .btn { background-color: var(--primary-color); color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; transition: background-color 0.2s; }
        .btn:hover { background-color: var(--secondary-color); }
        .btn:disabled { background-color: var(--medium-grey); cursor: not-allowed; }
        .btn-reset { background-color: var(--warning-color); color: var(--dark-grey); }
        .btn-reset:hover { background-color: #fdd835; }
        
        /* TASK & CONTENT STYLING */
        .task-box { background-color: #f9f9f9; border: 1px solid var(--medium-grey); border-left: 5px solid var(--primary-color); padding: 20px; margin: 20px 0; border-radius: 5px; }
        .learning-outcomes, .key-takeaways { background-color: #e3f2fd; border: 1px solid #90caf9; padding: 15px; margin: 20px 0; border-radius: 5px; }
        .learning-outcomes ul, .key-takeaways ul { list-style-type: '✅'; padding-left: 20px; }
        .learning-outcomes li, .key-takeaways li { padding-left: 10px; }

        /* QUESTION STYLES */
        .question-container { margin-bottom: 20px; }
        .options-list { list-style-type: none; padding: 0; }
        .options-list li { background-color: white; border: 1px solid var(--medium-grey); padding: 10px; margin-bottom: 10px; border-radius: 5px; cursor: pointer; transition: background-color 0.2s, transform 0.1s; }
        .options-list li:hover { background-color: #eef; }
        .options-list li.selected { background-color: #bbdefb; border-color: var(--primary-color); }
        .options-list li.correct { background-color: #C8E6C9; border-color: var(--accent-color); }
        .options-list li.incorrect { background-color: #FFCDD2; border-color: var(--danger-color); }
        .options-list li.disabled { pointer-events: none; opacity: 0.7; }
        input[type="text"], textarea, select { width: 95%; padding: 10px; font-size: 1em; border: 1px solid var(--medium-grey); border-radius: 4px; font-family: inherit; }
        textarea { resize: vertical; }
        .fill-in-the-blank-container { display: flex; flex-wrap: wrap; align-items: center; gap: 10px; }
        .fill-in-the-blank-container p { margin: 0; }
        .blank-options { display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; background: #f0f0f0; border-radius: 5px; margin-top: 10px; }
        .blank-option { background: white; border: 1px solid var(--primary-color); padding: 5px 10px; border-radius: 15px; cursor: pointer; }
        .blank-option:hover { background: #e0e0ff; }
        .blank-input { border: none; border-bottom: 2px solid var(--primary-color); padding: 5px; text-align: center; width: 120px; background: #f9f9f9; }

        /* DRAG AND DROP */
        .drag-item { background-color: #4fc3f7; color: white; padding: 10px; margin: 5px; border-radius: 5px; cursor: grab; user-select: none; text-align: center; }
        .drop-zone { border: 2px dashed var(--primary-color); padding: 10px; margin: 10px 0; min-height: 50px; border-radius: 5px; background-color: white; transition: background-color 0.2s; }
        .drop-zone.hover { background-color: #e3f2fd; }
        
        /* SIMULATIONS */
        .simulation-container { position: relative; background: #e0f7fa; border: 1px solid #4dd0e1; padding: 20px; border-radius: 8px; text-align: center; }
        
        /* E-Waste Sim v2 */
        #ewaste-sim-visual { height: 300px; background: linear-gradient(#a1d3f7, #87CEEB); position: relative; overflow: hidden; border: 1px solid var(--dark-grey); border-radius: 5px; }
        #ewaste-landfill { position: absolute; bottom: 80px; left: 0; width: 100%; height: 220px; }
        #ewaste-ground-surface { position: absolute; top: 0; width: 100%; height: 5px; background: #a07a53; }
        #ewaste-soil { position: absolute; top: 5px; width: 100%; height: 75px; background: #8B4513; }
        #water-table { position: absolute; bottom: 0; width: 100%; height: 80px; background: #1E90FF; transition: background-color 1s ease-in-out; }
        #ewaste-pile-v2 { position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); width: 10px; height: 5px; background: #5a4f41; border-radius: 5px; transition: all 0.5s ease-out; }
        #ewaste-items-v2 { margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
        #ewaste-items-v2 .drag-item { background-color: var(--secondary-color); }
        .drag-item.dragging { opacity: 0.5; }

        /* Energy Sim v2 */
        #energy-sim-v2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .sim-controls, .sim-outputs { background: white; padding: 15px; border-radius: 5px; border: 1px solid var(--medium-grey); }
        .sim-controls h4, .sim-outputs h4 { margin-top: 0; }
        #energy-sim-v2 .btn { width: 100%; margin-top: 10px; }
        .output-metric { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 1.1em; }
        .output-metric span:last-child { font-weight: bold; color: var(--primary-color); }
        #co2-visual-v2 { position: relative; width: 100%; height: 100px; grid-column: 1 / -1; }
        #factory-img-v2 { width: 80px; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); }
        #co2-cloud-v2 { position: absolute; top: 0; left: 50%; transform: translateX(-20%); width: 40px; height: 40px; background: #b0bec5; border-radius: 50%; opacity: 0; transform-origin: bottom center; transition: transform 0.5s, opacity 0.5s; }

        /* Mining Sim v2 */
        #mining-sim-v2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .mining-dashboard-card { background: white; padding: 15px; border-radius: 5px; border: 1px solid var(--medium-grey); }
        .mining-dashboard-card h4 { margin-top: 0; }
        .resource-bar-container { margin: 5px 0 15px; background: var(--medium-grey); border-radius: 5px; overflow: hidden; }
        .resource-bar { height: 25px; text-align: right; color: white; padding-right: 5px; line-height: 25px; transition: width 0.3s; white-space: nowrap; }
        #rare-earths-bar { background: #42a5f5; }
        #water-bar { background: #1E90FF; }
        #damage-bar-v2 { background: var(--danger-color); }
        .component-inventory span { display: block; font-size: 1.2em; text-align: center; }
        
        /* Writing Scorer */
        #writingScorer { border: 1px solid var(--medium-grey); padding: 15px; border-radius: 8px; margin-top: 20px; }
        #resultsDashboard { margin-top: 20px; border: 1px solid #eee; padding: 15px; border-radius: 8px; animation: fadeIn 0.5s; display: flex; gap: 20px; align-items: center; }
        #scoreCircle { width: 100px; height: 100px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 2em; font-weight: bold; border: 8px solid var(--medium-grey); transition: border-color 0.5s; }
        #feedbackLists { flex-grow: 1; }
        #successList, #improvementList { list-style: none; padding-left: 0; }
        #successList li::before { content: '✔️ '; margin-right: 8px; }
        #improvementList li::before { content: '❌ '; margin-right: 8px; }
        #improvementList li.suggestion::before { content: '💡 '; }

        /* GENERAL UTILITIES */
        .hidden { display: none; }
        .feedback { padding: 10px; margin-top: 10px; border-radius: 4px; font-weight: bold; }
        .feedback.correct { background-color: #C8E6C9; color: var(--accent-dark); }
        .feedback.incorrect { background-color: #FFCDD2; color: var(--danger-color); }
        .shame-message { color: red; font-weight: bold; text-align: center; padding: 10px; background-color: #ffcdd2; border: 1px solid red; border-radius: 5px; margin-top: 10px; }
        .hint-container { margin-top: 10px; }
        .hint-button { background: none; border: none; color: var(--primary-color); cursor: pointer; text-decoration: underline; }
        .hint-text { background-color: #fffbe6; border: 1px solid #ffe58f; padding: 10px; border-radius: 4px; font-style: italic; }
        
        /* POPUPS and MODALS */
        .popup-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0s 0.3s; }
        .popup-overlay.visible { opacity: 1; visibility: visible; transition: opacity 0.3s; }
        .popup-content { background: white; padding: 30px; border-radius: 10px; text-align: center; transform: scale(0.7); transition: transform 0.3s; }
        .popup-overlay.visible .popup-content { transform: scale(1); }
        #achievement-popup .popup-content { background: linear-gradient(135deg, var(--primary-color), var(--accent-color)); color: white; }
        #achievement-popup h3 { color: white; }
        #achievement-icon { font-size: 4em; }
        
        /* FEEDBACK BUTTON */
        #feedback-button { position: fixed; bottom: 20px; right: 20px; width: 50px; height: 50px; background-color: var(--danger-color); color: white; border: none; border-radius: 50%; font-size: 24px; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.2); z-index: 999; display: flex; justify-content: center; align-items: center; }
    </style>
</head>
<body>

    <!-- ======== HEADER & STATUS BAR ======== -->
    <header class="main-header">
        <div class="status-bar">
            <span>LVL: <span id="level-badge">1</span></span>
            <div class="xp-bar-container">
                <div id="xp-bar" class="xp-bar"></div>
            </div>
            <span id="xp-text">0/100 XP</span>
        </div>
        <nav class="main-nav">
            <ul id="main-nav-list"></ul>
        </nav>
    </header>

    <!-- ======== ACCESSIBILITY CONTROLS ======== -->
    <div class="accessibility-controls">
        <div class="control-group"> <label for="font-size-control">Font Size:</label> <button id="font-decrease-btn">-</button> <button id="font-increase-btn">+</button> </div>
        <div class="control-group"> <label for="contrast-toggle">High Contrast:</label> <button id="contrast-toggle">Toggle</button> </div>
        <div class="control-group"> <label for="dyslexia-toggle">Dyslexia Font:</label> <button id="dyslexia-toggle">Toggle</button> </div>
    </div>

    <div class="container" id="main-container">

        <!-- ======== PAGE 0: INTRODUCTION ======== -->
        <div id="page-0" class="page">
            <h1>Welcome to Environmental Issues in CS</h1>
            <p>This worksheet explores the impact of digital technology on our planet. As we rely more on computers, it's crucial to understand their hidden environmental costs. This aligns with the <strong>OCR J277 GCSE Computer Science specification (1.5)</strong>.</p>
            <div class="learning-outcomes">
                <h4>Learning Outcomes</h4>
                <ul>
                    <li>Identify the main environmental impacts of digital technology.</li>
                    <li>Explain the consequences of e-waste, energy consumption, and resource mining.</li>
                    <li>Analyse how data centres contribute to a large carbon footprint.</li>
                    <li>Evaluate strategies to make technology more sustainable.</li>
                </ul>
            </div>
            <div class="task-box">
                <h3>Starter Activity: Fact or Fiction?</h3>
                <p>Let's test your current knowledge. Are the following statements fact or fiction? Click your answer.</p>
                <div id="starter-quiz-container"></div>
                <div class="button-container" style="margin-top:20px;">
                    <button class="btn" id="check-starter-btn">Check Answers</button>
                    <button class="btn btn-reset" onclick="lesson.resetTask('starter-quiz')">Reset</button>
                </div>
            </div>
        </div>

        <!-- ======== PAGE 1: ELECTRONIC WASTE ======== -->
        <div id="page-1" class="page">
            <h2>1. Electronic Waste (E-Waste)</h2>
            <p>E-waste is the term for discarded electronic devices. When not disposed of properly, these items can be incredibly harmful. They contain toxic chemicals like <strong>lead, mercury, and cadmium</strong> that can leak into the ground and contaminate soil and water supplies, harming ecosystems and human health.</p>

            <div class="task-box">
                <h3>Simulation: The E-Waste Mountain</h3>
                <p>Drag the electronic items from the conveyor belt into the landfill. Watch how the pile grows and contaminates the water table below.</p>
                <div class="simulation-container">
                    <div id="ewaste-sim-visual">
                        <div id="ewaste-landfill" class="drop-zone">
                             <div id="ewaste-ground-surface"></div>
                             <div id="ewaste-soil"></div>
                             <div id="water-table"></div>
                        </div>
                        <div id="ewaste-pile-v2"></div>
                    </div>
                    <div id="ewaste-items-v2">
                        <div class="drag-item" draggable="true" data-item="phone">📱 Smartphone</div>
                        <div class="drag-item" draggable="true" data-item="laptop">💻 Laptop</div>
                        <div class="drag-item" draggable="true" data-item="battery">🔋 Battery</div>
                        <div class="drag-item" draggable="true" data-item="monitor">🖥️ Old Monitor</div>
                        <div class="drag-item" draggable="true" data-item="cables">🔌 Cables</div>
                    </div>
                </div>
                 <div class="button-container" style="margin-top:20px;">
                    <button class="btn btn-reset" onclick="lesson.resetTask('ewaste-sim')">Reset Simulation</button>
                </div>
                <h4>Reflection Questions</h4>
                <p>After using the simulation, answer this question:</p>
                <div class="question-container">
                     <label for="ewaste-reflection">In your own words, why is simply throwing away old electronics a bad idea? (Aim for 15+ words)</label>
                     <textarea id="ewaste-reflection" rows="3" data-keywords="toxic,harmful,chemicals,leak,contaminate,soil,water,environment,pollute" onpaste="return false;"></textarea>
                     <button class="btn" onclick="lesson.checkShortAnswer('ewaste-reflection', 15)">Submit Answer</button>
                     <div id="ewaste-reflection-feedback" class="feedback hidden"></div>
                </div>
            </div>
        </div>

        <!-- ======== PAGE 2: ENERGY & CARBON FOOTPRINT ======== -->
        <div id="page-2" class="page">
            <h2>2. Energy Consumption & Carbon Footprint</h2>
            <p>Every online action requires energy, primarily consumed by <strong>data centres</strong>. Powering and cooling these servers uses massive amounts of electricity, which releases <strong>greenhouse gases</strong> (like CO₂) and contributes to our <strong>carbon footprint</strong>.</p>
            
            <div class="task-box">
                <h3>Simulation: Powering a Data Centre</h3>
                <p>Configure a data centre and run a task to see its environmental impact. Compare the results of different configurations.</p>
                <div class="simulation-container" id="energy-sim-v2">
                    <div class="sim-controls">
                        <h4>1. Configuration</h4>
                        <label for="power-source">Power Source:</label>
                        <select id="power-source">
                            <option value="coal">Coal Fired Plant</option>
                            <option value="gas">Natural Gas</option>
                            <option value="solar">Solar Farm</option>
                        </select>
                        <label for="cooling-method" style="margin-top:10px; display:block;">Cooling Method:</label>
                        <select id="cooling-method">
                            <option value="air">Standard Air Con</option>
                            <option value="liquid">Liquid Cooling</option>
                        </select>
                    </div>
                     <div class="sim-outputs">
                        <h4>3. Impact per Task</h4>
                        <div class="output-metric"><span>⚡ Energy Used:</span> <span id="energy-output">0 kWh</span></div>
                        <div class="output-metric"><span>💨 CO₂ Emitted:</span> <span id="co2-output">0 kg</span></div>
                        <div class="output-metric"><span>💧 Water Used:</span> <span id="water-output">0 L</span></div>
                    </div>
                    <div class="sim-controls" style="grid-column: 1 / -1;">
                        <h4>2. Run a Service Task</h4>
                        <button class="btn" id="run-streaming-btn">Run: Stream 1M Videos</button>
                        <button class="btn" id="run-ai-btn">Run: Process AI Data</button>
                    </div>
                    <div id="co2-visual-v2">
                         <img id="factory-img-v2" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj4KICA8ZyBmaWxsPSIjNjA3RDhCIj4KICAgIDxyZWN0IHg9IjM1IiB5PSIyMCIgd2lkdGg9IjE1IiBoZWlnaHQ9IjgwIiAvPgogICAgPHBhdGggZD0iTTM1IDIwIEwyMCAzMCBMNTAgMzAgTDY1IDIwIFoiIC8+CiAgICA8cmVjdCB4PSIyMCIgeT0iNzAiIHdpZHRoPSIzMCIgaGVpZ2h0PSIzMCIgLz4KICAgIDxyZWN0IHg9IjU1IiB5PSI1MCIgd2lkdGg9IjMwIiBoZWlnaHQ9IjUwIiAvPgogICAgPHJlY3QgeD0iMjUiIHk9Ijc1IiB3aWR0aD0iNSIgaGVpZ2h0PSI1IiBmaWxsPSIjRkZGOTAwIiAvPgogICAgPHJlY3QgeD0iNjAiIHk9Ijg1IiB3aWR0aD0iNSIgaGVpZ2h0PSI1IiBmaWxsPSIjRkZGOTAwIiAvPgogICAgPHJlY3QgeD0iNzUiIHk9Ijc1IiB3aWR0aD0iNSIgaGVpZ2h0PSI1IiBmaWxsPSIjRkZGOTAwIiAvPgogIDwvZz4KPC9zdmc+Cg==" alt="Factory"/>
                         <div id="co2-cloud-v2"></div>
                    </div>
                </div>
                 <div class="button-container" style="margin-top:20px;">
                    <button class="btn btn-reset" onclick="lesson.resetTask('energy-sim')">Reset Simulation</button>
                </div>
            </div>

            <div class="task-box">
                <h3>Task: Fill in the Blanks</h3>
                <p>Complete the sentences below by dragging the correct words into the blanks, or by typing them in.</p>
                <div id="energy-fill-blanks-container" class="fill-in-the-blank-container"></div>
                <div id="energy-fill-blanks-options" class="blank-options"></div>
                <div class="button-container" style="margin-top:20px;">
                    <button class="btn" id="check-energy-blanks-btn">Check Answers</button>
                    <button class="btn btn-reset" onclick="lesson.resetTask('energy-blanks')">Reset</button>
                </div>
                <div id="energy-blanks-feedback" class="feedback hidden"></div>
            </div>
        </div>

        <!-- ======== PAGE 3: RESOURCE MINING ======== -->
        <div id="page-3" class="page">
            <h2>3. Mining for Rare Earth Materials</h2>
            <p>Your devices are made from materials mined from the earth. Many require <strong>rare earth materials</strong>. This process is destructive, depletes finite resources, and consumes large amounts of water.</p>

            <div class="task-box">
                <h3>Simulation: Smartphone Factory</h3>
                <p>Your goal is to assemble as many phones as possible before resources run out. A phone requires 1 CPU, 1 Battery, and 1 Screen. Choose wisely what to manufacture!</p>
                <div class="simulation-container" id="mining-sim-v2">
                    <div class="mining-dashboard-card">
                        <h4>Resources</h4>
                        <label>Rare Earths:</label>
                        <div class="resource-bar-container"><div id="rare-earths-bar" class="resource-bar" style="width: 100%;">1000 units</div></div>
                        <label>Fresh Water:</label>
                        <div class="resource-bar-container"><div id="water-bar" class="resource-bar" style="width: 100%;">1000 units</div></div>
                    </div>
                    <div class="mining-dashboard-card">
                        <h4>Manufacturing</h4>
                        <button class="btn" id="make-cpu-btn">Make CPU <small>(-10 Earth, -20 Water)</small></button>
                        <button class="btn" id="make-battery-btn" style="margin-top:10px;">Make Battery <small>(-25 Earth, -5 Water)</small></button>
                        <button class="btn" id="make-screen-btn" style="margin-top:10px;">Make Screen <small>(-5 Earth, -15 Water)</small></button>
                    </div>
                    <div class="mining-dashboard-card">
                         <h4>Inventory</h4>
                         <div class="component-inventory">
                            <p>CPUs: <span id="cpu-inv">0</span></p>
                            <p>Batteries: <span id="battery-inv">0</span></p>
                            <p>Screens: <span id="screen-inv">0</span></p>
                         </div>
                    </div>
                     <div class="mining-dashboard-card" style="grid-column: 1 / -1;">
                        <h4>Results</h4>
                        <p style="font-size: 1.5em; text-align:center;">📱 Phones Assembled: <strong id="phones-assembled">0</strong></p>
                        <label>Total Environmental Damage:</label>
                        <div class="resource-bar-container"><div id="damage-bar-v2" class="resource-bar" style="width: 0%;">0%</div></div>
                    </div>
                </div>
                <div class="button-container" style="margin-top:20px;">
                    <button class="btn btn-reset" onclick="lesson.resetTask('mining-sim')">Reset Simulation</button>
                </div>
            </div>
            
            <div class="task-box">
                <h3>Task: Device Lifecycle Sequencing</h3>
                <p>The creation and disposal of a device follows a cycle. Drag and drop the following stages into the correct order from start to finish.</p>
                <div id="lifecycle-sequencing-container">
                    <div id="lifecycle-drop-zones" class="drop-zones"></div>
                    <div id="lifecycle-drag-items" class="drag-items"></div>
                </div>
                <div class="button-container" style="margin-top:20px;">
                    <button class="btn" id="check-lifecycle-btn">Check Order</button>
                    <button class="btn btn-reset" onclick="lesson.resetTask('lifecycle-sequence')">Reset</button>
                </div>
                 <div id="lifecycle-feedback" class="feedback hidden"></div>
            </div>
        </div>

        <!-- ======== PAGE 4: WATER CONSUMPTION ======== -->
        <div id="page-4" class="page">
            <h2>4. Water Consumption</h2>
            <p>Manufacturing a single microchip can require thousands of litres of ultra-pure water. This significant water consumption contributes to global <strong>water scarcity</strong> issues. This "water footprint" is one of the less obvious but highly significant environmental impacts of technology.</p>
            <div class="task-box">
                <h3>Task: True or False?</h3>
                <p>Read the statements about water consumption in tech and decide if they are true or false.</p>
                <div id="water-tf-container"></div>
                <div class="button-container" style="margin-top:20px;">
                    <button class="btn" id="check-water-tf-btn">Check Answers</button>
                    <button class="btn btn-reset" onclick="lesson.resetTask('water-tf')">Reset</button>
                </div>
            </div>
            <div class="task-box">
                <h3>Real World Context & Common Mistakes</h3>
                <h4>Real World: The Aral Sea</h4>
                <p>While not directly caused by tech, the shrinking of the Aral Sea is a powerful example of how diverting water for industrial and agricultural purposes can lead to environmental catastrophe. The same principles apply to the large-scale water use in semiconductor fabrication plants.</p>
                <h4>Common Mistake: Forgetting Manufacturing</h4>
                <p>Students often focus on the electricity used when a device is *on*. They forget that the environmental impact starts long before you unbox your new gadget. The manufacturing phase, with its huge water and energy requirements, is a massive part of a device's total lifecycle impact.</p>
            </div>
        </div>

        <!-- ======== PAGE 5: SUMMARY & QUIZ ======== -->
        <div id="page-5" class="page">
            <h2>5. Lesson Summary & Knowledge Check</h2>
            <div class="key-takeaways">
                <h4>Key Takeaways</h4>
                <ul>
                    <li><b>E-waste</b> pollutes soil and water with toxic chemicals.</li>
                    <li><b>Data centres</b> use vast amounts of energy, increasing our collective carbon footprint.</li>
                    <li>Mining for <b>rare earth materials</b> damages landscapes and depletes finite resources.</li>
                    <li>Hardware manufacturing consumes significant quantities of <b>fresh water</b>.</li>
                    <li>The environmental impact of a device covers its entire <b>lifecycle</b>, from creation to disposal.</li>
                </ul>
            </div>
            <div class="task-box">
                <h3>Final Quiz</h3>
                <p>Answer these questions to see what you've learned. This will test your knowledge from all sections.</p>
                <div id="final-quiz-container"></div>
                 <div class="button-container" style="margin-top:20px;">
                    <button class="btn" id="check-final-quiz-btn">Submit Quiz</button>
                    <button class="btn btn-reset" onclick="lesson.resetTask('final-quiz')">Reset</button>
                </div>
                <div id="final-quiz-feedback" class="feedback hidden"></div>
            </div>
        </div>
        
        <!-- ======== PAGE 6: EXAM PRACTICE ======== -->
        <div id="page-6" class="page">
            <h2>6. Exam Practice (OCR Style)</h2>
            <div class="task-box">
                <h3>Question 1 (4 marks)</h3>
                <p>Describe two environmental issues related to the disposal of old computer equipment.</p>
                <textarea id="exam-q1" rows="5" placeholder="Describe the first issue... then the second issue..." onpaste="return false;"></textarea>
                <div style="text-align: right; margin-top: 10px;"> Predicted Marks: <input type="number" min="0" max="4" style="width: 50px;"> / 4 </div>
                <button class="btn" id="reveal-mark-scheme-1">Check Mark Scheme</button>
                <div id="mark-scheme-1" class="hidden" style="margin-top: 15px; background: #f0f0f0; padding: 10px; border-radius: 5px;">
                    <h4>Mark Scheme:</h4>
                    <ul>
                        <li>(1 mark) Issue identified: E-waste contains harmful/toxic chemicals (e.g., lead/mercury).</li>
                        <li>(1 mark) Description: These can leak/leach into the ground/soil.</li>
                        <li>(1 mark) Consequence: This contaminates soil and water sources, harming wildlife/humans.</li>
                        <li>(1 mark) Issue identified: Many components are non-biodegradable and take up landfill space.</li>
                    </ul>
                </div>
            </div>
            <div class="task-box">
                <h3>Question 2 (8 marks)</h3>
                <p>“The increasing use of cloud storage and video streaming services is the biggest environmental threat from modern computing.” Discuss this statement.</p>
                <div id="writingScorer">
                    <div>
                        <label for="studentAnswer">Enter your answer:</label>
                        <textarea id="studentAnswer" rows="10" placeholder="Start your discussion here..." onpaste="return false;"></textarea>
                        <input type="hidden" id="keywords" value="data centre,energy,electricity,cooling,fossil fuels,carbon footprint,streaming,cloud,e-waste,mining,water,manufacturing,lifecycle">
                        <button id="analyzeBtn" class="btn">Check My Writing Structure</button>
                    </div>
                    <div id="resultsDashboard" style="display: none;">
                         <div id="scoreCircle"><span id="scoreValue">0</span></div>
                         <div id="feedbackLists">
                             <h4>Successes:</h4> <ul id="successList"></ul>
                             <h4>Areas for Improvement:</h4> <ul id="improvementList"></ul>
                         </div>
                    </div>
                </div>
                 <div style="text-align: right; margin-top: 10px;"> Predicted Marks: <input type="number" min="0" max="8" style="width: 50px;"> / 8 </div>
                <button class="btn" id="reveal-mark-scheme-2">Check Mark Scheme</button>
                <div id="mark-scheme-2" class="hidden" style="margin-top: 15px; background: #f0f0f0; padding: 10px; border-radius: 5px;">
                    <h4>Mark Scheme Guide:</h4>
                     <p><b>Level 3 (6-8 marks):</b> A thorough discussion of both sides. Considers multiple points for and against. A justified conclusion is drawn. Good use of specialist terms.</p>
                     <p><b>Level 2 (3-5 marks):</b> Discusses both sides but may be unbalanced. A simple conclusion is attempted.</p>
                     <p><b>Level 1 (1-2 marks):</b> A limited, often one-sided answer. Points are listed rather than explained.</p>
                     <p><b>Points for (Agreeing):</b> Data centres require huge, constant electricity for power/cooling; often from fossil fuels; demand is growing.</p>
                     <p><b>Points against (Other threats):</b> Device manufacturing (mining, water) has a huge upfront cost; E-waste causes toxic pollution; some data centres are moving to renewables.</p>
                </div>
            </div>
        </div>

        <!-- ======== PAGE 7: EXTENSION & RESOURCES ======== -->
        <div id="page-7" class="page">
            <h2>7. Extension and Further Resources</h2>
            <div class="task-box">
                <h3>Extension Activity: The Circular Economy</h3>
                <p>The "circular economy" is a model that aims to eliminate waste by reusing, repairing, and recycling materials. Propose one practical idea for how a smartphone company could apply this principle.</p>
                <textarea id="extension-answer" rows="4" data-keywords="repair,modular,recycle,battery,re-use,sustainable,upgradeable,standardised" onpaste="return false;"></textarea>
                <button class="btn" onclick="lesson.checkShortAnswer('extension-answer', 20)">Submit Idea</button>
                <div id="extension-answer-feedback" class="feedback hidden"></div>
            </div>
            <div class="task-box">
                <h3>Further Resources (Placeholders)</h3>
                <ul>
                    <li><b>Video 1:</b> The Problem with E-Waste</li> <li><b>Video 2:</b> Inside a Google Data Centre</li>
                </ul>
            </div>
            <div id="easter-egg-container" style="text-align:center; margin-top: 30px;">
                <span id="easter-egg" style="cursor: pointer; font-size: 0.8em; color: var(--medium-grey);">© 2025 Green Tech Education</span>
            </div>
        </div>
    </div>

    <!-- ======== PAGE NAVIGATION BUTTONS ======== -->
    <div class="container"> <div class="page-nav"> <button id="prev-btn" class="btn">Previous</button> <button id="next-btn" class="btn">Next</button> </div> </div>
    
    <!-- ======== POPUPS & MODALS ======== -->
    <div id="achievement-popup" class="popup-overlay">
        <div class="popup-content">
            <div id="achievement-icon">🏆</div> <h3>Achievement Unlocked!</h3>
            <p id="achievement-title"></p> <p id="achievement-desc"></p>
        </div>
    </div>
    <button id="feedback-button" title="Report a bug or suggest a feature">🐞</button>
    <div id="feedback-modal" class="popup-overlay">
        <div class="popup-content">
            <h3>Send Feedback</h3>
            <form id="feedback-form">
                <input type="hidden" id="feedback-page-info">
                <textarea id="feedback-text" rows="5" placeholder="Please be as detailed as possible..." style="width: 95%;"></textarea>
                <button type="submit" class="btn" style="margin-top:10px;">Send Feedback</button>
                <button type="button" id="close-feedback-modal" class="btn btn-reset">Cancel</button>
            </form>
        </div>
    </div>


    <script>
    // OCR J277 - Environmental Issues Worksheet -- JavaScript
    // Generated by Google Gemini (v2)

    const lesson = {
        gameState: {
            currentPage: 0, xp: 0, level: 1,
            achievements: new Set(), tasksCompleted: new Set(),
        },
        config: {
            pages: [], pageTitles: ["Intro", "E-Waste", "Energy", "Mining", "Water", "Quiz", "Exam", "Resources"],
            xpLevels: [0, 100, 250, 450, 650, 900],
            achievements: {
                "ewaste-master": { title: "Contamination Crisis", desc: "You've seen the effects of e-waste." },
                "energy-saver": { title: "Energy Analyst", desc: "You've run a data centre simulation." },
                "resourceful": { title: "Resourceful", desc: "You've managed a factory's resources." },
                "green-coder": { title: "Green Coder", desc: "Completed all core learning sections." },
                "quiz-whiz": { title: "Top of the Class", desc: "Scored over 80% on the final quiz." },
                "essay-expert": { title: "Essay Expert", desc: "Scored over 75 on the writing checker." },
                "easter-egg": { title: "Easter Egg Hunter", desc: "You found the hidden secret!" },
            },
        },

        init: function() {
            document.addEventListener('DOMContentLoaded', this.onDomReady.bind(this));
        },

        onDomReady: function() {
            this.cacheDOMElements();
            this.setupEventListeners();
            this.populateNav();
            this.populateQuizzes();
            this.updateUI();
            this.dom.pages[0].classList.add('active');
            this.dom.mainContainer.addEventListener('touchstart', this.handleTouchStart.bind(this), false);
            this.dom.mainContainer.addEventListener('touchmove', this.handleTouchMove.bind(this), false);
            this.initEwasteSim();
            this.initEnergySim();
            this.initMiningSim();
            this.initSequencingTask();
            this.initFillBlanks();
            this.initWritingScorer();
        },
        
        cacheDOMElements: function() {
            this.dom = {
                mainContainer: document.getElementById('main-container'),
                pages: document.querySelectorAll('.page'),
                prevBtn: document.getElementById('prev-btn'), nextBtn: document.getElementById('next-btn'),
                navlist: document.getElementById('main-nav-list'),
                xpBar: document.getElementById('xp-bar'), xpText: document.getElementById('xp-text'), levelBadge: document.getElementById('level-badge'),
                achievementPopup: document.getElementById('achievement-popup'), achievementTitle: document.getElementById('achievement-title'), achievementDesc: document.getElementById('achievement-desc'),
                fontIncreaseBtn: document.getElementById('font-increase-btn'), fontDecreaseBtn: document.getElementById('font-decrease-btn'),
                contrastToggle: document.getElementById('contrast-toggle'), dyslexiaToggle: document.getElementById('dyslexia-toggle'),
                feedbackBtn: document.getElementById('feedback-button'), feedbackModal: document.getElementById('feedback-modal'),
                closeFeedbackModal: document.getElementById('close-feedback-modal'), feedbackForm: document.getElementById('feedback-form'),
            };
            this.config.pages = Array.prototype.slice.call(this.dom.pages);
        },

        setupEventListeners: function() {
            this.dom.prevBtn.addEventListener('click', this.prevPage.bind(this));
            this.dom.nextBtn.addEventListener('click', this.nextPage.bind(this));
            this.dom.navlist.addEventListener('click', this.handleNavClick.bind(this));
            this.dom.achievementPopup.addEventListener('click', this.hideAchievement.bind(this));
            this.dom.fontIncreaseBtn.addEventListener('click', this.changeFontSize.bind(this, 1));
            this.dom.fontDecreaseBtn.addEventListener('click', this.changeFontSize.bind(this, -1));
            this.dom.contrastToggle.addEventListener('click', this.toggleContrast.bind(this));
            this.dom.dyslexiaToggle.addEventListener('click', this.toggleDyslexiaFont.bind(this));
            this.dom.feedbackBtn.addEventListener('click', this.showFeedbackModal.bind(this));
            this.dom.closeFeedbackModal.addEventListener('click', this.hideFeedbackModal.bind(this));
            this.dom.feedbackForm.addEventListener('submit', this.sendFeedback.bind(this));
            document.getElementById('reveal-mark-scheme-1').addEventListener('click', this.revealMarkScheme.bind(this, 'exam-q1', 'mark-scheme-1'));
            document.getElementById('reveal-mark-scheme-2').addEventListener('click', this.revealMarkScheme.bind(this, 'studentAnswer', 'mark-scheme-2'));
            document.getElementById('check-starter-btn').addEventListener('click', this.checkQuiz.bind(this, 'starter-quiz'));
            document.getElementById('check-energy-blanks-btn').addEventListener('click', this.checkFillBlanks.bind(this));
            document.getElementById('check-lifecycle-btn').addEventListener('click', this.checkSequence.bind(this));
            document.getElementById('check-water-tf-btn').addEventListener('click', this.checkQuiz.bind(this, 'water-tf'));
            document.getElementById('check-final-quiz-btn').addEventListener('click', this.checkQuiz.bind(this, 'final-quiz'));
            document.getElementById('easter-egg').addEventListener('click', this.triggerEasterEgg.bind(this));
            const inputs = document.querySelectorAll('textarea, input[type="text"]');
            for(let i=0; i < inputs.length; i++){ inputs[i].addEventListener('paste', this.showPasteMessage.bind(this)); }
        },

        goToPage: function(pageIndex) {
            if (pageIndex < 0 || pageIndex >= this.config.pages.length) return;
            this.dom.pages[this.gameState.currentPage].classList.remove('active');
            this.gameState.currentPage = pageIndex;
            this.dom.pages[this.gameState.currentPage].classList.add('active');
            window.scrollTo(0, 0); this.updateUI();
        },
        nextPage: function() { this.goToPage(this.gameState.currentPage + 1); },
        prevPage: function() { this.goToPage(this.gameState.currentPage - 1); },
        handleNavClick: function(e) {
            e.preventDefault();
            if (e.target.tagName === 'A') { this.goToPage(parseInt(e.target.getAttribute('data-index'), 10)); }
        },
        touchStartX: 0, touchEndX: 0,
        handleTouchStart: function(evt) { this.touchStartX = evt.changedTouches[0].screenX; },
        handleTouchMove: function(evt) { this.touchEndX = evt.changedTouches[0].screenX; if (Math.abs(this.touchStartX - this.touchEndX) > 10) { this.handleSwipe(); } },
        handleSwipe: function() {
            if (this.touchEndX < this.touchStartX - 50) { this.nextPage(); this.resetTouches(); }
            if (this.touchEndX > this.touchStartX + 50) { this.prevPage(); this.resetTouches(); }
        },
        resetTouches: function() { this.touchStartX = 0; this.touchEndX = 0; },

        updateUI: function() {
            this.dom.prevBtn.disabled = this.gameState.currentPage === 0;
            this.dom.nextBtn.disabled = this.gameState.currentPage === this.config.pages.length - 1;
            const navLinks = this.dom.navlist.querySelectorAll('a');
            navLinks.forEach((link, i) => {
                link.classList.toggle('active-nav', i === this.gameState.currentPage);
            });
            const currentLevelXp = this.config.xpLevels[this.gameState.level - 1];
            const nextLevelXp = this.config.xpLevels[this.gameState.level];
            const xpInLevel = this.gameState.xp - currentLevelXp;
            const xpForLevel = nextLevelXp - currentLevelXp;
            const xpPercentage = Math.min(100, (xpInLevel / xpForLevel) * 100);
            this.dom.xpBar.style.width = xpPercentage + '%';
            this.dom.xpText.textContent = this.gameState.xp + ' / ' + nextLevelXp + ' XP';
            this.dom.levelBadge.textContent = this.gameState.level;
        },
        addXP: function(amount, taskID) {
            if (this.gameState.tasksCompleted.has(taskID)) return;
            this.gameState.xp += amount;
            this.gameState.tasksCompleted.add(taskID);
            this.checkLevelUp(); this.updateUI();
        },
        checkLevelUp: function() {
            const currentLevel = this.gameState.level;
            if (currentLevel >= this.config.xpLevels.length-1) return;
            const nextLevelXp = this.config.xpLevels[currentLevel];
            if (this.gameState.xp >= nextLevelXp) {
                this.gameState.level++;
                this.showAchievement("level-up", { title: "Level Up!", desc: "You've reached Level " + this.gameState.level + "!" });
            }
        },
        triggerAchievement: function(id) {
            if (this.gameState.achievements.has(id)) return;
            this.gameState.achievements.add(id);
            const achievement = this.config.achievements[id];
            this.showAchievement(id, achievement);
            this.addXP(50, 'achievement-' + id);
        },
        showAchievement: function(id, achievementData) {
            this.dom.achievementTitle.textContent = achievementData.title;
            this.dom.achievementDesc.textContent = achievementData.desc;
            this.dom.achievementPopup.classList.add('visible');
            if(window.navigator.vibrate) { window.navigator.vibrate(100); }
            setTimeout(this.hideAchievement.bind(this), 4000);
        },
        hideAchievement: function() { this.dom.achievementPopup.classList.remove('visible'); },
        populateNav: function() {
            this.dom.navlist.innerHTML = this.config.pageTitles.map((title, i) => `<li><a href="#" data-index="${i}">${title}</a></li>`).join('');
        },

        changeFontSize: function(delta) {
            let currentRootSize = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--font-size'));
            document.documentElement.style.setProperty('--font-size', (currentRootSize + delta) + 'px');
        },
        toggleContrast: function() { document.body.classList.toggle('high-contrast'); },
        toggleDyslexiaFont: function() { document.body.classList.toggle('dyslexia-friendly'); },

        quizData: {
            'starter-quiz': [
                { q: "A typical smartphone contains over 60 different elements.", a: "Fact", type: "tf" },
                { q: "Data centres use less energy than the entire airline industry.", a: "Fiction", type: "tf" },
                { q: "Recycling one million laptops saves energy equivalent to powering over 3,500 homes for a year.", a: "Fact", type: "tf" }
            ],
            'water-tf': [
                 { q: "Manufacturing a computer uses less water than making a cup of coffee.", a: "False", type: "tf" },
                 { q: "Water used in chip manufacturing must be purer than drinking water.", a: "True", type: "tf" },
                 { q: "Most of a computer's water footprint comes from the user washing their hands.", a: "False", type: "tf" }
            ],
            'final-quiz': [
                { q: "Which of these is a harmful chemical commonly found in e-waste?", a: "Mercury", o: ["Sodium", "Oxygen", "Carbon Dioxide"], type: "mcq" },
                { q: "The total amount of greenhouse gases produced is called:", a: "Carbon footprint", o: ["Energy consumption", "Digital footprint", "E-waste"], type: "mcq" },
                { q: "What is the primary reason data centres consume so much energy?", a: "Powering and cooling servers", o: ["Building security systems", "Office lighting", "Wi-Fi for staff"], type: "mcq" },
            ]
        },
        populateQuizzes: function() {
            Object.keys(this.quizData).forEach(key => {
                const container = document.getElementById(key.replace('_', '-') + '-container');
                if (container) this.populateQuiz(key, container.id);
            });
        },
        populateQuiz: function(quizId, containerId) {
            const container = document.getElementById(containerId);
            const questions = this.quizData[quizId];
            container.innerHTML = questions.map((q, i) => {
                let optionsHtml = '';
                if(q.type === 'mcq') {
                    const options = this.shuffleArray([q.a, ...q.o]);
                    optionsHtml = `<ul class="options-list">${options.map(opt => `<li data-answer="${opt}">${opt}</li>`).join('')}</ul>`;
                } else if (q.type === 'tf') {
                    optionsHtml = `<ul class="options-list"><li data-answer="Fact">Fact</li><li data-answer="Fiction">Fiction</li></ul>`;
                }
                return `<div class="question-container" id="${quizId}-q${i}"><p><strong>${i+1}. ${q.q}</strong></p>${optionsHtml}<div class="feedback hidden"></div></div>`;
            }).join('');
            
            container.querySelectorAll('.options-list li').forEach(li => {
                li.addEventListener('click', () => {
                    li.parentNode.querySelectorAll('li').forEach(sib => sib.classList.remove('selected'));
                    li.classList.add('selected');
                });
            });
        },
        checkQuiz: function(quizId) {
            if (this.gameState.tasksCompleted.has(quizId)) return;
            let score = 0;
            const questions = this.quizData[quizId];
            questions.forEach((q, i) => {
                const qContainer = document.getElementById(`${quizId}-q${i}`);
                const selected = qContainer.querySelector('.options-list li.selected');
                qContainer.querySelectorAll('.options-list li').forEach(opt => opt.classList.add('disabled'));
                if (selected && selected.dataset.answer === q.a) {
                    score++;
                    selected.classList.add('correct');
                } else if (selected) {
                    selected.classList.add('incorrect');
                    qContainer.querySelector(`li[data-answer="${q.a}"]`).classList.add('correct');
                }
            });
            
            const finalFeedback = document.getElementById(quizId.replace('_', '-') + '-feedback');
            if (finalFeedback) {
                finalFeedback.innerHTML = `You scored ${score} out of ${questions.length}.`;
                finalFeedback.className = `feedback ${score > questions.length / 2 ? 'correct' : 'incorrect'}`;
                finalFeedback.classList.remove('hidden');
            }
            this.addXP(score * 15, quizId);
            if (quizId === 'final-quiz' && (score / questions.length) >= 0.8) this.triggerAchievement('quiz-whiz');
        },

        showPasteMessage: function(e) {
            let msg = e.target.parentNode.querySelector('.shame-message');
            if(!msg) {
                msg = document.createElement('div');
                msg.className = 'shame-message';
                msg.innerHTML = "Pasting is disabled. Please type your answer.";
                e.target.parentNode.appendChild(msg);
                setTimeout(() => msg.remove(), 4000);
            }
            e.preventDefault();
        },
        checkShortAnswer: function(textareaId, minLength) {
             const textarea = document.getElementById(textareaId), feedbackEl = document.getElementById(`${textareaId}-feedback`), text = textarea.value.toLowerCase().trim();
             if (this.gameState.tasksCompleted.has(textareaId)) return;
             if (text.length < minLength) {
                feedbackEl.innerHTML = 'Please provide a more detailed answer.';
                feedbackEl.className = 'feedback incorrect';
                feedbackEl.classList.remove('hidden');
                return;
             }
             const keywords = (textarea.dataset.keywords || '').split(',');
             let keywordCount = keywords.filter(kw => kw && text.includes(kw)).length;
             const xpGained = 10 + (keywordCount * 5);
             this.addXP(xpGained, textareaId);
             feedbackEl.innerHTML = `Great answer! You used ${keywordCount} key terms. +${xpGained} XP`;
             feedbackEl.className = 'feedback correct';
             feedbackEl.classList.remove('hidden');
             textarea.disabled = true;
        },

        // --- NEW SIMULATIONS ---
        ewasteState: { count: 0, max: 5 },
        initEwasteSim: function() {
            const landfill = document.getElementById('ewaste-landfill');
            const items = document.querySelectorAll('#ewaste-items-v2 .drag-item');
            let draggedItem = null;

            items.forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    draggedItem = e.target;
                    setTimeout(() => e.target.classList.add('dragging'), 0);
                });
                item.addEventListener('dragend', () => draggedItem.classList.remove('dragging'));
            });

            landfill.addEventListener('dragover', e => e.preventDefault());
            landfill.addEventListener('drop', (e) => {
                e.preventDefault();
                if (draggedItem && !draggedItem.classList.contains('dropped')) {
                    draggedItem.classList.add('dropped');
                    draggedItem.style.display = 'none';
                    this.ewasteState.count++;

                    const pile = document.getElementById('ewaste-pile-v2');
                    const water = document.getElementById('water-table');
                    
                    pile.style.width = `${10 + this.ewasteState.count * 25}px`;
                    pile.style.height = `${5 + this.ewasteState.count * 12}px`;

                    const contamination = this.ewasteState.count / this.ewasteState.max;
                    const r = Math.round(30 - (30 * contamination)); // 30 -> 0
                    const g = Math.round(144 - (84 * contamination)); // 144 -> 60
                    const b = Math.round(255 - (200 * contamination)); // 255 -> 55
                    water.style.backgroundColor = `rgb(${r}, ${g}, ${b})`;
                    
                    if (this.ewasteState.count === this.ewasteState.max) {
                         this.addXP(30, 'ewaste-sim');
                         this.triggerAchievement('ewaste-master');
                    }
                }
            });
        },
        
        energyState: { costs: {
            tasks: { stream: { energy: 4000, water: 500 }, ai: { energy: 15000, water: 2000 } },
            power: { coal: { co2: 0.9, water: 2 }, gas: { co2: 0.4, water: 1 }, solar: { co2: 0, water: 0.5 } },
            cooling: { air: { energy_mod: 1.25, water: 0 }, liquid: { energy_mod: 1.05, water: 1000 } }
        }},
        initEnergySim: function() {
            document.getElementById('run-streaming-btn').addEventListener('click', () => this.runEnergyTask('stream'));
            document.getElementById('run-ai-btn').addEventListener('click', () => this.runEnergyTask('ai'));
        },
        runEnergyTask: function(taskType) {
            const powerSrc = document.getElementById('power-source').value;
            const coolingMethod = document.getElementById('cooling-method').value;

            const baseEnergy = this.energyState.costs.tasks[taskType].energy;
            const baseWater = this.energyState.costs.tasks[taskType].water;
            
            const totalEnergy = baseEnergy * this.energyState.costs.cooling[coolingMethod].energy_mod;
            const totalCO2 = totalEnergy * this.energyState.costs.power[powerSrc].co2;
            const totalWater = baseWater + this.energyState.costs.power[powerSrc].water * baseEnergy/1000 + this.energyState.costs.cooling[coolingMethod].water;

            document.getElementById('energy-output').textContent = `${Math.round(totalEnergy)} kWh`;
            document.getElementById('co2-output').textContent = `${Math.round(totalCO2)} kg`;
            document.getElementById('water-output').textContent = `${Math.round(totalWater)} L`;

            const co2Cloud = document.getElementById('co2-cloud-v2');
            const co2Scale = Math.min(5, totalCO2 / 3000); // Max scale based on AI on coal
            co2Cloud.style.opacity = Math.min(1, co2Scale);
            co2Cloud.style.transform = `translateX(-20%) scale(${co2Scale})`;

            this.addXP(10, `energy-sim-${taskType}`);
            this.triggerAchievement('energy-saver');
        },

        miningState: {
            resources: { earths: 1000, water: 1000 },
            inventory: { cpu: 0, battery: 0, screen: 0 },
            assembled: 0, damage: 0,
            costs: {
                cpu: { earths: 10, water: 20, dmg: 2 },
                battery: { earths: 25, water: 5, dmg: 4 },
                screen: { earths: 5, water: 15, dmg: 3 },
            }
        },
        initMiningSim: function() {
            document.getElementById('make-cpu-btn').addEventListener('click', () => this.manufactureComponent('cpu'));
            document.getElementById('make-battery-btn').addEventListener('click', () => this.manufactureComponent('battery'));
            document.getElementById('make-screen-btn').addEventListener('click', () => this.manufactureComponent('screen'));
        },
        manufactureComponent: function(comp) {
            const cost = this.miningState.costs[comp];
            if (this.miningState.resources.earths >= cost.earths && this.miningState.resources.water >= cost.water) {
                this.miningState.resources.earths -= cost.earths;
                this.miningState.resources.water -= cost.water;
                this.miningState.inventory[comp]++;
                this.miningState.damage += cost.dmg;
                this.checkAssembly();
                this.updateMiningUI();
            } else {
                alert("Not enough resources!");
            }
        },
        checkAssembly: function() {
            while (this.miningState.inventory.cpu > 0 && this.miningState.inventory.battery > 0 && this.miningState.inventory.screen > 0) {
                this.miningState.inventory.cpu--;
                this.miningState.inventory.battery--;
                this.miningState.inventory.screen--;
                this.miningState.assembled++;
                this.addXP(25, `phone-assembled-${this.miningState.assembled}`);
            }
            if (this.miningState.assembled >= 5) this.triggerAchievement('resourceful');
        },
        updateMiningUI: function() {
            document.getElementById('rare-earths-bar').style.width = `${this.miningState.resources.earths / 10}%`;
            document.getElementById('rare-earths-bar').textContent = `${this.miningState.resources.earths} units`;
            document.getElementById('water-bar').style.width = `${this.miningState.resources.water / 10}%`;
            document.getElementById('water-bar').textContent = `${this.miningState.resources.water} units`;
            document.getElementById('damage-bar-v2').style.width = `${Math.min(100, this.miningState.damage)}%`;
            document.getElementById('damage-bar-v2').textContent = `${Math.min(100, this.miningState.damage)}%`;
            document.getElementById('cpu-inv').textContent = this.miningState.inventory.cpu;
            document.getElementById('battery-inv').textContent = this.miningState.inventory.battery;
            document.getElementById('screen-inv').textContent = this.miningState.inventory.screen;
            document.getElementById('phones-assembled').textContent = this.miningState.assembled;
        },

        initSequencingTask: function() {
            const data = ["1. Resource Mining", "2. Manufacturing", "3. Consumer Use", "4. Disposal / E-Waste"];
            const dropZonesContainer = document.getElementById('lifecycle-drop-zones');
            const dragItemsContainer = document.getElementById('lifecycle-drag-items');
            dropZonesContainer.innerHTML = data.map((_, i) => `<div class="drop-zone" data-correct-order="${i+1}">${i+1}. </div>`).join('');
            dragItemsContainer.innerHTML = this.shuffleArray(data).map(item => `<div class="drag-item" draggable="true" data-item-name="${item}">${item.substring(3)}</div>`).join('');
            this.initDragAndDrop('#lifecycle-sequencing-container');
        },
        checkSequence: function() {
            if (this.gameState.tasksCompleted.has('lifecycle-sequence')) return;
            const dropZones = document.querySelectorAll('#lifecycle-drop-zones .drop-zone');
            let correctCount = 0;
            dropZones.forEach(zone => {
                const item = zone.querySelector('.drag-item');
                zone.classList.remove('correct', 'incorrect');
                if (item) {
                    const correctOrder = parseInt(zone.dataset.correctOrder, 10);
                    const itemOrder = parseInt(item.dataset.itemName.substring(0, 1), 10);
                    if (correctOrder === itemOrder) {
                        zone.classList.add('correct');
                        correctCount++;
                    } else {
                        zone.classList.add('incorrect');
                    }
                }
            });
            const feedback = document.getElementById('lifecycle-feedback');
            feedback.textContent = `You placed ${correctCount} out of ${dropZones.length} correctly.`;
            feedback.className = `feedback ${correctCount === dropZones.length ? 'correct' : 'incorrect'}`;
            feedback.classList.remove('hidden');
            if (correctCount === dropZones.length) this.addXP(30, 'lifecycle-sequence');
        },

        initFillBlanks: function() {
            const container = document.getElementById('energy-fill-blanks-container');
            const optionsContainer = document.getElementById('energy-fill-blanks-options');
            const data = {
                sentence: "Huge buildings called _data centres_ use massive amounts of _energy_ to power and cool servers. This releases _greenhouse gases_, increasing the _carbon footprint_.",
                options: ["energy", "data centres", "water", "recycling", "carbon footprint", "e-waste", "greenhouse gases", "minerals"]
            };
            optionsContainer.innerHTML = this.shuffleArray(data.options).map(opt => `<div class="blank-option" draggable="true">${opt}</div>`).join('');
            container.innerHTML = `<p>${data.sentence.replace(/_([a-zA-Z\s]+)_/g, (m, p1) => `<input type="text" class="blank-input" data-correct="${p1.toLowerCase()}" ondragover="event.preventDefault()" ondrop="lesson.handleBlankDrop(event)">`)}</p>`;
            optionsContainer.querySelectorAll('.blank-option').forEach(opt => {
                opt.addEventListener('dragstart', e => e.dataTransfer.setData('text/plain', e.target.textContent));
            });
        },
        handleBlankDrop: function(event) { event.preventDefault(); event.target.value = event.dataTransfer.getData('text/plain'); },
        checkFillBlanks: function() {
            if (this.gameState.tasksCompleted.has('energy-blanks')) return;
            const inputs = document.querySelectorAll('#energy-fill-blanks-container .blank-input');
            let correctCount = 0;
            inputs.forEach(input => {
                if (this.isSimilar(input.value, input.dataset.correct)) {
                    input.style.backgroundColor = '#C8E6C9';
                    correctCount++;
                } else {
                    input.style.backgroundColor = '#FFCDD2';
                    input.value = `${input.value} (${input.dataset.correct})`;
                }
                input.disabled = true;
            });
            const feedback = document.getElementById('energy-blanks-feedback');
            feedback.textContent = `You got ${correctCount} out of ${inputs.length} correct.`;
            feedback.className = `feedback ${correctCount === inputs.length ? 'correct' : 'incorrect'}`;
            feedback.classList.remove('hidden');
            if (correctCount === inputs.length) this.addXP(40, 'energy-blanks');
        },

        revealMarkScheme: function(textareaId, markSchemeId) {
            if (document.getElementById(textareaId).value.length < 50) {
                alert('Please write a more detailed answer first.'); return;
            }
            document.getElementById(markSchemeId).classList.remove('hidden');
            this.addXP(10, `reveal-${markSchemeId}`);
        },

        initWritingScorer: function() { document.getElementById('analyzeBtn').addEventListener('click', this.analyzeWriting.bind(this)); },
        analyzeWriting: function() {
            const text = document.getElementById('studentAnswer').value, keywords = document.getElementById('keywords').value.split(',');
            if (text.trim() === "") { alert("Please enter some text."); return; }
            let score = 100, successes = [], improvements = [];
            const cleanedText = text.trim().replace(/\s+/g, ' '), sentences = cleanedText.match(/[^.!?]+[.!?]+/g) || [cleanedText];
            const firstLetterResult = this.ws_checkFirstLetterCapital(cleanedText);
            if (firstLetterResult.scoreChange < 0) { score += firstLetterResult.scoreChange; improvements.push(firstLetterResult.message); } 
            else { successes.push(firstLetterResult.message); }
            sentences.forEach(sentence => {
                const s = sentence.trim(); if (s.length === 0) return;
                Object.values(this.ws_checkers).forEach(checker => {
                    const result = checker(s);
                    if (result.scoreChange) {
                        score += result.scoreChange;
                        improvements.push(result.message);
                    }
                });
            });
            const iThinkResult = this.ws_checkIThink(cleanedText); if (iThinkResult.message) improvements.push({ message: iThinkResult.message, type: 'suggestion' });
            const keywordResult = this.ws_checkKeywords(cleanedText, keywords); if (keywordResult.message) successes.push(keywordResult.message);
            score = Math.max(0, score); this.ws_displayResults(score, successes, improvements);
            this.addXP(score >= 75 ? 50 : 25, 'writing-scorer-attempt');
            if(score >= 75) this.triggerAchievement('essay-expert');
        },
        ws_displayResults: function(score, successes, improvements) {
            const resultsDashboard = document.getElementById('resultsDashboard');
            const scoreValue = document.getElementById('scoreValue'), scoreCircle = document.getElementById('scoreCircle');
            const successList = document.getElementById('successList'), improvementList = document.getElementById('improvementList');
            successList.innerHTML = ''; improvementList.innerHTML = '';
            scoreValue.textContent = score;
            scoreCircle.style.borderColor = score > 75 ? 'var(--accent-color)' : score > 50 ? 'var(--warning-color)' : 'var(--danger-color)';
            successes.forEach(item => { const li = document.createElement('li'); li.textContent = item; successList.appendChild(li); });
            improvements.forEach(item => {
                const li = document.createElement('li');
                li.textContent = item.message || item;
                if(item.type === 'suggestion') li.classList.add('suggestion');
                improvementList.appendChild(li);
            });
            if (improvements.length === 0) improvementList.innerHTML = '<li>Great work! No major issues found.</li>';
            resultsDashboard.style.display = 'flex';
        },
        ws_checkFirstLetterCapital: text => (text.charAt(0) !== text.charAt(0).toUpperCase() || !isNaN(parseInt(text.charAt(0)))) ? { scoreChange: -15, message: 'Your answer should begin with a capital letter.' } : { scoreChange: 0, message: 'Started with a capital letter.' },
        ws_checkers: {
            capitalization: s => (s.trim().charAt(0) !== s.trim().charAt(0).toUpperCase() || !isNaN(parseInt(s.trim().charAt(0)))) ? { scoreChange: -5, message: `A sentence beginning with "${s.substring(0,15)}..." needs a capital.` } : {},
            punctuation: s => ('.!?'.indexOf(s.trim().slice(-1)) === -1) ? { scoreChange: -10, message: `The sentence "${s.substring(0,15)}..." is missing end punctuation.` } : {},
            length: s => (s.split(' ').length < 4) ? { scoreChange: -10, message: `The phrase "${s.trim()}" seems too short. Write in full sentences.` } : {},
        },
        ws_checkIThink: text => (/\bi think/i.test(text)) ? { message: 'For formal answers, avoid "I think..." to sound more confident.' } : {},
        ws_checkKeywords: (text, keywords) => {
            const found = keywords.filter(kw => text.toLowerCase().includes(kw.toLowerCase()));
            return found.length > 0 ? { message: `You included key terms like: ${found.join(', ')}.` } : {};
        },

        showFeedbackModal: function() {
            document.getElementById('feedback-page-info').value = `Page: ${this.config.pageTitles[this.gameState.currentPage]}`;
            this.dom.feedbackModal.classList.add('visible');
        },
        hideFeedbackModal: function() { this.dom.feedbackModal.classList.remove('visible'); },
        sendFeedback: function(e) {
            e.preventDefault();
            const body = `Feedback on: ${document.getElementById('feedback-page-info').value}\n\n${document.getElementById('feedback-text').value}`;
            window.location.href = `mailto:millingtond@mgs.org?subject=Worksheet Feedback&body=${encodeURIComponent(body)}`;
            this.hideFeedbackModal();
        },
        
        shuffleArray: function(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        },
        initDragAndDrop: function(containerSelector) {
            const container = document.querySelector(containerSelector);
            let draggedItem = null;
            container.addEventListener('dragstart', e => { if (e.target.classList.contains('drag-item')) { draggedItem = e.target; setTimeout(() => e.target.style.opacity = '0.5', 0); } });
            container.addEventListener('dragend', e => { if(draggedItem) { draggedItem.style.opacity = '1'; draggedItem = null; }});
            container.addEventListener('dragover', e => { e.preventDefault(); const zone = e.target.closest('.drop-zone'); if(zone) zone.classList.add('hover'); });
            container.addEventListener('dragleave', e => { const zone = e.target.closest('.drop-zone'); if(zone) zone.classList.remove('hover'); });
            container.addEventListener('drop', e => {
                e.preventDefault();
                const zone = e.target.closest('.drop-zone');
                if (zone && draggedItem) {
                    zone.classList.remove('hover');
                    if (zone.querySelector('.drag-item')) { container.querySelector('.drag-items').appendChild(zone.querySelector('.drag-item')); }
                    zone.appendChild(draggedItem);
                }
            });
        },
        isSimilar: function(str1, str2) {
            const a = str1.toLowerCase().trim(), b = str2.toLowerCase().trim();
            if (a === b) return true;
            const matrix = Array(b.length + 1).fill(null).map(() => Array(a.length + 1).fill(null));
            for (let i = 0; i <= a.length; i++) { matrix[0][i] = i; }
            for (let j = 0; j <= b.length; j++) { matrix[j][0] = j; }
            for (let j = 1; j <= b.length; j++) {
                for (let i = 1; i <= a.length; i++) {
                    const cost = a[i - 1] === b[j - 1] ? 0 : 1;
                    matrix[j][i] = Math.min(matrix[j][i - 1] + 1, matrix[j - 1][i] + 1, matrix[j - 1][i - 1] + cost);
                }
            }
            return matrix[b.length][a.length] <= Math.max(1, Math.floor(b.length / 5));
        },
        triggerEasterEgg: function() {
            this.addXP(100, 'easter-egg');
            this.triggerAchievement('easter-egg');
            document.getElementById('easter-egg').textContent = "You found it! +100 XP!";
        },
        resetTask: function(taskId) {
            switch(taskId) {
                case 'starter-quiz': this.populateQuiz('starter-quiz', 'starter-quiz-container'); break;
                case 'ewaste-sim':
                    this.ewasteState = { count: 0, max: 5 };
                    document.getElementById('ewaste-pile-v2').style.cssText = 'width: 10px; height: 5px;';
                    document.getElementById('water-table').style.backgroundColor = '#1E90FF';
                    document.querySelectorAll('#ewaste-items-v2 .drag-item').forEach(el => { el.style.display = 'block'; el.classList.remove('dropped'); });
                    break;
                case 'energy-sim':
                    document.getElementById('energy-output').textContent = '0 kWh';
                    document.getElementById('co2-output').textContent = '0 kg';
                    document.getElementById('water-output').textContent = '0 L';
                    document.getElementById('co2-cloud-v2').style.opacity = '0';
                    break;
                case 'mining-sim':
                    this.miningState = { resources: { earths: 1000, water: 1000 }, inventory: { cpu: 0, battery: 0, screen: 0 }, assembled: 0, damage: 0, costs: this.miningState.costs };
                    this.updateMiningUI();
                    break;
                case 'lifecycle-sequence': this.initSequencingTask(); document.getElementById('lifecycle-feedback').classList.add('hidden'); break;
                case 'energy-blanks': this.initFillBlanks(); document.getElementById('energy-blanks-feedback').classList.add('hidden'); break;
                case 'water-tf': this.populateQuiz('water-tf', 'water-tf-container'); break;
                case 'final-quiz': this.populateQuiz('final-quiz', 'final-quiz-container'); document.getElementById('final-quiz-feedback').classList.add('hidden'); break;
            }
        }
    };
    lesson.init();
    </script>
</body>
</html>
