<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="description" content="Interactive GCSE Computer Science lesson on Computational Thinking - OCR J277">
    <meta name="author" content="MGS Computer Science Department">
    <title>Computational Thinking - GCSE Computer Science</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --error-color: #e74c3c;
            --warning-color: #f39c12;
            --bg-color: #ecf0f1;
            --text-color: #2c3e50;
            --card-bg: #ffffff;
            --shadow: 0 2px 10px rgba(0,0,0,0.1);
            --font-size: 16px;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: var(--font-size);
            line-height: 1.6;
            position: relative;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            padding: 20px 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: var(--shadow);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .xp-display {
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .xp-bar {
            width: 200px;
            height: 20px;
            background: rgba(255,255,255,0.3);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .xp-fill {
            height: 100%;
            background: linear-gradient(90deg, #f39c12, #e74c3c);
            width: 0%;
            transition: width 0.5s ease;
        }

        .navbar {
            background-color: #34495e;
            padding: 10px 0;
            position: sticky;
            top: 80px;
            z-index: 999;
            box-shadow: var(--shadow);
        }

        .nav-items {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .nav-item {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 20px;
            transition: all 0.3s;
            cursor: pointer;
            background: rgba(255,255,255,0.1);
        }

        .nav-item:hover, .nav-item.active {
            background: var(--secondary-color);
            transform: translateY(-2px);
        }

        .section {
            display: none;
            animation: fadeIn 0.5s;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: var(--card-bg);
            padding: 30px;
            margin: 20px 0;
            border-radius: 10px;
            box-shadow: var(--shadow);
            position: relative;
        }

        .learning-outcome {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        h1, h2, h3 {
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        button {
            background: var(--secondary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        button:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }

        .reset-btn {
            background: var(--warning-color);
        }

        .reset-btn:hover {
            background: #d68910;
        }

        input[type="text"], textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus, textarea:focus {
            outline: none;
            border-color: var(--secondary-color);
        }

        .drag-container {
            display: flex;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .drag-item {
            background: var(--secondary-color);
            color: white;
            padding: 15px 20px;
            border-radius: 5px;
            cursor: grab;
            transition: all 0.3s;
            user-select: none;
        }

        .drag-item:active {
            cursor: grabbing;
            transform: scale(0.95);
        }

        .drag-item.dragging {
            opacity: 0.5;
        }

        .drop-zone {
            min-height: 60px;
            border: 2px dashed #95a5a6;
            border-radius: 5px;
            padding: 15px;
            background: #f8f9fa;
            transition: all 0.3s;
            flex: 1;
        }

        .drop-zone.drag-over {
            background: #e3f2fd;
            border-color: var(--secondary-color);
            transform: scale(1.02);
        }

        .drop-zone h4 {
            margin-bottom: 10px;
            color: #7f8c8d;
        }

        .correct {
            background: #d4edda;
            border-color: var(--success-color);
        }

        .incorrect {
            background: #f8d7da;
            border-color: var(--error-color);
        }

        /* Improved achievement popup with particles */
        .achievement-popup {
            position: fixed;
            top: 20px;
            right: -400px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 2000;
            transition: right 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow: hidden;
        }

        .achievement-popup.show {
            right: 20px;
        }

        .achievement-popup::before {
            content: 'üèÜ';
            font-size: 40px;
            animation: bounce 0.6s ease-in-out;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* Particle effects for achievements */
        .particles {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none;
        }

        .particle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0% {
                opacity: 0;
                transform: translateY(100px) rotate(0deg);
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                opacity: 0;
                transform: translateY(-100px) rotate(360deg);
            }
        }

        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }

        .feedback-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #95a5a6;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            transition: all 0.3s;
            z-index: 998;
        }

        .feedback-btn:hover {
            background: #7f8c8d;
            transform: scale(1.1);
        }

        .feedback-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2001;
        }

        .feedback-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            position: relative;
        }

        .close-modal {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 30px;
            cursor: pointer;
            color: #95a5a6;
        }

        .quiz-option {
            display: block;
            margin: 10px 0;
            padding: 15px;
            background: #f8f9fa;
            border: 2px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .quiz-option:hover {
            background: #e3f2fd;
            border-color: var(--secondary-color);
        }

        .quiz-option.selected {
            background: #d1ecf1;
            border-color: #17a2b8;
        }

        .mark-scheme {
            background: #fff3cd;
            padding: 20px;
            border-radius: 5px;
            margin-top: 20px;
            border: 1px solid #ffeaa7;
            display: none;
        }

        .canvas-container {
            border: 2px solid #ddd;
            border-radius: 5px;
            margin: 20px 0;
            position: relative;
        }

        #drawingCanvas {
            display: block;
            cursor: crosshair;
            touch-action: none;
        }

        .canvas-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .shame-message {
            background: #e74c3c;
            color: white;
            padding: 20px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
            display: none;
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .simulation-container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .step {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: all 0.3s;
        }

        .step.active {
            background: var(--secondary-color);
            color: white;
            transform: scale(1.2);
        }

        .step.completed {
            background: var(--success-color);
            color: white;
        }

        /* Improved responsive design */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .card {
                padding: 20px;
            }
            
            .drag-container {
                flex-direction: column;
            }
            
            .navigation-buttons {
                flex-direction: column;
                gap: 10px;
            }
            
            .navigation-buttons button {
                width: 100%;
            }
            
            .xp-display {
                flex-direction: column;
                text-align: center;
                font-size: 14px;
            }
            
            .xp-bar {
                width: 100px;
            }
            
            .nav-items {
                font-size: 14px;
                gap: 10px;
            }
            
            .nav-item {
                padding: 6px 12px;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            h2 {
                font-size: 1.3rem;
            }
            
            h3 {
                font-size: 1.1rem;
            }
            
            #drawingCanvas {
                width: 100%;
                height: 250px;
            }
            
            .feedback-btn {
                bottom: 10px;
                right: 10px;
                width: 40px;
                height: 40px;
            }
            
            .accessibility-toggle {
                top: 90px;
                right: 10px;
                width: 35px;
                height: 35px;
            }
            
            #commonMistakes {
                display: none !important;
            }
        }

        .high-contrast {
            --bg-color: #000;
            --text-color: #fff;
            --card-bg: #111;
            --primary-color: #fff;
            --secondary-color: #ff0;
        }

        .dyslexia-font {
            font-family: 'OpenDyslexic', Arial, sans-serif;
        }

        .accessibility-controls {
            position: fixed;
            top: 100px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: var(--shadow);
            display: none;
            z-index: 997;
        }

        .accessibility-toggle {
            position: fixed;
            top: 100px;
            right: 20px;
            background: #95a5a6;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 998;
        }
        /* Print styles */
        @media print {
            body {
                background: white;
                color: black;
            }
            
            header, .navbar, .feedback-btn, .accessibility-toggle, 
            #commonMistakes, .achievement-popup, .navigation-buttons {
                display: none !important;
            }
            
            .section {
                display: block !important;
                page-break-before: always;
            }
            
            .section:first-child {
                page-break-before: auto;
            }
            
            .card {
                box-shadow: none;
                border: 1px solid #ddd;
                margin: 10px 0;
            }
            
            .drag-item, .drop-zone {
                border: 1px solid #333;
            }
            
            button {
                display: none;
            }
            
            .mark-scheme {
                display: block !important;
                border: 1px solid #333;
                background: #f0f0f0 !important;
            }
            
            a {
                color: black;
                text-decoration: underline;
            }
        }

        /* Loading animation */
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }

        .loading {
            animation: pulse 1.5s ease-in-out infinite;
        }

        /* Focus styles for accessibility */
        *:focus {
            outline: 3px solid var(--secondary-color);
            outline-offset: 2px;
        }

        /* Skip to content link */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: var(--primary-color);
            color: white;
            padding: 8px;
            text-decoration: none;
            border-radius: 0 0 5px 0;
            z-index: 3000;
        }

        .skip-link:focus {
            top: 0;
        }
        /* Performance optimizations */
        .card, .drag-item, .drop-zone, button {
            will-change: transform;
        }
        
        /* Reduce motion for accessibility */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
            
            .drag-item {
                transition: none !important;
            }
        }
    </style>
    
    <!-- Preload key fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <!-- External libraries for Python editor -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/skulpt/0.11.1/skulpt.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/skulpt/0.11.1/skulpt-stdlib.js"></script>
</head>
<body>
    <a href="#starter" class="skip-link">Skip to main content</a>
    
    <header>
        <div class="header-content">
            <h1>Computational Thinking</h1>
            <div class="xp-display">
                <span>Level <span id="level">1</span></span>
                <div class="xp-bar">
                    <div class="xp-fill" id="xpFill"></div>
                </div>
                <span><span id="currentXP">0</span> / <span id="requiredXP">100</span> XP</span>
            </div>
        </div>
    </header>

    <nav class="navbar">
        <div class="nav-items">
            <a class="nav-item active" onclick="showSection('starter', true)">Starter</a>
            <a class="nav-item" onclick="showSection('intro', true)">Introduction</a>
            <a class="nav-item" onclick="showSection('abstraction', true)">Abstraction</a>
            <a class="nav-item" onclick="showSection('decomposition', true)">Decomposition</a>
            <a class="nav-item" onclick="showSection('algorithmic', true)">Algorithmic Thinking</a>
            <a class="nav-item" onclick="showSection('together', true)">Bringing It Together</a>
            <a class="nav-item" onclick="showSection('exam', true)">Exam Practice</a>
            <a class="nav-item" onclick="showSection('extension', true)">Extension</a>
            <a class="nav-item" onclick="showSection('summary', true)">Summary</a>
            <a class="nav-item" onclick="showSection('videos', true)">Videos</a>
        </div>
    </nav>

    <div class="container">
        <!-- Starter Activity -->
        <section id="starter" class="section active">
            <div class="card">
                <div class="learning-outcome">
                    <h2>Learning Outcome</h2>
                    <p>By the end of this lesson, you will be able to identify and apply the three key computational thinking skills: abstraction, decomposition, and algorithmic thinking.</p>
                </div>

                <div class="task-header">
                    <h2>Starter Activity: Computational Thinking Sort</h2>
                    <button class="reset-btn" onclick="resetStarter()">Reset Activity</button>
                </div>

                <p>Drag each example into the correct computational thinking category. Think carefully about which skill each example best represents!</p>

                <div class="drag-container" id="starterItems">
                    <div class="drag-item" draggable="true" data-category="abstraction">Using a weather app instead of understanding meteorology</div>
                    <div class="drag-item" draggable="true" data-category="decomposition">Breaking a essay into introduction, body, and conclusion</div>
                    <div class="drag-item" draggable="true" data-category="algorithmic">Following a recipe step-by-step</div>
                    <div class="drag-item" draggable="true" data-category="abstraction">Using print() without knowing how it displays text</div>
                    <div class="drag-item" draggable="true" data-category="decomposition">Dividing a game into graphics, input, and logic modules</div>
                    <div class="drag-item" draggable="true" data-category="algorithmic">Creating a flowchart for making tea</div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 30px;">
                    <div class="drop-zone" data-category="abstraction">
                        <h4>Abstraction</h4>
                    </div>
                    <div class="drop-zone" data-category="decomposition">
                        <h4>Decomposition</h4>
                    </div>
                    <div class="drop-zone" data-category="algorithmic">
                        <h4>Algorithmic Thinking</h4>
                    </div>
                </div>

                <button onclick="checkStarter()" style="margin-top: 20px;">Check Answers</button>
                <div id="starterFeedback" style="margin-top: 20px;"></div>

                <div class="navigation-buttons">
                    <button disabled>Previous</button>
                    <button onclick="showSection('intro', true)">Next: Introduction</button>
                </div>
            </div>
        </section>

        <!-- Introduction Section -->
        <section id="intro" class="section">
            <div class="card">
                <h2>Introduction to Computational Thinking</h2>
                
                <p>Computational thinking is a problem-solving process that helps us tackle complex problems in a systematic way. It's not just about computers - it's a way of thinking that can be applied to any problem!</p>

                <div class="simulation-container">
                    <h3>The Three Pillars of Computational Thinking</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
                        <div id="pillar-abstraction" style="text-align: center; padding: 20px; background: #e3f2fd; border-radius: 10px; cursor: pointer;">
                            <h4 style="color: #1976d2;">Abstraction</h4>
                            <p>Focusing on important details</p>
                        </div>
                        <div id="pillar-decomposition" style="text-align: center; padding: 20px; background: #e8f5e9; border-radius: 10px; cursor: pointer;">
                            <h4 style="color: #388e3c;">Decomposition</h4>
                            <p>Breaking down problems</p>
                        </div>
                        <div id="pillar-algorithmic" style="text-align: center; padding: 20px; background: #fff3e0; border-radius: 10px; cursor: pointer;">
                            <h4 style="color: #f57c00;">Algorithmic Thinking</h4>
                            <p>Creating step-by-step solutions</p>
                        </div>
                    </div>
                    <div id="pillarDescription" style="margin-top: 20px; padding: 20px; background: #f5f5f5; border-radius: 10px; display: none;"></div>
                </div>

                <div style="margin-top: 30px;">
                    <h3>Quick Check</h3>
                    <p>What is computational thinking?</p>
                    <div id="introQuiz">
                        <label class="quiz-option">
                            <input type="radio" name="introQ1" value="a"> A way to fix computers when they break
                        </label>
                        <label class="quiz-option">
                            <input type="radio" name="introQ1" value="b"> A problem-solving process using abstraction, decomposition and algorithmic thinking
                        </label>
                        <label class="quiz-option">
                            <input type="radio" name="introQ1" value="c"> Learning to code in Python
                        </label>
                        <label class="quiz-option">
                            <input type="radio" name="introQ1" value="d"> Making computers think like humans
                        </label>
                    </div>
                    <button onclick="checkIntroQuiz()" style="margin-top: 10px;">Check Answer</button>
                    <div id="introQuizFeedback"></div>
                </div>

                <div class="navigation-buttons">
                    <button onclick="showSection('starter', true)">Previous: Starter</button>
                    <button onclick="showSection('abstraction', true)">Next: Abstraction</button>
                </div>
            </div>
        </section>

        <!-- Abstraction Section -->
        <section id="abstraction" class="section">
            <div class="card">
                <div class="task-header">
                    <h2>Abstraction</h2>
                    <button class="reset-btn" onclick="resetAbstraction()">Reset Section</button>
                </div>

                <p><strong>Abstraction</strong> is the process of removing or hiding unnecessary details and focusing on the important information needed to solve a problem. It simplifies complex problems by concentrating on what matters.</p>

                <div class="simulation-container">
                    <h3>Map Abstraction Simulation</h3>
                    <p>Let's see how abstraction works by creating a simplified map. Click the buttons to add or remove details:</p>
                    
                    <div id="mapSimulation" style="position: relative; width: 100%; height: 400px; background: #f0f0f0; border: 2px solid #ddd; border-radius: 10px; overflow: hidden;">
                        <!-- Map layers will be added here -->
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                        <button onclick="toggleMapLayer('roads')">Toggle Roads</button>
                        <button onclick="toggleMapLayer('buildings')">Toggle Buildings</button>
                        <button onclick="toggleMapLayer('trees')">Toggle Trees</button>
                        <button onclick="toggleMapLayer('labels')">Toggle Labels</button>
                        <button onclick="toggleMapLayer('traffic')">Toggle Traffic</button>
                        <button onclick="toggleMapLayer('parking')">Toggle Parking</button>
                        <button onclick="toggleMapLayer('terrain')">Toggle Terrain</button>
                    </div>
                    
                    <p style="margin-top: 10px;"><strong>Reflection:</strong> Notice how removing unnecessary details (like individual trees or traffic) makes the map clearer for navigation purposes. This is abstraction in action!</p>
                </div>

                <div style="margin-top: 30px;">
                    <h3>Fill in the Blanks: Abstraction Examples</h3>
                    <p>Complete the sentences by selecting the correct words from the options:</p>
                    
                    <div style="margin: 20px 0;">
                        <p>1. When we use a 
                            <select id="abs1" onchange="checkAbstractionFill()">
                                <option value="">Select...</option>
                                <option value="correct">URL</option>
                                <option value="wrong1">HTML</option>
                                <option value="wrong2">CPU</option>
                                <option value="wrong3">RAM</option>
                            </select>
                            to access a website, we don't need to know the 
                            <select id="abs2" onchange="checkAbstractionFill()">
                                <option value="">Select...</option>
                                <option value="wrong1">password</option>
                                <option value="correct">IP address</option>
                                <option value="wrong2">username</option>
                                <option value="wrong3">browser</option>
                            </select>.
                        </p>
                        
                        <p>2. Using built-in functions like 
                            <select id="abs3" onchange="checkAbstractionFill()">
                                <option value="">Select...</option>
                                <option value="wrong1">if</option>
                                <option value="wrong2">while</option>
                                <option value="correct">randint()</option>
                                <option value="wrong3">define</option>
                            </select>
                            is an example of abstraction because we can use them without understanding their 
                            <select id="abs4" onchange="checkAbstractionFill()">
                                <option value="">Select...</option>
                                <option value="correct">implementation</option>
                                <option value="wrong1">name</option>
                                <option value="wrong2">color</option>
                                <option value="wrong3">speed</option>
                            </select>.
                        </p>
                    </div>
                    
                    <div id="abstractionFillFeedback"></div>
                </div>

                <div style="margin-top: 30px;">
                    <h3>Real-World Abstraction</h3>
                    <p>Match each real-world example with what it abstracts away:</p>
                    
                    <div class="drag-container" id="abstractionMatchItems">
                        <div class="drag-item" draggable="true" data-match="calendar">Calendar Widget</div>
                        <div class="drag-item" draggable="true" data-match="weather">Weather Forecast Model</div>
                        <div class="drag-item" draggable="true" data-match="remote">TV Remote Control</div>
                        <div class="drag-item" draggable="true" data-match="emoji">Emoji</div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 20px;">
                        <div class="drop-zone" data-match="calendar">
                            <h4>Complex date calculations</h4>
                        </div>
                        <div class="drop-zone" data-match="weather">
                            <h4>Atmospheric physics equations</h4>
                        </div>
                        <div class="drop-zone" data-match="remote">
                            <h4>Infrared signal protocols</h4>
                        </div>
                        <div class="drop-zone" data-match="emoji">
                            <h4>Complex human emotions</h4>
                        </div>
                    </div>
                    
                    <button onclick="checkAbstractionMatch()" style="margin-top: 20px;">Check Matches</button>
                    <div id="abstractionMatchFeedback"></div>
                </div>

                <div class="navigation-buttons">
                    <button onclick="showSection('intro')">Previous: Introduction</button>
                    <button onclick="showSection('decomposition')">Next: Decomposition</button>
                </div>
            </div>
        </section>

        <!-- Decomposition Section -->
        <section id="decomposition" class="section">
            <div class="card">
                <div class="task-header">
                    <h2>Decomposition</h2>
                    <button class="reset-btn" onclick="resetDecomposition()">Reset Section</button>
                </div>

                <p><strong>Decomposition</strong> is breaking down a complex problem into smaller, more manageable parts (subtasks). Each part can be understood, solved, and tested independently.</p>

                <div class="simulation-container">
                    <h3>Recipe Decomposition Simulation</h3>
                    <p>Let's decompose making a sandwich into smaller steps. Click to see how we break it down:</p>
                    
                    <div class="step-indicator">
                        <div class="step active" id="step1">1</div>
                        <div class="step" id="step2">2</div>
                        <div class="step" id="step3">3</div>
                        <div class="step" id="step4">4</div>
                        <div class="step" id="step5">5</div>
                    </div>
                    
                    <div id="decompositionSteps" style="min-height: 200px; padding: 20px; background: white; border-radius: 10px;">
                        <h4>Making a Sandwich</h4>
                        <p>This seems like a simple task, but let's break it down...</p>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                        <button onclick="previousDecompositionStep()">Previous Step</button>
                        <button onclick="nextDecompositionStep()">Next Step</button>
                    </div>
                </div>

                <div style="margin-top: 30px;">
                    <h3>Benefits of Decomposition</h3>
                    <p>Match each benefit with its explanation:</p>
                    
                    <div class="drag-container" id="benefitsItems">
                        <div class="drag-item" draggable="true" data-benefit="parallel">Parallel Development</div>
                        <div class="drag-item" draggable="true" data-benefit="reuse">Code Reusability</div>
                        <div class="drag-item" draggable="true" data-benefit="debug">Easier Debugging</div>
                        <div class="drag-item" draggable="true" data-benefit="maintain">Better Maintenance</div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr; gap: 15px; margin-top: 20px;">
                        <div class="drop-zone" data-benefit="debug">
                            <h4>Testing smaller parts helps find errors quickly</h4>
                        </div>
                        <div class="drop-zone" data-benefit="parallel">
                            <h4>Multiple people can work on different parts simultaneously</h4>
                        </div>
                        <div class="drop-zone" data-benefit="maintain">
                            <h4>Changes to one part don't affect the whole system</h4>
                        </div>
                        <div class="drop-zone" data-benefit="reuse">
                            <h4>Components can be used in other programs</h4>
                        </div>
                    </div>
                    
                    <button onclick="checkBenefitsMatch()" style="margin-top: 20px;">Check Matches</button>
                    <div id="benefitsFeedback"></div>
                </div>

                <div style="margin-top: 30px;">
                    <h3>Case Study: Decomposing a Chess Game</h3>
                    <p>A chess game is complex, but we can decompose it into manageable parts. Select the correct word for each subtask:</p>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                        <p><strong>Main Task:</strong> Create a Chess Game</p>
                        <p><strong>Subtasks:</strong></p>
                        <ol>
                            <li>Display the 
                                <select id="chess1" style="width: 150px;">
                                    <option value="">Select...</option>
                                    <option value="board">board</option>
                                    <option value="pieces">pieces</option>
                                    <option value="screen">screen</option>
                                    <option value="players">players</option>
                                </select>
                                - Show the 8x8 grid with pieces
                            </li>
                            <li>Handle player 
                                <select id="chess2" style="width: 150px;">
                                    <option value="">Select...</option>
                                    <option value="turns">turns</option>
                                    <option value="input">input</option>
                                    <option value="names">names</option>
                                    <option value="scores">scores</option>
                                </select>
                                - Allow clicking and moving pieces
                            </li>
                            <li>Validate 
                                <select id="chess3" style="width: 150px;">
                                    <option value="">Select...</option>
                                    <option value="moves">moves</option>
                                    <option value="players">players</option>
                                    <option value="time">time</option>
                                    <option value="board">board</option>
                                </select>
                                - Check if moves follow chess rules
                            </li>
                            <li>Update game 
                                <select id="chess4" style="width: 150px;">
                                    <option value="">Select...</option>
                                    <option value="state">state</option>
                                    <option value="graphics">graphics</option>
                                    <option value="sound">sound</option>
                                    <option value="menu">menu</option>
                                </select>
                                - Track captured pieces and check for checkmate
                            </li>
                            <li>Implement 
                                <select id="chess5" style="width: 150px;">
                                    <option value="">Select...</option>
                                    <option value="AI">AI</option>
                                    <option value="graphics">graphics</option>
                                    <option value="network">network</option>
                                    <option value="database">database</option>
                                </select>
                                logic - Create computer opponent
                            </li>
                        </ol>
                        <button onclick="checkChessDecomposition()" style="margin-top: 10px;">Check Answers</button>
                        <div id="chessFeedback"></div>
                    </div>
                </div>

                <div class="navigation-buttons">
                    <button onclick="showSection('abstraction')">Previous: Abstraction</button>
                    <button onclick="showSection('algorithmic')">Next: Algorithmic Thinking</button>
                </div>
            </div>
        </section>

        <!-- Algorithmic Thinking Section -->
        <section id="algorithmic" class="section">
            <div class="card">
                <div class="task-header">
                    <h2>Algorithmic Thinking</h2>
                    <button class="reset-btn" onclick="resetAlgorithmic()">Reset Section</button>
                </div>

                <p><strong>Algorithmic thinking</strong> involves creating a step-by-step solution to a problem using sequence, selection, and iteration.</p>

                <div style="margin-top: 30px;">
                    <h3>Key Constructs</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div style="background: #e3f2fd; padding: 20px; border-radius: 10px;">
                            <h4>Sequence</h4>
                            <p>Steps executed in order</p>
                            <code style="display: block; margin-top: 10px;">
                                Step 1<br>
                                Step 2<br>
                                Step 3
                            </code>
                        </div>
                        <div style="background: #e8f5e9; padding: 20px; border-radius: 10px;">
                            <h4>Selection</h4>
                            <p>Making decisions</p>
                            <code style="display: block; margin-top: 10px;">
                                IF condition:<br>
                                &nbsp;&nbsp;Do this<br>
                                ELSE:<br>
                                &nbsp;&nbsp;Do that
                            </code>
                        </div>
                        <div style="background: #fff3e0; padding: 20px; border-radius: 10px;">
                            <h4>Iteration</h4>
                            <p>Repeating steps</p>
                            <code style="display: block; margin-top: 10px;">
                                WHILE condition:<br>
                                &nbsp;&nbsp;Repeat this
                            </code>
                        </div>
                    </div>
                </div>

                <div class="simulation-container" style="margin-top: 30px;">
                    <h3>Interactive Flowchart Builder</h3>
                    <p>Create an algorithm for making a cup of tea by clicking the steps in the correct order:</p>
                    
                    <div id="flowchartSteps" class="drag-container">
                        <button class="flowchart-step" onclick="addToFlowchart(this, 4)" data-order="4">Pour hot water into cup</button>
                        <button class="flowchart-step" onclick="addToFlowchart(this, 1)" data-order="1">Fill kettle with water</button>
                        <button class="flowchart-step" onclick="addToFlowchart(this, 6)" data-order="6">Add milk/sugar if desired</button>
                        <button class="flowchart-step" onclick="addToFlowchart(this, 3)" data-order="3">Put tea bag in cup</button>
                        <button class="flowchart-step" onclick="addToFlowchart(this, 2)" data-order="2">Boil the water</button>
                        <button class="flowchart-step" onclick="addToFlowchart(this, 5)" data-order="5">Wait for tea to brew</button>
                        <button class="flowchart-step" onclick="addToFlowchart(this, 7)" data-order="7">Stir and enjoy</button>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <h4>Your Algorithm:</h4>
                        <div id="flowchartDropZone" style="min-height: 300px; background: #f8f9fa; border: 2px solid #ddd; border-radius: 10px; padding: 20px;">
                            <p style="color: #999;">Click steps above to add them here...</p>
                        </div>
                    </div>
                    
                    <div style="margin-top: 10px;">
                        <button onclick="checkFlowchart()">Check Algorithm</button>
                        <button onclick="clearFlowchart()" class="reset-btn">Clear All</button>
                    </div>
                    <div id="flowchartFeedback"></div>
                </div>

                <div style="margin-top: 30px;">
                    <h3>Identify the Constructs</h3>
                    <p>For each Python code snippet, identify which construct is being used:</p>
                    
                    <div style="margin: 20px 0;">
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                            <code style="display: block; white-space: pre;">for student in class_list:
    print(student)</code>
                            <select id="construct1" style="margin-top: 10px;">
                                <option value="">Select construct...</option>
                                <option value="sequence">Sequence</option>
                                <option value="selection">Selection</option>
                                <option value="iteration">Iteration</option>
                            </select>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                            <code style="display: block; white-space: pre;">if score >= 50:
    print("Pass")
else:
    print("Fail")</code>
                            <select id="construct2" style="margin-top: 10px;">
                                <option value="">Select construct...</option>
                                <option value="sequence">Sequence</option>
                                <option value="selection">Selection</option>
                                <option value="iteration">Iteration</option>
                            </select>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px;">
                            <code style="display: block; white-space: pre;">username = input("Enter username: ")
password = input("Enter password: ")
print("Checking credentials...")
print("Login successful")</code>
                            <select id="construct3" style="margin-top: 10px;">
                                <option value="">Select construct...</option>
                                <option value="sequence">Sequence</option>
                                <option value="selection">Selection</option>
                                <option value="iteration">Iteration</option>
                            </select>
                        </div>
                    </div>
                    
                    <button onclick="checkConstructs()">Check Answers</button>
                    <div id="constructsFeedback"></div>
                </div>

                <div class="navigation-buttons">
                    <button onclick="showSection('decomposition')">Previous: Decomposition</button>
                    <button onclick="showSection('together')">Next: Bringing It Together</button>
                </div>
            </div>
        </section>

        <!-- Bringing It Together Section -->
        <section id="together" class="section">
            <div class="card">
                <h2>Bringing It All Together</h2>
                
                <p>Now let's apply all three computational thinking skills to solve a real problem!</p>

                <div style="background: #f0f8ff; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h3>üéØ Problem: Create a School Timetable App</h3>
                    <p>Your school wants an app that helps students view their daily timetable. Let's use computational thinking to plan this!</p>
                </div>

                <div style="margin-top: 30px;">
                    <h3>Step 1: Apply Abstraction</h3>
                    <p>What details should we include and what should we hide? Select the relevant details for our timetable app:</p>
                    
                    <div id="abstractionChoices" style="margin: 20px 0;">
                        <label class="quiz-option">
                            <input type="checkbox" value="subject"> Subject names
                        </label>
                        <label class="quiz-option">
                            <input type="checkbox" value="room"> Room numbers
                        </label>
                        <label class="quiz-option">
                            <input type="checkbox" value="teacher_age"> Teacher's age
                        </label>
                        <label class="quiz-option">
                            <input type="checkbox" value="time"> Lesson times
                        </label>
                        <label class="quiz-option">
                            <input type="checkbox" value="building_year"> Year building was constructed
                        </label>
                        <label class="quiz-option">
                            <input type="checkbox" value="teacher"> Teacher names
                        </label>
                    </div>
                    <button onclick="checkTogetherAbstraction()">Check Abstraction</button>
                    <div id="togetherAbstractionFeedback"></div>
                </div>

                <div style="margin-top: 30px;">
                    <h3>Step 2: Apply Decomposition</h3>
                    <p>Break down the timetable app into smaller tasks. Drag to match each main component with its subtasks:</p>
                    
                    <div class="drag-container" id="decompTasks">
                        <div class="drag-item" draggable="true" data-component="display">Create grid layout</div>
                        <div class="drag-item" draggable="true" data-component="data">Store lesson information</div>
                        <div class="drag-item" draggable="true" data-component="user">Login system</div>
                        <div class="drag-item" draggable="true" data-component="display">Show current day</div>
                        <div class="drag-item" draggable="true" data-component="data">Load timetable data</div>
                        <div class="drag-item" draggable="true" data-component="user">Personal settings</div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px;">
                        <div class="drop-zone" data-component="display">
                            <h4>Display Component</h4>
                        </div>
                        <div class="drop-zone" data-component="data">
                            <h4>Data Component</h4>
                        </div>
                        <div class="drop-zone" data-component="user">
                            <h4>User Component</h4>
                        </div>
                    </div>
                    <button onclick="checkTogetherDecomposition()" style="margin-top: 20px;">Check Decomposition</button>
                    <div id="togetherDecompFeedback"></div>
                </div>

                <div style="margin-top: 30px;">
                    <h3>Step 3: Apply Algorithmic Thinking</h3>
                    <p>Create an algorithm for displaying today's timetable. Select the correct options:</p>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                        <code style="display: block; line-height: 1.8;">
                            1. Get current 
                            <select id="algo1" style="width: 120px;">
                                <option value="">Select...</option>
                                <option value="day">day</option>
                                <option value="time">time</option>
                                <option value="user">user</option>
                                <option value="password">password</option>
                            </select><br>
                            2. Load user's 
                            <select id="algo2" style="width: 120px;">
                                <option value="">Select...</option>
                                <option value="timetable">timetable</option>
                                <option value="grades">grades</option>
                                <option value="homework">homework</option>
                                <option value="friends">friends</option>
                            </select><br>
                            3. <strong>FOR</strong> each lesson today:<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;Display lesson 
                            <select id="algo3" style="width: 120px;">
                                <option value="">Select...</option>
                                <option value="details">details</option>
                                <option value="teacher">teacher</option>
                                <option value="homework">homework</option>
                                <option value="grades">grades</option>
                            </select><br>
                            4. <strong>IF</strong> current time is during a lesson:<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;Highlight 
                            <select id="algo4" style="width: 150px;">
                                <option value="">Select...</option>
                                <option value="current lesson">current lesson</option>
                                <option value="next lesson">next lesson</option>
                                <option value="all lessons">all lessons</option>
                                <option value="past lessons">past lessons</option>
                            </select><br>
                            5. <strong>ELSE:</strong><br>
                            &nbsp;&nbsp;&nbsp;&nbsp;Show 
                            <select id="algo5" style="width: 150px;">
                                <option value="">Select...</option>
                                <option value="next lesson">next lesson</option>
                                <option value="previous lesson">previous lesson</option>
                                <option value="tomorrow">tomorrow</option>
                                <option value="nothing">nothing</option>
                            </select>
                        </code>
                    </div>
                    <button onclick="checkTogetherAlgorithm()" style="margin-top: 10px;">Check Algorithm</button>
                    <div id="togetherAlgoFeedback"></div>
                </div>

                <div class="navigation-buttons">
                    <button onclick="showSection('algorithmic')">Previous: Algorithmic Thinking</button>
                    <button onclick="showSection('exam')">Next: Exam Practice</button>
                </div>
            </div>
        </section>

        <!-- Exam Practice Section -->
        <section id="exam" class="section">
            <div class="card">
                <h2>Practice Exam Questions</h2>
                
                <p>Test your understanding with these exam-style questions. Enter your predicted marks after attempting each question.</p>

                <div style="background: #fff3cd; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                    <p><strong>Tip:</strong> Read each question carefully and show your working. Mark schemes will appear after you've made a good attempt.</p>
                </div>

                <!-- Question 1 -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3>Question 1 (4 marks)</h3>
                    <p>A student is creating a program to calculate the average temperature for a week.</p>
                    <p>(a) Identify TWO examples of abstraction the student might use. (2 marks)</p>
                    <textarea id="exam1a" rows="3" placeholder="Write your answer here..."></textarea>
                    
                    <p style="margin-top: 15px;">(b) Describe how decomposition would help in creating this program. (2 marks)</p>
                    <textarea id="exam1b" rows="3" placeholder="Write your answer here..."></textarea>
                    
                    <div style="margin-top: 15px;">
                        <label>Predicted marks (0-4): <input type="number" id="marks1" min="0" max="4" style="width: 60px;"></label>
                        <button onclick="showMarkScheme(1)" style="margin-left: 10px;">Show Mark Scheme</button>
                    </div>
                    
                    <div id="markScheme1" class="mark-scheme">
                        <h4>Mark Scheme:</h4>
                        <p><strong>(a) 2 marks - 1 mark for each valid example:</strong></p>
                        <ul>
                            <li>Using simple number inputs instead of complex weather station data</li>
                            <li>Displaying only the average, not all the calculations</li>
                            <li>Using days of week labels instead of full dates</li>
                            <li>Ignoring weather conditions and focusing only on temperature</li>
                        </ul>
                        <p><strong>(b) 2 marks:</strong></p>
                        <ul>
                            <li>1 mark: Breaking the problem into smaller tasks</li>
                            <li>1 mark: Example tasks such as: input temperatures, calculate total, divide by 7, display result</li>
                        </ul>
                    </div>
                </div>

                <!-- Question 2 -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3>Question 2 (6 marks)</h3>
                    <p>A shopping website needs to process customer orders.</p>
                    <p>Write a Python program using sequence, selection and iteration that:</p>
                    <ul>
                        <li>Checks each item in the shopping basket</li>
                        <li>Calculates the total price</li>
                        <li>Applies a 10% discount if the total is over ¬£50</li>
                        <li>Displays the final price</li>
                    </ul>
                    
                    <div style="margin-top: 15px;">
                        <div id="pythonEditor2" style="width: 100%; height: 300px; border: 1px solid #ddd; border-radius: 5px;"></div>
                        <div style="margin-top: 10px;">
                            <button onclick="runPythonCode(2)" style="background: #27ae60;">Run Code</button>
                            <button onclick="resetPythonCode(2)" class="reset-btn">Reset Code</button>
                        </div>
                        <div id="pythonOutput2" style="margin-top: 10px; padding: 10px; background: #2c3e50; color: #fff; border-radius: 5px; font-family: monospace; min-height: 50px; display: none;"></div>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <label>Predicted marks (0-6): <input type="number" id="marks2" min="0" max="6" style="width: 60px;"></label>
                        <button onclick="showMarkScheme(2)" style="margin-left: 10px;">Show Mark Scheme</button>
                    </div>
                    
                    <div id="markScheme2" class="mark-scheme">
                        <h4>Mark Scheme:</h4>
                        <p><strong>6 marks total:</strong></p>
                        <ul>
                            <li>2 marks: Correct use of iteration (loop through items)</li>
                            <li>1 mark: Sequence - calculating total</li>
                            <li>2 marks: Selection - IF total > 50 apply discount</li>
                            <li>1 mark: Clear, logical program structure</li>
                        </ul>
                        <p><strong>Example answer:</strong></p>
                        <pre style="background: #f4f4f4; padding: 10px; border-radius: 5px;"><code># Shopping basket with items and prices
basket = [
    {"item": "Book", "price": 12.99},
    {"item": "Pen", "price": 2.50},
    {"item": "Notebook", "price": 8.99},
    {"item": "Laptop Case", "price": 35.00}
]

total = 0
print("Shopping Basket:")

# Iteration - loop through items
for item in basket:
    print("- " + item['item'] + ": ¬£" + str(item['price']))
    total = total + item['price']  # Sequence

print("\nSubtotal: ¬£" + str(round(total, 2)))

# Selection - check for discount
if total > 50:
    discount = total * 0.1
    total = total - discount
    print("10% discount applied: -¬£" + str(round(discount, 2)))

print("Final total: ¬£" + str(round(total, 2)))</code></pre>
                    </div>
                </div>

                <!-- Question 3 -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3>Question 3 (5 marks)</h3>
                    <p>Explain how computational thinking would be used to create a mobile app that helps students revise for exams.</p>
                    <p>Your answer should refer to abstraction, decomposition and algorithmic thinking.</p>
                    
                    <textarea id="exam3" rows="8" placeholder="Write your answer here..." style="margin-top: 15px; width: 100%;"></textarea>
                    
                    <div style="margin-top: 15px;">
                        <label>Predicted marks (0-5): <input type="number" id="marks3" min="0" max="5" style="width: 60px;"></label>
                        <button onclick="showMarkScheme(3)" style="margin-left: 10px;">Show Mark Scheme</button>
                    </div>
                    
                    <div id="markScheme3" class="mark-scheme">
                        <h4>Mark Scheme:</h4>
                        <p><strong>5 marks - 1-2 marks for each skill mentioned with relevant example:</strong></p>
                        <ul>
                            <li><strong>Abstraction:</strong> Hide complex scoring algorithms, show simple progress bars; Focus on key revision topics not entire textbook</li>
                            <li><strong>Decomposition:</strong> Break into components: question bank, progress tracking, user accounts, revision scheduler</li>
                            <li><strong>Algorithmic thinking:</strong> Algorithm to select questions based on weak areas; Steps to track and update progress</li>
                        </ul>
                        <p>Award marks for clear explanation and relevant examples</p>
                    </div>
                </div>

                <div class="navigation-buttons">
                    <button onclick="showSection('together')">Previous: Bringing It Together</button>
                    <button onclick="showSection('extension')">Next: Extension Activities</button>
                </div>
            </div>
        </section>

        <!-- Extension Section -->
        <section id="extension" class="section">
            <div class="card">
                <h2>Extension Activities</h2>
                
                <p>Ready to go beyond the specification? Try these challenging activities!</p>

                <div style="background: #e8f5e9; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3>üöÄ Challenge 1: Design Your Own App</h3>
                    <p>Choose an everyday problem and design an app to solve it using computational thinking.</p>
                    
                    <div style="margin-top: 20px;">
                        <p><strong>Your Problem:</strong></p>
                        <input type="text" id="extProblem" placeholder="Describe the problem your app will solve...">
                        
                        <p style="margin-top: 15px;"><strong>Abstraction - What details will you include/exclude?</strong></p>
                        <textarea id="extAbstraction" rows="3" placeholder="List the relevant details..."></textarea>
                        
                        <p style="margin-top: 15px;"><strong>Decomposition - Break it into components:</strong></p>
                        <textarea id="extDecomposition" rows="4" placeholder="List the main components..."></textarea>
                        
                        <p style="margin-top: 15px;"><strong>Algorithm - Main process flow:</strong></p>
                        <textarea id="extAlgorithm" rows="5" placeholder="Describe the main algorithm..."></textarea>
                        
                        <button onclick="submitExtension1()" style="margin-top: 15px;">Submit Design</button>
                        <div id="extension1Feedback"></div>
                    </div>
                </div>

                <div style="background: #fff3e0; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3>üß© Challenge 2: Recursive Thinking</h3>
                    <p>Recursion is when a function calls itself. It's an advanced form of algorithmic thinking!</p>
                    
                    <p>Can you identify what this recursive algorithm calculates?</p>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 15px 0;">
                        <code style="display: block; white-space: pre-line;">
FUNCTION mystery(n):
    IF n <= 1:
        RETURN n
    ELSE:
        RETURN mystery(n-1) + mystery(n-2)
                        </code>
                    </div>
                    
                    <p>What does this calculate when mystery(6) is called?</p>
                    <input type="text" id="recursionAnswer" placeholder="Your answer...">
                    <button onclick="checkRecursion()" style="margin-left: 10px;">Check</button>
                    <div id="recursionFeedback"></div>
                </div>

                <div style="background: #e3f2fd; padding: 20px; border-radius: 10px;">
                    <h3>üí° Challenge 3: Real-World Problem Solving</h3>
                    <p>Your school cafeteria wants to reduce food waste. Use computational thinking to design a solution.</p>
                    
                    <p>Consider:</p>
                    <ul>
                        <li>How to predict demand for different meals</li>
                        <li>How to track waste patterns</li>
                        <li>How to adjust ordering accordingly</li>
                    </ul>
                    
                    <textarea id="realWorldSolution" rows="6" placeholder="Describe your solution using computational thinking principles..."></textarea>
                    <button onclick="submitRealWorld()" style="margin-top: 10px;">Submit Solution</button>
                    <div id="realWorldFeedback"></div>
                </div>

                <div class="navigation-buttons">
                    <button onclick="showSection('exam')">Previous: Exam Practice</button>
                    <button onclick="showSection('summary')">Next: Summary</button>
                </div>
            </div>
        </section>

        <!-- Summary Section -->
        <section id="summary" class="section">
            <div class="card">
                <h2>Summary & Final Assessment</h2>
                
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3>Key Takeaways</h3>
                    <ul style="list-style: none; padding: 0;">
                        <li>‚úÖ <strong>Abstraction</strong> - Focus on relevant details, hide complexity</li>
                        <li>‚úÖ <strong>Decomposition</strong> - Break problems into manageable parts</li>
                        <li>‚úÖ <strong>Algorithmic Thinking</strong> - Create step-by-step solutions</li>
                        <li>‚úÖ <strong>Computational Thinking</strong> - Combine all three to solve problems effectively</li>
                    </ul>
                </div>

                <h3>Final Assessment</h3>
                <p>Test your understanding with these questions:</p>

                <!-- Question 1 -->
                <div style="margin: 20px 0;">
                    <p><strong>1. What is the main purpose of abstraction?</strong></p>
                    <div>
                        <label class="quiz-option">
                            <input type="radio" name="final1" value="a"> To make problems more complex
                        </label>
                        <label class="quiz-option">
                            <input type="radio" name="final1" value="b"> To focus on important details and hide unnecessary ones
                        </label>
                        <label class="quiz-option">
                            <input type="radio" name="final1" value="c"> To break problems into smaller parts
                        </label>
                        <label class="quiz-option">
                            <input type="radio" name="final1" value="d"> To create loops in programs
                        </label>
                    </div>
                </div>

                <!-- Question 2 -->
                <div style="margin: 20px 0;">
                    <p><strong>2. Which of these is NOT a benefit of decomposition?</strong></p>
                    <div>
                        <label class="quiz-option">
                            <input type="radio" name="final2" value="a"> Makes programs run faster
                        </label>
                        <label class="quiz-option">
                            <input type="radio" name="final2" value="b"> Allows parallel development
                        </label>
                        <label class="quiz-option">
                            <input type="radio" name="final2" value="c"> Makes debugging easier
                        </label>
                        <label class="quiz-option">
                            <input type="radio" name="final2" value="d"> Enables code reuse
                        </label>
                    </div>
                </div>

                <!-- Question 3 -->
                <div style="margin: 20px 0;">
                    <p><strong>3. In algorithmic thinking, what construct would you use for "repeat until condition is met"?</strong></p>
                    <div>
                        <label class="quiz-option">
                            <input type="radio" name="final3" value="a"> Sequence
                        </label>
                        <label class="quiz-option">
                            <input type="radio" name="final3" value="b"> Selection
                        </label>
                        <label class="quiz-option">
                            <input type="radio" name="final3" value="c"> Iteration
                        </label>
                        <label class="quiz-option">
                            <input type="radio" name="final3" value="d"> Abstraction
                        </label>
                    </div>
                </div>

                <!-- Question 4 -->
                <div style="margin: 20px 0;">
                    <p><strong>4. When accessing a website using a URL, what is being abstracted away?</strong></p>
                    <input type="text" id="final4" placeholder="Your answer...">
                </div>

                <!-- Question 5 -->
                <div style="margin: 20px 0;">
                    <p><strong>5. True or False: Computational thinking is only useful for computer programming.</strong></p>
                    <div>
                        <label class="quiz-option">
                            <input type="radio" name="final5" value="true"> True
                        </label>
                        <label class="quiz-option">
                            <input type="radio" name="final5" value="false"> False
                        </label>
                    </div>
                </div>

                <!-- Question 6 -->
                <div style="margin: 20px 0;">
                    <p><strong>6. Match the example to the computational thinking skill:</strong></p>
                    <p>"Breaking a essay into introduction, body paragraphs, and conclusion" is an example of:</p>
                    <select id="final6">
                        <option value="">Select...</option>
                        <option value="abstraction">Abstraction</option>
                        <option value="decomposition">Decomposition</option>
                        <option value="algorithmic">Algorithmic Thinking</option>
                    </select>
                </div>

                <button onclick="checkFinalAssessment()" style="margin-top: 20px; font-size: 18px; padding: 15px 30px;">Submit Final Assessment</button>
                <div id="finalFeedback" style="margin-top: 20px;"></div>

                <div class="navigation-buttons">
                    <button onclick="showSection('extension')">Previous: Extension</button>
                    <button onclick="showSection('videos')">Next: Videos</button>
                </div>
            </div>
        </section>

        <!-- Videos Section -->
        <section id="videos" class="section">
            <div class="card">
                <h2>Video Resources</h2>
                
                <div style="background: #f0f8ff; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <p>üì∫ <strong>Additional video resources will be added here to support your learning.</strong></p>
                    <p>Videos will cover:</p>
                    <ul>
                        <li>Abstraction in detail with real-world examples</li>
                        <li>Decomposition case studies</li>
                        <li>Step-by-step algorithmic thinking tutorials</li>
                        <li>Exam technique tips</li>
                    </ul>
                </div>

                <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 10px;">
                    <h3>üé¨ Video Content Coming Soon!</h3>
                    <p>Check back later for helpful video tutorials.</p>
                </div>

                <div style="margin-top: 30px;">
                    <h3>Congratulations!</h3>
                    <p>You've completed the Computational Thinking lesson. Your final statistics:</p>
                    <div style="background: #e8f5e9; padding: 20px; border-radius: 10px;">
                        <p><strong>Total XP Earned:</strong> <span id="totalXP">0</span></p>
                        <p><strong>Final Level:</strong> <span id="finalLevel">1</span></p>
                        <p><strong>Achievements Unlocked:</strong> <span id="achievementCount">0</span></p>
                    </div>
                </div>

                <div class="navigation-buttons">
                    <button onclick="showSection('summary')">Previous: Summary</button>
                    <button onclick="window.print()">Print Worksheet</button>
                </div>
            </div>
        </section>
    </div>

    <!-- Common Mistakes Section (appears in sidebar) -->
    <div style="position: fixed; top: 200px; right: 20px; width: 250px; background: #fff3cd; padding: 15px; border-radius: 10px; box-shadow: var(--shadow); display: none; z-index: 996;" id="commonMistakes">
        <button onclick="this.parentElement.style.display='none'" style="position: absolute; top: 5px; right: 5px; background: transparent; border: none; font-size: 20px; cursor: pointer; padding: 0;">√ó</button>
        <h4>‚ö†Ô∏è Common Mistakes</h4>
        <ul style="font-size: 14px; padding-left: 20px;">
            <li>Confusing abstraction with decomposition</li>
            <li>Including too much detail when abstracting</li>
            <li>Making decomposed parts too large</li>
            <li>Forgetting iteration in algorithms</li>
            <li>Not testing each decomposed component</li>
        </ul>
        <button onclick="toggleCommonMistakes()" style="margin-top: 10px; font-size: 14px; padding: 5px 10px;">Show on All Pages</button>
    </div>

    <!-- Feedback Modal -->
    <div class="feedback-modal" id="feedbackModal">
        <div class="feedback-content">
            <span class="close-modal" onclick="closeFeedback()">&times;</span>
            <h3>Send Feedback</h3>
            <p>Found a bug or have a suggestion? Let us know!</p>
            <textarea id="feedbackText" rows="5" placeholder="Describe the issue or suggestion..."></textarea>
            <button onclick="sendFeedback()" style="margin-top: 15px;">Send Feedback</button>
            <div id="feedbackStatus"></div>
        </div>
    </div>

    <!-- Feedback Button -->
    <div class="feedback-btn" onclick="openFeedback()">
        <span style="font-size: 24px;">üí¨</span>
    </div>

    <!-- Achievement Popup -->
    <div class="achievement-popup" id="achievementPopup" role="alert" aria-live="polite">
        <h3 id="achievementTitle">Achievement Unlocked!</h3>
        <p id="achievementDesc">Description</p>
    </div>

    <!-- Accessibility Toggle -->
    <button class="accessibility-toggle" onclick="toggleAccessibility()" aria-label="Accessibility Options" title="Accessibility Options">
        <span style="font-size: 20px;">‚ôø</span>
    </button>

    <!-- Accessibility Controls -->
    <div class="accessibility-controls" id="accessibilityControls">
        <h4>Accessibility Options</h4>
        <label>
            <input type="checkbox" onchange="toggleHighContrast()"> High Contrast Mode
        </label><br>
        <label>
            <input type="checkbox" onchange="toggleDyslexiaFont()"> Dyslexia-Friendly Font
        </label><br>
        <label>
            Font Size: 
            <input type="range" min="12" max="24" value="16" onchange="changeFontSize(this.value)">
        </label>
    </div>

    <!-- Shame Message -->
    <div class="shame-message" id="shameMessage">
        üö´ Copying and pasting detected! Real learning comes from doing the work yourself. Try again!
    </div>

    <script>
        (function() { // Start IIFE to prevent global scope pollution
        
        // Global variables - with defaults
        let currentSection = 'starter';
        let xp = 0;
        let level = 1;
        let achievements = new Set();
        let sectionProgress = {};
        let decompositionStep = 0;
        let canvasDrawing = false;
        let ctx = null;
        let draggedElement = null;

        // XP thresholds for levels
        const levelThresholds = [0, 100, 250, 450, 700, 1000];

        // Initialize - Improved with error handling
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // Check if essential elements exist
                const essentialElements = ['currentXP', 'level', 'xpFill', 'requiredXP'];
                let allElementsPresent = true;
                
                essentialElements.forEach(id => {
                    if (!document.getElementById(id)) {
                        console.error(`Essential element missing: ${id}`);
                        allElementsPresent = false;
                    }
                });
                
                if (!allElementsPresent) {
                    console.error('Some essential elements are missing. The worksheet may not function properly.');
                }
                
                initializeDragAndDrop();
                // Initialize canvas for drawing (if element exists)
                const canvas = document.getElementById('drawingCanvas');
                if (canvas) {
                    initializeCanvas();
                }
                
                preventPaste();
                loadProgress();
                
                // Initialize XP display
                updateXPDisplay();
                
                // Initialize map display
                updateMapDisplay();
                
                // Initialize from URL hash
                const hash = window.location.hash.slice(1);
                if (hash && document.getElementById(hash)) {
                    showSection(hash, false);
                }
                
                // Smooth scroll behavior
                document.documentElement.style.scrollBehavior = 'smooth';
                
                // Check for reduced motion preference
                if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                    document.documentElement.style.scrollBehavior = 'auto';
                    // Disable animations
                    const style = document.createElement('style');
                    style.textContent = '*, *::before, *::after { animation-duration: 0.01ms !important; transition-duration: 0.01ms !important; }';
                    document.head.appendChild(style);
                }
                
                // Load custom fonts if needed
                if ('fonts' in document) {
                    document.fonts.ready.then(function() {
                        document.body.classList.add('fonts-loaded');
                    });
                }
                
                // Add reset all button to accessibility controls
                const accessibilityControls = document.getElementById('accessibilityControls');
                if (accessibilityControls) {
                    const resetBtn = document.createElement('button');
                    resetBtn.textContent = 'Reset All Progress';
                    resetBtn.style.cssText = 'margin-top: 15px; background: #e74c3c; font-size: 14px;';
                    resetBtn.onclick = resetAllProgress;
                    accessibilityControls.appendChild(resetBtn);
                }
                
                // Initialize XP display
                updateXPDisplay();
                
                // Check storage availability and notify user
                if (!isStorageAvailable()) {
                    console.warn('Local storage is not available. Progress will not be saved between sessions.');
                    // Create a notice for the user
                    const notice = document.createElement('div');
                    notice.style.cssText = `
                        position: fixed;
                        bottom: 70px;
                        left: 20px;
                        background: #f39c12;
                        color: white;
                        padding: 15px 20px;
                        border-radius: 5px;
                        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
                        z-index: 999;
                        max-width: 300px;
                        font-size: 14px;
                    `;
                    notice.innerHTML = `
                        <strong>‚ö†Ô∏è Storage Disabled</strong><br>
                        Your progress won't be saved between sessions. This may be due to private browsing mode or browser settings.
                        <button onclick="this.parentElement.style.display='none'" style="float: right; background: transparent; border: none; color: white; cursor: pointer; font-size: 20px; margin-top: -10px;">√ó</button>
                    `;
                    document.body.appendChild(notice);
                    
                    // Auto-hide after 10 seconds
                    setTimeout(() => {
                        if (notice.parentElement) {
                            notice.style.display = 'none';
                        }
                    }, 10000);
                }
                
                console.log('Computational Thinking Worksheet initialized successfully');
            } catch (error) {
                console.error('Error initializing worksheet:', error);
            }
        });

        // Handle navigation with browser back/forward
        window.addEventListener('popstate', function(e) {
            const hash = window.location.hash.slice(1);
            if (hash && document.getElementById(hash)) {
                showSection(hash, false);
            }
        });

        // Navigation helper
        function navigateToSection(sectionId) {
            showSection(sectionId, true);
        }

        // Navigation
        function showSection(sectionId, fromNav = true) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Show selected section
            const targetSection = document.getElementById(sectionId);
            if (!targetSection) return;
            targetSection.classList.add('active');
            
            // Update nav
            document.querySelectorAll('.nav-item').forEach((item, index) => {
                item.classList.remove('active');
                if (item.getAttribute('onclick').includes(sectionId)) {
                    item.classList.add('active');
                }
            });
            
            currentSection = sectionId;
            
            // Award XP for section progression
            if (!sectionProgress[sectionId]) {
                sectionProgress[sectionId] = true;
                awardXP(10, "Section Progress");
            }
            
            // Initialize Python editor if entering exam section
            if (sectionId === 'exam' && typeof ace !== 'undefined' && !pythonEditors[2]) {
                setTimeout(() => {
                    initializePythonEditor(2);
                }, 100);
            }
            
            // Check if we should show common mistakes
            checkShowCommonMistakes();
            
            // Smooth scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            // Update URL without reload
            if (fromNav) {
                history.pushState(null, '', '#' + sectionId);
            }
        }

        // XP and Achievements System
        function awardXP(amount, reason) {
            if (amount <= 0) return;
            
            xp += amount;
            updateXPDisplay();
            
            // Check for level up
            for (let i = level; i < levelThresholds.length; i++) {
                if (xp >= levelThresholds[i]) {
                    level = i + 1;
                    showAchievement("Level Up!", `You reached Level ${level}!`);
                }
            }
            
            // Save progress if available
            if (isStorageAvailable()) {
                saveProgress();
            }
        }

        function updateXPDisplay() {
            const currentXPElement = document.getElementById('currentXP');
            const levelElement = document.getElementById('level');
            const xpFillElement = document.getElementById('xpFill');
            const requiredXPElement = document.getElementById('requiredXP');
            
            if (!currentXPElement || !levelElement || !xpFillElement || !requiredXPElement) {
                console.warn('XP display elements not found');
                return;
            }
            
            currentXPElement.textContent = xp;
            levelElement.textContent = Math.min(level, 5);
            
            const currentLevelXP = levelThresholds[level - 1] || 0;
            const nextLevelXP = levelThresholds[level] || levelThresholds[levelThresholds.length - 1];
            const progress = ((xp - currentLevelXP) / (nextLevelXP - currentLevelXP)) * 100;
            
            xpFillElement.style.width = Math.max(0, Math.min(100, progress)) + '%';
            requiredXPElement.textContent = nextLevelXP;
        }

        function showAchievement(title, description) {
            const popup = document.getElementById('achievementPopup');
            if (!popup) return;
            
            document.getElementById('achievementTitle').textContent = title;
            document.getElementById('achievementDesc').textContent = description;
            
            // Clear any existing timeout
            if (window.achievementTimeout) {
                clearTimeout(window.achievementTimeout);
            }
            
            // Add particles
            addParticles(popup);
            
            // Show popup
            popup.classList.add('show');
            popup.style.display = 'flex';
            
            // Hide after delay
            window.achievementTimeout = setTimeout(() => {
                popup.classList.remove('show');
                setTimeout(() => {
                    popup.style.display = 'none';
                }, 500);
            }, 3000);
            
            achievements.add(title);
            
            // Haptic feedback if available
            if (navigator.vibrate) {
                navigator.vibrate(200);
            }
        }

        function addParticles(container) {
            const particleContainer = document.createElement('div');
            particleContainer.className = 'particles';
            
            for (let i = 0; i < 10; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 2 + 's';
                particle.style.animationDuration = (Math.random() * 3 + 2) + 's';
                particleContainer.appendChild(particle);
            }
            
            container.appendChild(particleContainer);
            
            // Remove particles after animation
            setTimeout(() => {
                particleContainer.remove();
            }, 5000);
        }

        // Drag and Drop - Improved with event delegation
        function initializeDragAndDrop() {
            // Use event delegation for better performance
            document.addEventListener('dragstart', function(e) {
                if (e.target.classList.contains('drag-item')) {
                    dragStart(e);
                }
            });
            
            document.addEventListener('dragend', function(e) {
                if (e.target.classList.contains('drag-item')) {
                    dragEnd(e);
                }
            });
            
            // Add event listeners to all drop zones
            document.querySelectorAll('.drop-zone').forEach(zone => {
                zone.addEventListener('dragover', dragOver);
                zone.addEventListener('drop', dragDrop);
                zone.addEventListener('dragleave', dragLeave);
            });
        }

       

        function dragStart(e) {
            draggedElement = e.target;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', e.target.innerHTML);
            
            // Store all data attributes
            const dataAttrs = {};
            for (const attr in e.target.dataset) {
                dataAttrs[attr] = e.target.dataset[attr];
            }
            e.dataTransfer.setData('dataAttrs', JSON.stringify(dataAttrs));
            
            e.target.classList.add('dragging');
            
            // Visual feedback
            setTimeout(() => {
                e.target.style.opacity = '0.5';
            }, 0);
        }

        function dragEnd(e) {
            e.target.classList.remove('dragging');
            e.target.style.opacity = '';
            draggedElement = null;
        }

        function dragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            e.currentTarget.classList.add('drag-over');
            return false;
        }

        function dragLeave(e) {
            // Check if we're actually leaving the drop zone
            if (e.target === e.currentTarget) {
                e.currentTarget.classList.remove('drag-over');
            }
        }

        function dragDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const dropZone = e.currentTarget;
            dropZone.classList.remove('drag-over');
            
            if (!draggedElement) return;
            
            // Create new element
            const newItem = document.createElement('div');
            newItem.className = 'drag-item';
            newItem.draggable = true;
            newItem.innerHTML = e.dataTransfer.getData('text/html');
            
            // Restore data attributes
            try {
                const dataAttrs = JSON.parse(e.dataTransfer.getData('dataAttrs'));
                for (const attr in dataAttrs) {
                    newItem.dataset[attr] = dataAttrs[attr];
                }
            } catch (e) {
                console.error('Error parsing data attributes:', e);
            }
            
            // Append to drop zone
            dropZone.appendChild(newItem);
            
            // Remove original element
            if (draggedElement && draggedElement.parentNode) {
                draggedElement.parentNode.removeChild(draggedElement);
            }
            
            return false;
        }

        // Starter Activity Functions
        function resetStarter() {
            location.reload(); // Simple reset for now
        }

        function checkStarter() {
            let correct = 0;
            const dropZones = document.querySelectorAll('#starter .drop-zone');
            
            dropZones.forEach(zone => {
                const zoneCategory = zone.dataset.category;
                const items = zone.querySelectorAll('.drag-item');
                
                zone.classList.remove('correct', 'incorrect');
                
                let zoneCorrect = true;
                items.forEach(item => {
                    if (item.dataset.category !== zoneCategory) {
                        zoneCorrect = false;
                    }
                });
                
                if (items.length > 0 && zoneCorrect && items.length === 2) {
                    zone.classList.add('correct');
                    correct++;
                } else if (items.length > 0) {
                    zone.classList.add('incorrect');
                }
            });
            
            const feedback = document.getElementById('starterFeedback');
            if (correct === 3) {
                feedback.innerHTML = '<p style="color: green;">‚úÖ Excellent! You correctly sorted all examples.</p>';
                awardXP(30, "Starter Activity Completed");
                if (!achievements.has("Quick Starter")) {
                    showAchievement("Quick Starter", "Completed the starter activity perfectly!");
                }
            } else {
                feedback.innerHTML = `<p style="color: orange;">‚ö†Ô∏è You got ${correct}/3 categories correct. Remember:<br>
                - Abstraction: Hiding unnecessary details<br>
                - Decomposition: Breaking into smaller parts<br>
                - Algorithmic Thinking: Step-by-step solutions</p>`;
                awardXP(correct * 5, "Starter Activity Attempt");
            }
        }



        function checkIntroQuiz() {
            const selected = document.querySelector('input[name="introQ1"]:checked');
            const feedback = document.getElementById('introQuizFeedback');
            
            if (!selected) {
                feedback.innerHTML = '<p style="color: orange;">Please select an answer.</p>';
                return;
            }
            
            if (selected.value === 'b') {
                feedback.innerHTML = '<p style="color: green;">‚úÖ Correct! Computational thinking is indeed a problem-solving process using abstraction, decomposition and algorithmic thinking.</p>';
                awardXP(20, "Introduction Quiz");
            } else {
                feedback.innerHTML = '<p style="color: red;">‚ùå Not quite. Computational thinking is a problem-solving process that uses abstraction, decomposition and algorithmic thinking.</p>';
                awardXP(5, "Introduction Quiz Attempt");
            }
        }

        // Map Simulation for Abstraction
        const mapLayers = {
            roads: true,
            buildings: true,
            trees: true,
            labels: true,
            traffic: false,
            parking: false,
            terrain: false
        };
        
        let mapLayerClicks = new Set();

        function toggleMapLayer(layer) {
            mapLayers[layer] = !mapLayers[layer];
            updateMapDisplay();
            
            // Award XP for interaction
            if (!mapLayerClicks.has(layer)) {
                mapLayerClicks.add(layer);
                awardXP(3, `Toggled ${layer} layer`);
                
                if (mapLayerClicks.size >= 5) {
                    awardXP(10, "Map Explorer");
                }
            }
        }

        function updateMapDisplay() {
            const mapDiv = document.getElementById('mapSimulation');
            mapDiv.innerHTML = '';
            
            // Create a more realistic map
            const mapContainer = document.createElement('div');
            mapContainer.style.cssText = 'position: relative; width: 100%; height: 100%;';
            
            // Terrain layer (background)
            if (mapLayers.terrain) {
                const terrain = document.createElement('div');
                terrain.style.cssText = `position: absolute; width: 100%; height: 100%; 
                    background: linear-gradient(45deg, #d4f1d4 25%, #c8e6c9 25%, #c8e6c9 50%, 
                    #d4f1d4 50%, #d4f1d4 75%, #c8e6c9 75%, #c8e6c9);
                    background-size: 50px 50px; opacity: 0.3;`;
                mapContainer.appendChild(terrain);
            }
            
            // Base map
            const baseMap = document.createElement('div');
            baseMap.style.cssText = 'position: absolute; width: 100%; height: 100%; background: #f5f5dc;';
            mapContainer.appendChild(baseMap);
            
            // Water features
            const river = document.createElement('div');
            river.style.cssText = `position: absolute; width: 60px; height: 100%; left: 70%; 
                background: #64b5f6; border-radius: 30px; opacity: 0.6;`;
            mapContainer.appendChild(river);
            
            // Parks
            const park = document.createElement('div');
            park.style.cssText = `position: absolute; width: 120px; height: 80px; left: 10%; top: 60%; 
                background: #81c784; border-radius: 20px; opacity: 0.5;`;
            mapContainer.appendChild(park);
            
            // Trees layer
            if (mapLayers.trees) {
                // Forest area
                for (let i = 0; i < 15; i++) {
                    const tree = document.createElement('div');
                    const x = 10 + (i % 5) * 20 + Math.random() * 10;
                    const y = 65 + Math.floor(i / 5) * 15 + Math.random() * 5;
                    tree.style.cssText = `position: absolute; width: 15px; height: 15px; 
                        background: #2e7d32; border-radius: 50%; left: ${x}%; top: ${y}%;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.2);`;
                    mapContainer.appendChild(tree);
                }
                
                // Random trees
                for (let i = 0; i < 25; i++) {
                    const tree = document.createElement('div');
                    tree.style.cssText = `position: absolute; width: 12px; height: 12px; 
                        background: #388e3c; border-radius: 50%; 
                        left: ${Math.random() * 90}%; top: ${Math.random() * 90}%;
                        box-shadow: 0 1px 3px rgba(0,0,0,0.2);`;
                    mapContainer.appendChild(tree);
                }
            }
            
            // Buildings layer
            if (mapLayers.buildings) {
                const buildings = [
                    {left: '15%', top: '20%', width: '80px', height: '60px', color: '#757575', label: 'School'},
                    {left: '55%', top: '15%', width: '100px', height: '80px', color: '#616161', label: 'Shopping Mall'},
                    {left: '35%', top: '45%', width: '70px', height: '50px', color: '#9e9e9e', label: 'Library'},
                    {left: '10%', top: '40%', width: '60px', height: '40px', color: '#ef5350', label: 'Hospital'},
                    {left: '60%', top: '60%', width: '90px', height: '70px', color: '#5c6bc0', label: 'Town Hall'},
                    {left: '80%', top: '30%', width: '50px', height: '50px', color: '#ffa726', label: 'Post Office'}
                ];
                
                buildings.forEach(b => {
                    const building = document.createElement('div');
                    building.style.cssText = `position: absolute; background: ${b.color}; 
                        left: ${b.left}; top: ${b.top}; width: ${b.width}; height: ${b.height};
                        box-shadow: 0 4px 8px rgba(0,0,0,0.3); border-radius: 4px;`;
                    building.dataset.label = b.label;
                    mapContainer.appendChild(building);
                });
            }
            
            // Roads layer
            if (mapLayers.roads) {
                // Main roads
                const mainRoadH = document.createElement('div');
                mainRoadH.style.cssText = `position: absolute; background: #424242; 
                    width: 100%; height: 40px; top: 50%; transform: translateY(-50%);`;
                mapContainer.appendChild(mainRoadH);
                
                const mainRoadV = document.createElement('div');
                mainRoadV.style.cssText = `position: absolute; background: #424242; 
                    width: 40px; height: 100%; left: 45%;`;
                mapContainer.appendChild(mainRoadV);
                
                // Secondary roads
                const roads = [
                    {width: '100%', height: '30px', top: '25%', left: '0', rotate: '0'},
                    {width: '100%', height: '30px', top: '75%', left: '0', rotate: '0'},
                    {width: '30px', height: '100%', top: '0', left: '20%', rotate: '0'},
                    {width: '30px', height: '100%', top: '0', left: '70%', rotate: '0'}
                ];
                
                roads.forEach(r => {
                    const road = document.createElement('div');
                    road.style.cssText = `position: absolute; background: #616161; 
                        width: ${r.width}; height: ${r.height}; top: ${r.top}; left: ${r.left};`;
                    mapContainer.appendChild(road);
                });
                
                // Road markings
                const markings = document.createElement('div');
                markings.style.cssText = `position: absolute; width: 100%; height: 100%;`;
                markings.innerHTML = `
                    <div style="position: absolute; width: 100%; height: 2px; background: #fdd835; 
                        top: 50%; left: 0; transform: translateY(-50%);"></div>
                    <div style="position: absolute; width: 2px; height: 100%; background: #fdd835; 
                        left: 45%; top: 0; transform: translateX(19px);"></div>
                `;
                mapContainer.appendChild(markings);
            }
            
            // Traffic layer
            if (mapLayers.traffic) {
                // Traffic lights
                const trafficLights = [
                    {left: '45%', top: '50%'},
                    {left: '45%', top: '25%'},
                    {left: '20%', top: '50%'},
                    {left: '70%', top: '50%'}
                ];
                
                trafficLights.forEach(tl => {
                    const light = document.createElement('div');
                    light.style.cssText = `position: absolute; width: 20px; height: 20px; 
                        background: #f44336; border-radius: 50%; left: ${tl.left}; top: ${tl.top};
                        border: 3px solid #333; box-shadow: 0 0 10px rgba(244,67,54,0.5);`;
                    mapContainer.appendChild(light);
                });
                
                // Cars
                for (let i = 0; i < 8; i++) {
                    const car = document.createElement('div');
                    const isHorizontal = i % 2 === 0;
                    car.style.cssText = `position: absolute; width: ${isHorizontal ? '25px' : '15px'}; 
                        height: ${isHorizontal ? '15px' : '25px'}; 
                        background: ${['#e53935', '#1e88e5', '#43a047', '#fdd835'][i % 4]}; 
                        left: ${isHorizontal ? Math.random() * 90 + '%' : (45 + (i % 2) * 25 + '%')}; 
                        top: ${isHorizontal ? (50 + (i % 2) * 25 + '%') : Math.random() * 90 + '%'};
                        border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.3);`;
                    mapContainer.appendChild(car);
                }
            }
            
            // Parking layer
            if (mapLayers.parking) {
                const parkingAreas = [
                    {left: '18%', top: '30%'},
                    {left: '58%', top: '25%'},
                    {left: '63%', top: '70%'}
                ];
                
                parkingAreas.forEach(pa => {
                    const parking = document.createElement('div');
                    parking.style.cssText = `position: absolute; width: 60px; height: 40px; 
                        background: repeating-linear-gradient(90deg, #bdbdbd, #bdbdbd 15px, #fdd835 15px, #fdd835 20px);
                        left: ${pa.left}; top: ${pa.top}; border: 2px solid #616161;`;
                    parking.innerHTML = '<div style="text-align: center; font-size: 20px; color: #1976d2;">P</div>';
                    mapContainer.appendChild(parking);
                });
            }
            
            // Labels layer
            if (mapLayers.labels) {
                const labelElements = mapContainer.querySelectorAll('[data-label]');
                labelElements.forEach(el => {
                    const label = document.createElement('div');
                    label.style.cssText = `position: absolute; left: ${el.style.left}; 
                        top: calc(${el.style.top} + ${el.style.height} + 5px); 
                        font-weight: bold; color: #1976d2; font-size: 12px; 
                        background: rgba(255,255,255,0.8); padding: 2px 5px; border-radius: 3px;
                        white-space: nowrap;`;
                    label.textContent = el.dataset.label;
                    mapContainer.appendChild(label);
                });
                
                // Street names
                if (mapLayers.roads) {
                    const streetNames = [
                        {text: 'High Street', left: '50%', top: '48%', rotate: '0'},
                        {text: 'Main Avenue', left: '43%', top: '30%', rotate: '90deg'},
                        {text: 'Park Road', left: '50%', top: '73%', rotate: '0'},
                        {text: 'School Lane', left: '18%', top: '30%', rotate: '90deg'}
                    ];
                    
                    streetNames.forEach(sn => {
                        const name = document.createElement('div');
                        name.style.cssText = `position: absolute; left: ${sn.left}; top: ${sn.top}; 
                            color: white; font-size: 10px; font-weight: bold; 
                            transform: translateX(-50%) rotate(${sn.rotate});
                            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);`;
                        name.textContent = sn.text;
                        mapContainer.appendChild(name);
                    });
                }
            }
            
            mapDiv.appendChild(mapContainer);
        }

        // Initialize map
        updateMapDisplay();

        // Abstraction Fill in Blanks
        function checkAbstractionFill() {
            const abs1 = document.getElementById('abs1').value;
            const abs2 = document.getElementById('abs2').value;
            const abs3 = document.getElementById('abs3').value;
            const abs4 = document.getElementById('abs4').value;
            
            let correct = 0;
            if (abs1 === 'correct') correct++;
            if (abs2 === 'correct') correct++;
            if (abs3 === 'correct') correct++;
            if (abs4 === 'correct') correct++;
            
            const feedback = document.getElementById('abstractionFillFeedback');
            if (correct === 4) {
                feedback.innerHTML = '<p style="color: green;">‚úÖ Perfect! You understand abstraction examples well.</p>';
                awardXP(25, "Abstraction Fill in Blanks");
            } else if (correct > 0) {
                feedback.innerHTML = `<p style="color: orange;">‚ö†Ô∏è You got ${correct}/4 correct. Keep trying!</p>`;
            }
        }

        // Abstraction Matching
        function checkAbstractionMatch() {
            let correct = 0;
            const dropZones = document.querySelectorAll('#abstraction .drop-zone[data-match]');
            
            dropZones.forEach(zone => {
                const zoneMatch = zone.dataset.match;
                const item = zone.querySelector('.drag-item');
                
                if (item && item.dataset.match === zoneMatch) {
                    zone.classList.add('correct');
                    correct++;
                } else if (item) {
                    zone.classList.add('incorrect');
                }
            });
            
            const feedback = document.getElementById('abstractionMatchFeedback');
            if (correct === 4) {
                feedback.innerHTML = '<p style="color: green;">‚úÖ Excellent matching! You understand real-world abstraction.</p>';
                awardXP(30, "Abstraction Matching");
            } else {
                feedback.innerHTML = `<p style="color: orange;">‚ö†Ô∏è You matched ${correct}/4 correctly. Think about what each tool hides from the user.</p>`;
                awardXP(correct * 5, "Abstraction Matching Attempt");
            }
        }

        // Decomposition Simulation
        const decompositionSteps = [
            {
                title: "Making a Sandwich",
                content: "This seems like a simple task, but let's break it down into smaller steps..."
            },
            {
                title: "Step 1: Gather Ingredients",
                content: "‚Ä¢ Get bread<br>‚Ä¢ Get filling (cheese, ham, etc.)<br>‚Ä¢ Get condiments<br>‚Ä¢ Get plate and knife"
            },
            {
                title: "Step 2: Prepare Bread",
                content: "‚Ä¢ Take two slices of bread<br>‚Ä¢ Place on plate<br>‚Ä¢ Apply butter or spread to each slice"
            },
            {
                title: "Step 3: Add Filling",
                content: "‚Ä¢ Place filling on one slice<br>‚Ä¢ Add any vegetables<br>‚Ä¢ Add condiments"
            },
            {
                title: "Step 4: Complete Sandwich",
                content: "‚Ä¢ Place second slice on top<br>‚Ä¢ Cut if desired<br>‚Ä¢ Clean up workspace<br><br><strong>Notice how each step could be done by different people!</strong>"
            }
        ];

        function nextDecompositionStep() {
            if (decompositionStep < decompositionSteps.length - 1) {
                decompositionStep++;
                updateDecompositionDisplay();
            }
        }

        function previousDecompositionStep() {
            if (decompositionStep > 0) {
                decompositionStep--;
                updateDecompositionDisplay();
            }
        }

        function updateDecompositionDisplay() {
            const stepsDiv = document.getElementById('decompositionSteps');
            if (!stepsDiv) return; // Exit if element doesn't exist
            
            const currentStepData = decompositionSteps[decompositionStep];
            if (!currentStepData) return; // Exit if step data doesn't exist
            
            stepsDiv.innerHTML = `<h4>${currentStepData.title}</h4><p>${currentStepData.content}</p>`;
            
            // Update step indicators
            for (let i = 1; i <= 5; i++) {
                const stepIndicator = document.getElementById(`step${i}`);
                if (!stepIndicator) continue;
                
                stepIndicator.classList.remove('active', 'completed');
                if (i - 1 === decompositionStep) {
                    stepIndicator.classList.add('active');
                } else if (i - 1 < decompositionStep) {
                    stepIndicator.classList.add('completed');
                }
            }
        }

        // Benefits Matching
        function checkBenefitsMatch() {
            let correct = 0;
            const dropZones = document.querySelectorAll('#decomposition .drop-zone[data-benefit]');
            
            dropZones.forEach(zone => {
                const zoneBenefit = zone.dataset.benefit;
                const item = zone.querySelector('.drag-item');
                
                if (item && item.dataset.benefit === zoneBenefit) {
                    zone.classList.add('correct');
                    correct++;
                } else if (item) {
                    zone.classList.add('incorrect');
                }
            });
            
            const feedback = document.getElementById('benefitsFeedback');
            if (correct === 4) {
                feedback.innerHTML = '<p style="color: green;">‚úÖ Perfect! You understand the benefits of decomposition.</p>';
                awardXP(30, "Decomposition Benefits");
            } else {
                feedback.innerHTML = `<p style="color: orange;">‚ö†Ô∏è You matched ${correct}/4 correctly. Review the benefits of breaking down problems.</p>`;
                awardXP(correct * 5, "Benefits Attempt");
            }
        }

        // Chess Decomposition
        function checkChessDecomposition() {
            const correctAnswers = {
                chess1: 'board',
                chess2: 'input',
                chess3: 'moves',
                chess4: 'state',
                chess5: 'AI'
            };
            
            let correct = 0;
            
            for (let i = 1; i <= 5; i++) {
                const select = document.getElementById(`chess${i}`);
                if (select.value === correctAnswers[`chess${i}`]) {
                    correct++;
                    select.style.borderColor = '#27ae60';
                } else {
                    select.style.borderColor = '#e74c3c';
                }
            }
            
            const feedbackDiv = document.getElementById('chessFeedback');
            if (correct === 5) {
                feedbackDiv.innerHTML = '<p style="color: green;">‚úÖ Excellent decomposition! You broke down the chess game perfectly.</p>';
                awardXP(35, "Chess Decomposition");
            } else {
                feedbackDiv.innerHTML = `<p style="color: orange;">‚ö†Ô∏è You got ${correct}/5 correct. Think about the main components needed for a chess game.</p>`;
                awardXP(correct * 5, "Chess Decomposition Attempt");
            }
        }

        // Flowchart Functions
        let flowchartOrder = [];
        
        function addToFlowchart(button, order) {
            const dropZone = document.getElementById('flowchartDropZone');
            
            // Award XP for first interaction
            if (flowchartOrder.length === 0) {
                awardXP(5, "Started building algorithm");
            }
            
            // Create step element
            const stepDiv = document.createElement('div');
            stepDiv.className = 'flowchart-added';
            stepDiv.dataset.order = order;
            stepDiv.innerHTML = `
                <span>${flowchartOrder.length + 1}. ${button.textContent}</span>
                <button onclick="removeFromFlowchart(this)" style="background: #e74c3c; padding: 5px 10px;">Remove</button>
            `;
            
            // Clear placeholder text
            if (flowchartOrder.length === 0) {
                dropZone.innerHTML = '';
            }
            
            dropZone.appendChild(stepDiv);
            flowchartOrder.push(order);
            
            // Disable the button
            button.disabled = true;
        }
        
        function removeFromFlowchart(removeBtn) {
            const stepDiv = removeBtn.parentElement;
            const order = parseInt(stepDiv.dataset.order);
            const dropZone = document.getElementById('flowchartDropZone');
            
            // Remove from array
            flowchartOrder = flowchartOrder.filter(o => o !== order);
            
            // Re-enable the button
            const buttons = document.querySelectorAll('.flowchart-step');
            buttons.forEach(btn => {
                if (parseInt(btn.dataset.order) === order) {
                    btn.disabled = false;
                }
            });
            
            // Remove element
            stepDiv.remove();
            
            // Update numbering
            const remainingSteps = dropZone.querySelectorAll('.flowchart-added');
            remainingSteps.forEach((step, index) => {
                const span = step.querySelector('span');
                const text = span.textContent.split('. ')[1];
                span.textContent = `${index + 1}. ${text}`;
            });
            
            // Show placeholder if empty
            if (flowchartOrder.length === 0) {
                dropZone.innerHTML = '<p style="color: #999;">Click steps above to add them here...</p>';
            }
        }
        
        function clearFlowchart() {
            flowchartOrder = [];
            const dropZone = document.getElementById('flowchartDropZone');
            dropZone.innerHTML = '<p style="color: #999;">Click steps above to add them here...</p>';
            
            // Re-enable all buttons
            const buttons = document.querySelectorAll('.flowchart-step');
            buttons.forEach(btn => {
                btn.disabled = false;
            });
            
            document.getElementById('flowchartFeedback').innerHTML = '';
        }
        
        function checkFlowchart() {
            const feedback = document.getElementById('flowchartFeedback');
            
            if (flowchartOrder.length !== 7) {
                feedback.innerHTML = '<p style="color: orange;">‚ö†Ô∏è Please add all 7 steps before checking.</p>';
                return;
            }
            
            let correct = true;
            let correctCount = 0;
            
            for (let i = 0; i < flowchartOrder.length; i++) {
                if (flowchartOrder[i] === i + 1) {
                    correctCount++;
                } else {
                    correct = false;
                }
            }
            
            if (correct) {
                feedback.innerHTML = '<p style="color: green;">‚úÖ Perfect algorithm! The steps are in the correct sequence.</p>';
                awardXP(40, "Tea Algorithm");
                if (!achievements.has("Algorithm Master")) {
                    showAchievement("Algorithm Master", "Created a perfect step-by-step algorithm!");
                }
            } else {
                feedback.innerHTML = `<p style="color: orange;">‚ö†Ô∏è ${correctCount}/7 steps are in the correct position. Think about the logical order of making tea.</p>`;
                awardXP(correctCount * 3, "Algorithm Attempt");
            }
        }

        // Constructs Check
        function checkConstructs() {
            const correct = {
                construct1: 'iteration',
                construct2: 'selection',
                construct3: 'sequence'
            };
            
            let score = 0;
            let feedback = '';
            
            for (let i = 1; i <= 3; i++) {
                const selected = document.getElementById(`construct${i}`).value;
                if (selected === correct[`construct${i}`]) {
                    score++;
                }
            }
            
            const feedbackDiv = document.getElementById('constructsFeedback');
            if (score === 3) {
                feedbackDiv.innerHTML = '<p style="color: green;">‚úÖ Excellent! You can identify all three algorithmic constructs.</p>';
                awardXP(30, "Identify Constructs");
            } else {
                feedbackDiv.innerHTML = `<p style="color: orange;">‚ö†Ô∏è You got ${score}/3 correct. Remember:<br>
                - Sequence: Steps in order<br>
                - Selection: IF/ELSE decisions<br>
                - Iteration: Loops and repetition</p>`;
                awardXP(score * 8, "Constructs Attempt");
            }
        }

        // Bringing It Together Functions
        function checkTogetherAbstraction() {
            const checkboxes = document.querySelectorAll('#abstractionChoices input[type="checkbox"]');
            const correct = ['subject', 'room', 'time', 'teacher'];
            const incorrect = ['teacher_age', 'building_year'];
            
            let correctCount = 0;
            let incorrectCount = 0;
            
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    if (correct.includes(checkbox.value)) {
                        correctCount++;
                    } else if (incorrect.includes(checkbox.value)) {
                        incorrectCount++;
                    }
                }
            });
            
            const feedback = document.getElementById('togetherAbstractionFeedback');
            if (correctCount === 4 && incorrectCount === 0) {
                feedback.innerHTML = '<p style="color: green;">‚úÖ Perfect abstraction! You identified all relevant details and excluded unnecessary ones.</p>';
                awardXP(35, "Applied Abstraction");
            } else {
                feedback.innerHTML = `<p style="color: orange;">‚ö†Ô∏è You selected ${correctCount} relevant details correctly but also included ${incorrectCount} unnecessary details. Focus on what's essential for a timetable.</p>`;
                awardXP(correctCount * 5, "Abstraction Application");
            }
        }

        function checkTogetherDecomposition() {
            let correct = 0;
            const dropZones = document.querySelectorAll('#together .drop-zone[data-component]');
            
            dropZones.forEach(zone => {
                const zoneComponent = zone.dataset.component;
                const items = zone.querySelectorAll('.drag-item');
                
                let zoneCorrect = 0;
                items.forEach(item => {
                    if (item.dataset.component === zoneComponent) {
                        zoneCorrect++;
                    }
                });
                
                if (zoneCorrect === 2) {
                    zone.classList.add('correct');
                    correct++;
                } else {
                    zone.classList.add('incorrect');
                }
            });
            
            const feedback = document.getElementById('togetherDecompFeedback');
            if (correct === 3) {
                feedback.innerHTML = '<p style="color: green;">‚úÖ Excellent decomposition! You correctly organized all components.</p>';
                awardXP(35, "Applied Decomposition");
            } else {
                feedback.innerHTML = `<p style="color: orange;">‚ö†Ô∏è You correctly organized ${correct}/3 components. Think about which tasks belong together.</p>`;
                awardXP(correct * 10, "Decomposition Application");
            }
        }

        function checkTogetherAlgorithm() {
            const correctAnswers = {
                algo1: 'day',
                algo2: 'timetable',
                algo3: 'details',
                algo4: 'current lesson',
                algo5: 'next lesson'
            };
            
            let correct = 0;
            
            for (let i = 1; i <= 5; i++) {
                const select = document.getElementById(`algo${i}`);
                if (select.value === correctAnswers[`algo${i}`]) {
                    correct++;
                    select.style.borderColor = '#27ae60';
                } else {
                    select.style.borderColor = '#e74c3c';
                }
            }
            
            const feedback = document.getElementById('togetherAlgoFeedback');
            if (correct === 5) {
                feedback.innerHTML = '<p style="color: green;">‚úÖ Perfect algorithm! You successfully applied all three computational thinking skills.</p>';
                awardXP(40, "Complete CT Application");
                if (!achievements.has("CT Master")) {
                    showAchievement("CT Master", "Successfully applied all computational thinking skills!");
                }
            } else {
                feedback.innerHTML = `<p style="color: orange;">‚ö†Ô∏è You got ${correct}/5 steps correct. Review the algorithm structure.</p>`;
                awardXP(correct * 6, "Algorithm Application");
            }
        }

        // Exam Practice Functions
        function showMarkScheme(questionNum) {
            const marksInput = document.getElementById(`marks${questionNum}`);
            const markScheme = document.getElementById(`markScheme${questionNum}`);
            
            // Check if sufficient attempt made
            let sufficientAttempt = false;
            
            if (questionNum === 1) {
                const text1a = document.getElementById('exam1a').value;
                const text1b = document.getElementById('exam1b').value;
                sufficientAttempt = (text1a + text1b).length >= 50;
            } else if (questionNum === 2) {
                // For Python editor, check if code has been modified significantly
                const editor = pythonEditors[2];
                if (editor) {
                    const code = editor.getValue();
                    sufficientAttempt = code.includes('for') || code.includes('if') || code.includes('total');
                }
            } else if (questionNum === 3) {
                const text = document.getElementById('exam3').value;
                sufficientAttempt = text.length >= 150;
            }
            
            if (!sufficientAttempt || !marksInput.value) {
                alert('Please make a reasonable attempt at the question and enter your predicted marks before viewing the mark scheme.');
                return;
            }
            
            markScheme.style.display = 'block';
            awardXP(20, `Exam Question ${questionNum} Attempt`);
            
            // Check for keywords and award bonus XP
            const keywords = {
                1: ['abstraction', 'decomposition', 'hiding', 'simplify', 'breaking', 'smaller'],
                2: ['loop', 'for', 'iteration', 'if', 'selection', 'sequence', 'total'],
                3: ['abstraction', 'decomposition', 'algorithmic', 'hide', 'break down', 'steps']
            };
            
            let text = '';
            if (questionNum === 1) {
                text = document.getElementById('exam1a').value + document.getElementById('exam1b').value;
            } else if (questionNum === 2) {
                text = pythonEditors[2] ? pythonEditors[2].getValue() : '';
            } else if (questionNum === 3) {
                text = document.getElementById('exam3').value;
            }
            
            let keywordCount = 0;
            keywords[questionNum].forEach(keyword => {
                if (text.toLowerCase().includes(keyword)) {
                    keywordCount++;
                }
            });
            
            if (keywordCount >= 3) {
                awardXP(keywordCount * 5, "Good Use of Keywords");
            }
        }

        // Canvas Functions - Improved
        function initializeCanvas() {
            const canvas = document.getElementById('drawingCanvas');
            if (!canvas) return;
            
            ctx = canvas.getContext('2d');
            
            // Set canvas size properly for different screens
            function resizeCanvas() {
                const rect = canvas.getBoundingClientRect();
                canvas.width = rect.width;
                canvas.height = 400;
                
                // Set drawing styles
                ctx.strokeStyle = '#2c3e50';
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
            }
            
            resizeCanvas();
            window.addEventListener('resize', debounce(resizeCanvas, 250));
            
            // Mouse events
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            // Touch events for stylus/tablet
            canvas.addEventListener('touchstart', handleTouch, { passive: false });
            canvas.addEventListener('touchmove', handleTouch, { passive: false });
            canvas.addEventListener('touchend', stopDrawing);
        }

        function startDrawing(e) {
            canvasDrawing = true;
            const rect = e.target.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            ctx.beginPath();
            ctx.moveTo(x, y);
        }

        function draw(e) {
            if (!canvasDrawing) return;
            
            const rect = e.target.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            ctx.lineTo(x, y);
            ctx.stroke();
        }

        function handleTouch(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = e.target.getBoundingClientRect();
            
            const mouseEvent = new MouseEvent(
                e.type === 'touchstart' ? 'mousedown' : 
                e.type === 'touchmove' ? 'mousemove' : 'mouseup', 
                {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                }
            );
            e.target.dispatchEvent(mouseEvent);
        }

        function stopDrawing() {
            if (canvasDrawing) {
                canvasDrawing = false;
                ctx.closePath();
            }
        }

        function clearCanvas() {
            const canvas = document.getElementById('drawingCanvas');
            const rect = canvas.getBoundingClientRect();
            ctx.clearRect(0, 0, rect.width, canvas.height);
        }

        function saveCanvasAnswer() {
            const canvas = document.getElementById('drawingCanvas');
            const dataURL = canvas.toDataURL('image/png');
            
            // In a real app, would save to server
            console.log('Canvas saved');
            awardXP(10, "Used Drawing Canvas");
            
            // Visual feedback
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '‚úì Saved!';
            btn.style.background = '#27ae60';
            setTimeout(() => {
                btn.textContent = originalText;
                btn.style.background = '';
            }, 2000);
        }

        // Utility function for debouncing
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Python Editor Functions
        let pythonEditors = {};
        
        function initializePythonEditor(questionNum) {
            const editor = ace.edit(`pythonEditor${questionNum}`);
            editor.setTheme("ace/theme/monokai");
            editor.session.setMode("ace/mode/python");
            editor.setOptions({
                fontSize: "14px",
                showPrintMargin: false,
                highlightActiveLine: true,
                highlightSelectedWord: true
            });
            
            // Set initial code
            if (questionNum === 2) {
                editor.setValue(`# Shopping basket with items and prices
basket = [
    {"item": "Book", "price": 12.99},
    {"item": "Pen", "price": 2.50},
    {"item": "Notebook", "price": 8.99}
]

# Write your code here to:
# 1. Loop through items (iteration)
# 2. Calculate total (sequence)
# 3. Apply discount if > ¬£50 (selection)
# 4. Display final price

# Note: Use string concatenation or % formatting
# Do NOT use f-strings or .format()

`);
            }
            
            pythonEditors[questionNum] = editor;
            
            // Award XP for starting to code
            editor.on('change', function() {
                if (editor.getValue().length > 100 && !achievements.has(`StartedCoding${questionNum}`)) {
                    achievements.add(`StartedCoding${questionNum}`);
                    awardXP(10, "Started coding solution");
                }
            });
        }
        
        function runPythonCode(questionNum) {
            const editor = pythonEditors[questionNum];
            const code = editor.getValue();
            const outputDiv = document.getElementById(`pythonOutput${questionNum}`);
            
            outputDiv.style.display = 'block';
            outputDiv.innerHTML = 'Running...';
            
            // Configure Skulpt
            Sk.configure({
                output: function(text) {
                    outputDiv.innerHTML += text;
                },
                read: function(x) {
                    if (Sk.builtinFiles === undefined || Sk.builtinFiles["files"][x] === undefined) {
                        throw "File not found: '" + x + "'";
                    }
                    return Sk.builtinFiles["files"][x];
                }
            });
            
            // Run the code
            outputDiv.innerHTML = '';
            Sk.misceval.asyncToPromise(function() {
                return Sk.importMainWithBody("<stdin>", false, code, true);
            }).then(function() {
                awardXP(15, "Successfully ran Python code");
            }).catch(function(err) {
                outputDiv.innerHTML = `<span style="color: #e74c3c;">Error: ${err.toString()}</span>`;
            });
        }
        
        function resetPythonCode(questionNum) {
            if (confirm('Are you sure you want to reset your code?')) {
                initializePythonEditor(questionNum);
            }
        
            const problem = document.getElementById('extProblem').value;
            const abstraction = document.getElementById('extAbstraction').value;
            const decomposition = document.getElementById('extDecomposition').value;
            const algorithm = document.getElementById('extAlgorithm').value;
            
            if (problem.length < 20 || abstraction.length < 30 || decomposition.length < 30 || algorithm.length < 40) {
                document.getElementById('extension1Feedback').innerHTML = '<p style="color: orange;">Please provide more detailed answers for all sections.</p>';
                return;
            }
            
            document.getElementById('extension1Feedback').innerHTML = '<p style="color: green;">‚úÖ Excellent design! You successfully applied computational thinking to a real problem.</p>';
            awardXP(60, "Extension: App Design");
            
            if (!achievements.has("Innovator")) {
                showAchievement("Innovator", "Completed an extension challenge!");
            }
        }

        function checkRecursion() {
            const answer = document.getElementById('recursionAnswer').value.toLowerCase().trim();
            const feedback = document.getElementById('recursionFeedback');
            
            // Fibonacci sequence: 0, 1, 1, 2, 3, 5, 8...
            // mystery(6) = 8
            if (answer === '8' || answer.includes('fibonacci') || answer.includes('8')) {
                feedback.innerHTML = '<p style="color: green;">‚úÖ Correct! This calculates the Fibonacci sequence. mystery(6) = 8.</p>';
                awardXP(50, "Recursion Challenge");
            } else {
                feedback.innerHTML = '<p style="color: orange;">‚ö†Ô∏è Not quite. Trace through the function: mystery(6) calls mystery(5) + mystery(4)...</p>';
                awardXP(10, "Recursion Attempt");
            }
        }

        function submitRealWorld() {
            const solution = document.getElementById('realWorldSolution').value;
            
            if (solution.length < 100) {
                document.getElementById('realWorldFeedback').innerHTML = '<p style="color: orange;">Please provide a more detailed solution using computational thinking principles.</p>';
                return;
            }
            
            const keywords = ['abstraction', 'decomposition', 'algorithm', 'data', 'pattern', 'analyze'];
            let keywordCount = 0;
            
            keywords.forEach(keyword => {
                if (solution.toLowerCase().includes(keyword)) {
                    keywordCount++;
                }
            });
            
            if (keywordCount >= 3) {
                document.getElementById('realWorldFeedback').innerHTML = '<p style="color: green;">‚úÖ Great solution! You effectively applied computational thinking to solve a real-world problem.</p>';
                awardXP(50, "Real-World Problem Solving");
            } else {
                document.getElementById('realWorldFeedback').innerHTML = '<p style="color: orange;">‚ö†Ô∏è Good effort! Try to explicitly mention how you would use abstraction, decomposition, and algorithmic thinking.</p>';
                awardXP(20, "Real-World Attempt");
            }
        }

        // Final Assessment
        function checkFinalAssessment() {
            const answers = {
                final1: 'b',
                final2: 'a',
                final3: 'c',
                final5: 'false',
                final6: 'decomposition'
            };
            
            let score = 0;
            
            // Check multiple choice
            Object.keys(answers).forEach(key => {
                if (key.includes('final') && !key.includes('4')) {
                    const selected = document.querySelector(`input[name="${key}"]:checked`) || document.getElementById(key);
                    if (selected && (selected.value === answers[key] || selected.value === answers[key])) {
                        score++;
                    }
                }
            });
            
            // Check text answer for question 4
            const final4 = document.getElementById('final4').value.toLowerCase();
            if (final4.includes('ip') || final4.includes('address') || final4.includes('dns')) {
                score++;
            }
            
            const feedback = document.getElementById('finalFeedback');
            const percentage = Math.round((score / 6) * 100);
            
            let message = '';
            if (percentage >= 90) {
                message = `<h3 style="color: green;">üéâ Outstanding! Score: ${score}/6 (${percentage}%)</h3>
                <p>You have mastered computational thinking! Well done!</p>`;
                awardXP(100, "Final Assessment Excellence");
                if (!achievements.has("Champion")) {
                    showAchievement("Champion", "Scored over 90% on the final assessment!");
                }
            } else if (percentage >= 70) {
                message = `<h3 style="color: green;">‚úÖ Well done! Score: ${score}/6 (${percentage}%)</h3>
                <p>You have a good understanding of computational thinking.</p>`;
                awardXP(70, "Final Assessment Success");
            } else if (percentage >= 50) {
                message = `<h3 style="color: orange;">‚ö†Ô∏è Good effort! Score: ${score}/6 (${percentage}%)</h3>
                <p>Review the sections you found challenging and try again.</p>`;
                awardXP(50, "Final Assessment Complete");
            } else {
                message = `<h3 style="color: red;">‚ùå Keep practicing! Score: ${score}/6 (${percentage}%)</h3>
                <p>Review the lesson and try the assessment again.</p>`;
                awardXP(30, "Final Assessment Attempt");
            }
            
            feedback.innerHTML = message;
            
            // Update final stats
            document.getElementById('totalXP').textContent = xp;
            document.getElementById('finalLevel').textContent = Math.min(level, 5);
            document.getElementById('achievementCount').textContent = achievements.size;
        }

        // Feedback System
        function openFeedback() {
            document.getElementById('feedbackModal').style.display = 'flex';
        }

        function closeFeedback() {
            document.getElementById('feedbackModal').style.display = 'none';
        }

        function sendFeedback() {
            const feedbackText = document.getElementById('feedbackText').value;
            if (feedbackText.length < 10) {
                document.getElementById('feedbackStatus').innerHTML = '<p style="color: red;">Please provide more detailed feedback.</p>';
                return;
            }
            
            // Format email content
            const subject = encodeURIComponent('CT Worksheet Feedback - ' + currentSection);
            const body = encodeURIComponent(`
Page: ${currentSection}
URL: ${window.location.href}
Browser: ${navigator.userAgent}
Timestamp: ${new Date().toISOString()}

Feedback:
${feedbackText}

Progress:
- Level: ${level}
- XP: ${xp}
- Achievements: ${achievements.size}
            `.trim());
            
            // Create mailto link
            const mailtoLink = `mailto:millingtond@mgs.org?subject=${subject}&body=${body}`;
            
            // Try to open email client
            window.location.href = mailtoLink;
            
            // Show success message
            document.getElementById('feedbackStatus').innerHTML = '<p style="color: green;">Thank you! Your email client should open now. If not, please email millingtond@mgs.org directly.</p>';
            
            setTimeout(() => {
                closeFeedback();
                document.getElementById('feedbackText').value = '';
                document.getElementById('feedbackStatus').innerHTML = '';
            }, 3000);
            
            awardXP(5, "Provided Feedback");
        }

        // Accessibility Functions
        function toggleAccessibility() {
            const controls = document.getElementById('accessibilityControls');
            controls.style.display = controls.style.display === 'block' ? 'none' : 'block';
        }

        function toggleHighContrast() {
            document.body.classList.toggle('high-contrast');
        }

        function toggleDyslexiaFont() {
            document.body.classList.toggle('dyslexia-font');
        }

        function changeFontSize(size) {
            document.documentElement.style.setProperty('--font-size', size + 'px');
        }

        // Prevent Paste - More robust
        function preventPaste() {
            // Prevent paste on all input elements
            document.addEventListener('paste', function(e) {
                const target = e.target;
                if (target.tagName === 'INPUT' || target.tagName === 'TEXTAREA' || target.tagName === 'SELECT') {
                    e.preventDefault();
                    showShameMessage();
                    return false;
                }
            });
            
            // Prevent context menu on form elements
            document.addEventListener('contextmenu', function(e) {
                const target = e.target;
                if (target.tagName === 'INPUT' || target.tagName === 'TEXTAREA' || target.tagName === 'SELECT') {
                    e.preventDefault();
                    return false;
                }
            });
            
            // Prevent drag and drop text into inputs
            const inputs = document.querySelectorAll('input, textarea');
            inputs.forEach(input => {
                input.addEventListener('drop', function(e) {
                    e.preventDefault();
                    showShameMessage();
                    return false;
                });
            });
        }

        function showShameMessage() {
            const shameMsg = document.getElementById('shameMessage');
            if (!shameMsg) return;
            
            shameMsg.style.display = 'block';
            shameMsg.style.animation = 'shake 0.5s';
            
            setTimeout(() => {
                shameMsg.style.display = 'none';
                shameMsg.style.animation = '';
            }, 3000);
        }

        // Save/Load Progress - Enhanced with storage availability check
        function isStorageAvailable() {
            try {
                const test = '__storage_test__';
                localStorage.setItem(test, test);
                localStorage.removeItem(test);
                return true;
            } catch (e) {
                return false;
            }
        }

        function saveProgress() {
            if (!isStorageAvailable()) {
                console.log('Storage not available - progress will not be saved');
                return;
            }
            
            try {
                const progress = {
                    xp: xp,
                    level: level,
                    achievements: Array.from(achievements),
                    sectionProgress: sectionProgress,
                    timestamp: Date.now(),
                    version: '1.0'
                };
                localStorage.setItem('ctWorksheetProgress', JSON.stringify(progress));
            } catch (error) {
                console.error('Error saving progress:', error);
            }
        }

        function loadProgress() {
            if (!isStorageAvailable()) {
                console.log('Storage not available - using default values');
                xp = 0;
                level = 1;
                achievements = new Set();
                sectionProgress = {};
                updateXPDisplay();
                return;
            }
            
            try {
                const saved = localStorage.getItem('ctWorksheetProgress');
                if (saved) {
                    const progress = JSON.parse(saved);
                    
                    // Check version compatibility
                    if (progress.version === '1.0') {
                        xp = progress.xp || 0;
                        level = progress.level || 1;
                        achievements = new Set(progress.achievements || []);
                        sectionProgress = progress.sectionProgress || {};
                        updateXPDisplay();
                        
                        // Show welcome back message if returning user
                        if (progress.timestamp) {
                            const daysSince = Math.floor((Date.now() - progress.timestamp) / (1000 * 60 * 60 * 24));
                            if (daysSince > 0) {
                                setTimeout(() => {
                                    showAchievement("Welcome Back!", `You last visited ${daysSince} day${daysSince > 1 ? 's' : ''} ago`);
                                }, 1000);
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading progress:', error);
                // Reset on error
                xp = 0;
                level = 1;
                achievements = new Set();
                sectionProgress = {};
            }
        }

        // Auto-save periodically only if storage is available
        if (isStorageAvailable()) {
            setInterval(saveProgress, 30000); // Save every 30 seconds
            
            // Save on page unload
            window.addEventListener('beforeunload', saveProgress);
        }

        // Reset Functions
        function resetAbstraction() {
            // Reset abstraction section
            document.querySelectorAll('#abstraction select').forEach(select => select.value = '');
            document.querySelectorAll('#abstraction .drop-zone').forEach(zone => {
                zone.innerHTML = zone.querySelector('h4').outerHTML;
                zone.classList.remove('correct', 'incorrect');
            });
            document.getElementById('abstractionFillFeedback').innerHTML = '';
            document.getElementById('abstractionMatchFeedback').innerHTML = '';
            
            // Reinitialize drag items
            const container = document.getElementById('abstractionMatchItems');
            container.innerHTML = `
                <div class="drag-item" draggable="true" data-match="calendar">Calendar Widget</div>
                <div class="drag-item" draggable="true" data-match="weather">Weather Forecast Model</div>
                <div class="drag-item" draggable="true" data-match="remote">TV Remote Control</div>
                <div class="drag-item" draggable="true" data-match="emoji">Emoji</div>
            `;
            initializeDragAndDrop();
        }

        function resetDecomposition() {
            decompositionStep = 0;
            updateDecompositionDisplay();
            
            // Reset benefits matching
            document.querySelectorAll('#decomposition .drop-zone').forEach(zone => {
                zone.innerHTML = zone.querySelector('h4').outerHTML;
                zone.classList.remove('correct', 'incorrect');
            });
            
            const benefitsContainer = document.getElementById('benefitsItems');
            benefitsContainer.innerHTML = `
                <div class="drag-item" draggable="true" data-benefit="parallel">Parallel Development</div>
                <div class="drag-item" draggable="true" data-benefit="reuse">Code Reusability</div>
                <div class="drag-item" draggable="true" data-benefit="debug">Easier Debugging</div>
                <div class="drag-item" draggable="true" data-benefit="maintain">Better Maintenance</div>
            `;
            
            // Reset chess inputs
            for (let i = 1; i <= 5; i++) {
                document.getElementById(`chess${i}`).value = '';
            }
            
            document.getElementById('benefitsFeedback').innerHTML = '';
            document.getElementById('chessFeedback').innerHTML = '';
            
            initializeDragAndDrop();
        }

        function resetAlgorithmic() {
            // Reset flowchart
            clearFlowchart();
            
            // Reset constructs
            for (let i = 1; i <= 3; i++) {
                const select = document.getElementById(`construct${i}`);
                if (select) {
                    select.value = '';
                    select.style.borderColor = '';
                }
            }
            
            document.getElementById('flowchartFeedback').innerHTML = '';
            document.getElementById('constructsFeedback').innerHTML = '';
        }

        // Mobile gesture support
        let touchStartX = 0;
        let touchEndX = 0;

        document.addEventListener('touchstart', function(e) {
            touchStartX = e.changedTouches[0].screenX;
        }, { passive: true });

        document.addEventListener('touchend', function(e) {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        }, { passive: true });

        function handleSwipe() {
            const swipeThreshold = 50;
            const sections = ['starter', 'intro', 'abstraction', 'decomposition', 'algorithmic', 'together', 'exam', 'extension', 'summary', 'videos'];
            const currentIndex = sections.indexOf(currentSection);
            
            if (touchEndX < touchStartX - swipeThreshold && currentIndex < sections.length - 1) {
                // Swipe left - next section
                showSection(sections[currentIndex + 1]);
            } else if (touchEndX > touchStartX + swipeThreshold && currentIndex > 0) {
                // Swipe right - previous section
                showSection(sections[currentIndex - 1]);
            }
        }

        // Additional utility functions
        let commonMistakesVisible = false;
        
        function toggleCommonMistakes() {
            commonMistakesVisible = !commonMistakesVisible;
            const mistakesDiv = document.getElementById('commonMistakes');
            
            if (commonMistakesVisible) {
                mistakesDiv.style.display = 'block';
                event.target.textContent = 'Hide on Other Pages';
            } else {
                event.target.textContent = 'Show on All Pages';
            }
        }

        // Show common mistakes on certain sections
        function checkShowCommonMistakes() {
            const showOnSections = ['together', 'exam']; // Only show on specific pages
            const mistakesDiv = document.getElementById('commonMistakes');
            
            if (commonMistakesVisible || showOnSections.includes(currentSection)) {
                mistakesDiv.style.display = 'block';
            } else {
                mistakesDiv.style.display = 'none';
            }
        }

        // Enhanced reset functions with confirmation
        function resetAllProgress() {
            if (confirm('Are you sure you want to reset ALL progress? This cannot be undone.')) {
                if (isStorageAvailable()) {
                    try {
                        localStorage.removeItem('ctWorksheetProgress');
                    } catch (error) {
                        console.error('Error clearing storage:', error);
                    }
                }
                xp = 0;
                level = 1;
                achievements = new Set();
                sectionProgress = {};
                updateXPDisplay();
                showSection('starter');
                location.reload();
            }
        }

        // Keyboard navigation - Enhanced
        document.addEventListener('keydown', function(e) {
            // Skip if user is typing in an input
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                return;
            }
            
            const sections = ['starter', 'intro', 'abstraction', 'decomposition', 'algorithmic', 'together', 'exam', 'extension', 'summary', 'videos'];
            const currentIndex = sections.indexOf(currentSection);
            
            switch(e.key) {
                case 'ArrowRight':
                case 'PageDown':
                    if (currentIndex < sections.length - 1) {
                        e.preventDefault();
                        showSection(sections[currentIndex + 1]);
                    }
                    break;
                    
                case 'ArrowLeft':
                case 'PageUp':
                    if (currentIndex > 0) {
                        e.preventDefault();
                        showSection(sections[currentIndex - 1]);
                    }
                    break;
                    
                case 'Home':
                    e.preventDefault();
                    showSection('starter');
                    break;
                    
                case 'End':
                    e.preventDefault();
                    showSection('videos');
                    break;
                    
                case '?':
                    if (e.shiftKey) {
                        e.preventDefault();
                        showKeyboardShortcuts();
                    }
                    break;
            }
        });

        function showKeyboardShortcuts() {
            const shortcuts = `
                <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                     background: white; padding: 30px; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); 
                     z-index: 3000; max-width: 400px;">
                    <h3>Keyboard Shortcuts</h3>
                    <p><strong>‚Üí / Page Down:</strong> Next section</p>
                    <p><strong>‚Üê / Page Up:</strong> Previous section</p>
                    <p><strong>Home:</strong> First section</p>
                    <p><strong>End:</strong> Last section</p>
                    <p><strong>?:</strong> Show this help</p>
                    <button onclick="this.parentElement.remove()" style="margin-top: 20px;">Close</button>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', shortcuts);
        }
        })();  // End IIFE
    </script>
</body>
</html>