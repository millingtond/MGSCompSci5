<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insertion Sort - A Level Computer Science</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* Prevent any auto-numbering */
        body {
            counter-reset: none;
        }

        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --secondary: #7c3aed;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --bg-dark: #111827;
            --bg-light: #f9fafb;
            --text-dark: #111827;
            --text-light: #f9fafb;
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text-dark);
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--glass-border);
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(79, 70, 229, 0.1), transparent);
            transform: rotate(45deg);
            animation: shine 3s infinite;
        }

        @keyframes shine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .learning-outcomes {
            background: rgba(79, 70, 229, 0.1);
            border-left: 4px solid var(--primary);
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
        }

        .stats-bar {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.9);
            padding: 15px 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 10px;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .stat-item:hover {
            transform: translateY(-2px);
        }

        .xp-bar {
            flex: 1;
            background: #e5e7eb;
            height: 24px;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        .xp-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success) 0%, #34d399 100%);
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .xp-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .nav-menu {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .nav-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }

        .nav-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .nav-btn:active::before {
            width: 300px;
            height: 300px;
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }

        .nav-btn.active {
            background: linear-gradient(135deg, var(--secondary) 0%, #6d28d9 100%);
        }

        .section {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .task {
            background: linear-gradient(135deg, rgba(79, 70, 229, 0.05) 0%, rgba(124, 58, 237, 0.05) 100%);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid rgba(79, 70, 229, 0.2);
            position: relative;
            overflow: hidden;
        }

        .task::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            animation: slideIn 1s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }

        .quiz-option {
            display: block;
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: left;
            font-size: 1rem;
        }

        .quiz-option:hover {
            border-color: var(--primary);
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.1);
        }

        .quiz-option.correct {
            background: rgba(16, 185, 129, 0.1);
            border-color: var(--success);
        }

        .quiz-option.incorrect {
            background: rgba(239, 68, 68, 0.1);
            border-color: var(--error);
        }

        .input-field {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
        }

        .array-visualization {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            justify-content: center;
            flex-wrap: wrap;
            counter-reset: none !important;
            list-style: none !important;
        }
        
        .array-visualization * {
            list-style: none !important;
            counter-increment: none !important;
        }

        .array-item {
            width: 60px;
            height: 60px;
            background: white !important;
            border: 2px solid var(--primary);
            border-radius: 12px;
            display: flex !important;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: bold;
            font-family: 'Courier New', monospace !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            color: #111827 !important;
            counter-increment: none !important;
            counter-reset: none !important;
            z-index: 1;
            text-align: center;
            line-height: 1;
            white-space: nowrap;
            overflow: hidden;
            list-style: none !important;
            list-style-type: none !important;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        
        .array-item::before,
        .array-item::after {
            content: none !important;
            display: none !important;
            counter-increment: none !important;
        }

        .array-item.current {
            background: var(--warning);
            color: white;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }

        .array-item.sorted {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }

        .array-item.comparing {
            background: var(--secondary);
            color: white;
            transform: translateY(-10px);
        }

        .simulation-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .code-block {
            background: #1e293b;
            color: #e2e8f0;
            padding: 10px 15px 10px 45px;
            border-radius: 12px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            overflow-x: auto;
            margin: 20px 0;
            position: relative;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            font-size: 13px;
        }

        .code-line {
            padding: 0;
            transition: all 0.3s;
            position: relative;
            padding-left: 10px;
            line-height: 1.15;
            margin: 0;
            display: block;
        }

        .code-line::before {
            content: attr(data-line);
            position: absolute;
            left: -30px;
            color: #5c6370;
            font-size: 12px;
            user-select: none;
            width: 25px;
            text-align: right;
        }

        .code-line.active {
            background: rgba(79, 70, 229, 0.2);
            border-left: 3px solid var(--primary);
            margin-left: -10px;
            padding-left: 17px;
            padding-right: 10px;
            padding-top: 0;
            padding-bottom: 0;
        }

        /* Syntax highlighting */
        .keyword {
            color: #c678dd;
            font-weight: bold;
        }

        .function {
            color: #61afef;
        }

        .parameter {
            color: #e06c75;
        }

        .operator {
            color: #56b6c2;
        }

        .number {
            color: #d19a66;
        }

        .builtin {
            color: #e5c07b;
        }

        .comment {
            color: #5c6370;
            font-style: italic;
        }

        .string {
            color: #98c379;
        }
        
        /* Ensure no list numbering affects array items */
        ol .array-item,
        ul .array-item,
        .array-item {
            list-style: none !important;
            list-style-type: none !important;
        }
        
        .array-visualization,
        .array-visualization * {
            list-style: none !important;
            list-style-type: none !important;
        }

        .achievement-popup {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            transform: translateX(400px);
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
        }

        .achievement-popup.show {
            transform: translateX(0);
        }

        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 999;
        }

        .particle {
            position: absolute;
            background: var(--warning);
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: float 3s ease-in-out;
        }

        @keyframes float {
            0% {
                transform: translateY(100vh) scale(0);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) scale(1);
                opacity: 0;
            }
        }

        .feedback-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 900;
        }

        .feedback-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .feedback-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1001;
        }

        .feedback-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .drag-item {
            padding: 10px 20px;
            background: white;
            border: 2px solid var(--primary);
            border-radius: 8px;
            margin: 5px;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-block;
        }

        .drag-item:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2);
        }

        .drag-item.selected {
            background: var(--primary);
            color: white;
        }

        .drop-zone {
            min-height: 50px;
            padding: 15px;
            border: 2px dashed #e5e7eb;
            border-radius: 8px;
            margin: 10px 0;
            transition: all 0.3s;
        }

        .drop-zone.highlight {
            border-color: var(--primary);
            background: rgba(79, 70, 229, 0.05);
        }

        .canvas-container {
            position: relative;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
            margin: 20px 0;
            background: white;
        }

        canvas {
            display: block;
            touch-action: none;
        }

        .canvas-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 10px;
        }

        .hint {
            background: rgba(245, 158, 11, 0.1);
            border-left: 4px solid var(--warning);
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            display: none;
        }

        .nav-arrows {
            display: flex;
            justify-content: space-between;
            margin: 30px 0;
        }

        iframe {
            width: 100%;
            height: 80vh;
            border: none;
            display: block;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.8rem;
            }
            
            .container {
                padding: 10px;
            }
            
            header, .section {
                padding: 20px;
            }
            
            .array-item {
                width: 50px;
                height: 50px;
                font-size: 1rem;
            }
            
            .nav-menu {
                justify-content: center;
            }
            
            .stats-bar {
                justify-content: center;
            }
        }

        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        .error-message {
            color: var(--error);
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .success-message {
            color: var(--success);
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .mark-scheme {
            background: rgba(16, 185, 129, 0.1);
            border: 2px solid var(--success);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }

        .extension-task {
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            border: 2px solid var(--secondary);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Insertion Sort Algorithm</h1>
            <p>A Level Computer Science - Cambridge 9618</p>
            
            <div class="learning-outcomes">
                <h3>Learning Outcomes</h3>
                <ul>
                    <li>Understand how the insertion sort algorithm works</li>
                    <li>Analyse the efficiency factors affecting insertion sort performance</li>
                    <li>Compare best, average, and worst-case scenarios</li>
                    <li>Implement and trace through insertion sort</li>
                    <li>Apply insertion sort to real-world problems</li>
                </ul>
            </div>

            <div class="stats-bar">
                <div class="stat-item">
                    <span>Level: <strong id="level">0</strong>/5</span>
                </div>
                <div class="stat-item">
                    <span>XP: <strong id="xp">0</strong>/<strong id="xp-needed">100</strong></span>
                    <div class="xp-bar">
                        <div class="xp-fill" id="xp-fill" style="width: 0%"></div>
                    </div>
                </div>
                <div class="stat-item">
                    <span>Achievements: <strong id="achievements">0</strong></span>
                </div>
            </div>
        </header>

        <nav class="nav-menu">
            <button class="nav-btn active" onclick="showSection('starter')">Starter</button>
            <button class="nav-btn" onclick="showSection('introduction')">Introduction</button>
            <button class="nav-btn" onclick="showSection('how-it-works')">How It Works</button>
            <button class="nav-btn" onclick="showSection('efficiency')">Efficiency</button>
            <button class="nav-btn" onclick="showSection('practice')">Practice</button>
            <button class="nav-btn" onclick="showSection('summary')">Summary</button>
            <button class="nav-btn" onclick="showSection('exam')">Exam Practice</button>
            <button class="nav-btn" onclick="showSection('extension')">Extension</button>
        </nav>

        <section id="starter" class="section active">
            <h2>Starter Activity: Which Sorting Algorithm?</h2>
            <p>Watch the animation below and identify which sorting algorithm is being demonstrated.</p>
            
            <div class="array-visualization" id="starter-array">
                <div class="array-item">7</div>
                <div class="array-item">3</div>
                <div class="array-item">9</div>
                <div class="array-item">1</div>
                <div class="array-item">5</div>
            </div>
            
            <div class="simulation-controls">
                <button class="btn" onclick="startStarterAnimation()">Start Animation</button>
                <button class="btn btn-secondary" onclick="resetStarterAnimation()">Reset</button>
            </div>
            
            <div class="task">
                <h3>Question: Which sorting algorithm is this?</h3>
                <div id="starter-quiz">
                    <button class="quiz-option" onclick="checkStarterAnswer(this, 'bubble')">Bubble Sort</button>
                    <button class="quiz-option" onclick="checkStarterAnswer(this, 'insertion')">Insertion Sort</button>
                    <button class="quiz-option" onclick="checkStarterAnswer(this, 'selection')">Selection Sort</button>
                    <button class="quiz-option" onclick="checkStarterAnswer(this, 'merge')">Merge Sort</button>
                </div>
                <div id="starter-feedback"></div>
            </div>
            
            <div class="nav-arrows">
                <button class="btn btn-secondary" style="visibility: hidden;">Previous</button>
                <button class="btn" onclick="showSection('introduction')">Next →</button>
            </div>
        </section>

        <section id="introduction" class="section">
            <h2>Introduction to Insertion Sort</h2>
            
            <div class="task">
                <h3>Real-World Analogy</h3>
                <p>Imagine you're sorting a hand of playing cards. You pick up cards one by one and insert each card into its correct position among the cards you've already sorted. This is exactly how insertion sort works!</p>
                
                <div class="array-visualization">
                    <div class="array-item">♠️ 7</div>
                    <div class="array-item">♥️ 3</div>
                    <div class="array-item">♦️ 9</div>
                    <div class="array-item">♣️ 1</div>
                    <div class="array-item">♠️ 5</div>
                </div>
            </div>

            <div class="task">
                <h3>Key Characteristics</h3>
                <p>Fill in the blanks with the correct terms:</p>
                
                <div class="drop-zone" id="drop-zone-1">
                    Insertion sort builds the final sorted array one item at a <span class="blank-space">_______</span>.
                </div>
                
                <div class="drag-items">
                    <span class="drag-item" onclick="selectWord(this, 'drop-zone-1', 'time')">time</span>
                    <span class="drag-item" onclick="selectWord(this, 'drop-zone-1', 'pair')">pair</span>
                    <span class="drag-item" onclick="selectWord(this, 'drop-zone-1', 'group')">group</span>
                    <span class="drag-item" onclick="selectWord(this, 'drop-zone-1', 'section')">section</span>
                </div>
                
                <div class="drop-zone" id="drop-zone-2">
                    It is much less efficient on <span class="blank-space">_______</span> lists than more advanced algorithms.
                </div>
                
                <div class="drag-items">
                    <span class="drag-item" onclick="selectWord(this, 'drop-zone-2', 'small')">small</span>
                    <span class="drag-item" onclick="selectWord(this, 'drop-zone-2', 'sorted')">sorted</span>
                    <span class="drag-item" onclick="selectWord(this, 'drop-zone-2', 'large')">large</span>
                    <span class="drag-item" onclick="selectWord(this, 'drop-zone-2', 'random')">random</span>
                </div>
                
                <button class="btn" onclick="checkFillBlanks()">Check Answers</button>
                <div id="fill-blanks-feedback"></div>
            </div>

            <div class="nav-arrows">
                <button class="btn btn-secondary" onclick="showSection('starter')">← Previous</button>
                <button class="btn" onclick="showSection('how-it-works')">Next →</button>
            </div>
        </section>

        <section id="how-it-works" class="section">
            <h2>How Insertion Sort Works</h2>
            
            <div class="task">
                <h3>Step-by-Step Simulation</h3>
                <p>Click through each step to see how insertion sort processes the array:</p>
                <p style="font-size: 0.9rem; color: #6b7280;">Note: In Python, arrays are 0-indexed, so we start from index 1 (the second element) since the first element is already "sorted".</p>
                
                <div class="array-visualization" id="sort-demo">
                    <!-- Array items will be generated dynamically -->
                </div>
                
                <div style="position: relative;">
                    <div style="background: #2d3748; color: #e2e8f0; padding: 10px 20px; border-radius: 12px 12px 0 0; font-size: 0.9rem; display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: #a0aec0;">insertion_sort.py</span>
                        <span style="color: #4a5568; font-size: 0.8rem;">Python</span>
                    </div>
                    <div class="code-block" style="margin-top: 0; border-radius: 0 0 12px 12px;">
                        <div class="code-line" id="code-1" data-line="1"><span class="keyword">def</span> <span class="function">insertionSort</span>(<span class="parameter">A</span>):</div>
                        <div class="code-line" id="code-2" data-line="2">&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span> i <span class="keyword">in</span> <span class="builtin">range</span>(<span class="number">1</span>, <span class="builtin">len</span>(A)):</div>
                        <div class="code-line" id="code-3" data-line="3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;key <span class="operator">=</span> A[i]</div>
                        <div class="code-line" id="code-4" data-line="4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;j <span class="operator">=</span> i <span class="operator">-</span> <span class="number">1</span></div>
                        <div class="code-line" id="code-5" data-line="5">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">while</span> j <span class="operator">>=</span> <span class="number">0</span> <span class="keyword">and</span> A[j] <span class="operator">></span> key:</div>
                        <div class="code-line" id="code-6" data-line="6">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A[j <span class="operator">+</span> <span class="number">1</span>] <span class="operator">=</span> A[j]</div>
                        <div class="code-line" id="code-7" data-line="7">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;j <span class="operator">=</span> j <span class="operator">-</span> <span class="number">1</span></div>
                        <div class="code-line" id="code-8" data-line="8">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A[j <span class="operator">+</span> <span class="number">1</span>] <span class="operator">=</span> key</div>
                    </div>
                </div>
                
                <div class="simulation-controls">
                    <button class="btn btn-secondary" onclick="prevStep()">← Previous Step</button>
                    <button class="btn" onclick="nextStep()">Next Step →</button>
                    <button class="btn btn-secondary" onclick="resetSimulation(); return false;">Reset</button>
                    <button class="btn btn-success" onclick="autoPlay()">Auto Play</button>
                </div>
                
                <div id="step-explanation"></div>
            </div>

            <div class="task">
                <h3>Trace Table Exercise</h3>
                <p>Complete the trace table for the array [3, 1, 4, 2]:</p>
                
                <div class="canvas-container">
                    <canvas id="trace-canvas" width="600" height="300"></canvas>
                    <div class="canvas-controls">
                        <button class="btn btn-secondary" onclick="clearCanvas()">Clear</button>
                    </div>
                </div>
                
                <button class="btn" onclick="checkTraceTable()">Check Answer</button>
                <div id="trace-feedback"></div>
            </div>

            <div class="nav-arrows">
                <button class="btn btn-secondary" onclick="showSection('introduction')">← Previous</button>
                <button class="btn" onclick="showSection('efficiency')">Next →</button>
            </div>
        </section>

        <section id="efficiency" class="section">
            <h2>Efficiency Factors</h2>
            
            <div class="task">
                <h3>Understanding Time Complexity</h3>
                <p>Insertion sort's efficiency depends on two main factors:</p>
                
                <ol>
                    <li><strong>Array Size:</strong> How does performance change with larger arrays?</li>
                    <li><strong>Initial Order:</strong> How does the starting arrangement affect performance?</li>
                </ol>
            </div>

            <div class="task">
                <h3>Best, Average, and Worst Cases</h3>
                <p>Match each scenario to its time complexity:</p>
                
                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <div style="flex: 1;">
                        <h4>Scenarios:</h4>
                        <div class="drag-item" onclick="selectMatch(this, 'best')">Already sorted array</div>
                        <div class="drag-item" onclick="selectMatch(this, 'worst')">Reverse sorted array</div>
                        <div class="drag-item" onclick="selectMatch(this, 'average')">Random array</div>
                    </div>
                    
                    <div style="flex: 1;">
                        <h4>Time Complexities:</h4>
                        <div class="drop-zone" id="best-case">Best Case: O(n) - Drop here</div>
                        <div class="drop-zone" id="average-case">Average Case: O(n²) - Drop here</div>
                        <div class="drop-zone" id="worst-case">Worst Case: O(n²) - Drop here</div>
                    </div>
                </div>
                
                <button class="btn" onclick="checkMatching()">Check Matches</button>
                <div id="matching-feedback"></div>
            </div>

            <div class="task">
                <h3>Efficiency Comparison</h3>
                <p>How many comparisons and swaps occur in each case?</p>
                
                <label>For an array of size n=5, in the worst case, how many comparisons occur?</label>
                <input type="number" class="input-field" id="comparisons-input" placeholder="Enter your answer">
                
                <label>For the same array, how many swaps occur in the best case?</label>
                <input type="number" class="input-field" id="swaps-input" placeholder="Enter your answer">
                
                <button class="btn" onclick="checkEfficiencyAnswers()">Check Answers</button>
                <div id="efficiency-feedback"></div>
                
                <button class="btn btn-secondary" onclick="showHint('efficiency-hint')">Show Hint</button>
                <div class="hint" id="efficiency-hint">
                    <p>Think about what happens in each iteration. In the worst case, each element needs to be compared with all previous elements.</p>
                </div>
            </div>

            <div class="nav-arrows">
                <button class="btn btn-secondary" onclick="showSection('how-it-works')">← Previous</button>
                <button class="btn" onclick="showSection('practice')">Next →</button>
            </div>
        </section>

        <section id="practice" class="section">
            <h2>Practice and Application</h2>
            
            <div class="task">
                <h3>Sorting Challenge</h3>
                <p>Arrange these numbers in ascending order using insertion sort. Click on pairs to swap them:</p>
                
                <div class="array-visualization" id="practice-array">
                    <div class="array-item" onclick="selectForSwap(this)">8</div>
                    <div class="array-item" onclick="selectForSwap(this)">3</div>
                    <div class="array-item" onclick="selectForSwap(this)">5</div>
                    <div class="array-item" onclick="selectForSwap(this)">1</div>
                    <div class="array-item" onclick="selectForSwap(this)">9</div>
                    <div class="array-item" onclick="selectForSwap(this)">2</div>
                </div>
                
                <div style="margin-top: 20px;">
                    <span>Swaps made: <strong id="swap-count">0</strong></span>
                    <button class="btn btn-secondary" onclick="resetPracticeArray()">Reset</button>
                    <button class="btn" onclick="checkPracticeSolution()">Check Solution</button>
                </div>
                <div id="practice-feedback"></div>
            </div>

            <div class="task">
                <h3>Real-World Application</h3>
                <p>Which of these scenarios would be most suitable for insertion sort?</p>
                
                <div id="application-quiz">
                    <button class="quiz-option" onclick="checkApplication(this, 'a')">Sorting millions of database records</button>
                    <button class="quiz-option" onclick="checkApplication(this, 'b')">Adding new scores to a nearly sorted leaderboard</button>
                    <button class="quiz-option" onclick="checkApplication(this, 'c')">Initial sorting of completely random large datasets</button>
                    <button class="quiz-option" onclick="checkApplication(this, 'd')">Sorting data in a distributed system</button>
                </div>
                <div id="application-feedback"></div>
            </div>

            <div class="task">
                <h3>Common Mistakes</h3>
                <p>Identify the error in this insertion sort implementation:</p>
                
                <div style="position: relative;">
                    <div style="background: #2d3748; color: #e2e8f0; padding: 10px 20px; border-radius: 12px 12px 0 0; font-size: 0.9rem; display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: #a0aec0;">faulty_insertion_sort.py</span>
                        <span style="color: #ef4444; font-size: 0.8rem;">⚠️ Contains Errors</span>
                    </div>
                    <div class="code-block" style="margin-top: 0; border-radius: 0 0 12px 12px;">
                        <div class="code-line" data-line="1"><span class="keyword">def</span> <span class="function">faultyInsertionSort</span>(<span class="parameter">A</span>):</div>
                        <div class="code-line" data-line="2">&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span> i <span class="keyword">in</span> <span class="builtin">range</span>(<span class="number">0</span>, <span class="builtin">len</span>(A)):  <span class="comment"># Error: starts at 0</span></div>
                        <div class="code-line" data-line="3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;key <span class="operator">=</span> A[i]</div>
                        <div class="code-line" data-line="4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;j <span class="operator">=</span> i <span class="operator">-</span> <span class="number">1</span></div>
                        <div class="code-line" data-line="5">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">while</span> j <span class="operator">>=</span> <span class="number">0</span> <span class="keyword">and</span> A[j] <span class="operator">></span> key:</div>
                        <div class="code-line" data-line="6">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A[j] <span class="operator">=</span> A[j <span class="operator">+</span> <span class="number">1</span>]  <span class="comment"># Error: wrong assignment</span></div>
                        <div class="code-line" data-line="7">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;j <span class="operator">=</span> j <span class="operator">-</span> <span class="number">1</span></div>
                        <div class="code-line" data-line="8">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A[j <span class="operator">+</span> <span class="number">1</span>] <span class="operator">=</span> key</div>
                    </div>
                </div>
                
                <textarea class="input-field" id="mistake-answer" rows="4" placeholder="Explain the error and how to fix it..."></textarea>
                <button class="btn" onclick="checkMistakeAnswer()">Submit Answer</button>
                <div id="mistake-feedback"></div>
            </div>

            <div class="nav-arrows">
                <button class="btn btn-secondary" onclick="showSection('efficiency')">← Previous</button>
                <button class="btn" onclick="showSection('summary')">Next →</button>
            </div>
        </section>

        <section id="summary" class="section">
            <h2>Summary and Key Takeaways</h2>
            
            <div class="task">
                <h3>Key Points</h3>
                <ul>
                    <li>Insertion sort builds a sorted array one element at a time</li>
                    <li>Best case: O(n) when array is already sorted</li>
                    <li>Worst case: O(n²) when array is reverse sorted</li>
                    <li>Efficient for small datasets or nearly sorted data</li>
                    <li>In-place sorting algorithm (uses O(1) extra space)</li>
                    <li>Stable sort (maintains relative order of equal elements)</li>
                </ul>
            </div>

            <div class="task">
                <h3>Check Your Understanding</h3>
                
                <div class="quiz-question">
                    <p><strong>Question 1:</strong> What is the time complexity of insertion sort in the best case?</p>
                    <div class="quiz-options">
                        <button class="quiz-option" onclick="checkSummaryAnswer(this, 1, 'a')">O(n log n)</button>
                        <button class="quiz-option" onclick="checkSummaryAnswer(this, 1, 'b')">O(n)</button>
                        <button class="quiz-option" onclick="checkSummaryAnswer(this, 1, 'c')">O(n²)</button>
                        <button class="quiz-option" onclick="checkSummaryAnswer(this, 1, 'd')">O(1)</button>
                    </div>
                </div>

                <div class="quiz-question">
                    <p><strong>Question 2:</strong> True or False: Insertion sort is more efficient than merge sort for small datasets.</p>
                    <div class="quiz-options">
                        <button class="quiz-option" onclick="checkSummaryAnswer(this, 2, 'true')">True</button>
                        <button class="quiz-option" onclick="checkSummaryAnswer(this, 2, 'false')">False</button>
                    </div>
                </div>

                <div class="quiz-question">
                    <p><strong>Question 3:</strong> In which scenario does insertion sort perform best?</p>
                    <div class="quiz-options">
                        <button class="quiz-option" onclick="checkSummaryAnswer(this, 3, 'a')">Random data</button>
                        <button class="quiz-option" onclick="checkSummaryAnswer(this, 3, 'b')">Nearly sorted data</button>
                        <button class="quiz-option" onclick="checkSummaryAnswer(this, 3, 'c')">Reverse sorted data</button>
                        <button class="quiz-option" onclick="checkSummaryAnswer(this, 3, 'd')">Large datasets</button>
                    </div>
                </div>

                <div class="quiz-question">
                    <p><strong>Question 4:</strong> How many comparisons occur when sorting [1, 2, 3, 4] with insertion sort?</p>
                    <div class="quiz-options">
                        <button class="quiz-option" onclick="checkSummaryAnswer(this, 4, 'a')">6</button>
                        <button class="quiz-option" onclick="checkSummaryAnswer(this, 4, 'b')">4</button>
                        <button class="quiz-option" onclick="checkSummaryAnswer(this, 4, 'c')">3</button>
                        <button class="quiz-option" onclick="checkSummaryAnswer(this, 4, 'd')">0</button>
                    </div>
                </div>

                <div class="quiz-question">
                    <p><strong>Question 5:</strong> What is the space complexity of insertion sort?</p>
                    <div class="quiz-options">
                        <button class="quiz-option" onclick="checkSummaryAnswer(this, 5, 'a')">O(n)</button>
                        <button class="quiz-option" onclick="checkSummaryAnswer(this, 5, 'b')">O(log n)</button>
                        <button class="quiz-option" onclick="checkSummaryAnswer(this, 5, 'c')">O(n²)</button>
                        <button class="quiz-option" onclick="checkSummaryAnswer(this, 5, 'd')">O(1)</button>
                    </div>
                </div>

                <div class="quiz-question">
                    <p><strong>Question 6:</strong> Which statement about insertion sort is FALSE?</p>
                    <div class="quiz-options">
                        <button class="quiz-option" onclick="checkSummaryAnswer(this, 6, 'a')">It is a stable sort</button>
                        <button class="quiz-option" onclick="checkSummaryAnswer(this, 6, 'b')">It sorts in-place</button>
                        <button class="quiz-option" onclick="checkSummaryAnswer(this, 6, 'c')">It always takes O(n²) time</button>
                        <button class="quiz-option" onclick="checkSummaryAnswer(this, 6, 'd')">It works well for small datasets</button>
                    </div>
                </div>

                <div class="quiz-question">
                    <p><strong>Question 7:</strong> When inserting element 5 into sorted portion [1, 3, 7, 9], how many comparisons are needed?</p>
                    <div class="quiz-options">
                        <button class="quiz-option" onclick="checkSummaryAnswer(this, 7, 'a')">1</button>
                        <button class="quiz-option" onclick="checkSummaryAnswer(this, 7, 'b')">2</button>
                        <button class="quiz-option" onclick="checkSummaryAnswer(this, 7, 'c')">3</button>
                        <button class="quiz-option" onclick="checkSummaryAnswer(this, 7, 'd')">4</button>
                    </div>
                </div>

                <div class="quiz-question">
                    <p><strong>Question 8:</strong> Why might insertion sort be preferred over quicksort in some cases?</p>
                    <div class="quiz-options">
                        <button class="quiz-option" onclick="checkSummaryAnswer(this, 8, 'a')">It's always faster</button>
                        <button class="quiz-option" onclick="checkSummaryAnswer(this, 8, 'b')">For small or nearly sorted datasets</button>
                        <button class="quiz-option" onclick="checkSummaryAnswer(this, 8, 'c')">It uses less memory overall</button>
                        <button class="quiz-option" onclick="checkSummaryAnswer(this, 8, 'd')">It's easier to parallelize</button>
                    </div>
                </div>

                <div id="summary-score"></div>
            </div>

            <div class="nav-arrows">
                <button class="btn btn-secondary" onclick="showSection('practice')">← Previous</button>
                <button class="btn" onclick="showSection('exam')">Next →</button>
            </div>
        </section>

        <section id="exam" class="section">
            <h2>Practice Exam Question</h2>
            
            <div class="task">
                <h3>Question (6 marks)</h3>
                <p>A programmer is implementing insertion sort in Python to sort student records by their test scores.</p>
                
                <p>(a) Describe how insertion sort works. [3 marks]</p>
                <textarea class="input-field" id="exam-part-a" rows="5" placeholder="Write your answer here..."></textarea>
                
                <p>(b) State the best-case and worst-case time complexities of insertion sort. [2 marks]</p>
                <textarea class="input-field" id="exam-part-b" rows="3" placeholder="Write your answer here..."></textarea>
                
                <p>(c) Explain one advantage of using insertion sort over merge sort for this application. [1 mark]</p>
                <textarea class="input-field" id="exam-part-c" rows="2" placeholder="Write your answer here..."></textarea>
                
                <div style="margin-top: 20px;">
                    <label>Predicted marks: </label>
                    <input type="number" class="input-field" id="predicted-marks" min="0" max="6" style="width: 80px;">
                    <button class="btn" onclick="submitExamAnswer()">Submit Answer</button>
                </div>
                
                <div class="mark-scheme" id="mark-scheme">
                    <h4>Mark Scheme</h4>
                    <p><strong>Part (a) - 3 marks:</strong></p>
                    <ul>
                        <li>Starts with first element as sorted portion [1 mark]</li>
                        <li>Takes each subsequent element and finds correct position in sorted portion [1 mark]</li>
                        <li>Shifts elements to make space and inserts element [1 mark]</li>
                    </ul>
                    
                    <p><strong>Part (b) - 2 marks:</strong></p>
                    <ul>
                        <li>Best case: O(n) when array is already sorted [1 mark]</li>
                        <li>Worst case: O(n²) when array is reverse sorted [1 mark]</li>
                    </ul>
                    
                    <p><strong>Part (c) - 1 mark:</strong></p>
                    <p>Any one of:</p>
                    <ul>
                        <li>Simpler to implement</li>
                        <li>Better for small datasets</li>
                        <li>In-place sorting (uses less memory)</li>
                        <li>Stable sort (maintains order of equal elements)</li>
                    </ul>
                </div>
                
                <div id="exam-feedback"></div>
            </div>

            <div class="nav-arrows">
                <button class="btn btn-secondary" onclick="showSection('summary')">← Previous</button>
                <button class="btn" onclick="showSection('extension')">Next →</button>
            </div>
        </section>

        <section id="extension" class="section">
            <h2>Extension Activities</h2>
            
            <div class="extension-task">
                <h3>Challenge 1: Optimised Insertion Sort</h3>
                <p>Research and implement binary insertion sort, which uses binary search to find the insertion position. How does this affect the time complexity?</p>
                <textarea class="input-field" rows="6" placeholder="Write your implementation and analysis here..."></textarea>
            </div>

            <div class="extension-task">
                <h3>Challenge 2: Hybrid Sorting</h3>
                <p>Many modern sorting algorithms use insertion sort for small subarrays. Research Timsort and explain why it combines merge sort with insertion sort.</p>
                <textarea class="input-field" rows="6" placeholder="Write your research findings here..."></textarea>
            </div>

            <div class="extension-task">
                <h3>Challenge 3: Performance Analysis</h3>
                <p>Design an experiment to compare insertion sort performance on different types of data (random, nearly sorted, reverse sorted). What patterns do you observe?</p>
                <textarea class="input-field" rows="6" placeholder="Describe your experiment and findings..."></textarea>
            </div>

            <div class="task">
                <h3>Videos and Additional Resources</h3>
                <p>Watch these videos to deepen your understanding:</p>
                <div style="background: #f3f4f6; padding: 20px; border-radius: 12px; text-align: center;">
                    <p style="color: #6b7280;">Video content placeholder</p>
                    <p style="color: #6b7280;">Your teacher will provide links to relevant videos</p>
                </div>
            </div>

            <div class="nav-arrows">
                <button class="btn btn-secondary" onclick="showSection('exam')">← Previous</button>
                <button class="btn btn-success" onclick="completeWorksheet()">Complete Worksheet</button>
            </div>
        </section>
    </div>

    <div class="particles" id="particles"></div>
    
    <div class="achievement-popup" id="achievement-popup">
        <h3 id="achievement-title">Achievement Unlocked!</h3>
        <p id="achievement-desc">Description</p>
    </div>

    <div class="feedback-btn" onclick="openFeedback()" title="Send Feedback">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
            <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
        </svg>
    </div>

    <div class="feedback-modal" id="feedback-modal">
        <div class="feedback-content">
            <h3>Send Feedback</h3>
            <p>Found a bug or have a suggestion? Let us know!</p>
            <textarea class="input-field" id="feedback-text" rows="6" placeholder="Describe the issue or suggestion..."></textarea>
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn" onclick="sendFeedback()">Send</button>
                <button class="btn btn-secondary" onclick="closeFeedback()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // Prevent all paste methods
        document.addEventListener('paste', e => e.preventDefault());
        document.addEventListener('drop', e => e.preventDefault());
        document.addEventListener('dragover', e => e.preventDefault());

        // Global variables
        let currentSection = 'starter';
        let xp = 0;
        let level = 0;
        let achievements = 0;
        let completedTasks = new Set();
        let simulationStep = 0;
        let autoPlayInterval = null;
        let selectedSwapItem = null;
        let swapCount = 0;
        let starterAnimationInterval = null;
        let summaryAnswers = {};

        // XP requirements per level
        const xpRequirements = [100, 250, 500, 850, 1500];

        // Achievement definitions
        const achievementList = {
            firstStep: { title: "First Steps", desc: "Complete the starter activity", xp: 50 },
            theoryMaster: { title: "Theory Master", desc: "Complete all introduction tasks", xp: 100 },
            simulator: { title: "Algorithm Simulator", desc: "Complete the step-by-step simulation", xp: 150 },
            efficient: { title: "Efficiency Expert", desc: "Master time complexity analysis", xp: 150 },
            practitioner: { title: "Practitioner", desc: "Complete all practice exercises", xp: 200 },
            examReady: { title: "Exam Ready", desc: "Complete the practice exam question", xp: 250 },
            perfectScore: { title: "Perfect Score", desc: "Score 100% on the summary quiz", xp: 300 },
            explorer: { title: "Explorer", desc: "Try an extension activity", xp: 100 },
            completionist: { title: "Completionist", desc: "Complete the entire worksheet", xp: 500 }
        };

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            updateStats();
            resetStarterAnimation();
            
            // Force initialize if on how-it-works
            setTimeout(() => {
                if (document.getElementById('how-it-works') && document.getElementById('how-it-works').classList.contains('active')) {
                    resetSimulation();
                }
            }, 200);
        });

        // Also handle window load to ensure everything is ready
        window.addEventListener('load', function() {
            // If we're on the how-it-works section, initialize the simulation
            if (currentSection === 'how-it-works' || document.getElementById('how-it-works').classList.contains('active')) {
                resetSimulation();
            }
        });

        // Initialize
        updateStats();

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            
            document.getElementById(sectionId).classList.add('active');
            const navBtns = document.querySelectorAll('.nav-btn');
            const sectionNames = ['starter', 'introduction', 'how-it-works', 'efficiency', 'practice', 'summary', 'exam', 'extension'];
            const index = sectionNames.indexOf(sectionId);
            if (index !== -1) {
                navBtns[index].classList.add('active');
            }
            
            currentSection = sectionId;
            window.scrollTo(0, 0);
            
            // Initialize simulation when showing how-it-works section
            if (sectionId === 'how-it-works') {
                // Small delay to ensure DOM is ready
                setTimeout(() => resetSimulation(), 100);
            }
        }

        function updateStats() {
            document.getElementById('xp').textContent = xp;
            document.getElementById('level').textContent = level;
            document.getElementById('achievements').textContent = achievements;
            
            const xpNeeded = level < 5 ? xpRequirements[level] : xpRequirements[4];
            document.getElementById('xp-needed').textContent = xpNeeded;
            
            const xpProgress = level < 5 ? (xp / xpNeeded) * 100 : 100;
            document.getElementById('xp-fill').style.width = xpProgress + '%';
            
            // Check for level up
            if (level < 5 && xp >= xpRequirements[level]) {
                levelUp();
            }
        }

        function addXP(amount, taskId) {
            if (completedTasks.has(taskId)) return;
            
            completedTasks.add(taskId);
            xp += amount;
            updateStats();
            
            // Show floating XP
            showFloatingXP(amount);
        }

        function showFloatingXP(amount) {
            const floatingXP = document.createElement('div');
            floatingXP.textContent = '+' + amount + ' XP';
            floatingXP.style.cssText = `
                position: fixed;
                top: 100px;
                right: 50px;
                color: var(--success);
                font-weight: bold;
                font-size: 1.2rem;
                animation: floatUp 2s ease-out forwards;
                z-index: 1000;
            `;
            document.body.appendChild(floatingXP);
            
            setTimeout(() => floatingXP.remove(), 2000);
        }

        function levelUp() {
            level++;
            showParticles();
            unlockAchievement('levelUp' + level, { 
                title: 'Level ' + level + ' Reached!', 
                desc: 'Continue your journey to mastery' 
            });
        }

        function unlockAchievement(id, achievement) {
            if (completedTasks.has('achievement_' + id)) return;
            
            completedTasks.add('achievement_' + id);
            achievements++;
            
            const popup = document.getElementById('achievement-popup');
            document.getElementById('achievement-title').textContent = achievement.title;
            document.getElementById('achievement-desc').textContent = achievement.desc;
            
            popup.classList.add('show');
            setTimeout(() => popup.classList.remove('show'), 3000);
            
            if (achievement.xp) {
                xp += achievement.xp;
            }
            
            updateStats();
        }

        function showParticles() {
            const container = document.getElementById('particles');
            for (let i = 0; i < 20; i++) {
                setTimeout(() => {
                    const particle = document.createElement('div');
                    particle.className = 'particle';
                    particle.style.left = Math.random() * window.innerWidth + 'px';
                    particle.style.animationDelay = Math.random() * 0.5 + 's';
                    container.appendChild(particle);
                    
                    setTimeout(() => particle.remove(), 3000);
                }, i * 100);
            }
        }

        // Starter animation
        let starterArray = [7, 3, 9, 1, 5];
        let starterStep = 0;

        function startStarterAnimation() {
            if (starterAnimationInterval) return;
            
            starterArray = [7, 3, 9, 1, 5];
            starterStep = 0;
            updateStarterDisplay();
            
            starterAnimationInterval = setInterval(() => {
                if (starterStep >= starterArray.length - 1) {
                    clearInterval(starterAnimationInterval);
                    starterAnimationInterval = null;
                    return;
                }
                
                // Insertion sort step
                let key = starterArray[starterStep + 1];
                let j = starterStep;
                
                while (j >= 0 && starterArray[j] > key) {
                    starterArray[j + 1] = starterArray[j];
                    j--;
                }
                starterArray[j + 1] = key;
                
                starterStep++;
                updateStarterDisplay();
            }, 1000);
        }

        function updateStarterDisplay() {
            const container = document.getElementById('starter-array');
            container.innerHTML = '';
            
            starterArray.forEach((val, idx) => {
                const item = document.createElement('div');
                item.className = 'array-item';
                if (idx <= starterStep) {
                    item.classList.add('sorted');
                }
                item.textContent = val;
                container.appendChild(item);
            });
        }

        function resetStarterAnimation() {
            clearInterval(starterAnimationInterval);
            starterAnimationInterval = null;
            starterArray = [7, 3, 9, 1, 5];
            starterStep = 0;
            updateStarterDisplay();
        }

        function checkStarterAnswer(btn, answer) {
            const buttons = btn.parentElement.querySelectorAll('.quiz-option');
            buttons.forEach(b => b.disabled = true);
            
            if (answer === 'insertion') {
                btn.classList.add('correct');
                document.getElementById('starter-feedback').innerHTML = 
                    '<p class="success-message">Correct! This is insertion sort - notice how elements are inserted into their correct position one by one.</p>';
                addXP(50, 'starter-quiz');
                unlockAchievement('firstStep', achievementList.firstStep);
            } else {
                btn.classList.add('incorrect');
                document.getElementById('starter-feedback').innerHTML = 
                    '<p class="error-message">Not quite. Watch how each element finds its correct position among the sorted elements.</p>';
            }
        }

        // Fill in blanks
        let selectedWords = {};

        function selectWord(wordElement, dropZoneId, word) {
            // Clear previous selection for this drop zone
            document.querySelectorAll('.drag-item').forEach(item => {
                if (selectedWords[dropZoneId] === item.textContent) {
                    item.classList.remove('selected');
                }
            });
            
            wordElement.classList.add('selected');
            selectedWords[dropZoneId] = word;
            
            // Update drop zone display
            const dropZone = document.getElementById(dropZoneId);
            const blankSpace = dropZone.querySelector('.blank-space');
            if (blankSpace) {
                blankSpace.textContent = word;
            }
        }

        function checkFillBlanks() {
            let correct = 0;
            const expected = {
                'drop-zone-1': 'time',
                'drop-zone-2': 'large'
            };
            
            for (let zoneId in expected) {
                if (selectedWords[zoneId] === expected[zoneId]) {
                    correct++;
                }
            }
            
            const feedback = document.getElementById('fill-blanks-feedback');
            if (correct === 2) {
                feedback.innerHTML = '<p class="success-message">Perfect! You understand the key characteristics of insertion sort.</p>';
                addXP(75, 'fill-blanks');
                unlockAchievement('theoryMaster', achievementList.theoryMaster);
            } else {
                feedback.innerHTML = '<p class="error-message">Not quite right. Remember: insertion sort processes one element at a time and struggles with large datasets.</p>';
            }
        }

        // Simulation - Use function to ensure fresh array
        function getInitialArray() {
            return [5, 2, 4, 6, 1, 3];
        }
        
        let sortArray = getInitialArray();
        let currentI = 1;
        let currentJ = 0;
        let currentKey = 2; // sortArray[1]
        let simulating = false;

        function nextStep() {
            if (simulating) return;
            simulating = true;
            
            // Ensure array still contains correct values
            if (sortArray.length !== 6) {
                console.error('Array corrupted!');
                resetSimulation();
                simulating = false;
                return;
            }
            
            if (currentI >= sortArray.length) {
                document.getElementById('step-explanation').innerHTML = 
                    '<p class="success-message">Sorting complete! The array is now fully sorted: [' + sortArray.join(', ') + ']</p>';
                addXP(150, 'simulation-complete');
                unlockAchievement('simulator', achievementList.simulator);
                simulating = false;
                return;
            }
            
            // Perform one step of insertion sort
            if (currentJ >= 0 && sortArray[currentJ] > currentKey) {
                sortArray[currentJ + 1] = sortArray[currentJ];
                highlightCodeLine(6);
                currentJ--;
                highlightCodeLine(7);
            } else {
                sortArray[currentJ + 1] = currentKey;
                highlightCodeLine(8);
                currentI++;
                if (currentI < sortArray.length) {
                    currentKey = sortArray[currentI];
                    currentJ = currentI - 1;
                    highlightCodeLine(3);
                }
            }
            
            updateSortDisplay();
            updateStepExplanation();
            simulating = false;
        }

        function prevStep() {
            // Simplified - just reset
            resetSimulation();
        }

        function resetSimulation() {
            clearInterval(autoPlayInterval);
            autoPlayInterval = null;
            
            // Reset to fresh array
            sortArray = getInitialArray();
            currentI = 1;
            currentJ = 0;
            currentKey = sortArray[1]; // Should be 2
            simulating = false;
            
            // Update display
            updateSortDisplay();
            
            // Update explanation with array values
            document.getElementById('step-explanation').innerHTML = 
                `<p>Array to sort: [${sortArray.join(', ')}]<br>Click "Next Step" to begin the sorting process.</p>`;
            
            // Clear code highlighting
            document.querySelectorAll('.code-line').forEach(line => line.classList.remove('active'));
        }

        function autoPlay() {
            if (autoPlayInterval) {
                clearInterval(autoPlayInterval);
                autoPlayInterval = null;
                return;
            }
            
            autoPlayInterval = setInterval(() => {
                nextStep();
                if (currentI >= sortArray.length) {
                    clearInterval(autoPlayInterval);
                    autoPlayInterval = null;
                }
            }, 1500);
        }

        function updateSortDisplay() {
            const container = document.getElementById('sort-demo');
            if (!container) return;
            
            // Clear existing content completely
            container.innerHTML = '';
            
            // Create the array items from scratch
            for (let idx = 0; idx < sortArray.length; idx++) {
                const val = sortArray[idx];
                const item = document.createElement('div');
                item.className = 'array-item';
                
                if (idx < currentI && idx !== currentJ + 1) {
                    item.classList.add('sorted');
                } else if (idx === currentJ + 1) {
                    item.classList.add('current');
                } else if (idx === currentJ && currentJ >= 0 && val > currentKey) {
                    item.classList.add('comparing');
                }
                
                // Force the value display with inline span
                item.innerHTML = `<span style="color: #111827; font-size: 1.2rem; font-weight: bold;">${val}</span>`;
                
                container.appendChild(item);
            }
        }

        function highlightCodeLine(lineNum) {
            document.querySelectorAll('.code-line').forEach(line => line.classList.remove('active'));
            document.getElementById('code-' + lineNum).classList.add('active');
        }

        function updateStepExplanation() {
            const explanation = document.getElementById('step-explanation');
            if (currentI >= sortArray.length) {
                return;
            }
            
            if (currentJ >= 0 && sortArray[currentJ] > currentKey) {
                explanation.innerHTML = `<p>Comparing ${currentKey} with ${sortArray[currentJ]}. Since ${sortArray[currentJ]} > ${currentKey}, shift ${sortArray[currentJ]} right.</p>`;
            } else {
                explanation.innerHTML = `<p>Found correct position for ${currentKey}. Insert it at index ${currentJ + 1}.</p>`;
            }
        }

        // Canvas for trace table
        const canvas = document.getElementById('trace-canvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;

        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('touchstart', handleTouch);
        canvas.addEventListener('touchmove', handleTouch);
        canvas.addEventListener('touchend', stopDrawing);

        function startDrawing(e) {
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            ctx.beginPath();
            ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        }

        function draw(e) {
            if (!isDrawing) return;
            const rect = canvas.getBoundingClientRect();
            ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
            ctx.stroke();
        }

        function stopDrawing() {
            isDrawing = false;
        }

        function handleTouch(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 
                                            e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        }

        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function checkTraceTable() {
            // Simplified check - just award XP for attempting
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const hasDrawing = imageData.data.some((channel, index) => index % 4 === 3 && channel > 0);
            
            if (hasDrawing) {
                document.getElementById('trace-feedback').innerHTML = 
                    '<p class="success-message">Good attempt! The correct trace shows: [3,1,4,2] → [1,3,4,2] → [1,3,4,2] → [1,2,3,4]</p>';
                addXP(100, 'trace-table');
            } else {
                document.getElementById('trace-feedback').innerHTML = 
                    '<p class="error-message">Please draw your trace table first.</p>';
            }
        }

        // Matching exercise
        let matchingSelections = {};

        function selectMatch(item, scenario) {
            // Clear previous selection for this scenario
            document.querySelectorAll('.drag-item').forEach(dragItem => {
                if (matchingSelections[dragItem.textContent] === scenario) {
                    delete matchingSelections[dragItem.textContent];
                }
            });
            
            matchingSelections[item.textContent] = scenario;
            
            // Update visual feedback
            const dropZone = document.getElementById(scenario + '-case');
            dropZone.innerHTML = dropZone.textContent.split(':')[0] + ': ' + item.textContent;
            dropZone.classList.add('highlight');
        }

        function checkMatching() {
            const correct = {
                'Already sorted array': 'best',
                'Reverse sorted array': 'worst',
                'Random array': 'average'
            };
            
            let score = 0;
            for (let item in correct) {
                if (matchingSelections[item] === correct[item]) {
                    score++;
                }
            }
            
            const feedback = document.getElementById('matching-feedback');
            if (score === 3) {
                feedback.innerHTML = '<p class="success-message">Excellent! You understand the different complexity scenarios.</p>';
                addXP(100, 'matching-complexity');
            } else {
                feedback.innerHTML = `<p class="error-message">You got ${score}/3 correct. Remember: best case is O(n) for sorted data.</p>`;
            }
        }

        function checkEfficiencyAnswers() {
            const comparisons = document.getElementById('comparisons-input').value;
            const swaps = document.getElementById('swaps-input').value;
            
            // For n=5, worst case comparisons: 1+2+3+4 = 10
            // Best case swaps: 0 (already sorted)
            
            let feedback = '';
            let correct = 0;
            
            if (comparisons === '10') {
                correct++;
                feedback += '<p class="success-message">Comparisons correct! In worst case: 1+2+3+4 = 10 comparisons.</p>';
            } else {
                feedback += '<p class="error-message">Comparisons incorrect. Think about how many comparisons each element needs.</p>';
            }
            
            if (swaps === '0') {
                correct++;
                feedback += '<p class="success-message">Swaps correct! In best case (sorted array), no swaps are needed.</p>';
            } else {
                feedback += '<p class="error-message">Swaps incorrect. What happens when the array is already sorted?</p>';
            }
            
            document.getElementById('efficiency-feedback').innerHTML = feedback;
            
            if (correct === 2) {
                addXP(150, 'efficiency-calculation');
                unlockAchievement('efficient', achievementList.efficient);
            }
        }

        function showHint(hintId) {
            const hint = document.getElementById(hintId);
            hint.style.display = 'block';
            addXP(25, 'hint-' + hintId); // Reduced XP for using hint
        }

        // Practice array sorting
        let practiceArray = [8, 3, 5, 1, 9, 2];

        function selectForSwap(element) {
            if (selectedSwapItem === null) {
                selectedSwapItem = element;
                element.classList.add('current');
            } else {
                // Swap values
                const temp = selectedSwapItem.textContent;
                selectedSwapItem.textContent = element.textContent;
                element.textContent = temp;
                
                selectedSwapItem.classList.remove('current');
                selectedSwapItem = null;
                swapCount++;
                document.getElementById('swap-count').textContent = swapCount;
            }
        }

        function resetPracticeArray() {
            practiceArray = [8, 3, 5, 1, 9, 2];
            swapCount = 0;
            selectedSwapItem = null;
            document.getElementById('swap-count').textContent = '0';
            
            const container = document.getElementById('practice-array');
            container.innerHTML = '';
            practiceArray.forEach(val => {
                const item = document.createElement('div');
                item.className = 'array-item';
                item.textContent = val;
                item.onclick = () => selectForSwap(item);
                container.appendChild(item);
            });
        }

        function checkPracticeSolution() {
            const items = document.querySelectorAll('#practice-array .array-item');
            const currentArray = Array.from(items).map(item => parseInt(item.textContent));
            const sorted = [...currentArray].sort((a, b) => a - b);
            
            const isCorrect = currentArray.every((val, idx) => val === sorted[idx]);
            
            const feedback = document.getElementById('practice-feedback');
            if (isCorrect) {
                feedback.innerHTML = `<p class="success-message">Perfect! You sorted the array in ${swapCount} swaps.</p>`;
                addXP(100 + Math.max(0, 50 - swapCount * 5), 'practice-sort'); // Bonus for efficiency
                unlockAchievement('practitioner', achievementList.practitioner);
            } else {
                feedback.innerHTML = '<p class="error-message">Not quite sorted yet. Keep trying!</p>';
            }
        }

        resetPracticeArray();

        function checkApplication(btn, answer) {
            const buttons = btn.parentElement.querySelectorAll('.quiz-option');
            buttons.forEach(b => b.disabled = true);
            
            if (answer === 'b') {
                btn.classList.add('correct');
                document.getElementById('application-feedback').innerHTML = 
                    '<p class="success-message">Correct! Insertion sort excels with nearly sorted data, making it perfect for maintaining sorted lists.</p>';
                addXP(75, 'application-quiz');
            } else {
                btn.classList.add('incorrect');
                document.getElementById('application-feedback').innerHTML = 
                    '<p class="error-message">Think about when insertion sort performs best - with small or nearly sorted datasets.</p>';
            }
        }

        function checkMistakeAnswer() {
            const answer = document.getElementById('mistake-answer').value.toLowerCase();
            const keywords = ['loop', 'start', 'zero', '0', 'index', 'first', 'a[j]', 'a[j + 1]', 'range', 'range(0', 'range(1'];
            
            const matchedKeywords = keywords.filter(keyword => answer.includes(keyword));
            
            if (answer.length < 50) {
                document.getElementById('mistake-feedback').innerHTML = 
                    '<p class="error-message">Please provide a more detailed explanation.</p>';
                return;
            }
            
            if (matchedKeywords.length >= 2) {
                document.getElementById('mistake-feedback').innerHTML = 
                    '<p class="success-message">Good analysis! The main issues are: 1) Loop starts at 0 (should start at 1 with range(1, len(A))), and 2) Line 6 has wrong assignment (should be A[j + 1] = A[j]).</p>';
                addXP(50 + matchedKeywords.length * 10, 'mistake-analysis');
            } else {
                document.getElementById('mistake-feedback').innerHTML = 
                    '<p class="error-message">Look more carefully at the loop starting index and the assignment in line 6.</p>';
            }
        }

        // Summary quiz
        function checkSummaryAnswer(btn, question, answer) {
            const questionKey = 'summary-q' + question;
            if (completedTasks.has(questionKey)) return;
            
            const correct = {
                1: 'b', 2: 'true', 3: 'b', 4: 'c',
                5: 'd', 6: 'c', 7: 'c', 8: 'b'
            };
            
            const buttons = btn.parentElement.querySelectorAll('.quiz-option');
            buttons.forEach(b => b.disabled = true);
            
            if (answer === correct[question]) {
                btn.classList.add('correct');
                summaryAnswers[question] = true;
                addXP(25, questionKey);
            } else {
                btn.classList.add('incorrect');
                summaryAnswers[question] = false;
            }
            
            // Check if all questions answered
            if (Object.keys(summaryAnswers).length === 8) {
                const score = Object.values(summaryAnswers).filter(v => v).length;
                const percentage = (score / 8) * 100;
                
                document.getElementById('summary-score').innerHTML = 
                    `<h3>Final Score: ${score}/8 (${percentage.toFixed(0)}%)</h3>`;
                
                if (percentage === 100) {
                    unlockAchievement('perfectScore', achievementList.perfectScore);
                }
            }
        }

        // Exam question
        function submitExamAnswer() {
            const partA = document.getElementById('exam-part-a').value;
            const partB = document.getElementById('exam-part-b').value;
            const partC = document.getElementById('exam-part-c').value;
            const predicted = document.getElementById('predicted-marks').value;
            
            if (!partA || !partB || !partC || !predicted) {
                document.getElementById('exam-feedback').innerHTML = 
                    '<p class="error-message">Please answer all parts and provide predicted marks.</p>';
                return;
            }
            
            if (partA.length < 100 || partB.length < 50 || partC.length < 30) {
                document.getElementById('exam-feedback').innerHTML = 
                    '<p class="error-message">Please provide more detailed answers before viewing the mark scheme.</p>';
                return;
            }
            
            document.getElementById('mark-scheme').style.display = 'block';
            document.getElementById('exam-feedback').innerHTML = 
                '<p class="success-message">Well done! Compare your answer with the mark scheme above.</p>';
            
            addXP(250, 'exam-question');
            unlockAchievement('examReady', achievementList.examReady);
        }

        // Extension activities
        document.querySelectorAll('.extension-task textarea').forEach((textarea, index) => {
            textarea.addEventListener('input', function() {
                if (this.value.length > 100 && !completedTasks.has('extension-' + index)) {
                    addXP(100, 'extension-' + index);
                    if (!completedTasks.has('explorer-achievement')) {
                        completedTasks.add('explorer-achievement');
                        unlockAchievement('explorer', achievementList.explorer);
                    }
                }
            });
        });

        function completeWorksheet() {
            if (level >= 4) {
                unlockAchievement('completionist', achievementList.completionist);
                showParticles();
                alert('Congratulations! You have mastered insertion sort!');
            } else {
                alert('Complete more activities to finish the worksheet. Current level: ' + level + '/5');
            }
        }

        // Feedback system
        function openFeedback() {
            document.getElementById('feedback-modal').style.display = 'flex';
        }

        function closeFeedback() {
            document.getElementById('feedback-modal').style.display = 'none';
        }

        function sendFeedback() {
            const feedback = document.getElementById('feedback-text').value;
            if (!feedback) return;
            
            const subject = 'Insertion Sort Worksheet Feedback - ' + currentSection;
            const body = `Section: ${currentSection}\n\nFeedback: ${feedback}\n\nUser Stats: Level ${level}, XP ${xp}`;
            
            // Create mailto link
            const mailtoLink = `mailto:millingtond@mgs.org?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.location.href = mailtoLink;
            
            closeFeedback();
            document.getElementById('feedback-text').value = '';
        }

        // Close feedback modal on outside click
        document.getElementById('feedback-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeFeedback();
            }
        });

        // Add CSS animation for floating XP
        const style = document.createElement('style');
        style.textContent = `
            @keyframes floatUp {
                0% {
                    opacity: 1;
                    transform: translateY(0);
                }
                100% {
                    opacity: 0;
                    transform: translateY(-50px);
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>