<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python Path</title>
    <!-- Google Fonts: Inter for UI, Fira Code for code blocks -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Fira+Code:wght@500&display=swap" rel="stylesheet">
    <!-- Tone.js for Sound Effects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    
    <style>
        /* --- VISUAL REFINEMENT STYLES --- */
        :root {
            --font-sans: 'Inter', sans-serif;
            --font-mono: 'Fira Code', monospace;
            --bg-color: #f7f8fa;
            --panel-color: #ffffff;
            --border-color: #e2e8f0;
            --shadow-color-light: rgba(45, 55, 72, 0.08);
            --shadow-color-dark: rgba(45, 55, 72, 0.15);
            --text-primary: #1a202c;
            --text-secondary: #718096;
            --accent-primary: #4f46e5;
            --accent-primary-hover: #4338ca;
            --sprite-color-start: #60a5fa;
            --sprite-color-end: #3b82f6;
            --tile-blue: #dbeafe;
            --tile-green: #dcfce7;
            --tile-red: #fee2e2;
            --tile-purple: #e9d5ff;
            --tile-yellow: #fef08a;
            --victory-gold: #fde047;
            --xp-bar-color: #f59e0b;
            --code-bg: #f1f5f9;
            --code-function: #be185d;
            --code-string: #059669;
            --code-keyword: #8b5cf6;
            --code-number: #d97706;
            --code-def: #9333ea;
            --code-operator: #9333ea;
        }

        /* General Setup & Main Layout */
        body {
            background-color: var(--bg-color);
            font-family: var(--font-sans);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            color: var(--text-primary);
            overflow: hidden;
            background-image: radial-gradient(var(--border-color) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .game-container {
            display: flex;
            flex-direction: column; 
            width: 100%;
            height: 100%;
            max-width: 1400px;
            max-height: 95vh;
            box-shadow: 0 10px 30px -15px var(--shadow-color-dark);
            border-radius: 20px;
            overflow: hidden;
            position: relative;
            border: 1px solid var(--border-color);
        }
        .main-content {
            display: flex;
            flex: 1;
            min-height: 0;
        }
        .instructions-panel, .game-panel {
            padding: clamp(15px, 2.5vw, 40px);
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }
        .instructions-panel {
            background-color: var(--panel-color);
            flex-basis: 40%;
            border-right: 1px solid var(--border-color);
            min-width: 450px;
        }
        .game-panel {
            flex-basis: 60%;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        /* UI Elements */
        .level-title { text-align: center; margin-top: 0; margin-bottom: 5px; font-size: clamp(1.8rem, 3vw, 2.5rem); font-weight: 700; }
        .attempts-counter { text-align: center; font-size: clamp(1rem, 1.2vw, 1.1rem); color: var(--text-secondary); margin-bottom: 20px; min-height: 1.2rem; font-weight: 500; }

        /* XP System UI */
        .xp-container { margin: 5px 0 15px 0; text-align: center; }
        .player-level { font-weight: 700; color: var(--accent-primary); font-size: 1.1rem; margin-bottom: 8px; }
        .xp-bar-background { width: 80%; margin: 0 auto; background-color: var(--border-color); border-radius: 8px; height: 16px; overflow: hidden; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); }
        .xp-bar-fill { height: 100%; width: 0%; background: linear-gradient(90deg, var(--xp-bar-color), #fcd34d); border-radius: 8px; transition: width 0.5s ease-out; }
        .xp-text { font-size: 0.9rem; color: var(--text-secondary); margin-top: 5px; font-weight: 500; }
        .xp-gain-popup { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 8px 16px; background-color: rgba(245, 158, 11, 0.9); color: white; font-weight: 700; border-radius: 20px; z-index: 150; opacity: 0; animation: xpGainAnimation 1.5s ease-out forwards; font-size: 1.2rem; pointer-events: none; }
        @keyframes xpGainAnimation { 0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; } 20% { transform: translate(-50%, -100%) scale(1); opacity: 1; } 80% { transform: translate(-50%, -150%) scale(1); opacity: 1; } 100% { transform: translate(-50%, -200%) scale(0.8); opacity: 0; } }
        .level-up-popup { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); padding: 15px 30px; background: linear-gradient(45deg, var(--accent-primary), #a78bfa); color: white; font-weight: 700; border-radius: 12px; z-index: 151; opacity: 0; font-size: 2rem; pointer-events: none; text-shadow: 0 2px 4px rgba(0,0,0,0.2); animation: levelUpAnimation 2s ease-out forwards; }
        @keyframes levelUpAnimation { 0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; } 50% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(1); opacity: 0; } }

        .code-block { 
            background-color: var(--code-bg); 
            border: 1px solid var(--border-color); 
            border-radius: 12px; 
            padding: 20px; 
            flex-grow: 1; 
            font-family: var(--font-mono); 
            font-size: clamp(14px, 1.5vw, 16px); 
            line-height: 1.8; 
            overflow: auto;
            white-space: pre;
        }
        
        button { cursor: pointer; border: none; border-radius: 8px; font-size: clamp(15px, 1.5vw, 16px); padding: 12px 20px; transition: all 0.2s ease; font-weight: 700; font-family: var(--font-sans); }
        button:active { transform: scale(0.96); }
        .button-container { display: flex; gap: 12px; margin-top: 20px; flex-wrap: wrap; }
        .primary-btn { background: var(--accent-primary); color: white; flex-grow: 1; box-shadow: 0 4px 14px 0 rgba(79, 70, 229, 0.39); }
        .primary-btn:hover { background: var(--accent-primary-hover); box-shadow: 0 6px 20px 0 rgba(79, 70, 229, 0.23); }
        .secondary-btn { background-color: transparent; color: var(--text-secondary); border: 2px solid var(--border-color); flex-grow: 1; }
        .secondary-btn:hover { background-color: var(--bg-color); border-color: #cbd5e1; color: var(--text-primary); }
        .skip-btn { margin-top: 10px; background-color: #f8fafc; color: var(--text-secondary); border: 1px solid var(--border-color); }
        .skip-btn:hover { background-color: #f1f5f9; }

        .level-select-container { margin-top: 15px; display: flex; align-items: center; justify-content: center; padding: 10px; background-color: var(--code-bg); border-radius: 8px; }
        .level-select-container label { font-weight: 500; color: var(--text-secondary); margin-right: 10px; }
        #level-select { padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border-color); background-color: #fff; font-family: var(--font-sans); font-weight: 500; }

        /* Start Screen Overlay */
        #start-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(30, 41, 59, 0.8); backdrop-filter: blur(8px); display: flex; justify-content: center; align-items: center; z-index: 999; color: white; flex-direction: column; text-align: center; cursor: pointer; transition: opacity 0.5s ease; }
        #start-overlay h1 { font-size: 3rem; margin-bottom: 10px; }
        #start-overlay p { font-size: 1.5rem; }
        
        /* Grid & Sprite */
        .grid-container { width: 85vmin; height: 85vmin; max-width: 650px; max-height: 650px; position: relative; display: grid; grid-template-columns: repeat(10, 1fr); grid-template-rows: repeat(10, 1fr); border: 1px solid var(--border-color); background-color: var(--panel-color); box-shadow: 0 0 0 1px var(--border-color), 0 5px 25px var(--shadow-color-light); border-radius: 12px; gap: 1px; background-color: var(--border-color); }
        .grid-cell { background-color: var(--panel-color); transition: background-color 0.3s ease; }
        .grid-cell.blue { background-color: var(--tile-blue); }
        .grid-cell.green { background-color: var(--tile-green); }
        .grid-cell.red { background-color: var(--tile-red); }
        .grid-cell.purple { background-color: var(--tile-purple); }
        .grid-cell.yellow { background-color: var(--tile-yellow); }
        .sprite { position: absolute; background: radial-gradient(circle at 35% 35%, var(--sprite-color-start), var(--sprite-color-end)); border-radius: 50%; box-shadow: 0 5px 10px rgba(60, 130, 246, 0.5), inset 0 0 3px 1px rgba(255,255,255,0.5); transition: all 0.15s linear; }

        /* Syntax Highlighting */
        .code-function { color: var(--code-function); font-weight: 500; }
        .code-def-name { color: var(--code-function); font-weight: 700; }
        .code-string { color: var(--code-string); }
        .code-loop, .code-conditional, .code-def { color: var(--code-keyword); font-weight: 500; }
        .code-variable { font-style: italic; color: var(--text-primary); }
        .code-number { color: var(--code-number); }
        .code-operator { color: var(--code-operator); font-weight: 700; }

        /* Modals & Badges */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(30, 41, 59, 0.6); backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: center; z-index: 100; visibility: hidden; opacity: 0; transition: opacity 0.3s ease, visibility 0s 0.3s; }
        .modal-overlay.visible { visibility: visible; opacity: 1; transition-delay: 0s; }
        .modal-box { background: var(--bg-color); width: 90%; max-width: 800px; max-height: 80vh; border-radius: 16px; padding: 30px 40px; box-sizing: border-box; display: flex; flex-direction: column; transform: scale(0.95) translateY(10px); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.3s ease; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); opacity: 0; }
        .modal-overlay.visible .modal-box { transform: scale(1) translateY(0); opacity: 1; }
        .modal-box h2 { margin: 0 0 20px 0; text-align: center; font-size: 1.8rem; }
        .badge-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 20px; overflow-y: auto; flex-grow: 1; padding-right: 10px; }
        .badge { aspect-ratio: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; background: var(--panel-color); border-radius: 12px; padding: 10px; border: 1px solid var(--border-color); filter: grayscale(1); opacity: 0.7; transition: all 0.3s ease; }
        .badge.earned { filter: grayscale(0); opacity: 1; border-color: var(--accent-primary); box-shadow: 0 4px 10px var(--shadow-color-light); transform: translateY(-3px); }
        .badge-icon { font-size: 2.8em; }
        .badge-name { font-weight: bold; font-size: 0.9em; margin-top: 10px; }
        .badge-desc { font-size: 0.75em; color: var(--text-secondary); }
        .modal-close-btn { align-self: center; margin-top: 20px; min-width: 120px; }
        .badge-notification { position: fixed; top: 20px; right: -100%; background-color: var(--panel-color); color: var(--text-primary); padding: 20px; border-radius: 12px; box-shadow: 0 10px 25px -5px var(--shadow-color-dark); border: 1px solid var(--border-color); display: flex; align-items: center; gap: 15px; transition: right 0.6s cubic-bezier(0.2, 1, 0.2, 1); z-index: 200; }
        .badge-notification.show { right: 20px; }
        .confirm-modal { max-width: 450px; text-align: center; padding: 40px; }
        .confirm-modal p { margin: 0 0 25px 0; font-size: 1.1rem; line-height: 1.6; color: var(--text-secondary); }
        .confirm-buttons { display: flex; gap: 15px; justify-content: center; }
        .confirm-btn { background: #dc2626; color: white; }
        .confirm-btn:hover { background: #b91c1c; }
        
        /* Settings Modal & Toggle Switch */
        .settings-row { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid var(--border-color); }
        .settings-row:last-child { border-bottom: none; }
        .settings-row label { font-size: 1.1rem; font-weight: 500; }
        .toggle-switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 28px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent-primary); }
        input:checked + .slider:before { transform: translateX(22px); }

        /* --- NEW: Feedback Button and Modal Styles --- */
        #feedback-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--accent-primary);
            color: white;
            font-size: 1.8rem;
            line-height: 1;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px var(--shadow-color-dark);
            z-index: 100;
            border: 2px solid white;
        }
        #feedback-textarea {
            width: 100%;
            height: 150px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-family: var(--font-sans);
            font-size: 1rem;
            resize: vertical;
            margin-bottom: 15px;
        }
        
        /* Touch Controls */
        #touch-controls { display: none; }

        /* Animations */
        @keyframes shake { 0%, 100% { transform: translateX(0); } 10%, 50%, 90% { transform: translateX(-6px); } 30%, 70% { transform: translateX(6px); } }
        .sprite-shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97); }
        @keyframes victory-flip { 0%   { transform: scale(1) rotateY(0deg); box-shadow: 0 5px 10px rgba(60, 130, 246, 0.5); } 50%  { transform: scale(1.5) rotateY(180deg); box-shadow: 0 8px 25px rgba(253, 224, 71, 0.7); background: radial-gradient(circle at 35% 35%, #fde047, #facc15); } 100% { transform: scale(1) rotateY(360deg); box-shadow: 0 5px 10px rgba(60, 130, 246, 0.5); } }
        .sprite-celebrate { animation: victory-flip 1.2s ease-in-out; }
        @keyframes tile-flash { 50% { background-color: var(--victory-gold); } }
        .tile-flash { animation: tile-flash 1.2s ease-in-out; }

        /* Media query for mobile layout and touch controls */
        @media (max-width: 800px), (max-height: 600px) {
            body { height: auto; min-height: 100vh; }
            .game-container { flex-direction: column; height: 100%; max-height: none; border-radius: 0; border: none; }
            .main-content { flex-direction: column; }
            .instructions-panel { border-right: none; border-bottom: 1px solid var(--border-color); min-width: unset; }
            #touch-controls { display: grid; grid-template-areas: ". up ." "left . right" ". down ."; gap: 10px; width: 150px; margin-top: 20px; }
            .arrow-btn { width: 50px; height: 50px; font-size: 2rem; line-height: 1; background-color: var(--panel-color); border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 2px 5px var(--shadow-color-light); }
            .arrow-btn:active { background-color: var(--border-color); transform: scale(0.95); }
            #arrow-up { grid-area: up; }
            #arrow-down { grid-area: down; }
            #arrow-left { grid-area: left; }
            #arrow-right { grid-area: right; }
        }
    </style>
</head>
<body>
    <div id="start-overlay">
        <h1>Python Path</h1>
        <p>Click anywhere to begin your journey.</p>
    </div>

    <div class="game-container" style="visibility: hidden;">
        <div class="main-content">
            <div class="instructions-panel">
                <h1 class="level-title">Level 1</h1>
                <div class="xp-container">
                    <div class="player-level">Player Level 1</div>
                    <div class="xp-bar-background">
                        <div class="xp-bar-fill"></div>
                    </div>
                    <div class="xp-text">0 / 100 XP</div>
                </div>
                <div class="attempts-counter"></div>
                <div class="code-block"></div>
                <div class="button-container">
                    <button class="secondary-btn" id="settings-btn">⚙️</button>
                    <button class="secondary-btn" id="reset-btn">Reset</button>
                    <button class="primary-btn" id="badges-btn">🏆 Badges</button>
                </div>
                <button class="skip-btn" style="margin-top: 10px;">Skip Level →</button>
                <div class="level-select-container">
                    <label for="level-select">Go to Level:</label>
                    <select id="level-select"></select>
                </div>
            </div>
            <div class="game-panel">
                <div class="grid-container">
                    <div class="sprite"></div>
                </div>
                <div id="touch-controls">
                    <button id="arrow-up" class="arrow-btn">▲</button>
                    <button id="arrow-left" class="arrow-btn">◀</button>
                    <button id="arrow-right" class="arrow-btn">▶</button>
                    <button id="arrow-down" class="arrow-btn">▼</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="badge-overlay" class="modal-overlay">
        <div class="modal-box">
            <h2>Your Badges</h2>
            <div class="badge-grid"></div>
            <button id="badge-close-btn" class="secondary-btn modal-close-btn">Close</button>
        </div>
    </div>

    <div id="settings-overlay" class="modal-overlay">
        <div class="modal-box confirm-modal">
            <h2>Settings</h2>
            <div class="settings-row">
                <label for="sound-toggle">Sound Effects</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="sound-toggle">
                    <span class="slider"></span>
                </label>
            </div>
            <button id="settings-close-btn" class="primary-btn modal-close-btn">Done</button>
        </div>
    </div>
    
    <div id="confirm-overlay" class="modal-overlay">
        <div class="modal-box confirm-modal">
            <h2>Are you sure?</h2>
            <p id="confirm-text">This will erase all of your progress, including completed levels and earned badges. This action cannot be undone.</p>
            <div class="confirm-buttons">
                 <button id="confirm-cancel-btn" class="secondary-btn">Cancel</button>
                 <button id="confirm-ok-btn" class="confirm-btn">Yes, Reset</button>
            </div>
        </div>
    </div>

    <!-- NEW: Feedback Modal -->
    <div id="feedback-overlay" class="modal-overlay">
        <div class="modal-box confirm-modal">
            <h2>Submit Feedback</h2>
            <p>Spotted a bug or have a suggestion? Let us know!</p>
            <textarea id="feedback-textarea" placeholder="Please describe the issue or your idea..."></textarea>
            <div class="confirm-buttons">
                <button id="feedback-cancel-btn" class="secondary-btn">Cancel</button>
                <button id="feedback-send-btn" class="primary-btn">Send</button>
            </div>
        </div>
    </div>

    <div class="badge-notification"></div>

    <!-- NEW: Feedback Button -->
    <button id="feedback-btn" title="Submit Feedback">🐞</button>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            const game = {
                badgeData: {
                    'first_step': { name: 'First Step', desc: 'Complete Level 1', icon: '👟' },
                    'novice_no_more': { name: 'Novice No More', desc: 'Complete Level 10', icon: '🧑‍🎓' },
                    'loop_learner': { name: 'Loop Learner', desc: 'Complete your first `for` loop', icon: '🔄' },
                    'if_initiate': { name: 'Conditional Coder', desc: 'Complete your first `if` statement', icon: '🤔' },
                    'while_wizard': { name: 'While Wizard', desc: 'Complete your first `while` loop', icon: '🧙' },
                    'branching_out': { name: 'Branching Out', desc: 'Complete your first if/else level', icon: '🌳' },
                    'function_follower': { name: 'Function Follower', desc: 'Complete your first function level', icon: '⚙️' },
                    'quarter_century': { name: 'Quarter Century', desc: 'Reach Level 25', icon: '🎉' },
                    'python_master': { name: 'Python Master', desc: 'Complete Level 45', icon: '👑' },
                    'grandmaster': { name: 'Grandmaster', desc: 'Complete all available levels', icon: '🏆' },
                    'perfect_10': { name: 'Perfectionist', desc: 'Complete 10 levels perfectly', icon: '🎯' },
                    'flawless_victory': { name: 'Flawless Victory', desc: 'Beat a hard level on the first try', icon: '💎' },
                    'persistent': { name: 'Persistent', desc: 'Make 50 total attempts', icon: '💪' },
                    'the_determinator': { name: 'Determinator', desc: 'Beat a level after 10 tries', icon: '🧗' },
                    'wrong_way': { name: 'Wrong Way', desc: 'Make 100 wrong moves', icon: '↩️' },
                    'wall_bumper': { name: 'Wall Bumper', desc: 'Try to move off the grid 25 times', icon: '🧱' },
                    'careful_coder': { name: 'Careful Coder', desc: 'Complete 15 levels perfectly', icon: '👌' },
                    'nested_knowledge': { name: 'Nested Knowledge', desc: 'Complete your first nested level', icon: '🪆' },
                    'chain_reaction': { name: 'Chain Reaction', desc: 'Complete a level with chained loops', icon: '⛓️' },
                    'parameter_pro': { name: 'Parameter Pro', desc: 'Use a parameterized function', icon: '🔢' },
                    'logic_lord': { name: 'Logic Lord', desc: 'Use a logical operator (and, or, not)', icon: '💡' },
                    'logic_ladder': { name: 'Logic Ladder', desc: 'Use an elif statement', icon: '🪜'},
                    'nested_master': { name: 'Nested Master', desc: 'Use nested loops', icon: '🍱'},
                    'recursive_rythm': { name: 'Recursive Rythm', desc: 'Solve a recursive level', icon: '➰'}
                },
                
                levelData: [
                    // Levels 1-69 are unchanged
                    { level: 1, startPos: { x: 4, y: 4 }, commands: [{ type: 'move', direction: 'right' }, { type: 'move', direction: 'down' }] },
                    { level: 2, startPos: { x: 1, y: 1 }, commands: [{ type: 'move', direction: 'right' }, { type: 'move', direction: 'right' }, { type: 'move', direction: 'down' }] },
                    { level: 3, startPos: { x: 8, y: 2 }, commands: [{ type: 'move', direction: 'down' }, { type: 'move', direction: 'down' }, { type: 'move', direction: 'left' }, { type: 'move', direction: 'left' }] },
                    { level: 4, startPos: { x: 2, y: 7 }, commands: [{ type: 'move', direction: 'up' }, { type: 'move', direction: 'right' }, { type: 'move', direction: 'up' }, { type: 'move', direction: 'right' }, { type: 'move', direction: 'right' }] },
                    { level: 5, startPos: { x: 5, y: 5 }, commands: [{ type: 'move', direction: 'up' }, { type: 'move', direction: 'left' }, { type: 'move', direction: 'left' }, { type: 'move', direction: 'down' }, { type: 'move', direction: 'down' }, { type: 'move', direction: 'right' }] },
                    { level: 6, startPos: { x: 0, y: 9 }, commands: [{ type: 'move', direction: 'up' }, { type: 'move', direction: 'up' }, { type: 'move', direction: 'up' }, { type: 'move', direction: 'right' }, { type: 'move', direction: 'right' }, { type: 'move', direction: 'down' }] },
                    { level: 7, startPos: { x: 9, y: 0 }, commands: [{ type: 'move', direction: 'left' }, { type: 'move', direction: 'left' }, { type: 'move', direction: 'down' }, { type: 'move', direction: 'down' }, { type: 'move', direction: 'left' }, { type: 'move', direction: 'left' }, { type: 'move', direction: 'down' }] },
                    { level: 8, startPos: { x: 4, y: 8 }, commands: [{ type: 'move', direction: 'up' }, { type: 'move', direction: 'up' }, { type: 'move', direction: 'left' }, { type: 'move', direction: 'up' }, { type: 'move', direction: 'up' }, { type: 'move', direction: 'right' }, { type: 'move', direction: 'up' }, { type: 'move', direction: 'up' }] },
                    { level: 9, startPos: { x: 1, y: 3 }, commands: [{ type: 'move', direction: 'right' }, { type: 'move', direction: 'down' }, { type: 'move', direction: 'right' }, { type: 'move', direction: 'down' }, { type: 'move', direction: 'right' }, { type: 'move', direction: 'up' }, { type: 'move', direction: 'right' }, { type: 'move', direction: 'up' }, { type: 'move', direction: 'right' }] },
                    { level: 10, startPos: { x: 4, y: 4 }, commands: [{ type: 'move', direction: 'right' }, { type: 'move', direction: 'down' }, { type: 'move', direction: 'left' }, { type: 'move', direction: 'left' }, { type: 'move', direction: 'up' }, { type: 'move', direction: 'up' }, { type: 'move', direction: 'right' }, { type: 'move', direction: 'right' }, { type: 'move', direction: 'right' }, { type: 'move', direction: 'down' }, { type: 'move', direction: 'down' }] },
                    { level: 11, startPos: { x: 1, y: 1 }, commands: [ { type: 'loop', count: 4, commands: [{ type: 'move', direction: "right"}] }, { type: 'loop', count: 3, commands: [{ type: 'move', direction: "down"}] } ]},
                    { level: 12, startPos: { x: 4, y: 4 }, commands: [ { type: 'loop', count: 2, commands: [{ type: 'move', direction: "up"}, { type: 'move', direction: "right"}] }, { type: 'loop', count: 2, commands: [{ type: 'move', direction: "down"}, { type: 'move', direction: "right"}] }, { type: 'loop', count: 2, commands: [{ type: 'move', direction: "down"}, { type: 'move', direction: "left"}] } ]},
                    { level: 13, startPos: { x: 1, y: 8 }, commands: [ { type: 'loop', count: 3, commands: [{ type: 'move', direction: "right"}] }, { type: 'loop', count: 6, commands: [{ type: 'move', direction: "up"}] }, { type: 'loop', count: 3, commands: [{ type: 'move', direction: "right"}] } ]},
                    { level: 14, startPos: { x: 0, y: 0 }, commands: [ { type: 'loop', count: 4, commands: [{ type: 'move', direction: "down"}, { type: 'move', direction: "right"}] } ]},
                    { level: 15, startPos: { x: 1, y: 1 }, commands: [ { type: 'loop', count: 3, commands: [{ type: 'move', direction: "right"}] }, { type: 'move', direction: "down"}, { type: 'loop', count: 3, commands: [{ type: 'move', direction: "left"}] }, { type: 'move', direction: "down"}, { type: 'loop', count: 3, commands: [{ type: 'move', direction: "right"}] } ]},
                    { level: 16, startPos: { x: 2, y: 4 }, tiles: { blue: [{x:3, y:4}, {x:5, y:4}] }, commands: [ { type: 'move', direction: "right"}, { type: 'if', condition: { color: 'blue' }, commands: [{ type: 'move', direction: "up"}] }, { type: 'move', direction: "right"}, { type: 'if', condition: { color: 'blue' }, commands: [{ type: 'move', direction: "down"}] }, { type: 'move', direction: "right"} ]},
                    { level: 17, startPos: { x: 1, y: 1 }, tiles: { blue: [{x:1,y:2}, {x:1,y:3}, {x:2,y:4}, {x:3,y:4}, {x:4,y:3}, {x:4,y:2}, {x:3,y:1}] }, commands: [ { type: 'loop', count: 8, commands: [ { type: 'move', direction: "down"}, { type: 'if', condition: { color: 'blue'}, commands: [{ type: 'move', direction: "right"}] } ]} ]},
                    { level: 18, startPos: { x: 1, y: 5 }, tiles: { blue: [{x:2, y:5}, {x:4, y:5}, {x:6, y:5}] }, commands: [ { type: 'loop', count: 6, commands: [ { type: 'move', direction: "right"}, { type: 'if', condition: { color: 'blue' }, commands: [{ type: 'move', direction: "up"}, { type: 'move', direction: "up"}] } ]}]},
                    { level: 19, startPos: { x: 0, y: 4 }, tiles: { blue: [{x:2, y:4}, {x:5, y:4}], green: [{x:3, y:4}, {x:6, y:4}] }, commands: [ { type: 'move', direction: "right"}, { type: 'move', direction: "right"}, { type: 'if', condition: {color: 'blue'}, commands: [{ type: 'move', direction: "up"}]}, { type: 'move', direction: "right"}, { type: 'if', condition: {color: 'green'}, commands: [{ type: 'move', direction: "down"}]}, { type: 'move', direction: "right"}, { type: 'move', direction: "right"}, { type: 'if', condition: {color: 'blue'}, commands: [{ type: 'move', direction: "up"}]}, { type: 'move', direction: "right"}, { type: 'if', condition: {color: 'green'}, commands: [{ type: 'move', direction: "down"}]} ]},
                    { level: 20, startPos: { x: 1, y: 1 }, tiles: { blue: [{x:1, y:2}, {x:3,y:2}, {x:5,y:2}, {x:7,y:2}] }, commands: [ { type: 'loop', count: 4, commands: [{ type: 'move', direction: "down"}, { type: 'move', direction: "right"}, { type: 'if', condition: {color: 'blue'}, commands: [{ type: 'move', direction: "down"}]}, { type: 'move', direction: "right"} ]} ]},
                    { level: 21, startPos: { x: 2, y: 3 }, tiles: { green: [{x:2,y:4}, {x:3,y:4}, {x:4,y:4}, {x:5,y:4}] }, commands: [ { type: 'move', direction: "down"}, { type: 'while', condition: { color: 'green' }, commands: [{ type: 'move', direction: "right"}] } ]},
                    { level: 22, startPos: { x: 1, y: 1 }, tiles: { green: [{x:1,y:2},{x:1,y:3},{x:1,y:4}], blue: [{x:2,y:4},{x:3,y:4},{x:4,y:4}] }, commands: [ { type: 'move', direction: "down"}, { type: 'while', condition: { color: 'green' }, commands: [{ type: 'move', direction: "down"}] }, { type: 'move', direction: "up"}, { type: 'move', direction: "right"}, { type: 'while', condition: { color: 'blue' }, commands: [{ type: 'move', direction: "right"}] } ]},
                    { level: 23, startPos: { x: 2, y: 8 }, tiles: { green: [{x:2,y:7}, {x:2,y:6}, {x:2,y:5}, {x:2,y:4}, {x:2,y:3}, {x:2,y:2}] }, commands: [ { type: 'move', direction: "up"}, { type: 'while', condition: { color: 'green' }, commands: [{ type: 'move', direction: "up"}] } ]},
                    { level: 24, startPos: { x: 1, y: 1 }, tiles: { green: [{x:2,y:1},{x:3,y:1},{x:4,y:1}], blue: [{x:4,y:2},{x:4,y:3},{x:4,y:4}] }, commands: [ { type: 'move', direction: "right"}, { type: 'while', condition: { color: 'green' }, commands: [{ type: 'move', direction: "right"}] }, { type: 'move', direction: "left"}, { type: 'move', direction: "down"}, { type: 'while', condition: { color: 'blue' }, commands: [{ type: 'move', direction: "down"}] } ]},
                    { level: 25, startPos: { x: 8, y: 1 }, tiles: { green: [{x:7,y:1},{x:6,y:1},{x:5,y:1}], blue: [{x:5,y:2},{x:5,y:3},{x:5,y:4}] }, commands: [ { type: 'move', direction: "left"}, { type: 'while', condition: {color: 'green'}, commands: [{ type: 'move', direction: "left"}]}, { type: 'move', direction: "right"}, { type: 'move', direction: "down"}, { type: 'while', condition: {color: 'blue'}, commands: [{ type: 'move', direction: "down"}]} ]},
                    { level: 26, startPos: { x: 1, y: 8 }, tiles: { green: [{x:1, y:7}, {x:1, y:6}], blue: [{x:2, y:6}, {x:3, y:6}] }, commands: [ { type: 'move', direction: "up"}, { type: 'while', condition: {color: 'green'}, commands: [{ type: 'move', direction: "up"}] }, { type: 'move', direction: "down"}, { type: 'move', direction: "right"}, { type: 'while', condition: {color: 'blue'}, commands: [{ type: 'move', direction: "right"}] } ] },
                    { level: 27, startPos: { x: 4, y: 1 }, tiles: { green: [{x:4,y:2},{x:4,y:3},{x:4,y:4}], blue: [{x:3,y:4},{x:2,y:4},{x:1,y:4}] }, commands: [ { type: 'move', direction: "down"}, { type: 'while', condition: { color: 'green' }, commands: [{ type: 'move', direction: "down"}] }, { type: 'move', direction: "up"}, { type: 'move', direction: "left"}, { type: 'while', condition: { color: 'blue' }, commands: [{ type: 'move', direction: "left"}] } ]},
                    { level: 28, startPos: { x: 0, y: 4 }, hasNested: true, tiles: { blue: [{x:1,y:4},{x:2,y:4},{x:3,y:4}], green: [{x:3,y:5},{x:3,y:6},{x:3,y:7}] }, commands: [ { type: 'loop', count: 3, commands: [ { type: 'move', direction: "right"}, { type: 'if', condition: {color: 'blue'}, commands: [{ type: 'move', direction: "down"}] } ] }, { type: 'loop', count: 2, commands: [{ type: 'move', direction: "down"}] } ]},
                    { level: 29, startPos: { x: 8, y: 8 }, tiles: { green: [{x:7,y:8},{x:6,y:8},{x:5,y:8}], blue: [{x:5,y:7},{x:5,y:6},{x:5,y:5}] }, commands: [ { type: 'move', direction: "left"}, { type: 'while', condition: { color: 'green' }, commands: [{ type: 'move', direction: "left"}] }, { type: 'move', direction: "right"}, { type: 'move', direction: "up"}, { type: 'if', condition: { color: 'blue' }, commands: [{ type: 'move', direction: "up"}] }, { type: 'while', condition: { color: 'blue' }, commands: [{ type: 'move', direction: "up"}] } ]},
                    { level: 30, startPos: { x: 4, y: 0 }, hasNested: true, tiles: { green: [{x:4,y:1},{x:4,y:2}], blue: [{x:5,y:2},{x:6,y:2}] }, commands: [ { type: 'move', direction: "down"}, { type: 'while', condition: {color: 'green'}, commands: [{ type: 'move', direction: "down"}] }, { type: 'move', direction: "up"}, { type: 'loop', count: 2, commands: [ { type: 'move', direction: "right"}, { type: 'if', condition: { color: 'blue' }, commands: [{ type: 'move', direction: "right"}] } ] } ]},
                    { level: 31, hasElse: true, startPos: { x: 1, y: 1 }, tiles: { blue: [{x:1,y:2}] }, commands: [ { type: 'move', direction: "down"}, { type: 'if', condition: {color: 'blue'}, commands: [{ type: 'move', direction: "right"}], elseCommands: [{ type: 'move', direction: "left"}] } ]},
                    { level: 32, hasElse: true, startPos: { x: 0, y: 4 }, tiles: { green: [{x:1,y:4},{x:3,y:4}] }, commands: [ { type: 'loop', count: 4, commands: [{ type: 'move', direction: "right"}, { type: 'if', condition: {color: 'green'}, commands: [{ type: 'move', direction: "up"}], elseCommands: [{ type: 'move', direction: "down"}] }] } ]},
                    { level: 33, hasElse: true, startPos: { x: 1, y: 1 }, tiles: { blue: [{x:1,y:2}], green: [{x:2,y:3}] }, commands: [ { type: 'move', direction: "down"}, { type: 'if', condition: {color: 'blue'}, commands: [{ type: 'move', direction: "right"}], elseCommands: [{ type: 'move', direction: "down"}] }, { type: 'move', direction: "right"}, { type: 'if', condition: {color: 'green'}, commands: [{ type: 'move', direction: "up"}], elseCommands: [{ type: 'move', direction: "right"}] } ]},
                    { level: 34, hasElse: true, hasNested: true, startPos: { x: 8, y: 2 }, tiles: { blue: [{x:8,y:3},{x:8,y:4}], green: [{x:7,y:4},{x:6,y:4}] }, commands: [ { type: 'move', direction: "down"}, { type: 'while', condition: {color: 'blue'}, commands: [{ type: 'move', direction: "down"}, { type: 'if', condition: {color: 'green'}, commands: [{ type: 'move', direction: "left"}], elseCommands: [{ type: 'move', direction: "right"}] }] } ]},
                    { level: 35, hasElse: true, startPos: { x: 5, y: 8 }, tiles: { green: [{x:5,y:7},{x:5,y:6},{x:5,y:5}], blue: [{x:6,y:5},{x:7,y:5}] }, commands: [ { type: 'move', direction: "up"}, { type: 'while', condition: {color: 'green'}, commands: [{ type: 'move', direction: "up"}] }, { type: 'move', direction: "right"}, { type: 'if', condition: {color: 'blue'}, commands: [{ type: 'move', direction: "right"}], elseCommands: [{ type: 'move', direction: "down"}] }, { type: 'while', condition: {color: 'blue'}, commands: [{ type: 'move', direction: "right"}] } ]},
                    { level: 36, hasFunctions: true, startPos: { x: 1, y: 1 }, commands: [ { type: 'def', name: 'go_right_twice', commands: [{ type: 'move', direction: 'right'}, { type: 'move', direction: 'right'}] }, { type: 'call', name: 'go_right_twice' } ] },
                    { level: 37, hasFunctions: true, startPos: { x: 1, y: 4 }, commands: [ { type: 'def', name: 'zig', commands: [{ type: 'move', direction: 'right'}, { type: 'move', direction: 'up'}, { type: 'move', direction: 'right'}, { type: 'move', direction: 'down'}] }, { type: 'call', name: 'zig' }, { type: 'call', name: 'zig' } ] },
                    { level: 38, hasFunctions: true, startPos: { x: 4, y: 8 }, commands: [ { type: 'def', name: 'go_up', commands: [{ type: 'move', direction: 'up'}, { type: 'move', direction: 'up'}] }, { type: 'def', name: 'go_left', commands: [{ type: 'move', direction: 'left'}, { type: 'move', direction: 'left'}] }, { type: 'call', name: 'go_up' }, { type: 'call', name: 'go_left' }, { type: 'call', name: 'go_up' } ] },
                    { level: 39, hasFunctions: true, hasNested: true, startPos: { x: 0, y: 1 }, tiles: { blue: [{x:2,y:1},{x:5,y:1}] }, commands: [ { type: 'def', name: 'hop', commands: [{ type: 'move', direction: 'right'}, { type: 'move', direction: 'right'}] }, { type: 'loop', count: 3, commands: [{ type: 'call', name: 'hop' }, { type: 'if', condition: {color:'blue'}, commands: [{ type: 'move', direction: 'up'}]}] } ]},
                    { level: 40, hasFunctions: true, hasElse: true, startPos: { x: 2, y: 2 }, tiles: { green: [{x:4,y:2}] }, commands: [ { type: 'def', name: 'check_and_move', commands: [{ type: 'if', condition: {color: 'green'}, commands:[{ type: 'move', direction: 'up'}], elseCommands:[{ type: 'move', direction: 'down'}]}] }, { type: 'move', direction: 'right'}, { type: 'move', direction: 'right'}, { type: 'call', name: 'check_and_move'} ]},
                    { level: 41, hasFunctions: true, hasNested: true, startPos: { x: 1, y: 1 }, tiles: { green: [{x:1,y:2},{x:1,y:3},{x:1,y:4}], blue: [{x:2,y:4}] }, commands: [ { type: 'def', name: 'step_or_turn', commands: [{ type: 'if', condition: {color:'blue'}, commands:[{ type: 'move', direction: 'up'}], elseCommands:[{ type: 'move', direction: 'down'}] }] }, { type: 'move', direction: 'down'}, { type: 'while', condition: {color: 'green'}, commands: [{ type: 'move', direction: 'down'}, { type: 'call', name: 'step_or_turn' }] } ]},
                    { level: 42, hasFunctions: true, hasElse: true, hasNested: true, startPos: { x: 8, y: 1 }, tiles: { blue: [{x:7,y:1},{x:5,y:1}], green: [{x:5,y:2},{x:5,y:4}] }, commands: [ { type: 'def', name: 'pathfind', commands: [ { type: 'if', condition: {color:'green'}, commands:[{ type: 'move', direction: 'down'}], elseCommands:[{ type: 'move', direction: 'left'}] } ] }, { type: 'loop', count: 4, commands: [ { type: 'call', name: 'pathfind' } ] } ]},
                    { level: 43, hasFunctions: true, hasElse: true, hasNested: true, startPos: { x: 0, y: 8 }, tiles: { green: [{x:1,y:8},{x:2,y:8},{x:3,y:8}], blue: [{x:3,y:7},{x:3,y:6},{x:3,y:5}] }, commands: [ { type: 'def', name: 'go_horizontal', commands:[{ type: 'move', direction: 'right'}] }, { type: 'def', name: 'go_vertical', commands:[{ type: 'move', direction: 'up'}] }, { type: 'move', direction: 'right'}, { type: 'while', condition: {color: 'green'}, commands: [{ type: 'call', name: 'go_horizontal' }] }, { type: 'move', direction: 'up'}, { type: 'while', condition: {color: 'blue'}, commands: [{ type: 'call', name: 'go_vertical' }] } ]},
                    { level: 44, hasFunctions: true, hasElse: true, hasNested: true, startPos: { x: 4, y: 4 }, tiles: { blue: [{x:5,y:4},{x:3,y:4}], green: [{x:4,y:5},{x:4,y:3}] }, commands: [ { type: 'def', name: 'check_blue', commands: [{ type: 'if', condition:{color:'blue'}, commands:[{ type: 'move', direction: 'up'}], elseCommands:[{ type: 'move', direction: 'down'}] }] }, { type: 'def', name: 'check_green', commands: [{ type: 'if', condition:{color:'green'}, commands:[{ type: 'move', direction: 'left'}], elseCommands:[{ type: 'move', direction: 'right'}] }] }, { type: 'call', name: 'check_green' }, { type: 'call', name: 'check_blue' }, { type: 'call', name: 'check_green' }, { type: 'call', name: 'check_blue' } ]},
                    { level: 45, hasFunctions: true, hasElse: true, hasNested: true, startPos: { x: 0, y: 0 }, tiles: { green: [{x:0,y:1},{x:0,y:2},{x:0,y:3}], blue: [{x:1,y:3},{x:2,y:3},{x:3,y:3}], }, commands: [ { type: 'def', name: 'snake', commands: [{ type: 'move', direction: 'down'}, { type: 'move', direction: 'right'}, { type: 'move', direction: 'up'}, { type: 'move', direction: 'right'}] }, { type: 'move', direction: 'down'}, { type: 'while', condition: {color:'green'}, commands:[{ type: 'move', direction: 'down'}] }, { type: 'move', direction: 'right'}, { type: 'while', condition: {color:'blue'}, commands:[{ type: 'move', direction: 'right'}] }, { type: 'loop', count:2, commands: [ { type: 'call', name: 'snake' } ] } ]},
                    { level: 46, startPos: { x: 9, y: 9 }, tiles: { green: [{x:8,y:9},{x:7,y:9},{x:6,y:9}], blue: [{x:6,y:8},{x:6,y:7},{x:6,y:6}] }, commands: [ { type: 'move', direction: "left"}, { type: 'while', condition: {color:'green'}, commands: [{ type: 'move', direction: "left"}] }, { type: 'move', direction: "up"}, { type: 'while', condition: {color:'blue'}, commands: [{ type: 'move', direction: "up"}] } ]},
                    { level: 47, startPos: { x: 0, y: 5 }, hasNested: true, hasElse: true, tiles: { green: [{x:1,y:5},{x:3,y:5},{x:5,y:5}], blue: [{x:5,y:4}] }, commands: [ { type: 'loop', count: 3, commands: [ { type: 'move', direction: "right"}, { type: 'move', direction: "right"}, { type: 'if', condition: {color:'green'}, commands:[{ type: 'move', direction: 'up'}], elseCommands:[{ type: 'move', direction: 'down'}] }] } ]},
                    { level: 48, startPos: { x: 4, y: 0 }, hasFunctions: true, hasNested: true, tiles: { green: [{x:4,y:1},{x:4,y:2}], blue: [{x:5,y:2},{x:6,y:2}] }, commands: [ { type: 'def', name: 'walk', commands:[{ type: 'move', direction: 'down'}, { type: 'move', direction: 'down'}] }, { type: 'def', name: 'turn', commands:[{ type: 'move', direction: 'right'}, { type: 'move', direction: 'right'}] }, { type: 'call', name: 'walk' }, { type: 'call', name: 'turn' }, { type: 'call', name: 'walk' }] },
                    { level: 49, startPos: { x: 1, y: 8 }, hasElse: true, hasNested: true, tiles: { blue: [{x:1,y:7},{x:1,y:5},{x:1,y:3}], green: [{x:2,y:3},{x:3,y:3},{x:4,y:3}] }, commands: [ { type: 'loop', count:3, commands:[ { type: 'move', direction: "up"}, { type: 'move', direction: "up"}, { type: 'if', condition: {color: 'blue'}, commands:[{ type: 'move', direction: 'right'}], elseCommands:[{ type: 'move', direction: 'left'}]} ]}, { type: 'move', direction: "right"}, { type: 'while', condition: {color:'green'}, commands:[{ type: 'move', direction: 'right'}]} ]},
                    { level: 50, startPos: { x: 9, y: 5 }, hasFunctions: true, hasNested: true, hasElse: true, tiles: { blue: [{x:8,y:5},{x:6,y:5},{x:4,y:5}], green: [{x:4,y:4},{x:4,y:3}] }, commands: [ { type: 'def', name: 'step_and_check', commands:[{ type: 'move', direction: 'left'}, { type: 'move', direction: 'left'}, { type: 'if', condition: {color:'blue'}, commands:[{ type: 'move', direction: 'up'}], elseCommands:[{ type: 'move', direction: 'down'}]}] }, { type: 'loop', count:3, commands: [ { type: 'call', name: 'step_and_check' }] } ]},
                    { level: 51, startPos: { x: 5, y: 1 }, hasNested: true, tiles: { green: [{x:5,y:2},{x:5,y:3},{x:6,y:3},{x:7,y:3},{x:7,y:2},{x:7,y:1}] }, commands: [ { type: 'move', direction: "down"}, { type: 'move', direction: "down"}, { type: 'while', condition: {color:'green'}, commands:[{ type: 'move', direction: 'right'}, { type: 'move', direction: 'up'}, { type: 'move', direction: 'left'}, { type: 'move', direction: 'down'}] } ]},
                    { level: 52, startPos: { x: 2, y: 8 }, hasFunctions: true, hasNested: true, tiles: { blue: [{x:2,y:7},{x:3,y:7},{x:4,y:7}], green: [{x:4,y:6},{x:4,y:5},{x:4,y:4}] }, commands: [ { type: 'def', name: 'traverse', commands: [ { type: 'while', condition: {color:'blue'}, commands:[{ type: 'move', direction: 'right'}]}, { type: 'move', direction: 'up'}, { type: 'while', condition: {color:'green'}, commands:[{ type: 'move', direction: 'up'}]}] }, { type: 'move', direction: 'up'}, { type: 'call', name: 'traverse' } ] },
                    { level: 53, startPos: { x: 0, y: 9 }, hasNested: true, hasElse: true, tiles: { green: [{x:1,y:9},{x:2,y:8},{x:3,y:7},{x:4,y:6}], blue: [{x:0,y:8},{x:1,y:7},{x:2,y:6}] }, commands: [ { type: 'loop', count: 4, commands: [ { type: 'if', condition: {color:'blue'}, commands:[{ type: 'move', direction: 'up'}], elseCommands:[{ type: 'move', direction: 'right'}]}, { type: 'if', condition: {color:'green'}, commands:[{ type: 'move', direction: 'up'}], elseCommands:[{ type: 'move', direction: 'right'}]} ] } ] },
                    { level: 54, startPos: { x: 8, y: 0 }, hasFunctions: true, tiles: { green: [{x:8,y:1},{x:7,y:1},{x:6,y:1}], blue: [{x:6,y:2},{x:6,y:3}] }, commands: [ { type: 'def', name: 'descend', commands: [{ type: 'move', direction: 'down'}, { type: 'move', direction: 'left'}] }, { type: 'move', direction: 'down'}, { type: 'call', name: 'descend' }, { type: 'call', name: 'descend' }, { type: 'move', direction: 'down'}, { type: 'while', condition:{color:'blue'}, commands:[{ type: 'move', direction: 'down'}]} ] },
                    { level: 55, startPos: { x: 1, y: 1 }, hasNested: true, tiles: { blue: [{x:1,y:1},{x:2,y:2},{x:3,y:3},{x:4,y:4}], green: [{x:2,y:1},{x:3,y:2},{x:4,y:3}] }, commands: [ { type: 'loop', count: 4, commands: [ { type: 'if', condition:{color:'blue'}, commands:[{ type: 'move', direction: 'right'}]}, { type: 'if', condition:{color:'green'}, commands:[{ type: 'move', direction: 'down'}]} ]} ]},
                    { level: 56, startPos: { x: 3, y: 6 }, hasFunctions: true, hasNested: true, tiles: { green: [{x:3,y:5},{x:4,y:5},{x:5,y:5}], blue: [{x:5,y:4},{x:5,y:3},{x:5,y:2}] }, commands: [ { type: 'def', name: 'go', commands: [ { type: 'while', condition: {color:'green'}, commands:[{ type: 'move', direction: 'right'}]}, { type: 'move', direction: 'up'}, { type: 'while', condition: {color:'blue'}, commands:[{ type: 'move', direction: 'up'}]}] }, { type: 'move', direction: 'up'}, { type: 'move', direction: 'right'}, { type: 'call', name: 'go' } ]},
                    { level: 57, startPos: { x: 0, y: 0 }, hasFunctions: true, hasElse: true, hasNested: true, tiles: { blue: [{x:1,y:0},{x:2,y:1},{x:3,y:2}], green: [{x:0,y:1},{x:1,y:2},{x:2,y:3}] }, commands: [ { type: 'def', name: 'diagonal', commands: [{ type: 'move', direction: 'right'}, { type: 'move', direction: 'down'}] }, { type: 'move', direction: 'right'}, { type: 'loop', count: 3, commands: [ { type: 'if', condition:{color:'blue'}, commands:[{ type: 'call', name: 'diagonal' }], elseCommands:[{ type: 'move', direction: 'down'}]} ]} ]},
                    { level: 58, startPos: { x: 9, y: 9 }, hasFunctions: true, hasNested: true, tiles: { green: [{x:8,y:9},{x:7,y:9},{x:6,y:9}], blue: [{x:5,y:8},{x:5,y:7}] }, commands: [ { type: 'def', name: 'back_and_forth', commands: [{ type: 'move', direction: 'left'}, { type: 'move', direction: 'right'}] }, { type: 'move', direction: 'left'}, { type: 'while', condition:{color:'green'}, commands:[{ type: 'move', direction: 'left'}]}, { type: 'move', direction: 'up'}, { type: 'while', condition:{color:'blue'}, commands:[{ type: 'call', name: 'back_and_forth' }, { type: 'move', direction: 'up'}] } ]},
                    { level: 59, startPos: { x: 4, y: 5 }, hasFunctions: true, hasNested: true, hasElse: true, tiles: { green: [{x:4,y:5},{x:3,y:5}], blue: [{x:3,y:4},{x:3,y:3}] }, commands: [ { type: 'def', name: 'spiral_out', commands: [{ type: 'move', direction: 'left'}, { type: 'move', direction: 'up'}, { type: 'move', direction: 'right'}, { type: 'move', direction: 'right'}, { type: 'move', direction: 'down'}, { type: 'move', direction: 'down'}] }, { type: 'if', condition:{color:'green'}, commands:[{ type: 'call', name: 'spiral_out' }], elseCommands:[{ type: 'move', direction: 'right'}] } ]},
                    { level: 60, startPos: { x: 0, y: 1 }, hasFunctions: true, hasNested: true, hasElse: true, tiles: { green: [{x:1,y:1},{x:2,y:1},{x:2,y:2},{x:1,y:2}], blue: [{x:4,y:1},{x:5,y:1},{x:5,y:2},{x:4,y:2}] }, commands: [ { type: 'def', name: 'make_square', commands: [{ type: 'move', direction: 'right'}, { type: 'move', direction: 'down'}, { type: 'move', direction: 'left'}, { type: 'move', direction: 'up'}] }, { type: 'call', name: 'make_square' }, { type: 'move', direction: 'right'}, { type: 'move', direction: 'right'}, { type: 'if', condition:{color:'blue'}, commands:[{ type: 'call', name: 'make_square' }], elseCommands:[{ type: 'move', direction: 'down'}] } ]},
                    { level: 61, hasParameters: true, hasFunctions: true, startPos: { x: 1, y: 4 }, commands: [ { type: 'def', name: 'travel', params: ['steps'], commands: [ { type: 'loop', count: { param: 'steps' }, commands: [ {type: 'move', direction: 'right'} ] } ] }, { type: 'call', name: 'travel', args: [4] } ] },
                    { level: 62, hasLogic: true, startPos: { x: 1, y: 4 }, tiles: { blue: [{x:2,y:4}], red: [{x:2,y:4}, {x:4,y:4}], green: [{x:3,y:4}] }, commands: [ { type: 'move', direction: 'right'}, { type: 'if', condition: { and: [{color: 'blue'}, {not: {color: 'red'}}]}, commands: [{ type: 'move', direction: 'up'}]}, { type: 'move', direction: 'right'}, { type: 'if', condition: { and: [{color: 'green'}, {not: {color: 'red'}}]}, commands: [{ type: 'move', direction: 'down'}]} ]},
                    { level: 63, hasLogic: true, startPos: { x: 2, y: 2 }, tiles: { blue: [{x:3,y:2}], green: [{x:5,y:2}] }, commands: [ { type: 'move', direction: 'right'}, { type: 'if', condition: { or: [{color: 'blue'}, {color: 'green'}]}, commands: [{ type: 'move', direction: 'up'}]}, { type: 'move', direction: 'right'}, { type: 'move', direction: 'right'}, { type: 'if', condition: { or: [{color: 'blue'}, {color: 'green'}]}, commands: [{ type: 'move', direction: 'down'}]} ]},
                    { level: 64, hasParameters: true, hasLogic: true, hasNested: true, hasFunctions: true, startPos: { x: 1, y: 1 }, tiles: { blue: [{x:1,y:2},{x:1,y:3},{x:1,y:4}], red: [{x:1,y:4}]}, commands: [ { type: 'def', name: 'move_down_safely', commands: [ { type: 'while', condition: {and: [{color: 'blue'}, {not: {color: 'red'}}]}, commands: [{ type: 'move', direction: 'down'}]} ] }, { type: 'call', name: 'move_down_safely' }, { type: 'move', direction: 'right' }, { type: 'move', direction: 'right' } ]},
                    { level: 65, hasNested: true, hasElse: true, startPos: {x: 4, y: 4}, tiles: { blue: [{x:0, y:0}, {x:0, y:1}, {x:0, y:2}, {x:0, y:3}]}, commands: [ { type: 'loop', count: 4, commands: [ { type: 'loop', count: 4, commands: [{ type: 'if', condition: {color: 'blue'}, commands: [{type: 'move', direction: 'down'}], elseCommands: [{type: 'move', direction: 'up'}]}] }, {type: 'move', direction: 'left'}]}]},
                    { level: 66, hasLogic: true, startPos: {x: 0, y: 3}, tiles: { blue: [{x:1, y:3}, {x:2, y:3}], green: [{x:2, y:2}, {x:2, y:1}], red: [{x:3, y:1}, {x:4, y:1}] }, commands: [ { type: 'while', condition: {color: 'blue'}, commands: [{type: 'move', direction: 'right'}]}, { type: 'while', condition: {color: 'green'}, commands: [{type: 'move', direction: 'up'}]}, { type: 'while', condition: {color: 'red'}, commands: [{type: 'move', direction: 'right'}]} ]},
                    { level: 67, hasLogic: true, hasElse: true, startPos: {x: 0, y: 0}, tiles: { green: [{x:0,y:1},{x:1,y:2},{x:2,y:3},{x:3,y:4}], blue: [{x:1,y:0},{x:2,y:1},{x:3,y:2},{x:4,y:3}]}, commands: [ { type: 'loop', count: 8, commands: [ { type: 'if', condition: {color: 'green'}, commands: [{type: 'move', direction: 'down'}], elseCommands: [{type: 'move', direction: 'right'}]} ]} ]},
                    { level: 68, hasElif: true, startPos: {x:1, y:1}, tiles: { blue: [{x:1,y:2}], green: [{x:2,y:2}]}, commands: [ { type: 'conditional_chain', chain: [ {condition: {color: 'green'}, commands: [{type: 'move', direction: 'right'}]}, {condition: {color: 'blue'}, commands: [{type: 'move', direction: 'down'}]} ], elseCommands: [{type: 'move', direction: 'up'}]} ]},
                    { level: 69, hasElif: true, hasLogic: true, startPos: {x:1,y:8}, tiles: { purple: [{x:8,y:1}], red: [{x:1,y:7},{x:2,y:7},{x:3,y:7}], green: [{x:3,y:6},{x:3,y:5},{x:3,y:4}], blue: [{x:4,y:4},{x:5,y:4},{x:6,y:4},{x:7,y:4}], }, commands: [ {type: 'while', condition: {not: {color: 'purple'}}, commands: [ {type: 'conditional_chain', chain: [ {condition: {color: 'red'}, commands:[{type:'move', direction: 'right'}]}, {condition: {color: 'green'}, commands:[{type:'move', direction: 'up'}]}, {condition: {color: 'blue'}, commands:[{type:'move', direction: 'right'}]} ], elseCommands: [{type:'move', direction: 'up'}] } ] } ]},
                    { level: 70, hasRecursion: true, hasFunctions: true, hasElse: true, startPos: {x: 2, y: 1}, tiles: { green: [{x:2, y:5}], red: [{x:2,y:2},{x:2,y:3},{x:2,y:4},{x:2,y:6}]}, commands: [ {type: 'def', name: 'road', commands: [{type: 'move', direction: 'down'}, {type:'if', condition: {color: 'green'}, commands: [{type: 'call', name: 'bypass'}], elseCommands: [{type: 'call', name: 'road'}]}]}, {type: 'def', name: 'bypass', commands: [{type: 'move', direction: 'left'},{type: 'move', direction: 'down'},{type: 'move', direction: 'down'},{type: 'move', direction: 'right'}]}, {type: 'call', name: 'road'}]},
                    { level: 71, hasFunctions: true, startPos: {x: 3, y: 1}, tiles: {}, commands: [ {type: 'def', name: 'shake', commands: [{type: 'move', direction: 'right'}, {type: 'move', direction: 'left'}, {type: 'move', direction: 'right'}, {type: 'move', direction: 'left'}]}, {type: 'def', name: 'dance', commands: [{type: 'call', name: 'shake'}, {type: 'move', direction: 'right'}]}, {type: 'call', name: 'dance'}, {type: 'call', name: 'dance'}, {type: 'call', name: 'dance'}]},
                    { level: 72, hasFunctions: true, hasElse: true, startPos: {x: 1, y: 1}, tiles: {red: [{x:2, y:1}], yellow:[{x:3,y:1}]}, commands: [ {type: 'def', name:'check', commands: [{type:'if', condition: {color: 'red'}, commands:[{type:'move', direction:'down'}]}, {type:'if', condition: {color: 'yellow'}, commands:[{type:'move', direction:'up'}]}]}, {type: 'loop', count: 3, commands: [ {type:'call', name: 'check'}, {type:'move', direction:'right'} ]}]},
                    { level: 73, hasRecursion: true, hasFunctions: true, startPos: {x:1, y:1}, tiles: {green: [{x:4,y:4}]}, commands: [ {type:'def', name:'climb', commands:[ {type:'if', condition:{not:{color:'green'}}, commands:[ {type:'move', direction:'right'}, {type:'move', direction:'down'}, {type:'call', name:'climb'} ]} ]}, {type:'call', name:'climb'} ]},
                    { level: 74, hasFunctions: true, hasElif: true, hasNested: true, startPos: {x:1,y:1}, tiles: {red:[{x:2,y:1}], blue:[{x:3,y:2}], green:[{x:4,y:1}]}, commands: [{type:'def', name:'path_a', commands:[{type:'move', direction:'down'}]}, {type:'def', name:'path_b', commands:[{type:'move', direction:'up'}]}, {type:'loop', count:4, commands:[{type:'move',direction:'right'}, {type:'conditional_chain', chain: [ {condition:{color:'red'}, commands:[{type:'call', name:'path_a'}]}, {condition:{color:'blue'}, commands:[{type:'call', name:'path_b'}]} ]}]}]},
                    { level: 75, hasFunctions: true, hasParameters: true, hasRecursion: true, startPos: {x:4,y:4}, tiles:{red:[{x:6,y:2}]}, commands: [{type:'def', name:'spiral', params:['steps'], commands:[{type:'if', condition:{not: {color:'red'}}, commands:[ {type:'loop', count:{param:'steps'}, commands:[{type:'move',direction:'right'}]}, {type:'loop', count:{param:'steps'}, commands:[{type:'move',direction:'up'}]}, {type:'call', name:'spiral', args:[{param:'steps', op:'+', val:1}]} ] }] }, {type:'call', name:'spiral', args:[1]}]},
                    { level: 76, hasFunctions: true, hasNested: true, startPos: {x:1,y:1}, tiles:{}, commands: [{type:'def', name:'ping', commands:[{type:'move', direction:'right'},{type:'move', direction:'right'}]}, {type:'def', name:'pong', commands:[{type:'move', direction:'down'},{type:'move', direction:'down'}]}, {type:'loop', count:2, commands:[{type:'call',name:'ping'},{type:'call',name:'pong'}]}]},
                    { level: 77, hasParameters: true, hasRecursion: true, hasFunctions: true, startPos: {x:1,y:1}, tiles:{red:[{x:1,y:8}]}, commands: [{type:'def', name:'descend', params:['count'], commands:[{type:'if', condition:{param: 'count', op: '>', val: 0}, commands:[{type:'move',direction:'down'},{type:'call',name:'descend',args:[{param:'count', op: '-', val: 1}]}]}]}, {type:'call', name:'descend', args:[7]}]},
                ],

                state: { 
                    level: 1, attempts: 1, structuredCommands: [], flatCommands: [], currentStep: 0, 
                    spritePos: { x: 0, y: 0 }, initialSpritePos: { x: 0, y: 0 }, 
                    gridSize: 10, gridCellSize: 50, isInputBlocked: false, 
                    tiles: {}, functions: {}, consecutiveSkips: 0,
                    soundEnabled: true
                },

                elements: {
                    gridContainer: document.querySelector('.grid-container'),
                    sprite: document.querySelector('.sprite'),
                    codeBlock: document.querySelector('.code-block'),
                    resetBtn: document.querySelector('#reset-btn'),
                    skipBtn: document.querySelector('.skip-btn'),
                    badgesBtn: document.querySelector('#badges-btn'),
                    levelTitle: document.querySelector('.level-title'),
                    attemptsCounter: document.querySelector('.attempts-counter'),
                    badgeOverlay: document.querySelector('#badge-overlay'),
                    badgeGrid: document.querySelector('.badge-grid'),
                    badgeCloseBtn: document.querySelector('#badge-close-btn'),
                    badgeNotification: document.querySelector('.badge-notification'),
                    confirmOverlay: document.querySelector('#confirm-overlay'),
                    confirmOkBtn: document.querySelector('#confirm-ok-btn'),
                    confirmCancelBtn: document.querySelector('#confirm-cancel-btn'),
                    levelSelect: document.querySelector('#level-select'),
                    xpContainer: document.querySelector('.xp-container'),
                    playerLevel: document.querySelector('.player-level'),
                    xpBarFill: document.querySelector('.xp-bar-fill'),
                    xpText: document.querySelector('.xp-text'),
                    gamePanel: document.querySelector('.game-panel'),
                    settingsBtn: document.querySelector('#settings-btn'),
                    settingsOverlay: document.querySelector('#settings-overlay'),
                    settingsCloseBtn: document.querySelector('#settings-close-btn'),
                    soundToggle: document.querySelector('#sound-toggle'),
                    touchUp: document.querySelector('#arrow-up'),
                    touchDown: document.querySelector('#arrow-down'),
                    touchLeft: document.querySelector('#arrow-left'),
                    touchRight: document.querySelector('#arrow-right'),
                    feedbackBtn: document.querySelector('#feedback-btn'),
                    feedbackOverlay: document.querySelector('#feedback-overlay'),
                    feedbackCancelBtn: document.querySelector('#feedback-cancel-btn'),
                    feedbackSendBtn: document.querySelector('#feedback-send-btn'),
                    feedbackTextarea: document.querySelector('#feedback-textarea'),
                },
                
                sounds: {},

                init() {
                    document.getElementById('start-overlay').addEventListener('click', () => {
                        this.setupAudio();
                        document.getElementById('start-overlay').style.display = 'none';
                        document.querySelector('.game-container').style.visibility = 'visible';
                        this.populateLevelSelect();
                        this.loadSettings();
                        this.setupEventListeners();
                        this.buildGrid();
                        this.stats.load.call(this.stats);
                        this.updateXpUi();
                        const savedLevel = parseInt(localStorage.getItem('pythonPathLevel'), 10);
                        this.loadLevel(savedLevel || 1);
                        console.log(`Python Path Game Initialized. Starting at Level ${this.state.level}.`);
                    }, { once: true });
                },

                loadSettings() {
                    const soundEnabled = localStorage.getItem('pythonPath_soundEnabled');
                    this.state.soundEnabled = soundEnabled === null ? true : (soundEnabled === 'true');
                    this.elements.soundToggle.checked = this.state.soundEnabled;
                },

                setupAudio() {
                    this.sounds.correct = new Tone.Synth({ oscillator: { type: "sine" }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 1 } }).toDestination();
                    this.sounds.incorrect = new Tone.Synth({ oscillator: { type: "square" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.2 } }).toDestination();
                    this.sounds.levelComplete = new Tone.PolySynth(Tone.Synth, { oscillator: { type: "triangle" } }).toDestination();
                    this.sounds.levelUp = new Tone.PolySynth(Tone.Synth, { oscillator: { type: "sawtooth" } }).toDestination();
                    this.sounds.badgeUnlock = new Tone.PolySynth(Tone.Synth, { oscillator: { type: "fmsquare" } }).toDestination();
                },

                playSound(sound) {
                    if (!this.state.soundEnabled) return;
                    if (Tone.context.state !== 'running') Tone.context.resume();
                    switch(sound) {
                        case 'correct': this.sounds.correct.triggerAttackRelease("C5", "8n"); break;
                        case 'incorrect': this.sounds.incorrect.triggerAttackRelease("F#3", "8n"); break;
                        case 'levelComplete': this.sounds.levelComplete.triggerAttackRelease(["C4", "E4", "G4", "C5"], "8n"); break;
                        case 'levelUp': this.sounds.levelUp.triggerAttackRelease(["C4", "G4", "C5", "E5", "G5"], "4n"); break;
                        case 'badgeUnlock': this.sounds.badgeUnlock.triggerAttackRelease(["A4", "C5", "E5"], "8n"); break;
                    }
                },
                
                populateLevelSelect() {
                    this.elements.levelSelect.innerHTML = '';
                    this.levelData.forEach(level => {
                        const option = document.createElement('option');
                        option.value = level.level;
                        option.textContent = level.level;
                        this.elements.levelSelect.appendChild(option);
                    });
                },

                loadLevel(levelNumber) {
                    const level = this.levelData.find(l => l.level === levelNumber);
                    if (!level) {
                        this.showConfirmation( "Congratulations! You've completed all available levels! Click OK to restart from Level 1.", () => { this.stats.clearAll.call(this.stats); this.loadLevel(1); }, true);
                        return;
                    }
                    const state = this.state;
                    state.level = level.level;
                    state.structuredCommands = level.commands;
                    state.initialSpritePos = { ...level.startPos };
                    state.tiles = level.tiles || {};
                    state.functions = {}; 
                    state.hasNested = level.hasNested || false; 
                    state.hasElse = level.hasElse || false; 
                    state.hasFunctions = level.hasFunctions || false;
                    state.hasParameters = level.hasParameters || false;
                    state.hasLogic = level.hasLogic || false;
                    state.hasElif = level.hasElif || false;
                    state.hasRecursion = level.hasRecursion || false; // NEW
                    localStorage.setItem('pythonPathLevel', state.level);
                    this.elements.levelSelect.value = state.level;
                    this.parseCommands();
                    this.resetLevel(true);
                },
                
                parseCommands() {
                    this.state.flatCommands = [];
                    this.state.functions = {};
                    const topLevelCommands = this.state.structuredCommands;
                    for (const cmd of topLevelCommands) {
                        if (cmd.type === 'def') this.state.functions[cmd.name] = cmd;
                    }
                    this.state.flatCommands = this.getUnrolled(topLevelCommands, {});
                },

                getUnrolled(commandsToUnroll, scope) {
                    const unrolledCmds = [];
                    const unrollRecursive = (commands, currentScope) => {
                        if (!commands) return;
                        for (let cmd of commands) {
                            if (cmd.type === 'move') {
                                // Resolve parameter for direction if it exists
                                let direction = cmd.direction;
                                if (typeof direction === 'object' && direction.param) {
                                    direction = currentScope[direction.param] || 'right'; // Default if param not found
                                }
                                unrolledCmds.push({type: 'move', direction: direction});
                            } else if (cmd.type === 'loop') {
                                let loopCount = cmd.count;
                                if (typeof loopCount === 'object' && loopCount.param) {
                                    loopCount = currentScope[loopCount.param] || 0;
                                }
                                for(let i=0; i < loopCount; i++) {
                                    unrollRecursive(cmd.commands, currentScope);
                                }
                            } else if (cmd.type === 'call') {
                                const funcDef = this.state.functions[cmd.name];
                                if (funcDef) {
                                    const newScope = {};
                                    if (funcDef.params && cmd.args) {
                                        funcDef.params.forEach((paramName, index) => {
                                            let argValue = cmd.args[index];
                                            if (typeof argValue === 'object' && argValue.param) {
                                                 let baseValue = currentScope[argValue.param] || 0;
                                                if (argValue.op === '+') { newScope[paramName] = baseValue + argValue.val; } 
                                                else if (argValue.op === '-') { newScope[paramName] = baseValue - argValue.val; } 
                                                else { newScope[paramName] = baseValue; }
                                            } else {
                                                newScope[paramName] = argValue;
                                            }
                                        });
                                    }
                                    unrollRecursive(funcDef.commands, newScope);
                                }
                            } else if (cmd.type === 'if' || cmd.type === 'while' || cmd.type === 'conditional_chain') {
                                unrolledCmds.push({ ...cmd, scope: currentScope });
                            }
                        }
                    };
                    unrollRecursive(commandsToUnroll, scope);
                    return unrolledCmds;
                },

                handleResize() {
                    const state = this.state;
                    const elems = this.elements;
                    state.gridCellSize = elems.gridContainer.offsetWidth / state.gridSize;
                    const spriteSize = state.gridCellSize * 0.75;
                    elems.sprite.style.width = `${spriteSize}px`;
                    elems.sprite.style.height = `${spriteSize}px`;
                    this.updateSpritePosition();
                },

                buildGrid() {
                    const elems = this.elements;
                    const state = this.state;
                    const fragment = document.createDocumentFragment();
                    elems.gridContainer.innerHTML = ''; 
                    for (let y = 0; y < state.gridSize; y++) {
                        for (let x = 0; x < state.gridSize; x++) {
                            const cell = document.createElement('div');
                            cell.className = 'grid-cell';
                            cell.id = `cell-${x}-${y}`;
                            fragment.appendChild(cell);
                        }
                    }
                    elems.gridContainer.appendChild(fragment);
                    elems.gridContainer.appendChild(elems.sprite);
                },
                
                renderTiles() {
                    document.querySelectorAll('.grid-cell').forEach(c => c.className = 'grid-cell');
                    for (const color in this.state.tiles) {
                        this.state.tiles[color].forEach(pos => {
                            const cell = document.getElementById(`cell-${pos.x}-${pos.y}`);
                            if (cell) cell.classList.add(color);
                        });
                    }
                },
                
                displayCommands() {
                    const buildConditionHtml = (condition) => {
                        if (!condition) return 'True';
                        if (condition.color) return `on_colour(<span class="code-string">'${condition.color}'</span>)`;
                        if (condition.not) return `<span class="code-operator">not</span> ${buildConditionHtml(condition.not)}`;
                        if (condition.and) return `(${condition.and.map(buildConditionHtml).join(' <span class="code-operator">and</span> ')})`;
                        if (condition.or) return `(${condition.or.map(buildConditionHtml).join(' <span class="code-operator">or</span> ')})`;
                        if (condition.param) return `${condition.param} ${condition.op} ${condition.val}`;
                        return '';
                    };
                    let html = '';
                    const buildHtml = (commands, indentLevel) => {
                        for (const cmd of commands) {
                            const indentStyle = `padding-left: ${indentLevel * 2}em;`;
                            if (cmd.type === 'move') {
                                let directionText = `'${cmd.direction}'`;
                                if (typeof cmd.direction === 'object' && cmd.direction.param) {
                                    directionText = cmd.direction.param;
                                }
                                html += `<div style="${indentStyle}"><span class="code-function">move</span>(<span class="code-string">${directionText}</span>)</div>`;
                            } else if (cmd.type === 'def') {
                                const params = cmd.params ? cmd.params.join(', ') : '';
                                html += `<div style="${indentStyle}"><span class="code-def">def</span> <span class="code-def-name">${cmd.name}</span>(${params}):</div>`;
                                buildHtml(cmd.commands, indentLevel + 1);
                                html += `<div>&nbsp;</div>`;
                            } else if (cmd.type === 'call') {
                                const args = cmd.args ? cmd.args.map(arg => {
                                    if (typeof arg === 'object' && arg.param) {
                                        if (arg.op) return `${arg.param} ${arg.op} ${arg.val}`;
                                        return arg.param;
                                    }
                                    return arg;
                                }).join(', ') : '';
                                html += `<div style="${indentStyle}"><span class="code-def-name">${cmd.name}</span>(${args})</div>`;
                            } else if (cmd.type === 'loop') {
                                let countText = cmd.count;
                                if(typeof cmd.count === 'object' && cmd.count.param) countText = cmd.count.param;
                                html += `<div style="${indentStyle}"><span class="code-loop">for</span> <span class="code-variable">i</span> <span class="code-loop">in</span> <span class="code-function">range</span>(<span class="code-number">${countText}</span>):</div>`;
                                buildHtml(cmd.commands, indentLevel + 1);
                            } else if (cmd.type === 'if') { // Legacy if for backward compatibility
                                const conditionHtml = buildConditionHtml(cmd.condition);
                                html += `<div style="${indentStyle}"><span class="code-conditional">if</span> ${conditionHtml}:</div>`;
                                buildHtml(cmd.commands, indentLevel + 1);
                                if(cmd.elseCommands) {
                                    html += `<div style="${indentStyle}"><span class="code-conditional">else</span>:</div>`;
                                    buildHtml(cmd.elseCommands, indentLevel + 1);
                                }
                            } else if (cmd.type === 'conditional_chain') { // New elif structure
                                cmd.chain.forEach((link, index) => {
                                    const keyword = index === 0 ? 'if' : 'elif';
                                    const conditionHtml = buildConditionHtml(link.condition);
                                    html += `<div style="${indentStyle}"><span class="code-conditional">${keyword}</span> ${conditionHtml}:</div>`;
                                    buildHtml(link.commands, indentLevel + 1);
                                });
                                if(cmd.elseCommands) {
                                    html += `<div style="${indentStyle}"><span class="code-conditional">else</span>:</div>`;
                                    buildHtml(cmd.elseCommands, indentLevel + 1);
                                }
                            } else if (cmd.type === 'while') {
                                const conditionHtml = buildConditionHtml(cmd.condition);
                                html += `<div style="${indentStyle}"><span class="code-loop">while</span> ${conditionHtml}:</div>`;
                                buildHtml(cmd.commands, indentLevel + 1);
                            }
                        }
                    };
                    buildHtml(this.state.structuredCommands, 0);
                    this.elements.codeBlock.innerHTML = html;
                },
                
                resetLevel(isHardReset = false) {
                    if (isHardReset) {
                        this.state.attempts = 1;
                        this.stats.increment.call(this.stats, 'totalAttempts');
                    }
                    this.state.currentStep = 0;
                    this.state.spritePos = { ...this.state.initialSpritePos };
                    this.elements.levelTitle.textContent = `Level ${this.state.level}`;
                    this.elements.attemptsCounter.textContent = `Attempt: ${this.state.attempts}`;
                    this.parseCommands(); 
                    this.displayCommands();
                    this.renderTiles();
                    this.handleResize();
                    this.elements.sprite.className = 'sprite';
                    this.advanceState();
                },

                checkCondition(condition, scope = {}) {
                    if (!condition) return false;
                    const {x, y} = this.state.spritePos;
                    if (condition.color) return this.state.tiles[condition.color]?.some(p => p.x === x && p.y === y) || false;
                    if (condition.not) return !this.checkCondition(condition.not, scope);
                    if (condition.and) return condition.and.every(c => this.checkCondition(c, scope));
                    if (condition.or) return condition.or.some(c => this.checkCondition(c, scope));
                    if (condition.param) {
                        const paramValue = scope[condition.param] || 0;
                        switch (condition.op) {
                            case '>': return paramValue > condition.val;
                            case '<': return paramValue < condition.val;
                            case '==': return paramValue == condition.val;
                            default: return false;
                        }
                    }
                    return false;
                },

                advanceState() {
                    this.state.isInputBlocked = false;
                    while (true) {
                        if (this.state.currentStep >= this.state.flatCommands.length) { this.startLevelCompleteSequence(); return; }
                        if (this.state.currentStep > 2000) { console.error("Infinite loop or recursion limit detected."); this.state.isInputBlocked = true; return; }
                        
                        const command = this.state.flatCommands[this.state.currentStep];
                        if (!command) { this.startLevelCompleteSequence(); return; }
                        if (command.type === 'move') return;

                        let commandsToInject = [];
                        let removeCurrentCommand = true;
                        
                        const conditionMet = this.checkCondition(command.condition, command.scope || {});

                        if (command.type === 'conditional_chain') {
                            let linkFound = false;
                            for (const link of command.chain) {
                                if (this.checkCondition(link.condition, command.scope || {})) {
                                    commandsToInject = this.getUnrolled(link.commands, command.scope || {});
                                    linkFound = true;
                                    break;
                                }
                            }
                            if (!linkFound && command.elseCommands) {
                                commandsToInject = this.getUnrolled(command.elseCommands, command.scope || {});
                            }
                        } else if (command.type === 'if') {
                             if (conditionMet) {
                                commandsToInject = this.getUnrolled(command.commands, command.scope || {});
                            } else if (command.elseCommands) {
                                commandsToInject = this.getUnrolled(command.elseCommands, command.scope || {});
                            }
                        } else if (command.type === 'while') {
                            if (conditionMet) {
                                commandsToInject = this.getUnrolled(command.commands, command.scope || {});
                                commandsToInject.push(command); 
                            }
                        } else {
                            removeCurrentCommand = false;
                            console.warn("Unhandled command type in advanceState, skipping:", command);
                            this.state.currentStep++;
                        }

                        if(removeCurrentCommand) {
                            this.state.flatCommands.splice(this.state.currentStep, 1, ...commandsToInject);
                        }
                    }
                },

                processInput(direction) {
                    if (this.state.isInputBlocked) return;
                    const command = this.state.flatCommands[this.state.currentStep];
                    if (!command || command.type !== 'move') return;
                    if (direction === command.direction) this.onCorrectMove(direction);
                    else this.onIncorrectMove(direction);
                },
                
                handleKeyPress(e) {
                    const arrowKeys = ["ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight"];
                    if (arrowKeys.includes(e.key)) e.preventDefault();
                    const keyMap = { "ArrowUp": "up", "ArrowDown": "down", "ArrowLeft": "left", "ArrowRight": "right" };
                    const direction = keyMap[e.key];
                    if (direction) this.processInput(direction);
                },

                onCorrectMove(direction) {
                    this.state.isInputBlocked = true;
                    this.playSound('correct');
                    const pos = this.state.spritePos;
                    if (direction === "right") pos.x++;
                    if (direction === "left")  pos.x--;
                    if (direction === "down")  pos.y++;
                    if (direction === "up")    pos.y--;
                    this.state.currentStep++;
                    this.updateSpritePosition();
                    this.advanceState();
                },
                
                onIncorrectMove(playerCommand) {
                    this.state.isInputBlocked = true;
                    this.playSound('incorrect');
                    const sprite = this.elements.sprite;
                    const currentPos = this.state.spritePos;
                    let nextX = currentPos.x, nextY = currentPos.y;
                    if(playerCommand === 'up') nextY--;
                    if(playerCommand === 'down') nextY++;
                    if(playerCommand === 'left') nextX--;
                    if(playerCommand === 'right') nextX++;
                    if(nextX < 0 || nextX >= this.state.gridSize || nextY < 0 || nextY >= this.state.gridSize) {
                        this.stats.increment.call(this.stats, 'wallBumps');
                    } else {
                        this.stats.increment.call(this.stats, 'wrongMoves');
                    }
                    this.checkForBadgeUnlocks();
                    sprite.classList.add('sprite-shake');
                    setTimeout(() => {
                        sprite.classList.remove('sprite-shake');
                        this.state.attempts++;
                        this.resetLevel(false);
                    }, 800);
                },

                updateSpritePosition() {
                    const { spritePos, gridCellSize } = this.state;
                    const { sprite } = this.elements;
                    const spriteSize = gridCellSize * 0.75;
                    const offset = (gridCellSize - spriteSize) / 2;
                    sprite.style.top = `${spritePos.y * gridCellSize + offset}px`;
                    sprite.style.left = `${spritePos.x * gridCellSize + offset}px`;
                },
                
                startLevelCompleteSequence() {
                    this.state.isInputBlocked = true;
                    this.playSound('levelComplete');
                    const hadLeveledUp = this.stats.getPlayerLevel();
                    let xpGained = 0;
                    if (!this.stats.hasCompleted(this.state.level)) {
                        let baseXP = this.state.level * 10;
                        let perfectBonus = (this.state.attempts === 1) ? Math.ceil(baseXP * 0.5) : 0;
                        xpGained = baseXP + perfectBonus;
                        this.stats.addXP(xpGained, this.state.level);
                        this.showXpGain(xpGained, (this.state.attempts === 1));
                    }
                    const hasLeveledUp = this.stats.getPlayerLevel() > hadLeveledUp;
                    if (hasLeveledUp) {
                        this.showLevelUp(this.stats.getPlayerLevel());
                        this.playSound('levelUp');
                    }
                    this.updateXpUi();
                    if (this.state.attempts === 1) this.stats.increment.call(this.stats, 'perfects');
                    if (this.state.hasParameters) this.unlockBadge('parameter_pro');
                    if (this.state.hasLogic) this.unlockBadge('logic_lord');
                    if (this.state.hasElif) this.unlockBadge('logic_ladder');
                    if (this.state.hasNested) this.unlockBadge('nested_master');
                    if (this.state.hasRecursion) this.unlockBadge('recursive_rythm');
                    if (this.stats.get.call(this.stats, 'first_loop_level') === 0 && this.state.structuredCommands.some(c => c.type === 'loop' || c.type === 'for')) this.stats.set.call(this.stats, 'first_loop_level', this.state.level);
                    if (this.stats.get.call(this.stats, 'first_if_level') === 0 && this.state.structuredCommands.some(c => c.type === 'if' || c.type === 'conditional_chain')) this.stats.set.call(this.stats, 'first_if_level', this.state.level);
                    if (this.stats.get.call(this.stats, 'first_while_level') === 0 && this.state.structuredCommands.some(c => c.type === 'while')) this.stats.set.call(this.stats, 'first_while_level', this.state.level);
                    if (this.state.level === 1) this.unlockBadge('first_step');
                    if (this.state.level === 10) this.unlockBadge('novice_no_more');
                    if (this.state.level === 25) this.unlockBadge('quarter_century');
                    if (this.state.level === 45) this.unlockBadge('python_master');
                    if (this.state.level === this.levelData.length) this.unlockBadge('grandmaster');
                    if (this.state.attempts >= 10) this.unlockBadge('the_determinator');
                    if (this.state.attempts === 1 && this.state.level >= 30) this.unlockBadge('flawless_victory');
                    if (this.state.hasNested) this.unlockBadge('nested_knowledge');
                    if (this.state.hasElse) this.unlockBadge('branching_out');
                    if (this.state.hasFunctions) this.unlockBadge('function_follower');
                    this.checkForBadgeUnlocks();
                    const { sprite, gridContainer } = this.elements;
                    const { spritePos } = this.state;
                    const targetCell = gridContainer.querySelector(`#cell-${spritePos.x}-${spritePos.y}`);
                    sprite.className = 'sprite sprite-celebrate';
                    if (targetCell) targetCell.classList.add('tile-flash');
                    setTimeout(() => {
                        sprite.className = 'sprite';
                        if (targetCell) targetCell.classList.remove('tile-flash');
                        this.loadLevel(this.state.level + 1);
                    }, 1500);
                },

                stats: {
                    data: { xp: 0, completedForXp: {}, totalAttempts: 0, perfects: 0, wrongMoves: 0, wallBumps: 0, first_loop_level: 0, first_if_level: 0, first_while_level: 0, badges: {} },
                    secret: 'pYth0n_p4th_s3cr3t_s4lt',
                    generateSignature() { const dataString = JSON.stringify(this.data); let hash = 0; for (let i = 0; i < dataString.length; i++) { const char = dataString.charCodeAt(i); hash = ((hash << 5) - hash) + char; hash |= 0; } return btoa(hash.toString() + this.secret); },
                    save() { const signature = this.generateSignature(); localStorage.setItem('pythonPath_stats', JSON.stringify(this.data)); localStorage.setItem('pythonPath_signature', signature); },
                    load() { const storedStats = localStorage.getItem('pythonPath_stats'); const storedSignature = localStorage.getItem('pythonPath_signature'); if (storedStats) { try { const parsedData = JSON.parse(storedStats); if (typeof parsedData === 'object' && parsedData !== null) { this.data = parsedData; if (this.generateSignature() !== storedSignature) { console.warn("Data tampering detected! Resetting stats."); this.clearAll(); } } else { this.clearAll(); } } catch (e) { console.error("Failed to parse stats, resetting.", e); this.clearAll(); } } },
                    get(key) { return this.data[key] || 0; },
                    set(key, value) { this.data[key] = value; this.save(); },
                    increment(key) { this.data[key] = (this.data[key] || 0) + 1; this.save(); },
                    getBadges() { return this.data.badges || {}; },
                    setBadges(badges) { this.data.badges = badges; this.save(); },
                    addXP(amount, levelId) { this.data.xp += amount; if(!this.data.completedForXp) this.data.completedForXp = {}; this.data.completedForXp[levelId] = true; this.save(); },
                    hasCompleted(levelId) { return !!(this.data.completedForXp && this.data.completedForXp[levelId]); },
                    getXpForLevel(level) { if (level <= 0) return 0; return 50 * Math.pow(level, 2) + (50 * level); },
                    getPlayerLevel() { let level = 1; if (typeof this.data.xp !== 'number') this.data.xp = 0; while (this.data.xp >= this.getXpForLevel(level)) { level++; } return level; },
                    clearAll() { this.data = { xp: 0, completedForXp: {}, totalAttempts: 0, perfects: 0, wrongMoves: 0, wallBumps: 0, first_loop_level: 0, first_if_level: 0, first_while_level: 0, badges: {} }; this.save(); }
                },

                updateXpUi() { const playerLevel = this.stats.getPlayerLevel(); const currentLevelXp = this.stats.getXpForLevel(playerLevel - 1); const nextLevelXp = this.stats.getXpForLevel(playerLevel); const xpIntoLevel = this.stats.get('xp') - currentLevelXp; const xpForThisLevel = nextLevelXp - currentLevelXp; const percentage = Math.min(100, (xpIntoLevel / xpForThisLevel) * 100); this.elements.playerLevel.textContent = `Player Level ${playerLevel}`; this.elements.xpBarFill.style.width = `${percentage}%`; this.elements.xpText.textContent = `${this.stats.get('xp')} / ${nextLevelXp} XP`; },
                showXpGain(amount, isPerfect) { const popup = document.createElement('div'); popup.className = 'xp-gain-popup'; popup.textContent = `+${amount} XP ${isPerfect ? ' (Perfect!)' : ''}`; this.elements.gamePanel.appendChild(popup); setTimeout(() => { if (popup.parentElement) popup.parentElement.removeChild(popup); }, 1500); },
                showLevelUp(newLevel) { const popup = document.createElement('div'); popup.className = 'level-up-popup'; popup.textContent = `Level Up! Reached Level ${newLevel}!`; this.elements.gamePanel.appendChild(popup); setTimeout(() => { if (popup.parentElement) popup.parentElement.removeChild(popup); }, 2000); },
                
                unlockBadge(badgeId) { const earnedBadges = this.stats.getBadges.call(this.stats); if (earnedBadges[badgeId]) return; const badge = this.badgeData[badgeId]; if (!badge) { console.error(`Attempted to unlock non-existent badge: ${badgeId}`); return; } earnedBadges[badgeId] = true; this.stats.setBadges.call(this.stats, earnedBadges); this.playSound('badgeUnlock'); const notification = this.elements.badgeNotification; notification.innerHTML = `<div class="badge-icon">${badge.icon}</div><div><b>${badge.name}</b><br>${badge.desc}</div>`; notification.classList.add('show'); setTimeout(() => notification.classList.remove('show'), 4000); },
                
                checkForBadgeUnlocks() { if (this.stats.get.call(this.stats, 'first_loop_level') > 0) this.unlockBadge('loop_learner'); if (this.stats.get.call(this.stats, 'first_if_level') > 0) this.unlockBadge('if_initiate'); if (this.stats.get.call(this.stats, 'first_while_level') > 0) this.unlockBadge('while_wizard'); if (this.stats.get.call(this.stats, 'perfects') >= 10) this.unlockBadge('perfect_10'); if (this.stats.get.call(this.stats, 'perfects') >= 15) this.unlockBadge('careful_coder'); if (this.stats.get.call(this.stats, 'totalAttempts') >= 50) this.unlockBadge('persistent'); if (this.stats.get.call(this.stats, 'wrongMoves') >= 100) this.unlockBadge('wrong_way'); if (this.stats.get.call(this.stats, 'wallBumps') >= 25) this.unlockBadge('wall_bumper'); },
                
                renderBadgeModal() { const earnedBadges = this.stats.getBadges.call(this.stats); this.elements.badgeGrid.innerHTML = ''; for (const id in this.badgeData) { const badge = this.badgeData[id]; const isEarned = earnedBadges[id]; const badgeEl = document.createElement('div'); badgeEl.className = `badge ${isEarned ? 'earned' : ''}`; badgeEl.innerHTML = `<div class="badge-icon">${badge.icon}</div><div class="badge-name">${badge.name}</div><div class="badge-desc">${badge.desc}</div>`; this.elements.badgeGrid.appendChild(badgeEl); } },
                showConfirmation(message, onConfirm, isInfoOnly = false) { const { confirmOverlay, confirmOkBtn, confirmCancelBtn } = this.elements; document.getElementById('confirm-text').textContent = message; if (isInfoOnly) { confirmCancelBtn.style.display = 'none'; confirmOkBtn.textContent = 'OK'; } else { confirmCancelBtn.style.display = 'inline-block'; confirmOkBtn.textContent = 'Yes, Reset'; } confirmOverlay.classList.add('visible'); const close = () => confirmOverlay.classList.remove('visible'); this.elements.confirmOkBtn.onclick = () => { close(); onConfirm(); }; this.elements.confirmCancelBtn.onclick = close; },

                setupEventListeners() {
                    window.addEventListener('keydown', this.handleKeyPress.bind(this));
                    window.addEventListener('resize', this.handleResize.bind(this));
                    this.elements.resetBtn.addEventListener('click', () => { this.showConfirmation( "This will erase all of your progress, including completed levels and earned badges. This action cannot be undone.", () => { this.stats.clearAll.call(this.stats); this.updateXpUi(); this.loadLevel(1); } ); });
                    this.elements.skipBtn.addEventListener('click', () => { this.loadLevel(this.state.level + 1); });
                    this.elements.badgesBtn.addEventListener('click', () => { this.renderBadgeModal(); this.elements.badgeOverlay.classList.add('visible'); });
                    this.elements.badgeCloseBtn.addEventListener('click', () => { this.elements.badgeOverlay.classList.remove('visible'); });
                    this.elements.levelSelect.addEventListener('change', (e) => { this.loadLevel(parseInt(e.target.value, 10)); });
                    this.elements.settingsBtn.addEventListener('click', () => { this.elements.settingsOverlay.classList.add('visible'); });
                    this.elements.settingsCloseBtn.addEventListener('click', () => { this.elements.settingsOverlay.classList.remove('visible'); });
                    this.elements.soundToggle.addEventListener('change', (e) => { this.state.soundEnabled = e.target.checked; localStorage.setItem('pythonPath_soundEnabled', this.state.soundEnabled); });
                    this.elements.touchUp.addEventListener('click', () => this.processInput('up'));
                    this.elements.touchDown.addEventListener('click', () => this.processInput('down'));
                    this.elements.touchLeft.addEventListener('click', () => this.processInput('left'));
                    this.elements.touchRight.addEventListener('click', () => this.processInput('right'));
                    
                    // --- NEW: Feedback Event Listeners ---
                    this.elements.feedbackBtn.addEventListener('click', () => {
                        this.elements.feedbackOverlay.classList.add('visible');
                    });
                    this.elements.feedbackCancelBtn.addEventListener('click', () => {
                        this.elements.feedbackOverlay.classList.remove('visible');
                    });
                    this.elements.feedbackSendBtn.addEventListener('click', () => {
                        const userMessage = this.elements.feedbackTextarea.value;
                        if (userMessage.trim() === '') {
                            alert('Please enter a message before sending.');
                            return;
                        }

                        const levelNum = this.state.level;
                        const levelData = this.levelData.find(l => l.level === levelNum);
                        const codeString = JSON.stringify(levelData.commands, null, 2);

                        const subject = `Python Path Feedback (Level ${levelNum})`;
                        const body = `Hi there,\n\nHere is some feedback on Python Path:\n\n---\n${userMessage}\n---\n\n\n---DEBUG INFO---\nLevel: ${levelNum}\nLevel Code:\n${codeString}\n`;
                        
                        const mailtoLink = `mailto:millingtond@mgs.org?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                        
                        window.location.href = mailtoLink;
                        
                        this.elements.feedbackTextarea.value = '';
                        this.elements.feedbackOverlay.classList.remove('visible');
                    });
                }
            };

            game.init();
        });
    </script>
</body>

</html>
