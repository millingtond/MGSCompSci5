<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compiler Optimisation Simulation</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --bg-color: #0f172a; /* Slate 900 */
            --primary-color: #38bdf8; /* Sky 400 */
            --secondary-color: #1e293b; /* Slate 800 */
            --text-color: #e2e8f0; /* Slate 200 */
            --accent-color: #818cf8; /* Indigo 400 */
            --success-color: #4ade80; /* Green 400 */
            --error-color: #f87171; /* Red 400 */
            --border-color: rgba(255, 255, 255, 0.1);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            overflow-x: hidden;
        }

        /* Visual Polish: Glassmorphism Card with Gradient Border */
        .glass-card {
            background: rgba(30, 41, 59, 0.6); /* Slate 800 with opacity */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 1rem;
            position: relative;
            z-index: 1;
            overflow: hidden;
            border: 1px solid transparent;
            background-clip: padding-box;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        .glass-card::before {
            content: '';
            position: absolute;
            top: 0; right: 0; bottom: 0; left: 0;
            z-index: -1;
            margin: -1px;
            border-radius: inherit;
            background: linear-gradient(145deg, var(--primary-color), var(--accent-color));
        }

        /* Visual Polish: Animated Gradient Background */
        .animated-gradient {
            background: linear-gradient(-45deg, #1e3a8a, #38bdf8, #818cf8, #0f172a);
            background-size: 400% 400%;
            animation: gradient-animation 20s ease infinite;
        }

        @keyframes gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* Performance: GPU-accelerated animations */
        .will-change {
            will-change: transform, opacity;
            transform: translateZ(0);
        }

        section {
            transition: opacity 0.5s ease, transform 0.5s ease;
        }
        section.hidden {
            opacity: 0;
            transform: translateY(20px);
            pointer-events: none;
            position: absolute;
            width: 100%;
        }

        /* Code Block Styling */
        pre {
            font-family: 'Roboto Mono', monospace;
            background-color: #020617; /* Slate 950 */
            border-radius: 0.5rem;
            padding: 1.25rem;
            overflow-x: auto;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        
        .code-line {
            transition: all 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
            opacity: 1;
            transform: translateX(0);
        }

        .code-line.highlight {
            background-color: rgba(56, 189, 248, 0.2);
            border-left: 3px solid var(--primary-color);
            padding-left: 0.75rem;
            margin-left: -1rem;
        }
        
        .code-line.fade-out {
            opacity: 0.3;
            text-decoration: line-through;
            transform: translateX(-15px);
        }

        .code-line.new-line {
            background-color: rgba(74, 222, 128, 0.15);
            border-left: 3px solid var(--success-color);
            padding-left: 0.75rem;
            margin-left: -1rem;
        }

        /* Visual Polish: Enhanced Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
            overflow: hidden;
            border: 1px solid;
            cursor: pointer;
        }
        /* CONTRAST FIX: Default button text is now high-contrast */
        .btn-secondary {
            color: var(--text-color);
            border-color: var(--secondary-color);
            background-color: #1e293b80; /* Semi-transparent slate */
        }
        .btn-secondary:hover:not(:disabled) {
             background-color: var(--secondary-color);
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
        .btn-primary {
            background: var(--primary-color);
            color: var(--bg-color);
            border-color: var(--primary-color);
        }
        .btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px 0 rgba(56, 189, 248, 0.3);
        }
        .btn-primary:hover:not(:disabled) {
            background: #7dd3fc; /* Lighter sky */
            border-color: #7dd3fc;
        }

        /* Visual Polish: Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            transform: scale(0.9) translateY(20px);
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .modal.show .modal-content {
            transform: scale(1) translateY(0);
        }

        /* Visual Polish: Quiz Styles */
        .quiz-option {
            border: 2px solid var(--secondary-color);
            transition: all 0.2s ease;
        }
        .quiz-option:hover:not(.selected):not(.correct):not(.incorrect) {
            border-color: var(--primary-color);
            transform: translateX(5px);
            background-color: rgba(56, 189, 248, 0.1);
        }
        .quiz-option.selected {
            background-color: rgba(56, 189, 248, 0.2);
            border-color: var(--primary-color);
        }
        .quiz-option.correct {
            background-color: rgba(74, 222, 128, 0.2);
            border-color: var(--success-color);
        }
        .quiz-option.incorrect {
            background-color: rgba(248, 113, 113, 0.2);
            border-color: var(--error-color);
        }

        /* Visual Polish: Drag and Drop */
        .draggable {
            cursor: grab;
            user-select: none;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .draggable:active {
            cursor: grabbing;
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .drop-target {
            border: 2px dashed var(--secondary-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .drop-target.over {
            background-color: rgba(56, 189, 248, 0.1);
            border-color: var(--primary-color);
        }
        .drop-target.filled {
             border-style: solid;
        }
        
        /* Improvement: Progress Bar */
        .progress-bar-container {
            background-color: var(--secondary-color);
            border-radius: 9999px;
            height: 0.75rem;
            overflow: hidden;
        }
        .progress-bar {
            background-color: var(--primary-color);
            height: 100%;
            width: 0;
            border-radius: 9999px;
            transition: width 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        /* Accessibility */
        @media (prefers-reduced-motion: reduce) {
            *, ::before, ::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-200">

    <div id="app" class="min-h-screen p-4 sm:p-6 lg:p-8">
        <header class="text-center p-6 mb-8 rounded-xl animated-gradient">
            <h1 class="text-4xl md:text-5xl font-bold text-white">Compiler Optimisation</h1>
            <p class="text-lg text-gray-200 mt-2">The Fourth Stage of Compilation (Cambridge 9618)</p>
        </header>

        <main id="main-content" class="max-w-7xl mx-auto relative">
            <!-- Introduction Section -->
            <section id="intro" class="glass-card p-8 will-change">
                <h2 class="text-3xl font-bold text-white mb-4">What is Optimisation?</h2>
                <p class="text-lg text-slate-300 leading-relaxed">
                    Optimisation is the process of transforming a program's code to make it more efficient, without changing its output. The goal is to create an object program that runs faster, uses less memory, or consumes less power.
                </p>
                <p class="text-lg text-slate-300 leading-relaxed mt-4">
                    This simulation will walk you through common optimisation techniques using Python examples. Use the "Next" and "Previous" buttons, or your keyboard's left and right arrow keys, to navigate.
                </p>
                <div class="mt-6 text-center">
                    <button id="start-sim-btn" class="btn btn-primary">Start Simulation</button>
                </div>
            </section>

            <!-- Simulation Section -->
            <section id="simulation" class="hidden glass-card p-6 md:p-8 will-change">
                <div class="progress-bar-container mb-6">
                    <div id="sim-progress-bar" class="progress-bar"></div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div id="code-container">
                        <h3 class="text-2xl font-bold mb-4 text-white">Code Transformation (Python)</h3>
                        <div class="flex justify-between items-center mb-2">
                            <span id="code-title" class="text-slate-300 font-semibold">Original Code</span>
                            <!-- CONTRAST FIX: Changed color from blue to a more readable slate gray -->
                            <button id="reset-sim-btn" class="text-sm text-slate-300 hover:text-slate-100 transition">Reset Simulation</button>
                        </div>
                        <pre><code id="code-block" class="language-python"></code></pre>
                    </div>
                    <div id="explanation-container" class="flex flex-col justify-center">
                        <h3 id="explanation-title" class="text-2xl font-bold mb-4 text-white"></h3>
                        <div id="explanation-text" class="text-lg text-slate-300 leading-relaxed space-y-4"></div>
                    </div>
                </div>
                <div class="mt-8 flex justify-between items-center">
                    <!-- CONTRAST FIX: Applied high-contrast secondary button style -->
                    <button id="prev-step-btn" class="btn btn-secondary">Previous</button>
                    <!-- CONTRAST FIX: Improved contrast for step counter text -->
                    <span id="step-counter" class="text-slate-200 font-mono">Step 0 / 0</span>
                    <button id="next-step-btn" class="btn btn-primary">Next</button>
                </div>
            </section>

            <!-- Quiz Section -->
            <section id="quiz" class="hidden glass-card p-6 md:p-8 will-change">
                <div class="progress-bar-container mb-6">
                    <div id="quiz-progress-bar" class="progress-bar"></div>
                </div>
                <h2 class="text-3xl font-bold text-white text-center mb-6">Test Your Knowledge</h2>
                <div id="quiz-content">
                    <!-- Quiz questions will be injected here -->
                </div>
                <div id="quiz-feedback" class="mt-6 text-center text-lg font-semibold h-8"></div>
                <div class="mt-6 flex justify-center gap-4">
                    <button id="submit-quiz-btn" class="btn btn-primary">Submit Answer</button>
                    <button id="next-quiz-btn" class="btn btn-primary hidden">Next Question</button>
                </div>
            </section>

            <!-- Results Section -->
            <section id="results" class="hidden glass-card p-8 text-center will-change">
                <h2 class="text-3xl font-bold text-white mb-4">Quiz Complete!</h2>
                <p class="text-xl text-slate-300">You scored <span id="final-score" class="font-bold text-sky-400">0</span> out of <span id="total-questions" class="font-bold text-sky-400">0</span>.</p>
                <div id="results-summary" class="mt-6 text-left max-w-2xl mx-auto space-y-2"></div>
                <div class="mt-8">
                    <button id="restart-quiz-btn" class="btn btn-primary">Try Again</button>
                </div>
            </section>
        </main>
    </div>

    <!-- Modal for Explanations -->
    <div id="info-modal" class="modal">
        <div class="modal-content glass-card max-w-lg w-full p-6 m-4">
            <h3 id="modal-title" class="text-2xl font-bold text-white mb-4"></h3>
            <div id="modal-text" class="text-slate-300 leading-relaxed"></div>
            <div class="mt-6 text-right">
                <button id="modal-close-btn" class="btn btn-primary">Got it!</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM Caching ---
        const mainContent = document.getElementById('main-content');
        const sections = {
            intro: document.getElementById('intro'),
            simulation: document.getElementById('simulation'),
            quiz: document.getElementById('quiz'),
            results: document.getElementById('results'),
        };
        const startSimBtn = document.getElementById('start-sim-btn');
        const codeBlock = document.getElementById('code-block');
        const codeTitle = document.getElementById('code-title');
        const explanationTitle = document.getElementById('explanation-title');
        const explanationText = document.getElementById('explanation-text');
        const prevStepBtn = document.getElementById('prev-step-btn');
        const nextStepBtn = document.getElementById('next-step-btn');
        const stepCounter = document.getElementById('step-counter');
        const resetSimBtn = document.getElementById('reset-sim-btn');
        const quizContent = document.getElementById('quiz-content');
        const submitQuizBtn = document.getElementById('submit-quiz-btn');
        const nextQuizBtn = document.getElementById('next-quiz-btn');
        const quizFeedback = document.getElementById('quiz-feedback');
        const finalScoreEl = document.getElementById('final-score');
        const totalQuestionsEl = document.getElementById('total-questions');
        const restartQuizBtn = document.getElementById('restart-quiz-btn');
        const resultsSummary = document.getElementById('results-summary');
        const simProgressBar = document.getElementById('sim-progress-bar');
        const quizProgressBar = document.getElementById('quiz-progress-bar');

        // Modal elements
        const infoModal = document.getElementById('info-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalText = document.getElementById('modal-text');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        let state = {
            currentStep: 0,
            currentQuizQuestion: 0,
            score: 0,
            userAnswers: [],
            isModalOpen: false,
            activeInput: null,
            currentSection: 'intro'
        };

        // --- Simulation Data (Python) ---
        const initialCode = `
pi = 3.14
radius = 5.0
circumference = 2 * pi * radius
area = pi * radius * radius
useless_variable = 10
if radius > 0:
    print("Positive radius")
`.trim();
        
        const strengthReductionCode = `
# Calculate total size of 10 items
total_size = 0
for i in range(10):
    # Each item's size is its index * 8
    item_size = i * 8
    total_size += item_size
`.trim();

        const simulationSteps = [
            {
                title: "Original Unoptimised Code",
                explanation: "This is our starting Python code. It calculates the circumference and area of a circle. Let's see how a compiler can improve this.",
                code: initialCode,
                action: (code) => code.split('\n').map(line => `<span>${line.replace(/ /g, '&nbsp;')}</span>`).join('\n')
            },
            {
                title: "Technique 1: Constant Folding",
                explanation: "The compiler identifies expressions with only constant values. The expression <strong>2 * 3.14</strong> can be calculated at compile time, saving a multiplication operation every time the program runs.",
                code: initialCode,
                action: (code) => {
                    let lines = code.split('\n');
                    lines[2] = `<span class="highlight">circumference = 2 * pi * radius</span>`;
                    return lines.map(line => line.replace(/ /g, '&nbsp;')).join('\n');
                }
            },
            {
                title: "Applying Constant Folding",
                explanation: "The expression is replaced with its result, <strong>6.28</strong>. This is a simple but effective optimisation.",
                code: initialCode,
                action: (code) => {
                    let lines = code.split('\n');
                    lines[2] = `<span class="new-line">circumference = 6.28 * radius</span>`;
                    return lines.map(line => line.replace(/ /g, '&nbsp;')).join('\n');
                }
            },
            {
                title: "Technique 2: Constant Propagation",
                explanation: "The compiler sees that <strong>radius</strong> is assigned a constant value (5.0) and is never changed. It can substitute this constant value wherever 'radius' is used.",
                code: `
pi = 3.14
radius = 5.0
circumference = 6.28 * radius
area = pi * radius * radius
useless_variable = 10
if radius > 0:
    print("Positive radius")
`.trim(),
                action: (code) => {
                    let lines = code.split('\n');
                    lines[1] = `<span class="highlight">radius = 5.0</span>`;
                    lines[2] = `circumference = 6.28 * <span class="highlight">radius</span>`;
                    lines[3] = `area = pi * <span class="highlight">radius</span> * <span class="highlight">radius</span>`;
                    lines[5] = `if <span class="highlight">radius</span> > 0:`;
                    return lines.map(line => line.replace(/ /g, '&nbsp;')).join('\n');
                }
            },
            {
                title: "Applying Constant Propagation",
                explanation: "The value <strong>5.0</strong> replaces the variable 'radius'. This now makes other expressions constant, enabling more optimisations.",
                code: `
pi = 3.14
radius = 5.0
circumference = 6.28 * radius
area = pi * radius * radius
useless_variable = 10
if radius > 0:
    print("Positive radius")
`.trim(),
                action: (code) => {
                    let lines = code.split('\n');
                    lines[2] = `<span class="new-line">circumference = 6.28 * 5.0</span>`;
                    lines[3] = `<span class="new-line">area = 3.14 * 5.0 * 5.0</span>`;
                    lines[5] = `<span class="new-line">if 5.0 > 0:</span>`;
                    return lines.map(line => line.replace(/ /g, '&nbsp;')).join('\n');
                }
            },
            {
                title: "More Constant Folding",
                explanation: "With the constants propagated, the compiler can now evaluate the new constant expressions at compile time.",
                code: `
pi = 3.14
radius = 5.0
circumference = 6.28 * 5.0
area = 3.14 * 5.0 * 5.0
useless_variable = 10
if 5.0 > 0:
    print("Positive radius")
`.trim(),
                action: (code) => {
                    let lines = code.split('\n');
                    lines[2] = `<span class="new-line">circumference = 31.4</span>`;
                    lines[3] = `<span class="new-line">area = 78.5</span>`;
                    return lines.map(line => line.replace(/ /g, '&nbsp;')).join('\n');
                }
            },
            {
                title: "Technique 3: Dead Code Elimination",
                explanation: "The compiler analyzes how variables are used. It finds that <strong>useless_variable</strong> is assigned a value but is never read or used again. This makes the line 'dead code'.",
                code: `
pi = 3.14
radius = 5.0
circumference = 31.4
area = 78.5
useless_variable = 10
if 5.0 > 0:
    print("Positive radius")
`.trim(),
                action: (code) => {
                    let lines = code.split('\n');
                    lines[4] = `<span class="highlight">useless_variable = 10</span>`;
                    return lines.map(line => line.replace(/ /g, '&nbsp;')).join('\n');
                }
            },
            {
                title: "Applying Dead Code Elimination",
                explanation: "The useless line is removed. The original 'pi' and 'radius' variables are also now dead code, as their values have been fully propagated and are no longer needed.",
                code: `
pi = 3.14
radius = 5.0
circumference = 31.4
area = 78.5
useless_variable = 10
if 5.0 > 0:
    print("Positive radius")
`.trim(),
                action: (code) => {
                    let lines = code.split('\n');
                    lines[0] = `<span class="fade-out">pi = 3.14</span>`;
                    lines[1] = `<span class="fade-out">radius = 5.0</span>`;
                    lines[4] = `<span class="fade-out">useless_variable = 10</span>`;
                    return lines.map(line => line.replace(/ /g, '&nbsp;')).join('\n');
                }
            },
            {
                title: "Control Flow Optimisation",
                explanation: "The condition <strong>if 5.0 > 0:</strong> is always true. A smart compiler can determine this and simplify the code by removing the conditional check, keeping only the code inside the block.",
                code: `
circumference = 31.4
area = 78.5
if 5.0 > 0:
    print("Positive radius")
`.trim(),
                action: (code) => {
                     let lines = code.split('\n');
                    lines[2] = `<span class="highlight">if 5.0 > 0:</span>`;
                    lines[3] = `<span class="highlight">${lines[3]}</span>`;
                    return lines.map(line => line.replace(/ /g, '&nbsp;')).join('\n');
                }
            },
            {
                title: "Intermediate Optimised Code",
                explanation: "This is the optimised code from the first example. Let's look at another common technique.",
                code: `
circumference = 31.4
area = 78.5
print("Positive radius")
`.trim(),
                 action: (code) => code.split('\n').map(line => `<span>${line.replace(/ /g, '&nbsp;')}</span>`).join('\n')
            },
            {
                title: "Technique 4: Strength Reduction",
                explanation: "Consider this loop. Inside, there is a multiplication: <strong>i * 8</strong>. Multiplication is a computationally 'stronger' (i.e., slower) operation than addition or bit-shifting.",
                code: strengthReductionCode,
                action: (code) => {
                    let lines = code.split('\n');
                    lines[3] = `<span class="highlight">${lines[3]}</span>`;
                    lines[4] = `<span class="highlight">${lines[4]}</span>`;
                    return lines.map(line => line.replace(/ /g, '&nbsp;')).join('\n');
                }
            },
            {
                title: "Applying Strength Reduction",
                explanation: "A compiler can replace the multiplication with a 'weaker' (faster) operation. Since 8 is a power of 2 (2^3), multiplying by 8 is the same as a bitwise left shift by 3 positions (<strong>i << 3</strong>). This is much faster for the CPU to execute.",
                code: strengthReductionCode,
                action: (code) => {
                    let lines = code.split('\n');
                    lines[4] = `<span class="fade-out">${lines[4]}</span><br><span class="new-line">&nbsp;&nbsp;&nbsp;&nbsp;item_size = i << 3</span>`;
                    return lines.map(line => line.replace(/ /g, '&nbsp;')).join('\n');
                }
            },
            {
                title: "Ready for the Quiz?",
                explanation: "You have now seen several key optimisation techniques. Let's test your understanding with a few questions.",
                code: `
# Final optimised code for the loop
total_size = 0
for i in range(10):
    item_size = i << 3
    total_size += item_size
`.trim(),
                action: (code) => code.split('\n').map(line => `<span>${line.replace(/ /g, '&nbsp;')}</span>`).join('\n')
            }
        ];

        // --- Quiz Data ---
        const quizQuestions = [
            {
                type: 'mcq',
                question: "What is the primary goal of compiler optimisation?",
                options: [
                    "To add more features to the program.",
                    "To make the source code shorter and easier to read.",
                    "To improve the program's efficiency without changing its output.",
                    "To find and fix bugs in the source code."
                ],
                answer: "To improve the program's efficiency without changing its output."
            },
            {
                type: 'input',
                question: "A compiler replaces the expression `x = 5 * 20` with `x = 100`. What is this optimisation technique called?",
                answer: "Constant Folding"
            },
            {
                type: 'mcq',
                question: "Which of the following best describes Strength Reduction?",
                options: [
                    "Removing code that is never executed.",
                    "Replacing a complex operation with a simpler, equivalent one.",
                    "Calculating constant expressions at compile-time.",
                    "Substituting a variable with its known constant value."
                ],
                answer: "Replacing a complex operation with a simpler, equivalent one."
            },
            {
                type: 'drag-drop',
                question: "Match the optimisation technique to the code transformation.",
                items: {
                    "Constant Propagation": "Replace a variable with its constant value.",
                    "Dead Code Elimination": "Remove a variable that is never used.",
                    "Strength Reduction": "Replace an expensive operation (e.g., `x * 2`) with a cheaper one (e.g., `x << 1`)."
                }
            },
        ];

        // --- Core Functions ---

        const switchSection = (sectionName) => {
            if (state.currentSection === sectionName) return;
            Object.keys(sections).forEach(key => {
                if (!sections[key].classList.contains('hidden')) {
                    sections[key].classList.add('hidden');
                }
            });
            sections[sectionName].classList.remove('hidden');
            state.currentSection = sectionName;
        };
        
        const updateProgressBar = (bar, current, total) => {
            const percentage = total > 0 ? ((current + 1) / total) * 100 : 0;
            bar.style.width = `${percentage}%`;
        };

        const runSimulationStep = (stepIndex) => {
            state.currentStep = stepIndex;
            const step = simulationSteps[stepIndex];
            
            explanationTitle.textContent = step.title;
            explanationText.innerHTML = step.explanation;
            codeTitle.textContent = step.title;
            codeBlock.innerHTML = step.action(step.code);

            stepCounter.textContent = `Step ${stepIndex + 1} / ${simulationSteps.length}`;
            prevStepBtn.disabled = stepIndex === 0;
            nextStepBtn.textContent = stepIndex === simulationSteps.length - 1 ? "Start Quiz" : "Next";
            updateProgressBar(simProgressBar, stepIndex, simulationSteps.length);
            
            if (step.title.includes("Technique") || step.title.includes("Optimisation")) {
                showModal(step.title, step.explanation);
            }
        };

        const loadQuizQuestion = (index) => {
            state.currentQuizQuestion = index;
            quizFeedback.innerHTML = '';
            submitQuizBtn.classList.remove('hidden');
            nextQuizBtn.classList.add('hidden');
            submitQuizBtn.disabled = false;
            updateProgressBar(quizProgressBar, index, quizQuestions.length);

            const q = quizQuestions[index];
            let content = `<div class="mb-4"><h3 class="text-xl font-semibold">${index + 1}. ${q.question}</h3></div>`;

            if (q.type === 'mcq') {
                content += `<div id="options-container" class="space-y-3">
                    ${q.options.map(option => `<div class="quiz-option p-4 rounded-lg cursor-pointer">${option}</div>`).join('')}
                </div>`;
            } else if (q.type === 'input') {
                content += `<input type="text" id="input-answer" class="w-full p-3 bg-slate-700 border-2 border-slate-600 rounded-lg focus:outline-none focus:border-sky-500 transition-colors" placeholder="Type your answer here...">`;
            } else if (q.type === 'drag-drop') {
                const techniques = Object.keys(q.items);
                const descriptions = Object.values(q.items);
                const shuffledDescriptions = [...descriptions].sort(() => Math.random() - 0.5);

                content += `<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-3 p-4 bg-slate-900/50 rounded-lg">
                        <h4 class="font-bold text-lg text-center text-white">Techniques (Drag these)</h4>
                        <div id="draggable-container" class="space-y-2">
                            ${techniques.map(tech => `<div class="draggable p-3 bg-slate-700 rounded-lg text-center will-change" draggable="true">${tech}</div>`).join('')}
                        </div>
                    </div>
                    <div class="space-y-3">
                        <h4 class="font-bold text-lg text-center text-white">Descriptions</h4>
                        ${shuffledDescriptions.map(desc => `
                            <div class="flex items-center gap-4">
                                <div class="drop-target flex-grow p-3 rounded-lg will-change" data-desc="${desc}"></div>
                                <p class="text-slate-300">${desc}</p>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
            }
            quizContent.innerHTML = content;
            addQuizListeners();
        };

        const checkQuizAnswer = () => {
            const q = quizQuestions[state.currentQuizQuestion];
            let isCorrect = false;
            let userAnswer;
            
            const inputAnswer = document.getElementById('input-answer');
            if (q.type === 'input' && inputAnswer && inputAnswer.value.length < 3) {
                 quizFeedback.textContent = "Please provide a more detailed answer.";
                 quizFeedback.style.color = 'var(--error-color)';
                 return;
            }

            if (q.type === 'mcq') {
                const selected = quizContent.querySelector('.quiz-option.selected');
                if (!selected) {
                    quizFeedback.textContent = "Please select an answer.";
                    quizFeedback.style.color = 'var(--error-color)';
                    return;
                }
                userAnswer = selected.textContent;
                isCorrect = userAnswer === q.answer;
                selected.classList.add(isCorrect ? 'correct' : 'incorrect');
                if (!isCorrect) {
                    quizContent.querySelectorAll('.quiz-option').forEach(opt => {
                        if (opt.textContent === q.answer) opt.classList.add('correct');
                    });
                }
            } else if (q.type === 'input') {
                userAnswer = inputAnswer.value.trim();
                isCorrect = userAnswer.toLowerCase().replace(/\s/g, '') === q.answer.toLowerCase().replace(/\s/g, '');
                inputAnswer.classList.add(isCorrect ? 'border-green-500' : 'border-red-500');
                inputAnswer.disabled = true;
                if (!isCorrect) {
                     quizFeedback.innerHTML = `Correct answer: <strong class="text-green-400">${q.answer}</strong>`;
                }
            } else if (q.type === 'drag-drop') {
                const dropTargets = document.querySelectorAll('.drop-target');
                if (Array.from(dropTargets).some(t => !t.querySelector('.draggable'))) {
                    quizFeedback.textContent = "Please match all techniques to a description.";
                    quizFeedback.style.color = 'var(--error-color)';
                    return;
                }
                let correctMatches = 0;
                dropTargets.forEach(target => {
                    const droppedTech = target.querySelector('.draggable');
                    const desc = target.dataset.desc;
                    if (droppedTech && q.items[droppedTech.textContent] === desc) {
                        correctMatches++;
                        target.classList.add('correct');
                    } else {
                        target.classList.add('incorrect');
                    }
                    if (droppedTech) droppedTech.setAttribute('draggable', false);
                });
                isCorrect = correctMatches === Object.keys(q.items).length;
                userAnswer = 'Drag and drop activity';
            }

            if (isCorrect) {
                state.score++;
                quizFeedback.textContent = "Correct!";
                quizFeedback.style.color = 'var(--success-color)';
            } else if (q.type !== 'input') {
                quizFeedback.textContent = "Incorrect.";
                quizFeedback.style.color = 'var(--error-color)';
            }
            
            state.userAnswers[state.currentQuizQuestion] = { question: q.question, answer: userAnswer, correct: isCorrect, correctAnswer: q.answer || q.items, type: q.type };

            submitQuizBtn.classList.add('hidden');
            nextQuizBtn.classList.remove('hidden');
        };

        const showResults = () => {
            switchSection('results');
            finalScoreEl.textContent = state.score;
            totalQuestionsEl.textContent = quizQuestions.length;
            
            resultsSummary.innerHTML = state.userAnswers.map((ans, index) => {
                let correctAnswerHtml = '';
                if (!ans.correct) {
                    correctAnswerHtml = ans.type === 'drag-drop' 
                        ? '<p class="text-sm text-slate-300">Correct matches were not all made.</p>'
                        : `<p class="text-sm text-slate-300">Correct answer: ${ans.correctAnswer}</p>`;
                }
                return `<div class="p-4 rounded-lg ${ans.correct ? 'bg-green-500/10' : 'bg-red-500/10'}">
                            <p class="font-semibold">${index + 1}. ${ans.question}</p>
                            <p class="text-sm ${ans.correct ? 'text-green-400' : 'text-red-400'}">
                                Your answer: ${ans.answer} ${ans.correct ? '✔' : '❌'}
                            </p>
                            ${correctAnswerHtml}
                        </div>`;
            }).join('');
        };

        const showModal = (title, text) => {
            state.isModalOpen = true;
            modalTitle.textContent = title;
            modalText.innerHTML = text;
            infoModal.classList.add('show');
        };
        
        // --- Event Handlers ---
        
        const handleNav = (direction) => {
            if (state.isModalOpen) return;
            const next = state.currentStep + direction;
            if (next >= 0 && next < simulationSteps.length) {
                runSimulationStep(next);
            } else if (direction > 0 && next === simulationSteps.length) {
                switchSection('quiz');
                loadQuizQuestion(0);
            }
        };
        
        const handleNextQuestion = () => {
            const next = state.currentQuizQuestion + 1;
            if (next < quizQuestions.length) {
                loadQuizQuestion(next);
            } else {
                showResults();
            }
        };

        const resetSimulation = () => {
            runSimulationStep(0);
        };
        
        const restartApp = () => {
            state = { ...state, currentStep: 0, currentQuizQuestion: 0, score: 0, userAnswers: [] };
            switchSection('intro');
        };

        // --- Event Listeners Setup ---

        startSimBtn.addEventListener('click', () => {
            switchSection('simulation');
            runSimulationStep(0);
        });
        resetSimBtn.addEventListener('click', resetSimulation);
        nextStepBtn.addEventListener('click', () => handleNav(1));
        prevStepBtn.addEventListener('click', () => handleNav(-1));
        
        submitQuizBtn.addEventListener('click', checkQuizAnswer);
        nextQuizBtn.addEventListener('click', handleNextQuestion);
        restartQuizBtn.addEventListener('click', restartApp);

        modalCloseBtn.addEventListener('click', () => {
            infoModal.classList.remove('show');
            state.isModalOpen = false;
        });

        document.addEventListener('keydown', (e) => {
            if (state.isModalOpen) {
                if(e.key === 'Escape' || e.key === 'Enter') modalCloseBtn.click();
                return;
            }
            if (state.activeInput) return;
            if (state.currentSection === 'simulation') {
                if (e.key === 'ArrowRight') nextStepBtn.click();
                if (e.key === 'ArrowLeft') prevStepBtn.click();
            }
        });

        function addQuizListeners() {
            // Event delegation for quiz options
            const optionsContainer = document.getElementById('options-container');
            if (optionsContainer) {
                optionsContainer.addEventListener('click', (e) => {
                    if (e.target.classList.contains('quiz-option')) {
                        optionsContainer.querySelectorAll('.quiz-option').forEach(o => o.classList.remove('selected'));
                        e.target.classList.add('selected');
                    }
                });
            }

            const inputField = document.getElementById('input-answer');
            if (inputField) {
                inputField.addEventListener('focus', () => state.activeInput = inputField);
                inputField.addEventListener('blur', () => state.activeInput = null);
            }
            
            const draggableContainer = document.getElementById('draggable-container');
            if(draggableContainer) {
                let draggedItem = null;
                // Use event delegation on a parent element for drag events
                mainContent.addEventListener('dragstart', e => {
                    if (e.target.classList.contains('draggable')) {
                        draggedItem = e.target;
                        setTimeout(() => e.target.style.opacity = '0.5', 0);
                    }
                });
                mainContent.addEventListener('dragend', e => {
                    if (draggedItem) {
                        setTimeout(() => e.target.style.opacity = '1', 0);
                        draggedItem = null;
                    }
                });
                document.querySelectorAll('.drop-target').forEach(target => {
                    target.addEventListener('dragover', e => { e.preventDefault(); target.classList.add('over'); });
                    target.addEventListener('dragleave', () => target.classList.remove('over'));
                    target.addEventListener('drop', e => {
                        e.preventDefault();
                        target.classList.remove('over');
                        if (draggedItem && !target.children.length) {
                             target.appendChild(draggedItem);
                             target.classList.add('filled');
                        }
                    });
                });
            }
        }

        // --- Initialisation ---
        switchSection('intro');
    });
    </script>
</body>
</html>
