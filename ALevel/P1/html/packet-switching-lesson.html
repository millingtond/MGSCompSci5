<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Packet & Circuit Switching - Interactive Lesson</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #1f2937;
            --light: #f3f4f6;
            --white: #ffffff;
            --card-bg: rgba(255, 255, 255, 0.95);
            --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-2: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-3: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--dark);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Header Styles */
        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .header h1 {
            color: var(--white);
            font-size: 1.5rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* XP and Level Display */
        .xp-container {
            display: flex;
            align-items: center;
            gap: 1rem;
            background: rgba(255, 255, 255, 0.2);
            padding: 0.5rem 1rem;
            border-radius: 25px;
            backdrop-filter: blur(5px);
        }

        .level-badge {
            background: var(--gradient-2);
            color: var(--white);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .xp-bar {
            width: 200px;
            height: 20px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .xp-fill {
            height: 100%;
            background: var(--gradient-3);
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .xp-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            animation: shine 2s infinite;
        }

        @keyframes shine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .xp-text {
            color: var(--white);
            font-size: 0.9rem;
            font-weight: 500;
            margin-left: 0.5rem;
        }

        /* Navigation */
        .nav-bar {
            display: flex;
            gap: 0.5rem;
            background: rgba(255, 255, 255, 0.2);
            padding: 0.5rem;
            border-radius: 25px;
            backdrop-filter: blur(5px);
            flex-wrap: wrap;
        }

        .nav-item {
            padding: 0.5rem 1rem;
            background: transparent;
            color: var(--white);
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .nav-item.active {
            background: var(--white);
            color: var(--primary);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* Main Content */
        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 100px 2rem 2rem;
        }

        .section {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Card Styles */
        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-1);
            animation: colorWave 3s ease-in-out infinite;
        }

        @keyframes colorWave {
            0%, 100% { transform: translateX(-100%); }
            50% { transform: translateX(100%); }
        }

        .card h2 {
            color: var(--primary);
            margin-bottom: 1rem;
            font-size: 1.8rem;
        }

        .card h3 {
            color: var(--secondary);
            margin: 1.5rem 0 1rem;
            font-size: 1.3rem;
        }

        /* Button Styles */
        .btn {
            background: var(--gradient-1);
            color: var(--white);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            margin: 0.5rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: var(--gradient-2);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        /* Ripple Effect */
        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.4);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:active::after {
            width: 300px;
            height: 300px;
        }

        /* Quiz Styles */
        .quiz-container {
            margin: 1rem 0;
        }

        .quiz-option {
            display: block;
            width: 100%;
            padding: 1rem;
            margin: 0.5rem 0;
            background: var(--light);
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            position: relative;
            overflow: hidden;
        }

        .quiz-option:hover {
            background: var(--white);
            border-color: var(--primary);
            transform: translateX(5px);
        }

        .quiz-option.selected {
            background: var(--primary);
            color: var(--white);
            border-color: var(--primary);
        }

        .quiz-option.correct {
            background: var(--success);
            color: var(--white);
            border-color: var(--success);
            animation: correctPulse 0.5s ease;
        }

        .quiz-option.incorrect {
            background: var(--danger);
            color: var(--white);
            border-color: var(--danger);
            animation: shake 0.5s ease;
        }

        @keyframes correctPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        /* Fill in the Blanks */
        .fill-blank-container {
            margin: 1rem 0;
            line-height: 2;
        }

        .blank-space {
            display: inline-block;
            min-width: 150px;
            padding: 0.25rem 0.5rem;
            border-bottom: 2px solid var(--primary);
            margin: 0 0.25rem;
            background: var(--light);
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .blank-options {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin: 1rem 0;
            padding: 1rem;
            background: var(--light);
            border-radius: 8px;
        }

        .blank-option {
            padding: 0.5rem 1rem;
            background: var(--white);
            border: 2px solid var(--primary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
        }

        .blank-option:hover {
            background: var(--primary);
            color: var(--white);
            transform: translateY(-2px);
        }

        .blank-option.used {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .blank-space.filled {
            background: var(--primary);
            color: var(--white);
            border-color: var(--primary);
        }

        .blank-space.correct {
            background: var(--success);
            border-color: var(--success);
        }

        .blank-space.incorrect {
            background: var(--danger);
            border-color: var(--danger);
        }

        /* Simulation Styles */
        .simulation-container {
            background: var(--dark);
            border-radius: 12px;
            padding: 2rem;
            margin: 1rem 0;
            position: relative;
            overflow: hidden;
            min-height: 400px;
        }

        .packet {
            position: absolute;
            width: 60px;
            height: 40px;
            background: var(--gradient-3);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-weight: bold;
            font-size: 0.8rem;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            cursor: pointer;
        }

        .packet:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }

        .router {
            position: absolute;
            width: 80px;
            height: 80px;
            background: var(--gradient-2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-weight: bold;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
            z-index: 10;
        }

        .router.active {
            animation: routerPulse 1s infinite;
        }

        @keyframes routerPulse {
            0%, 100% { transform: scale(1); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3); }
            50% { transform: scale(1.1); box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4); }
        }

        .connection-line {
            position: absolute;
            height: 2px;
            background: rgba(255, 255, 255, 0.3);
            transform-origin: left center;
        }

        .sim-controls {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            justify-content: center;
        }

        /* Canvas Styles */
        .canvas-container {
            border: 2px solid var(--primary);
            border-radius: 8px;
            background: var(--white);
            margin: 1rem 0;
            position: relative;
            touch-action: none;
        }

        #drawingCanvas {
            display: block;
            cursor: crosshair;
            touch-action: none;
        }

        .canvas-controls {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        /* Input Styles */
        input[type="text"], input[type="number"], textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--light);
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: var(--white);
        }

        input[type="text"]:focus, input[type="number"]:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* Achievement Popup */
        .achievement-popup {
            position: fixed;
            top: 100px;
            right: 20px;
            background: var(--gradient-3);
            color: var(--white);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            transform: translateX(400px);
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            z-index: 2000;
            max-width: 300px;
        }

        .achievement-popup.show {
            transform: translateX(0);
        }

        .achievement-popup h4 {
            margin-bottom: 0.5rem;
            font-size: 1.2rem;
        }

        .achievement-popup p {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* XP Indicator */
        .xp-indicator {
            position: fixed;
            color: var(--success);
            font-weight: bold;
            font-size: 1.5rem;
            pointer-events: none;
            z-index: 2000;
            animation: floatUp 2s ease-out forwards;
        }

        @keyframes floatUp {
            0% {
                opacity: 1;
                transform: translateY(0);
            }
            100% {
                opacity: 0;
                transform: translateY(-50px);
            }
        }

        /* Particle Effects */
        .particle {
            position: fixed;
            pointer-events: none;
            width: 10px;
            height: 10px;
            background: var(--warning);
            border-radius: 50%;
            z-index: 2000;
        }

        /* Navigation Buttons */
        .nav-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
            gap: 1rem;
        }

        /* Mark Scheme */
        .mark-scheme {
            background: rgba(99, 102, 241, 0.1);
            border: 2px solid var(--primary);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            display: none;
        }

        .mark-scheme.visible {
            display: block;
            animation: slideDown 0.5s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Feedback Button */
        .feedback-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: var(--gradient-2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .feedback-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        /* Feedback Modal */
        .feedback-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .feedback-modal.show {
            opacity: 1;
            visibility: visible;
        }

        .feedback-content {
            background: var(--white);
            padding: 2rem;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .feedback-modal.show .feedback-content {
            transform: scale(1);
        }

        /* Copy Prevention */
        .no-select {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .paste-shame {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--danger);
            color: var(--white);
            padding: 2rem;
            border-radius: 12px;
            z-index: 4000;
            display: none;
            font-size: 1.2rem;
            font-weight: bold;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }

            .nav-bar {
                justify-content: center;
                width: 100%;
            }

            .xp-container {
                width: 100%;
                justify-content: center;
            }

            .card {
                padding: 1.5rem;
            }

            .simulation-container {
                padding: 1rem;
                min-height: 300px;
            }

            .nav-buttons {
                flex-direction: column;
            }

            .quiz-option:hover {
                transform: none;
            }
        }

        /* Accessibility */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation: none !important;
                transition: none !important;
            }
        }

        /* Loading State */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--white);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Hint System */
        .hint-container {
            background: rgba(245, 158, 11, 0.1);
            border: 2px solid var(--warning);
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            display: none;
        }

        .hint-container.show {
            display: block;
            animation: slideDown 0.5s ease;
        }

        .hint-button {
            background: var(--warning);
            color: var(--white);
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            margin: 0.5rem 0;
        }

        /* Progress Indicator */
        .progress-indicator {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            margin: 1rem 0;
        }

        .progress-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }

        .progress-dot.active {
            background: var(--white);
            transform: scale(1.5);
        }

        .progress-dot.completed {
            background: var(--success);
        }

        /* Error States */
        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 2px solid var(--danger);
            color: var(--danger);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            display: none;
        }

        .error-message.show {
            display: block;
            animation: shake 0.5s ease;
        }

        /* Success States */
        .success-message {
            background: rgba(16, 185, 129, 0.1);
            border: 2px solid var(--success);
            color: var(--success);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            display: none;
        }

        .success-message.show {
            display: block;
            animation: correctPulse 0.5s ease;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            background: var(--white);
            border-radius: 8px;
            overflow: hidden;
        }

        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--light);
        }

        th {
            background: var(--primary);
            color: var(--white);
            font-weight: 600;
        }

        tr:hover {
            background: var(--light);
        }

        /* Code Blocks */
        .code-block {
            background: var(--dark);
            color: #e6e6e6;
            padding: 1rem;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
            margin: 1rem 0;
        }

        /* Drag and Drop (Click-based) */
        .matching-container {
            display: flex;
            gap: 2rem;
            margin: 1rem 0;
            flex-wrap: wrap;
        }

        .matching-column {
            flex: 1;
            min-width: 250px;
        }

        .match-item {
            padding: 1rem;
            margin: 0.5rem 0;
            background: var(--light);
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .match-item:hover {
            background: var(--white);
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .match-item.selected {
            background: var(--primary);
            color: var(--white);
            border-color: var(--primary);
        }

        .match-item.matched {
            background: var(--success);
            color: var(--white);
            border-color: var(--success);
            cursor: not-allowed;
        }

        .match-item.incorrect-match {
            background: var(--danger);
            color: var(--white);
            border-color: var(--danger);
            animation: shake 0.5s ease;
        }

        /* Real-world Context */
        .context-box {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            border-left: 4px solid var(--primary);
            padding: 1.5rem;
            margin: 1rem 0;
            border-radius: 0 8px 8px 0;
        }

        .context-box h4 {
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        /* Common Mistakes */
        .mistake-box {
            background: rgba(239, 68, 68, 0.05);
            border-left: 4px solid var(--danger);
            padding: 1.5rem;
            margin: 1rem 0;
            border-radius: 0 8px 8px 0;
        }

        .mistake-box h4 {
            color: var(--danger);
            margin-bottom: 0.5rem;
        }

        /* Extension Activities */
        .extension-box {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(34, 197, 94, 0.1) 100%);
            border: 2px dashed var(--success);
            padding: 1.5rem;
            margin: 1rem 0;
            border-radius: 8px;
        }

        .extension-box h4 {
            color: var(--success);
            margin-bottom: 0.5rem;
        }

        /* Video Placeholder */
        .video-placeholder {
            background: var(--dark);
            border-radius: 8px;
            padding: 3rem;
            text-align: center;
            color: var(--white);
            margin: 1rem 0;
        }

        .video-placeholder i {
            font-size: 3rem;
            margin-bottom: 1rem;
            display: block;
        }

        /* Tooltips */
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: var(--dark);
            color: var(--white);
            text-align: center;
            padding: 0.5rem;
            border-radius: 6px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* Print Styles */
        @media print {
            .header, .feedback-button, .nav-buttons {
                display: none;
            }

            .section {
                display: block !important;
                page-break-after: always;
            }

            body {
                background: white;
            }

            .card {
                box-shadow: none;
                border: 1px solid #ddd;
            }
        }
    </style>
</head>
<body class="no-select">
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <h1>📦 Packet & Circuit Switching</h1>
            <nav class="nav-bar">
                <button class="nav-item active" data-section="starter">Starter</button>
                <button class="nav-item" data-section="packet-basics">Packet Basics</button>
                <button class="nav-item" data-section="headers">Headers</button>
                <button class="nav-item" data-section="routing">Routing</button>
                <button class="nav-item" data-section="circuit">Circuit</button>
                <button class="nav-item" data-section="comparison">Compare</button>
                <button class="nav-item" data-section="applications">Applications</button>
                <button class="nav-item" data-section="summary">Summary</button>
            </nav>
            <div class="xp-container">
                <span class="level-badge">Level <span id="level">0</span></span>
                <div class="xp-bar">
                    <div class="xp-fill" id="xpFill" style="width: 0%"></div>
                </div>
                <span class="xp-text"><span id="currentXP">0</span> / <span id="requiredXP">100</span> XP</span>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Starter Activity -->
        <section id="starter" class="section active">
            <div class="card">
                <h2>🚀 Starter Activity: How Does Data Travel?</h2>
                <p>Welcome to our lesson on Packet and Circuit Switching! Let's start by exploring how data travels across networks.</p>
                
                <h3>Quick Knowledge Check</h3>
                <div class="quiz-container">
                    <p><strong>Question 1:</strong> When you send a message over the internet, how do you think it travels?</p>
                    <button class="quiz-option" data-answer="single">As one complete piece from sender to receiver</button>
                    <button class="quiz-option" data-answer="pieces">Broken into smaller pieces that travel separately</button>
                    <button class="quiz-option" data-answer="duplicate">Duplicated and sent multiple times</button>
                    <button class="quiz-option" data-answer="random">Randomly through any available path</button>
                </div>

                <h3>Interactive Visualization</h3>
                <div class="simulation-container" id="starterSim">
                    <div class="router" style="left: 50%; top: 50%; transform: translate(-50%, -50%);">Internet</div>
                    <div class="packet" id="dataPacket" style="left: 10%; top: 50%; transform: translateY(-50%);">Data</div>
                    <div class="packet" id="destNode" style="right: 10%; top: 50%; transform: translateY(-50%); background: var(--gradient-2);">Destination</div>
                </div>
                <div class="sim-controls">
                    <button class="btn" onclick="startDataAnimation()">Send Data</button>
                    <button class="btn btn-danger" onclick="resetStarterSim()">Reset</button>
                </div>

                <button class="hint-button" onclick="showHint('starter-hint')">💡 Need a hint?</button>
                <div id="starter-hint" class="hint-container">
                    <p>Think about how efficient it would be to send a large file as one piece versus breaking it into smaller chunks...</p>
                </div>

                <div class="nav-buttons">
                    <button class="btn btn-secondary" disabled>Previous</button>
                    <button class="btn" onclick="navigateToSection('packet-basics')">Next: Packet Basics →</button>
                </div>
            </div>
        </section>

        <!-- Section 1: Packet Switching Basics -->
        <section id="packet-basics" class="section">
            <div class="card">
                <h2>📦 Understanding Packet Switching</h2>
                
                <div class="context-box">
                    <h4>🌍 Real-World Context</h4>
                    <p>Packet switching is like sending a jigsaw puzzle through the mail - each piece is sent separately and reassembled at the destination!</p>
                </div>

                <h3>What is Packet Switching?</h3>
                <p>Fill in the blanks to complete the definition:</p>
                
                <div class="fill-blank-container">
                    <p>A message is broken into a number of <span class="blank-space" data-answer="equal sized"></span> parts called <span class="blank-space" data-answer="packets"></span> that are sent <span class="blank-space" data-answer="independently"></span> over whatever <span class="blank-space" data-answer="route"></span> is optimum for each packet.</p>
                </div>
                
                <div class="blank-options">
                    <div class="blank-option">equal sized</div>
                    <div class="blank-option">randomly sized</div>
                    <div class="blank-option">packets</div>
                    <div class="blank-option">bundles</div>
                    <div class="blank-option">independently</div>
                    <div class="blank-option">together</div>
                    <div class="blank-option">route</div>
                    <div class="blank-option">speed</div>
                    <div class="blank-option">large</div>
                    <div class="blank-option">compressed</div>
                </div>

                <button class="btn btn-success" onclick="checkFillBlanks()">Check Answers</button>

                <h3>Key Steps in Packet Switching</h3>
                <p>Put these steps in the correct order:</p>
                <div class="quiz-container" id="sequencing-container">
                    <div class="match-item" data-order="3">Routers choose best path using tables</div>
                    <div class="match-item" data-order="1">Data divided into packets</div>
                    <div class="match-item" data-order="6">Destination reassembles packets</div>
                    <div class="match-item" data-order="2">Headers added with IP addresses</div>
                    <div class="match-item" data-order="5">Packets may arrive out of order</div>
                    <div class="match-item" data-order="4">Packets can take different routes</div>
                    <div class="match-item" data-order="7">Missing packets trigger re-transmission</div>
                </div>
                <button class="btn btn-success" onclick="checkSequencing()">Check Order</button>

                <div class="mistake-box">
                    <h4>⚠️ Common Mistake</h4>
                    <p>Students often think packets always travel the same route - remember, each packet finds its own optimal path!</p>
                </div>

                <h3>Interactive Packet Switching Simulation</h3>
                <div class="simulation-container" id="packetSim">
                    <!-- Dynamic content will be added by JavaScript -->
                </div>
                <div class="sim-controls">
                    <button class="btn" onclick="startPacketSimulation()">Start Simulation</button>
                    <button class="btn btn-secondary" onclick="stepPacketSimulation()">Step Forward</button>
                    <button class="btn btn-danger" onclick="resetPacketSimulation()">Reset</button>
                </div>
                <div class="progress-indicator">
                    <div class="progress-dot active"></div>
                    <div class="progress-dot"></div>
                    <div class="progress-dot"></div>
                    <div class="progress-dot"></div>
                    <div class="progress-dot"></div>
                </div>

                <div class="nav-buttons">
                    <button class="btn btn-secondary" onclick="navigateToSection('starter')">← Previous</button>
                    <button class="btn" onclick="navigateToSection('headers')">Next: Packet Headers →</button>
                </div>
            </div>
        </section>

        <!-- Section 2: Packet Headers -->
        <section id="headers" class="section">
            <div class="card">
                <h2>📋 Packet Headers Explained</h2>
                
                <h3>What's in a Packet Header?</h3>
                <p>Click on the correct header components from the options below:</p>
                
                <div class="matching-container">
                    <div class="matching-column">
                        <h4>Select Header Components:</h4>
                        <div class="match-item" data-type="header" data-valid="true">Source IP Address</div>
                        <div class="match-item" data-type="header" data-valid="true">Destination IP Address</div>
                        <div class="match-item" data-type="header" data-valid="false">File Name</div>
                        <div class="match-item" data-type="header" data-valid="true">Packet Sequence Number</div>
                        <div class="match-item" data-type="header" data-valid="false">User Password</div>
                        <div class="match-item" data-type="header" data-valid="true">Time to Live</div>
                        <div class="match-item" data-type="header" data-valid="true">Checksum</div>
                        <div class="match-item" data-type="header" data-valid="false">Encryption Key</div>
                        <div class="match-item" data-type="header" data-valid="true">Protocol Used</div>
                        <div class="match-item" data-type="header" data-valid="true">Total Packet Count</div>
                    </div>
                    <div class="matching-column">
                        <h4>Selected Components:</h4>
                        <div id="selectedHeaders" style="min-height: 200px; background: var(--light); border-radius: 8px; padding: 1rem;">
                            <p style="color: #999; text-align: center;">Click components to add them here</p>
                        </div>
                    </div>
                </div>
                <button class="btn btn-success" onclick="checkHeaderComponents()">Check Selection</button>

                <h3>Header Purpose Matching</h3>
                <p>Match each header component to its purpose:</p>
                
                <div class="quiz-container">
                    <p><strong>Source IP Address</strong></p>
                    <button class="quiz-option" data-match="source">Identifies where the packet came from</button>
                    <button class="quiz-option" data-match="wrong1">Counts the number of packets</button>
                    <button class="quiz-option" data-match="wrong2">Verifies data integrity</button>
                    <button class="quiz-option" data-match="wrong3">Sets maximum hops allowed</button>
                </div>

                <div class="quiz-container">
                    <p><strong>Checksum</strong></p>
                    <button class="quiz-option" data-match="wrong4">Identifies the sender</button>
                    <button class="quiz-option" data-match="checksum">Verifies data integrity</button>
                    <button class="quiz-option" data-match="wrong5">Orders the packets</button>
                    <button class="quiz-option" data-match="wrong6">Specifies the protocol</button>
                </div>

                <div class="quiz-container">
                    <p><strong>Time to Live (TTL)</strong></p>
                    <button class="quiz-option" data-match="wrong7">Measures transmission speed</button>
                    <button class="quiz-option" data-match="wrong8">Encrypts the data</button>
                    <button class="quiz-option" data-match="ttl">Prevents packets from circulating forever</button>
                    <button class="quiz-option" data-match="wrong9">Stores the creation time</button>
                </div>

                <h3>Short Answer: Why are headers essential?</h3>
                <textarea id="headerEssential" placeholder="Explain in your own words why packet headers are essential for network communication..."></textarea>
                <button class="btn btn-success" onclick="checkShortAnswer('headerEssential', ['routing', 'destination', 'reassembly', 'order', 'integrity'])">Submit Answer</button>
                
                <div class="extension-box">
                    <h4>🚀 Extension Activity</h4>
                    <p>Research IPv6 headers and explain how they differ from IPv4 headers. What new features do they provide?</p>
                    <textarea id="extensionIPv6" placeholder="Your research findings..."></textarea>
                </div>

                <div class="nav-buttons">
                    <button class="btn btn-secondary" onclick="navigateToSection('packet-basics')">← Previous</button>
                    <button class="btn" onclick="navigateToSection('routing')">Next: Routing →</button>
                </div>
            </div>
        </section>

        <!-- Section 3: Routing -->
        <section id="routing" class="section">
            <div class="card">
                <h2>🔀 Router's Role & Routing Tables</h2>
                
                <h3>How Routers Make Decisions</h3>
                <div class="simulation-container" id="routerSim">
                    <!-- Router decision simulation -->
                </div>
                <div class="sim-controls">
                    <button class="btn" onclick="startRouterSimulation()">Start Router Simulation</button>
                    <button class="btn btn-secondary" id="routerStepBtn" onclick="stepRouterSimulation()" disabled>Next Step</button>
                    <button class="btn btn-secondary" id="routerPrevBtn" onclick="prevRouterSimulation()" disabled>Previous Step</button>
                    <button class="btn btn-danger" onclick="resetRouterSimulation()">Reset</button>
                </div>
                <div id="routerExplanation" class="context-box" style="margin-top: 1rem; display: none;">
                    <h4>Current Step:</h4>
                    <p id="routerStepText"></p>
                </div>

                <h3>Routing Table Components</h3>
                <p>Build a routing table by selecting the correct components:</p>
                
                <table id="routingTable">
                    <thead>
                        <tr>
                            <th>Network Destination</th>
                            <th>Gateway</th>
                            <th>Interface</th>
                            <th>Metric</th>
                            <th>Hop Count</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><input type="text" placeholder="e.g., 192.168.1.0" class="routing-input"></td>
                            <td><input type="text" placeholder="e.g., 192.168.1.1" class="routing-input"></td>
                            <td><input type="text" placeholder="e.g., eth0" class="routing-input"></td>
                            <td><input type="number" placeholder="e.g., 10" class="routing-input"></td>
                            <td><input type="number" placeholder="e.g., 2" class="routing-input"></td>
                        </tr>
                    </tbody>
                </table>
                <button class="btn" onclick="addRoutingRow()">Add Row</button>
                <button class="btn btn-success" onclick="checkRoutingTable()">Validate Table</button>

                <h3>Problem Solving: Best Route Selection</h3>
                <div class="context-box">
                    <h4>Scenario:</h4>
                    <p>A packet needs to travel from Network A to Network D. There are three possible routes:</p>
                    <ul>
                        <li>Route 1: A → B → D (Metric: 15, Hops: 2)</li>
                        <li>Route 2: A → C → D (Metric: 10, Hops: 2)</li>
                        <li>Route 3: A → B → C → D (Metric: 8, Hops: 3)</li>
                    </ul>
                </div>
                
                <div class="quiz-container">
                    <p><strong>Which route should the router choose?</strong></p>
                    <button class="quiz-option" data-answer="route3">Route 3 (lowest metric)</button>
                    <button class="quiz-option" data-answer="route1">Route 1 (direct path)</button>
                    <button class="quiz-option" data-answer="route2">Route 2 (balanced)</button>
                    <button class="quiz-option" data-answer="random">Random selection</button>
                </div>

                <h3>Analysis Question</h3>
                <p>Why do routers use metrics instead of just hop count?</p>
                <textarea id="metricsAnalysis" placeholder="Analyze why metrics provide better routing decisions than hop count alone..."></textarea>
                <button class="btn btn-success" onclick="checkShortAnswer('metricsAnalysis', ['bandwidth', 'congestion', 'speed', 'reliability', 'cost', 'efficiency'])">Submit Analysis</button>

                <div class="nav-buttons">
                    <button class="btn btn-secondary" onclick="navigateToSection('headers')">← Previous</button>
                    <button class="btn" onclick="navigateToSection('circuit')">Next: Circuit Switching →</button>
                </div>
            </div>
        </section>

        <!-- Section 4: Circuit Switching -->
        <section id="circuit" class="section">
            <div class="card">
                <h2>📞 Circuit Switching Explained</h2>
                
                <h3>What is Circuit Switching?</h3>
                <div class="fill-blank-container">
                    <p>Circuit switching establishes a <span class="blank-space" data-answer="dedicated"></span> communications channel between devices <span class="blank-space" data-answer="prior to"></span> the start of communication that lasts the <span class="blank-space" data-answer="duration"></span> of the connection.</p>
                </div>
                
                <div class="blank-options">
                    <div class="blank-option">shared</div>
                    <div class="blank-option">dedicated</div>
                    <div class="blank-option">after</div>
                    <div class="blank-option">prior to</div>
                    <div class="blank-option">duration</div>
                    <div class="blank-option">beginning</div>
                    <div class="blank-option">temporary</div>
                    <div class="blank-option">partial</div>
                </div>

                <h3>Circuit Switching Process</h3>
                <p>True or False:</p>
                <div class="quiz-container">
                    <p>1. Circuit switching requires a connection setup phase before data transmission.</p>
                    <button class="quiz-option" data-answer="true">True</button>
                    <button class="quiz-option" data-answer="false">False</button>
                </div>
                
                <div class="quiz-container">
                    <p>2. Multiple users can share the same circuit simultaneously.</p>
                    <button class="quiz-option" data-answer="false">True</button>
                    <button class="quiz-option" data-answer="true">False</button>
                </div>
                
                <div class="quiz-container">
                    <p>3. Data arrives in the same order it was sent in circuit switching.</p>
                    <button class="quiz-option" data-answer="true">True</button>
                    <button class="quiz-option" data-answer="false">False</button>
                </div>

                <h3>Interactive Comparison</h3>
                <div class="simulation-container" id="circuitSim">
                    <!-- Circuit vs Packet switching visualization -->
                </div>
                <div class="sim-controls">
                    <button class="btn" onclick="showPacketMode()">Show Packet Switching</button>
                    <button class="btn" onclick="showCircuitMode()">Show Circuit Switching</button>
                    <button class="btn btn-danger" onclick="resetComparisonSim()">Reset</button>
                </div>

                <div class="mistake-box">
                    <h4>⚠️ Common Mistake</h4>
                    <p>Don't confuse "dedicated" with "faster" - circuit switching isn't always faster, but it guarantees consistent bandwidth!</p>
                </div>

                <div class="nav-buttons">
                    <button class="btn btn-secondary" onclick="navigateToSection('routing')">← Previous</button>
                    <button class="btn" onclick="navigateToSection('comparison')">Next: Comparison →</button>
                </div>
            </div>
        </section>

        <!-- Section 5: Comparison -->
        <section id="comparison" class="section">
            <div class="card">
                <h2>⚖️ Packet vs Circuit Switching</h2>
                
                <h3>Compare and Contrast</h3>
                <div class="matching-container">
                    <div class="matching-column">
                        <h4>Features:</h4>
                        <div class="match-item" data-category="feature">Bandwidth is shared</div>
                        <div class="match-item" data-category="feature">Dedicated path</div>
                        <div class="match-item" data-category="feature">Packets may arrive out of order</div>
                        <div class="match-item" data-category="feature">Connection setup required</div>
                        <div class="match-item" data-category="feature">Can reroute if problems occur</div>
                        <div class="match-item" data-category="feature">Wasteful if not continuously used</div>
                        <div class="match-item" data-category="feature">Good for real-time applications</div>
                        <div class="match-item" data-category="feature">Efficient use of network resources</div>
                    </div>
                    <div class="matching-column">
                        <h4>Categorize as:</h4>
                        <div style="margin-bottom: 1rem;">
                            <h5>Packet Switching:</h5>
                            <div id="packetFeatures" class="match-target" style="min-height: 100px; background: rgba(99, 102, 241, 0.1); border: 2px dashed var(--primary); border-radius: 8px; padding: 1rem;"></div>
                        </div>
                        <div>
                            <h5>Circuit Switching:</h5>
                            <div id="circuitFeatures" class="match-target" style="min-height: 100px; background: rgba(139, 92, 246, 0.1); border: 2px dashed var(--secondary); border-radius: 8px; padding: 1rem;"></div>
                        </div>
                    </div>
                </div>
                <button class="btn btn-success" onclick="checkCategorization()">Check Categorization</button>

                <h3>Evaluation Exercise</h3>
                <p>For each scenario, evaluate which switching method is most appropriate:</p>
                
                <div class="quiz-container">
                    <p><strong>Scenario 1:</strong> A live video conference between two offices</p>
                    <button class="quiz-option" data-answer="circuit">Circuit Switching</button>
                    <button class="quiz-option" data-answer="packet">Packet Switching</button>
                </div>
                
                <div class="quiz-container">
                    <p><strong>Scenario 2:</strong> Sending an email with large attachments</p>
                    <button class="quiz-option" data-answer="circuit">Circuit Switching</button>
                    <button class="quiz-option" data-answer="packet">Packet Switching</button>
                </div>
                
                <div class="quiz-container">
                    <p><strong>Scenario 3:</strong> Online gaming with low latency requirements</p>
                    <button class="quiz-option" data-answer="both">Could use either</button>
                    <button class="quiz-option" data-answer="packet">Packet Switching only</button>
                    <button class="quiz-option" data-answer="circuit">Circuit Switching only</button>
                </div>

                <h3>Critical Thinking</h3>
                <p>Why has packet switching become the dominant method for internet communication?</p>
                <textarea id="criticalThinking" placeholder="Consider efficiency, scalability, cost, and flexibility in your answer..."></textarea>
                <button class="btn btn-success" onclick="checkShortAnswer('criticalThinking', ['efficiency', 'scalability', 'cost', 'flexible', 'resources', 'multiple', 'paths'])">Submit Answer</button>

                <div class="nav-buttons">
                    <button class="btn btn-secondary" onclick="navigateToSection('circuit')">← Previous</button>
                    <button class="btn" onclick="navigateToSection('applications')">Next: Applications →</button>
                </div>
            </div>
        </section>

        <!-- Section 6: Real-World Applications -->
        <section id="applications" class="section">
            <div class="card">
                <h2>🌐 Real-World Applications</h2>
                
                <h3>Case Study Analysis</h3>
                <div class="context-box">
                    <h4>Case Study: Netflix Streaming Service</h4>
                    <p>Netflix serves millions of users simultaneously, streaming high-quality video content worldwide. They use adaptive bitrate streaming and content delivery networks (CDNs).</p>
                    
                    <p><strong>Questions:</strong></p>
                    <ol>
                        <li>Which switching method does Netflix primarily use?</li>
                        <li>Why is this method suitable for video streaming?</li>
                        <li>What challenges might arise with the other method?</li>
                    </ol>
                </div>
                
                <textarea id="caseStudy" placeholder="Analyze the Netflix case study addressing all three questions..."></textarea>
                <button class="btn btn-success" onclick="checkCaseStudy()">Submit Analysis</button>

                <h3>Ranking Exercise</h3>
                <p>Rank these applications from most suitable for packet switching (1) to most suitable for circuit switching (5):</p>
                
                <div id="rankingContainer">
                    <div class="match-item" data-rank="true">Web browsing</div>
                    <div class="match-item" data-rank="true">Voice over IP (VoIP) call</div>
                    <div class="match-item" data-rank="true">File download</div>
                    <div class="match-item" data-rank="true">Traditional telephone call</div>
                    <div class="match-item" data-rank="true">Email</div>
                </div>
                <button class="btn btn-success" onclick="checkRanking()">Check Ranking</button>

                <h3>Problem Solving: Network Design</h3>
                <div class="canvas-container">
                    <canvas id="drawingCanvas" width="800" height="400"></canvas>
                </div>
                <div class="canvas-controls">
                    <button class="btn btn-secondary" onclick="clearCanvas()">Clear Canvas</button>
                    <button class="btn" onclick="downloadCanvas()">Download Design</button>
                </div>
                <p>Design a hybrid network that uses both packet and circuit switching appropriately. Label which parts use which method.</p>

                <div class="extension-box">
                    <h4>🚀 Extension: Future Technologies</h4>
                    <p>Research Software-Defined Networking (SDN) and explain how it changes traditional routing approaches.</p>
                    <textarea id="sdnExtension" placeholder="Your research on SDN..."></textarea>
                </div>

                <div class="nav-buttons">
                    <button class="btn btn-secondary" onclick="navigateToSection('comparison')">← Previous</button>
                    <button class="btn" onclick="navigateToSection('summary')">Next: Summary →</button>
                </div>
            </div>
        </section>

        <!-- Summary Section -->
        <section id="summary" class="section">
            <div class="card">
                <h2>📊 Summary & Assessment</h2>
                
                <h3>Key Takeaways</h3>
                <div class="context-box">
                    <h4>What You've Learned:</h4>
                    <ul>
                        <li>Packet switching breaks data into packets that travel independently</li>
                        <li>Packet headers contain routing and reassembly information</li>
                        <li>Routers use routing tables to make forwarding decisions</li>
                        <li>Circuit switching establishes dedicated paths before transmission</li>
                        <li>Each method has specific advantages for different applications</li>
                    </ul>
                </div>

                <h3>Final Assessment Quiz</h3>
                <div id="finalQuiz">
                    <div class="quiz-container">
                        <p><strong>Q1:</strong> What happens when a packet's TTL reaches zero?</p>
                        <button class="quiz-option" data-answer="dropped">The packet is dropped</button>
                        <button class="quiz-option" data-answer="faster">It travels faster</button>
                        <button class="quiz-option" data-answer="return">It returns to sender</button>
                        <button class="quiz-option" data-answer="priority">It gets priority routing</button>
                    </div>

                    <div class="quiz-container">
                        <p><strong>Q2:</strong> Which switching method guarantees ordered delivery?</p>
                        <button class="quiz-option" data-answer="packet">Packet switching</button>
                        <button class="quiz-option" data-answer="circuit">Circuit switching</button>
                        <button class="quiz-option" data-answer="both">Both methods</button>
                        <button class="quiz-option" data-answer="neither">Neither method</button>
                    </div>

                    <div class="quiz-container">
                        <p><strong>Q3:</strong> What is stored in a routing table's metric field?</p>
                        <button class="quiz-option" data-answer="cost">Cost/quality measure of route</button>
                        <button class="quiz-option" data-answer="speed">Transmission speed</button>
                        <button class="quiz-option" data-answer="size">Packet size limit</button>
                        <button class="quiz-option" data-answer="time">Current time</button>
                    </div>

                    <div class="quiz-container">
                        <p><strong>Q4:</strong> Why might packets arrive out of order?</p>
                        <button class="quiz-option" data-answer="corruption">Data corruption</button>
                        <button class="quiz-option" data-answer="routes">Different routes taken</button>
                        <button class="quiz-option" data-answer="priority">Priority differences</button>
                        <button class="quiz-option" data-answer="error">Network errors</button>
                    </div>

                    <div class="quiz-container">
                        <p><strong>Q5:</strong> Which is NOT a benefit of packet switching?</p>
                        <button class="quiz-option" data-answer="guaranteed">Guaranteed bandwidth</button>
                        <button class="quiz-option" data-answer="efficient">Efficient use of resources</button>
                        <button class="quiz-option" data-answer="resilient">Network resilience</button>
                        <button class="quiz-option" data-answer="sharing">Path sharing</button>
                    </div>

                    <div class="quiz-container">
                        <p><strong>Q6:</strong> What triggers packet retransmission?</p>
                        <button class="quiz-option" data-answer="slow">Slow transmission</button>
                        <button class="quiz-option" data-answer="missing">Missing or corrupted packets</button>
                        <button class="quiz-option" data-answer="full">Full network capacity</button>
                        <button class="quiz-option" data-answer="timeout">Router timeout</button>
                    </div>

                    <div class="quiz-container">
                        <p><strong>Q7:</strong> Circuit switching is ideal for:</p>
                        <button class="quiz-option" data-answer="email">Email transmission</button>
                        <button class="quiz-option" data-answer="web">Web browsing</button>
                        <button class="quiz-option" data-answer="realtime">Real-time communication</button>
                        <button class="quiz-option" data-answer="backup">Data backup</button>
                    </div>

                    <div class="quiz-container">
                        <p><strong>Q8:</strong> What does the checksum in a packet header verify?</p>
                        <button class="quiz-option" data-answer="integrity">Data integrity</button>
                        <button class="quiz-option" data-answer="source">Source authenticity</button>
                        <button class="quiz-option" data-answer="encryption">Encryption status</button>
                        <button class="quiz-option" data-answer="priority">Packet priority</button>
                    </div>
                </div>
                <button class="btn btn-success" onclick="submitFinalQuiz()">Submit Final Quiz</button>
                <div id="quizResults" style="display: none; margin-top: 1rem;"></div>

                <h3>Practice Exam Question</h3>
                <div class="context-box">
                    <h4>Question (6 marks):</h4>
                    <p>Explain why packet switching is preferred over circuit switching for general internet traffic. Include discussion of efficiency, resilience, and resource utilization.</p>
                </div>
                
                <textarea id="examAnswer" placeholder="Write your answer here..." style="min-height: 200px;"></textarea>
                <div style="display: flex; gap: 1rem; align-items: center; margin-top: 1rem;">
                    <button class="btn btn-success" onclick="checkExamAnswer()">Submit Answer</button>
                    <label>Predicted marks: <input type="number" id="predictedMarks" min="0" max="6" style="width: 60px;"> / 6</label>
                </div>
                
                <div id="markScheme" class="mark-scheme">
                    <h4>Mark Scheme:</h4>
                    <ul>
                        <li><strong>Efficiency (2 marks):</strong>
                            <ul>
                                <li>Bandwidth sharing allows multiple users (1)</li>
                                <li>No wasted resources when not transmitting (1)</li>
                            </ul>
                        </li>
                        <li><strong>Resilience (2 marks):</strong>
                            <ul>
                                <li>Alternative routes available if problems occur (1)</li>
                                <li>Only affected packets need retransmission (1)</li>
                            </ul>
                        </li>
                        <li><strong>Resource Utilization (2 marks):</strong>
                            <ul>
                                <li>Statistical multiplexing of traffic (1)</li>
                                <li>Dynamic allocation based on demand (1)</li>
                            </ul>
                        </li>
                    </ul>
                </div>

                <h3>Your Achievements</h3>
                <div id="achievementsList" class="context-box">
                    <!-- Achievements will be displayed here -->
                </div>

                <div class="video-placeholder">
                    <i>🎥</i>
                    <h4>Additional Video Resources</h4>
                    <p>Video tutorials on packet and circuit switching will be added here</p>
                </div>

                <div class="nav-buttons">
                    <button class="btn btn-secondary" onclick="navigateToSection('applications')">← Previous</button>
                    <button class="btn btn-success" onclick="completeLesson()">Complete Lesson 🎉</button>
                </div>
            </div>
        </section>
    </main>

    <!-- Achievement Popup -->
    <div id="achievementPopup" class="achievement-popup">
        <h4 id="achievementTitle"></h4>
        <p id="achievementDesc"></p>
    </div>

    <!-- Feedback Button -->
    <button class="feedback-button" onclick="openFeedback()">💬</button>

    <!-- Feedback Modal -->
    <div id="feedbackModal" class="feedback-modal">
        <div class="feedback-content">
            <h3>Send Feedback</h3>
            <p>Found a bug or have a suggestion? Let us know!</p>
            <textarea id="feedbackText" placeholder="Describe the issue or suggestion..." style="min-height: 150px;"></textarea>
            <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                <button class="btn btn-success" onclick="sendFeedback()">Send</button>
                <button class="btn btn-secondary" onclick="closeFeedback()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Paste Shame Message -->
    <div id="pasteShame" class="paste-shame">
        🚫 Nice try! Pasting is disabled. Type your answers to earn XP!
    </div>

    <script>
        // Global Variables
        let currentXP = 0;
        let currentLevel = 0;
        let completedTasks = new Set();
        let earnedAchievements = new Set();
        let currentSection = 'starter';
        let simulationStep = 0;
        let routerSimStep = 0;

        // XP Requirements per level
        const xpRequirements = [100, 250, 500, 1000, 2000];

        // Achievements
        const achievements = {
            firstStep: { title: "First Steps", desc: "Complete your first activity", xp: 20 },
            packetMaster: { title: "Packet Master", desc: "Complete all packet switching activities", xp: 50 },
            headerExpert: { title: "Header Expert", desc: "Identify all header components correctly", xp: 40 },
            routingGuru: { title: "Routing Guru", desc: "Master routing tables and decisions", xp: 45 },
            comparePro: { title: "Comparison Pro", desc: "Successfully compare both switching methods", xp: 35 },
            examReady: { title: "Exam Ready", desc: "Score 100% on the final quiz", xp: 100 },
            levelMax: { title: "Maximum Level!", desc: "Reach level 5", xp: 200 }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            preventPasting();
            initializeEventListeners();
            updateXPDisplay();
            initializeCanvas();
            loadProgress();
        });

        // Prevent Pasting
        function preventPasting() {
            document.addEventListener('paste', function(e) {
                e.preventDefault();
                showPasteShame();
                return false;
            });

            // Also prevent context menu
            document.addEventListener('contextmenu', function(e) {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                    e.preventDefault();
                    return false;
                }
            });

            // Prevent keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if ((e.ctrlKey || e.metaKey) && (e.key === 'v' || e.key === 'V')) {
                    e.preventDefault();
                    showPasteShame();
                    return false;
                }
            });
        }

        function showPasteShame() {
            const shame = document.getElementById('pasteShame');
            shame.style.display = 'block';
            setTimeout(() => {
                shame.style.display = 'none';
            }, 3000);
            
            // Lose XP for trying to cheat
            if (currentXP > 10) {
                addXP(-10);
                showXPIndicator(event.clientX, event.clientY, '-10 XP', '#ef4444');
            }
        }

        // XP System
        function addXP(amount, taskId = null) {
            if (taskId && completedTasks.has(taskId)) {
                return; // Already completed this task
            }
            
            if (taskId) {
                completedTasks.add(taskId);
            }
            
            currentXP += amount;
            updateXPDisplay();
            checkLevelUp();
            saveProgress();
            
            // Show floating XP indicator
            if (amount > 0) {
                showXPIndicator(event.clientX, event.clientY, `+${amount} XP`);
            }
        }

        function updateXPDisplay() {
            const requiredXP = xpRequirements[currentLevel] || xpRequirements[xpRequirements.length - 1];
            const xpInLevel = currentXP;
            const percentage = Math.min((xpInLevel / requiredXP) * 100, 100);
            
            document.getElementById('currentXP').textContent = xpInLevel;
            document.getElementById('requiredXP').textContent = requiredXP;
            document.getElementById('xpFill').style.width = percentage + '%';
            document.getElementById('level').textContent = currentLevel;
        }

        function checkLevelUp() {
            const requiredXP = xpRequirements[currentLevel];
            if (currentXP >= requiredXP && currentLevel < 5) {
                currentLevel++;
                currentXP = currentXP - requiredXP;
                showAchievement('levelUp', `Level ${currentLevel} Reached!`, `You've reached level ${currentLevel}!`);
                createParticles();
                
                if (currentLevel === 5 && !earnedAchievements.has('levelMax')) {
                    earnedAchievements.add('levelMax');
                    showAchievement('levelMax', achievements.levelMax.title, achievements.levelMax.desc);
                    addXP(achievements.levelMax.xp, 'achievement-levelMax');
                }
            }
        }

        function showXPIndicator(x, y, text, color = '#10b981') {
            const indicator = document.createElement('div');
            indicator.className = 'xp-indicator';
            indicator.style.left = x + 'px';
            indicator.style.top = y + 'px';
            indicator.style.color = color;
            indicator.textContent = text;
            document.body.appendChild(indicator);
            
            setTimeout(() => {
                indicator.remove();
            }, 2000);
        }

        // Achievement System
        function showAchievement(id, title, description) {
            const popup = document.getElementById('achievementPopup');
            document.getElementById('achievementTitle').textContent = title;
            document.getElementById('achievementDesc').textContent = description;
            
            popup.classList.add('show');
            createParticles();
            
            setTimeout(() => {
                popup.classList.remove('show');
            }, 3000);
        }

        function checkAchievement(achievementId) {
            if (!earnedAchievements.has(achievementId) && achievements[achievementId]) {
                earnedAchievements.add(achievementId);
                const achievement = achievements[achievementId];
                showAchievement(achievementId, achievement.title, achievement.desc);
                addXP(achievement.xp, `achievement-${achievementId}`);
            }
        }

        // Particle Effects
        function createParticles() {
            for (let i = 0; i < 20; i++) {
                setTimeout(() => {
                    const particle = document.createElement('div');
                    particle.className = 'particle';
                    particle.style.left = Math.random() * window.innerWidth + 'px';
                    particle.style.top = Math.random() * window.innerHeight + 'px';
                    particle.style.background = `hsl(${Math.random() * 360}, 70%, 50%)`;
                    document.body.appendChild(particle);
                    
                    const angle = Math.random() * Math.PI * 2;
                    const velocity = 2 + Math.random() * 3;
                    let x = parseFloat(particle.style.left);
                    let y = parseFloat(particle.style.top);
                    let opacity = 1;
                    
                    function animateParticle() {
                        x += Math.cos(angle) * velocity;
                        y += Math.sin(angle) * velocity + 1;
                        opacity -= 0.02;
                        
                        particle.style.left = x + 'px';
                        particle.style.top = y + 'px';
                        particle.style.opacity = opacity;
                        
                        if (opacity > 0) {
                            requestAnimationFrame(animateParticle);
                        } else {
                            particle.remove();
                        }
                    }
                    
                    requestAnimationFrame(animateParticle);
                }, i * 50);
            }
        }

        // Navigation
        function navigateToSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-section="${sectionId}"]`).classList.add('active');
            
            currentSection = sectionId;
            window.scrollTo(0, 0);
        }

        // Event Listeners
        function initializeEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    navigateToSection(this.getAttribute('data-section'));
                });
            });

            // Quiz options
            document.querySelectorAll('.quiz-option').forEach(option => {
                option.addEventListener('click', function() {
                    handleQuizOption(this);
                });
            });

            // Fill in the blanks
            document.querySelectorAll('.blank-option').forEach(option => {
                option.addEventListener('click', function() {
                    handleBlankOption(this);
                });
            });

            // Matching items
            document.querySelectorAll('.match-item').forEach(item => {
                item.addEventListener('click', function() {
                    handleMatchItem(this);
                });
            });
        }

        // Starter Section Functions
        function startDataAnimation() {
            const packet = document.getElementById('dataPacket');
            const sim = document.getElementById('starterSim');
            
            // Create multiple packets
            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    const newPacket = packet.cloneNode(true);
                    newPacket.id = 'packet' + i;
                    newPacket.textContent = 'P' + (i + 1);
                    newPacket.style.top = (30 + i * 15) + '%';
                    sim.appendChild(newPacket);
                    
                    // Animate to destination
                    setTimeout(() => {
                        newPacket.style.transition = 'all 2s ease';
                        newPacket.style.left = '85%';
                    }, 100);
                    
                    // Remove after animation
                    setTimeout(() => {
                        newPacket.remove();
                    }, 2500);
                }, i * 500);
            }
            
            addXP(10, 'starter-animation');
            checkAchievement('firstStep');
        }

        function resetStarterSim() {
            const sim = document.getElementById('starterSim');
            const packets = sim.querySelectorAll('.packet:not(#dataPacket):not(#destNode)');
            packets.forEach(p => p.remove());
        }

        function showHint(hintId) {
            const hint = document.getElementById(hintId);
            hint.classList.add('show');
            addXP(5, `hint-${hintId}`); // Reduced XP for using hint
        }

        // Quiz Handling
        function handleQuizOption(option) {
            const container = option.parentElement;
            const options = container.querySelectorAll('.quiz-option');
            
            // Check if already answered
            if (container.classList.contains('answered')) return;
            
            options.forEach(opt => opt.classList.remove('selected'));
            option.classList.add('selected');
            
            // Check answer after selection
            setTimeout(() => {
                const correct = option.getAttribute('data-answer');
                const isCorrect = checkQuizAnswer(container, correct);
                
                if (isCorrect) {
                    option.classList.add('correct');
                    addXP(15, `quiz-${container.id}-${correct}`);
                } else {
                    option.classList.add('incorrect');
                    // Show correct answer
                    options.forEach(opt => {
                        if (opt.getAttribute('data-answer') === getCorrectAnswer(container)) {
                            opt.classList.add('correct');
                        }
                    });
                }
                
                container.classList.add('answered');
            }, 300);
        }

        function checkQuizAnswer(container, answer) {
            // Define correct answers based on context
            const questionText = container.querySelector('p').textContent.toLowerCase();
            
            if (questionText.includes('how do you think it travels')) {
                return answer === 'pieces';
            } else if (questionText.includes('ttl reaches zero')) {
                return answer === 'dropped';
            } else if (questionText.includes('ordered delivery')) {
                return answer === 'circuit';
            } else if (questionText.includes('metric field')) {
                return answer === 'cost';
            } else if (questionText.includes('out of order')) {
                return answer === 'routes';
            } else if (questionText.includes('not a benefit')) {
                return answer === 'guaranteed';
            } else if (questionText.includes('retransmission')) {
                return answer === 'missing';
            } else if (questionText.includes('ideal for')) {
                return answer === 'realtime';
            } else if (questionText.includes('checksum')) {
                return answer === 'integrity';
            } else if (questionText.includes('route should')) {
                return answer === 'route3';
            } else if (questionText.includes('video conference')) {
                return answer === 'circuit';
            } else if (questionText.includes('email')) {
                return answer === 'packet';
            } else if (questionText.includes('online gaming')) {
                return answer === 'both';
            } else if (questionText.includes('source ip')) {
                return answer === 'source';
            } else if (questionText.includes('checksum')) {
                return answer === 'checksum';
            } else if (questionText.includes('time to live')) {
                return answer === 'ttl';
            } else if (questionText.includes('setup phase')) {
                return answer === 'true';
            } else if (questionText.includes('share the same circuit')) {
                return answer === 'true'; // This is FALSE
            } else if (questionText.includes('same order')) {
                return answer === 'true';
            }
            
            return false;
        }

        function getCorrectAnswer(container) {
            // Return correct answer based on question
            const questionText = container.querySelector('p').textContent.toLowerCase();
            
            if (questionText.includes('how do you think it travels')) {
                return 'pieces';
            }
            // Add more as needed...
            
            return null;
        }

        // Fill in the Blanks
        let selectedBlank = null;

        function handleBlankOption(option) {
            if (option.classList.contains('used') || !selectedBlank) return;
            
            const answer = option.textContent;
            selectedBlank.textContent = answer;
            selectedBlank.classList.add('filled');
            selectedBlank.setAttribute('data-filled', answer);
            
            option.classList.add('used');
            selectedBlank = null;
        }

        function checkFillBlanks() {
            const blanks = document.querySelectorAll('.blank-space');
            let allCorrect = true;
            let correctCount = 0;
            
            blanks.forEach(blank => {
                const expected = blank.getAttribute('data-answer');
                const filled = blank.getAttribute('data-filled');
                
                if (filled && filled.toLowerCase() === expected.toLowerCase()) {
                    blank.classList.add('correct');
                    correctCount++;
                } else {
                    blank.classList.add('incorrect');
                    allCorrect = false;
                    // Show correct answer
                    setTimeout(() => {
                        blank.textContent = expected;
                        blank.classList.remove('incorrect');
                        blank.classList.add('correct');
                    }, 2000);
                }
            });
            
            addXP(correctCount * 10, 'fill-blanks-packet-basics');
            
            if (allCorrect) {
                showAchievement('fillMaster', 'Fill Master!', 'All blanks filled correctly!');
            }
        }

        // Add click handler for blank spaces
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('blank-space')) {
                document.querySelectorAll('.blank-space').forEach(b => b.style.borderColor = '');
                selectedBlank = e.target;
                e.target.style.borderColor = '#6366f1';
            }
        });

        // Packet Simulation
        function startPacketSimulation() {
            const sim = document.getElementById('packetSim');
            sim.innerHTML = '';
            
            // Create network topology
            const nodes = [
                { id: 'source', x: 10, y: 50, label: 'Source' },
                { id: 'router1', x: 35, y: 20, label: 'R1' },
                { id: 'router2', x: 35, y: 80, label: 'R2' },
                { id: 'router3', x: 65, y: 30, label: 'R3' },
                { id: 'router4', x: 65, y: 70, label: 'R4' },
                { id: 'dest', x: 90, y: 50, label: 'Dest' }
            ];
            
            // Create nodes
            nodes.forEach(node => {
                const el = document.createElement('div');
                el.className = node.id.includes('router') ? 'router' : 'packet';
                el.id = node.id;
                el.style.left = node.x + '%';
                el.style.top = node.y + '%';
                el.style.transform = 'translate(-50%, -50%)';
                el.textContent = node.label;
                if (!node.id.includes('router')) {
                    el.style.background = 'var(--gradient-2)';
                }
                sim.appendChild(el);
            });
            
            // Create connections
            const connections = [
                ['source', 'router1'],
                ['source', 'router2'],
                ['router1', 'router3'],
                ['router2', 'router4'],
                ['router1', 'router4'],
                ['router2', 'router3'],
                ['router3', 'dest'],
                ['router4', 'dest']
            ];
            
            connections.forEach(([from, to]) => {
                const fromEl = document.getElementById(from);
                const toEl = document.getElementById(to);
                const line = createConnection(fromEl, toEl);
                sim.appendChild(line);
            });
            
            // Start packet animation
            simulationStep = 0;
            animatePackets();
            
            addXP(20, 'packet-simulation-start');
        }

        function createConnection(from, to) {
            const line = document.createElement('div');
            line.className = 'connection-line';
            
            const fromRect = from.getBoundingClientRect();
            const toRect = to.getBoundingClientRect();
            const simRect = from.parentElement.getBoundingClientRect();
            
            const x1 = fromRect.left + fromRect.width / 2 - simRect.left;
            const y1 = fromRect.top + fromRect.height / 2 - simRect.top;
            const x2 = toRect.left + toRect.width / 2 - simRect.left;
            const y2 = toRect.top + toRect.height / 2 - simRect.top;
            
            const length = Math.sqrt((x2 - x1) ** 2 + (y2 - y1) ** 2);
            const angle = Math.atan2(y2 - y1, x2 - x1) * 180 / Math.PI;
            
            line.style.width = length + 'px';
            line.style.left = x1 + 'px';
            line.style.top = y1 + 'px';
            line.style.transform = `rotate(${angle}deg)`;
            
            return line;
        }

        function animatePackets() {
            const sim = document.getElementById('packetSim');
            const routes = [
                ['source', 'router1', 'router3', 'dest'],
                ['source', 'router2', 'router4', 'dest'],
                ['source', 'router1', 'router4', 'dest']
            ];
            
            // Create 3 packets taking different routes
            for (let i = 0; i < 3; i++) {
                const packet = document.createElement('div');
                packet.className = 'packet';
                packet.textContent = 'P' + (i + 1);
                packet.style.width = '40px';
                packet.style.height = '30px';
                sim.appendChild(packet);
                
                animatePacketRoute(packet, routes[i], i * 1000);
            }
        }

        function animatePacketRoute(packet, route, delay) {
            let currentIndex = 0;
            
            function moveToNext() {
                if (currentIndex >= route.length) {
                    packet.style.background = 'var(--success)';
                    setTimeout(() => packet.remove(), 1000);
                    return;
                }
                
                const target = document.getElementById(route[currentIndex]);
                const rect = target.getBoundingClientRect();
                const simRect = packet.parentElement.getBoundingClientRect();
                
                packet.style.left = (rect.left - simRect.left + rect.width / 2 - 20) + 'px';
                packet.style.top = (rect.top - simRect.top + rect.height / 2 - 15) + 'px';
                
                if (route[currentIndex].includes('router')) {
                    target.classList.add('active');
                    setTimeout(() => target.classList.remove('active'), 500);
                }
                
                currentIndex++;
                setTimeout(moveToNext, 1500);
            }
            
            setTimeout(moveToNext, delay);
        }

        function stepPacketSimulation() {
            // Implement step-by-step simulation
            simulationStep++;
            // Add step logic here
        }

        function resetPacketSimulation() {
            const sim = document.getElementById('packetSim');
            sim.innerHTML = '';
            simulationStep = 0;
        }

        // Router Simulation
        function startRouterSimulation() {
            const sim = document.getElementById('routerSim');
            const stepBtn = document.getElementById('routerStepBtn');
            const prevBtn = document.getElementById('routerPrevBtn');
            const explanation = document.getElementById('routerExplanation');
            
            stepBtn.disabled = false;
            prevBtn.disabled = true;
            explanation.style.display = 'block';
            
            routerSimStep = 0;
            setupRouterSimulation();
            updateRouterStep();
        }

        function setupRouterSimulation() {
            const sim = document.getElementById('routerSim');
            sim.innerHTML = `
                <div class="router" style="left: 50%; top: 50%; transform: translate(-50%, -50%);">
                    <span>Router</span>
                </div>
                <div class="packet" id="routerPacket" style="left: 20%; top: 50%; transform: translateY(-50%);">
                    Packet
                </div>
                <div style="position: absolute; right: 20px; top: 20px; background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px;">
                    <h4 style="color: white; margin-bottom: 0.5rem;">Routing Table</h4>
                    <table style="color: white; font-size: 0.9rem;">
                        <tr><td>192.168.1.0</td><td>→ Port 1</td><td>Metric: 10</td></tr>
                        <tr><td>192.168.2.0</td><td>→ Port 2</td><td>Metric: 5</td></tr>
                        <tr><td>192.168.3.0</td><td>→ Port 3</td><td>Metric: 15</td></tr>
                    </table>
                </div>
            `;
        }

        function stepRouterSimulation() {
            routerSimStep++;
            updateRouterStep();
            
            if (routerSimStep >= 5) {
                document.getElementById('routerStepBtn').disabled = true;
                addXP(30, 'router-simulation-complete');
            }
        }

        function prevRouterSimulation() {
            if (routerSimStep > 0) {
                routerSimStep--;
                updateRouterStep();
            }
        }

        function updateRouterStep() {
            const packet = document.getElementById('routerPacket');
            const router = document.querySelector('#routerSim .router');
            const stepText = document.getElementById('routerStepText');
            const prevBtn = document.getElementById('routerPrevBtn');
            
            prevBtn.disabled = routerSimStep === 0;
            
            const steps = [
                { text: "Packet arrives at router with destination IP 192.168.2.100", action: () => {} },
                { text: "Router examines packet header and reads destination IP", action: () => { packet.style.transform = 'translateY(-50%) scale(1.2)'; } },
                { text: "Router consults routing table for best path", action: () => { router.classList.add('active'); } },
                { text: "Router finds matching network (192.168.2.0) with lowest metric (5)", action: () => {} },
                { text: "Router forwards packet through Port 2", action: () => { packet.style.left = '80%'; } }
            ];
            
            if (routerSimStep < steps.length) {
                stepText.textContent = steps[routerSimStep].text;
                steps[routerSimStep].action();
            }
        }

        function resetRouterSimulation() {
            routerSimStep = 0;
            document.getElementById('routerStepBtn').disabled = true;
            document.getElementById('routerPrevBtn').disabled = true;
            document.getElementById('routerExplanation').style.display = 'none';
            document.getElementById('routerSim').innerHTML = '';
        }

        // Sequencing Check
        function checkSequencing() {
            const items = document.querySelectorAll('#sequencing-container .match-item');
            let correct = true;
            let currentOrder = 1;
            
            items.forEach((item, index) => {
                const expectedOrder = parseInt(item.getAttribute('data-order'));
                if (index + 1 !== expectedOrder) {
                    correct = false;
                    item.classList.add('incorrect-match');
                } else {
                    item.classList.add('matched');
                }
            });
            
            if (correct) {
                addXP(25, 'sequencing-correct');
                showAchievement('sequenceMaster', 'Sequence Master!', 'Perfect ordering!');
            } else {
                // Show correct order after delay
                setTimeout(() => {
                    const sortedItems = Array.from(items).sort((a, b) => 
                        parseInt(a.getAttribute('data-order')) - parseInt(b.getAttribute('data-order'))
                    );
                    const container = document.getElementById('sequencing-container');
                    container.innerHTML = '';
                    sortedItems.forEach(item => {
                        item.classList.remove('incorrect-match');
                        item.classList.add('matched');
                        container.appendChild(item);
                    });
                }, 2000);
            }
        }

        // Header Components Check
        let selectedHeaders = [];

        function handleMatchItem(item) {
            if (item.getAttribute('data-type') === 'header') {
                if (item.classList.contains('selected')) {
                    item.classList.remove('selected');
                    const index = selectedHeaders.indexOf(item);
                    if (index > -1) selectedHeaders.splice(index, 1);
                } else {
                    item.classList.add('selected');
                    selectedHeaders.push(item);
                }
                updateSelectedHeaders();
            } else if (item.getAttribute('data-category') === 'feature') {
                // Handle categorization
                if (!item.classList.contains('matched')) {
                    item.classList.add('selected');
                }
            }
        }

        function updateSelectedHeaders() {
            const container = document.getElementById('selectedHeaders');
            if (selectedHeaders.length === 0) {
                container.innerHTML = '<p style="color: #999; text-align: center;">Click components to add them here</p>';
            } else {
                container.innerHTML = selectedHeaders.map(h => 
                    `<div style="padding: 0.5rem; background: white; margin: 0.25rem; border-radius: 4px; display: inline-block;">${h.textContent}</div>`
                ).join('');
            }
        }

        function checkHeaderComponents() {
            let correct = 0;
            let incorrect = 0;
            
            selectedHeaders.forEach(header => {
                if (header.getAttribute('data-valid') === 'true') {
                    header.classList.add('matched');
                    correct++;
                } else {
                    header.classList.add('incorrect-match');
                    incorrect++;
                }
            });
            
            // Check for missed valid components
            document.querySelectorAll('.match-item[data-type="header"][data-valid="true"]').forEach(item => {
                if (!item.classList.contains('selected')) {
                    item.classList.add('incorrect-match');
                }
            });
            
            const score = correct - incorrect;
            addXP(Math.max(score * 5, 0), 'header-components');
            
            if (incorrect === 0 && correct === 7) {
                checkAchievement('headerExpert');
            }
        }

        // Short Answer Checking
        function checkShortAnswer(textareaId, keywords) {
            const textarea = document.getElementById(textareaId);
            const answer = textarea.value.toLowerCase();
            
            if (answer.length < 30) {
                alert('Please provide a more detailed answer (at least 30 characters)');
                return;
            }
            
            let foundKeywords = 0;
            keywords.forEach(keyword => {
                if (answer.includes(keyword) || answer.includes(getSynonym(keyword))) {
                    foundKeywords++;
                }
            });
            
            const xpEarned = Math.min(foundKeywords * 10, 50);
            addXP(xpEarned, `short-answer-${textareaId}`);
            
            // Provide feedback
            const feedback = document.createElement('div');
            feedback.className = foundKeywords >= keywords.length / 2 ? 'success-message' : 'error-message';
            feedback.classList.add('show');
            feedback.textContent = `Good effort! You included ${foundKeywords} out of ${keywords.length} key concepts.`;
            textarea.parentElement.appendChild(feedback);
            
            setTimeout(() => feedback.remove(), 3000);
        }

        function getSynonym(keyword) {
            const synonyms = {
                'routing': 'route',
                'destination': 'target',
                'reassembly': 'reassemble',
                'order': 'sequence',
                'integrity': 'validity',
                'bandwidth': 'capacity',
                'congestion': 'traffic',
                'efficiency': 'efficient',
                'scalability': 'scalable',
                'flexible': 'flexibility',
                'resources': 'resource',
                'paths': 'routes'
            };
            return synonyms[keyword] || keyword;
        }

        // Routing Table Functions
        function addRoutingRow() {
            const tbody = document.querySelector('#routingTable tbody');
            const newRow = tbody.insertRow();
            for (let i = 0; i < 5; i++) {
                const cell = newRow.insertCell();
                const input = document.createElement('input');
                input.type = i >= 3 ? 'number' : 'text';
                input.className = 'routing-input';
                input.placeholder = getPlaceholder(i);
                cell.appendChild(input);
            }
        }

        function getPlaceholder(index) {
            const placeholders = [
                'e.g., 192.168.1.0',
                'e.g., 192.168.1.1',
                'e.g., eth0',
                'e.g., 10',
                'e.g., 2'
            ];
            return placeholders[index];
        }

        function checkRoutingTable() {
            const inputs = document.querySelectorAll('.routing-input');
            let valid = true;
            
            inputs.forEach(input => {
                if (input.value.trim() === '') {
                    valid = false;
                    input.style.borderColor = 'var(--danger)';
                } else {
                    input.style.borderColor = 'var(--success)';
                }
            });
            
            if (valid) {
                addXP(30, 'routing-table-complete');
                showAchievement('tableBuilder', 'Table Builder!', 'Successfully created a routing table!');
            }
        }

        // Circuit Switching Functions
        function showPacketMode() {
            const sim = document.getElementById('circuitSim');
            sim.innerHTML = `
                <div style="text-align: center; color: white;">
                    <h3>Packet Switching Mode</h3>
                    <p>Multiple packets taking different routes</p>
                    <div style="display: flex; justify-content: space-around; margin-top: 2rem;">
                        <div class="packet" style="position: relative; animation: movePacket1 3s infinite;">P1</div>
                        <div class="packet" style="position: relative; animation: movePacket2 3s infinite;">P2</div>
                        <div class="packet" style="position: relative; animation: movePacket3 3s infinite;">P3</div>
                    </div>
                </div>
            `;
            
            // Add CSS animations
            const style = document.createElement('style');
            style.textContent = `
                @keyframes movePacket1 {
                    0% { transform: translateX(0); }
                    50% { transform: translateX(200px) translateY(-50px); }
                    100% { transform: translateX(400px); }
                }
                @keyframes movePacket2 {
                    0% { transform: translateX(0); }
                    50% { transform: translateX(200px) translateY(50px); }
                    100% { transform: translateX(400px); }
                }
                @keyframes movePacket3 {
                    0% { transform: translateX(0); }
                    100% { transform: translateX(400px); }
                }
            `;
            document.head.appendChild(style);
            
            addXP(10, 'view-packet-mode');
        }

        function showCircuitMode() {
            const sim = document.getElementById('circuitSim');
            sim.innerHTML = `
                <div style="text-align: center; color: white;">
                    <h3>Circuit Switching Mode</h3>
                    <p>Dedicated path for all data</p>
                    <div style="position: relative; height: 200px; margin-top: 2rem;">
                        <div style="position: absolute; left: 10%; top: 50%; width: 80%; height: 4px; background: var(--gradient-3);"></div>
                        <div class="packet" style="position: absolute; left: 10%; top: 50%; transform: translateY(-50%); animation: moveCircuit 3s infinite;">Data Stream</div>
                    </div>
                </div>
            `;
            
            // Add CSS animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes moveCircuit {
                    0% { left: 10%; }
                    100% { left: 85%; }
                }
            `;
            document.head.appendChild(style);
            
            addXP(10, 'view-circuit-mode');
        }

        function resetComparisonSim() {
            document.getElementById('circuitSim').innerHTML = '';
        }

        // Categorization Functions
        function checkCategorization() {
            const packetFeatures = document.getElementById('packetFeatures');
            const circuitFeatures = document.getElementById('circuitFeatures');
            
            // Define correct categorizations
            const correctPacket = ['Bandwidth is shared', 'Packets may arrive out of order', 'Can reroute if problems occur', 'Efficient use of network resources'];
            const correctCircuit = ['Dedicated path', 'Connection setup required', 'Wasteful if not continuously used', 'Good for real-time applications'];
            
            let score = 0;
            
            // Check packet features
            packetFeatures.querySelectorAll('.match-item').forEach(item => {
                if (correctPacket.includes(item.textContent)) {
                    item.classList.add('matched');
                    score++;
                } else {
                    item.classList.add('incorrect-match');
                }
            });
            
            // Check circuit features
            circuitFeatures.querySelectorAll('.match-item').forEach(item => {
                if (correctCircuit.includes(item.textContent)) {
                    item.classList.add('matched');
                    score++;
                } else {
                    item.classList.add('incorrect-match');
                }
            });
            
            addXP(score * 5, 'categorization-complete');
            
            if (score === 8) {
                checkAchievement('comparePro');
            }
        }

        // Drag and drop functionality for categorization
        let draggedItem = null;

        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('match-item') && e.target.getAttribute('data-category') === 'feature') {
                if (draggedItem) {
                    draggedItem.classList.remove('selected');
                }
                draggedItem = e.target;
                draggedItem.classList.add('selected');
            } else if (e.target.classList.contains('match-target') || e.target.closest('.match-target')) {
                if (draggedItem) {
                    const target = e.target.classList.contains('match-target') ? e.target : e.target.closest('.match-target');
                    target.appendChild(draggedItem);
                    draggedItem.classList.remove('selected');
                    draggedItem = null;
                }
            }
        });

        // Case Study Functions
        function checkCaseStudy() {
            const answer = document.getElementById('caseStudy').value;
            
            if (answer.length < 100) {
                alert('Please provide a more detailed analysis (at least 100 characters)');
                return;
            }
            
            const keywords = ['packet', 'adaptive', 'bandwidth', 'efficiency', 'cdn', 'resilient'];
            let score = 0;
            
            keywords.forEach(keyword => {
                if (answer.toLowerCase().includes(keyword)) {
                    score++;
                }
            });
            
            addXP(score * 10, 'case-study-netflix');
            
            // Show feedback
            const feedback = document.createElement('div');
            feedback.className = 'success-message show';
            feedback.textContent = `Good analysis! You covered ${score} out of ${keywords.length} key points.`;
            document.getElementById('caseStudy').parentElement.appendChild(feedback);
            
            setTimeout(() => feedback.remove(), 3000);
        }

        // Ranking Functions
        function checkRanking() {
            const items = document.querySelectorAll('#rankingContainer .match-item');
            const correctOrder = ['Web browsing', 'Email', 'File download', 'Voice over IP (VoIP) call', 'Traditional telephone call'];
            
            let correct = 0;
            items.forEach((item, index) => {
                if (item.textContent === correctOrder[index]) {
                    item.classList.add('matched');
                    correct++;
                } else {
                    item.classList.add('incorrect-match');
                }
            });
            
            addXP(correct * 5, 'ranking-applications');
            
            // Show correct order after delay
            if (correct < 5) {
                setTimeout(() => {
                    const container = document.getElementById('rankingContainer');
                    container.innerHTML = '';
                    correctOrder.forEach(text => {
                        const item = document.createElement('div');
                        item.className = 'match-item matched';
                        item.textContent = text;
                        container.appendChild(item);
                    });
                }, 2000);
            }
        }

        // Make ranking items sortable by clicking
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('match-item') && e.target.getAttribute('data-rank') === 'true') {
                const container = e.target.parentElement;
                if (e.target.classList.contains('selected')) {
                    // Move down
                    const next = e.target.nextElementSibling;
                    if (next) {
                        container.insertBefore(next, e.target);
                    }
                } else {
                    // Select for moving
                    container.querySelectorAll('.match-item').forEach(item => item.classList.remove('selected'));
                    e.target.classList.add('selected');
                }
            }
        });

        // Canvas Functions
        let canvas, ctx, isDrawing = false;

        function initializeCanvas() {
            canvas = document.getElementById('drawingCanvas');
            if (!canvas) return;
            
            ctx = canvas.getContext('2d');
            
            // Set canvas size
            function resizeCanvas() {
                const rect = canvas.parentElement.getBoundingClientRect();
                canvas.width = rect.width - 4;
                canvas.height = 400;
            }
            
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            // Drawing events
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            // Touch events
            canvas.addEventListener('touchstart', handleTouch);
            canvas.addEventListener('touchmove', handleTouch);
            canvas.addEventListener('touchend', stopDrawing);
        }

        function startDrawing(e) {
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            ctx.beginPath();
            ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        }

        function draw(e) {
            if (!isDrawing) return;
            
            const rect = canvas.getBoundingClientRect();
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.strokeStyle = '#6366f1';
            
            ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
            ctx.stroke();
        }

        function stopDrawing() {
            if (isDrawing) {
                isDrawing = false;
                addXP(5, 'canvas-drawing');
            }
        }

        function handleTouch(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        }

        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function downloadCanvas() {
            const link = document.createElement('a');
            link.download = 'network-design.png';
            link.href = canvas.toDataURL();
            link.click();
            addXP(10, 'download-canvas');
        }

        // Final Quiz Functions
        function submitFinalQuiz() {
            const containers = document.querySelectorAll('#finalQuiz .quiz-container');
            let correct = 0;
            
            containers.forEach(container => {
                if (container.classList.contains('answered')) {
                    const selected = container.querySelector('.quiz-option.selected');
                    if (selected && selected.classList.contains('correct')) {
                        correct++;
                    }
                }
            });
            
            const total = containers.length;
            const percentage = (correct / total) * 100;
            
            const results = document.getElementById('quizResults');
            results.style.display = 'block';
            results.innerHTML = `
                <div class="context-box">
                    <h4>Quiz Results</h4>
                    <p>You scored ${correct} out of ${total} (${percentage.toFixed(0)}%)</p>
                    ${percentage === 100 ? '<p>🎉 Perfect score! Excellent work!</p>' : '<p>Review the questions you missed and try again!</p>'}
                </div>
            `;
            
            addXP(correct * 15, 'final-quiz');
            
            if (percentage === 100) {
                checkAchievement('examReady');
            }
        }

        // Exam Answer Functions
        function checkExamAnswer() {
            const answer = document.getElementById('examAnswer').value;
            const predictedMarks = document.getElementById('predictedMarks').value;
            
            if (answer.length < 150) {
                alert('Please provide a more detailed answer for a 6-mark question (at least 150 characters)');
                return;
            }
            
            // Check for key points
            const keyPoints = {
                efficiency: ['bandwidth', 'sharing', 'multiple users', 'statistical multiplexing'],
                resilience: ['alternative routes', 'reroute', 'retransmission', 'reliability'],
                resources: ['dynamic allocation', 'on demand', 'no waste', 'utilization']
            };
            
            let marksEarned = 0;
            let feedback = [];
            
            Object.entries(keyPoints).forEach(([category, keywords]) => {
                let categoryPoints = 0;
                keywords.forEach(keyword => {
                    if (answer.toLowerCase().includes(keyword)) {
                        categoryPoints++;
                    }
                });
                if (categoryPoints > 0) {
                    marksEarned += Math.min(categoryPoints, 2);
                    feedback.push(`✓ ${category}: ${Math.min(categoryPoints, 2)}/2 marks`);
                } else {
                    feedback.push(`✗ ${category}: 0/2 marks`);
                }
            });
            
            // Show mark scheme
            document.getElementById('markScheme').classList.add('visible');
            
            // Add feedback
            const feedbackDiv = document.createElement('div');
            feedbackDiv.className = 'context-box';
            feedbackDiv.innerHTML = `
                <h4>Your Score: ${marksEarned}/6</h4>
                ${feedback.map(f => `<p>${f}</p>`).join('')}
                ${predictedMarks ? `<p>Your prediction: ${predictedMarks}/6 (${Math.abs(predictedMarks - marksEarned) <= 1 ? 'Good prediction!' : 'Keep practicing your self-assessment'})</p>` : ''}
            `;
            document.getElementById('examAnswer').parentElement.appendChild(feedbackDiv);
            
            addXP(marksEarned * 10, 'exam-question');
        }

        // Complete Lesson
        function completeLesson() {
            // Calculate completion
            const totalXP = currentXP + (currentLevel * xpRequirements[currentLevel - 1]);
            
            // Show completion message
            const card = document.querySelector('#summary .card');
            const completion = document.createElement('div');
            completion.className = 'context-box';
            completion.style.background = 'var(--gradient-3)';
            completion.style.color = 'white';
            completion.innerHTML = `
                <h3>🎉 Congratulations!</h3>
                <p>You've completed the Packet & Circuit Switching lesson!</p>
                <p>Total XP earned: ${totalXP}</p>
                <p>Level reached: ${currentLevel}</p>
                <p>Achievements unlocked: ${earnedAchievements.size}</p>
            `;
            card.appendChild(completion);
            
            // Show all achievements
            displayAchievements();
            
            // Final celebration
            createParticles();
            addXP(50, 'lesson-complete');
        }

        function displayAchievements() {
            const list = document.getElementById('achievementsList');
            list.innerHTML = '<h4>Your Achievements:</h4>';
            
            earnedAchievements.forEach(id => {
                const achievement = achievements[id];
                if (achievement) {
                    const item = document.createElement('div');
                    item.style.margin = '0.5rem 0';
                    item.innerHTML = `<strong>${achievement.title}</strong> - ${achievement.desc} (+${achievement.xp} XP)`;
                    list.appendChild(item);
                }
            });
        }

        // Feedback System
        function openFeedback() {
            document.getElementById('feedbackModal').classList.add('show');
        }

        function closeFeedback() {
            document.getElementById('feedbackModal').classList.remove('show');
        }

        function sendFeedback() {
            const text = document.getElementById('feedbackText').value;
            if (!text.trim()) {
                alert('Please enter your feedback');
                return;
            }
            
            // Get current section and relevant code context
            const currentSectionElement = document.querySelector('.section.active');
            const sectionTitle = currentSectionElement.querySelector('h2').textContent;
            
            // Create email content
            const subject = `Packet Switching Lesson Feedback - ${sectionTitle}`;
            const body = `Feedback from: ${sectionTitle}\n\nUser Feedback:\n${text}\n\nTechnical Context:\nSection ID: ${currentSection}\nUser Level: ${currentLevel}\nUser XP: ${currentXP}`;
            
            // Create mailto link
            const mailtoLink = `mailto:millingtond@mgs.org?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.location.href = mailtoLink;
            
            closeFeedback();
            document.getElementById('feedbackText').value = '';
            
            // Thank the user
            showAchievement('feedback', 'Thanks for the Feedback!', 'Your input helps improve the lesson');
            addXP(10, 'feedback-sent');
        }

        // Save/Load Progress
        function saveProgress() {
            const progress = {
                currentXP,
                currentLevel,
                completedTasks: Array.from(completedTasks),
                earnedAchievements: Array.from(earnedAchievements),
                currentSection
            };
            localStorage.setItem('packetSwitchingProgress', JSON.stringify(progress));
        }

        function loadProgress() {
            try {
                const saved = localStorage.getItem('packetSwitchingProgress');
                if (saved) {
                    const progress = JSON.parse(saved);
                    currentXP = progress.currentXP || 0;
                    currentLevel = progress.currentLevel || 0;
                    completedTasks = new Set(progress.completedTasks || []);
                    earnedAchievements = new Set(progress.earnedAchievements || []);
                    currentSection = progress.currentSection || 'starter';
                    
                    updateXPDisplay();
                    navigateToSection(currentSection);
                }
            } catch (e) {
                console.error('Error loading progress:', e);
            }
        }

        // Keyboard Navigation
        document.addEventListener('keydown', function(e) {
            if (e.key === 'ArrowRight' || e.key === 'ArrowLeft') {
                const sections = ['starter', 'packet-basics', 'headers', 'routing', 'circuit', 'comparison', 'applications', 'summary'];
                const currentIndex = sections.indexOf(currentSection);
                
                if (e.key === 'ArrowRight' && currentIndex < sections.length - 1) {
                    navigateToSection(sections[currentIndex + 1]);
                } else if (e.key === 'ArrowLeft' && currentIndex > 0) {
                    navigateToSection(sections[currentIndex - 1]);
                }
            }
        });

        // Accessibility - Focus Management
        function manageFocus() {
            const activeSection = document.querySelector('.section.active');
            if (activeSection) {
                const firstFocusable = activeSection.querySelector('button, input, textarea, select');
                if (firstFocusable) {
                    firstFocusable.focus();
                }
            }
        }

        // Performance optimization - Debounce
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Optimized scroll handler
        const optimizedScroll = debounce(() => {
            // Update progress indicators based on scroll
            const sections = document.querySelectorAll('.section');
            const scrollPosition = window.scrollY + window.innerHeight / 2;
            
            sections.forEach((section, index) => {
                const rect = section.getBoundingClientRect();
                const top = rect.top + window.scrollY;
                const bottom = top + rect.height;
                
                if (scrollPosition >= top && scrollPosition <= bottom) {
                    // Update active nav item
                    const navItems = document.querySelectorAll('.nav-item');
                    navItems.forEach(item => item.classList.remove('active'));
                    navItems[index]?.classList.add('active');
                }
            });
        }, 100);

        window.addEventListener('scroll', optimizedScroll);

        // Touch gesture support for mobile
        let touchStartX = 0;
        let touchEndX = 0;

        document.addEventListener('touchstart', e => {
            touchStartX = e.changedTouches[0].screenX;
        });

        document.addEventListener('touchend', e => {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        });

        function handleSwipe() {
            const swipeThreshold = 50;
            const diff = touchStartX - touchEndX;
            
            if (Math.abs(diff) > swipeThreshold) {
                const sections = ['starter', 'packet-basics', 'headers', 'routing', 'circuit', 'comparison', 'applications', 'summary'];
                const currentIndex = sections.indexOf(currentSection);
                
                if (diff > 0 && currentIndex < sections.length - 1) {
                    // Swipe left - next section
                    navigateToSection(sections[currentIndex + 1]);
                } else if (diff < 0 && currentIndex > 0) {
                    // Swipe right - previous section
                    navigateToSection(sections[currentIndex - 1]);
                }
            }
        }

        // Extension activity handlers
        document.getElementById('extensionIPv6')?.addEventListener('input', debounce(function() {
            if (this.value.length > 50) {
                addXP(15, 'extension-ipv6');
            }
        }, 1000));

        document.getElementById('sdnExtension')?.addEventListener('input', debounce(function() {
            if (this.value.length > 50) {
                addXP(15, 'extension-sdn');
            }
        }, 1000));

        // Auto-save progress
        setInterval(saveProgress, 30000); // Save every 30 seconds

        // Handle window unload
        window.addEventListener('beforeunload', saveProgress);

        // Initialize tooltips
        document.querySelectorAll('[title]').forEach(element => {
            const title = element.getAttribute('title');
            element.removeAttribute('title');
            
            const tooltip = document.createElement('span');
            tooltip.className = 'tooltiptext';
            tooltip.textContent = title;
            
            const wrapper = document.createElement('span');
            wrapper.className = 'tooltip';
            element.parentNode.insertBefore(wrapper, element);
            wrapper.appendChild(element);
            wrapper.appendChild(tooltip);
        });

        // Reduced motion support
        if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
            document.documentElement.style.setProperty('--animation-duration', '0.01s');
        }

        // Error handling
        window.addEventListener('error', function(e) {
            console.error('Error occurred:', e);
            // Could send error to feedback system
        });

        // Performance monitoring
        if ('performance' in window) {
            window.addEventListener('load', function() {
                const perfData = window.performance.timing;
                const loadTime = perfData.loadEventEnd - perfData.navigationStart;
                console.log('Page load time:', loadTime + 'ms');
            });
        }

        // Initialize everything when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }

        function init() {
            preventPasting();
            initializeEventListeners();
            updateXPDisplay();
            initializeCanvas();
            loadProgress();
            manageFocus();
        }
    </script>
</body>
</html>