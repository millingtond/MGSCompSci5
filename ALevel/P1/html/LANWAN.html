<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A-Level CS: Networks Lesson</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Open+Sans:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* CSS Variables for theming and accessibility */
        :root {
            --font-main: 'Inter', sans-serif;
            --font-dyslexia: 'Open Sans', sans-serif;

            --color-bg: #f0f4f8;
            --color-surface: #ffffff;
            --color-text: #1e293b;
            --color-text-muted: #64748b;
            --color-primary: #3b82f6;
            --color-primary-dark: #2563eb;
            --color-accent: #10b981;
            --color-accent-dark: #059669;
            --color-danger: #ef4444;
            --color-warning: #f59e0b;
            --color-border: #cbd5e1;
            --color-disabled: #94a3b8;
            
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            
            --font-size-base: 16px;
            --font-size-sm: 0.875rem;
            --font-size-lg: 1.125rem;
            --font-size-xl: 1.25rem;
            --font-size-2xl: 1.5rem;
        }

        /* High Contrast Theme */
        body.high-contrast {
            --color-bg: #000000;
            --color-surface: #121212;
            --color-text: #ffffff;
            --color-text-muted: #cccccc;
            --color-primary: #38bdf8;
            --color-primary-dark: #0ea5e9;
            --color-accent: #4ade80;
            --color-accent-dark: #22c55e;
            --color-danger: #f87171;
            --color-warning: #facc15;
            --color-border: #666666;
        }

        /* Font Size Themes */
        body.font-size-large { --font-size-base: 18px; }
        body.font-size-xlarge { --font-size-base: 20px; }
        
        /* Dyslexia-friendly font */
        body.dyslexia-font { --font-main: var(--font-dyslexia); }

        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--color-bg);
            color: var(--color-text);
            font-size: var(--font-size-base);
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
            overflow-x: hidden;
        }

        #app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }

        header {
            background-color: var(--color-surface);
            padding: 1rem;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--color-border);
        }
        
        .main-header {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        .main-header h1 {
            font-size: var(--font-size-2xl);
            color: var(--color-primary);
            cursor: default;
        }

        .main-header h1 .easter-egg-trigger {
            display: inline-block;
            width: 2rem;
            height: 2rem;
        }

        .controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .control-btn {
            background-color: transparent;
            border: 1px solid var(--color-border);
            color: var(--color-text-muted);
            padding: 0.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }
        .control-btn:hover {
            background-color: var(--color-primary);
            color: white;
        }
        .control-btn.active {
            background-color: var(--color-primary);
            color: white;
            border-color: var(--color-primary-dark);
        }

        .gamification-stats {
            width: 100%;
            margin-top: 1rem;
        }
        .xp-bar-container {
            width: 100%;
            background-color: var(--color-border);
            border-radius: 999px;
            height: 2rem;
            position: relative;
            overflow: hidden;
        }
        #xp-bar {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, var(--color-primary) 0%, var(--color-accent) 100%);
            border-radius: 999px;
            transition: width 0.5s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #xp-text {
            color: white;
            font-weight: 600;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            z-index: 2;
        }

        nav {
            margin-top: 1rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
        }
        #top-nav {
            display: flex;
            gap: 0.5rem;
            list-style: none;
            padding: 0;
            margin: 0;
            white-space: nowrap;
        }
        .nav-item a {
            display: block;
            padding: 0.5rem 1rem;
            background-color: var(--color-bg);
            color: var(--color-text-muted);
            text-decoration: none;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s;
        }
        .nav-item a:hover {
            background-color: var(--color-primary);
            color: white;
        }
        .nav-item.active a {
            background-color: var(--color-primary);
            color: white;
            box-shadow: var(--shadow-sm);
        }

        main {
            flex-grow: 1;
            background-color: var(--color-surface);
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--color-border);
            position: relative;
            overflow: hidden; /* For page transitions */
        }
        
        .page {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }
        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h2 {
            font-size: var(--font-size-2xl);
            color: var(--color-primary-dark);
            margin-bottom: 1rem;
            border-bottom: 2px solid var(--color-border);
            padding-bottom: 0.5rem;
        }
        h3 {
            font-size: var(--font-size-xl);
            color: var(--color-text);
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
        }
        p, li {
            margin-bottom: 1rem;
        }
        strong {
            color: var(--color-primary-dark);
        }
        .content-box {
            background-color: var(--color-bg);
            padding: 1rem;
            border-radius: 0.5rem;
            border-left: 4px solid var(--color-primary);
            margin: 1.5rem 0;
        }
        .content-box.mistake {
             border-left-color: var(--color-danger);
        }
         .content-box.context {
             border-left-color: var(--color-accent);
        }

        .btn {
            display: inline-block;
            background-color: var(--color-primary);
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            transition: background-color 0.2s, transform 0.1s;
            box-shadow: var(--shadow-sm);
        }
        .btn:hover {
            background-color: var(--color-primary-dark);
        }
        .btn:active {
            transform: translateY(1px);
        }
        .btn-secondary {
            background-color: var(--color-text-muted);
        }
        .btn-secondary:hover {
            background-color: #475569;
        }
        .btn-accent {
            background-color: var(--color-accent);
        }
        .btn-accent:hover {
            background-color: var(--color-accent-dark);
        }
        .btn:disabled {
            background-color: var(--color-disabled);
            cursor: not-allowed;
        }

        .task-controls {
            margin-top: 1rem;
            display: flex;
            gap: 0.5rem;
        }

        /* Navigation Buttons */
        .page-navigation {
            margin-top: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .page-navigation .btn {
            min-width: 120px;
            text-align: center;
        }

        /* Interactive Task Styles */
        .mcq-options, .true-false-options {
            list-style: none;
            padding: 0;
        }
        .mcq-options li, .true-false-options li {
            background-color: var(--color-bg);
            border: 2px solid var(--color-border);
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .mcq-options li:hover, .true-false-options li:hover {
            border-color: var(--color-primary);
            transform: translateY(-2px);
        }
        .mcq-options li.correct, .true-false-options li.correct {
            background-color: #dcfce7;
            border-color: var(--color-accent);
            color: var(--color-accent-dark);
            font-weight: bold;
        }
        .mcq-options li.incorrect, .true-false-options li.incorrect {
            background-color: #fee2e2;
            border-color: var(--color-danger);
            color: #b91c1c;
            font-weight: bold;
        }
        .mcq-options.answered li, .true-false-options.answered li {
            cursor: not-allowed;
            opacity: 0.8;
        }
        .mcq-options.answered li:hover, .true-false-options.answered li:hover {
             transform: none;
        }
        
        .matching-task {
            display: flex;
            flex-wrap: wrap;
            gap: 2rem;
            justify-content: space-around;
        }
        .matching-column {
            flex: 1;
            min-width: 250px;
        }
        .matching-items { list-style: none; padding: 0; }
        .matching-item {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background-color: var(--color-bg);
            border-radius: 0.5rem;
            cursor: pointer;
            border: 2px solid var(--color-border);
            transition: all 0.2s;
        }
        .matching-item:hover {
            border-color: var(--color-primary);
            transform: translateY(-2px);
        }
        .matching-item.selected {
            background-color: var(--color-warning);
            color: black;
            border-color: var(--color-warning);
        }
        .matching-item.matched {
             opacity: 0.5;
             cursor: not-allowed;
             background-color: #e0e0e0;
             text-decoration: line-through;
        }

        .drop-target {
            padding: 1rem;
            margin-bottom: 0.5rem;
            background-color: var(--color-surface);
            border-radius: 0.5rem;
            border: 2px dashed var(--color-border);
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            cursor: pointer;
        }
        .drop-target:hover, .drop-target.selected-target {
            border-color: var(--color-primary);
            background-color: #eff6ff;
        }
        .drop-target.correct {
            background-color: #dcfce7;
            border-color: var(--color-accent);
            color: var(--color-accent-dark);
            font-weight: 600;
            border-style: solid;
        }
        .drop-target.incorrect {
             animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        textarea, input[type="text"], input[type="number"] {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid var(--color-border);
            font-family: var(--font-main);
            font-size: var(--font-size-base);
            background-color: var(--color-bg);
            color: var(--color-text);
        }
        textarea {
            min-height: 150px;
            resize: vertical;
        }

        .mark-scheme {
            margin-top: 1.5rem;
            background-color: #fffbeb;
            color: #713f12;
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #fde68a;
            display: none;
        }

        .drawing-canvas-container {
            margin-top: 1rem;
            text-align: center;
        }
        #drawing-canvas {
            border: 2px solid var(--color-border);
            border-radius: 0.5rem;
            cursor: crosshair;
            touch-action: none;
        }

        /* Achievement Popup */
        #achievement-popup {
            position: fixed;
            bottom: -150px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--color-accent);
            color: white;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            transition: bottom 0.5s ease-in-out;
            text-align: center;
            width: 90%;
            max-width: 400px;
        }
        #achievement-popup.show {
            bottom: 20px;
        }
        #achievement-popup h4 {
            font-size: 1.25rem;
            margin: 0 0 0.5rem 0;
            color: white;
        }
        #achievement-popup p {
            margin: 0;
            opacity: 0.9;
        }

        /* Feedback Button and Modal */
        #feedback-widget {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 998;
        }
        #feedback-btn {
            background-color: var(--color-warning);
            color: black;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 1.5rem;
            box-shadow: var(--shadow-md);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }
        #feedback-btn:hover {
            transform: scale(1.1);
        }

        #feedback-modal, #shame-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1001;
        }
        .modal-content {
            background-color: var(--color-surface);
            padding: 2rem;
            border-radius: 1rem;
            width: 90%;
            max-width: 500px;
            box-shadow: var(--shadow-lg);
        }
        #shame-modal .modal-content {
            background-color: #450a0a;
            color: #fecaca;
            text-align: center;
        }
        .modal-content h3 {
            margin-top: 0;
        }

        /* Client-Server Sim Styles */
        .computer-icon {
            width: 80px;
            height: 80px;
            position: absolute;
            transition: all 0.5s ease-in-out, box-shadow 0.3s ease-in-out;
            cursor: pointer;
        }
        .server-icon {
            width: 100px;
            height: 100px;
        }
        .computer-icon.glow {
            box-shadow: 0 0 25px 5px #3b82f6;
            transform: scale(1.05);
        }
        .data-packet {
            position: absolute;
            width: 30px;
            height: 30px;
            background-color: #f59e0b;
            border: 2px solid white;
            border-radius: 50%;
            opacity: 0;
            transition: all 1s ease-in-out;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: white;
            box-shadow: 0 0 10px #f59e0b;
        }
        .line {
            position: absolute;
            background-color: #9ca3af;
            transform-origin: 0 50%;
            z-index: -1;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        .info-btn.active {
            background-color: #3b82f6;
            color: white;
            transform: scale(1.05);
        }
        .info-btn.drawback.active {
            background-color: #ef4444;
            color: white;
        }
        .quiz-option.correct {
            background-color: #22c55e !important;
            color: white !important;
            border-color: #16a34a;
        }
        .quiz-option.incorrect {
            background-color: #ef4444 !important;
            color: white !important;
            border-color: #dc2626;
        }
        
        /* New P2P Sim Styles */
        .peer {
            position: absolute;
            width: 100px;
            height: 110px;
            transition: all 0.5s ease, box-shadow 0.3s ease;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            opacity: 0;
            transform: scale(0.5);
        }
        .peer.visible {
            opacity: 1;
            transform: scale(1);
        }
        .peer-icon {
            width: 70px;
            height: 70px;
            padding: 10px;
            background-color: white;
            border: 3px solid #60a5fa;
            border-radius: 50%;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .peer.infected .peer-icon {
            border-color: #ef4444;
            animation: pulse-red 2s infinite;
        }
        .peer.offline .peer-icon {
            filter: grayscale(100%);
            border-color: #9ca3af;
        }
        .peer.selected .peer-icon {
            box-shadow: 0 0 25px 5px #f59e0b;
            transform: scale(1.1);
        }
        .peer-label {
            margin-top: 5px;
            font-weight: 600;
            text-align: center;
            font-size: 0.875rem;
            color: #374151;
        }
        .peer-label span {
            font-size: 0.75rem;
            font-weight: 400;
            color: #6b7280;
            display: block;
        }
        .peer.offline .peer-label {
            color: #9ca3af;
        }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .p2p-data-packet {
            position: absolute;
            width: 30px;
            height: 30px;
            background-color: #f97316;
            border-radius: 50%;
            z-index: 10;
            transition: all 1.2s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0;
            transform: scale(0);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            box-shadow: 0 0 15px #f97316;
        }
        #p2p-network-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }
        
        /* LAN/WAN SIM STYLES */
        .lws-sim-container {
            background-color: #e0f2fe;
            background-image: var(--bg-image, none);
            background-size: cover;
            background-position: center;
            transition: all 0.8s ease-in-out;
        }
        .lws-device {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 80px;
            transition: all 0.5s ease-in-out;
            cursor: pointer;
            z-index: 5;
        }
        .lws-device-icon {
            width: 50px;
            height: 50px;
            padding: 8px;
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            border: 2px solid;
            transition: all 0.3s ease;
        }
        .lws-device.selected .lws-device-icon {
            transform: scale(1.1);
            box-shadow: 0 0 20px 3px var(--tw-shadow-color);
        }
        .lws-client .lws-device-icon { border-color: #3b82f6; }
        .lws-server .lws-device-icon { border-color: #16a34a; width: 60px; height: 60px; }
        .lws-switch .lws-device-icon { border-color: #9333ea; }
        .lws-router .lws-device-icon { border-color: #f59e0b; }
        .lws-device-label {
            margin-top: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            color: #4b5563;
            text-align: center;
            background: rgba(255,255,255,0.7);
            padding: 0 4px;
            border-radius: 4px;
        }
        .lws-lan-area {
            position: absolute;
            border: 3px dashed #6b7280;
            background-color: rgba(255, 255, 255, 0.5);
            border-radius: 1rem;
            transition: all 0.8s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: #4b5563;
            font-size: 1.5rem;
            z-index: 1; /* Keep LAN area behind the cloud */
        }
        .lws-wan-cloud {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            height: 150px;
            background: #93c5fd;
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            z-index: 2; /* Ensure cloud is above LAN areas */
        }
        .lws-wan-cloud-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: 700;
            font-size: 2.25rem; /* Larger text */
            color: #1e3a8a; /* Darker blue for better contrast */
            z-index: 3; /* Ensure text is on top of the cloud shape */
        }
        .lws-wan-cloud::before, .lws-wan-cloud::after {
            content: '';
            position: absolute;
            background: #93c5fd;
            border-radius: 50%;
        }
        .lws-wan-cloud::before { width: 180px; height: 180px; top: -90px; left: 60px; }
        .lws-wan-cloud::after { width: 120px; height: 120px; top: -40px; right: 50px; }
        .lws-packet {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            z-index: 10;
            opacity: 0;
            box-shadow: 0 0 8px 2px var(--tw-shadow-color);
        }
        .lws-lan-packet { background-color: #3b82f6; --tw-shadow-color: #3b82f6; }
        .lws-wan-packet { background-color: #ef4444; --tw-shadow-color: #ef4444; }
        .lws-popup {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%) translateY(-200%);
            padding: 12px 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 100;
            transition: transform 0.4s ease-in-out;
            border-left: 5px solid;
            max-width: 90%;
            text-align: center;
        }
        .lws-popup.show { transform: translateX(-50%) translateY(0); }
        .lws-popup.info { border-color: #3b82f6; }
        .lws-popup.warning { border-color: #f59e0b; }
        #lws-quiz-section .quiz-option.correct {
            background-color: #22c55e !important;
            color: white !important;
            border-color: #16a34a !important;
        }
        #lws-quiz-section .quiz-option.incorrect {
            background-color: #ef4444 !important;
            color: white !important;
            border-color: #b91c1c !important;
        }
        
        /* PSTN Simulation Styles */
        .pstn-device {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: all 0.5s ease;
            cursor: pointer;
        }
        .pstn-device-icon {
            width: 60px;
            height: 60px;
            padding: 10px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border: 2px solid var(--color-primary);
            transition: all 0.3s ease;
        }
        .pstn-device.active .pstn-device-icon {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
        }
        .pstn-device-label {
            margin-top: 5px;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--color-text);
            background: rgba(255,255,255,0.8);
            padding: 2px 8px;
            border-radius: 4px;
        }
        .signal-wave {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid var(--color-primary);
            opacity: 0;
            animation: signal-pulse 2s infinite;
        }
        @keyframes signal-pulse {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(3); opacity: 0; }
        }
        .data-conversion-box {
            position: absolute;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.5s ease;
            z-index: 20;
        }
        .pstn-line {
            position: absolute;
            height: 2px;
            background: #6b7280;
            transform-origin: 0 50%;
            z-index: -1;
            transition: background-color 0.3s ease;
        }
        .pstn-line.active {
            background: var(--color-primary);
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }
        
        /* Cell Tower Simulation Styles */
        .cell-tower {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: all 0.5s ease;
        }
        .cell-tower-icon {
            width: 80px;
            height: 100px;
            position: relative;
        }
        .tower-base {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 70px;
            background: #4b5563;
        }
        .tower-antenna {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 20px;
            background: #6b7280;
            border-radius: 10px;
        }
        .coverage-area {
            position: absolute;
            border-radius: 50%;
            background: rgba(59, 130, 246, 0.1);
            border: 2px dashed rgba(59, 130, 246, 0.3);
            transition: all 0.5s ease;
            z-index: -2;
        }
        .coverage-area.active {
            background: rgba(16, 185, 129, 0.15);
            border-color: rgba(16, 185, 129, 0.5);
            animation: coverage-pulse 2s infinite;
        }
        @keyframes coverage-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .mobile-device {
            position: absolute;
            width: 50px;
            height: 50px;
            cursor: pointer;
            transition: all 0.5s ease;
        }
        .mobile-device-icon {
            width: 100%;
            height: 100%;
            background: white;
            border: 3px solid #3b82f6;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        .mobile-device.connected {
            transform: scale(1.1);
        }
        .mobile-device.connected .mobile-device-icon {
            border-color: #10b981;
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.5);
        }
        .signal-strength {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.75rem;
            font-weight: 600;
            background: white;
            padding: 2px 8px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .handoff-animation {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }
        .handoff-line {
            stroke: #f59e0b;
            stroke-width: 3;
            fill: none;
            stroke-dasharray: 5, 5;
            opacity: 0;
            animation: handoff-dash 1s linear infinite;
        }
        @keyframes handoff-dash {
            to { stroke-dashoffset: -10; }
        }
        
        @media (max-width: 768px) {
            .main-header { flex-direction: column; align-items: flex-start; }
            .matching-task { flex-direction: column; }
            #feedback-widget { bottom: 70px; }
            .page-navigation { flex-direction: column; gap: 1rem; }
            .page-navigation .btn { width: 100%; }
        }

    </style>
</head>
<body>

    <div id="app-container">
        <header>
            <div class="main-header">
                <h1>
                    A-Level CS: Networks 
                    <span class="easter-egg-trigger" title="What's this?"></span>
                </h1>
                <div class="controls">
                    <button id="contrast-toggle" class="control-btn" title="Toggle High Contrast">üé®</button>
                    <button id="font-size-toggle" class="control-btn" title="Cycle Font Size">Aa</button>
                    <button id="dyslexia-toggle" class="control-btn" title="Toggle Dyslexia-friendly Font">Abc</button>
                </div>
            </div>
            <div class="gamification-stats">
                <div class="xp-bar-container">
                    <div id="xp-bar">
                        <span id="xp-text">Level 1: 0/100 XP</span>
                    </div>
                </div>
            </div>
            <nav>
                <ul id="top-nav">
                    <!-- Nav items will be generated by JS -->
                </ul>
            </nav>
        </header>

        <main id="main-content">
            <!-- Page content will be injected here -->
            <div id="page-0" class="page">
                <h2>Welcome & Learning Outcomes</h2>
                <p>Welcome to this interactive lesson on computer networks. Today, we will explore the fundamental building blocks of how computers communicate with each other.</p>
                <p>By the end of this lesson, you will be able to:</p>
                <div class="content-box">
                    <ul>
                        <li>Define and differentiate between a Local Area Network (LAN) and a Wide Area Network (WAN).</li>
                        <li>Describe the function of a server and provide examples of different server types.</li>
                        <li>Explain the features of the client-server and peer-to-peer network models.</li>
                        <li>Compare the benefits and drawbacks of the client-server and peer-to-peer models.</li>
                        <li>Describe the hardware that is used to support the internet, including modems, PSTN, dedicated lines, and cell phone networks.</li>
                        <li>Apply your knowledge to exam-style questions.</li>
                    </ul>
                </div>
                <p>Use the navigation bar above or the buttons below to move through the sections. Complete the tasks to earn XP and level up!</p>
            </div>
            
            <div id="page-1" class="page">
                <h2>Starter: LAN vs. WAN Characteristics</h2>
                <p>Let's start by testing your initial knowledge. Below are several characteristics of networks. Click a characteristic, then click on the box (LAN or WAN) where you think it belongs. Complete the task to earn your first achievement!</p>
                
                <div id="starter-task" class="matching-task">
                    <div class="matching-column">
                        <h3>Characteristics</h3>
                        <ul class="matching-items" id="starter-items">
                            <!-- Items will be generated by JS -->
                        </ul>
                    </div>
                    <div class="matching-column">
                        <h3>LAN (Local Area Network)</h3>
                        <div class="drop-target" data-category="LAN"></div>
                        <div class="drop-target" data-category="LAN"></div>
                        <div class="drop-target" data-category="LAN"></div>
                    </div>
                    <div class="matching-column">
                        <h3>WAN (Wide Area Network)</h3>
                        <div class="drop-target" data-category="WAN"></div>
                        <div class="drop-target" data-category="WAN"></div>
                        <div class="drop-target" data-category="WAN"></div>
                    </div>
                </div>
                <div class="task-controls">
                    <button class="btn btn-secondary" id="reset-starter">Reset Task</button>
                </div>
            </div>

            <div id="page-2" class="page">
                <!-- LAN/WAN/Server Simulation -->
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                    <div class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-lg">
                        <h2 class="text-2xl font-bold mb-4 border-b pb-2">LAN/WAN Simulation</h2>
                        <div id="lws-instruction-box" class="text-gray-700 space-y-4" aria-live="polite"></div>
                        <div id="lws-controls" class="mt-6 space-y-3"></div>
                    </div>
                    <div class="lg:col-span-3 bg-gray-200 p-4 rounded-2xl shadow-lg min-h-[550px] lg:min-h-[650px] relative overflow-hidden">
                        <div id="lws-popup-container"></div>
                        <div id="lws-simulation-area" class="w-full h-full relative lws-sim-container">
                            <canvas id="lws-network-canvas" class="absolute top-0 left-0 w-full h-full z-0"></canvas>
                        </div>
                    </div>
                </div>
                <div id="lws-quiz-section" class="mt-8 bg-white p-6 rounded-2xl shadow-lg hidden">
                    <h2 class="text-2xl md:text-3xl font-bold text-center mb-6">Test Your Knowledge</h2>
                    <div id="lws-quiz-content" class="max-w-2xl mx-auto"></div>
                    <div id="lws-quiz-feedback" class="text-center mt-4 font-semibold text-lg h-8"></div>
                    <div class="mt-6 flex justify-center space-x-4">
                        <button id="lws-next-question-btn" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition-all transform hover:scale-105 hidden">Next Question</button>
                        <button id="lws-restart-btn" class="bg-gray-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-gray-700 transition-all transform hover:scale-105 hidden">Restart</button>
                    </div>
                </div>
            </div>

            <div id="page-3" class="page">
                <h2>LANs, WANs, and Servers Tasks</h2>
                <p>Networks are classified by the geographical area they cover. The two main types are <strong>Local Area Networks (LANs)</strong> and <strong>Wide Area Networks (WANs)</strong>.</p>
            
                <h3>Task 1: LAN or WAN?</h3>
                <p>Read the scenarios below. Is it describing a LAN or a WAN? Click a scenario, then click the correct category box.</p>
                <div id="lan-wan-scenario-task" class="matching-task">
                    <div class="matching-column">
                        <h4>Scenarios</h4>
                        <ul class="matching-items" id="lan-wan-scenario-items">
                            <!-- JS will populate this -->
                        </ul>
                    </div>
                    <div class="matching-column">
                        <h4>LAN Scenarios</h4>
                        <div class="drop-target" data-category="LAN"></div>
                        <div class="drop-target" data-category="LAN"></div>
                        <div class="drop-target" data-category="LAN"></div>
                    </div>
                    <div class="matching-column">
                        <h4>WAN Scenarios</h4>
                        <div class="drop-target" data-category="WAN"></div>
                        <div class="drop-target" data-category="WAN"></div>
                        <div class="drop-target" data-category="WAN"></div>
                    </div>
                </div>
                <div class="task-controls">
                    <button class="btn btn-secondary" id="reset-lan-wan-scenario">Reset Task</button>
                </div>
            
                <h3 style="margin-top: 2rem;">Task 2: Match the Server to its Job</h3>
                <p>A <strong>server</strong> provides a service to other computers (clients). Match the descriptions on the left to the correct server type on the right.</p>
                <div id="server-matching-task" class="matching-task">
                    <div class="matching-column">
                        <h4>Description</h4>
                        <ul class="matching-items" id="server-desc-items">
                            <!-- JS will populate this -->
                        </ul>
                    </div>
                    <div class="matching-column">
                        <h4>Server Type</h4>
                        <div class="drop-target" data-category="web">Web Server</div>
                        <div class="drop-target" data-category="file">File Server</div>
                        <div class="drop-target" data-category="mail">Mail Server</div>
                        <div class="drop-target" data-category="print">Print Server</div>
                    </div>
                </div>
                 <div class="task-controls">
                    <button class="btn btn-secondary" id="reset-server-matching">Reset Task</button>
                </div>
            </div>
            
            <div id="page-4" class="page">
                <div class="container mx-auto p-4 md:p-8 max-w-5xl">
                    <header class="text-center mb-8">
                        <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Interactive Simulation: The Client-Server Network</h1>
                        <p class="text-md text-gray-600 mt-2">For OCR J277 GCSE Computer Science</p>
                    </header>
            
                    <div id="simulation-container" class="bg-white rounded-lg shadow-xl p-6 min-h-[500px] relative overflow-hidden">
                        <div id="network-area" class="w-full h-[400px] relative mb-4">
                            <!-- Server and clients will be injected here -->
                        </div>
                        <div id="explanation-box" class="bg-blue-50 border-l-4 border-blue-500 text-blue-800 p-4 rounded-md min-h-[80px] flex items-center justify-center text-center" aria-live="polite">
                            <p id="explanation-text" class="text-lg">Welcome! Click the "Start" button to begin the simulation.</p>
                        </div>
                         <div class="mt-6 flex justify-center">
                            <button id="cs-next-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition-transform duration-300 transform hover:scale-105">Start Simulation</button>
                        </div>
                    </div>
            
                    <div id="info-section" class="mt-8 bg-white rounded-lg shadow-xl p-6 hidden">
                        <h2 class="text-2xl font-bold text-center mb-2">Exploring the Model</h2>
                        <p class="text-center text-gray-600 mb-6">Click on the buttons below to learn about the pros and cons.</p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div>
                                <h3 class="text-xl font-bold text-center mb-4 text-green-600">Benefits</h3>
                                <div class="grid grid-cols-2 gap-3">
                                    <button class="info-btn benefit bg-gray-200 p-3 rounded-lg hover:bg-gray-300 transition-all text-sm md:text-base" data-key="storage">üìÇ Central Storage</button>
                                    <button class="info-btn benefit bg-gray-200 p-3 rounded-lg hover:bg-gray-300 transition-all text-sm md:text-base" data-key="backup">üíæ Central Backups</button>
                                    <button class="info-btn benefit bg-gray-200 p-3 rounded-lg hover:bg-gray-300 transition-all text-sm md:text-base" data-key="security">üõ°Ô∏è Central Security</button>
                                    <button class="info-btn benefit bg-gray-200 p-3 rounded-lg hover:bg-gray-300 transition-all text-sm md:text-base" data-key="upgrade">‚¨ÜÔ∏è Central Upgrades</button>
                                </div>
                            </div>
                             <div>
                                <h3 class="text-xl font-bold text-center mb-4 text-red-600">Drawbacks</h3>
                                <div class="grid grid-cols-2 gap-3">
                                      <button class="info-btn drawback bg-gray-200 p-3 rounded-lg hover:bg-gray-300 transition-all text-sm md:text-base" data-key="failure">‚ò†Ô∏è Single Point of Failure</button>
                                      <button class="info-btn drawback bg-gray-200 p-3 rounded-lg hover:bg-gray-300 transition-all text-sm md:text-base" data-key="cost">üí∞ High Cost</button>
                                      <button class="info-btn drawback bg-gray-200 p-3 rounded-lg hover:bg-gray-300 transition-all text-sm md:text-base" data-key="expertise">üßë‚Äçüîß Specialist Staff Needed</button>
                                </div>
                            </div>
                        </div>
                    </div>
            
            
                    <div id="cs-quiz-container" class="mt-8 bg-white rounded-lg shadow-xl p-6 hidden">
                        <h2 class="text-2xl font-bold text-center mb-6">Test Your Knowledge</h2>
                        <div id="cs-quiz-content">
                            <!-- Quiz questions will be injected here -->
                        </div>
                        <div id="cs-quiz-feedback" class="text-center mt-4 font-semibold h-6"></div>
                        <div class="mt-6 flex justify-center space-x-4">
                              <button id="cs-next-question-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors hidden">Next Question</button>
                              <button id="cs-restart-btn" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600 transition-colors hidden">Restart Simulation</button>
                        </div>
                    </div>
            
                </div>
            </div>

            <div id="page-5" class="page">
                <div id="p2p-main-content" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
                    <!-- Left Panel: Instructions and Controls -->
                    <div class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-lg">
                        <h2 class="text-2xl font-bold mb-4 border-b pb-2">P2P Simulation</h2>
                        <div id="p2p-instruction-box" class="text-gray-700 space-y-4" aria-live="polite">
                            <!-- Instructions will be injected here -->
                        </div>
                        <div id="p2p-controls" class="mt-6 space-y-3">
                            <!-- Controls will be injected here -->
                        </div>
                    </div>
        
                    <!-- Center Panel: Simulation Area -->
                    <div class="lg:col-span-2 bg-white p-4 rounded-2xl shadow-lg min-h-[500px] lg:min-h-[600px] relative overflow-hidden">
                        <div id="p2p-popup-container"></div>
                        <div id="p2p-network-area" class="w-full h-full relative">
                            <canvas id="p2p-network-canvas"></canvas>
                            <!-- Peers will be injected here -->
                        </div>
                    </div>
        
                </div>
        
                <!-- Quiz Section -->
                <div id="p2p-quiz-section" class="mt-8 bg-white p-6 rounded-2xl shadow-lg hidden">
                    <h2 class="text-2xl md:text-3xl font-bold text-center mb-6">Test Your Knowledge</h2>
                    <div id="p2p-quiz-content" class="max-w-2xl mx-auto">
                        <!-- Quiz questions appear here -->
                    </div>
                    <div id="p2p-quiz-feedback" class="text-center mt-4 font-semibold text-lg h-8"></div>
                    <div class="mt-6 flex justify-center space-x-4">
                        <button id="p2p-next-question-btn" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition-all transform hover:scale-105 hidden">Next Question</button>
                        <button id="p2p-restart-btn" class="bg-gray-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-gray-700 transition-all transform hover:scale-105 hidden">Restart</button>
                    </div>
                </div>
            </div>

            <div id="page-6" class="page">
                <h2>Task: Comparing Network Models</h2>
                <p>You've seen both models in action. Now, sort the following statements into the correct category: Client-Server or Peer-to-Peer. Click a statement, then click the box it belongs to.</p>
                
                <div id="model-comparison-task" class="matching-task">
                    <div class="matching-column">
                        <h3>Statements</h3>
                        <ul class="matching-items" id="model-comparison-items">
                           <!-- Items will be generated by JS -->
                        </ul>
                    </div>
                    <div class="matching-column">
                        <h3>Client-Server</h3>
                        <div class="drop-target" data-category="CS"></div>
                        <div class="drop-target" data-category="CS"></div>
                        <div class="drop-target" data-category="CS"></div>
                        <div class="drop-target" data-category="CS"></div>
                    </div>
                    <div class="matching-column">
                        <h3>Peer-to-Peer</h3>
                        <div class="drop-target" data-category="P2P"></div>
                        <div class="drop-target" data-category="P2P"></div>
                        <div class="drop-target" data-category="P2P"></div>
                        <div class="drop-target" data-category="P2P"></div>
                    </div>
                </div>
                <div class="task-controls">
                    <button class="btn btn-secondary" id="reset-model-comparison">Reset Task</button>
                </div>

                <div class="content-box mistake">
                    <h3>Common Mistakes</h3>
                    <p>A common error is thinking P2P is only for illegal activities. While it's known for torrents, legitimate applications like Skype (in its early days) and some online games use P2P technology to reduce server load.</p>
                </div>
            </div>

            <div id="page-7" class="page">
                <h2>Summary Quiz</h2>
                <p>Let's check your understanding of the key concepts from this lesson. Answer these questions to earn a big XP bonus!</p>
                
                <div id="summary-quiz-container">
                    <!-- Quiz questions will be generated here -->
                </div>
            </div>
            
            <div id="page-8" class="page">
                <h2>Exam Practice</h2>
                <p>Time to apply your knowledge to an exam-style question. Answer to the best of your ability. The mark scheme will become available after you have written a reasonable response.</p>
                
                <h3>Question 1</h3>
                <p>Compare and contrast the client-server and peer-to-peer network models. You should refer to their features, benefits, and drawbacks in your answer. [8 marks]</p>
                <textarea id="exam-q1-answer" placeholder="Start by defining both models. Then, create paragraphs for comparisons, such as how they handle security, management, and cost..."></textarea>
                
                <div style="margin-top: 1rem; display: flex; align-items: center; gap: 1rem;">
                    <span>Predict your mark: </span>
                    <input type="number" min="0" max="8" style="width: 80px;"> / 8
                </div>

                <button id="exam-q1-reveal-btn" class="btn btn-accent" disabled>Reveal Mark Scheme</button>
                <div id="exam-q1-mark-scheme" class="mark-scheme">
                    <h4>Mark Scheme (8 marks)</h4>
                    <ul>
                        <li><strong>AO1 (Knowledge):</strong> Award marks for accurate descriptions of features.
                            <ul>
                                <li>(1) Client-server has a central server; clients request services.</li>
                                <li>(1) P2P has no central server; peers have equal status.</li>
                            </ul>
                        </li>
                        <li><strong>AO2 (Application/Comparison):</strong> Award marks for direct comparisons.
                            <ul>
                                <li>(1) <strong>Security:</strong> C-S is centrally managed and more secure. P2P security is managed by each peer and can be inconsistent.</li>
                                <li>(1) <strong>Management:</strong> C-S allows for central backup and software updates. P2P management is decentralised, making backups and consistency difficult.</li>
                                <li>(1) <strong>Cost:</strong> C-S is more expensive (requires server hardware/specialist staff). P2P is cheaper (uses existing hardware).</li>
                                <li>(1) <strong>Reliability/Dependency:</strong> C-S has a single point of failure (the server). P2P is more resilient to a single machine failing, but relies on specific peers being online for their resources.</li>
                            </ul>
                        </li>
                         <li><strong>AO3 (Evaluation):</strong> Award marks for justified conclusions.
                             <ul>
                                 <li>(1) C-S is suitable for businesses needing control and security.</li>
                                 <li>(1) P2P is suitable for small networks or specific applications like file sharing where central control is not needed.</li>
                             </ul>
                         </li>
                    </ul>
                </div>

                <h3 style="margin-top: 2rem;">Question 2</h3>
                <p>Draw a diagram of a school's Local Area Network (LAN) connected to the internet (a WAN). Label the following components: a client, a server, a switch, and a router. [4 marks]</p>
                <div class="drawing-canvas-container">
                    <canvas id="drawing-canvas" width="600" height="400"></canvas>
                    <div>
                        <button id="clear-canvas-btn" class="btn btn-secondary">Clear Canvas</button>
                    </div>
                </div>
                 <button id="exam-q2-reveal-btn" class="btn btn-accent">Reveal Example Diagram</button>
                 <div id="exam-q2-mark-scheme" class="mark-scheme">
                     <h4>Example Diagram & Marking</h4>
                     <p>A suitable diagram would show several client PCs and a server connected to a central switch. The switch would then connect to a router, and the router would connect to a 'cloud' symbol labelled "Internet (WAN)".</p>
                     <ul>
                         <li>(1 mark) for correctly labelled client(s).</li>
                         <li>(1 mark) for a correctly labelled server.</li>
                         <li>(1 mark) for a switch connecting the clients and server.</li>
                         <li>(1 mark) for a router connecting the LAN (via the switch) to the WAN.</li>
                     </ul>
                 </div>
            </div>

            <div id="page-9" class="page">
                <h2>Extension Activities</h2>
                <p>Ready for a challenge? These activities go beyond the core specification and will deepen your understanding of networking concepts.</p>

                <h3>Thin vs. Thick Clients</h3>
                <p>In a client-server network, the clients themselves can be "thin" or "thick". A <strong>thick client</strong> (like a standard PC) does most of its own processing. A <strong>thin client</strong> is a simpler machine that relies heavily on the server to do the work. Research this concept.</p>
                <textarea id="extension-q1" placeholder="In what scenarios would a network of thin clients be more advantageous than one using thick clients? Consider cost, maintenance, and performance."></textarea>
                <button id="submit-extension-q1" class="btn">Submit Answer</button>

                <h3>The Internet of Things (IoT)</h3>
                <p>The IoT consists of billions of devices (from smartwatches to refrigerators) connected to the internet. These devices often use a hybrid of network models to communicate.</p>
                <textarea id="extension-q2" placeholder="Research how a device like a smart thermostat (e.g., Nest, Hive) communicates. Does it primarily use a client-server model to talk to the company's servers, a P2P model to talk to your phone directly, or something else? Explain."></textarea>
                <button id="submit-extension-q2" class="btn">Submit Answer</button>
            </div>

            <div id="page-10" class="page">
                <h2>Video Resources</h2>
                <p>Your teacher may provide links to helpful videos here. These can be a great way to review the concepts covered in this lesson.</p>
                <div style="display: flex; flex-wrap: wrap; gap: 1rem;">
                    <div style="flex: 1; min-width: 250px; height: 150px; background: #e0e0e0; display:flex; align-items:center; justify-content:center; border-radius: 0.5rem; color: #666;">Video Placeholder 1</div>
                    <div style="flex: 1; min-width: 250px; height: 150px; background: #e0e0e0; display:flex; align-items:center; justify-content:center; border-radius: 0.5rem; color: #666;">Video Placeholder 2</div>
                </div>
            </div>

            <div id="page-11" class="page">
                <h2>PSTN - Public Switched Telephone Network</h2>
                <p>The <strong>PSTN (Public Switched Telephone Network)</strong> is the traditional circuit-switched telephone network that has been used for decades to connect telephone calls worldwide. Let's explore how it works and its role in internet connectivity.</p>

                <div class="content-box">
                    <h3>Key Concepts</h3>
                    <ul>
                        <li><strong>Circuit Switching:</strong> Creates a dedicated communication path between two points for the duration of the call</li>
                        <li><strong>Modem:</strong> MOdulator-DEModulator - converts digital data to analog signals and vice versa</li>
                        <li><strong>Dedicated Lines:</strong> Permanent connections that don't require dialing (e.g., leased lines)</li>
                    </ul>
                </div>

                <h3>Interactive: How Dial-up Internet Works</h3>
                <p>Click "Start" to see how your computer connects to the internet using PSTN and a modem.</p>
                
                <div id="pstn-simulation" style="position: relative; height: 500px; background: var(--color-bg); border-radius: 1rem; margin: 1rem 0; overflow: hidden;">
                    <!-- Simulation area will be populated by JS -->
                </div>

                <div class="task-controls">
                    <button class="btn btn-primary" id="start-pstn-sim">Start Simulation</button>
                    <button class="btn btn-secondary" id="reset-pstn-sim">Reset</button>
                </div>

                <h3 style="margin-top: 2rem;">Task: PSTN Components</h3>
                <p>Match each component to its function in the PSTN system:</p>
                
                <div id="pstn-matching-task" class="matching-task">
                    <div class="matching-column">
                        <h4>Components</h4>
                        <ul class="matching-items" id="pstn-items">
                            <!-- JS will populate -->
                        </ul>
                    </div>
                    <div class="matching-column">
                        <h4>Functions</h4>
                        <div class="drop-target" data-category="modem">Converts digital to analog signals</div>
                        <div class="drop-target" data-category="exchange">Routes calls between subscribers</div>
                        <div class="drop-target" data-category="copper">Carries analog voice signals</div>
                        <div class="drop-target" data-category="isp">Provides internet connectivity</div>
                    </div>
                </div>
                <div class="task-controls">
                    <button class="btn btn-secondary" id="reset-pstn-matching">Reset Task</button>
                </div>

                <div class="content-box context" style="margin-top: 2rem;">
                    <h3>Dedicated Lines vs Dial-up</h3>
                    <p><strong>Dial-up:</strong> Uses existing phone lines, requires dialing, shares bandwidth with voice calls. Maximum speed: 56 Kbps.</p>
                    <p><strong>Dedicated Lines (Leased Lines):</strong> Always-on connection, guaranteed bandwidth, much more expensive. Used by businesses for reliable, high-speed connections.</p>
                </div>
            </div>

            <div id="page-12" class="page">
                <h2>Cell Phone Networks</h2>
                <p>Cell phone networks enable mobile devices to connect to the internet wirelessly through a system of <strong>cell towers</strong>. Each tower covers a geographic area called a <strong>cell</strong>.</p>

                <div class="content-box">
                    <h3>How Cell Networks Work</h3>
                    <ul>
                        <li><strong>Cell Towers:</strong> Radio transceivers that communicate with mobile devices</li>
                        <li><strong>Cells:</strong> Geographic areas covered by each tower (hexagonal in theory)</li>
                        <li><strong>Handoff/Handover:</strong> Transferring a connection from one tower to another as you move</li>
                        <li><strong>Generations:</strong> 2G, 3G, 4G, 5G - each offering faster data speeds</li>
                    </ul>
                </div>

                <h3>Interactive: Cell Tower Coverage & Handoff</h3>
                <p>Move the mobile device around to see how it connects to different towers. Watch the signal strength change!</p>
                
                <div id="cell-simulation" style="position: relative; height: 600px; background: linear-gradient(to bottom, #e0f2fe, #bae6fd); border-radius: 1rem; margin: 1rem 0; overflow: hidden;">
                    <!-- Cell tower simulation will be populated by JS -->
                </div>

                <div class="task-controls">
                    <button class="btn btn-primary" id="start-cell-sim">Start Movement</button>
                    <button class="btn btn-secondary" id="reset-cell-sim">Reset</button>
                </div>

                <h3 style="margin-top: 2rem;">Quick Quiz: Cell Networks</h3>
                <div id="cell-quiz-container">
                    <div style="margin-bottom: 1.5rem;">
                        <p><strong>1. What happens during a "handoff" in a cell network?</strong></p>
                        <ul class="mcq-options" id="cell-q1">
                            <li data-correct="true">The connection transfers from one cell tower to another</li>
                            <li data-correct="false">The phone shuts down and restarts</li>
                            <li data-correct="false">The internet speed doubles</li>
                            <li data-correct="false">The phone switches to WiFi</li>
                        </ul>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <p><strong>2. Cell phone networks connect to the internet through:</strong></p>
                        <ul class="mcq-options" id="cell-q2">
                            <li data-correct="false">Satellite connections only</li>
                            <li data-correct="true">Backhaul connections to ISPs</li>
                            <li data-correct="false">Direct peer-to-peer connections</li>
                            <li data-correct="false">Bluetooth technology</li>
                        </ul>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <p><strong>3. Which generation of cell network first enabled practical mobile internet?</strong></p>
                        <ul class="mcq-options" id="cell-q3">
                            <li data-correct="false">1G</li>
                            <li data-correct="false">2G</li>
                            <li data-correct="true">3G</li>
                            <li data-correct="false">5G</li>
                        </ul>
                    </div>
                </div>

                <div class="content-box context" style="margin-top: 2rem;">
                    <h3>Connection to the Internet</h3>
                    <p>Cell towers don't directly provide internet. They connect to the operator's core network via high-speed <strong>backhaul</strong> connections (fiber optic or microwave links). The core network then connects to Internet Service Providers (ISPs), allowing your mobile data to reach the wider internet.</p>
                </div>
            </div>

            <div class="page-navigation">
                <button id="prev-btn" class="btn btn-secondary">Previous</button>
                <span id="page-indicator"></span>
                <button id="next-btn" class="btn">Next</button>
            </div>
        </main>
    </div>

    <!-- Modals and Popups -->
    <div id="achievement-popup">
        <h4 id="achievement-title"></h4>
        <p id="achievement-desc"></p>
    </div>

    <div id="feedback-widget">
        <button id="feedback-btn" title="Send Feedback">üí°</button>
    </div>

    <div id="feedback-modal">
        <div class="modal-content">
            <h3>Send Feedback or Report a Bug</h3>
            <p>Your feedback helps improve this lesson! Please describe the issue or your suggestion below. This will prepare an email to your teacher.</p>
            <textarea id="feedback-text" placeholder="e.g., The button on the P2P simulation didn't work, or it would be cool if..." style="min-height: 100px;"></textarea>
            <div style="margin-top: 1rem; display: flex; justify-content: flex-end; gap: 1rem;">
                <button id="cancel-feedback-btn" class="btn btn-secondary">Cancel</button>
                <a id="send-feedback-btn" class="btn">Send</a>
            </div>
        </div>
    </div>
    
    <div id="shame-modal">
        <div class="modal-content">
            <h3>Whoops!</h3>
            <p>Pasting is disabled to encourage original thought. Please type your own answers. True learning comes from practice!</p>
            <div style="margin-top: 1rem;">
                <button id="close-shame-btn" class="btn btn-secondary">I Understand</button>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- STATE MANAGEMENT ---
    const state = {
        currentPageIndex: 0,
        xp: 0,
        level: 1,
        xpForNextLevel: 100,
        achievements: new Set(),
        answeredItems: new Set(), // Prevents re-awarding XP for the same action
        settings: {
            contrast: 'normal',
            fontSize: 'normal',
            font: 'default',
        },
        easterEggClicks: 0,
    };

    const pages = [
        { title: "Intro", id: "page-0" },
        { title: "Starter", id: "page-1" },
        { title: "LAN/WAN Sim", id: "page-2" },
        { title: "LAN/WAN Tasks", id: "page-3" },
        { title: "Client-Server Sim", id: "page-4" },
        { title: "P2P Sim", id: "page-5" },
        { title: "Comparison Task", id: "page-6" },
        { title: "Summary Quiz", id: "page-7" },
        { title: "Exam Practice", id: "page-8" },
        { title: "Extension", id: "page-9" },
        { title: "Videos", id: "page-10" },
        { title: "PSTN", id: "page-11" },
        { title: "Cell Networks", id: "page-12" }
    ];

    // --- DOM ELEMENT SELECTORS ---
    const mainContent = document.getElementById('main-content');
    const topNav = document.getElementById('top-nav');
    const pageIndicator = document.getElementById('page-indicator');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const xpBar = document.getElementById('xp-bar');
    const xpText = document.getElementById('xp-text');
    
    // --- UTILITY FUNCTIONS ---
    
    /**
     * Shuffles an array in place.
     * @param {Array} array The array to shuffle.
     * @returns {Array} The shuffled array.
     */
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    /**
     * Normalizes a string for keyword matching.
     * @param {string} text The text to normalize.
     * @returns {string} The normalized text.
     */
    function normalizeText(text) {
        return text.toLowerCase().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"").trim();
    }

    /**
      * Updates the drawing canvas stroke color based on current CSS theme.
      */
    function updateCanvasColor() {
        const canvas = document.getElementById('drawing-canvas');
        if (canvas) {
            const ctx = canvas.getContext('2d');
            // Gets the computed value of the --color-text CSS variable from the body
            ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue('--color-text').trim();
        }
    }


    // --- NAVIGATION ---
    function showPage(index) {
        // Hide current page
        const currentPage = document.querySelector('.page.active');
        if (currentPage) currentPage.classList.remove('active');

        // Show new page
        state.currentPageIndex = index;
        const newPage = document.getElementById(pages[index].id);
        if (newPage) newPage.classList.add('active');

        updateNavUI();
    }

    function updateNavUI() {
        // Update nav bar
        document.querySelectorAll('#top-nav .nav-item').forEach((item, i) => {
            if (i === state.currentPageIndex) {
                item.classList.add('active');
            } else {
                item.classList.remove('active');
            }
        });

        // Update page indicator
        pageIndicator.textContent = `Page ${state.currentPageIndex + 1} of ${pages.length}`;

        // Update prev/next buttons
        prevBtn.disabled = state.currentPageIndex === 0;
        nextBtn.disabled = state.currentPageIndex === pages.length - 1;
    }

    function initNav() {
        pages.forEach((page, index) => {
            const li = document.createElement('li');
            li.className = 'nav-item';
            const a = document.createElement('a');
            a.href = `#${page.id}`;
            a.textContent = page.title;
            a.addEventListener('click', (e) => {
                e.preventDefault();
                showPage(index);
            });
            li.appendChild(a);
            topNav.appendChild(li);
        });

        prevBtn.addEventListener('click', () => {
            if (state.currentPageIndex > 0) showPage(state.currentPageIndex - 1);
        });
        nextBtn.addEventListener('click', () => {
            if (state.currentPageIndex < pages.length - 1) showPage(state.currentPageIndex + 1);
        });
        
        // Swipe navigation for mobile
        let touchstartX = 0;
        let touchendX = 0;

        mainContent.addEventListener('touchstart', e => {
            touchstartX = e.changedTouches[0].screenX;
        }, { passive: true });

        mainContent.addEventListener('touchend', e => {
            touchendX = e.changedTouches[0].screenX;
            handleSwipe();
        }, { passive: true });

        function handleSwipe() {
            if (touchendX < touchstartX - 50) { // Swiped left
                if (state.currentPageIndex < pages.length - 1) showPage(state.currentPageIndex + 1);
            }
            if (touchendX > touchstartX + 50) { // Swiped right
                if (state.currentPageIndex > 0) showPage(state.currentPageIndex - 1);
            }
        }

        showPage(0);
    }
    
    // --- GAMIFICATION ---
    function addXP(amount, itemId) {
        if (state.answeredItems.has(itemId)) return; // Already answered
        
        state.answeredItems.add(itemId);
        state.xp += amount;

        if (state.xp >= state.xpForNextLevel) {
            state.level++;
            state.xp -= state.xpForNextLevel;
            state.xpForNextLevel = Math.floor(state.xpForNextLevel * 1.5);
            grantAchievement(`level${state.level}`, `Level Up!`, `You've reached Level ${state.level}!`);
            if (state.level >= 5) {
                grantAchievement('maxlevel', 'Network Master', 'You have completed all levels!');
            }
        }
        updateXPBar();
    }
    
    function updateXPBar() {
        const percentage = (state.xp / state.xpForNextLevel) * 100;
        xpBar.style.width = `${Math.min(percentage, 100)}%`;
        xpText.textContent = `Level ${state.level}: ${state.xp}/${state.xpForNextLevel} XP`;
    }
    
    function grantAchievement(id, title, desc) {
        if (state.achievements.has(id)) return;
        
        state.achievements.add(id);
        const popup = document.getElementById('achievement-popup');
        document.getElementById('achievement-title').textContent = title;
        document.getElementById('achievement-desc').textContent = desc;

        popup.classList.add('show');
        if ('vibrate' in navigator) navigator.vibrate(200);

        setTimeout(() => {
            popup.classList.remove('show');
        }, 4000);
    }

    // --- ACCESSIBILITY AND SETTINGS ---
    function initSettings() {
        const body = document.body;
        document.getElementById('contrast-toggle').addEventListener('click', () => {
            body.classList.toggle('high-contrast');
            updateCanvasColor(); // Update canvas color on theme change
        });
        document.getElementById('dyslexia-toggle').addEventListener('click', () => {
            body.classList.toggle('dyslexia-font');
        });
        
        const fontSizes = ['normal', 'large', 'xlarge'];
        let currentFontIndex = 0;
        document.getElementById('font-size-toggle').addEventListener('click', () => {
            body.classList.remove(`font-size-${fontSizes[currentFontIndex]}`);
            currentFontIndex = (currentFontIndex + 1) % fontSizes.length;
            if (fontSizes[currentFontIndex] !== 'normal') {
                body.classList.add(`font-size-${fontSizes[currentFontIndex]}`);
            }
        });
    }

    // --- PASTE PREVENTION ---
    function initPastePrevention() {
        const inputs = document.querySelectorAll('textarea, input[type="text"], input[type="number"]');
        const shameModal = document.getElementById('shame-modal');

        inputs.forEach(input => {
            input.addEventListener('paste', (e) => {
                e.preventDefault();
                shameModal.style.display = 'flex';
            });
        });
        document.getElementById('close-shame-btn').addEventListener('click', () => {
            shameModal.style.display = 'none';
        });
    }
    
    // --- FEEDBACK WIDGET ---
    function initFeedback() {
        const modal = document.getElementById('feedback-modal');
        document.getElementById('feedback-btn').addEventListener('click', () => {
            modal.style.display = 'flex';
        });
        document.getElementById('cancel-feedback-btn').addEventListener('click', () => {
            modal.style.display = 'none';
        });
        document.getElementById('send-feedback-btn').addEventListener('click', (e) => {
            const feedbackText = document.getElementById('feedback-text').value;
            if (!feedbackText) {
                e.preventDefault();
                alert('Please enter some feedback first.');
                return;
            }
            const currentPageTitle = pages[state.currentPageIndex].title;
            const subject = encodeURIComponent("Feedback on A-Level CS Worksheet");
            const body = encodeURIComponent(`Page: ${currentPageTitle}\n\nFeedback:\n${feedbackText}`);
            e.target.href = `mailto:millingtond@mgs.org?subject=${subject}&body=${body}`;
            
            setTimeout(() => {
                modal.style.display = 'none';
                document.getElementById('feedback-text').value = '';
            }, 500);
        });
    }
    
    // --- TASK INITIALIZATION AND LOGIC ---

    // Generic function for matching tasks
    function initMatchingTask(config) {
        const itemsContainer = document.getElementById(config.itemsContainerId);
        const taskContainer = document.getElementById(config.taskContainerId);
        const dropTargets = taskContainer.querySelectorAll('.drop-target');
        const resetBtn = document.getElementById(config.resetBtnId);
        let selectedItem = null;

        function setup() {
            itemsContainer.innerHTML = '';
            dropTargets.forEach(t => { 
                if(!t.classList.contains('correct')) {
                    t.innerHTML = config.originalDropText ? config.originalDropText[t.dataset.category] : '';
                    t.classList.remove('correct'); 
                }
            });

            shuffleArray(config.items).forEach((item, index) => {
                const li = document.createElement('li');
                li.textContent = item.text;
                li.className = 'matching-item';
                li.dataset.category = item.category;
                li.dataset.id = `${config.idPrefix}-${index}`;
                itemsContainer.appendChild(li);
            });
        }
        
        itemsContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('matching-item') && !e.target.classList.contains('matched')) {
                if (selectedItem) selectedItem.classList.remove('selected');
                selectedItem = e.target;
                selectedItem.classList.add('selected');
            }
        });

        taskContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('drop-target') && !e.target.classList.contains('correct') && selectedItem) {
                if (e.target.dataset.category === selectedItem.dataset.category) {
                    e.target.textContent = selectedItem.textContent;
                    e.target.classList.add('correct');
                    selectedItem.classList.add('matched');
                    selectedItem.classList.remove('selected');
                    addXP(config.xp, selectedItem.dataset.id);
                    if ('vibrate' in navigator) navigator.vibrate(50);
                    
                    selectedItem = null;

                    if (taskContainer.querySelectorAll('.matched').length === config.items.length) {
                        grantAchievement(config.achievement.id, config.achievement.title, config.achievement.desc);
                    }
                } else {
                    e.target.classList.add('incorrect');
                    setTimeout(() => e.target.classList.remove('incorrect'), 500);
                }
            }
        });
        
        resetBtn.addEventListener('click', setup);
        setup();
    }


    // Page 1: Starter Task
    function initStarterTask() {
        initMatchingTask({
            taskContainerId: 'starter-task',
            itemsContainerId: 'starter-items',
            resetBtnId: 'reset-starter',
            idPrefix: 'starter',
            xp: 10,
            items: [
                { text: "Small geographical area", category: "LAN" },
                { text: "Uses private infrastructure", category: "LAN" },
                { text: "High data transfer rate", category: "LAN" },
                { text: "Covers a large geographical area", category: "WAN" },
                { text: "e.g., The Internet", category: "WAN" },
                { text: "Infrastructure managed by telcos", category: "WAN" },
            ],
            achievement: { id: 'starter', title: 'Off to a Good Start!', desc: 'You completed the starter activity!' }
        });
    }

    // Page 2: LAN/WAN/Server Simulation
    function initLanWanServerSim() {
        const instructionBox = document.getElementById('lws-instruction-box');
        const controls = document.getElementById('lws-controls');
        const simArea = document.getElementById('lws-simulation-area');
        const popupContainer = document.getElementById('lws-popup-container');
        const canvas = document.getElementById('lws-network-canvas');
        const ctx = canvas.getContext('2d');
        const quizSection = document.getElementById('lws-quiz-section');
        const quizContent = document.getElementById('lws-quiz-content');
        const quizFeedback = document.getElementById('lws-quiz-feedback');
        const nextQuestionBtn = document.getElementById('lws-next-question-btn');
        const restartBtn = document.getElementById('lws-restart-btn');

        let simState = {
            step: 0,
            devices: {},
            areas: {},
            isActionInProgress: false,
        };
        let quizState = {
            score: 0,
            currentQuestionIndex: 0
        };

        const ICONS = {
            client: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17.25v1.007a3 3 0 0 1-.879 2.122L7.5 21h9l-1.621-1.621A3 3 0 0 1 14 18.257V17.25m6-12V15a2.25 2.25 0 0 1-2.25 2.25H5.25A2.25 2.25 0 0 1 3 15V5.25A2.25 2.25 0 0 1 5.25 3h13.5A2.25 2.25 0 0 1 21 5.25Z" /></svg>`,
            server: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M5.25 14.25h13.5m-13.5 0a3 3 0 0 1-3-3V7.5a3 3 0 0 1 3-3h13.5a3 3 0 0 1 3 3v3.75a3 3 0 0 1-3 3m-13.5 0h13.5m-13.5 0a3 3 0 0 0-3 3v.75a3 3 0 0 0 3 3h13.5a3 3 0 0 0 3-3v-.75a3 3 0 0 0-3-3m-9-5.25h.008v.008H9v-.008Zm3 0h.008v.008H12v-.008ZM15 9h.008v.008H15V9Z" /></svg>`,
            switch: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75a4.5 4.5 0 0 1-4.5 4.5H6.75a4.5 4.5 0 0 1-4.5-4.5v-1.5a4.5 4.5 0 0 1 4.5-4.5h10.5a4.5 4.5 0 0 1 4.5 4.5v1.5Zm-18 8.25a4.5 4.5 0 0 1 4.5-4.5h10.5a4.5 4.5 0 0 1 4.5 4.5v.5a4.5 4.5 0 0 1-4.5 4.5H6.75a4.5 4.5 0 0 1-4.5-4.5v-.5Zm11.25-7.5a.75.75 0 0 0-1.5 0v2.25a.75.75 0 0 0 1.5 0v-2.25Zm-3-1.5a.75.75 0 0 0-1.5 0v5.25a.75.75 0 0 0 1.5 0v-5.25Z" /></svg>`,
            router: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M5.25 12a.75.75 0 0 1 .75-.75h.01a.75.75 0 0 1 .75.75v.01a.75.75 0 0 1-.75.75H6a.75.75 0 0 1-.75-.75v-.01M8.25 12a.75.75 0 0 1 .75-.75h.01a.75.75 0 0 1 .75.75v.01a.75.75 0 0 1-.75.75H9a.75.75 0 0 1-.75-.75v-.01M11.25 12a.75.75 0 0 1 .75-.75h.01a.75.75 0 0 1 .75.75v.01a.75.75 0 0 1-.75.75h-.01a.75.75 0 0 1-.75-.75v-.01M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 2.625a.75.75 0 0 0 .75-.75v-.01a.75.75 0 0 0-.75-.75h-.01a.75.75 0 0 0-.75.75v.01c0 .414.336.75.75.75Zm-3.375 0a.75.75 0 0 0 .75-.75v-.01a.75.75 0 0 0-.75-.75h-.01a.75.75 0 0 0-.75.75v.01c0 .414.336.75.75.75Zm6.75 0a.75.75 0 0 0 .75-.75v-.01a.75.75 0 0 0-.75-.75h-.01a.75.75 0 0 0-.75.75v.01c0 .414.336.75.75.75Z" /></svg>`
        };

        const simulationSteps = [
            {
                instruction: `<p>This is the <strong>Manchester Office LAN</strong>. It's a Local Area Network covering a small geographical area.</p>`,
                setup: () => {
                    createArea('lan1', { label: 'Manchester LAN', rect: { top: '5%', left: '5%', width: '90%', height: '90%' } });
                    createDevice('client1', 'client', { top: '20%', left: '20%' });
                    createDevice('client2', 'client', { top: '20%', left: '70%' });
                    createDevice('switch1', 'switch', { top: '50%', left: '46%' });
                    createDevice('server1', 'server', { top: '75%', left: '46%' });
                    showNextButton('Show LAN Speed');
                }
            },
            {
                instruction: `<p>Within a LAN, data transfer is very fast due to private, high-speed infrastructure.</p><p>Click a Client to send data to the Server.</p>`,
                setup: () => {
                    hideNextButton();
                    enableDeviceSelection({
                        onSelect: async (fromId) => {
                            if (fromId === 'client1' || fromId === 'client2') {
                                await animatePacket(fromId, 'switch1', 'lws-lan-packet', 400);
                                await animatePacket('switch1', 'server1', 'lws-lan-packet', 400);
                                showPopup('info', 'High Speed!', 'Data travels quickly on a LAN.');
                                addXP(5, `lws-lan-transfer`);
                                nextStep();
                            }
                        },
                        selectable: ['client1', 'client2']
                    });
                }
            },
            {
                instruction: `<p>Now, let's connect to the <strong>Tokyo Office</strong> using a <strong>Wide Area Network (WAN)</strong>.</p>`,
                setup: async () => {
                    Object.values(simState.devices).forEach(d => {
                        const el = d.element;
                        el.style.transform = 'scale(0.5)';
                        el.style.top = `calc(${d.pos.top} * 0.4 + 10%)`;
                        el.style.left = `calc(${d.pos.left} * 0.4 + 5%)`;
                    });
                    simState.areas.lan1.element.style.cssText += `top: 10%; left: 5%; width: 40%; height: 80%;`;
                    createDevice('router1', 'router', { top: '80%', left: '23%' });
                    
                    createArea('lan2', { label: 'Tokyo LAN', rect: { top: '10%', left: '55%', width: '40%', height: '80%' }});
                    createDevice('client3', 'client', { top: '30%', left: '73%' });
                    createDevice('router2', 'router', { top: '80%', left: '73%' });

                    const cloud = document.createElement('div');
                    cloud.className = 'lws-wan-cloud';
                    const cloudText = document.createElement('span');
                    cloudText.className = 'lws-wan-cloud-text';
                    cloudText.textContent = 'WAN';
                    simArea.appendChild(cloud);
                    simArea.appendChild(cloudText);
                    setTimeout(() => {
                        cloud.style.opacity = '1';
                        cloudText.style.opacity = '1';
                    }, 500);
                    
                    showNextButton('Send Data over WAN');
                }
            },
            {
                instruction: `<p>WANs use public infrastructure (like the internet), making data transfer slower due to distance and congestion.</p><p>Click Client 1 to send data to Client 3.</p>`,
                setup: () => {
                    hideNextButton();
                    const c1 = simState.devices['client1'].element;
                    c1.onclick = async () => {
                        c1.onclick = null;
                        if(simState.isActionInProgress) return;
                        simState.isActionInProgress = true;
                        await animatePacket('client1', 'switch1', 'lws-lan-packet', 400);
                        await animatePacket('switch1', 'router1', 'lws-lan-packet', 400);
                        await animatePacket('router1', 'router2', 'lws-wan-packet', 2000);
                        await animatePacket('router2', 'client3', 'lws-lan-packet', 400);
                        showPopup('warning', 'Slower Transfer!', 'Notice the delay across the WAN.');
                        addXP(5, `lws-wan-transfer`);
                        simState.isActionInProgress = false;
                        nextStep();
                    }
                }
            },
            {
                instruction: `<p>You've seen the key differences. Time to check your understanding!</p>`,
                setup: () => { showNextButton('Take the Quiz'); }
            },
            {
                instruction: ``,
                setup: () => {
                    document.getElementById('lws-main-content').classList.add('hidden');
                    quizSection.classList.remove('hidden');
                    loadQuizQuestion();
                }
            }
        ];

        function initLws() {
            resizeCanvas();
            window.addEventListener('resize', () => { resizeCanvas(); drawLines(); });
            runStep();
        }
        
        function runStep() {
            const currentStep = simulationSteps[simState.step];
            instructionBox.innerHTML = currentStep.instruction;
            currentStep.setup();
            setTimeout(drawLines, 100);
        }

        function nextStep() {
            if (simState.isActionInProgress) return;
            simState.step++;
            if (simState.step < simulationSteps.length) {
                runStep();
            }
        }
        
        function createDevice(id, type, pos) {
            const device = document.createElement('div');
            device.id = `lws-device-${id}`;
            device.className = `lws-device ${type}`;
            device.style.top = pos.top;
            device.style.left = pos.left;
            device.innerHTML = `<div class="lws-device-icon">${ICONS[type]}</div><span class="lws-device-label">${id.charAt(0).toUpperCase() + id.slice(1)}</span>`;
            simArea.appendChild(device);
            simState.devices[id] = { element: device, type: type, pos: pos };
        }
        
        function createArea(id, config) {
            const area = document.createElement('div');
            area.id = `lws-area-${id}`;
            area.className = `lws-lan-area`;
            area.style.top = config.rect.top;
            area.style.left = config.rect.left;
            area.style.width = config.rect.width;
            area.style.height = config.rect.height;
            area.textContent = config.label;
            simArea.insertBefore(area, simArea.firstChild);
            simState.areas[id] = { element: area, rect: config.rect };
        }

        function animatePacket(fromId, toId, packetClass, duration) {
            return new Promise(resolve => {
                const fromEl = simState.devices[fromId].element;
                const toEl = simState.devices[toId].element;
                const fromRect = fromEl.getBoundingClientRect();
                const toRect = toEl.getBoundingClientRect();
                const simRect = simArea.getBoundingClientRect();
                const startX = fromRect.left + fromRect.width / 2 - simRect.left;
                const startY = fromRect.top + fromRect.height / 2 - simRect.top;
                const endX = toRect.left + toRect.width / 2 - simRect.left;
                const endY = toRect.top + toRect.height / 2 - simRect.top;
                const packet = document.createElement('div');
                packet.className = `lws-packet ${packetClass}`;
                packet.style.transform = `translate(${startX - 6}px, ${startY - 6}px)`;
                packet.style.transition = `transform ${duration}ms ease-in-out`;
                simArea.appendChild(packet);
                requestAnimationFrame(() => {
                    packet.style.opacity = '1';
                    packet.style.transform = `translate(${endX - 6}px, ${endY - 6}px)`;
                });
                setTimeout(() => {
                    packet.remove();
                    resolve();
                }, duration);
            });
        }

        function enableDeviceSelection({ onSelect, selectable }) {
             simState.selectedDevice = null;
             Object.keys(simState.devices).forEach(id => {
                const device = simState.devices[id];
                if (selectable && !selectable.includes(id)) {
                    device.element.onclick = null;
                    return;
                }
                device.element.onclick = () => {
                    Object.values(simState.devices).forEach(d => d.element.classList.remove('selected'));
                    device.element.classList.add('selected');
                    onSelect(id);
                    Object.values(simState.devices).forEach(d => d.element.onclick = null); // Disable after one click
                };
            });
        }
        
        function showNextButton(text) {
            controls.innerHTML = `<button id="lws-next-step-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-all transform hover:scale-105">${text}</button>`;
            document.getElementById('lws-next-step-btn').onclick = nextStep;
        }
        function hideNextButton() { controls.innerHTML = ''; }
        function showPopup(type, title, message) {
            const popup = document.createElement('div');
            popup.className = `lws-popup ${type}`;
            popup.innerHTML = `<strong class="block text-lg">${title}</strong><p class="text-sm">${message}</p>`;
            popupContainer.appendChild(popup);
            setTimeout(() => popup.classList.add('show'), 100);
            setTimeout(() => {
                popup.classList.remove('show');
                setTimeout(() => popup.remove(), 500);
            }, 3500);
        }
        
        function resizeCanvas() {
            canvas.width = simArea.clientWidth;
            canvas.height = simArea.clientHeight;
        }

        function drawLines() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = '#9ca3af';
            ctx.lineWidth = 2;
            const connections = [
                ['client1', 'switch1'], ['client2', 'switch1'], ['server1', 'switch1'],
                ['switch1', 'router1'], ['client3', 'router2']
            ];
            connections.forEach(([fromId, toId]) => {
                const from = simState.devices[fromId];
                const to = simState.devices[toId];
                if (!from || !to) return;
                const fromRect = from.element.getBoundingClientRect();
                const toRect = to.element.getBoundingClientRect();
                const simRect = simArea.getBoundingClientRect();
                ctx.beginPath();
                ctx.moveTo(fromRect.left + fromRect.width / 2 - simRect.left, fromRect.top + fromRect.height / 2 - simRect.top);
                ctx.lineTo(toRect.left + toRect.width / 2 - simRect.left, toRect.top + toRect.height / 2 - simRect.top);
                ctx.stroke();
            });
            const r1 = simState.devices['router1'];
            const r2 = simState.devices['router2'];
            if (r1 && r2) {
                const fromRect = r1.element.getBoundingClientRect();
                const toRect = r2.element.getBoundingClientRect();
                const simRect = simArea.getBoundingClientRect();
                ctx.strokeStyle = '#ef4444';
                ctx.lineWidth = 4;
                ctx.setLineDash([10, 10]);
                ctx.beginPath();
                ctx.moveTo(fromRect.left + fromRect.width / 2 - simRect.left, fromRect.top + fromRect.height / 2 - simRect.top);
                ctx.lineTo(toRect.left + toRect.width / 2 - simRect.left, toRect.top + toRect.height / 2 - simRect.top);
                ctx.stroke();
                ctx.setLineDash([]);
            }
        }

        const quizQuestions = [
            { q: "A network in a single room or building is best described as a...", o: ["WAN", "LAN", "Server", "Internet"], a: "LAN" },
            { q: "What is a key characteristic of a LAN's data transfer rate?", o: ["Low", "High", "Variable", "Dependent on internet speed"], a: "High" },
            { q: "Which of these best describes a WAN?", o: ["A network in a single home", "A network connecting multiple LANs across a country", "A single powerful computer", "A network with a very high data transfer rate"], a: "A network connecting multiple LANs across a country" },
            { q: "Why is data transfer typically slower on a WAN compared to a LAN?", o: ["WANs use better quality cables", "Data travels a shorter distance", "WAN infrastructure is private and dedicated", "Infrastructure is shared and data travels longer distances"], a: "Infrastructure is shared and data travels longer distances" },
            { q: "What is the primary function of a server?", o: ["To request data from clients", "To provide services to clients on a network", "To connect different LANs together", "To browse the web"], a: "To provide services to clients on a network" },
            { q: "The infrastructure of the internet (a WAN) is primarily managed by...", o: ["Individual users", "Small businesses", "Telecommunications companies", "The government"], a: "Telecommunications companies" }
        ];

        function loadQuizQuestion() {
            quizFeedback.textContent = '';
            nextQuestionBtn.classList.add('hidden');
            if (quizState.currentQuestionIndex >= quizQuestions.length) {
                showFinalScore();
                return;
            }
            const q = quizQuestions[quizState.currentQuestionIndex];
            quizContent.innerHTML = `<p class="text-xl font-semibold mb-4 text-gray-800">${q.q}</p><div class="space-y-3">${shuffleArray([...q.o]).map(option => `<button class="quiz-option w-full text-left p-4 rounded-lg bg-gray-100 hover:bg-blue-100 border-2 border-gray-200 transition-all">${option}</button>`).join('')}</div>`;
            document.querySelectorAll('.quiz-option').forEach(btn => btn.onclick = handleAnswer);
        }

        function handleAnswer(e) {
            const selectedBtn = e.target;
            const answer = selectedBtn.textContent;
            const correctAnswer = quizQuestions[quizState.currentQuestionIndex].a;
            document.querySelectorAll('.quiz-option').forEach(btn => {
                btn.disabled = true;
                if (btn.textContent === correctAnswer) btn.classList.add('correct');
            });
            if (answer === correctAnswer) {
                quizFeedback.textContent = "Correct!";
                quizFeedback.className = 'text-center mt-4 font-semibold text-lg text-green-600 h-8';
                quizState.score++;
                addXP(10, `lws-quiz-q${quizState.currentQuestionIndex}`);
            } else {
                selectedBtn.classList.add('incorrect');
                quizFeedback.textContent = `Incorrect. The correct answer is highlighted.`;
                quizFeedback.className = 'text-center mt-4 font-semibold text-lg text-red-600 h-8';
            }
            quizState.currentQuestionIndex++;
            nextQuestionBtn.textContent = (quizState.currentQuestionIndex >= quizQuestions.length) ? 'Show Results' : 'Next Question';
            nextQuestionBtn.classList.remove('hidden');
        }

        function showFinalScore() {
            quizContent.innerHTML = `<div class="text-center"><p class="text-2xl font-bold text-gray-800">Quiz Complete!</p><p class="text-4xl mt-4 font-bold ${quizState.score / quizQuestions.length >= 0.7 ? 'text-green-600' : 'text-blue-600'}">${quizState.score} / ${quizQuestions.length}</p></div>`;
            if (quizState.score === quizQuestions.length) {
                grantAchievement('lws-perfect', 'Network Navigator', 'You aced the LAN/WAN simulation quiz!');
                addXP(30, 'lws-quiz-perfect');
            }
            quizFeedback.textContent = '';
            nextQuestionBtn.classList.add('hidden');
            restartBtn.classList.remove('hidden');
        }

        function resetAll() {
            simState = { step: 0, devices: {}, areas: {}, isActionInProgress: false };
            quizState = { score: 0, currentQuestionIndex: 0 };
            simArea.innerHTML = '<canvas id="lws-network-canvas" class="absolute top-0 left-0 w-full h-full z-0"></canvas>';
            popupContainer.innerHTML = '';
            document.getElementById('lws-main-content').classList.remove('hidden');
            quizSection.classList.add('hidden');
            restartBtn.classList.add('hidden');
            simArea.style.backgroundImage = '';
            initLws();
        }

        nextQuestionBtn.addEventListener('click', loadQuizQuestion);
        restartBtn.addEventListener('click', resetAll);
        
        initLws();
    }
    
    // Page 3: LAN/WAN/Server Tasks - These are the old tasks
    function initLanWanScenarioTask() {
        initMatchingTask({
            taskContainerId: 'lan-wan-scenario-task',
            itemsContainerId: 'lan-wan-scenario-items',
            resetBtnId: 'reset-lan-wan-scenario',
            idPrefix: 'lanwan',
            xp: 10,
            items: [
                { text: "A home WiFi network", category: "LAN" },
                { text: "A school computer suite", category: "LAN" },
                { text: "An office building's network", category: "LAN" },
                { text: "The network connecting ATMs across a country", category: "WAN" },
                { text: "A company connecting its London and Tokyo offices", category: "WAN" },
                { text: "The global network of academic computers", category: "WAN" }
            ],
            achievement: { id: 'lan-wan-sorter', title: 'Network Spotter', desc: 'You correctly identified LAN and WAN scenarios!' }
        });
    }

    function initServerMatchingTask() {
        initMatchingTask({
            taskContainerId: 'server-matching-task',
            itemsContainerId: 'server-desc-items',
            resetBtnId: 'reset-server-matching',
            idPrefix: 'server',
            xp: 15,
            items: [
                { text: "Stores and delivers web pages to your browser.", category: "web" },
                { text: "A central location for storing and managing files.", category: "file" },
                { text: "Handles the sending, receiving, and storing of emails.", category: "mail" },
                { text: "Manages print jobs for shared printers on a network.", category: "print" },
            ],
            achievement: { id: 'server-sorter', title: 'Server Sorter', desc: 'You matched all the server types!' },
            originalDropText: {
                web: 'Web Server',
                file: 'File Server',
                mail: 'Mail Server',
                print: 'Print Server',
            }
        });
    }

    // Page 4: Client-Server Sim
    function initNewClientServerSim() {
        // --- DOM Elements ---
        const nextBtn = document.getElementById('cs-next-btn');
        const explanationText = document.getElementById('explanation-text');
        const networkArea = document.getElementById('network-area');
        const infoSection = document.getElementById('info-section');
        const quizContainer = document.getElementById('cs-quiz-container');
        const quizContent = document.getElementById('cs-quiz-content');
        const quizFeedback = document.getElementById('cs-quiz-feedback');
        const nextQuestionBtn = document.getElementById('cs-next-question-btn');
        const restartBtn = document.getElementById('cs-restart-btn');

        // --- SVG Icons ---
        const serverSVG = `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-full h-full"><path d="M5 16H4C3.44772 16 3 15.5523 3 15V5C3 4.44772 3.44772 4 4 4H20C20.5523 4 21 4.44772 21 5V15C21 15.5523 20.5523 16 20 16H19" stroke="#1e40af" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M5 20H19" stroke="#1e40af" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 20V16" stroke="#1e40af" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M9 8H15" stroke="#60a5fa" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M9 12H12" stroke="#60a5fa" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
        const clientSVG = `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-full h-full"><path d="M5 14H4C3.44772 14 3 13.5523 3 13V5C3 4.44772 3.44772 4 4 4H20C20.5523 4 21 4.44772 21 5V13C21 13.5523 20.5523 14 20 14H19" stroke="#4338ca" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M2 18H22" stroke="#4338ca" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;

        // --- State ---
        let step = 0;
        let server, dataPacket;
        let clients = [];
        let score = 0;
        let currentQuestionIndex = 0;
        let clientClickHandlers = [];

        const clientPositions = [
            { top: '10%', left: '10%' }, { top: '10%', left: '75%' },
            { top: '70%', left: '10%' }, { top: '70%', left: '75%' }
        ];

        // --- Simulation Logic ---
        const simulationSteps = [
            { // Step 0: Add Server
                action: async () => {
                    explanationText.textContent = "A client-server network uses a central computer, known as a server, to manage the network.";
                    addServer();
                    nextBtn.textContent = 'Next';
                }
            },
            { // Step 1: Add Clients
                action: async () => {
                    explanationText.textContent = "Other computers, called clients, connect to the server.";
                    addClients();
                    drawLines();
                }
            },
            { // Step 2: Resource Sharing
                action: async () => {
                    explanationText.innerHTML = "A client requests a file from the server. This is <strong>resource sharing</strong>. <br/><strong>Click a client</strong> to send a request.";
                    enableClientClicks(async (client) => {
                         await animateDataPacket(client, server);
                         await animateDataPacket(server, client, 'üìÇ');
                         disableClientClicks();
                         nextBtn.disabled = false;
                    });
                    nextBtn.disabled = true;
                }
            },
            { // Step 3: Communication
                action: async () => {
                    explanationText.innerHTML = "The server also facilitates communication between clients. <br/><strong>Click a client</strong> to send a message to another.";
                     enableClientClicks(async (clientFrom) => {
                         const clientTo = clients.find(c => c !== clientFrom); // send to any other client
                         await animateDataPacket(clientFrom, server, '‚úâÔ∏è');
                         await animateDataPacket(server, clientTo, '‚úâÔ∏è');
                         disableClientClicks();
                         nextBtn.disabled = false;
                    });
                    nextBtn.disabled = true;
                }
            },
            { // Step 4: Transition to Info Section
                action: async () => {
                    explanationText.textContent = "Now, let's explore the benefits and drawbacks of this network structure.";
                    nextBtn.textContent = 'Take the Quiz';
                    infoSection.classList.remove('hidden');
                    window.scrollTo({ top: infoSection.offsetTop - 20, behavior: 'smooth' });
                    addXP(20, 'cs-sim-complete');
                }
            },
            { // Step 5: Transition to Quiz
                action: async () => {
                    infoSection.classList.add('hidden');
                    quizContainer.classList.remove('hidden');
                    nextBtn.style.display = 'none';
                    window.scrollTo({ top: quizContainer.offsetTop - 20, behavior: 'smooth' });
                    loadQuestion();
                }
            }
        ];

        // --- Helper Functions ---
        function createDiv(className, id = '', role = '', ariaLabel = '') {
            const div = document.createElement('div');
            div.className = className;
            if (id) div.id = id;
            if (role) div.setAttribute('role', role);
            if (ariaLabel) div.setAttribute('aria-label', ariaLabel);
            return div;
        }

        function addServer() {
            server = createDiv('computer-icon server-icon', 'server', 'img', 'Central Server Computer');
            server.innerHTML = serverSVG;
            server.style.top = '50%';
            server.style.left = '50%';
            server.style.transform = 'translate(-50%, -50%)';
            networkArea.appendChild(server);
            setTimeout(() => server.style.opacity = '1', 100);
        }

        function addClients() {
            clientPositions.forEach((pos, i) => {
                const client = createDiv('computer-icon', `client-${i}`, 'img', `Client computer ${i + 1}`);
                client.innerHTML = clientSVG;
                client.style.top = pos.top;
                client.style.left = pos.left;
                networkArea.appendChild(client);
                clients.push(client);
                setTimeout(() => client.style.opacity = '1', 100 + i * 150);
            });
        }

        function drawLines() {
            setTimeout(() => {
                const serverRect = server.getBoundingClientRect();
                const networkRect = networkArea.getBoundingClientRect();
                const serverX = serverRect.left + serverRect.width / 2 - networkRect.left;
                const serverY = serverRect.top + serverRect.height / 2 - networkRect.top;
                clients.forEach(client => {
                    const clientRect = client.getBoundingClientRect();
                    const clientX = clientRect.left + clientRect.width / 2 - networkRect.left;
                    const clientY = clientRect.top + clientRect.height / 2 - networkRect.top;
                    const distance = Math.sqrt(Math.pow(clientX - serverX, 2) + Math.pow(clientY - serverY, 2));
                    const angle = Math.atan2(clientY - serverY, clientX - serverX) * (180 / Math.PI);
                    const line = createDiv('line');
                    line.style.width = `${distance}px`;
                    line.style.height = '2px';
                    line.style.left = `${serverX}px`;
                    line.style.top = `${serverY}px`;
                    line.style.transform = `rotate(${angle}deg)`;
                    networkArea.appendChild(line);
                    setTimeout(() => line.style.opacity = '0.5', 500);
                });
            }, 100);
        }
        
        function animateDataPacket(from, to, content = '') {
             return new Promise(resolve => {
                if (dataPacket && dataPacket.parentNode) {
                     dataPacket.parentNode.removeChild(dataPacket);
                }
                dataPacket = createDiv('data-packet');
                dataPacket.innerHTML = content;
                const fromRect = from.getBoundingClientRect();
                const toRect = to.getBoundingClientRect();
                const networkRect = networkArea.getBoundingClientRect();
                const startX = (fromRect.left + fromRect.width / 2 - networkRect.left) - 15;
                const startY = (fromRect.top + fromRect.height / 2 - networkRect.top) - 15;
                const endX = (toRect.left + toRect.width / 2 - networkRect.left) - 15;
                const endY = (toRect.top + toRect.height / 2 - networkRect.top) - 15;
                dataPacket.style.left = `${startX}px`;
                dataPacket.style.top = `${startY}px`;
                networkArea.appendChild(dataPacket);
                from.classList.add('glow');
                to.classList.add('glow');
                setTimeout(() => {
                    dataPacket.style.opacity = '1';
                    dataPacket.style.transform = `translate(${endX - startX}px, ${endY - startY}px)`;
                }, 100);
                setTimeout(() => {
                    dataPacket.style.opacity = '0';
                    from.classList.remove('glow');
                    to.classList.remove('glow');
                    resolve();
                }, 1100);
             });
        }

        function enableClientClicks(callback) {
            clients.forEach(client => {
                const handler = () => callback(client);
                clientClickHandlers.push({ client, handler });
                client.addEventListener('click', handler);
                client.style.cursor = 'pointer';
            });
        }

        function disableClientClicks() {
            clientClickHandlers.forEach(({ client, handler }) => {
                client.removeEventListener('click', handler);
                client.style.cursor = 'default';
            });
            clientClickHandlers = [];
        }
        
        function resetSimulation() {
            step = 0;
            score = 0;
            currentQuestionIndex = 0;
            clients = [];
            networkArea.innerHTML = '';
            explanationText.textContent = 'Welcome! Click the "Start" button to begin the simulation.';
            nextBtn.textContent = 'Start Simulation';
            nextBtn.style.display = 'inline-block';
            nextBtn.disabled = false;
            infoSection.classList.add('hidden');
            quizContainer.classList.add('hidden');
            nextQuestionBtn.classList.add('hidden');
            restartBtn.classList.add('hidden');
             document.querySelectorAll('.info-btn').forEach(b => b.classList.remove('active'));
        }

        nextBtn.addEventListener('click', () => {
            if (step < simulationSteps.length) {
                simulationSteps[step].action();
                step++;
            }
        });
        restartBtn.addEventListener('click', resetSimulation);
        const infoExplanations = {
            storage: { text: "All files can be stored centrally on the server, so workers can access files from any client computer on the network.", animation: async () => await animateDataPacket(server, clients[1], 'üìÇ')},
            backup: { text: "Backups are central. The server's data is backed up regularly, so individual computers don't need to be backed up separately.", animation: async () => {
                server.style.boxShadow = '0 0 25px 10px #34d399';
                await new Promise(r => setTimeout(r, 2000));
                server.style.boxShadow = '';
            }},
            security: { text: "Central security (like antivirus and firewalls) can be managed on the server, protecting the entire network.", animation: async () => {
                const shield = createDiv('shield');
                shield.innerHTML = 'üõ°Ô∏è';
                Object.assign(shield.style, {position: 'absolute', fontSize: '80px', top: '50%', left: '50%', transform: 'translate(-50%, -50%)', opacity: '0.5', zIndex: '20'});
                networkArea.appendChild(shield);
                await new Promise(r => setTimeout(r, 2500));
                shield.remove();
            }},
            upgrade: { text: "Software can be upgraded centrally on the server and deployed to all clients, saving time and ensuring consistency.", animation: async () => {
                  const promises = clients.map(client => animateDataPacket(server, client, '‚¨ÜÔ∏è'));
                  await Promise.all(promises);
            }},
            failure: { text: "If the central server fails, the entire network becomes unusable. No one can access files or communicate.", animation: async () => {
                server.style.transition = 'all 0.5s ease';
                server.style.filter = 'grayscale(100%) brightness(0.5)';
                server.style.transform = 'translate(-50%, -50%) rotate(-5deg)';
                await new Promise(r => setTimeout(r, 2500));
                server.style.filter = '';
                server.style.transform = 'translate(-50%, -50%)';
            }},
            cost: { text: "Servers are powerful computers and can be very expensive to buy and maintain compared to standard client machines.", animation: async () => await animateDataPacket(clients[2], server, 'üí∞')},
            expertise: { text: "Managing a server and the network requires specialist IT knowledge, meaning businesses need to hire skilled staff.", animation: async () => await animateDataPacket(clients[3], server, 'üßë‚Äçüîß')}
        };
        document.querySelectorAll('.info-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const key = btn.dataset.key;
                document.querySelectorAll('.info-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                explanationText.innerHTML = infoExplanations[key].text;
                if (infoExplanations[key].animation) {
                    infoExplanations[key].animation();
                }
            });
        });

        const quizQuestions = [
            { question: "What is the primary role of the server?", options: ["To store files and manage the network", "To connect directly to other clients", "To browse the internet"], answer: "To store files and manage the network" },
            { question: "A key benefit of central file storage is that...", options: ["Files are more secure on client PCs", "Workers can access files from any computer on the network", "Files can only be accessed by one person"], answer: "Workers can access files from any computer on the network" },
            { question: "What is a major drawback of a client-server network?", options: ["It is very slow", "It is difficult to add new clients", "The whole network fails if the server fails"], answer: "The whole network fails if the server fails" },
            { question: "How are software updates typically handled?", options: ["Each user installs updates manually", "Updates are deployed centrally from the server", "Only the server gets updates"], answer: "Updates are deployed centrally from the server" },
            { question: "Why is a client-server network expensive?", options: ["Client computers are expensive", "It requires a powerful, expensive server and specialist staff", "Internet costs are higher"], answer: "It requires a powerful, expensive server and specialist staff" }
        ];

        function loadQuestion() {
            quizFeedback.textContent = '';
            nextQuestionBtn.classList.add('hidden');
            restartBtn.classList.add('hidden');
            if (currentQuestionIndex >= quizQuestions.length) {
                quizContent.innerHTML = `<div class="text-center"><p class="text-2xl font-bold text-green-600">Quiz Complete!</p><p class="text-xl mt-2">You scored ${score} out of ${quizQuestions.length}</p></div>`;
                restartBtn.classList.remove('hidden');
                if (score === quizQuestions.length) {
                    grantAchievement('cs-quiz-perfect', 'Server Savvy', 'You got a perfect score on the simulation quiz!');
                    addXP(50, 'cs-quiz-perfect-score');
                } else {
                     addXP(score * 10, 'cs-quiz-score');
                }
                return;
            }
            const q = quizQuestions[currentQuestionIndex];
            quizContent.innerHTML = `<p class="text-lg font-semibold mb-4 text-center">${q.question}</p><div class="flex flex-col space-y-3">${q.options.map(option => `<button class="quiz-option p-4 rounded-lg bg-gray-100 hover:bg-blue-100 border-2 border-transparent transition-colors">${option}</button>`).join('')}</div>`;
            document.querySelectorAll('.quiz-option').forEach(optionBtn => {
                optionBtn.addEventListener('click', handleAnswer);
            });
        }
        
        function handleAnswer(e) {
            const selectedOption = e.target;
            const answer = selectedOption.textContent;
            const correctAnswer = quizQuestions[currentQuestionIndex].answer;
            document.querySelectorAll('.quiz-option').forEach(btn => {
                btn.disabled = true;
                if(btn.textContent === correctAnswer) btn.classList.add('correct');
            });
            if (answer === correctAnswer) {
                selectedOption.classList.add('correct');
                quizFeedback.textContent = "Correct!";
                quizFeedback.className = 'text-center mt-4 font-semibold text-green-600';
                score++;
            } else {
                selectedOption.classList.add('incorrect');
                quizFeedback.textContent = `Correct answer: "${correctAnswer}"`;
                quizFeedback.className = 'text-center mt-4 font-semibold text-red-600';
            }
            currentQuestionIndex++;
            nextQuestionBtn.classList.remove('hidden');
            if (currentQuestionIndex >= quizQuestions.length) {
                nextQuestionBtn.textContent = 'Show Results';
            }
        }
        nextQuestionBtn.addEventListener('click', loadQuestion);
    }
    
    // Page 5: P2P Simulation
    function initNewP2PSim() {
        const instructionBox = document.getElementById('p2p-instruction-box');
        const controls = document.getElementById('p2p-controls');
        const networkArea = document.getElementById('p2p-network-area');
        const popupContainer = document.getElementById('p2p-popup-container');
        const canvas = document.getElementById('p2p-network-canvas');
        const ctx = canvas.getContext('2d');
        const quizSection = document.getElementById('p2p-quiz-section');
        const quizContent = document.getElementById('p2p-quiz-content');
        const quizFeedback = document.getElementById('p2p-quiz-feedback');
        const nextQuestionBtn = document.getElementById('p2p-next-question-btn');
        const restartBtn = document.getElementById('p2p-restart-btn');

        const peerConfig = [
            { id: 'A', name: 'Peer A', files: ['doc1.pdf'], position: { top: '10%', left: '45%' }, infected: false },
            { id: 'B', name: 'Peer B', files: ['music.mp3'], position: { top: '40%', left: '10%' }, infected: false },
            { id: 'C', name: 'Peer C', files: [], position: { top: '40%', left: '80%' }, infected: false },
            { id: 'D', name: 'Peer D', files: ['video.mp4'], position: { top: '75%', left: '25%' }, infected: true },
            { id: 'E', name: 'Peer E', files: ['game.exe'], position: { top: '75%', left: '65%' }, infected: false }
        ];

        let peers = {};
        let simState = { step: 0, selectedPeer: null, targetPeer: null, isActionInProgress: false };
        let quizState = { score: 0, currentQuestionIndex: 0 };
        
        const peerSVG = `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7 18H17V11.0001C17 10.4478 16.5523 10.0001 16 10.0001H8C7.44772 10.0001 7 10.4478 7 11.0001V18Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 10V6M10 4H14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;

        const simulationSteps = [
            {
                instruction: `<p>Welcome! This is a <strong>Peer-to-Peer (P2P) network</strong>.</p><p>Notice there's no central server. Each computer, or 'peer', is equal and connects directly to others.</p>`,
                setup: () => { createPeers(); drawNetworkLines(); showNextButton('Start Sharing'); }
            },
            {
                instruction: `<p>Peers can share resources directly.</p><p><strong>1. Click a Peer</strong> that wants to get a file (the requester).</p><p><strong>2. Click another Peer</strong> that has the file (the provider).</p>`,
                setup: () => { simState.selectedPeer = null; simState.targetPeer = null; enablePeerSelection(); }
            },
            {
                instruction: `<p><strong>Drawback 1: Dependency</strong></p><p>What if a peer with a needed file goes offline? Click on Peer A to take it offline.</p>`,
                setup: () => {
                    const peerA = document.getElementById('p2p-peer-A');
                    peerA.onclick = () => {
                        if (simState.isActionInProgress) return;
                        togglePeerOffline('A');
                        showPopup('drawback', 'Peer A is Offline!', 'Resources on this peer are now unavailable to the network.');
                        setTimeout(nextStep, 2000);
                    };
                    hideNextButton();
                }
            },
            {
                instruction: `<p>Now Peer A is offline.</p><p>Try to get the document from Peer A. <strong>Click Peer B</strong> to request the file.</p>`,
                setup: () => {
                    const peerB = document.getElementById('p2p-peer-B');
                    peerB.onclick = () => {
                        if (simState.isActionInProgress) return;
                        showPopup('drawback', 'Request Failed!', 'Cannot connect to Peer A because it is offline.');
                        setTimeout(nextStep, 2000);
                    };
                }
            },
            {
                instruction: `<p><strong>Drawback 2: Security Risk</strong></p><p>Peer D is infected with a virus (indicated in red). Security is the responsibility of each peer.</p><p>Click Peer E to request the infected 'video.mp4' file from Peer D.</p>`,
                setup: () => {
                    if(peers['A'].isOffline) togglePeerOffline('A');
                    const peerE = document.getElementById('p2p-peer-E');
                    peerE.onclick = async () => {
                        if (simState.isActionInProgress) return;
                        simState.isActionInProgress = true;
                        disableAllPeerClicks();
                        await transferFile('D', 'E');
                        peers['E'].infected = true;
                        document.getElementById('p2p-peer-E').classList.add('infected');
                        showPopup('drawback', 'Virus Spread!', 'Peer E is now infected because there is no central security management.');
                        simState.isActionInProgress = false;
                        nextStep();
                    };
                }
            },
            {
                instruction: `<p>You've seen how P2P networks operate, including their key benefits and drawbacks.</p><p>Now, let's test your understanding!</p>`,
                setup: () => {
                    showNextButton('Take the Quiz');
                    addXP(20, 'p2p-sim-complete');
                }
            },
            {
                instruction: ``,
                setup: () => {
                    document.getElementById('p2p-main-content').classList.add('hidden');
                    quizSection.classList.remove('hidden');
                    loadQuizQuestion();
                }
            }
        ];

        function initP2PSim() {
            resizeCanvas();
            window.addEventListener('resize', () => { resizeCanvas(); drawNetworkLines(); });
            runStep();
        }
        
        function runStep() {
            const currentStep = simulationSteps[simState.step];
            instructionBox.innerHTML = currentStep.instruction;
            currentStep.setup();
        }

        function nextStep() {
            if (simState.isActionInProgress) return;
            simState.step++;
            if (simState.step < simulationSteps.length) {
                runStep();
            }
        }

        function showNextButton(text) {
            controls.innerHTML = `<button id="p2p-next-step-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-all transform hover:scale-105">${text}</button>`;
            document.getElementById('p2p-next-step-btn').onclick = nextStep;
        }

        function hideNextButton() { controls.innerHTML = ''; }

        function showPopup(type, title, message) {
            const popup = document.createElement('div');
            popup.className = `popup ${type}`;
            popup.innerHTML = `<strong class="block text-lg">${title}</strong><p class="text-sm">${message}</p>`;
            popupContainer.appendChild(popup);
            setTimeout(() => popup.classList.add('show'), 100);
            setTimeout(() => {
                popup.classList.remove('show');
                setTimeout(() => popup.remove(), 500);
            }, 3500);
        }

        function createPeers() {
            peerConfig.forEach(config => {
                const peerDiv = document.createElement('div');
                peerDiv.id = `p2p-peer-${config.id}`;
                peerDiv.className = 'peer';
                if (config.infected) peerDiv.classList.add('infected');
                peerDiv.style.top = config.position.top;
                peerDiv.style.left = config.position.left;
                peerDiv.innerHTML = `<div class="peer-icon text-blue-500">${peerSVG}</div><div class="peer-label">${config.name}<span>${config.files.join(', ')}</span></div>`;
                networkArea.appendChild(peerDiv);
                setTimeout(() => peerDiv.classList.add('visible'), 100 + (Math.random() * 500));
                peers[config.id] = { ...config, element: peerDiv, isOffline: false };
            });
        }

        function enablePeerSelection() {
            Object.values(peers).forEach(peer => {
                peer.element.onclick = () => handlePeerClick(peer.id);
            });
            hideNextButton();
        }
        
        async function handlePeerClick(peerId) {
            if (simState.isActionInProgress || peers[peerId].isOffline) return;
            if (!simState.selectedPeer) {
                simState.selectedPeer = peerId;
                peers[peerId].element.classList.add('selected');
                instructionBox.innerHTML = `<p><strong>Requester: ${peers[peerId].name}</strong></p><p>Now, click the peer that has the file you want.</p>`;
            } else if (simState.selectedPeer && !simState.targetPeer && simState.selectedPeer !== peerId) {
                simState.targetPeer = peerId;
                peers[peerId].element.classList.add('selected');
                instructionBox.innerHTML = `<p>Transferring file from <strong>${peers[simState.targetPeer].name}</strong> to <strong>${peers[simState.selectedPeer].name}</strong>...</p>`;
                simState.isActionInProgress = true;
                disableAllPeerClicks();
                await transferFile(simState.targetPeer, simState.selectedPeer);
                showPopup('benefit', 'Direct Transfer!', 'The file was shared directly between peers without needing a server.');
                peers[simState.selectedPeer].element.classList.remove('selected');
                peers[simState.targetPeer].element.classList.remove('selected');
                simState.isActionInProgress = false;
                nextStep();
            }
        }

        function disableAllPeerClicks() { Object.values(peers).forEach(peer => { peer.element.onclick = null; }); }
        
        async function transferFile(fromId, toId) {
            const fromPeer = peers[fromId];
            const toPeer = peers[toId];
            if (fromPeer.isOffline || toPeer.isOffline) return;
            const numberOfPackets = 5;
            const interval = 150;
            for (let i = 0; i < numberOfPackets; i++) {
                setTimeout(() => {
                    const packet = document.createElement('div');
                    packet.className = 'p2p-data-packet';
                    packet.innerHTML = 'üìÇ';
                    networkArea.appendChild(packet);
                    const fromRect = fromPeer.element.getBoundingClientRect();
                    const toRect = toPeer.element.getBoundingClientRect();
                    const networkRect = networkArea.getBoundingClientRect();
                    const startX = (fromRect.left + fromRect.width / 2) - networkRect.left;
                    const startY = (fromRect.top + fromRect.height / 2) - networkRect.top;
                    const endX = (toRect.left + toRect.width / 2) - networkRect.left;
                    const endY = (toRect.top + toRect.height / 2) - networkRect.top;
                    packet.style.transform = `translate(${startX - 15}px, ${startY - 15}px) scale(0)`;
                    packet.style.opacity = '1';
                    requestAnimationFrame(() => {
                        packet.style.transform = `translate(${endX - 15}px, ${endY - 15}px) scale(1)`;
                    });
                    setTimeout(() => { packet.remove(); }, 1200);
                }, i * interval);
            }
            await new Promise(r => setTimeout(r, (numberOfPackets - 1) * interval + 1200));
        }
        
        function togglePeerOffline(peerId) {
            const peer = peers[peerId];
            peer.isOffline = !peer.isOffline;
            peer.element.classList.toggle('offline');
            peer.element.onclick = null;
        }

        function resizeCanvas() {
            canvas.width = networkArea.clientWidth;
            canvas.height = networkArea.clientHeight;
        }

        function drawNetworkLines() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const peerIds = Object.keys(peers);
            if (peerIds.length < 2) return;
            ctx.strokeStyle = '#d1d5db';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            for (let i = 0; i < peerIds.length; i++) {
                for (let j = i + 1; j < peerIds.length; j++) {
                    const peer1 = peers[peerIds[i]];
                    const peer2 = peers[peerIds[j]];
                    if (peer1.isOffline || peer2.isOffline) continue;
                    const p1Rect = peer1.element.getBoundingClientRect();
                    const p2Rect = peer2.element.getBoundingClientRect();
                    const netRect = networkArea.getBoundingClientRect();
                    const x1 = p1Rect.left + p1Rect.width / 2 - netRect.left;
                    const y1 = p1Rect.top + p1Rect.height / 2 - netRect.top;
                    const x2 = p2Rect.left + p2Rect.width / 2 - netRect.left;
                    const y2 = p2Rect.top + p2Rect.height / 2 - netRect.top;
                    ctx.beginPath();
                    ctx.moveTo(x1, y1);
                    ctx.lineTo(x2, y2);
                    ctx.stroke();
                }
            }
        }
        
        const quizQuestions = [
            { q: "In a P2P network, where are files and resources typically stored?", o: ["On a central server", "On each individual peer", "In the cloud", "On a dedicated backup machine"], a: "On each individual peer" },
            { q: "What is a major benefit of the P2P model for a small company?", o: ["It offers the highest level of security.", "It's cheap to set up as it requires less specialist hardware.", "A network manager can easily monitor all traffic.", "Data is automatically backed up to a central location."], a: "It's cheap to set up as it requires less specialist hardware." },
            { q: "What does 'each computer has equal status' mean in a P2P network?", o: ["All computers have the same processing power.", "Each computer can act as both a client and a server.", "All computers must be from the same manufacturer.", "Only one computer can be online at a time."], a: "Each computer can act as both a client and a server." },
            { q: "A key drawback related to security in a P2P network is...", o: ["A single firewall protects all peers.", "Passwords are managed centrally.", "Each peer is responsible for its own security, creating potential vulnerabilities.", "Viruses cannot spread between peers."], a: "Each peer is responsible for its own security, creating potential vulnerabilities." },
            { q: "Why might a file be unavailable in a P2P network?", o: ["The central server is down.", "The network administrator has restricted access.", "The peer storing the file is switched off.", "The internet connection is too slow."], a: "The peer storing the file is switched off." }
        ];

        function loadQuizQuestion() {
            quizFeedback.textContent = '';
            nextQuestionBtn.classList.add('hidden');
            if (quizState.currentQuestionIndex >= quizQuestions.length) {
                showFinalScore();
                return;
            }
            const q = quizQuestions[quizState.currentQuestionIndex];
            const optionsHTML = shuffleArray([...q.o]).map(option => `<button class="quiz-option w-full text-left p-4 rounded-lg bg-gray-100 hover:bg-blue-100 border-2 border-gray-200 transition-all">${option}</button>`).join('');
            quizContent.innerHTML = `<p class="text-xl font-semibold mb-4 text-gray-800">${q.q}</p><div class="space-y-3">${optionsHTML}</div>`;
            document.querySelectorAll('#p2p-quiz-section .quiz-option').forEach(btn => btn.onclick = handleAnswer);
        }

        function handleAnswer(e) {
            const selectedBtn = e.target;
            const answer = selectedBtn.textContent;
            const correctAnswer = quizQuestions[quizState.currentQuestionIndex].a;
            document.querySelectorAll('#p2p-quiz-section .quiz-option').forEach(btn => {
                btn.disabled = true;
                if (btn.textContent === correctAnswer) btn.classList.add('correct');
            });
            if (answer === correctAnswer) {
                quizFeedback.textContent = "Correct!";
                quizFeedback.className = 'text-center mt-4 font-semibold text-lg text-green-600 h-8';
                quizState.score++;
                addXP(10, `p2p-quiz-q${quizState.currentQuestionIndex}`);
            } else {
                selectedBtn.classList.add('incorrect');
                quizFeedback.textContent = "Incorrect. The correct answer is highlighted.";
                quizFeedback.className = 'text-center mt-4 font-semibold text-lg text-red-600 h-8';
            }
            quizState.currentQuestionIndex++;
            nextQuestionBtn.textContent = (quizState.currentQuestionIndex >= quizQuestions.length) ? 'Show Results' : 'Next Question';
            nextQuestionBtn.classList.remove('hidden');
        }

        function showFinalScore() {
            quizContent.innerHTML = `<div class="text-center"><p class="text-2xl font-bold text-gray-800">Quiz Complete!</p><p class="text-4xl mt-4 font-bold ${quizState.score / quizQuestions.length >= 0.7 ? 'text-green-600' : 'text-blue-600'}">${quizState.score} / ${quizQuestions.length}</p></div>`;
            if (quizState.score === quizQuestions.length) {
                grantAchievement('p2p-perfect', 'P2P Pro!', 'You aced the P2P simulation quiz!');
                addXP(25, 'p2p-quiz-perfect');
            }
            quizFeedback.textContent = '';
            nextQuestionBtn.classList.add('hidden');
            restartBtn.classList.remove('hidden');
        }

        function resetAll() {
            peers = {};
            simState = { step: 0, selectedPeer: null, targetPeer: null, isActionInProgress: false };
            quizState = { score: 0, currentQuestionIndex: 0 };
            networkArea.innerHTML = '<canvas id="p2p-network-canvas"></canvas>';
            popupContainer.innerHTML = '';
            document.getElementById('p2p-main-content').classList.remove('hidden');
            quizSection.classList.add('hidden');
            restartBtn.classList.add('hidden');
            initP2PSim();
        }
        nextQuestionBtn.addEventListener('click', loadQuizQuestion);
        restartBtn.addEventListener('click', resetAll);
        initP2PSim();
    }
    
    // Page 6: Model Comparison
    function initModelComparison() {
        initMatchingTask({
            taskContainerId: 'model-comparison-task',
            itemsContainerId: 'model-comparison-items',
            resetBtnId: 'reset-model-comparison',
            idPrefix: 'model-comp',
            xp: 10,
            items: [
                { text: "Centralised security and backup", category: "CS" },
                { text: "Single point of failure", category: "CS" },
                { text: "More expensive to set up", category: "CS" },
                { text: "Allows for internet monitoring", category: "CS" },
                { text: "Cheap to set up", category: "P2P" },
                { text: "Each computer is responsible for its own security", category: "P2P" },
                { text: "No central management of files", category: "P2P" },
                { text: "File availability depends on peers being online", category: "P2P" },
            ],
            achievement: { id: 'comparison', title: 'Analyst', desc: 'You correctly compared both models!' }
        });
    }
    
    // Page 7: Summary Quiz
    function initSummaryQuiz() {
        const container = document.getElementById('summary-quiz-container');
        const questions = [
            {
                q: "Which network type would you typically find in a single school building?",
                a: ["LAN", "WAN", "PAN", "MAN"],
                correct: "LAN",
                type: 'mcq'
            },
            {
                q: "The Internet is the largest example of a WAN.",
                a: ["True", "False"],
                correct: "True",
                type: 'tf'
            },
            {
                q: "Which of these is a major drawback of the client-server model?",
                a: ["It is very cheap to set up.", "It has a single point of failure.", "Each computer is responsible for its own security.", "It is only suitable for very small networks."],
                correct: "It has a single point of failure.",
                type: 'mcq'
            },
            {
                q: "In a peer-to-peer network, all computers have equal status.",
                a: ["True", "False"],
                correct: "True",
                type: 'tf'
            },
            {
                q: "What is the primary role of a File Server?",
                a: ["To host websites.", "To manage printing jobs.", "To provide a central location for storing files.", "To handle email."],
                correct: "To provide a central location for storing files.",
                type: 'mcq'
            },
            {
                q: "Which model is generally considered more secure due to central management?",
                a: ["Peer-to-Peer", "Client-Server"],
                correct: "Client-Server",
                type: 'mcq'
            }
        ];
        
        shuffleArray(questions).forEach((item, index) => {
            const qDiv = document.createElement('div');
            qDiv.style.marginBottom = '2rem';
            const p = document.createElement('p');
            p.innerHTML = `<strong>Question ${index + 1}:</strong> ${item.q}`;
            qDiv.appendChild(p);

            const ul = document.createElement('ul');
            ul.className = item.type === 'mcq' ? 'mcq-options' : 'true-false-options';
            ul.id = `summary-q-${index}`;
            
            shuffleArray(item.a).forEach(ans => {
                const li = document.createElement('li');
                li.textContent = ans;
                li.dataset.correct = (ans === item.correct).toString();
                ul.appendChild(li);
            });
            
            qDiv.appendChild(ul);
            container.appendChild(qDiv);
            
            ul.addEventListener('click', e => {
                 if (e.target.tagName === 'LI' && !ul.classList.contains('answered')) {
                    ul.classList.add('answered');
                    const isCorrect = e.target.dataset.correct === 'true';
                    if (isCorrect) {
                        e.target.classList.add('correct');
                        addXP(20, ul.id);
                        if ('vibrate' in navigator) navigator.vibrate(50);
                    } else {
                        e.target.classList.add('incorrect');
                        ul.querySelector('[data-correct="true"]').classList.add('correct');
                    }
                    if(document.querySelectorAll('#summary-quiz-container .answered').length === questions.length) {
                        grantAchievement('quizmaster', 'Quiz Master!', 'You aced the summary quiz!');
                    }
                }
            });
        });
    }

    // Page 8: Exam Practice
    function initExamPractice() {
        const q1Answer = document.getElementById('exam-q1-answer');
        const q1RevealBtn = document.getElementById('exam-q1-reveal-btn');
        const q1MarkScheme = document.getElementById('exam-q1-mark-scheme');

        q1Answer.addEventListener('input', () => {
            const wordCount = q1Answer.value.split(' ').filter(w => w.length > 0).length;
            if (wordCount > 40 && !state.answeredItems.has('exam-q1-reveal')) {
                q1RevealBtn.disabled = false;
            }
        });

        q1RevealBtn.addEventListener('click', () => {
            q1MarkScheme.style.display = 'block';
            addXP(50, 'exam-q1-reveal');
            q1RevealBtn.disabled = true;
            q1RevealBtn.textContent = 'Mark Scheme Revealed';
        });

        const canvas = document.getElementById('drawing-canvas');
        const ctx = canvas.getContext('2d');
        let drawing = false;

        function getMousePos(canvasEl, evt) {
            const rect = canvasEl.getBoundingClientRect();
            const scaleX = canvasEl.width / rect.width;
            const scaleY = canvasEl.height / rect.height;
            const clientX = evt.clientX || evt.touches[0].clientX;
            const clientY = evt.clientY || evt.touches[0].clientY;
            return {
                x: (clientX - rect.left) * scaleX,
                y: (clientY - rect.top) * scaleY
            };
        }
        
        function startDrawing(e) {
            e.preventDefault();
            drawing = true;
            const pos = getMousePos(canvas, e);
            ctx.beginPath();
            ctx.moveTo(pos.x, pos.y);
        }

        function draw(e) {
            e.preventDefault();
            if (!drawing) return;
            const pos = getMousePos(canvas, e);
            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();
        }

        function stopDrawing(e) {
            e.preventDefault();
            drawing = false;
            ctx.closePath();
        }
        
        ctx.lineWidth = 3;
        ctx.lineCap = 'round';
        ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue('--color-text').trim();
        
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);
        canvas.addEventListener('touchstart', startDrawing);
        canvas.addEventListener('touchmove', draw);
        canvas.addEventListener('touchend', stopDrawing);

        document.getElementById('clear-canvas-btn').addEventListener('click', () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        });
        
        const q2RevealBtn = document.getElementById('exam-q2-reveal-btn');
        const q2MarkScheme = document.getElementById('exam-q2-mark-scheme');
        q2RevealBtn.addEventListener('click', () => {
            q2MarkScheme.style.display = 'block';
            addXP(20, 'exam-q2-reveal');
            q2RevealBtn.disabled = true;
        });
    }
    
    // Page 9: Extension Activities
    function initExtension() {
        function checkExtension(btnId, qId) {
             if (state.answeredItems.has(btnId)) return;
             const answer = document.getElementById(qId).value;
             if (answer.split(' ').length > 20) {
                 addXP(40, btnId);
                 grantAchievement('extension', 'Going Further', 'You completed an extension task!');
                 document.getElementById(btnId).textContent = "Submitted!";
                 document.getElementById(btnId).disabled = true;
             } else {
                 alert("Please write a more detailed response.");
             }
        }
        document.getElementById('submit-extension-q1').addEventListener('click', () => checkExtension('submit-extension-q1', 'extension-q1'));
        document.getElementById('submit-extension-q2').addEventListener('click', () => checkExtension('submit-extension-q2', 'extension-q2'));
    }

    // Page 11: PSTN Simulation
    function initPSTNSim() {
        const simArea = document.getElementById('pstn-simulation');
        const startBtn = document.getElementById('start-pstn-sim');
        const resetBtn = document.getElementById('reset-pstn-sim');
        
        let simState = {
            step: 0,
            devices: {}
        };

        const ICONS = {
            computer: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="4" y="4" width="16" height="12" rx="2"/><path d="M8 20h8"/><path d="M12 16v4"/></svg>`,
            modem: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="8" width="18" height="8" rx="1"/><circle cx="6" cy="12" r="1"/><circle cx="10" cy="12" r="1"/><circle cx="14" cy="12" r="1"/></svg>`,
            phone: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 4h4l2 5-2.5 1.5a11 11 0 005 5l1.5-2.5 5 2v4a2 2 0 01-2 2A16 16 0 013 6a2 2 0 012-2"/></svg>`,
            exchange: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 3v18"/><path d="M15 3v18"/><path d="M3 9h18"/><path d="M3 15h18"/></svg>`,
            isp: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M2 12h20"/><path d="M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"/></svg>`
        };

        function createDevice(id, type, x, y, label) {
            const device = document.createElement('div');
            device.className = 'pstn-device';
            device.id = `pstn-${id}`;
            device.style.left = x + '%';
            device.style.top = y + '%';
            device.innerHTML = `
                <div class="pstn-device-icon">${ICONS[type]}</div>
                <div class="pstn-device-label">${label}</div>
            `;
            simArea.appendChild(device);
            simState.devices[id] = { element: device, type, x, y };
            return device;
        }

        function createLine(from, to) {
            const fromEl = simState.devices[from].element;
            const toEl = simState.devices[to].element;
            const fromRect = fromEl.getBoundingClientRect();
            const toRect = toEl.getBoundingClientRect();
            const simRect = simArea.getBoundingClientRect();
            
            const x1 = fromRect.left + fromRect.width/2 - simRect.left;
            const y1 = fromRect.top + fromRect.height/2 - simRect.top;
            const x2 = toRect.left + toRect.width/2 - simRect.left;
            const y2 = toRect.top + toRect.height/2 - simRect.top;
            
            const length = Math.sqrt((x2-x1)**2 + (y2-y1)**2);
            const angle = Math.atan2(y2-y1, x2-x1) * 180 / Math.PI;
            
            const line = document.createElement('div');
            line.className = 'pstn-line';
            line.id = `line-${from}-${to}`;
            line.style.width = length + 'px';
            line.style.left = x1 + 'px';
            line.style.top = y1 + 'px';
            line.style.transform = `rotate(${angle}deg)`;
            simArea.appendChild(line);
            return line;
        }

        function showConversion(x, y, text) {
            const box = document.createElement('div');
            box.className = 'data-conversion-box';
            box.style.left = x + '%';
            box.style.top = y + '%';
            box.textContent = text;
            simArea.appendChild(box);
            setTimeout(() => box.style.opacity = '1', 100);
            setTimeout(() => {
                box.style.opacity = '0';
                setTimeout(() => box.remove(), 500);
            }, 3000);
        }

        async function animateSignal(from, to, isAnalog = false) {
            for (let i = 0; i < 3; i++) {
                const signal = document.createElement('div');
                signal.className = 'signal-wave';
                signal.style.left = simState.devices[from].x + 5 + '%';
                signal.style.top = simState.devices[from].y + 5 + '%';
                if (isAnalog) signal.style.borderColor = '#f59e0b';
                simArea.appendChild(signal);
                setTimeout(() => signal.remove(), 2000);
                await new Promise(r => setTimeout(r, 300));
            }
            
            const line = document.getElementById(`line-${from}-${to}`);
            if (line) {
                line.classList.add('active');
                setTimeout(() => line.classList.remove('active'), 1000);
            }
        }

        async function runSimulation() {
            // Step 1: Set up devices
            createDevice('computer', 'computer', 10, 40, 'Your Computer');
            createDevice('modem', 'modem', 30, 40, 'Modem');
            createDevice('phone', 'phone', 50, 20, 'Phone Line');
            createDevice('exchange', 'exchange', 70, 40, 'Exchange');
            createDevice('isp', 'isp', 90, 40, 'ISP');
            
            await new Promise(r => setTimeout(r, 500));
            
            // Step 2: Draw connections
            createLine('computer', 'modem');
            createLine('modem', 'phone');
            createLine('phone', 'exchange');
            createLine('exchange', 'isp');
            
            await new Promise(r => setTimeout(r, 1000));
            
            // Step 3: Show data conversion
            simState.devices.computer.element.classList.add('active');
            await animateSignal('computer', 'modem');
            showConversion(25, 25, 'Digital ‚Üí Analog');
            
            await new Promise(r => setTimeout(r, 2000));
            
            // Step 4: Analog signal through phone line
            simState.devices.modem.element.classList.add('active');
            await animateSignal('modem', 'phone', true);
            await animateSignal('phone', 'exchange', true);
            
            await new Promise(r => setTimeout(r, 1000));
            
            // Step 5: Connection to ISP
            simState.devices.exchange.element.classList.add('active');
            await animateSignal('exchange', 'isp');
            showConversion(80, 25, 'Connected to Internet!');
            simState.devices.isp.element.classList.add('active');
            
            addXP(15, 'pstn-sim-complete');
        }

        function reset() {
            simArea.innerHTML = '';
            simState = { step: 0, devices: {} };
        }

        startBtn.addEventListener('click', () => {
            reset();
            runSimulation();
        });
        
        resetBtn.addEventListener('click', reset);
    }

    // PSTN Matching Task
    function initPSTNMatching() {
        initMatchingTask({
            taskContainerId: 'pstn-matching-task',
            itemsContainerId: 'pstn-items',
            resetBtnId: 'reset-pstn-matching',
            idPrefix: 'pstn',
            xp: 10,
            items: [
                { text: "Modem", category: "modem" },
                { text: "Telephone Exchange", category: "exchange" },
                { text: "Copper Telephone Lines", category: "copper" },
                { text: "Internet Service Provider", category: "isp" }
            ],
            achievement: { id: 'pstn-master', title: 'PSTN Expert', desc: 'You understand how dial-up internet works!' },
            originalDropText: {
                modem: 'Converts digital to analog signals',
                exchange: 'Routes calls between subscribers',
                copper: 'Carries analog voice signals',
                isp: 'Provides internet connectivity'
            }
        });
    }

    // Page 12: Cell Tower Simulation
    function initCellTowerSim() {
        const simArea = document.getElementById('cell-simulation');
        const startBtn = document.getElementById('start-cell-sim');
        const resetBtn = document.getElementById('reset-cell-sim');
        
        let simState = {
            towers: [],
            device: null,
            isMoving: false,
            currentTower: null
        };

        function createTower(id, x, y) {
            const tower = document.createElement('div');
            tower.className = 'cell-tower';
            tower.id = `tower-${id}`;
            tower.style.left = x + '%';
            tower.style.top = y + '%';
            tower.innerHTML = `
                <div class="cell-tower-icon">
                    <div class="tower-base"></div>
                    <div class="tower-antenna"></div>
                </div>
                <div class="pstn-device-label">Tower ${id}</div>
            `;
            
            const coverage = document.createElement('div');
            coverage.className = 'coverage-area';
            coverage.style.width = '300px';
            coverage.style.height = '300px';
            coverage.style.left = (x - 15) + '%';
            coverage.style.top = (y - 25) + '%';
            
            simArea.appendChild(coverage);
            simArea.appendChild(tower);
            
            simState.towers.push({ id, element: tower, coverage, x, y });
        }

        function createMobileDevice() {
            const device = document.createElement('div');
            device.className = 'mobile-device';
            device.id = 'mobile-device';
            device.style.left = '10%';
            device.style.top = '50%';
            device.innerHTML = `
                <div class="mobile-device-icon">üì±</div>
                <div class="signal-strength">Signal: --</div>
            `;
            simArea.appendChild(device);
            simState.device = device;
        }

        function calculateSignalStrength(deviceX, deviceY, towerX, towerY) {
            const distance = Math.sqrt((deviceX - towerX)**2 + (deviceY - towerY)**2);
            if (distance < 15) return 'Strong';
            if (distance < 25) return 'Medium';
            if (distance < 35) return 'Weak';
            return 'None';
        }

        function updateSignal() {
            const deviceRect = simState.device.getBoundingClientRect();
            const simRect = simArea.getBoundingClientRect();
            const deviceX = ((deviceRect.left - simRect.left) / simRect.width) * 100;
            const deviceY = ((deviceRect.top - simRect.top) / simRect.height) * 100;
            
            let bestTower = null;
            let bestSignal = 'None';
            
            simState.towers.forEach(tower => {
                const signal = calculateSignalStrength(deviceX, deviceY, tower.x, tower.y);
                if (signal !== 'None' && (bestSignal === 'None' || 
                    (signal === 'Strong' && bestSignal !== 'Strong') ||
                    (signal === 'Medium' && bestSignal === 'Weak'))) {
                    bestTower = tower;
                    bestSignal = signal;
                }
            });
            
            // Update signal display
            const signalEl = simState.device.querySelector('.signal-strength');
            signalEl.textContent = `Signal: ${bestSignal}`;
            
            // Handle handoff
            if (bestTower && bestTower !== simState.currentTower) {
                if (simState.currentTower) {
                    simState.currentTower.coverage.classList.remove('active');
                    // Show handoff animation
                    if (bestSignal !== 'None') {
                        showHandoff(simState.currentTower, bestTower);
                    }
                }
                
                simState.currentTower = bestTower;
                if (bestSignal !== 'None') {
                    bestTower.coverage.classList.add('active');
                    simState.device.classList.add('connected');
                }
            } else if (!bestTower) {
                if (simState.currentTower) {
                    simState.currentTower.coverage.classList.remove('active');
                }
                simState.currentTower = null;
                simState.device.classList.remove('connected');
            }
        }

        function showHandoff(fromTower, toTower) {
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.className = 'handoff-animation';
            svg.style.position = 'absolute';
            svg.style.width = '100%';
            svg.style.height = '100%';
            svg.style.left = '0';
            svg.style.top = '0';
            
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.classList.add('handoff-line');
            line.setAttribute('x1', fromTower.x + '%');
            line.setAttribute('y1', fromTower.y + '%');
            line.setAttribute('x2', toTower.x + '%');
            line.setAttribute('y2', toTower.y + '%');
            
            svg.appendChild(line);
            simArea.appendChild(svg);
            
            setTimeout(() => line.style.opacity = '1', 100);
            setTimeout(() => svg.remove(), 2000);
            
            addXP(5, `handoff-${fromTower.id}-${toTower.id}`);
        }

        async function startMovement() {
            if (simState.isMoving) return;
            simState.isMoving = true;
            
            const positions = [
                { x: 10, y: 50 },
                { x: 30, y: 40 },
                { x: 50, y: 50 },
                { x: 70, y: 60 },
                { x: 85, y: 50 }
            ];
            
            for (let pos of positions) {
                if (!simState.isMoving) break;
                simState.device.style.left = pos.x + '%';
                simState.device.style.top = pos.y + '%';
                await new Promise(r => setTimeout(r, 100));
                updateSignal();
                await new Promise(r => setTimeout(r, 1900));
            }
            
            simState.isMoving = false;
            addXP(20, 'cell-movement-complete');
        }

        function reset() {
            simArea.innerHTML = '';
            simState = { towers: [], device: null, isMoving: false, currentTower: null };
            
            // Create towers
            createTower('A', 20, 30);
            createTower('B', 50, 40);
            createTower('C', 80, 35);
            
            // Create mobile device
            createMobileDevice();
            
            // Initial signal check
            updateSignal();
        }

        startBtn.addEventListener('click', startMovement);
        resetBtn.addEventListener('click', () => {
            simState.isMoving = false;
            reset();
        });
        
        // Initialize
        reset();
    }

    // Cell Network Quiz
    function initCellQuiz() {
        const quizOptions = document.querySelectorAll('#cell-quiz-container .mcq-options');
        
        quizOptions.forEach(ul => {
            ul.addEventListener('click', e => {
                if (e.target.tagName === 'LI' && !ul.classList.contains('answered')) {
                    ul.classList.add('answered');
                    const isCorrect = e.target.dataset.correct === 'true';
                    
                    if (isCorrect) {
                        e.target.classList.add('correct');
                        addXP(10, ul.id);
                    } else {
                        e.target.classList.add('incorrect');
                        ul.querySelector('[data-correct="true"]').classList.add('correct');
                    }
                    
                    // Check if all questions answered
                    const allAnswered = document.querySelectorAll('#cell-quiz-container .answered').length;
                    const totalQuestions = document.querySelectorAll('#cell-quiz-container .mcq-options').length;
                    
                    if (allAnswered === totalQuestions) {
                        grantAchievement('cell-expert', 'Mobile Master', 'You understand cell phone networks!');
                    }
                }
            });
        });
    }

    // --- EASTER EGG ---
    function initEasterEgg() {
        document.querySelector('.main-header h1').addEventListener('click', () => {
            state.easterEggClicks++;
            if (state.easterEggClicks === 10) {
                grantAchievement('easteregg', 'Curious Explorer', 'You found a hidden secret!');
                addXP(50, 'easter-egg');
            }
        });
    }

    // --- INITIALIZATION CALL ---
    function init() {
        initNav();
        initSettings();
        initPastePrevention();
        initFeedback();
        initEasterEgg();
        
        initStarterTask();
        initLanWanServerSim();
        initLanWanScenarioTask();
        initServerMatchingTask();
        initNewClientServerSim(); 
        initNewP2PSim();
        initModelComparison();
        initSummaryQuiz();
        initExamPractice();
        initExtension();
        initPSTNSim();
        initPSTNMatching();
        initCellTowerSim();
        initCellQuiz();
    }

    init();
});
</script>
</body>
</html>