<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Year 9 Python Course - Section 9: While Loops</title>
    
    <!-- External Dependencies (Required - DO NOT MODIFY VERSIONS) -->
    <!-- CodeMirror CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/solarized.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldgutter.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/lint/lint.min.css">

    <!-- Sound Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    
    <!-- Pyodide -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    
    <!-- CodeMirror JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/python-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldgutter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/brace-fold.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/indent-fold.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/lint/lint.min.js"></script>
    
    <!-- Font for dyslexia support -->
    <link href="https://fonts.googleapis.com/css2?family=OpenDyslexic:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* CSS Variables for While Loops Theme */
        :root {
            --primary-color: #8b5cf6; /* Purple for loops */
            --primary-dark: #7c3aed;
            --primary-light: #a78bfa;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --xp-color: #fbbf24;
            --bg-primary: #f5f3ff;
            --bg-secondary: white;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        /* Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        body.dyslexic-font {
            font-family: 'OpenDyslexic', sans-serif;
        }

        /* Header Styles */
        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 1.5rem 0;
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: 'while True:';
            position: absolute;
            font-size: 100px;
            opacity: 0.1;
            right: -20px;
            top: 0px;
            transform: rotate(-15deg);
            font-family: monospace;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 1;
        }

        .header-left h1 {
            font-size: 2rem;
            margin-bottom: 0.25rem;
            font-weight: 700;
        }

        .header-left p {
            font-size: 1.1rem;
            opacity: 0.95;
        }

        /* User Stats */
        .user-stats {
            display: flex;
            gap: 2rem;
            background: rgba(255, 255, 255, 0.15);
            padding: 1rem 1.5rem;
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }

        .stat-item {
            text-align: center;
            min-width: 80px;
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        .xp-bar {
            width: 100px;
            height: 6px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
            margin-top: 0.5rem;
            overflow: hidden;
        }

        .xp-fill {
            height: 100%;
            background: var(--xp-color);
            transition: width 0.5s ease;
            border-radius: 3px;
        }

        /* Progress Section */
        .progress-section {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem 2rem 1rem 2rem;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: white;
            transition: width 0.5s ease;
            border-radius: 5px;
        }

        .badges-preview {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .badge {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            filter: grayscale(100%);
            opacity: 0.5;
        }

        .badge.earned {
            filter: grayscale(0%);
            opacity: 1;
            background: rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
        }

        .badge:hover {
            transform: scale(1.1);
        }

        /* Main Container */
        .main-container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 2rem;
            min-height: calc(100vh - 300px);
        }

        /* Sidebar */
        .sidebar {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--shadow-md);
            height: fit-content;
            position: sticky;
            top: 2rem;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--primary-light);
        }

        .task-list {
            list-style: none;
            margin-bottom: 1.5rem;
        }

        .task-item {
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .task-item:hover {
            background: var(--bg-primary);
            border-color: var(--primary-light);
        }

        .task-item.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .task-item.completed {
            border-left: 4px solid var(--success-color);
        }

        .task-xp {
            font-size: 0.75rem;
            opacity: 0.7;
            font-weight: 500;
        }

        /* Extension Toggle */
        .extension-toggle {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: var(--primary-light);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 1rem;
        }

        .extension-toggle:hover {
            background: var(--primary-color);
        }

        .extension-icon {
            font-size: 1.25rem;
        }

        .extension-arrow {
            margin-left: auto;
            transition: transform 0.3s ease;
        }

        .extension-arrow.open {
            transform: rotate(90deg);
        }

        .extension-section {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--bg-primary);
            border-radius: 8px;
        }

        /* Content Area */
        .content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: var(--shadow-md);
            min-height: 600px;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
        }

        .task-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .task-type {
            display: inline-block;
            padding: 0.25rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
            text-transform: uppercase;
        }

        .task-type.example { background: #dbeafe; color: #1e40af; }
        .task-type.practice { background: #d1fae5; color: #065f46; }
        .task-type.challenge { background: #fef3c7; color: #92400e; }
        .task-type.assessment { background: #ede9fe; color: #5b21b6; }

        /* Instructions */
        .instructions {
            margin-bottom: 2rem;
            line-height: 1.8;
        }

        .instructions h3 {
            color: var(--primary-color);
            margin: 1.5rem 0 0.75rem 0;
            font-size: 1.2rem;
        }

        .instructions pre {
            background: #f3f4f6;
            padding: 1rem;
            border-radius: 8px;
            overflow-x: auto;
            margin: 1rem 0;
            border-left: 4px solid var(--primary-color);
        }
        
        .instructions code {
            background: #f3f4f6;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }


        .instructions ul, .instructions ol {
            margin: 0.5rem 0 0.5rem 2rem;
        }

        .instructions li {
            margin: 0.5rem 0;
        }

        .instructions .why-matters,
        .instructions .common-mistake {
            margin: 1.5rem 0;
        }

        /* Code Editor */
        .editor-container {
            margin: 1.5rem 0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }

        .editor-header {
            background: var(--text-primary);
            color: white;
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .editor-title {
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .editor-actions {
            display: flex;
            gap: 0.5rem;
        }

        .editor-btn {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 0.4rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .editor-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .editor-btn.run {
            background: var(--success-color);
            border-color: var(--success-color);
        }

        .editor-btn.run:hover {
            background: #059669;
        }

        .CodeMirror {
            height: 300px;
            font-size: 1rem;
        }

        /* Output Panel */
        .output-panel {
            margin-top: 1rem;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }

        .output-header {
            background: #f9fafb;
            padding: 0.75rem 1rem;
            font-weight: 500;
            border-bottom: 1px solid var(--border-color);
        }

        .output-content {
            padding: 1rem;
            font-family: 'Courier New', monospace;
            min-height: 100px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            line-height: 1.5;
        }

        .output-content.error {
            color: var(--error-color);
        }

        /* Control Buttons */
        .controls {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: #f3f4f6;
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        /* Hints */
        .hint-box {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            display: none;
        }

        .hint-box.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        .hint-header {
            font-weight: 600;
            color: #92400e;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Checks */
        .checks-container {
            margin-top: 2rem;
            padding: 1.5rem;
            background: #f9fafb;
            border-radius: 8px;
        }

        .check-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
            padding: 0.5rem;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .check-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .check-icon.pending {
            background: #e5e7eb;
            color: #6b7280;
        }

        .check-icon.passed {
            background: var(--success-color);
            color: white;
        }

        .check-icon.failed {
            background: var(--error-color);
            color: white;
        }

        /* Achievement Notification */
        .achievement {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: white;
            padding: 1.5rem 2rem;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 1rem;
            opacity: 0;
            transform: translateX(400px);
            transition: all 0.5s ease;
            z-index: 1000;
            border-left: 4px solid var(--xp-color);
        }

        .achievement.show {
            opacity: 1;
            transform: translateX(0);
        }

        .achievement-icon {
            font-size: 2.5rem;
        }

        .achievement-content h3 {
            margin-bottom: 0.25rem;
            color: var(--text-primary);
        }

        .achievement-xp {
            color: var(--xp-color);
            font-weight: 600;
        }

        /* Why This Matters Box */
        .why-matters {
            background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%);
            border: 2px solid var(--primary-light);
            border-radius: 8px;
            padding: 1rem;
            margin: 1.5rem 0;
            position: relative;
            overflow: hidden;
        }

        .why-matters::before {
            content: 'üí°';
            position: absolute;
            font-size: 60px;
            opacity: 0.1;
            right: 10px;
            top: -10px;
        }

        .why-matters h4 {
            color: var(--primary-dark);
            margin: 0 0 0.5rem 0;
            font-size: 1.1rem;
        }

        .why-matters p {
            color: #5b21b6;
            margin: 0;
            position: relative;
            z-index: 1;
        }

        /* Common Mistake Box */
        .common-mistake {
            background: #fee2e2;
            border: 2px solid #ef4444;
            border-radius: 8px;
            padding: 1rem;
            margin: 1.5rem 0;
            position: relative;
        }

        .common-mistake h4 {
            color: #991b1b;
            margin: 0 0 0.5rem 0;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .common-mistake p {
            color: #7f1d1d;
            margin: 0.5rem 0;
        }

        .common-mistake pre,
        .common-mistake code {
            background: #fef2f2;
            border-left: 4px solid #ef4444;
            padding: 0.75rem;
            margin: 0.5rem 0;
            color: #991b1b;
        }
        
        /* Assessment & Worksheet Styles */
        .worksheet-section {
            margin-top: 2rem;
        }
        .worksheet-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
        }
        .worksheet-question {
            background-color: #f9fafb;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .worksheet-question h4 {
            margin: 0 0 1rem 0;
            font-weight: 600;
        }
        .worksheet-answer {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
        }
        .worksheet-answer:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }
        .worksheet-code {
            background: #f3f4f6;
            padding: 1rem;
            border-radius: 8px;
            overflow-x: auto;
            margin: 1rem 0;
            border-left: 4px solid var(--primary-light);
            font-family: 'Courier New', monospace;
        }

        /* Game Selection Screen Styles */
        .game-selection-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }
        
        .game-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-sm);
        }
        
        .game-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-md);
        }
        
        .game-card h3 {
            margin-top: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-primary);
        }
        
        .game-card p {
            flex-grow: 1;
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
            font-size: 0.95rem;
        }
        
        .play-btn {
            background-color: var(--success-color);
            color: white;
            text-decoration: none;
            text-align: center;
            justify-content: center;
            width: 100%;
        }
        
        .play-btn:hover {
            background-color: #059669;
        }
        
        .game-card.disabled {
            opacity: 0.6;
            background: #f8fafc;
        }
        
        .game-card.disabled:hover {
            transform: none;
            box-shadow: var(--shadow-sm);
        }
        
        .game-card.disabled .play-btn {
            background-color: var(--text-secondary);
            cursor: not-allowed;
        }

        /* Game Modal Styles */
        .game-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            transition: opacity 0.3s ease;
        }
        
        .game-modal {
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 2rem;
            width: 90%;
            max-width: 600px;
            text-align: center;
            box-shadow: var(--shadow-lg);
            position: relative;
            transform: scale(0.95);
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .game-modal-overlay.show {
            display: flex;
            opacity: 1;
        }
        
        .game-modal-overlay.show .game-modal {
            transform: scale(1);
            opacity: 1;
        }
        
        .game-modal h2 {
            margin-top: 0;
            color: var(--primary-dark);
        }
        
        .game-modal .close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
        }
        
        .game-stats {
            display: flex;
            justify-content: space-around;
            font-size: 1.25rem;
            margin: 1.5rem 0;
        }
        
        .game-problem {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 1.5rem 0;
            color: var(--text-primary);
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            border: 2px solid var(--border-color);
            min-height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        
        .game-input {
            width: 100%;
            padding: 1rem;
            font-size: 1.5rem;
            text-align: center;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            transition: all 0.2s;
            margin-top: 1rem;
        }
        
        .game-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
        }
        
        .game-input.correct {
            border-color: var(--success-color);
            background-color: #d1fae5;
            animation: pulse-green 0.3s;
        }
        
        .game-input.incorrect {
            border-color: var(--error-color);
            background-color: #fee2e2;
            animation: shake 0.3s;
        }
        
        .game-feedback {
            min-height: 1.5rem;
            margin-top: 1rem;
            color: var(--error-color);
            font-weight: 500;
        }
        
        .game-final-score strong {
            font-size: 2rem;
            color: var(--primary-color);
        }

        /* Game-specific styles */
        .countdown-display {
            font-size: 4rem;
            font-weight: bold;
            color: var(--primary-color);
            margin: 2rem 0;
        }

        .stop-button {
            font-size: 1.5rem;
            padding: 1rem 3rem;
            background: var(--error-color);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .stop-button:hover {
            transform: scale(1.05);
            background: #dc2626;
        }

        .stop-button:active {
            transform: scale(0.95);
        }

        .game-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .option-btn {
            padding: 1rem;
            font-size: 1.1rem;
            background: var(--bg-secondary);
            border: 2px solid var(--primary-light);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .option-btn:hover {
            background: var(--primary-light);
            color: white;
        }

        .option-btn.correct {
            background: var(--success-color);
            color: white;
            border-color: var(--success-color);
        }

        .option-btn.incorrect {
            background: var(--error-color);
            color: white;
            border-color: var(--error-color);
        }

        /* Accessibility Features */
        .accessibility-menu {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            padding: 1rem;
            display: none;
            z-index: 999;
        }

        .accessibility-toggle {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 56px;
            height: 56px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s ease;
            z-index: 998;
        }

        .accessibility-toggle:hover {
            transform: scale(1.1);
            background: var(--primary-dark);
        }

        /* Animations */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse-green {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        /* Responsive Design */
        @media (max-width: 1024px) {
            .main-container {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                position: static;
                margin-bottom: 2rem;
            }
            
            .header-content {
                flex-direction: column;
                gap: 1.5rem;
                text-align: center;
            }
            
            .user-stats {
                width: 100%;
                justify-content: center;
            }
        }

        @media (max-width: 640px) {
            .header-left h1 {
                font-size: 1.5rem;
            }
            
            .content {
                padding: 1rem;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .achievement {
                right: 1rem;
                left: 1rem;
                top: auto;
                bottom: 5rem;
            }
        }

        /* Loading State */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 200px;
            color: var(--text-secondary);
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60% { content: '...'; }
            80%, 100% { content: ''; }
        }

        /* Mini Game Icon */
        .game-icon {
            font-size: 1.1rem;
        }
    </style>
</head>
<body oncopy="return false" oncut="return false" onpaste="return false">
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div class="header-left">
                <h1>Year 9 Python Programming</h1>
                <p>Section 9 - While Loops</p>
            </div>
            <div class="user-stats">
                <div class="stat-item">
                    <div class="stat-value" id="userLevel">1</div>
                    <div class="stat-label">Level</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="userXP">0</div>
                    <div class="stat-label">XP</div>
                    <div class="xp-bar">
                        <div class="xp-fill" id="xpFill" style="width: 0%"></div>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="userStreak">0</div>
                    <div class="stat-label">Day Streak</div>
                </div>
            </div>
        </div>
        
        <div class="progress-section">
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar"></div>
            </div>
            <p style="margin: 5px 0 0 0; font-size: 14px; color: white;">
                Progress: <span id="progressText">0/9 tasks completed</span>
            </p>
            <div class="badges-preview">
                <div class="badge" id="badge-beginner" title="Loop Beginner - Complete the first 3 tasks">üîÅ</div>
                <div class="badge" id="badge-countdown" title="Countdown Commander - Complete the countdown task">üöÄ</div>
                <div class="badge" id="badge-accumulator" title="Accumulator Ace - Complete the accumulator task">üßÆ</div>
                <div class="badge" id="badge-guesser" title="Master Guesser - Complete the guessing game challenge">üéØ</div>
                <div class="badge" id="badge-perfect" title="Perfect Score - Complete 5 tasks without using hints">‚≠ê</div>
                <div class="badge" id="badge-first-try" title="Quick Learner - Complete 3 tasks on first try">üß†</div>
                <div class="badge" id="badge-infinite" title="Infinite Investigator - Explain infinite loops correctly">‚ôæÔ∏è</div>
                <div class="badge" id="badge-scholar" title="Loop Scholar - Complete the final assessment">üéì</div>
                <div class="badge" id="badge-champion" title="Section Champion - Complete all tasks and extensions">üèÜ</div>
            </div>
        </div>
    </div>

    <!-- Main content area -->
    <div class="main-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="section-title">Section 9 - While Loops</div>
            <ul class="task-list" id="taskList">
                <!-- Task items will be dynamically generated -->
            </ul>
            
            <div class="extension-toggle" onclick="toggleExtension()">
                <span class="extension-icon">üöÄ</span>
                <span class="extension-text">Extension Activities</span>
                <span class="extension-arrow" id="extensionArrow">‚ñ∂</span>
            </div>
            <div class="extension-section" id="extensionSection" style="display: none;">
                <div class="task-item" onclick="showExtensionTopic('menu-system')">
                    <span>Text-Based Menu System</span>
                    <span class="task-xp">50 XP</span>
                </div>
                <div class="task-item" onclick="showExtensionTopic('input-validation')">
                    <span>Input Validation Loop</span>
                    <span class="task-xp">40 XP</span>
                </div>
                <div class="task-item" onclick="showExtensionTopic('collatz')">
                    <span>The Collatz Conjecture</span>
                    <span class="task-xp">60 XP</span>
                </div>
                <div class="task-item" onclick="showGameScreen()">
                    <span class="game-icon">üéÆ</span>
                    <span>Mini Games</span>
                </div>
            </div>
        </aside>
        
        <!-- Main content -->
        <main class="content">
            <div id="taskContent">
                <div class="loading">Loading Python environment</div>
            </div>
            <div id="extensionContent" style="display: none;">
                <!-- Extension content loads here -->
            </div>
            <div id="gameContent" style="display: none;">
                <!-- Game selection screen loads here -->
            </div>
        </main>
    </div>

    <!-- Game Modal HTML -->
    <div class="game-modal-overlay" id="gameModalOverlay">
        <div class="game-modal" id="gameModal">
            <button class="close-btn" onclick="closeGameModal()">&times;</button>
            <div id="gameStartScreen">
                <h2 id="gameTitle">Game Title</h2>
                <p id="gameDescription">Game description</p>
                <button class="btn btn-primary" onclick="startGame()">Start Game</button>
            </div>
            <div id="gamePlayScreen" style="display: none;">
                <div class="game-stats">
                    <div>Score: <strong id="gameScore">0</strong></div>
                    <div>Time: <strong id="gameTimer">60</strong>s</div>
                </div>
                <div id="gameArea"></div>
            </div>
            <div id="gameOverScreen" style="display: none;">
                <h2>Game Over!</h2>
                <p class="game-final-score">Your score: <strong><span id="finalScore">0</span></strong></p>
                <p>High Score: <span id="highScore">0</span></p>
                <button class="btn btn-primary" onclick="restartGame()">Play Again</button>
                <button class="btn btn-secondary" onclick="closeGameModal()">Back to Games</button>
            </div>
        </div>
    </div>

    <!-- Achievement notification -->
    <div class="achievement" id="achievementPopup">
        <div class="achievement-icon" id="achievementIcon">üèÜ</div>
        <div class="achievement-content">
            <h3 id="achievementTitle">Achievement Unlocked!</h3>
            <p id="achievementMessage">You've completed a task!</p>
            <p class="achievement-xp">+<span id="achievementXP">50</span> XP</p>
        </div>
    </div>

    <!-- Accessibility Menu -->
    <button class="accessibility-toggle" onclick="toggleAccessibility()" title="Accessibility Options">
        ‚ôø
    </button>
    
    <div class="accessibility-menu" id="accessibilityMenu">
        <h3>Accessibility Options</h3>
        <label>
            <input type="checkbox" onchange="toggleDyslexicFont(this.checked)">
            Dyslexic-friendly font
        </label>
        <br>
        <label>
            <input type="checkbox" onchange="toggleHighContrast(this.checked)">
            High contrast mode
        </label>
    </div>

    <script>
        // Global variables
        let pyodide = null;
        let editors = {};
        let extensionEditors = {};
        let currentTask = 1;
        let userProgress = {
            completedTasks: {},
            hintsUsed: {},
            xp: 0,
            level: 1,
            streak: 0,
            lastVisit: new Date().toDateString(),
            badges: {},
            perfectTasks: 0,
            firstTryTasks: 0,
            taskAttempts: {},
            assessmentAnswers: {}
        };

        // Badge definitions
        const BADGES = {
            'beginner': { icon: 'üîÅ', name: 'Loop Beginner', desc: 'Complete the first 3 tasks', check: () => [1, 2, 3].every(t => userProgress.completedTasks[t]) },
            'countdown': { icon: 'üöÄ', name: 'Countdown Commander', desc: 'Complete the countdown task', check: () => userProgress.completedTasks[4] },
            'accumulator': { icon: 'üßÆ', name: 'Accumulator Ace', desc: 'Complete the accumulator task', check: () => userProgress.completedTasks[8] },
            'guesser': { icon: 'üéØ', name: 'Master Guesser', desc: 'Complete the guessing game challenge', check: () => userProgress.completedTasks[13] && !userProgress.hintsUsed[13] },
            'perfect': { icon: '‚≠ê', name: 'Perfect Score', desc: 'Complete 5 tasks without using hints', check: () => userProgress.perfectTasks >= 5 },
            'first-try': { icon: 'üß†', name: 'Quick Learner', desc: 'Complete 3 tasks on first try', check: () => userProgress.firstTryTasks >= 3 },
            'infinite': { icon: '‚ôæÔ∏è', name: 'Infinite Investigator', desc: 'Explain infinite loops correctly', check: () => userProgress.assessmentAnswers[1] && userProgress.assessmentAnswers[1].toLowerCase().includes('never stop') },
            'scholar': { icon: 'üéì', name: 'Loop Scholar', desc: 'Complete the final assessment', check: () => userProgress.completedTasks[9] },
            'champion': { icon: 'üèÜ', name: 'Section Champion', desc: 'Complete all tasks and extensions', check: () => Object.keys(userProgress.completedTasks).length >= 9 }
        };

        // Task definitions
        const tasks = {
            1: {
                id: "f305b0b8-d13b-45aa-9840-8c4f47407fc9",
                title: "9.1 While Loops",
                type: "example",
                xp: 50,
                instructions: `
                    <h3>While Loops</h3>
                    <p>The <code>while</code> loop repeats a block of instructions as long as a given condition is <strong>True</strong>. Each repetition is called an <strong>iteration</strong>.</p>
                    <p>We can use a <code>while</code> loop to print a sequence of numbers.</p>
                    
                    <h3>In English</h3>
                    <ul>
                        <li>A number <code>n</code> starts at 1.</li>
                        <li>While it is less than 4, print it out, then increase it by 1.</li>
                        <li>When <code>n</code> reaches 4, the condition <code>n < 4</code> is no longer True, so the loop ends.</li>
                    </ul>
                    
                    <h3>Your Task</h3>
                    <ol>
                        <li>Change <code>n</code> to 5 and run the code. Notice that nothing happens because <code>n</code> is never less than 4.</li>
                        <li>Change <code>n</code> back to 1, then change the condition on line 3 so that numbers from 1 to 9 are printed.</li>
                    </ol>
                `,
                starterCode: `n = 1\n\nwhile n < 4:\n\tprint(n)\n\tn = n + 1`,
                hints: [
                    "To print numbers up to 9, the loop needs to continue as long as 'n' is less than what number?",
                    "The condition should be `while n < 10` or `while n <= 9`."
                ],
                checks: [
                    { name: "Code prints the number 9", test: (code, output) => output.includes('9') && !output.includes('10') },
                    { name: "Code does not print the number 10", test: (code, output) => !output.includes('10') },
                    { name: "Condition is changed from 'n < 4'", test: (code, output) => !code.includes('n < 4') }
                ]
            },
            2: {
                id: "89efa328-5202-495d-ba98-4baf2cfe79df",
                title: "9.2 Print Every Year of Life",
                type: "practice",
                xp: 75,
                instructions: `
                    <h3>Task: Years Alive</h3>
                    <p>Given the <code>year</code> a person was born, print every year that the person has been alive, up to the current year (let's assume 2024).</p>
                    
                    <h3>Reminder</h3>
                    <pre>n = 1
while n < 4:
	print(n)
	n = n + 1</pre>
                `,
                starterCode: `year = 2000\n\n# Your code here`,
                hints: [
                    "You need a loop that starts at the birth year.",
                    "The loop should continue as long as the year is less than or equal to 2024.",
                    "Inside the loop, print the year and then add 1 to it."
                ],
                checks: [
                    { name: "Prints the start year (2000)", test: (code, output) => output.includes('2000') },
                    { name: "Prints the end year (2024)", test: (code, output) => output.includes('2024') },
                    { name: "Uses a while loop", test: (code, output) => code.includes('while') }
                ]
            },
            3: {
                id: "7b0810c8-1045-4733-a5a1-d106b8f8b6a7",
                title: "9.3 Components of a While Loop",
                type: "practice",
                xp: 75,
                instructions: `
                    <h3>Anatomy of a Loop</h3>
                    <ul>
                        <li><strong>Initialization:</strong> Set a variable to an initial value before the loop starts.</li>
                        <li><strong>Condition:</strong> The loop repeats as long as this expression is True.</li>
                        <li><strong>Increment/Update:</strong> A change inside the loop that moves the variable closer to making the condition False, preventing an infinite loop.</li>
                    </ul>
                    <div class="common-mistake">
                        <h4>‚ö†Ô∏è Common Mistake: Infinite Loops</h4>
                        <p>If you forget to increment your variable (e.g., <code>count = count + 1</code>), the condition will never become False and the loop will run forever! This will crash your program.</p>
                    </div>
                    <h3>Your Task</h3>
                    <p>Write a <code>while</code> loop that prints the word "Python" 10 times. Make sure the loop stops correctly!</p>
                `,
                starterCode: `count = 1\n\n# Your while loop here`,
                hints: [
                    "You'll need a condition like `while count <= 10`.",
                    "Inside the loop, don't forget to `print(\"Python\")`.",
                    "Crucially, you must increment your counter inside the loop: `count = count + 1`."
                ],
                checks: [
                    { name: "Prints 'Python' 10 times", test: (code, output) => (output.match(/Python/g) || []).length === 10 },
                    { name: "Uses a while loop", test: (code, output) => code.includes('while') },
                    { name: "Increments a counter variable", test: (code, output) => code.includes('+ 1') }
                ]
            },
            4: {
                id: "e2d0021f-6c77-4cca-bd30-7eb0074c0e73",
                title: "9.4 Counting Down",
                type: "practice",
                xp: 75,
                instructions: `
                    <h3>Counting Down</h3>
                    <p>Use a <code>while</code> loop to count down from 10. After the loop finishes, print "Lift off!".</p>
                    
                    <h3>In English</h3>
                    <p>Start a number <code>n</code> at 10. While it is greater than 0, print it out and then decrease it by 1. After the loop, print the message.</p>
                `,
                starterCode: `n = 10\n\n# Your code here`,
                hints: [
                    "Initialize a variable `n` to 10.",
                    "The condition should be `while n > 0`.",
                    "Inside the loop, you need to decrease n: `n = n - 1`.",
                    "The \"Lift off!\" print statement should be *after* the loop (not indented)."
                ],
                checks: [
                    { name: "Prints the number 10", test: (code, output) => output.includes('10') },
                    { name: "Prints the number 1", test: (code, output) => output.includes('1') },
                    { name: "Prints 'Lift off!' at the end", test: (code, output) => output.trim().endsWith('Lift off!') },
                    { name: "Decrements the counter", test: (code, output) => code.includes('- 1') }
                ]
            },
            5: {
                id: "3ca319da-e2d7-4768-afd4-f35bf1120423",
                title: "9.5 Repeating Instructions",
                type: "practice",
                xp: 50,
                instructions: `
                    <h3>Repeating Instructions</h3>
                    <p>A <code>while</code> loop is useful for repeating instructions, rather than typing the same code multiple times.</p>
                    <p>The code in the editor prints the steps to draw a square by repeating the 'forward' and 'left' instructions four times.</p>
                    <h3>Your Task</h3>
                    <p>Change the code to print the steps for drawing a triangle. A triangle has 3 sides and the turn angle is 120 degrees.</p>
                    <p><em>(Note: We are not actually drawing, just printing the steps to focus on the loop logic.)</em></p>
                `,
                starterCode: `print("Drawing a square:")\nprint("Move forward 100")\nprint("Turn left 90")\nprint("Move forward 100")\nprint("Turn left 90")\nprint("Move forward 100")\nprint("Turn left 90")\nprint("Move forward 100")\nprint("Turn left 90")`,
                hints: [
                    "A triangle has 3 sides, so you'll need three pairs of 'forward' and 'left' instructions.",
                    "The angle for an equilateral triangle is 120 degrees.",
                    "Remove one pair of print statements and change `90` to `120`."
                ],
                checks: [
                    { name: "Prints 'Move forward' 3 times", test: (code, output) => (output.match(/Move forward/g) || []).length === 3 },
                    { name: "Prints 'Turn left 120'", test: (code, output) => output.includes('Turn left 120') }
                ]
            },
            6: {
                id: "d6c96ac8-c803-44a0-927a-743eddd255a3",
                title: "9.6 Repeating with a Loop",
                type: "practice",
                xp: 100,
                instructions: `
                    <h3>Using a Loop for Repetition</h3>
                    <p>Instead of repeating instructions manually, we can use a <code>while</code> loop to repeat them a specific number of times.</p>
                    <h3>Your Task</h3>
                    <p>Modify the program below to print the steps for drawing a hexagon (6 sides). The angle to turn for a hexagon is 60 degrees.</p>
                `,
                starterCode: `print("Drawing a square:")\n# Start a variable at 0\nside = 0\n\n# While the variable is less than 4\nwhile side < 4:\n\tprint("Move forward 100")\n\tprint("Turn left 90")\n\t\n\t# Increase the variable by 1\n\tside = side + 1`,
                hints: [
                    "A hexagon has 6 sides, so the loop should run 6 times. Change the condition.",
                    "The turning angle for a hexagon is 60 degrees. Change the value in the 'Turn left' print.",
                    "Change `while side < 4` to `while side < 6` and `90` to `60`."
                ],
                checks: [
                    { name: "Loop condition is for 6 sides", test: (code, output) => code.includes('< 6') || code.includes('<= 5') },
                    { name: "Prints 'Move forward' 6 times", test: (code, output) => (output.match(/Move forward/g) || []).length === 6 },
                    { name: "Prints 'Turn left 60'", test: (code, output) => output.includes('Turn left 60') }
                ]
            },
            7: {
                id: "24a90d17-bad8-4765-ace8-23c58d99efc4",
                title: "9.7 Print Hello",
                type: "practice",
                xp: 75,
                instructions: `
                    <h3>Greeting a Room</h3>
                    <p>There are <code>n</code> people in a room, and you want to say hello to all of them. Use a <code>while</code> loop to print "hello" <code>n</code> times.</p>
                `,
                starterCode: `n = 5\n\n# Your code here`,
                hints: [
                    "You'll need a counter variable that starts at 0 or 1.",
                    "The loop should run as long as your counter is less than `n`.",
                    "Inside the loop, print \"hello\" and increment your counter."
                ],
                checks: [
                    { name: "Prints 'hello' 5 times", test: (code, output) => (output.match(/hello/g) || []).length === 5 },
                    { name: "Uses a while loop", test: (code, output) => code.includes('while') },
                    { name: "Uses the variable 'n'", test: (code, output) => code.includes('n') }
                ]
            },
            8: {
                id: "4e68394e-f5b9-4404-a76c-ee77317a1f98",
                title: "9.8 Sum of Multiples",
                type: "practice",
                xp: 125,
                instructions: `
                    <h3>Accumulator Variables</h3>
                    <p>Often, you'll need to accumulate a value over multiple iterations. To do this, we use an <strong>accumulator variable</strong> which is updated in every iteration.</p>
                    <p>In the example reminder, <code>total</code> is an accumulator variable.</p>
                    
                    <h3>Your Task</h3>
                    <p>Find the sum of all multiples of 3, from 3 up to 100, using a <code>while</code> loop and an accumulator variable.</p>
                    <p><strong>Hint:</strong> How much will you need to increase your counter by in each iteration to only get multiples of 3?</p>
                `,
                starterCode: `n = 3\ntotal = 0\n\n# Your code here\n\nprint(total)`,
                hints: [
                    "Your loop should continue as long as `n` is less than or equal to 100.",
                    "Inside the loop, add the current value of `n` to `total`.",
                    "Instead of incrementing `n` by 1, increment it by 3 to get the next multiple."
                ],
                checks: [
                    { name: "Final sum is correct (1683)", test: (code, output) => output.trim().includes('1683') },
                    { name: "Counter 'n' is incremented by 3", test: (code, output) => code.includes('n = n + 3') || code.includes('n += 3') },
                    { name: "Uses an accumulator variable 'total'", test: (code, output) => code.includes('total = total +') || code.includes('total +=') }
                ]
            },
            9: {
                id: "final-assessment-while-loops",
                title: "Section 9 Assessment",
                type: "assessment",
                xp: 250,
                instructions: `
                    <div class="worksheet-section">
                        <h3 class="worksheet-title">üìù End of Section 9: Worksheet</h3>
                        
                        <div class="worksheet-question">
                            <h4>1. Explain what the term "infinite loop" means in the context of a while loop.</h4>
                            <textarea class="worksheet-answer" rows="3" placeholder="An infinite loop is..." data-question="1"></textarea>
                        </div>
                        
                        <div class="worksheet-question">
                            <h4>2. What will be the output of the following code?</h4>
                            <div class="worksheet-code">count = 1
while count <= 5:
    print(count)
    count += 2</div>
                            <textarea class="worksheet-answer" rows="3" placeholder="The output will be..." data-question="2"></textarea>
                        </div>
                        
                        <div class="worksheet-question">
                            <h4>3. What is the output of the following code?</h4>
                            <div class="worksheet-code">num = 1
while num < 5:
    print("Hello")</div>
                            <textarea class="worksheet-answer" rows="3" placeholder="The output will be..." data-question="3"></textarea>
                        </div>

                        <div class="worksheet-question">
                            <h4>4. What will be the output of this code?</h4>
                            <div class="worksheet-code">n = 3
while n >= 0:
    print(n)
    n = n - 1
print("Done!")</div>
                            <textarea class="worksheet-answer" rows="4" placeholder="The output will be..." data-question="4"></textarea>
                        </div>

                        <div class="worksheet-question">
                            <h4>5. What will be the output of this code?</h4>
                            <div class="worksheet-code">x = 1
while x <= 3:
    print("A" * x)
    x += 1</div>
                            <textarea class="worksheet-answer" rows="3" placeholder="The output will be..." data-question="5"></textarea>
                        </div>
                    </div>
                `,
                starterCode: ``,
                checks: [] 
            }
        };

        // Extension progress tracking
        const extensionProgress = {
            'menu-system': { completed: false, xp: 50 },
            'input-validation': { completed: false, xp: 40 },
            'collatz': { completed: false, xp: 60 }
        };

        // Extension checks
        const extensionChecks = {
            'menu-system': {
                check: (code, output) => code.includes('while') && code.includes('input') && code.includes('== "q"'),
                hint: "Use a `while` loop that continues until the user's input is 'q'."
            },
            'input-validation': {
                check: (code, output) => code.includes('while') && code.includes('not') && code.includes('.isdigit()'),
                hint: "Use a `while` loop with `not your_variable.isdigit()` to keep asking until the user enters a valid number."
            },
            'collatz': {
                check: (code, output) => code.includes('while n != 1') && code.includes('% 2 == 0') && code.includes('else'),
                hint: "The loop should stop when n reaches 1. Inside the loop, check if n is even or odd and apply the correct rule."
            }
        };

        // Extension topics content
        const extensionTopics = {
            'menu-system': {
                title: 'Text-Based Menu System',
                content: `
                    <div class="extension-header"><h2>Text-Based Menu System</h2></div>
                    <div class="extension-content">
                        <p>A common use for a <code>while</code> loop is to create a menu that keeps running until the user decides to quit.</p>
                        <div class="example-box">
                            <h4>Concept</h4>
                            <p>We can use a <code>while True</code> loop, which runs forever, and then use the <code>break</code> keyword to exit the loop when the user enters a specific command (like 'q' for quit).</p>
                        </div>
                        <div class="try-it">
                            <h4>Try it yourself!</h4>
                            <p>Create a simple menu with at least 3 options and a quit option. The loop should print the user's choice and only stop when they choose to quit.</p>
                            <div class="extension-editor-container">
                                <div class="editor-header"><div class="editor-title">Python Code Editor</div><div class="editor-actions"><button class="editor-btn run" onclick="runExtensionCode('menu-system')">‚ñ∂ Run Code</button></div></div>
                                <textarea id="ext-menu-system">
# Your menu system code here
</textarea>
                            </div>
                            <div class="output-panel"><div class="output-header">Output</div><div class="output-content" id="output-ext-menu-system"></div></div>
                            <div class="controls"><button onclick="checkExtensionComplete('menu-system')" class="btn btn-success">‚úì Check Solution</button></div>
                        </div>
                    </div>`
            },
            'input-validation': {
                title: 'Input Validation Loop',
                content: `
                    <div class="extension-header"><h2>Input Validation Loop</h2></div>
                    <div class="extension-content">
                        <p>What if you need the user to enter a number, but they type text instead? A <code>while</code> loop is perfect for forcing the user to give you valid input.</p>
                        <div class="example-box">
                            <h4>Concept</h4>
                            <p>We can use a loop that continues as long as the input is not what we want. The <code>.isdigit()</code> string method is helpful here, as it returns <code>True</code> if all characters in the string are digits.</p>
                        </div>
                        <div class="try-it">
                            <h4>Try it yourself!</h4>
                            <p>Write a program that asks the user for their age and won't stop asking until they enter a valid number.</p>
                            <div class="extension-editor-container">
                                <div class="editor-header"><div class="editor-title">Python Code Editor</div><div class="editor-actions"><button class="editor-btn run" onclick="runExtensionCode('input-validation')">‚ñ∂ Run Code</button></div></div>
                                <textarea id="ext-input-validation">
# Your input validation code here
</textarea>
                            </div>
                            <div class="output-panel"><div class="output-header">Output</div><div class="output-content" id="output-ext-input-validation"></div></div>
                            <div class="controls"><button onclick="checkExtensionComplete('input-validation')" class="btn btn-success">‚úì Check Solution</button></div>
                        </div>
                    </div>`
            },
            'collatz': {
                title: 'The Collatz Conjecture',
                content: `
                    <div class="extension-header"><h2>The Collatz Conjecture</h2></div>
                    <div class="extension-content">
                        <p>This is a famous unsolved problem in mathematics. The procedure is as follows:</p>
                        <p>Start with any positive integer <code>n</code>. For the next term, apply these rules:</p>
                        <ul>
                            <li>If <code>n</code> is even, the next term is <code>n / 2</code>.</li>
                            <li>If <code>n</code> is odd, the next term is <code>3 * n + 1</code>.</li>
                        </ul>
                        <p>The conjecture is that no matter what value of <code>n</code> you start with, the sequence will always eventually reach 1.</p>
                        <div class="try-it">
                            <h4>Try it yourself!</h4>
                            <p>Write a program that takes a starting number and prints the Collatz sequence until it reaches 1.</p>
                            <div class="extension-editor-container">
                                <div class="editor-header"><div class="editor-title">Python Code Editor</div><div class="editor-actions"><button class="editor-btn run" onclick="runExtensionCode('collatz')">‚ñ∂ Run Code</button></div></div>
                                <textarea id="ext-collatz">
n = 27 # Try another number!
print(n)

# Your while loop here

</textarea>
                            </div>
                            <div class="output-panel"><div class="output-header">Output</div><div class="output-content" id="output-ext-collatz"></div></div>
                            <div class="controls"><button onclick="checkExtensionComplete('collatz')" class="btn btn-success">‚úì Check Solution</button></div>
                        </div>
                    </div>`
            }
        };

        // Game variables
        let currentGame = null;
        let gameScore = 0;
        let gameTimer = null;
        let gameTimeLeft = 60;
        let gameHighScores = {
            'countdown': localStorage.getItem('whileloops-highscore-countdown') || 0,
            'loop-predictor': localStorage.getItem('whileloops-highscore-predictor') || 0,
            'accumulator': localStorage.getItem('whileloops-highscore-accumulator') || 0,
            'infinite-escape': localStorage.getItem('whileloops-highscore-escape') || 0
        };
        const synth = window.Tone ? new Tone.Synth().toDestination() : null;

        // Initialize Pyodide
        async function initializePyodide() {
            try {
                pyodide = await loadPyodide({
                    indexURL: "https://cdn.jsdelivr.net/pyodide/v0.24.1/full/"
                });
                
                pyodide.runPython(`
                    import sys
                    from js import prompt
                    
                    def custom_input(prompt_text=""):
                        return prompt(prompt_text)
                    
                    __builtins__.input = custom_input
                `);
                
                console.log("Pyodide loaded successfully");
                loadAllProgress();
                generateTaskList();
                switchTask(1);
            } catch (error) {
                console.error("Failed to load Pyodide:", error);
                document.getElementById('taskContent').innerHTML = `<div class="error-message"><h3>Failed to load Python environment</h3><p>Please refresh the page to try again.</p></div>`;
            }
        }

        // Initialize CodeMirror editor
        function initializeEditor(taskNumber) {
            const editorElement = document.getElementById(`editor-${taskNumber}`);
            if (!editorElement) return;

            if (editors[taskNumber]) {
                editors[taskNumber].toTextArea();
            }

            editors[taskNumber] = CodeMirror.fromTextArea(editorElement, {
                mode: 'python',
                theme: 'monokai',
                lineNumbers: true,
                autoCloseBrackets: true,
                matchBrackets: true,
                indentUnit: 4,
                tabSize: 4,
                indentWithTabs: false,
                lineWrapping: true,
                foldGutter: true,
                gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
                extraKeys: {
                    "Tab": (cm) => cm.replaceSelection("    "),
                    "Ctrl-Enter": (cm) => runCode(taskNumber),
                    "Cmd-Enter": (cm) => runCode(taskNumber)
                }
            });

            const task = tasks[taskNumber];
            const savedCode = localStorage.getItem(`whileloops-code-${task.id}`);
            editors[taskNumber].setValue(savedCode || task.starterCode);
            
            editors[taskNumber].on('change', () => {
                localStorage.setItem(`whileloops-code-${task.id}`, editors[taskNumber].getValue());
            });
        }

        // Generate task list
        function generateTaskList() {
            const taskList = document.getElementById('taskList');
            taskList.innerHTML = '';
            const totalTasks = Object.keys(tasks).length;
            document.getElementById('progressText').textContent = `0/${totalTasks} tasks completed`;
            
            for (let i = 1; i <= totalTasks; i++) {
                const task = tasks[i];
                const li = document.createElement('li');
                li.className = 'task-item';
                if (userProgress.completedTasks[i]) li.classList.add('completed');
                if (i === currentTask) li.classList.add('active');
                li.innerHTML = `<span>${task.title}</span><span class="task-xp">${task.xp} XP</span>`;
                li.onclick = () => switchTask(i);
                taskList.appendChild(li);
            }
        }

        // Switch between tasks
        function switchTask(taskNum) {
            currentTask = taskNum;
            const task = tasks[taskNum];
            
            document.querySelectorAll('.task-item').forEach((item, index) => {
                item.classList.toggle('active', index === taskNum - 1);
            });
            
            if (task.type === 'assessment') {
                renderAssessmentTask(taskNum);
            } else {
                renderRegularTask(taskNum);
            }
            
            document.getElementById('taskContent').style.display = 'block';
            document.getElementById('extensionContent').style.display = 'none';
            document.getElementById('gameContent').style.display = 'none';
        }
        
        // Render regular task
        function renderRegularTask(taskNum) {
            const task = tasks[taskNum];
            document.getElementById('taskContent').innerHTML = `
                <div class="task-header">
                    <h2 class="task-title">${task.title}</h2>
                    <span class="task-type ${task.type}">${task.type}</span>
                </div>
                <div class="instructions">${task.instructions}</div>
                <div class="editor-container">
                    <div class="editor-header">
                        <div class="editor-title"><span>Python Code Editor</span></div>
                        <div class="editor-actions">
                            <button class="editor-btn" onclick="resetCode(${taskNum})">‚Ü∫ Reset</button>
                            <button class="editor-btn run" onclick="runCode(${taskNum})">‚ñ∂ Run Code</button>
                        </div>
                    </div>
                    <textarea id="editor-${taskNum}"></textarea>
                </div>
                <div class="output-panel">
                    <div class="output-header">Output</div>
                    <div class="output-content" id="output-${taskNum}"></div>
                </div>
                <div class="hint-box" id="hint-${taskNum}">
                    <div class="hint-header">
                        <span>üí°</span>
                        <span>Hint <span id="hintNumber-${taskNum}">1</span>/${task.hints.length}</span>
                    </div>
                    <p id="hintText-${taskNum}">${task.hints[0]}</p>
                </div>
                <div class="controls">
                    <button class="btn btn-secondary" onclick="showHint(${taskNum})">üí° Show Hint</button>
                    <button class="btn btn-success" onclick="checkCode(${taskNum})">‚úì Check Solution</button>
                    ${taskNum < Object.keys(tasks).length ? `<button class="btn btn-primary" onclick="switchTask(${taskNum + 1})">Next Task ‚Üí</button>` : '<button class="btn btn-primary" onclick="exportProgress()">Export Progress Report</button>'}
                </div>
                <div class="checks-container" id="checks-${taskNum}" style="display: none;">
                    <h3>Solution Checks:</h3>
                    ${task.checks.map((check, index) => `<div class="check-item" id="check-${taskNum}-${index}"><div class="check-icon pending" id="checkIcon-${taskNum}-${index}">?</div><span>${check.name}</span></div>`).join('')}
                </div>
            `;
            setTimeout(() => initializeEditor(taskNum), 0);
        }

        // Render assessment task
        function renderAssessmentTask(taskNum) {
            const task = tasks[taskNum];
            const contentDiv = document.getElementById('taskContent');
            contentDiv.innerHTML = `
                <div class="task-header">
                    <h2 class="task-title">${task.title}</h2>
                    <span class="task-type ${task.type}">${task.type}</span>
                </div>
                ${task.instructions}
                <div class="controls">
                     <button class="btn btn-success" onclick="markAssessmentComplete(${taskNum})">‚úì Mark as Complete</button>
                </div>
            `;
            
            document.querySelectorAll('.worksheet-answer').forEach(textarea => {
                const qId = textarea.dataset.question;
                textarea.value = userProgress.assessmentAnswers[qId] || '';
                textarea.addEventListener('input', (e) => {
                    userProgress.assessmentAnswers[qId] = e.target.value;
                    saveAllProgress();
                    checkBadges();
                });
            });
        }

        function markAssessmentComplete(taskNum) {
            if (!userProgress.completedTasks[taskNum]) {
                const task = tasks[taskNum];
                userProgress.completedTasks[taskNum] = true;
                awardXP(task.xp);
                updateProgress();
                generateTaskList();
                showAchievement('üéì', 'Assessment Complete!', `You've completed the assessment!`, task.xp);
                checkBadges();
            } else {
                alert("You have already completed this assessment.");
            }
        }

        // Run Python code
        async function runCode(taskNumber) {
            if (!pyodide || !editors[taskNumber]) return;

            const outputElement = document.getElementById(`output-${taskNumber}`);
            outputElement.textContent = 'Running...';
            outputElement.classList.remove('error');
            
            try {
                const code = editors[taskNumber].getValue();
                pyodide.runPython(`import sys, io; sys.stdout = io.StringIO(); sys.stderr = io.StringIO()`);
                await pyodide.runPythonAsync(code);
                const stdout = pyodide.runPython("sys.stdout.getvalue()");
                const stderr = pyodide.runPython("sys.stderr.getvalue()");
                
                if (stderr) {
                    outputElement.textContent = stderr;
                    outputElement.classList.add('error');
                } else {
                    outputElement.textContent = stdout || 'No output';
                }
            } catch (error) {
                outputElement.textContent = error.message;
                outputElement.classList.add('error');
            }
        }

        // Check code
        async function checkCode(taskNumber) {
            const task = tasks[taskNumber];
            const checksContainer = document.getElementById(`checks-${taskNumber}`);
            checksContainer.style.display = 'block';
            
            userProgress.taskAttempts[taskNumber] = (userProgress.taskAttempts[taskNumber] || 0) + 1;
            
            await runCode(taskNumber);
            
            const code = editors[taskNumber].getValue();
            const output = document.getElementById(`output-${taskNumber}`).textContent;
            
            let allChecksPassed = true;
            task.checks.forEach((check, index) => {
                const passed = check.test(code, output);
                const checkIcon = document.getElementById(`checkIcon-${taskNumber}-${index}`);
                checkIcon.textContent = passed ? '‚úì' : '‚úó';
                checkIcon.className = `check-icon ${passed ? 'passed' : 'failed'}`;
                if (!passed) allChecksPassed = false;
            });
            
            if (allChecksPassed && !userProgress.completedTasks[taskNumber]) {
                userProgress.completedTasks[taskNumber] = true;
                if (userProgress.taskAttempts[taskNumber] === 1) userProgress.firstTryTasks++;
                if (!userProgress.hintsUsed[taskNumber]) userProgress.perfectTasks++;
                awardXP(task.xp);
                updateProgress();
                generateTaskList();
                showAchievement('‚úÖ', 'Task Complete!', `${task.title} completed successfully!`, task.xp);
                checkBadges();
            }
        }

        function showHint(taskNumber) {
            const task = tasks[taskNumber];
            const hintBox = document.getElementById(`hint-${taskNumber}`);
            const hintText = document.getElementById(`hintText-${taskNumber}`);
            const hintNumber = document.getElementById(`hintNumber-${taskNumber}`);
            const currentHintIndex = userProgress.hintsUsed[taskNumber] || 0;
            
            if (currentHintIndex < task.hints.length) {
                hintBox.classList.add('show');
                hintText.textContent = task.hints[currentHintIndex];
                hintNumber.textContent = currentHintIndex + 1;
                userProgress.hintsUsed[taskNumber] = currentHintIndex + 1;
                saveAllProgress();
            }
        }

        function resetCode(taskNumber) {
            if (confirm('Are you sure you want to reset your code?')) {
                const task = tasks[taskNumber];
                editors[taskNumber].setValue(task.starterCode);
                localStorage.removeItem(`whileloops-code-${task.id}`);
            }
        }

        function awardXP(amount) {
            userProgress.xp += amount;
            const newLevel = Math.floor(userProgress.xp / 500) + 1;
            if (newLevel > userProgress.level) {
                userProgress.level = newLevel;
                showAchievement('üéâ', 'Level Up!', `You've reached Level ${newLevel}!`, 0);
            }
            updateProgress();
            saveAllProgress();
        }

        function updateProgress() {
            document.getElementById('userLevel').textContent = userProgress.level;
            document.getElementById('userXP').textContent = userProgress.xp;
            document.getElementById('userStreak').textContent = userProgress.streak;
            document.getElementById('xpFill').style.width = `${(userProgress.xp % 500) / 5}%`;
            
            const completedCount = Object.keys(userProgress.completedTasks).length;
            const totalTasks = Object.keys(tasks).length;
            document.getElementById('progressBar').style.width = `${(completedCount / totalTasks) * 100}%`;
            document.getElementById('progressText').textContent = `${completedCount}/${totalTasks} tasks completed`;
            
            Object.keys(BADGES).forEach(id => document.getElementById(`badge-${id}`).classList.toggle('earned', !!userProgress.badges[id]));
        }

        function checkBadges() {
            Object.keys(BADGES).forEach(id => {
                if (!userProgress.badges[id] && BADGES[id].check()) {
                    userProgress.badges[id] = true;
                    const badge = BADGES[id];
                    showAchievement(badge.icon, 'Badge Earned!', badge.name, 50);
                    awardXP(50);
                }
            });
        }

        function showAchievement(icon, title, message, xp) {
            const popup = document.getElementById('achievementPopup');
            document.getElementById('achievementIcon').textContent = icon;
            document.getElementById('achievementTitle').textContent = title;
            document.getElementById('achievementMessage').textContent = message;
            const xpElement = document.getElementById('achievementXP');
            xpElement.parentElement.style.display = xp > 0 ? 'block' : 'none';
            xpElement.textContent = xp;
            popup.classList.add('show');
            setTimeout(() => popup.classList.remove('show'), 4000);
        }

        function saveAllProgress() {
            localStorage.setItem('whileloops-progress', JSON.stringify(userProgress));
        }

        function loadAllProgress() {
            const saved = localStorage.getItem('whileloops-progress');
            if (saved) {
                userProgress = JSON.parse(saved);
                if (!userProgress.assessmentAnswers) userProgress.assessmentAnswers = {};
                const today = new Date().toDateString();
                const lastVisitDate = new Date(userProgress.lastVisit || 0);
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                if (today !== userProgress.lastVisit) {
                    userProgress.streak = (yesterday.toDateString() === lastVisitDate.toDateString()) ? userProgress.streak + 1 : 1;
                    userProgress.lastVisit = today;
                }
            }
            updateProgress();
        }

        function toggleExtension() {
            const section = document.getElementById('extensionSection');
            const arrow = document.getElementById('extensionArrow');
            const isOpen = section.style.display === 'block';
            section.style.display = isOpen ? 'none' : 'block';
            arrow.classList.toggle('open', !isOpen);
        }

        function showExtensionTopic(topic) {
            document.getElementById('taskContent').style.display = 'none';
            document.getElementById('gameContent').style.display = 'none';
            const extContent = document.getElementById('extensionContent');
            extContent.innerHTML = extensionTopics[topic] ? extensionTopics[topic].content : '<p>Not found.</p>';
            extContent.style.display = 'block';
            document.querySelectorAll('.task-item').forEach(item => item.classList.remove('active'));
            setTimeout(() => initializeExtensionEditors(topic), 0);
        }
        
        function initializeExtensionEditors(topic) {
            const editorElement = document.getElementById(`ext-${topic}`);
            if (editorElement && !extensionEditors[topic]) {
                extensionEditors[topic] = CodeMirror.fromTextArea(editorElement, {
                    mode: 'python', theme: 'monokai', lineNumbers: true, autoCloseBrackets: true
                });
            }
        }
        
        async function runExtensionCode(topic) {
            if (!pyodide || !extensionEditors[topic]) return;
            const outputElement = document.getElementById(`output-ext-${topic}`);
            outputElement.textContent = 'Running...';
            try {
                const code = extensionEditors[topic].getValue();
                pyodide.runPython(`import sys, io; sys.stdout = io.StringIO(); sys.stderr = io.StringIO()`);
                await pyodide.runPythonAsync(code);
                const stdout = pyodide.runPython("sys.stdout.getvalue()");
                const stderr = pyodide.runPython("sys.stderr.getvalue()");
                outputElement.textContent = stderr ? stderr : (stdout || 'No output');
            } catch (error) {
                outputElement.textContent = error.message;
            }
        }
        
        async function checkExtensionComplete(topic) {
            await runExtensionCode(topic);
            const code = extensionEditors[topic].getValue();
            const output = document.getElementById(`output-ext-${topic}`).textContent;
            if (extensionChecks[topic].check(code, output)) {
                if (!extensionProgress[topic].completed) {
                    extensionProgress[topic].completed = true;
                    awardXP(extensionProgress[topic].xp);
                    showAchievement('üåü', 'Extension Complete!', extensionTopics[topic].title, extensionProgress[topic].xp);
                    saveAllProgress();
                } else {
                    alert('Already completed!');
                }
            } else {
                alert(`Not quite right! Hint: ${extensionChecks[topic].hint}`);
            }
        }

        // Game functions
        function showGameScreen() {
            const taskContent = document.getElementById('taskContent');
            const extensionContent = document.getElementById('extensionContent');
            const gameContent = document.getElementById('gameContent');
            
            taskContent.style.display = 'none';
            extensionContent.style.display = 'none';
            gameContent.style.display = 'block';
            
            document.querySelectorAll('.task-item').forEach(item => {
                item.classList.remove('active');
            });
            
            gameContent.innerHTML = `
                <div class="task-header">
                    <h2 class="task-title">Interactive Mini-Games</h2>
                </div>
                <div class="game-selection-container">
                    <div class="game-card">
                        <h3><span class="game-icon">‚è±Ô∏è</span> Countdown Challenge</h3>
                        <p>Stop the countdown at exactly the right moment! Test your timing skills with while loops.</p>
                        <button class="btn play-btn" onclick="openGameModal('countdown')">Play ‚Üí</button>
                    </div>
                    <div class="game-card">
                        <h3><span class="game-icon">üîÆ</span> Loop Predictor</h3>
                        <p>Predict the output of while loops. How well do you understand loop conditions?</p>
                        <button class="btn play-btn" onclick="openGameModal('loop-predictor')">Play ‚Üí</button>
                    </div>
                    <div class="game-card">
                        <h3><span class="game-icon">üßÆ</span> Accumulator Race</h3>
                        <p>Build accumulator patterns to reach target values. Master the art of accumulation!</p>
                        <button class="btn play-btn" onclick="openGameModal('accumulator')">Play ‚Üí</button>
                    </div>
                    <div class="game-card">
                        <h3><span class="game-icon">‚ôæÔ∏è</span> Infinite Loop Escape</h3>
                        <p>Find and fix the infinite loops before time runs out!</p>
                        <button class="btn play-btn" onclick="openGameModal('infinite-escape')">Play ‚Üí</button>
                    </div>
                </div>
            `;
        }

        function openGameModal(gameType) {
            currentGame = gameType;
            const overlay = document.getElementById('gameModalOverlay');
            overlay.style.display = 'flex';
            setTimeout(() => overlay.classList.add('show'), 10);
            
            // Set game-specific content
            const gameConfigs = {
                'countdown': {
                    title: 'Countdown Challenge ‚è±Ô∏è',
                    description: 'Stop the countdown at exactly the target number!'
                },
                'loop-predictor': {
                    title: 'Loop Predictor üîÆ',
                    description: 'Predict what the while loop will output!'
                },
                'accumulator': {
                    title: 'Accumulator Race üßÆ',
                    description: 'Build the correct accumulator pattern!'
                },
                'infinite-escape': {
                    title: 'Infinite Loop Escape ‚ôæÔ∏è',
                    description: 'Fix the infinite loops before time runs out!'
                }
            };
            
            const config = gameConfigs[gameType];
            document.getElementById('gameTitle').textContent = config.title;
            document.getElementById('gameDescription').textContent = config.description;
            
            document.getElementById('gameOverScreen').style.display = 'none';
            document.getElementById('gamePlayScreen').style.display = 'none';
            document.getElementById('gameStartScreen').style.display = 'block';
        }

        function closeGameModal() {
            const overlay = document.getElementById('gameModalOverlay');
            overlay.classList.remove('show');
            setTimeout(() => {
                overlay.style.display = 'none';
            }, 300);
            if (gameTimer) {
                clearInterval(gameTimer);
                gameTimer = null;
            }
        }

        function startGame() {
            gameScore = 0;
            gameTimeLeft = 60;
            document.getElementById('gameScore').textContent = gameScore;
            document.getElementById('gameTimer').textContent = gameTimeLeft;
            document.getElementById('highScore').textContent = gameHighScores[currentGame];
            document.getElementById('gameStartScreen').style.display = 'none';
            document.getElementById('gameOverScreen').style.display = 'none';
            document.getElementById('gamePlayScreen').style.display = 'block';
            
            // Start game timer
            gameTimer = setInterval(() => {
                gameTimeLeft--;
                document.getElementById('gameTimer').textContent = gameTimeLeft;
                if (gameTimeLeft <= 0) {
                    endGame();
                }
            }, 1000);
            
            generateGameProblem();
        }

        function generateGameProblem() {
            const gameArea = document.getElementById('gameArea');
            
            switch (currentGame) {
                case 'countdown':
                    generateCountdownProblem(gameArea);
                    break;
                case 'loop-predictor':
                    generateLoopPredictorProblem(gameArea);
                    break;
                case 'accumulator':
                    generateAccumulatorProblem(gameArea);
                    break;
                case 'infinite-escape':
                    generateInfiniteEscapeProblem(gameArea);
                    break;
            }
        }

        function generateCountdownProblem(gameArea) {
            const target = Math.floor(Math.random() * 20) + 5;
            let countdown = target + Math.floor(Math.random() * 10) + 5;
            let isRunning = false;
            let countdownInterval = null;
            
            gameArea.innerHTML = `
                <div class="game-problem">
                    <p>Stop the countdown at exactly <strong>${target}</strong>!</p>
                    <div class="countdown-display" id="countdownDisplay">${countdown}</div>
                    <button class="stop-button" onclick="stopCountdown()">STOP!</button>
                </div>
            `;
            
            // Start countdown after a short delay
            setTimeout(() => {
                isRunning = true;
                countdownInterval = setInterval(() => {
                    if (isRunning) {
                        countdown--;
                        document.getElementById('countdownDisplay').textContent = countdown;
                        if (countdown <= 0) {
                            clearInterval(countdownInterval);
                            checkCountdownAnswer(-1); // Failed
                        }
                    }
                }, 300);
            }, 1000);
            
            window.stopCountdown = function() {
                if (isRunning) {
                    isRunning = false;
                    clearInterval(countdownInterval);
                    checkCountdownAnswer(countdown === target ? 1 : 0);
                }
            };
        }

        function checkCountdownAnswer(result) {
            if (result === 1) {
                gameScore += 10;
                document.getElementById('gameScore').textContent = gameScore;
                if (synth) synth.triggerAttackRelease("C5", "8n");
                showGameFeedback("Perfect! üéØ", true);
            } else if (result === 0) {
                if (synth) synth.triggerAttackRelease("A3", "8n");
                showGameFeedback("Close, but not quite! Try again!", false);
            } else {
                if (synth) synth.triggerAttackRelease("A3", "8n");
                showGameFeedback("Too late! The countdown reached 0!", false);
            }
            
            setTimeout(generateGameProblem, 2000);
        }

        function generateLoopPredictorProblem(gameArea) {
            const problems = [
                {
                    code: `n = 1
while n < 4:
    print(n)
    n = n + 1`,
                    options: ['1 2 3', '1 2 3 4', '0 1 2 3', '1 2'],
                    correct: 0
                },
                {
                    code: `x = 5
while x > 0:
    x = x - 2
    print(x)`,
                    options: ['5 3 1', '3 1 -1', '4 2 0', '5 3 1 -1'],
                    correct: 1
                },
                {
                    code: `count = 0
while count <= 2:
    print("Hi")
    count += 1`,
                    options: ['Hi Hi', 'Hi Hi Hi', 'Hi Hi Hi Hi', 'Hi'],
                    correct: 1
                },
                {
                    code: `n = 10
while n >= 8:
    print(n)
    n = n - 1`,
                    options: ['10 9 8', '10 9 8 7', '9 8', '10 9'],
                    correct: 0
                }
            ];
            
            const problem = problems[Math.floor(Math.random() * problems.length)];
            
            gameArea.innerHTML = `
                <div class="game-problem">
                    <p>What will this code output?</p>
                    <pre style="text-align: left; margin: 1rem auto; max-width: 400px;">${problem.code}</pre>
                    <div class="game-options">
                        ${problem.options.map((opt, i) => 
                            `<button class="option-btn" onclick="checkLoopAnswer(${i}, ${problem.correct})">${opt}</button>`
                        ).join('')}
                    </div>
                </div>
            `;
        }

        window.checkLoopAnswer = function(selected, correct) {
            const buttons = document.querySelectorAll('.option-btn');
            buttons[selected].classList.add(selected === correct ? 'correct' : 'incorrect');
            buttons[correct].classList.add('correct');
            
            if (selected === correct) {
                gameScore += 10;
                document.getElementById('gameScore').textContent = gameScore;
                if (synth) synth.triggerAttackRelease("C5", "8n");
            } else {
                if (synth) synth.triggerAttackRelease("A3", "8n");
            }
            
            setTimeout(generateGameProblem, 1500);
        };

        function generateAccumulatorProblem(gameArea) {
            const target = Math.floor(Math.random() * 50) + 20;
            const step = Math.floor(Math.random() * 5) + 2;
            
            gameArea.innerHTML = `
                <div class="game-problem">
                    <p>Build an accumulator that reaches exactly <strong>${target}</strong></p>
                    <p>Starting from 0, adding <strong>${step}</strong> each time</p>
                    <p>How many iterations needed?</p>
                    <input type="number" class="game-input" id="gameInput" placeholder="Enter number of iterations...">
                    <button class="btn btn-primary" onclick="checkAccumulatorAnswer(${target}, ${step})">Check</button>
                </div>
            `;
            
            document.getElementById('gameInput').focus();
            document.getElementById('gameInput').onkeyup = (e) => {
                if (e.key === 'Enter') {
                    checkAccumulatorAnswer(target, step);
                }
            };
        }

        window.checkAccumulatorAnswer = function(target, step) {
            const input = document.getElementById('gameInput');
            const userAnswer = parseInt(input.value);
            const correct = Math.ceil(target / step);
            
            if (userAnswer === correct) {
                gameScore += 15;
                document.getElementById('gameScore').textContent = gameScore;
                if (synth) synth.triggerAttackRelease("C5", "8n");
                input.classList.add('correct');
                showGameFeedback("Correct! üéâ", true);
                setTimeout(generateGameProblem, 1500);
            } else {
                if (synth) synth.triggerAttackRelease("A3", "8n");
                input.classList.add('incorrect');
                const hint = userAnswer < correct ? "Too few iterations!" : "Too many iterations!";
                showGameFeedback(hint, false);
                setTimeout(() => input.classList.remove('incorrect'), 500);
            }
        };

        function generateInfiniteEscapeProblem(gameArea) {
            const problems = [
                {
                    code: `n = 1
while n < 10:
    print(n)`,
                    issue: "Missing increment: n = n + 1",
                    fix: "n = n + 1"
                },
                {
                    code: `x = 5
while x > 0:
    print(x)
    x = x + 1`,
                    issue: "Wrong direction: should be x = x - 1",
                    fix: "x = x - 1"
                },
                {
                    code: `count = 0
while count != 5:
    count = count + 2`,
                    issue: "Will skip 5: use count < 5 instead",
                    fix: "count < 5"
                },
                {
                    code: `while True:
    print("Hello")`,
                    issue: "No exit condition: add a break statement",
                    fix: "break"
                }
            ];
            
            const problem = problems[Math.floor(Math.random() * problems.length)];
            
            gameArea.innerHTML = `
                <div class="game-problem">
                    <p>Fix the infinite loop!</p>
                    <pre style="text-align: left; margin: 1rem auto; max-width: 400px;">${problem.code}</pre>
                    <p>What's the fix?</p>
                    <input type="text" class="game-input" id="gameInput" placeholder="Type the missing/fixed code...">
                    <button class="btn btn-primary" onclick="checkInfiniteAnswer('${problem.fix}')">Submit Fix</button>
                </div>
            `;
            
            document.getElementById('gameInput').focus();
        }

        window.checkInfiniteAnswer = function(correctFix) {
            const input = document.getElementById('gameInput');
            const userAnswer = input.value.trim().toLowerCase();
            const correct = correctFix.toLowerCase();
            
            if (userAnswer.includes(correct) || correct.includes(userAnswer)) {
                gameScore += 20;
                document.getElementById('gameScore').textContent = gameScore;
                if (synth) synth.triggerAttackRelease("C5", "8n");
                input.classList.add('correct');
                showGameFeedback("Fixed! The loop is safe now! üõ°Ô∏è", true);
                setTimeout(generateGameProblem, 1500);
            } else {
                if (synth) synth.triggerAttackRelease("A3", "8n");
                input.classList.add('incorrect');
                showGameFeedback("Not quite right. Think about what makes the loop infinite.", false);
                setTimeout(() => input.classList.remove('incorrect'), 500);
            }
        };

        function showGameFeedback(message, isCorrect) {
            const gameArea = document.getElementById('gameArea');
            const feedback = document.createElement('div');
            feedback.className = 'game-feedback';
            feedback.style.color = isCorrect ? 'var(--success-color)' : 'var(--error-color)';
            feedback.textContent = message;
            gameArea.appendChild(feedback);
        }

        function endGame() {
            if (gameTimer) {
                clearInterval(gameTimer);
                gameTimer = null;
            }
            
            if (gameScore > gameHighScores[currentGame]) {
                gameHighScores[currentGame] = gameScore;
                localStorage.setItem(`whileloops-highscore-${currentGame.split('-').pop()}`, gameScore);
                showAchievement('üéÆ', 'New High Score!', `You scored ${gameScore} points!`, 20);
            }
            
            document.getElementById('finalScore').textContent = gameScore;
            document.getElementById('highScore').textContent = gameHighScores[currentGame];
            document.getElementById('gamePlayScreen').style.display = 'none';
            document.getElementById('gameOverScreen').style.display = 'block';
            
            // Award XP based on score
            const xpEarned = Math.floor(gameScore / 2);
            awardXP(xpEarned);
        }

        function restartGame() {
            startGame();
        }

        function toggleAccessibility() {
            const menu = document.getElementById('accessibilityMenu');
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
        }

        function toggleDyslexicFont(enabled) {
            document.body.classList.toggle('dyslexic-font', enabled);
            localStorage.setItem('whileloops-dyslexic-font', enabled);
        }

        function toggleHighContrast(enabled) {
            alert('High contrast mode is not yet implemented.');
        }

        function loadAccessibilityPreferences() {
            if (localStorage.getItem('whileloops-dyslexic-font') === 'true') {
                document.body.classList.add('dyslexic-font');
                document.querySelector('input[onchange*="toggleDyslexicFont"]').checked = true;
            }
        }
        
        function exportProgress() {
            const report = {
                date: new Date().toISOString(),
                section: "While Loops",
                level: userProgress.level,
                xp: userProgress.xp,
                completedTasks: Object.keys(userProgress.completedTasks).length,
                totalTasks: Object.keys(tasks).length,
                taskDetails: Object.keys(tasks).map(taskNum => ({
                    task: tasks[taskNum].title,
                    completed: !!userProgress.completedTasks[taskNum],
                    hintsUsed: userProgress.hintsUsed[taskNum] || 0,
                    attempts: userProgress.taskAttempts[taskNum] || 0
                })),
                badges: Object.keys(userProgress.badges).map(b => BADGES[b].name),
                perfectTasks: userProgress.perfectTasks,
                firstTryTasks: userProgress.firstTryTasks,
                streak: userProgress.streak,
                extensionsCompleted: Object.entries(extensionProgress)
                    .filter(([_, prog]) => prog.completed)
                    .map(([name, _]) => extensionTopics[name].title),
                gameHighScores: gameHighScores
            };
            
            const dataStr = JSON.stringify(report, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `while-loops-progress-${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }
        
        window.addEventListener('load', () => {
            loadAccessibilityPreferences();
            initializePyodide();
        });

        // Prevent text selection
        document.addEventListener('selectstart', function(e) {
            const target = e.target;
            if (target.nodeType === 1 && typeof target.closest === 'function') {
                if (target.tagName !== 'TEXTAREA' && target.tagName !== 'INPUT' && !target.closest('.CodeMirror')) {
                    e.preventDefault();
                }
            } else if (target.nodeType !== 1) {
                e.preventDefault();
            }
        });
    </script>
</body>
</html>