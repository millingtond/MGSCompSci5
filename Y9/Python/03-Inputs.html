<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Year 9 Python Course - Section 3: Inputs</title>
    
    <!-- CodeMirror CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/solarized.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldgutter.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/lint/lint.min.css">
    
    <!-- Pyodide -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    
    <!-- CodeMirror JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/python-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldgutter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/brace-fold.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/indent-fold.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/lint/lint.min.js"></script>
    
    <!-- Font for dyslexia support -->
    <link href="https://fonts.googleapis.com/css2?family=OpenDyslexic:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            box-sizing: border-box;
        }
        
        :root {
            --primary-color: #7c3aed;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --xp-color: #8b5cf6;
            --bg-primary: #faf5ff;
            --bg-secondary: white;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            background-color: var(--bg-primary);
            transition: font-family 0.3s ease;
        }
        
        body.dyslexic-font {
            font-family: 'OpenDyslexic', sans-serif;
        }
        
        .header {
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header-left h1 {
            margin: 0;
            font-size: 28px;
        }
        
        .header-left p {
            margin: 5px 0 0 0;
            opacity: 0.9;
        }
        
        .user-stats {
            display: flex;
            gap: 20px;
            align-items: center;
            background: rgba(255,255,255,0.1);
            padding: 10px 20px;
            border-radius: 8px;
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
        }
        
        .stat-label {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .xp-bar {
            width: 150px;
            height: 8px;
            background: rgba(255,255,255,0.3);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }
        
        .xp-fill {
            height: 100%;
            background: var(--xp-color);
            transition: width 0.5s ease;
        }
        
        .progress-section {
            max-width: 1400px;
            margin: 10px auto 0;
        }
        
        .progress-bar {
            background: rgba(255,255,255,0.3);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            background: #c084fc;
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 4px;
        }
        
        .badges-preview {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .badge {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            filter: grayscale(1);
            opacity: 0.5;
            transition: all 0.3s;
        }
        
        .badge.earned {
            filter: grayscale(0);
            opacity: 1;
            background: rgba(255,255,255,0.3);
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
        }
        
        .main-container {
            display: flex;
            max-width: 1400px;
            margin: 0 auto;
            gap: 20px;
            padding: 20px;
        }
        
        .sidebar {
            width: 280px;
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            height: fit-content;
            position: sticky;
            top: 20px;
        }
        
        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .task-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .task-item {
            padding: 12px;
            margin: 5px 0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            border: 1px solid #e5e7eb;
            position: relative;
        }
        
        .task-item:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
        }
        
        .task-item.active {
            background: #f3e8ff;
            border-color: var(--primary-color);
            color: #6d28d9;
        }
        
        .task-item.completed {
            border-color: var(--success-color);
        }
        
        .task-status {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }
        
        .task-status.completed {
            background: var(--success-color);
            color: white;
        }
        
        .task-xp {
            position: absolute;
            right: 10px;
            font-size: 12px;
            color: var(--xp-color);
            font-weight: bold;
        }
        
        .task-name {
            flex: 1;
            font-size: 14px;
        }
        
        .daily-challenge {
            margin-top: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
            border-radius: 8px;
            color: white;
        }
        
        .daily-challenge h3 {
            margin: 0 0 5px 0;
            font-size: 16px;
        }
        
        .daily-challenge p {
            margin: 0;
            font-size: 14px;
            opacity: 0.9;
        }
        
        .settings-panel {
            margin-top: 20px;
            padding: 15px;
            background: #f3f4f6;
            border-radius: 8px;
        }
        
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
        }
        
        .toggle-switch {
            position: relative;
            width: 48px;
            height: 24px;
            background: #d1d5db;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .toggle-switch.active {
            background: var(--primary-color);
        }
        
        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }
        
        .toggle-switch.active .toggle-slider {
            transform: translateX(24px);
        }
        
        .worksheet-container {
            flex: 1;
            background: var(--bg-secondary);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 30px;
            position: relative;
        }
        
        .task-header {
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 20px;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .task-header-left h2 {
            margin: 0 0 10px 0;
            color: var(--text-primary);
        }
        
        .task-badges {
            display: flex;
            gap: 10px;
        }
        
        .task-type {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            background: #ede9fe;
            color: #6d28d9;
        }
        
        .task-type.practice {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .task-type.challenge {
            background: #fef3c7;
            color: #92400e;
        }
        
        .task-type.assessment {
            background: #e0e7ff;
            color: #3730a3;
        }
        
        .instructions {
            background: #f9fafb;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid #e5e7eb;
            position: relative;
        }
        
        .instructions h3 {
            margin-top: 0;
            color: var(--text-primary);
            font-size: 18px;
        }
        
        .instructions code {
            background: #e5e7eb;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        
        .instructions pre {
            background: #1f2937;
            color: #f3f4f6;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .console-info {
            background: #fef3c7;
            border: 1px solid #fcd34d;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }
        
        .console-info strong {
            color: #92400e;
        }
        
        .audio-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }
        
        .audio-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .audio-btn:hover {
            background: #6d28d9;
        }
        
        .audio-btn.playing {
            background: var(--error-color);
        }
        
        .code-section {
            margin: 20px 0;
        }
        
        .editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #1f2937;
            color: white;
            padding: 10px 15px;
            border-radius: 6px 6px 0 0;
        }
        
        .editor-title {
            font-weight: 600;
            font-size: 14px;
        }
        
        .editor-container {
            border: 1px solid #e5e7eb;
            border-top: none;
            border-radius: 0 0 6px 6px;
            overflow: hidden;
            position: relative;
        }
        
        .CodeMirror {
            height: 300px;
            font-size: 14px;
            width: 100% !important;
        }
        
        .CodeMirror-scroll {
            overflow-y: auto !important;
            overflow-x: auto !important;
        }
        
        .CodeMirror-sizer {
            min-width: 100% !important;
        }
        
        .CodeMirror-lint-tooltip {
            background: #1f2937;
            color: #f3f4f6;
            border: 1px solid #374151;
            border-radius: 4px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 13px;
            padding: 5px 8px;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        button:hover {
            background: #6d28d9;
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }
        
        .run-btn {
            background: var(--success-color);
        }
        
        .run-btn:hover {
            background: #059669;
        }
        
        .check-btn {
            background: var(--xp-color);
        }
        
        .check-btn:hover {
            background: #7c3aed;
        }
        
        .hint-btn {
            background: var(--warning-color);
        }
        
        .hint-btn:hover {
            background: #d97706;
        }
        
        .reset-btn {
            background: #6b7280;
        }
        
        .reset-btn:hover {
            background: #4b5563;
        }
        
        .output-section {
            margin-top: 25px;
        }
        
        .output-panel {
            background: #1f2937;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        
        .output-header {
            background: #111827;
            color: white;
            padding: 10px 15px;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .output-content {
            color: #f3f4f6;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            min-height: 100px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            line-height: 1.5;
        }
        
        .console-section {
            background: #111827;
            border-radius: 6px;
            overflow: hidden;
            margin-top: 15px;
        }
        
        .console-header {
            background: #000;
            color: white;
            padding: 10px 15px;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .console-prompt {
            color: #10b981;
            font-weight: bold;
        }
        
        .console-input {
            background: transparent;
            border: none;
            color: white;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            width: 100%;
            outline: none;
            padding: 10px 15px;
        }
        
        .console-history {
            color: #9ca3af;
            padding: 0 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .test-result {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .test-pass {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
        }
        
        .test-fail {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }
        
        .xp-gained {
            font-weight: bold;
            color: var(--xp-color);
            font-size: 16px;
            animation: bounce 0.5s;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .loading {
            color: #60a5fa;
            font-style: italic;
        }
        
        .error {
            color: #f87171;
        }
        
        .success {
            color: #4ade80;
        }
        
        .hint-box {
            background: #fef3c7;
            border: 1px solid #fcd34d;
            padding: 15px;
            border-radius: 6px;
            margin-top: 10px;
            display: none;
        }
        
        .hint-box strong {
            color: #92400e;
        }
        
        .execution-info {
            color: #9ca3af;
            font-size: 12px;
            margin-top: 5px;
        }
        
        .next-task-section {
            margin-top: 30px;
            padding: 20px;
            background: #f3f4f6;
            border-radius: 6px;
            text-align: center;
            display: none;
        }
        
        .next-btn {
            background: var(--primary-color);
            font-size: 16px;
            padding: 12px 24px;
            margin-top: 10px;
        }
        
        .next-btn:hover {
            background: #6d28d9;
        }
        
        .achievement-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            text-align: center;
            z-index: 1000;
            display: none;
        }
        
        .achievement-popup.show {
            display: block;
            animation: popIn 0.5s ease-out;
        }
        
        @keyframes popIn {
            0% {
                transform: translate(-50%, -50%) scale(0.8);
                opacity: 0;
            }
            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }
        
        .achievement-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
        
        .achievement-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--text-primary);
        }
        
        .achievement-desc {
            color: var(--text-secondary);
            margin-bottom: 20px;
        }
        
        .achievement-xp {
            font-size: 20px;
            font-weight: bold;
            color: var(--xp-color);
        }
        
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }
        
        .overlay.show {
            display: block;
        }
        
        /* Assessment Styles */
        .assessment-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .assessment-question {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .assessment-question h4 {
            margin-top: 0;
            color: var(--text-primary);
        }

        .mc-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 15px 0;
        }

        .mc-option {
            display: flex;
            align-items: center;
            padding: 10px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .mc-option:hover {
            background: #f3f4f6;
            border-color: var(--primary-color);
        }

        .mc-option input {
            margin-right: 10px;
        }

        .text-answer {
            width: 100%;
            padding: 10px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
        }

        .feedback-box {
            margin-top: 10px;
            padding: 10px;
            border-radius: 6px;
            display: none;
        }

        .feedback-box.success {
            display: block;
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
        }

        .feedback-box.error {
            display: block;
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .feedback-box.warning {
            display: block;
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fcd34d;
        }

        .assessment-progress {
            margin-top: 40px;
            padding: 20px;
            background: #f3e8ff;
            border-radius: 8px;
            text-align: center;
        }

        .progress-items {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .progress-item {
            padding: 10px 15px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
            margin: 5px;
            font-size: 12px;
        }

        .progress-item.completed {
            background: var(--success-color);
            color: white;
            border-color: var(--success-color);
        }

        .submit-btn {
            background: var(--xp-color);
            font-size: 16px;
            padding: 12px 30px;
        }

        .submit-btn:disabled {
            background: #9ca3af;
        }
        
        /* Notification styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1001;
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.warning {
            border-left: 4px solid var(--warning-color);
        }
        
        .notification.success {
            border-left: 4px solid var(--success-color);
        }
        
        .notification.error {
            border-left: 4px solid var(--error-color);
        }
        
        .notification.info {
            border-left: 4px solid var(--primary-color);
        }
        
        .notification-icon {
            font-size: 20px;
        }
        
        .notification-content h4 {
            margin: 0 0 5px 0;
            font-size: 14px;
            color: var(--text-primary);
        }
        
        .notification-content p {
            margin: 0;
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        /* Disable text selection in code areas */
        .CodeMirror {
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
            user-select: text !important;
        }
        
        .no-copy {
            cursor: not-allowed !important;
        }
        
        /* Extension Section Styles */
        .extension-toggle {
            margin-top: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            border-radius: 8px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
        }

        .extension-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }

        .extension-icon {
            font-size: 20px;
        }

        .extension-text {
            flex: 1;
            font-weight: 600;
        }

        .extension-arrow {
            font-size: 14px;
            transition: transform 0.3s;
        }

        .extension-section {
            margin-top: 10px;
            background: #f3f4f6;
            border-radius: 8px;
            padding: 10px;
        }

        .extension-item {
            position: relative;
            padding: 12px;
            margin: 5px 0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
            border: 1px solid #e5e7eb;
        }

        .extension-item:hover {
            background: #f9fafb;
            border-color: var(--primary-color);
        }

        .extension-item.active {
            background: #f3e8ff;
            border-color: var(--primary-color);
            color: #6d28d9;
        }

        .extension-item.completed {
            border-color: var(--success-color);
        }

        .extension-status {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }

        .extension-status.completed {
            background: var(--success-color);
            color: white;
        }

        .topic-icon {
            font-size: 18px;
        }

        .extension-name {
            flex: 1;
            font-size: 14px;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .extension-xp {
            font-size: 12px;
            color: var(--xp-color);
            font-weight: bold;
            flex-shrink: 0;
            margin-left: auto;
        }

        .extension-feedback {
            margin-top: 15px;
        }

        .extension-code {
            width: 100%;
            min-height: 150px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        /* Game Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 12px;
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }

        .close:hover {
            color: #000;
        }

        .game-timer {
            font-size: 20px;
            font-weight: bold;
            color: var(--error-color);
            margin: 10px 0;
        }

        .game-score {
            font-size: 18px;
            color: var(--success-color);
            margin-bottom: 20px;
        }

        .game-challenge {
            background: #f3f4f6;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin: 15px 0;
        }

        .game-challenge pre {
            background: #1f2937;
            color: #f3f4f6;
            padding: 15px;
            border-radius: 6px;
            font-size: 16px;
            margin: 15px 0;
        }

        .game-challenge input {
            width: 100%;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            margin-bottom: 10px;
        }

        .game-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .game-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .game-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }

        .game-card.selected {
            border-color: var(--success-color);
            background: #ecfdf5;
        }

        .game-card.matched {
            border-color: var(--success-color);
            background: #d1fae5;
            opacity: 0.7;
        }

        .simulation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .simulation-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .simulation-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .play-btn {
            margin-top: 10px;
            background: var(--success-color);
        }

        .simulations-section {
            margin-top: 40px;
            padding: 20px;
            background: #f3f4f6;
            border-radius: 8px;
        }

        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                position: static;
            }
            
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .user-stats {
                width: 100%;
                justify-content: space-around;
            }
            
            .progress-items {
                justify-content: center;
            }
            
            .game-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
            
            .simulation-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body oncopy="return false" oncut="return false" onpaste="return false">
    <div class="header">
        <div class="header-content">
            <div class="header-left">
                <h1>Year 9 Python Programming</h1>
                <p>Section 3 - Inputs</p>
            </div>
            <div class="user-stats">
                <div class="stat-item">
                    <div class="stat-value" id="userLevel">1</div>
                    <div class="stat-label">Level</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="userXP">0</div>
                    <div class="stat-label">XP</div>
                    <div class="xp-bar">
                        <div class="xp-fill" id="xpFill" style="width: 0%"></div>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="userStreak">0</div>
                    <div class="stat-label">Day Streak</div>
                </div>
            </div>
        </div>
        <div class="progress-section">
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar"></div>
            </div>
            <p style="margin: 5px 0 0 0; font-size: 14px; color: white;">Progress: <span id="progressText">0/5 tasks completed</span></p>
            <div class="badges-preview">
                <div class="badge" id="badge-input-master" title="Input Master">‚å®Ô∏è</div>
                <div class="badge" id="badge-interactive-wizard" title="Interactive Wizard">üßô</div>
                <div class="badge" id="badge-story-creator" title="Story Creator">üìñ</div>
                <div class="badge" id="badge-challenge-solver" title="Challenge Solver">üéØ</div>
                <div class="badge" id="badge-perfect-inputs" title="Perfect Inputs">‚≠ê</div>
            </div>
        </div>
    </div>

    <div class="main-container">
        <aside class="sidebar">
            <div class="section-title">Section 3 - Inputs</div>
            <ul class="task-list" id="taskList">
                <li class="task-item active" onclick="switchTask(1)">
                    <span class="task-status" id="status1"></span>
                    <span class="task-name">03.01 Inputs</span>
                    <span class="task-xp">+75 XP</span>
                </li>
                <li class="task-item" onclick="switchTask(2)">
                    <span class="task-status" id="status2"></span>
                    <span class="task-name">03.02 Why Use Inputs?</span>
                    <span class="task-xp">+100 XP</span>
                </li>
                <li class="task-item" onclick="switchTask(3)">
                    <span class="task-status" id="status3"></span>
                    <span class="task-name">03.03 Interactive Story</span>
                    <span class="task-xp">+125 XP</span>
                </li>
                <li class="task-item" onclick="switchTask(4)">
                    <span class="task-status" id="status4"></span>
                    <span class="task-name">03.04 Challenge</span>
                    <span class="task-xp">+150 XP</span>
                </li>
                <li class="task-item" onclick="switchTask(5)">
                    <span class="task-status" id="status5"></span>
                    <span class="task-name">Section Assessment</span>
                    <span class="task-xp">+200 XP</span>
                </li>
            </ul>
            
            <div class="extension-toggle" onclick="toggleExtension()">
                <span class="extension-icon">üöÄ</span>
                <span class="extension-text">Extension Activities</span>
                <span class="extension-arrow" id="extensionArrow">‚ñ∂</span>
            </div>
            <div class="extension-section" id="extensionSection" style="display: none;">
                <div class="extension-item" onclick="showExtensionTopic('multiple-inputs')">
                    <span class="extension-status" id="ext-status-multiple-inputs"></span>
                    <span class="topic-icon">‚ûï</span>
                    <span class="extension-name">Multiple Inputs</span>
                    <span class="extension-xp">+30 XP</span>
                </div>
                <div class="extension-item" onclick="showExtensionTopic('input-validation')">
                    <span class="extension-status" id="ext-status-input-validation"></span>
                    <span class="topic-icon">‚úÖ</span>
                    <span class="extension-name">Input Validation</span>
                    <span class="extension-xp">+40 XP</span>
                </div>
                <div class="extension-item" onclick="showExtensionTopic('number-inputs')">
                    <span class="extension-status" id="ext-status-number-inputs"></span>
                    <span class="topic-icon">üî¢</span>
                    <span class="extension-name">Number Inputs</span>
                    <span class="extension-xp">+35 XP</span>
                </div>
                <div class="extension-item" onclick="showExtensionTopic('menu-systems')">
                    <span class="extension-status" id="ext-status-menu-systems"></span>
                    <span class="topic-icon">üìã</span>
                    <span class="extension-name">Menu Systems</span>
                    <span class="extension-xp">+45 XP</span>
                </div>
                <div class="extension-item" onclick="showExtensionTopic('password-inputs')">
                    <span class="extension-status" id="ext-status-password-inputs"></span>
                    <span class="topic-icon">üîê</span>
                    <span class="extension-name">Password Inputs</span>
                    <span class="extension-xp">+50 XP</span>
                </div>
            </div>
            
            <div class="daily-challenge">
                <h3>üåü Challenge</h3>
                <p>Master inputs by completing all tasks for bonus 300 XP!</p>
            </div>
            
            <div class="settings-panel">
                <div class="section-title">Settings</div>
                <div class="setting-item">
                    <span>Dyslexic Font</span>
                    <div class="toggle-switch" onclick="toggleDyslexicFont()" id="dyslexicToggle">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
                <div class="setting-item">
                    <span>Audio Instructions</span>
                    <div class="toggle-switch" onclick="toggleAudio()" id="audioToggle">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
                <div class="setting-item">
                    <span>Live Syntax Check</span>
                    <div class="toggle-switch active" onclick="toggleSyntaxCheck()" id="syntaxToggle">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 20px;">
                <button onclick="downloadProgress()" style="width: 100%; margin: 5px 0;">
                    üì• Save Progress
                </button>
                <button onclick="resetSection()" style="width: 100%; margin: 5px 0; background: #ef4444;">
                    üîÑ Reset Section
                </button>
            </div>
        </aside>

        <div class="worksheet-container">
            <div id="taskContent">
                <!-- Task content will be dynamically loaded here -->
            </div>
        </div>
    </div>
    
    <div class="overlay" id="overlay"></div>
    <div class="achievement-popup" id="achievementPopup">
        <div class="achievement-icon" id="achievementIcon">üèÜ</div>
        <div class="achievement-title" id="achievementTitle">Achievement Unlocked!</div>
        <div class="achievement-desc" id="achievementDesc">You've earned a new badge!</div>
        <div class="achievement-xp" id="achievementXP">+50 XP</div>
    </div>

    <script>
        // Global variables
        let pyodide = null;
        let editors = {};
        let currentTask = 1;
        let taskProgress = {};
        let currentTheme = 'monokai';
        let userProfile = {
            level: 1,
            xp: 0,
            xpToNextLevel: 500,
            streak: 0,
            badges: [],
            hintsUsed: {},
            attemptsBeforeSuccess: {},
            totalTime: 0,
            lastLogin: new Date().toDateString()
        };
        let taskStartTime = {};
        let codeHistory = {};
        let hintLevel = {};
        let settings = {
            dyslexicFont: false,
            audioEnabled: false,
            syntaxCheckEnabled: true
        };
        
        // Input handling variables
        let inputQueue = [];
        let waitingForInput = false;
        let inputResolver = null;
        
        // Assessment-specific variables
        let assessmentProgress = {
            q1: false,
            q2: false,
            q3: false,
            q4: false,
            q5: false
        };
        
        // XP values for different actions
        const XP_VALUES = {
            taskComplete: { 1: 75, 2: 100, 3: 125, 4: 150, 5: 200 },
            noHints: 25,
            firstTry: 50,
            dailyChallenge: 300,
            perfectWeek: 500
        };
        
        // Badge definitions
        const BADGES = {
            'input-master': { icon: '‚å®Ô∏è', name: 'Input Master', desc: 'Used input() function successfully' },
            'interactive-wizard': { icon: 'üßô', name: 'Interactive Wizard', desc: 'Created interactive programs' },
            'story-creator': { icon: 'üìñ', name: 'Story Creator', desc: 'Completed the interactive story' },
            'challenge-solver': { icon: 'üéØ', name: 'Challenge Solver', desc: 'Completed the challenge task' },
            'perfect-inputs': { icon: '‚≠ê', name: 'Perfect Inputs', desc: 'Completed all tasks without hints' }
        };

        // Task definitions based on curriculum
        const tasks = {
            1: {
                id: "7deb21d5-1a96-4da0-94dc-f5637b3c7bc6",
                title: "03.01 Inputs",
                type: "example",
                xp: 75,
                instructions: `
                    <h3>Inputs</h3>
                    <p>The <code>input()</code> function asks the user for a value and <strong>returns</strong> the result.</p>
                    <p>Returned values replace the call to the <code>input</code> function.</p>
                    
                    <div class="console-info">
                        <strong>Important:</strong> When you run this code, look for the console input area below. Type your answer there and press Enter!
                    </div>
                    
                    <h3>Task</h3>
                    <p>1. Run the code</p>
                    <p>2. Type in your name in the <strong>console</strong> (you'll see "Enter your name: ")</p>
                    <p>3. Press Enter to see the result</p>
                    
                    <h3>Practice</h3>
                    <p>After running the example, add another input that asks for your favorite color and prints it.</p>
                `,
                starterCode: `name = input("Enter your name: ")

print("Hello " + name)`,
                hints: [
                    "After running, look for the console section below where it says 'Enter your name: '",
                    "Type your name and press Enter",
                    "To add the color input, use: color = input('Enter your favorite color: ')",
                    "Then print it: print('I also like ' + color)"
                ],
                smartHints: {
                    'no_input_added': "Add a second input() for the favorite color",
                    'missing_print': "Don't forget to print the color after getting it",
                    'syntax_error': "Check your quotation marks and parentheses"
                },
                checks: [
                    {
                        name: "Name input works",
                        test: (code, output) => code.includes('input(') && code.includes('name')
                    },
                    {
                        name: "Added color input",
                        test: (code, output) => {
                            const inputCount = (code.match(/input\(/g) || []).length;
                            return inputCount >= 2;
                        }
                    },
                    {
                        name: "Prints both values",
                        test: (code, output) => {
                            const printCount = (code.match(/print\(/g) || []).length;
                            return printCount >= 2;
                        }
                    }
                ]
            },
            2: {
                id: "d1430870-b7f0-4d3c-8956-e37ab3eafd08",
                title: "03.02 Why use inputs?",
                type: "practice",
                xp: 100,
                instructions: `
                    <h3>Why use inputs?</h3>
                    <p>Inputs make it easier for a user to interact with your program.</p>
                    <p>Instead of adding <code>age = "12"</code> to the program and expecting users to change the value manually, an <code>input</code> lets the same code work for every person who runs the program.</p>
                    
                    <h3>Task</h3>
                    <p>Run the code multiple times with different ages to see how the output changes.</p>
                    <p>Then add another input that asks for the user's favorite subject and prints a message about it.</p>
                `,
                starterCode: `age = input("Enter your age: ")

print("You are " + age + " years old.")`,
                hints: [
                    "Run the code and try different ages like 12, 15, 16",
                    "Add a new input: subject = input('Enter your favorite subject: ')",
                    "Print a message about the subject"
                ],
                smartHints: {
                    'no_subject_input': "Add an input for favorite subject",
                    'missing_subject_print': "Print a message about the subject",
                    'good_job': "Great! Try running with different inputs"
                },
                checks: [
                    {
                        name: "Age input works",
                        test: (code, output) => code.includes('age') && code.includes('input(')
                    },
                    {
                        name: "Added subject input",
                        test: (code, output) => {
                            return code.includes('subject') || (code.match(/input\(/g) || []).length >= 2;
                        }
                    },
                    {
                        name: "Prints both values",
                        test: (code, output) => {
                            return (code.match(/print\(/g) || []).length >= 2;
                        }
                    }
                ]
            },
            3: {
                id: "153a4eaf-a1f5-4b77-bac1-8b237f911079",
                title: "03.03 Interactive Story",
                type: "practice",
                xp: 125,
                instructions: `
                    <h3>Adventure</h3>
                    <p>Create an interactive story using multiple inputs!</p>
                    <p>The code has the beginning of an adventure story. Add more inputs and lines to complete it.</p>
                    
                    <h3>Task</h3>
                    <p>1. Run the existing code to see how it works</p>
                    <p>2. Add at least 2 more inputs (like a villain, action, etc.)</p>
                    <p>3. Add at least 2 more print statements to continue the story</p>
                    <p>4. Make the story exciting and creative!</p>
                `,
                starterCode: `character = input("Enter a character: ")
place = input("Enter a place: ")
thing = input("Enter a thing: ")
adjective = input("Enter an adjective: ")

print("The " + character + " went to the " + place + " to get a " + thing + ".")
print("The " + thing + " was heavy and " + adjective + ".")
print("The " + character + " decided the " + thing + " was too " + adjective + ".")`,
                hints: [
                    "Add more inputs like: villain = input('Enter a villain: ')",
                    "Create more story lines using your new inputs",
                    "Try: action = input('Enter an action verb: ')",
                    "Make your story have a beginning, middle, and end"
                ],
                smartHints: {
                    'needs_more_inputs': "Add at least 2 more input() statements",
                    'needs_more_story': "Add more print statements to continue the story",
                    'good_story': "Great story! Make sure it uses all your inputs"
                },
                checks: [
                    {
                        name: "Has original inputs",
                        test: (code, output) => {
                            return code.includes('character') && code.includes('place') && 
                                   code.includes('thing') && code.includes('adjective');
                        }
                    },
                    {
                        name: "Added at least 2 more inputs",
                        test: (code, output) => {
                            return (code.match(/input\(/g) || []).length >= 6;
                        }
                    },
                    {
                        name: "Extended the story",
                        test: (code, output) => {
                            return (code.match(/print\(/g) || []).length >= 5;
                        }
                    }
                ]
            },
            4: {
                id: "446239cd-e8e7-4e9e-a313-cad3ad9da060",
                title: "03.04 Challenge - Inputs",
                type: "challenge",
                xp: 150,
                instructions: `
                    <h3>Challenge - Inputs</h3>
                    <p>Write a program that:</p>
                    <ul>
                        <li>Asks the user to input their superhero name. You can just make up something cool!</li>
                        <li>Then, asks the user to input the name of their first pet and the first part of the road they live on</li>
                        <li>Adds these 2 variables together and stores this in a variable called 'alterego' to give their superhero alter ego name. NOTE ‚Äì don't forget the space</li>
                        <li>Prints out "superheroname's alter ego name is‚Ä¶" and then whatever is stored in that variable</li>
                        <li>eg. Spiderman's alter ego name is Roger Broadway</li>
                    </ul>
                `,
                starterCode: ``,
                hints: [
                    "Start with: superhero = input('Enter your superhero name: ')",
                    "Get pet name: pet = input('Enter your first pet's name: ')",
                    "Get road name: road = input('Enter the first part of your road name: ')",
                    "Combine them: alterego = pet + ' ' + road",
                    "Print the final message using all the variables"
                ],
                smartHints: {
                    'no_inputs': "Start by creating input() statements for superhero, pet, and road",
                    'missing_alterego': "Create the alterego variable by combining pet and road with a space",
                    'wrong_format': "The output should be: superhero's alter ego name is alterego",
                    'missing_space': "Don't forget the space between pet and road names"
                },
                checks: [
                    {
                        name: "Has superhero input",
                        test: (code, output) => code.includes('superhero') && code.includes('input(')
                    },
                    {
                        name: "Has pet and road inputs",
                        test: (code, output) => {
                            return (code.includes('pet') || code.includes('first')) && 
                                   (code.includes('road') || code.includes('street'));
                        }
                    },
                    {
                        name: "Creates alterego variable",
                        test: (code, output) => code.includes('alterego')
                    },
                    {
                        name: "Correct output format",
                        test: (code, output) => {
                            return code.includes("'s alter ego name is") || 
                                   code.includes('"s alter ego name is') ||
                                   code.includes("alter ego");
                        }
                    }
                ]
            },
            5: {
                id: "assessment-section-3",
                title: "Section 3 Assessment",
                type: "assessment",
                xp: 200,
                instructions: `
                    <h3>üéØ Section 3 Assessment</h3>
                    <p>Great work on learning about inputs! Now let's test your understanding.</p>
                    <p>This assessment covers:</p>
                    <ul>
                        <li>How the input() function works</li>
                        <li>Why inputs are useful in programs</li>
                        <li>Creating interactive programs</li>
                        <li>Combining inputs with variables and strings</li>
                    </ul>
                `,
                starterCode: ``,
                assessmentQuestions: [
                    {
                        id: "q1",
                        type: "multiple-choice",
                        question: "What does the input() function do?",
                        options: [
                            "It prints text to the screen",
                            "It asks the user to type something and returns what they typed",
                            "It creates a new variable",
                            "It checks if the code is correct"
                        ],
                        correct: 1,
                        explanation: "The input() function waits for the user to type something and returns that value."
                    },
                    {
                        id: "q2",
                        type: "text-input",
                        question: "Explain why using input() is better than hardcoding values like age = '15' in your program",
                        hint: "Think about different users running your program...",
                        keywords: ["user", "different", "change", "interact", "flexible", "everyone", "same code", "work"]
                    },
                    {
                        id: "q3",
                        type: "code",
                        question: "Write code that asks for the user's name and then prints 'Welcome, [name]!'",
                        starterCode: `# Write your code here`,
                        check: (code) => {
                            return code.includes('input(') && code.includes('name') && 
                                   (code.includes('Welcome,') || code.includes('Welcome'));
                        }
                    },
                    {
                        id: "q4",
                        type: "code",
                        question: "Create a simple calculator that asks for two numbers and prints their sum. The output should say 'The sum is: [result]'",
                        starterCode: `# Ask for two numbers and print their sum`,
                        check: (code) => {
                            return (code.match(/input\(/g) || []).length >= 2 && 
                                   code.includes('print(') && 
                                   (code.includes('sum') || code.includes('+'));
                        }
                    },
                    {
                        id: "q5",
                        type: "multiple-choice",
                        question: "What will happen if you don't store the result of input() in a variable?",
                        options: [
                            "The program will crash",
                            "The user's input will be lost and you can't use it",
                            "The input will automatically be printed",
                            "Nothing - it will work fine"
                        ],
                        correct: 1,
                        explanation: "If you don't store input() in a variable, you can't access what the user typed later."
                    }
                ],
                simulations: [

                    {
                        id: "story-builder",
                        title: "üìö Story Builder",
                        description: "Create stories by choosing the right inputs"
                    },
                    {
                        id: "input-validator",
                        title: "‚úÖ Input Validator",
                        description: "Learn to validate different types of user input"
                    },

                ]
            }
        };

        // Extension progress tracking
        let extensionProgress = {
            'multiple-inputs': { completed: false, xp: 30 },
            'input-validation': { completed: false, xp: 40 },
            'number-inputs': { completed: false, xp: 35 },
            'menu-systems': { completed: false, xp: 45 },
            'password-inputs': { completed: false, xp: 50 }
        };

        const extensionChecks = {
            'multiple-inputs': {
                check: (code, output) => {
                    return (code.match(/input\(/g) || []).length >= 3 && code.includes('print(');
                },
                hint: "Get multiple inputs on one line or use a loop"
            },
            'input-validation': {
                check: (code, output) => {
                    return code.includes('if') && code.includes('input(') && 
                           (code.includes('len(') || code.includes('==') || code.includes('!='));
                },
                hint: "Use if statements to check if the input is valid"
            },
            'number-inputs': {
                check: (code, output) => {
                    return code.includes('int(') && code.includes('input(') && code.includes('+');
                },
                hint: "Convert input to int() before doing math"
            },
            'menu-systems': {
                check: (code, output) => {
                    return code.includes('print(') && code.includes('input(') && 
                           code.includes('if') && (code.includes('1') || code.includes('2'));
                },
                hint: "Create a menu with options and use if statements"
            },
            'password-inputs': {
                check: (code, output) => {
                    return code.includes('input(') && code.includes('if') && 
                           code.includes('==') && (code.includes('password') || code.includes('pass'));
                },
                hint: "Check if the input matches a stored password"
            }
        };

        // Initialize CodeMirror editors
        function initializeEditor(taskNum) {
            const textarea = document.getElementById(`code${taskNum}`);
            if (!textarea) return null;
            
            const editor = CodeMirror.fromTextArea(textarea, {
                mode: 'python',
                theme: currentTheme,
                lineNumbers: true,
                indentUnit: 4,
                autoCloseBrackets: true,
                matchBrackets: true,
                indentWithTabs: false,
                viewportMargin: Infinity,
                lint: settings.syntaxCheckEnabled ? pythonLinter : false,
                gutters: settings.syntaxCheckEnabled ? ["CodeMirror-lint-markers"] : ["CodeMirror-linenumbers"],
                extraKeys: {
                    "Tab": function(cm) {
                        cm.replaceSelection("    ", "end");
                    },
                    "Ctrl-Space": "autocomplete",
                    "Ctrl-C": function(cm) { return false; },
                    "Ctrl-X": function(cm) { return false; },
                    "Ctrl-V": function(cm) { return false; },
                    "Cmd-C": function(cm) { return false; },
                    "Cmd-X": function(cm) { return false; },
                    "Cmd-V": function(cm) { return false; }
                }
            });
            
            editors[taskNum] = editor;
            
            // Disable right-click and drag/drop
            editor.getWrapperElement().addEventListener('contextmenu', function(e) {
                e.preventDefault();
                return false;
            });
            
            editor.on('drop', function(cm, e) {
                e.preventDefault();
                return false;
            });
            
            // Track code changes
            editor.on('change', function() {
                saveProgress(taskNum);
                checkForCommonMistakes(taskNum);
                
                // Add to history
                if (!codeHistory[taskNum]) codeHistory[taskNum] = [];
                codeHistory[taskNum].push({
                    code: editor.getValue(),
                    timestamp: new Date()
                });
                
                // Keep only last 20 versions
                if (codeHistory[taskNum].length > 20) {
                    codeHistory[taskNum].shift();
                }
            });
            
            editor.setSize("100%", "300px");
            editor.refresh();
            
            return editor;
        }

        // Python linter for live syntax checking
        function pythonLinter(text, options) {
            const errors = [];
            const lines = text.split('\n');
            
            lines.forEach((line, i) => {
                // Check for missing closing parenthesis
                const openParens = (line.match(/\(/g) || []).length;
                const closeParens = (line.match(/\)/g) || []).length;
                if (openParens > closeParens) {
                    errors.push({
                        from: CodeMirror.Pos(i, line.length),
                        to: CodeMirror.Pos(i, line.length),
                        message: "Missing closing parenthesis )",
                        severity: "error"
                    });
                }
                
                // Check for unclosed quotes
                const quotes = line.match(/"/g) || [];
                if (quotes.length % 2 !== 0) {
                    errors.push({
                        from: CodeMirror.Pos(i, line.length),
                        to: CodeMirror.Pos(i, line.length),
                        message: "Unclosed string - missing \"",
                        severity: "error"
                    });
                }
                
                // Check for common typos
                if (line.includes('inpt(') || line.includes('imput(')) {
                    const col = line.indexOf('inpt(') !== -1 ? line.indexOf('inpt(') : line.indexOf('imput(');
                    errors.push({
                        from: CodeMirror.Pos(i, col),
                        to: CodeMirror.Pos(i, col + 5),
                        message: "Did you mean 'input'?",
                        severity: "warning"
                    });
                }
            });
            
            return errors;
        }

        // Load Pyodide
        async function initializePyodide() {
            const outputElements = document.querySelectorAll('.output-content');
            outputElements.forEach(el => {
                if (el) el.innerHTML = '<span class="loading">Loading Python environment...</span>';
            });
            
            try {
                pyodide = await loadPyodide({
                    indexURL: "https://cdn.jsdelivr.net/pyodide/v0.24.1/full/"
                });
                
                // Set up custom input function
                pyodide.runPython(`
import sys
from js import prompt, inputQueue, waitingForInput, inputResolver

def custom_input(prompt_text=""):
    # Display prompt in console
    console_output = sys.stdout.getvalue() if hasattr(sys.stdout, 'getvalue') else ""
    sys.stdout.write(prompt_text)
    sys.stdout.flush()
    
    # Use JavaScript prompt as fallback
    result = prompt(prompt_text)
    return result if result is not None else ""

# Replace built-in input
__builtins__['input'] = custom_input
                `);
                
                outputElements.forEach(el => {
                    if (el) el.innerHTML = '<span class="success">Python ready! Click "Run" to execute your code.</span>';
                });
            } catch (error) {
                outputElements.forEach(el => {
                    if (el) el.innerHTML = '<span class="error">Failed to load Python. Please refresh.</span>';
                });
                console.error('Failed to load Pyodide:', error);
            }
        }

        // Load task content
        function loadTaskContent(taskNum) {
            const task = tasks[taskNum];
            const taskContent = document.getElementById('taskContent');

            if (task.type === 'assessment') {
                taskContent.innerHTML = `
                    <div class="task-header">
                        <div class="task-header-left">
                            <h2>${task.title}</h2>
                            <span class="task-type assessment">Assessment</span>
                        </div>
                        <div class="task-badges">
                            <span class="task-xp">+${task.xp} XP</span>
                        </div>
                    </div>
                    
                    <div class="instructions">
                        ${task.instructions}
                    </div>
                    
                    <div class="assessment-container">
                        <!-- Question 1: Multiple Choice -->
                        <div class="assessment-question">
                            <h4>Question 1: ${task.assessmentQuestions[0].question}</h4>
                            <div class="mc-options">
                                ${task.assessmentQuestions[0].options.map((opt, i) => `
                                    <label class="mc-option">
                                        <input type="radio" name="q1" value="${i}">
                                        <span>${opt}</span>
                                    </label>
                                `).join('')}
                            </div>
                            <button onclick="checkMCAnswer(5, 0)" class="check-btn">Check Answer</button>
                            <div id="feedback-q1" class="feedback-box"></div>
                        </div>
                        
                        <!-- Question 2: Text Input -->
                        <div class="assessment-question">
                            <h4>Question 2: ${task.assessmentQuestions[1].question}</h4>
                            <textarea class="text-answer" id="textAnswer2" rows="4" 
                                placeholder="Write your answer here..."></textarea>
                            <button onclick="checkTextAnswer(5, 1)" class="check-btn">Check Answer</button>
                            <div id="feedback-q2" class="feedback-box"></div>
                        </div>
                        
                        <!-- Question 3: Code -->
                        <div class="assessment-question">
                            <h4>Question 3: ${task.assessmentQuestions[2].question}</h4>
                            <div class="code-section">
                                <div class="editor-container">
                                    <textarea id="assessCode3">${task.assessmentQuestions[2].starterCode}</textarea>
                                </div>
                                <button onclick="runAssessmentCode('assessCode3')" class="run-btn">‚ñ∂ Run</button>
                                <button onclick="checkAssessmentCode(5, 2, 'assessCode3')" class="check-btn">‚úì Check</button>
                                <div class="output-panel">
                                    <div class="output-header">Output</div>
                                    <div class="output-content" id="output-assessCode3">Ready to run...</div>
                                </div>
                            </div>
                            <div id="feedback-q3" class="feedback-box"></div>
                        </div>
                        
                        <!-- Question 4: Code -->
                        <div class="assessment-question">
                            <h4>Question 4: ${task.assessmentQuestions[3].question}</h4>
                            <div class="code-section">
                                <div class="editor-container">
                                    <textarea id="assessCode4">${task.assessmentQuestions[3].starterCode}</textarea>
                                </div>
                                <button onclick="runAssessmentCode('assessCode4')" class="run-btn">‚ñ∂ Run</button>
                                <button onclick="checkAssessmentCode(5, 3, 'assessCode4')" class="check-btn">‚úì Check</button>
                                <div class="output-panel">
                                    <div class="output-header">Output</div>
                                    <div class="output-content" id="output-assessCode4">Ready to run...</div>
                                </div>
                            </div>
                            <div id="feedback-q4" class="feedback-box"></div>
                        </div>
                        
                        <!-- Question 5: Multiple Choice -->
                        <div class="assessment-question">
                            <h4>Question 5: ${task.assessmentQuestions[4].question}</h4>
                            <div class="mc-options">
                                ${task.assessmentQuestions[4].options.map((opt, i) => `
                                    <label class="mc-option">
                                        <input type="radio" name="q5" value="${i}">
                                        <span>${opt}</span>
                                    </label>
                                `).join('')}
                            </div>
                            <button onclick="checkMCAnswer(5, 4)" class="check-btn">Check Answer</button>
                            <div id="feedback-q5" class="feedback-box"></div>
                        </div>
                        
                        <!-- Interactive Games -->
                        <div class="simulations-section">
                            <h3>üéÆ Interactive Games</h3>
                            <div class="simulation-grid">
                                ${task.simulations.map(sim => `
                                    <div class="simulation-card" onclick="startSimulation('${sim.id}')">
                                        <h4>${sim.title}</h4>
                                        <p>${sim.description}</p>
                                        <button class="play-btn">Play ‚Üí</button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <!-- Progress Summary -->
                        <div class="assessment-progress">
                            <h3>Your Progress</h3>
                            <div class="progress-items">
                                <div class="progress-item" id="prog-q1">‚ùì Q1</div>
                                <div class="progress-item" id="prog-q2">‚ùì Q2</div>
                                <div class="progress-item" id="prog-q3">‚ùì Q3</div>
                                <div class="progress-item" id="prog-q4">‚ùì Q4</div>
                                <div class="progress-item" id="prog-q5">‚ùì Q5</div>
                            </div>
                            <button onclick="submitAssessment(5)" class="submit-btn" id="submitBtn" disabled>
                                Submit Assessment
                            </button>
                        </div>
                    </div>
                    
                    <div id="gameModal" class="modal">
                        <div class="modal-content">
                            <span class="close" onclick="closeGame()">&times;</span>
                            <div id="gameContent"></div>
                        </div>
                    </div>
                `;
                
                setTimeout(() => {
                    initializeAssessmentEditors();
                }, 100);
            } else {
                // For regular tasks
                const consoleHTML = `
                    <div class="console-section" id="console${taskNum}">
                        <div class="console-header">
                            <span class="console-prompt">Console</span>
                            <span style="font-size: 12px; color: #9ca3af;">Type your input here when prompted</span>
                        </div>
                        <div class="console-history" id="consoleHistory${taskNum}"></div>
                        <div style="display: flex; align-items: center; padding: 0 15px;">
                            <span class="console-prompt" id="consolePrompt${taskNum}" style="margin-right: 10px;"></span>
                            <input type="text" class="console-input" id="consoleInput${taskNum}" 
                                   placeholder="Waiting for program..." disabled
                                   onkeypress="handleConsoleInput(event, ${taskNum})">
                        </div>
                    </div>
                `;
                
                taskContent.innerHTML = `
                    <div class="task-header">
                        <div class="task-header-left">
                            <h2>${task.title}</h2>
                            <span class="task-type ${task.type}">${task.type === 'example' ? 'Example' : task.type === 'challenge' ? 'Challenge' : 'Practice'}</span>
                        </div>
                        <div class="task-badges">
                            <span class="task-xp">+${task.xp} XP</span>
                        </div>
                    </div>
                    
                    <div class="instructions">
                        ${task.instructions}
                        <div class="audio-controls">
                            <button class="audio-btn" id="playAudioBtn${taskNum}" onclick="toggleAudioInstructions(${taskNum})" title="Read instructions aloud">
                                üîä
                            </button>
                            <button class="audio-btn" id="stopAudioBtn${taskNum}" onclick="stopAudio()" title="Stop audio" style="display: none;">
                                ‚èπÔ∏è
                            </button>
                        </div>
                    </div>
                    
                    <div class="code-section">
                        <div class="editor-header">
                            <div class="editor-title">Python Code Editor</div>
                        </div>
                        
                        <div class="editor-container">
                            <textarea id="code${taskNum}">${task.starterCode}</textarea>
                        </div>
                        
                        <div class="controls">
                            <button onclick="runCode(${taskNum})" id="runBtn${taskNum}" class="run-btn">
                                ‚ñ∂ Run
                            </button>
                            <button onclick="checkCode(${taskNum})" id="checkBtn${taskNum}" class="check-btn">
                                ‚úì Check
                            </button>
                            <button onclick="showHint(${taskNum})" class="hint-btn">
                                üí° Hint
                            </button>
                            <button onclick="resetCode(${taskNum})" class="reset-btn">
                                ‚Üª Reset
                            </button>
                        </div>
                        
                        <div class="hint-box" id="hint${taskNum}"></div>
                        
                        <div class="output-section">
                            <div class="output-panel">
                                <div class="output-header">
                                    <span>Output</span>
                                    <span class="execution-info" id="execInfo${taskNum}"></span>
                                </div>
                                <div class="output-content" id="output${taskNum}">
                                    <span class="success">Ready to run your code...</span>
                                </div>
                            </div>
                            
                            ${consoleHTML}
                            
                            <div class="output-panel" id="checkPanel${taskNum}" style="display: none;">
                                <div class="output-header">
                                    <span>Check Results</span>
                                </div>
                                <div class="output-content" id="checkOutput${taskNum}">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="next-task-section" id="nextSection${taskNum}">
                        <h3>üéâ Well done! You've completed this task.</h3>
                        <button class="next-btn" onclick="nextTask()">
                            Continue to Next Task ‚Üí
                        </button>
                    </div>
                `;
            }
        }

        // Handle console input
        function handleConsoleInput(event, taskNum) {
            if (event.key === 'Enter') {
                const input = document.getElementById(`consoleInput${taskNum}`);
                const history = document.getElementById(`consoleHistory${taskNum}`);
                const prompt = document.getElementById(`consolePrompt${taskNum}`);
                
                if (input.value.trim() !== '') {
                    // Add to history
                    history.innerHTML += `<div>${prompt.textContent}${input.value}</div>`;
                    
                    // Process input
                    if (inputResolver) {
                        inputResolver(input.value);
                        inputResolver = null;
                    }
                    
                    // Clear input
                    input.value = '';
                    input.disabled = true;
                    prompt.textContent = '';
                }
            }
        }

        // Custom prompt function for Pyodide
        window.prompt = function(message) {
            // For assessment or when running normally, use browser prompt
            return window.originalPrompt ? window.originalPrompt(message) : 
                   window.__proto__.prompt.call(window, message);
        };

        // Initialize assessment editors
        function initializeAssessmentEditors() {
            ['assessCode3', 'assessCode4'].forEach(id => {
                const textarea = document.getElementById(id);
                if (textarea) {
                    const editor = CodeMirror.fromTextArea(textarea, {
                        mode: 'python',
                        theme: currentTheme,
                        lineNumbers: true,
                        indentUnit: 4,
                        autoCloseBrackets: true,
                        matchBrackets: true
                    });
                    editors[id] = editor;
                    editor.setSize("100%", "150px");
                }
            });
        }

        // Run assessment code
        async function runAssessmentCode(editorId) {
            if (!pyodide) {
                const outputElement = document.getElementById(`output-${editorId}`);
                if (outputElement) {
                    outputElement.innerHTML = '<span class="error">Python environment not ready. Please wait...</span>';
                }
                return;
            }
            
            const code = editors[editorId].getValue();
            const outputElement = document.getElementById(`output-${editorId}`);
            
            if (!outputElement) {
                console.error(`Output element not found: output-${editorId}`);
                return;
            }
            
            outputElement.innerHTML = '<span class="loading">Running...</span>';
            
            try {
                pyodide.runPython(`
import sys
from io import StringIO
output_buffer = StringIO()
old_stdout = sys.stdout
sys.stdout = output_buffer
                `);
                
                pyodide.runPython(code);
                
                pyodide.runPython(`
sys.stdout = old_stdout
output_text = output_buffer.getvalue()
output_buffer.close()
                `);
                
                const output = pyodide.globals.get('output_text');
                outputElement.textContent = output || 'No output';
                
            } catch (error) {
                outputElement.innerHTML = `<span class="error">Error: ${error.message}</span>`;
            }
        }

        // Check assessment code
        function checkAssessmentCode(taskNum, questionIndex, editorId) {
            const editor = editors[editorId];
            const code = editor.getValue();
            const question = tasks[taskNum].assessmentQuestions[questionIndex];
            const feedbackEl = document.getElementById(`feedback-q${questionIndex + 1}`);
            
            if (question.check(code)) {
                feedbackEl.innerHTML = '<span class="success">‚úì Correct! Well done!</span>';
                feedbackEl.className = 'feedback-box success';
                assessmentProgress[`q${questionIndex + 1}`] = true;
                document.getElementById(`prog-q${questionIndex + 1}`).textContent = `‚úì Q${questionIndex + 1}`;
                document.getElementById(`prog-q${questionIndex + 1}`).classList.add('completed');
            } else {
                feedbackEl.innerHTML = '<span class="error">Not quite right. Check your code and try again.</span>';
                feedbackEl.className = 'feedback-box error';
            }
            
            checkAssessmentComplete();
        }

        // Check text answers
        function checkTextAnswer(taskNum, questionIndex) {
            const answer = document.getElementById(`textAnswer${questionIndex + 1}`).value.toLowerCase();
            const question = tasks[taskNum].assessmentQuestions[questionIndex];
            const feedbackEl = document.getElementById(`feedback-q${questionIndex + 1}`);
            
            if (answer.length < 20) {
                feedbackEl.innerHTML = '<span class="error">Please write a more detailed answer</span>';
                feedbackEl.className = 'feedback-box error';
                return;
            }
            
            const keywordCount = question.keywords.filter(keyword => 
                answer.includes(keyword.toLowerCase())
            ).length;
            
            if (keywordCount >= 2) {
                feedbackEl.innerHTML = '<span class="success">‚úì Good answer!</span>';
                feedbackEl.className = 'feedback-box success';
                assessmentProgress[`q${questionIndex + 1}`] = true;
                document.getElementById(`prog-q${questionIndex + 1}`).textContent = `‚úì Q${questionIndex + 1}`;
                document.getElementById(`prog-q${questionIndex + 1}`).classList.add('completed');
            } else {
                feedbackEl.innerHTML = `<span class="warning">Your answer could include more relevant details. ${question.hint}</span>`;
                feedbackEl.className = 'feedback-box warning';
            }
            
            checkAssessmentComplete();
        }

        // Check multiple choice answers
        function checkMCAnswer(taskNum, questionIndex) {
            const question = tasks[taskNum].assessmentQuestions[questionIndex];
            const questionNum = questionIndex === 0 ? 1 : 5;
            const selected = document.querySelector(`input[name="q${questionNum}"]:checked`);
            const feedbackEl = document.getElementById(`feedback-q${questionNum}`);
            
            if (!selected) {
                feedbackEl.innerHTML = '<span class="error">Please select an answer</span>';
                feedbackEl.className = 'feedback-box error';
                return;
            }
            
            if (parseInt(selected.value) === question.correct) {
                feedbackEl.innerHTML = '<span class="success">‚úì Correct! ' + question.explanation + '</span>';
                feedbackEl.className = 'feedback-box success';
                assessmentProgress[`q${questionNum}`] = true;
                document.getElementById(`prog-q${questionNum}`).textContent = `‚úì Q${questionNum}`;
                document.getElementById(`prog-q${questionNum}`).classList.add('completed');
            } else {
                feedbackEl.innerHTML = '<span class="error">Not correct. Think about what input() does.</span>';
                feedbackEl.className = 'feedback-box error';
            }
            
            checkAssessmentComplete();
        }

        // Check if assessment is complete
        function checkAssessmentComplete() {
            const allComplete = Object.values(assessmentProgress).every(v => v === true);
            const submitBtn = document.getElementById('submitBtn');
            if (submitBtn) {
                submitBtn.disabled = !allComplete;
            }
        }

        // Submit assessment
        function submitAssessment(taskNum) {
            if (confirm('Submit your assessment?')) {
                taskProgress[taskNum] = {
                    completed: true,
                    timestamp: new Date().toISOString()
                };
                
                awardXP(tasks[taskNum].xp);
                showAchievement('üèÜ', 'Assessment Complete!', 'You finished Section 3 - Inputs!', 200);
                
                updateProgress();
                saveAllProgress();
            }
        }

        // Switch between tasks
        function switchTask(taskNum) {
            currentTask = taskNum;
            
            // Update sidebar active state
            document.querySelectorAll('.task-item').forEach((item, index) => {
                item.classList.toggle('active', index + 1 === taskNum);
            });
            
            // Destroy existing editors to prevent memory leaks
            Object.keys(editors).forEach(key => {
                if (editors[key] && editors[key].toTextArea) {
                    editors[key].toTextArea();
                    delete editors[key];
                }
            });
            
            // Clear input state
            inputQueue = [];
            waitingForInput = false;
            inputResolver = null;
            
            // Load new task content
            loadTaskContent(taskNum);
            
            // Initialize editor after DOM update
            setTimeout(() => {
                if (tasks[taskNum].type !== 'assessment') {
                    const editor = initializeEditor(taskNum);
                    loadProgress(taskNum);
                    
                    if (editor) {
                        editor.refresh();
                        setTimeout(() => {
                            editor.refresh();
                            editor.focus();
                            editor.setCursor(editor.lineCount(), 0);
                        }, 100);
                    }
                }
            }, 50);
            
            // Record task start time
            taskStartTime[taskNum] = new Date();
        }

        // Run code with input support
        async function runCode(taskNumber) {
            if (!pyodide) {
                document.getElementById(`output${taskNumber}`).innerHTML = 
                    '<span class="error">Python environment not ready. Please wait...</span>';
                return;
            }
            
            const code = editors[taskNumber].getValue();
            const outputElement = document.getElementById(`output${taskNumber}`);
            const execInfoElement = document.getElementById(`execInfo${taskNumber}`);
            const runButton = document.getElementById(`runBtn${taskNumber}`);
            
            // Clear console
            const consoleHistory = document.getElementById(`consoleHistory${taskNumber}`);
            const consoleInput = document.getElementById(`consoleInput${taskNumber}`);
            const consolePrompt = document.getElementById(`consolePrompt${taskNumber}`);
            
            if (consoleHistory) consoleHistory.innerHTML = '';
            if (consoleInput) {
                consoleInput.value = '';
                consoleInput.disabled = true;
            }
            if (consolePrompt) consolePrompt.textContent = '';
            
            runButton.disabled = true;
            runButton.textContent = '‚è≥ Running...';
            outputElement.innerHTML = '';
            
            const startTime = performance.now();
            
            // Increment attempts
            if (!userProfile.attemptsBeforeSuccess[taskNumber]) {
                userProfile.attemptsBeforeSuccess[taskNumber] = 0;
            }
            userProfile.attemptsBeforeSuccess[taskNumber]++;
            
            try {
                // Capture output
                pyodide.runPython(`
import sys
from io import StringIO
output_buffer = StringIO()
old_stdout = sys.stdout
sys.stdout = output_buffer
                `);
                
                // Run user code
                try {
                    pyodide.runPython(code);
                } catch (userError) {
                    outputElement.innerHTML = `<span class="error">Error: ${userError.message}</span>`;
                    showErrorHelp(taskNumber, userError.message);
                    return;
                } finally {
                    // Restore stdout
                    pyodide.runPython(`
sys.stdout = old_stdout
output_text = output_buffer.getvalue()
output_buffer.close()
                    `);
                }
                
                const output = pyodide.globals.get('output_text');
                
                if (output) {
                    outputElement.textContent = output;
                    
                    // If output contains input prompts, show message
                    if (output.includes('Enter') && output.includes(':')) {
                        showNotification('üí° Input Required', 'This program uses input() - when running, respond to prompts in the popup dialog.', 'info');
                    }
                } else {
                    outputElement.innerHTML = '<span style="color: #9ca3af;">No output. Use print() to display text.</span>';
                }
                
                // Show execution time
                const endTime = performance.now();
                const execTime = (endTime - startTime).toFixed(2);
                if (execInfoElement) {
                    execInfoElement.textContent = `Executed in ${execTime}ms`;
                }
                
                // Auto-save progress
                saveProgress(taskNumber);
                
            } catch (error) {
                outputElement.innerHTML = `<span class="error">System Error: ${error.message}</span>`;
            } finally {
                runButton.disabled = false;
                runButton.textContent = '‚ñ∂ Run';
                
                // Cleanup
                try {
                    pyodide.runPython(`
if 'output_buffer' in locals():
    output_buffer.close()
if 'output_text' in locals():
    del output_text
                    `);
                } catch (cleanupError) {
                    // Ignore cleanup errors
                }
            }
        }

        // Check code
        async function checkCode(taskNumber) {
            const checkPanel = document.getElementById(`checkPanel${taskNumber}`);
            const checkOutput = document.getElementById(`checkOutput${taskNumber}`);
            const checkButton = document.getElementById(`checkBtn${taskNumber}`);
            
            checkPanel.style.display = 'block';
            checkButton.disabled = true;
            checkButton.textContent = '‚è≥ Checking...';
            
            // First run the code
            await runCode(taskNumber);
            
            const code = editors[taskNumber].getValue();
            const output = document.getElementById(`output${taskNumber}`).textContent;
            const task = tasks[taskNumber];
            
            let checkResults = '';
            let allPassed = true;
            let xpEarned = 0;
            
            for (const check of task.checks) {
                const passed = check.test(code, output);
                allPassed = allPassed && passed;
                checkResults += `<div class="test-result ${passed ? 'test-pass' : 'test-fail'}">
                    ${passed ? '‚úì' : '‚úó'} ${check.name}
                </div>`;
            }
            
            checkOutput.innerHTML = checkResults;
            
            if (allPassed) {
                // Calculate XP
                xpEarned = task.xp;
                
                // Bonus XP for not using hints
                if (!userProfile.hintsUsed[taskNumber] || userProfile.hintsUsed[taskNumber] === 0) {
                    xpEarned += XP_VALUES.noHints;
                    checkOutput.innerHTML += '<div class="test-result test-pass">üåü No hints bonus! +25 XP</div>';
                }
                
                // Bonus XP for first try
                if (userProfile.attemptsBeforeSuccess[taskNumber] === 1) {
                    xpEarned += XP_VALUES.firstTry;
                    checkOutput.innerHTML += '<div class="test-result test-pass">‚ö° First try bonus! +50 XP</div>';
                }
                
                // Mark as completed
                taskProgress[taskNumber] = {
                    completed: true,
                    code: code,
                    timestamp: new Date().toISOString(),
                    attempts: userProfile.attemptsBeforeSuccess[taskNumber],
                    hintsUsed: userProfile.hintsUsed[taskNumber] || 0
                };
                
                // Award XP
                awardXP(xpEarned);
                
                // Check for badges
                checkBadges();
                
                // Update progress
                updateProgress();
                saveAllProgress();
                
                // Show next task button
                document.getElementById(`nextSection${taskNumber}`).style.display = 'block';
                
                checkOutput.innerHTML += `<div class="test-result test-pass xp-gained">üéâ Task Complete! +${xpEarned} XP</div>`;
                
            } else {
                checkOutput.innerHTML += '<div class="test-result test-fail">Keep trying! Click "Hint" if you need assistance.</div>';
            }
            
            checkButton.disabled = false;
            checkButton.textContent = '‚úì Check';
        }

        // Show hint
        function showHint(taskNumber) {
            const hintBox = document.getElementById(`hint${taskNumber}`);
            const hints = tasks[taskNumber].hints;
            
            if (!hintLevel[taskNumber]) hintLevel[taskNumber] = 0;
            if (!userProfile.hintsUsed[taskNumber]) userProfile.hintsUsed[taskNumber] = 0;
            
            if (hintLevel[taskNumber] < hints.length) {
                hintBox.style.display = 'block';
                hintBox.innerHTML = `<strong>Hint ${hintLevel[taskNumber] + 1}:</strong> ${hints[hintLevel[taskNumber]]}`;
                hintLevel[taskNumber]++;
                userProfile.hintsUsed[taskNumber]++;
            } else {
                hintBox.innerHTML = '<strong>All hints shown!</strong> Try reviewing the instructions above.';
            }
        }

        // Check for common mistakes and show smart hints
        function checkForCommonMistakes(taskNumber) {
            const code = editors[taskNumber].getValue();
            const task = tasks[taskNumber];
            
            if (!task.smartHints) return;
            
            // Check patterns and show inline hints
            for (const [pattern, hint] of Object.entries(task.smartHints)) {
                if (checkCodePattern(code, pattern)) {
                    // Could show inline hint notification here
                    break;
                }
            }
        }

        // Check code patterns for smart hints
        function checkCodePattern(code, pattern) {
            switch (pattern) {
                case 'no_input_added':
                    return (code.match(/input\(/g) || []).length < 2;
                case 'missing_print':
                    return !code.includes('print(') || (code.match(/print\(/g) || []).length < 2;
                case 'no_subject_input':
                    return !code.includes('subject');
                case 'needs_more_inputs':
                    return (code.match(/input\(/g) || []).length < 6;
                case 'needs_more_story':
                    return (code.match(/print\(/g) || []).length < 5;
                case 'no_inputs':
                    return !code.includes('input(');
                case 'missing_alterego':
                    return !code.includes('alterego');
                case 'wrong_format':
                    return !code.includes('alter ego');
                case 'missing_space':
                    return code.includes('pet+road') || code.includes('pet +road');
                default:
                    return false;
            }
        }

        // Show error help
        function showErrorHelp(taskNumber, errorMessage) {
            let helpMessage = '<strong>Error Help:</strong><br>';
            
            if (errorMessage.includes('SyntaxError')) {
                helpMessage += '‚Ä¢ Syntax error means Python doesn\'t understand your code format<br>';
                helpMessage += '‚Ä¢ Check for missing quotes, parentheses, or colons<br>';
            } else if (errorMessage.includes('NameError')) {
                helpMessage += '‚Ä¢ NameError means Python doesn\'t recognize a word you used<br>';
                helpMessage += '‚Ä¢ Check your spelling, especially for variable names<br>';
            } else if (errorMessage.includes('IndentationError')) {
                helpMessage += '‚Ä¢ IndentationError means your spacing is wrong<br>';
                helpMessage += '‚Ä¢ Make sure lines start at the beginning (no spaces)<br>';
            }
            
            showNotification('üêõ Error Help', helpMessage, 'error');
        }

        // Reset code
        function resetCode(taskNumber) {
            if (confirm('Reset to the starter code? Your current work will be saved in history.')) {
                editors[taskNumber].setValue(tasks[taskNumber].starterCode);
                document.getElementById(`output${taskNumber}`).innerHTML = '<span class="success">Code reset.</span>';
                document.getElementById(`checkPanel${taskNumber}`).style.display = 'none';
                document.getElementById(`hint${taskNumber}`).style.display = 'none';
                hintLevel[taskNumber] = 0;
                saveProgress(taskNumber);
            }
        }

        // Award XP
        function awardXP(amount) {
            userProfile.xp += amount;
            
            // Check for level up
            while (userProfile.xp >= userProfile.xpToNextLevel) {
                userProfile.xp -= userProfile.xpToNextLevel;
                userProfile.level++;
                userProfile.xpToNextLevel = userProfile.level * 500;
                
                showAchievement('üéâ', 'Level Up!', `You reached level ${userProfile.level}!`, 100);
            }
            
            updateUserStats();
        }

        // Check for badges
        function checkBadges() {
            // Input Master badge
            if (taskProgress[1] && taskProgress[1].completed && !userProfile.badges.includes('input-master')) {
                userProfile.badges.push('input-master');
                showAchievement('‚å®Ô∏è', 'Input Master!', 'You used the input() function successfully!', 50);
            }
            
            // Interactive Wizard badge
            if (taskProgress[2] && taskProgress[2].completed && !userProfile.badges.includes('interactive-wizard')) {
                userProfile.badges.push('interactive-wizard');
                showAchievement('üßô', 'Interactive Wizard!', 'You created interactive programs!', 75);
            }
            
            // Story Creator badge
            if (taskProgress[3] && taskProgress[3].completed && !userProfile.badges.includes('story-creator')) {
                userProfile.badges.push('story-creator');
                showAchievement('üìñ', 'Story Creator!', 'You completed the interactive story!', 100);
            }
            
            // Challenge Solver badge
            if (taskProgress[4] && taskProgress[4].completed && !userProfile.badges.includes('challenge-solver')) {
                userProfile.badges.push('challenge-solver');
                showAchievement('üéØ', 'Challenge Solver!', 'You completed the challenge task!', 150);
            }
            
            // Perfect Inputs badge
            const practicalTasksCompleted = [1, 2, 3, 4].every(num => taskProgress[num] && taskProgress[num].completed);
            const noHintsUsed = [1, 2, 3, 4].every(num => !userProfile.hintsUsed[num] || userProfile.hintsUsed[num] === 0);
            
            if (practicalTasksCompleted && noHintsUsed && !userProfile.badges.includes('perfect-inputs')) {
                userProfile.badges.push('perfect-inputs');
                showAchievement('‚≠ê', 'Perfect Inputs!', 'You completed all tasks without hints!', 300);
            }
            
            updateBadgeDisplay();
        }

        // Show achievement popup
        function showAchievement(icon, title, description, xp) {
            const popup = document.getElementById('achievementPopup');
            const overlay = document.getElementById('overlay');
            
            document.getElementById('achievementIcon').textContent = icon;
            document.getElementById('achievementTitle').textContent = title;
            document.getElementById('achievementDesc').textContent = description;
            document.getElementById('achievementXP').textContent = `+${xp} XP`;
            
            overlay.classList.add('show');
            popup.classList.add('show');
            
            // Award XP
            awardXP(xp);
            
            // Hide after 3 seconds
            setTimeout(() => {
                overlay.classList.remove('show');
                popup.classList.remove('show');
            }, 3000);
        }

        // Update badge display
        function updateBadgeDisplay() {
            userProfile.badges.forEach(badgeId => {
                const badgeElement = document.getElementById(`badge-${badgeId}`);
                if (badgeElement) {
                    badgeElement.classList.add('earned');
                }
            });
        }

        // Update user stats
        function updateUserStats() {
            document.getElementById('userLevel').textContent = userProfile.level;
            document.getElementById('userXP').textContent = userProfile.xp;
            document.getElementById('userStreak').textContent = userProfile.streak;
            
            const xpPercentage = (userProfile.xp / userProfile.xpToNextLevel) * 100;
            document.getElementById('xpFill').style.width = `${xpPercentage}%`;
        }

        // Show notification function
        function showNotification(title, message, type = 'info') {
            // Remove any existing notifications
            const existing = document.querySelector('.notification');
            if (existing) existing.remove();
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="notification-icon">
                    ${type === 'warning' ? '‚ö†Ô∏è' : type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}
                </div>
                <div class="notification-content">
                    <h4>${title}</h4>
                    <p>${message}</p>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Trigger animation
            setTimeout(() => notification.classList.add('show'), 10);
            
            // Remove after 4 seconds
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }, 4000);
        }

        // Update progress including extensions
        function updateProgress() {
            const completedTasks = Object.values(taskProgress).filter(t => t.completed).length;
            const completedExtensions = Object.values(extensionProgress).filter(e => e.completed).length;
            const totalTasks = Object.keys(tasks).length;
            const totalExtensions = Object.keys(extensionProgress).length;
            
            document.getElementById('progressText').textContent = 
                `${completedTasks}/${totalTasks} tasks${completedExtensions > 0 ? `, ${completedExtensions}/${totalExtensions} extensions` : ''} completed`;
            
            // Update progress bar to include extensions
            const totalItems = totalTasks + totalExtensions;
            const totalCompleted = completedTasks + completedExtensions;
            document.getElementById('progressBar').style.width = `${(totalCompleted / totalItems) * 100}%`;
            
            // Update status indicators
            for (let i = 1; i <= totalTasks; i++) {
                const statusElement = document.getElementById(`status${i}`);
                if (taskProgress[i] && taskProgress[i].completed) {
                    statusElement.classList.add('completed');
                    statusElement.textContent = '‚úì';
                    document.querySelectorAll('.task-item')[i - 1].classList.add('completed');
                }
            }
        }

        // Toggle settings
        function toggleDyslexicFont() {
            settings.dyslexicFont = !settings.dyslexicFont;
            document.body.classList.toggle('dyslexic-font', settings.dyslexicFont);
            document.getElementById('dyslexicToggle').classList.toggle('active', settings.dyslexicFont);
            saveSettings();
        }
        
        function toggleAudio() {
            settings.audioEnabled = !settings.audioEnabled;
            document.getElementById('audioToggle').classList.toggle('active', settings.audioEnabled);
            
            if (!settings.audioEnabled) {
                stopAudio();
            }
            
            saveSettings();
        }
        
        function toggleSyntaxCheck() {
            settings.syntaxCheckEnabled = !settings.syntaxCheckEnabled;
            document.getElementById('syntaxToggle').classList.toggle('active', settings.syntaxCheckEnabled);
            
            // Recreate editors with new settings
            Object.keys(editors).forEach(key => {
                if (editors[key] && editors[key].toTextArea) {
                    const code = editors[key].getValue();
                    editors[key].toTextArea();
                    delete editors[key];
                }
            });
            
            setTimeout(() => {
                if (tasks[currentTask].type !== 'assessment') {
                    initializeEditor(currentTask);
                    loadProgress(currentTask);
                }
            }, 100);
            
            saveSettings();
        }

        // Audio control variables
        let currentUtterance = null;
        let isPlaying = false;
        
        // Toggle audio instructions
        function toggleAudioInstructions(taskNumber) {
            if (!settings.audioEnabled) {
                showNotification('üîä Audio Disabled', 'Enable audio in settings to use this feature', 'warning');
                return;
            }
            
            if (isPlaying) {
                stopAudio();
            } else {
                playAudioInstructions(taskNumber);
            }
        }
        
        // Play audio instructions
        function playAudioInstructions(taskNumber) {
            const task = tasks[taskNumber];
            const text = task.instructions.replace(/<[^>]*>/g, ''); // Strip HTML
            
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
                currentUtterance = new SpeechSynthesisUtterance(text);
                currentUtterance.rate = 0.9;
                
                currentUtterance.onstart = () => {
                    isPlaying = true;
                    const playBtn = document.getElementById(`playAudioBtn${taskNumber}`);
                    const stopBtn = document.getElementById(`stopAudioBtn${taskNumber}`);
                    if (playBtn) playBtn.style.display = 'none';
                    if (stopBtn) stopBtn.style.display = 'block';
                };
                
                currentUtterance.onend = () => {
                    isPlaying = false;
                    const playBtn = document.getElementById(`playAudioBtn${taskNumber}`);
                    const stopBtn = document.getElementById(`stopAudioBtn${taskNumber}`);
                    if (playBtn) playBtn.style.display = 'block';
                    if (stopBtn) stopBtn.style.display = 'none';
                };
                
                speechSynthesis.speak(currentUtterance);
            }
        }
        
        function stopAudio() {
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
                isPlaying = false;
                
                // Reset all audio buttons
                for (let i = 1; i <= Object.keys(tasks).length; i++) {
                    const playBtn = document.getElementById(`playAudioBtn${i}`);
                    const stopBtn = document.getElementById(`stopAudioBtn${i}`);
                    if (playBtn) playBtn.style.display = 'block';
                    if (stopBtn) stopBtn.style.display = 'none';
                }
            }
        }

        // Next task
        function nextTask() {
            if (currentTask < Object.keys(tasks).length) {
                switchTask(currentTask + 1);
            } else {
                // Check for daily challenge completion
                const allCompleted = [1, 2, 3, 4].every(num => taskProgress[num] && taskProgress[num].completed);
                const noHintsUsed = [1, 2, 3, 4].every(num => !userProfile.hintsUsed[num] || userProfile.hintsUsed[num] === 0);
                
                if (allCompleted && noHintsUsed) {
                    showAchievement('üåü', 'Daily Challenge Complete!', 'You completed all tasks without hints!', 300);
                }
                
                alert('Congratulations! You have completed all tasks in Section 3 - Inputs.');
            }
        }

        // Save/Load functions
        function saveProgress(taskNumber) {
            if (!editors[taskNumber]) return;
            
            const code = editors[taskNumber].getValue();
            const progress = {
                code: code,
                timestamp: new Date().toISOString()
            };
            
            const allProgress = JSON.parse(localStorage.getItem('pythonWorksheetSection3Progress') || '{}');
            allProgress[taskNumber] = progress;
            localStorage.setItem('pythonWorksheetSection3Progress', JSON.stringify(allProgress));
        }

        function loadProgress(taskNumber) {
            const allProgress = JSON.parse(localStorage.getItem('pythonWorksheetSection3Progress') || '{}');
            
            if (allProgress[taskNumber] && editors[taskNumber]) {
                editors[taskNumber].setValue(allProgress[taskNumber].code);
            }
        }
        
        function saveAllProgress() {
            localStorage.setItem('pythonWorksheetSection3TaskProgress', JSON.stringify(taskProgress));
            localStorage.setItem('pythonWorksheetSection3UserProfile', JSON.stringify(userProfile));
        }
        
        function saveSettings() {
            localStorage.setItem('pythonWorksheetSection3Settings', JSON.stringify(settings));
        }

        // Download progress
        function downloadProgress() {
            let documentContent = `Python Programming - Section 3: Inputs
Student: Level ${userProfile.level} (${userProfile.xp} XP)
Date: ${new Date().toLocaleDateString()}
=====================================\n\n`;
            
            for (let i = 1; i <= Object.keys(tasks).length; i++) {
                const task = tasks[i];
                const completed = taskProgress[i] && taskProgress[i].completed;
                
                documentContent += `${task.title}${completed ? ' ‚úì' : ' (Not completed)'}\n`;
                documentContent += '-'.repeat(task.title.length + (completed ? 2 : 16)) + '\n\n';
                
                let code = '';
                if (editors[i]) {
                    code = editors[i].getValue();
                } else if (localStorage.getItem('pythonWorksheetSection3Progress')) {
                    const progress = JSON.parse(localStorage.getItem('pythonWorksheetSection3Progress'));
                    if (progress[i]) code = progress[i].code;
                } else {
                    code = task.starterCode || '';
                }
                
                documentContent += code + '\n\n';
                
                if (completed) {
                    documentContent += `Completed on: ${new Date(taskProgress[i].timestamp).toLocaleDateString()}\n`;
                    documentContent += `Attempts: ${taskProgress[i].attempts || 'N/A'}\n`;
                    documentContent += `Hints used: ${taskProgress[i].hintsUsed || 0}\n`;
                }
                
                documentContent += '\n' + '='.repeat(50) + '\n\n';
            }
            
            const completedCount = Object.values(taskProgress).filter(t => t.completed).length;
            documentContent += `\nSummary\n-------\n`;
            documentContent += `Tasks completed: ${completedCount}/${Object.keys(tasks).length}\n`;
            documentContent += `Total XP earned: ${userProfile.xp}\n`;
            documentContent += `Current level: ${userProfile.level}\n`;
            documentContent += `Badges earned: ${userProfile.badges.map(b => BADGES[b]?.name || b).join(', ') || 'None'}\n`;
            
            const blob = new Blob([documentContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `python_section3_inputs_${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // Reset section
        function resetSection() {
            if (confirm('Reset all progress in this section? This cannot be undone!')) {
                localStorage.removeItem('pythonWorksheetSection3Progress');
                localStorage.removeItem('pythonWorksheetSection3TaskProgress');
                localStorage.removeItem('pythonWorksheetSection3UserProfile');
                localStorage.removeItem('pythonWorksheetSection3Settings');
                
                taskProgress = {};
                userProfile = {
                    level: 1,
                    xp: 0,
                    xpToNextLevel: 500,
                    streak: 0,
                    badges: [],
                    hintsUsed: {},
                    attemptsBeforeSuccess: {},
                    totalTime: 0,
                    lastLogin: new Date().toDateString()
                };
                hintLevel = {};
                codeHistory = {};
                
                location.reload();
            }
        }

        // Game functions
        function startSimulation(simId) {
            const modal = document.getElementById('gameModal');
            const content = document.getElementById('gameContent');
            
            modal.style.display = 'block';
            
            switch(simId) {

                case 'story-builder':
                    content.innerHTML = createStoryBuilderGame();
                    startStoryBuilder();
                    break;
                case 'input-validator':
                    content.innerHTML = createInputValidatorGame();
                    startInputValidator();
                    break;
            }
        }

        function closeGame() {
            const modal = document.getElementById('gameModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }



        function createStoryBuilderGame() {
            return `
                <h2>üìö Story Builder</h2>
                <p>Create a story by providing the right inputs!</p>
                <div id="storyContent"></div>
            `;
        }

        function startStoryBuilder() {
            const stories = [
                {
                    template: "Once upon a time, {character} went to {place} to find {item}. They met {friend} who helped them {action}.",
                    inputs: ["a character", "a place", "an item", "a friend", "an action"]
                },
                {
                    template: "In the year {year}, {hero} discovered {discovery} in {location}. This changed {what} forever!",
                    inputs: ["a year", "a hero name", "a discovery", "a location", "what it changed"]
                }
            ];
            
            let currentStory = 0;
            let inputs = [];
            let inputIndex = 0;
            
            function collectInput() {
                const story = stories[currentStory];
                if (inputIndex < story.inputs.length) {
                    document.getElementById('storyContent').innerHTML = `
                        <h4>Enter ${story.inputs[inputIndex]}:</h4>
                        <input type="text" id="storyInput" placeholder="Type here..." autocomplete="off">
                        <button onclick="addStoryInput()">Add</button>
                    `;
                    document.getElementById('storyInput').focus();
                } else {
                    showStory();
                }
            }
            
            window.addStoryInput = function() {
                const input = document.getElementById('storyInput').value.trim();
                if (input) {
                    inputs.push(input);
                    inputIndex++;
                    collectInput();
                }
            };
            
            function showStory() {
                let story = stories[currentStory].template;
                const placeholders = story.match(/{[^}]+}/g);
                placeholders.forEach((placeholder, i) => {
                    story = story.replace(placeholder, `<strong>${inputs[i]}</strong>`);
                });
                
                document.getElementById('storyContent').innerHTML = `
                    <h3>Your Story:</h3>
                    <p style="font-size: 18px; line-height: 1.8;">${story}</p>
                    <button onclick="nextStory()">Create Another Story</button>
                    <button onclick="closeGame()">Close</button>
                `;
            }
            
            window.nextStory = function() {
                currentStory = (currentStory + 1) % stories.length;
                inputs = [];
                inputIndex = 0;
                collectInput();
            };
            
            collectInput();
        }

        function createInputValidatorGame() {
            return `
                <h2>‚úÖ Input Validator</h2>
                <p>Learn to validate different types of input!</p>
                <div id="validatorContent"></div>
            `;
        }

        function startInputValidator() {
            const validations = [
                { type: "age", rule: "Must be a number between 1-120", check: (v) => !isNaN(v) && v >= 1 && v <= 120 },
                { type: "email", rule: "Must contain @ symbol", check: (v) => v.includes('@') },
                { type: "password", rule: "Must be at least 6 characters", check: (v) => v.length >= 6 },
                { type: "yes/no", rule: "Must be 'yes' or 'no'", check: (v) => v.toLowerCase() === 'yes' || v.toLowerCase() === 'no' }
            ];
            
            let currentValidation = 0;
            let score = 0;
            
            function showValidation() {
                const validation = validations[currentValidation];
                document.getElementById('validatorContent').innerHTML = `
                    <h3>Validate: ${validation.type}</h3>
                    <p>Rule: ${validation.rule}</p>
                    <input type="text" id="validInput" placeholder="Enter ${validation.type}" autocomplete="off">
                    <button onclick="validateInput()">Validate</button>
                    <div id="validFeedback"></div>
                    <div style="margin-top: 20px;">Score: ${score}/${validations.length}</div>
                `;
                document.getElementById('validInput').focus();
            }
            
            window.validateInput = function() {
                const input = document.getElementById('validInput').value;
                const validation = validations[currentValidation];
                
                if (validation.check(input)) {
                    score++;
                    document.getElementById('validFeedback').innerHTML = '<span class="success">‚úì Valid input!</span>';
                    currentValidation++;
                    
                    if (currentValidation < validations.length) {
                        setTimeout(showValidation, 1500);
                    } else {
                        showResults();
                    }
                } else {
                    document.getElementById('validFeedback').innerHTML = `<span class="error">‚úó Invalid. Remember: ${validation.rule}</span>`;
                }
            };
            
            function showResults() {
                document.getElementById('validatorContent').innerHTML = `
                    <h3>Validation Complete!</h3>
                    <p>You validated ${score}/${validations.length} inputs correctly!</p>
                    ${score === validations.length ? '<p>Perfect score! üéâ</p>' : '<p>Keep practicing!</p>'}
                    <button onclick="closeGame()">Close</button>
                `;
            }
            
            showValidation();
        }

        

        // Extension section functions
        function toggleExtension() {
            const section = document.getElementById('extensionSection');
            const arrow = document.getElementById('extensionArrow');
            
            if (section.style.display === 'none' || section.style.display === '') {
                section.style.display = 'block';
                arrow.textContent = '‚ñº';
            } else {
                section.style.display = 'none';
                arrow.textContent = '‚ñ∂';
            }
        }

        function showExtensionTopic(topic) {
            const taskContent = document.getElementById('taskContent');
            
            // Hide task content
            taskContent.style.display = 'none';
            
            // Update active states
            document.querySelectorAll('.task-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.extension-item').forEach(item => item.classList.remove('active'));
            
            // Add active to clicked extension item
            document.querySelectorAll('.extension-item').forEach(item => {
                if (item.getAttribute('onclick') && item.getAttribute('onclick').includes(`showExtensionTopic('${topic}')`)) {
                    item.classList.add('active');
                }
            });
            
            // Load extension content
            taskContent.innerHTML = getExtensionContent(topic);
            taskContent.style.display = 'block';
            
            // Initialize CodeMirror for extension
            setTimeout(() => {
                taskContent.querySelectorAll('textarea.extension-code[id]').forEach(textarea => {
                    const editorId = textarea.id;
                    if (editors[editorId]) {
                        editors[editorId].toTextArea();
                        delete editors[editorId];
                    }
                    const editor = CodeMirror.fromTextArea(textarea, {
                        mode: 'python',
                        theme: currentTheme,
                        lineNumbers: true,
                        indentUnit: 4,
                        autoCloseBrackets: true,
                        matchBrackets: true,
                        readOnly: textarea.hasAttribute('readonly')
                    });
                    editor.setSize("100%", textarea.hasAttribute('readonly') ? "auto" : "150px");
                    editor.refresh();
                    editors[editorId] = editor;
                });
            }, 100);
        }

        function getExtensionContent(topic) {
            const topicsData = {
                'multiple-inputs': {
                    title: 'Multiple Inputs on One Line',
                    content: `<h3>Getting Multiple Inputs</h3>
                    <p>Sometimes you want to get multiple values at once. Here are different approaches:</p>
                    <pre>
# Method 1: Multiple separate inputs
name = input("Name: ")
age = input("Age: ")
city = input("City: ")

# Method 2: Split one input (advanced)
data = input("Enter name, age, city: ")
# User types: John, 25, London</pre>
                    <h4>Try it:</h4>
                    <p>Create a program that gets 3 favorite things from the user and prints them in a sentence.</p>
                    <textarea class="extension-code" id="ext-multiple"># Get 3 favorite things</textarea>
                    <button onclick="runExtensionCode('ext-multiple')" class="run-btn">‚ñ∂ Run</button>
                    <button onclick="checkExtensionComplete('multiple-inputs', 'ext-multiple')" class="check-btn">‚úì Check</button>
                    <div class="output-panel"><div class="output-header">Output</div><div class="output-content" id="output-ext-multiple"></div></div>
                    <div id="feedback-ext-multiple"></div>`
                },
                'input-validation': {
                    title: 'Validating User Input',
                    content: `<h3>Input Validation</h3>
                    <p>Always validate user input to make sure it's what you expect!</p>
                    <pre>
name = input("Enter your name: ")
if len(name) > 0:
    print("Hello, " + name)
else:
    print("You didn't enter a name!")</pre>
                    <h4>Try it:</h4>
                    <p>Create a program that checks if the user entered a valid age (not empty and not text).</p>
                    <textarea class="extension-code" id="ext-validation"># Validate age input</textarea>
                    <button onclick="runExtensionCode('ext-validation')" class="run-btn">‚ñ∂ Run</button>
                    <button onclick="checkExtensionComplete('input-validation', 'ext-validation')" class="check-btn">‚úì Check</button>
                    <div class="output-panel"><div class="output-header">Output</div><div class="output-content" id="output-ext-validation"></div></div>
                    <div id="feedback-ext-validation"></div>`
                },
                'number-inputs': {
                    title: 'Working with Number Inputs',
                    content: `<h3>Number Inputs</h3>
                    <p>The input() function always returns text (string). To do math, convert to numbers:</p>
                    <pre>
# Convert to integer
age = int(input("Enter your age: "))
next_year = age + 1
print("Next year you'll be " + str(next_year))

# Convert to float (decimal)
price = float(input("Enter price: "))
tax = price * 0.2
print("Tax: " + str(tax))</pre>
                    <h4>Try it:</h4>
                    <p>Create a simple calculator that adds two numbers.</p>
                    <textarea class="extension-code" id="ext-numbers"># Number calculator</textarea>
                    <button onclick="runExtensionCode('ext-numbers')" class="run-btn">‚ñ∂ Run</button>
                    <button onclick="checkExtensionComplete('number-inputs', 'ext-numbers')" class="check-btn">‚úì Check</button>
                    <div class="output-panel"><div class="output-header">Output</div><div class="output-content" id="output-ext-numbers"></div></div>
                    <div id="feedback-ext-numbers"></div>`
                },
                'menu-systems': {
                    title: 'Creating Menu Systems',
                    content: `<h3>Menu Systems</h3>
                    <p>Use inputs to create interactive menus:</p>
                    <pre>
print("=== MENU ===")
print("1. Play Game")
print("2. View Scores")
print("3. Exit")
choice = input("Choose option (1-3): ")

if choice == "1":
    print("Starting game...")
elif choice == "2":
    print("High scores...")
elif choice == "3":
    print("Goodbye!")
else:
    print("Invalid choice!")</pre>
                    <h4>Try it:</h4>
                    <p>Create your own menu with at least 3 options.</p>
                    <textarea class="extension-code" id="ext-menu"># Create a menu</textarea>
                    <button onclick="runExtensionCode('ext-menu')" class="run-btn">‚ñ∂ Run</button>
                    <button onclick="checkExtensionComplete('menu-systems', 'ext-menu')" class="check-btn">‚úì Check</button>
                    <div class="output-panel"><div class="output-header">Output</div><div class="output-content" id="output-ext-menu"></div></div>
                    <div id="feedback-ext-menu"></div>`
                },
                'password-inputs': {
                    title: 'Password Systems',
                    content: `<h3>Password Protection</h3>
                    <p>Create simple password systems using input:</p>
                    <pre>
correct_password = "python123"
user_password = input("Enter password: ")

if user_password == correct_password:
    print("Access granted!")
    print("Welcome to the secret area")
else:
    print("Access denied!")</pre>
                    <h4>Try it:</h4>
                    <p>Create a username and password system.</p>
                    <textarea class="extension-code" id="ext-password"># Username and password check</textarea>
                    <button onclick="runExtensionCode('ext-password')" class="run-btn">‚ñ∂ Run</button>
                    <button onclick="checkExtensionComplete('password-inputs', 'ext-password')" class="check-btn">‚úì Check</button>
                    <div class="output-panel"><div class="output-header">Output</div><div class="output-content" id="output-ext-password"></div></div>
                    <div id="feedback-ext-password"></div>`
                }
            };
            
            const topicData = topicsData[topic];
            if (topicData) {
                return `<div class="task-header"><div class="task-header-left"><h2>${topicData.title}</h2></div></div><div class="instructions">${topicData.content}</div>`;
            }
            return '<p>Topic not found</p>';
        }

        async function runExtensionCode(editorId) {
            if (!pyodide) {
                alert('Python environment not ready');
                return;
            }
            
            const outputDiv = document.getElementById(`output-${editorId}`);
            let code;
            
            if (editors[editorId]) {
                code = editors[editorId].getValue();
            } else {
                const textarea = document.getElementById(editorId);
                if (textarea) code = textarea.value;
                else {
                    if(outputDiv) outputDiv.innerHTML = '<span class="error">Editor not found.</span>';
                    return;
                }
            }
            
            if(outputDiv) outputDiv.innerHTML = '<span class="loading">Running...</span>';
            
            try {
                pyodide.runPython(`
import sys
from io import StringIO
output_buffer = StringIO()
old_stdout = sys.stdout
sys.stdout = output_buffer
                `);
                pyodide.runPython(code);
                pyodide.runPython(`
sys.stdout = old_stdout
output_text = output_buffer.getvalue()
output_buffer.close()
                `);
                const output = pyodide.globals.get('output_text');
                if(outputDiv) outputDiv.innerHTML = `<pre>${output || 'No output'}</pre>`;
            } catch (error) {
                if(outputDiv) outputDiv.innerHTML = `<span class="error">Error: ${error.message}</span>`;
            }
        }

        async function checkExtensionComplete(topic, editorId) {
            const feedbackDiv = document.getElementById(`feedback-${editorId}`);
            let code;
            if (editors[editorId]) {
                code = editors[editorId].getValue();
            } else {
                const textarea = document.getElementById(editorId);
                if (textarea) code = textarea.value;
                else {
                    if(feedbackDiv) feedbackDiv.innerHTML = '<div class="test-result test-fail">Editor not found.</div>';
                    return;
                }
            }
            
            const outputDiv = document.getElementById(`output-${editorId}`);
            const output = outputDiv ? (outputDiv.textContent || '') : '';
            
            const check = extensionChecks[topic];
            if (check && check.check(code, output)) {
                if (!extensionProgress[topic].completed) {
                    extensionProgress[topic].completed = true;
                    const xpEarned = extensionProgress[topic].xp;
                    if(feedbackDiv) feedbackDiv.innerHTML = `<div class="test-result test-pass">‚úì Excellent work! <span class="xp-gained">+${xpEarned} XP</span></div>`;
                    awardXP(xpEarned);
                    updateExtensionStatus(topic);
                    saveExtensionProgress();
                } else {
                    if(feedbackDiv) feedbackDiv.innerHTML = `<div class="test-result test-pass">‚úì Correct! Already completed.</div>`;
                }
            } else {
                if(feedbackDiv) feedbackDiv.innerHTML = `<div class="test-result test-fail">Not quite right. ${check ? check.hint : 'Try again!'}</div>`;
            }
        }

        function updateExtensionStatus(topic) {
            const statusElement = document.getElementById(`ext-status-${topic}`);
            if (statusElement) {
                statusElement.classList.add('completed');
                statusElement.textContent = '‚úì';
            }
            document.querySelectorAll('.extension-item').forEach(item => {
                if (item.getAttribute('onclick') && item.getAttribute('onclick').includes(`showExtensionTopic('${topic}')`)) {
                    item.classList.add('completed');
                }
            });
            updateProgress();
        }

        function saveExtensionProgress() {
            localStorage.setItem('pythonWorksheetSection3ExtensionProgress', JSON.stringify(extensionProgress));
        }

        // Disable copy/paste globally for the page
        document.addEventListener('DOMContentLoaded', function() {
            // Disable text selection on the page (except in editors)
            document.addEventListener('selectstart', function(e) {
                if (e.target && e.target.closest && e.target.closest('.CodeMirror')) {
                    e.preventDefault();
                }
            });
            
            // Disable copy keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if ((e.ctrlKey || e.metaKey) && (e.key === 'c' || e.key === 'x' || e.key === 'v')) {
                    if (e.target.closest('.CodeMirror')) {
                        return;
                    }
                    e.preventDefault();
                    return false;
                }
            });
            
            // Disable right-click context menu
            document.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                return false;
            });
        });
        
        // Initialize everything
        window.addEventListener('load', () => {
            // Store original prompt
            window.originalPrompt = window.prompt;
            
            // Load saved data
            const savedTaskProgress = localStorage.getItem('pythonWorksheetSection3TaskProgress');
            if (savedTaskProgress) {
                try {
                    taskProgress = JSON.parse(savedTaskProgress);
                } catch (e) {
                    console.error('Failed to parse task progress:', e);
                }
            }
            
            const savedUserProfile = localStorage.getItem('pythonWorksheetSection3UserProfile');
            if (savedUserProfile) {
                try {
                    userProfile = JSON.parse(savedUserProfile);
                } catch (e) {
                    console.error('Failed to parse user profile:', e);
                }
            }
            
            const savedSettings = localStorage.getItem('pythonWorksheetSection3Settings');
            if (savedSettings) {
                try {
                    settings = JSON.parse(savedSettings);
                    
                    // Apply settings
                    if (settings.dyslexicFont) {
                        document.body.classList.add('dyslexic-font');
                        document.getElementById('dyslexicToggle').classList.add('active');
                    }
                    if (settings.audioEnabled) {
                        document.getElementById('audioToggle').classList.add('active');
                    }
                    if (!settings.syntaxCheckEnabled) {
                        document.getElementById('syntaxToggle').classList.remove('active');
                    }
                } catch (e) {
                    console.error('Failed to parse settings:', e);
                }
            }
            
            // Load extension progress
            const savedExtensionProgress = localStorage.getItem('pythonWorksheetSection3ExtensionProgress');
            if (savedExtensionProgress) {
                try {
                    extensionProgress = JSON.parse(savedExtensionProgress);
                    // Update extension status indicators
                    Object.keys(extensionProgress).forEach(topic => {
                        if (extensionProgress[topic].completed) {
                            updateExtensionStatus(topic);
                        }
                    });
                } catch (e) {
                    console.error('Failed to parse extension progress:', e);
                }
            }
            
            // Check for daily streak
            const today = new Date().toDateString();
            if (userProfile.lastLogin !== today) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                
                if (userProfile.lastLogin === yesterday.toDateString()) {
                    userProfile.streak++;
                    if (userProfile.streak === 5 && !userProfile.badges.includes('streak')) {
                        userProfile.badges.push('streak');
                        showAchievement('üî•', '5-Day Streak!', 'You\'ve been coding for 5 days straight!', 100);
                    }
                } else {
                    userProfile.streak = 1;
                }
                
                userProfile.lastLogin = today;
                saveAllProgress();
            }
            
            // Initialize displays
            updateProgress();
            updateUserStats();
            updateBadgeDisplay();
            
            // Initialize first task
            switchTask(1);
            
            // Initialize Pyodide
            initializePyodide();
        });
        
        // Make functions globally available for onclick handlers
        window.switchTask = switchTask;
        window.runCode = runCode;
        window.checkCode = checkCode;
        window.showHint = showHint;
        window.resetCode = resetCode;
        window.nextTask = nextTask;
        window.toggleDyslexicFont = toggleDyslexicFont;
        window.toggleAudio = toggleAudio;
        window.toggleSyntaxCheck = toggleSyntaxCheck;
        window.toggleAudioInstructions = toggleAudioInstructions;
        window.stopAudio = stopAudio;
        window.downloadProgress = downloadProgress;
        window.resetSection = resetSection;
        window.runAssessmentCode = runAssessmentCode;
        window.checkAssessmentCode = checkAssessmentCode;
        window.checkTextAnswer = checkTextAnswer;
        window.checkMCAnswer = checkMCAnswer;
        window.submitAssessment = submitAssessment;
        window.toggleExtension = toggleExtension;
        window.showExtensionTopic = showExtensionTopic;
        window.runExtensionCode = runExtensionCode;
        window.checkExtensionComplete = checkExtensionComplete;
        window.startSimulation = startSimulation;
        window.closeGame = closeGame;
        window.handleConsoleInput = handleConsoleInput;
    </script>
</body>
</html>