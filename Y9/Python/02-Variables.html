<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Year 9 Python Course - Section 2: Variables</title>
    
    <!-- CodeMirror CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/solarized.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldgutter.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/lint/lint.min.css">
    
    <!-- Pyodide -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    
    <!-- CodeMirror JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/python-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldgutter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/brace-fold.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/indent-fold.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/lint/lint.min.js"></script>
    
    <!-- Font for dyslexia support -->
    <link href="https://fonts.googleapis.com/css2?family=OpenDyslexic:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            box-sizing: border-box;
        }
        
        :root {
            --primary-color: #059669;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --xp-color: #8b5cf6;
            --bg-primary: #f0f8f5;
            --bg-secondary: white;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            background-color: var(--bg-primary);
            transition: font-family 0.3s ease;
        }
        
        body.dyslexic-font {
            font-family: 'OpenDyslexic', sans-serif;
        }
        
        .header {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header-left h1 {
            margin: 0;
            font-size: 28px;
        }
        
        .header-left p {
            margin: 5px 0 0 0;
            opacity: 0.9;
        }
        
        .user-stats {
            display: flex;
            gap: 20px;
            align-items: center;
            background: rgba(255,255,255,0.1);
            padding: 10px 20px;
            border-radius: 8px;
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
        }
        
        .stat-label {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .xp-bar {
            width: 150px;
            height: 8px;
            background: rgba(255,255,255,0.3);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }
        
        .xp-fill {
            height: 100%;
            background: var(--xp-color);
            transition: width 0.5s ease;
        }
        
        .progress-section {
            max-width: 1400px;
            margin: 10px auto 0;
        }
        
        .progress-bar {
            background: rgba(255,255,255,0.3);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            background: #4ade80;
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 4px;
        }
        
        .badges-preview {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .badge {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            filter: grayscale(1);
            opacity: 0.5;
            transition: all 0.3s;
        }
        
        .badge.earned {
            filter: grayscale(0);
            opacity: 1;
            background: rgba(255,255,255,0.3);
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
        }
        
        .main-container {
            display: flex;
            max-width: 1400px;
            margin: 0 auto;
            gap: 20px;
            padding: 20px;
        }
        
        .sidebar {
            width: 280px;
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            height: fit-content;
            position: sticky;
            top: 20px;
        }
        
        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .task-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .task-item {
            padding: 12px;
            margin: 5px 0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            border: 1px solid #e5e7eb;
            position: relative;
        }
        
        .task-item:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
        }
        
        .task-item.active {
            background: #ecfdf5;
            border-color: var(--primary-color);
            color: #047857;
        }
        
        .task-item.completed {
            border-color: var(--success-color);
        }
        
        .task-status {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }
        
        .task-status.completed {
            background: var(--success-color);
            color: white;
        }
        
        .task-xp {
            position: absolute;
            right: 10px;
            font-size: 12px;
            color: var(--xp-color);
            font-weight: bold;
        }
        
        .task-name {
            flex: 1;
            font-size: 14px;
        }
        
        .daily-challenge {
            margin-top: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            border-radius: 8px;
            color: white;
        }
        
        .daily-challenge h3 {
            margin: 0 0 5px 0;
            font-size: 16px;
        }
        
        .daily-challenge p {
            margin: 0;
            font-size: 14px;
            opacity: 0.9;
        }
        
        .settings-panel {
            margin-top: 20px;
            padding: 15px;
            background: #f3f4f6;
            border-radius: 8px;
        }
        
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
        }
        
        .toggle-switch {
            position: relative;
            width: 48px;
            height: 24px;
            background: #d1d5db;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .toggle-switch.active {
            background: var(--primary-color);
        }
        
        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }
        
        .toggle-switch.active .toggle-slider {
            transform: translateX(24px);
        }
        
        .worksheet-container {
            flex: 1;
            background: var(--bg-secondary);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 30px;
            position: relative;
        }
        
        .task-header {
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 20px;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .task-header-left h2 {
            margin: 0 0 10px 0;
            color: var(--text-primary);
        }
        
        .task-badges {
            display: flex;
            gap: 10px;
        }
        
        .task-type {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            background: #dcfce7;
            color: #15803d;
        }
        
        .task-type.practice {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .task-type.challenge {
            background: #fef3c7;
            color: #92400e;
        }
        
        .task-type.assessment {
            background: #e0e7ff;
            color: #3730a3;
        }
        
        .instructions {
            background: #f9fafb;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid #e5e7eb;
            position: relative;
        }
        
        .instructions h3 {
            margin-top: 0;
            color: var(--text-primary);
            font-size: 18px;
        }
        
        .instructions code {
            background: #e5e7eb;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        
        .instructions pre {
            background: #1f2937;
            color: #f3f4f6;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .audio-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }
        
        .audio-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .audio-btn:hover {
            background: #047857;
        }
        
        .audio-btn.playing {
            background: var(--error-color);
        }
        
        .code-section {
            margin: 20px 0;
        }
        
        .editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #1f2937;
            color: white;
            padding: 10px 15px;
            border-radius: 6px 6px 0 0;
        }
        
        .editor-title {
            font-weight: 600;
            font-size: 14px;
        }
        
        .editor-container {
            border: 1px solid #e5e7eb;
            border-top: none;
            border-radius: 0 0 6px 6px;
            overflow: hidden;
            position: relative;
        }
        
        .CodeMirror {
            height: 300px;
            font-size: 14px;
            width: 100% !important;
        }
        
        .CodeMirror-scroll {
            overflow-y: auto !important;
            overflow-x: auto !important;
        }
        
        .CodeMirror-sizer {
            min-width: 100% !important;
        }
        
        .CodeMirror-lint-tooltip {
            background: #1f2937;
            color: #f3f4f6;
            border: 1px solid #374151;
            border-radius: 4px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 13px;
            padding: 5px 8px;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        button:hover {
            background: #047857;
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }
        
        .run-btn {
            background: var(--success-color);
        }
        
        .run-btn:hover {
            background: #059669;
        }
        
        .check-btn {
            background: var(--xp-color);
        }
        
        .check-btn:hover {
            background: #7c3aed;
        }
        
        .hint-btn {
            background: var(--warning-color);
        }
        
        .hint-btn:hover {
            background: #d97706;
        }
        
        .reset-btn {
            background: #6b7280;
        }
        
        .reset-btn:hover {
            background: #4b5563;
        }
        
        .ai-help-btn {
            background: #06b6d4;
        }
        
        .ai-help-btn:hover {
            background: #0891b2;
        }
        
        .output-section {
            margin-top: 25px;
        }
        
        .output-panel {
            background: #1f2937;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        
        .output-header {
            background: #111827;
            color: white;
            padding: 10px 15px;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .output-content {
            color: #f3f4f6;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            min-height: 100px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            line-height: 1.5;
        }
        
        .test-result {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .test-pass {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
        }
        
        .test-fail {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }
        
        .xp-gained {
            font-weight: bold;
            color: var(--xp-color);
            font-size: 16px;
            animation: bounce 0.5s;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .loading {
            color: #60a5fa;
            font-style: italic;
        }
        
        .error {
            color: #f87171;
        }
        
        .success {
            color: #4ade80;
        }
        
        .hint-box {
            background: #fef3c7;
            border: 1px solid #fcd34d;
            padding: 15px;
            border-radius: 6px;
            margin-top: 10px;
            display: none;
        }
        
        .hint-box strong {
            color: #92400e;
        }
        
        .ai-help-box {
            background: #e0f2fe;
            border: 1px solid #7dd3fc;
            padding: 15px;
            border-radius: 6px;
            margin-top: 10px;
            display: none;
        }
        
        .ai-help-box strong {
            color: #075985;
        }
        
        .execution-info {
            color: #9ca3af;
            font-size: 12px;
            margin-top: 5px;
        }
        
        .next-task-section {
            margin-top: 30px;
            padding: 20px;
            background: #f3f4f6;
            border-radius: 6px;
            text-align: center;
            display: none;
        }
        
        .next-btn {
            background: var(--primary-color);
            font-size: 16px;
            padding: 12px 24px;
            margin-top: 10px;
        }
        
        .next-btn:hover {
            background: #047857;
        }
        
        .achievement-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            text-align: center;
            z-index: 1000;
            display: none;
        }
        
        .achievement-popup.show {
            display: block;
            animation: popIn 0.5s ease-out;
        }
        
        @keyframes popIn {
            0% {
                transform: translate(-50%, -50%) scale(0.8);
                opacity: 0;
            }
            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }
        
        .achievement-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
        
        .achievement-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--text-primary);
        }
        
        .achievement-desc {
            color: var(--text-secondary);
            margin-bottom: 20px;
        }
        
        .achievement-xp {
            font-size: 20px;
            font-weight: bold;
            color: var(--xp-color);
        }
        
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }
        
        .overlay.show {
            display: block;
        }
        
        /* Assessment Styles */
        .assessment-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .assessment-question {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .assessment-question h4 {
            margin-top: 0;
            color: var(--text-primary);
        }

        .mc-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 15px 0;
        }

        .mc-option {
            display: flex;
            align-items: center;
            padding: 10px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .mc-option:hover {
            background: #f3f4f6;
            border-color: var(--primary-color);
        }

        .mc-option input {
            margin-right: 10px;
        }

        .text-answer {
            width: 100%;
            padding: 10px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
        }

        .feedback-box {
            margin-top: 10px;
            padding: 10px;
            border-radius: 6px;
            display: none;
        }

        .feedback-box.success {
            display: block;
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
        }

        .feedback-box.error {
            display: block;
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .feedback-box.warning {
            display: block;
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fcd34d;
        }

        .assessment-progress {
            margin-top: 40px;
            padding: 20px;
            background: #ecfdf5;
            border-radius: 8px;
            text-align: center;
        }

        .progress-items {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .progress-item {
            padding: 10px 15px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
            margin: 5px;
            font-size: 12px;
        }

        .progress-item.completed {
            background: var(--success-color);
            color: white;
            border-color: var(--success-color);
        }

        .submit-btn {
            background: var(--xp-color);
            font-size: 16px;
            padding: 12px 30px;
        }

        .submit-btn:disabled {
            background: #9ca3af;
        }
        
        /* Notification styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1001;
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.warning {
            border-left: 4px solid var(--warning-color);
        }
        
        .notification.success {
            border-left: 4px solid var(--success-color);
        }
        
        .notification.error {
            border-left: 4px solid var(--error-color);
        }
        
        .notification-icon {
            font-size: 20px;
        }
        
        .notification-content h4 {
            margin: 0 0 5px 0;
            font-size: 14px;
            color: var(--text-primary);
        }
        
        .notification-content p {
            margin: 0;
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        /* Disable text selection in code areas */
        .CodeMirror {
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
            user-select: text !important;
        }
        
        .no-copy {
            cursor: not-allowed !important;
        }
        
        /* Extension Section Styles */
        .extension-toggle {
            margin-top: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            border-radius: 8px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
        }

        .extension-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }

        .extension-icon {
            font-size: 20px;
        }

        .extension-text {
            flex: 1;
            font-weight: 600;
        }

        .extension-arrow {
            font-size: 14px;
            transition: transform 0.3s;
        }

        .extension-section {
            margin-top: 10px;
            background: #f3f4f6;
            border-radius: 8px;
            padding: 10px;
        }

        .extension-item {
            position: relative;
            padding: 12px;
            margin: 5px 0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
            border: 1px solid #e5e7eb;
        }

        .extension-item:hover {
            background: #f9fafb;
            border-color: var(--primary-color);
        }

        .extension-item.active {
            background: #ecfdf5;
            border-color: var(--primary-color);
            color: #047857;
        }

        .extension-item.completed {
            border-color: var(--success-color);
        }

        .extension-status {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }

        .extension-status.completed {
            background: var(--success-color);
            color: white;
        }

        .topic-icon {
            font-size: 18px;
        }

        .extension-name {
            flex: 1;
            font-size: 14px;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .extension-xp {
            font-size: 12px;
            color: var(--xp-color);
            font-weight: bold;
            flex-shrink: 0;
            margin-left: auto;
        }

        .extension-feedback {
            margin-top: 15px;
        }

        .extension-code {
            width: 100%;
            min-height: 150px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        /* Game Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 12px;
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }

        .close:hover {
            color: #000;
        }

        .game-timer {
            font-size: 20px;
            font-weight: bold;
            color: var(--error-color);
            margin: 10px 0;
        }

        .game-score {
            font-size: 18px;
            color: var(--success-color);
            margin-bottom: 20px;
        }

        .game-challenge {
            background: #f3f4f6;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin: 15px 0;
        }

        .game-challenge pre {
            background: #1f2937;
            color: #f3f4f6;
            padding: 15px;
            border-radius: 6px;
            font-size: 16px;
            margin: 15px 0;
        }

        .game-challenge input {
            width: 100%;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            margin-bottom: 10px;
        }

        .game-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .game-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .game-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }

        .game-card.selected {
            border-color: var(--success-color);
            background: #ecfdf5;
        }

        .game-card.matched {
            border-color: var(--success-color);
            background: #d1fae5;
            opacity: 0.7;
        }

        .speed-input {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            align-items: center;
        }

        .speed-input input {
            flex: 1;
            padding: 8px;
            border: 2px solid #e5e7eb;
            border-radius: 4px;
        }

        .simulation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .simulation-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .simulation-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .play-btn {
            margin-top: 10px;
            background: var(--success-color);
        }

        .simulations-section {
            margin-top: 40px;
            padding: 20px;
            background: #f3f4f6;
            border-radius: 8px;
        }

                @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                position: static;
            }
            
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .user-stats {
                width: 100%;
                justify-content: space-around;
            }
            
            .progress-items {
                justify-content: center;
            }
            
            .game-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
            
            .simulation-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body oncopy="return false" oncut="return false" onpaste="return false">
    <div class="header">
        <div class="header-content">
            <div class="header-left">
                <h1>Year 9 Python Programming</h1>
                <p>Section 2 - Variables</p>
            </div>
            <div class="user-stats">
                <div class="stat-item">
                    <div class="stat-value" id="userLevel">1</div>
                    <div class="stat-label">Level</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="userXP">0</div>
                    <div class="stat-label">XP</div>
                    <div class="xp-bar">
                        <div class="xp-fill" id="xpFill" style="width: 0%"></div>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="userStreak">0</div>
                    <div class="stat-label">Day Streak</div>
                </div>
            </div>
        </div>
        <div class="progress-section">
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar"></div>
            </div>
            <p style="margin: 5px 0 0 0; font-size: 14px; color: white;">Progress: <span id="progressText">0/10 tasks completed</span></p>
            <div class="badges-preview">
                <div class="badge" id="badge-variable-master" title="Variable Master">üì¶</div>
                <div class="badge" id="badge-name-ninja" title="Naming Ninja">ü•∑</div>
                <div class="badge" id="badge-combination-expert" title="Combination Expert">üîó</div>
                <div class="badge" id="badge-challenge-champion" title="Challenge Champion">üèÜ</div>
                <div class="badge" id="badge-perfect-variables" title="Perfect Variables">‚≠ê</div>
            </div>
        </div>
    </div>

    <div class="main-container">
        <aside class="sidebar">
            <div class="section-title">Section 2 - Variables</div>
            <ul class="task-list" id="taskList">
                <li class="task-item active" onclick="switchTask(1)">
                    <span class="task-status" id="status1"></span>
                    <span class="task-name">02.01 Variables</span>
                    <span class="task-xp">+75 XP</span>
                </li>
                <li class="task-item" onclick="switchTask(2)">
                    <span class="task-status" id="status2"></span>
                    <span class="task-name">02.02 Think of Variables</span>
                    <span class="task-xp">+75 XP</span>
                </li>
                <li class="task-item" onclick="switchTask(3)">
                    <span class="task-status" id="status3"></span>
                    <span class="task-name">02.03 Why Use Variables?</span>
                    <span class="task-xp">+100 XP</span>
                </li>
                <li class="task-item" onclick="switchTask(4)">
                    <span class="task-status" id="status4"></span>
                    <span class="task-name">02.04 Naming Variables</span>
                    <span class="task-xp">+100 XP</span>
                </li>
                <li class="task-item" onclick="switchTask(5)">
                    <span class="task-status" id="status5"></span>
                    <span class="task-name">02.05 Combining Values</span>
                    <span class="task-xp">+100 XP</span>
                </li>
                <li class="task-item" onclick="switchTask(6)">
                    <span class="task-status" id="status6"></span>
                    <span class="task-name">02.06 Changing Values</span>
                    <span class="task-xp">+100 XP</span>
                </li>
                <li class="task-item" onclick="switchTask(7)">
                    <span class="task-status" id="status7"></span>
                    <span class="task-name">02.07 Print the Phrase</span>
                    <span class="task-xp">+125 XP</span>
                </li>
                <li class="task-item" onclick="switchTask(8)">
                    <span class="task-status" id="status8"></span>
                    <span class="task-name">02.08 Mad Libs</span>
                    <span class="task-xp">+125 XP</span>
                </li>
                <li class="task-item" onclick="switchTask(9)">
                    <span class="task-status" id="status9"></span>
                    <span class="task-name">02.09 Challenge</span>
                    <span class="task-xp">+150 XP</span>
                </li>
                <li class="task-item" onclick="switchTask(10)">
                    <span class="task-status" id="status10"></span>
                    <span class="task-name">Section Assessment</span>
                    <span class="task-xp">+200 XP</span>
                </li>
            </ul>
            
            <div class="extension-toggle" onclick="toggleExtension()">
                <span class="extension-icon">üöÄ</span>
                <span class="extension-text">Extension Activities</span>
                <span class="extension-arrow" id="extensionArrow">‚ñ∂</span>
            </div>
            <div class="extension-section" id="extensionSection" style="display: none;">
                <div class="extension-item" onclick="showExtensionTopic('variable-types')">
                    <span class="extension-status" id="ext-status-variable-types"></span>
                    <span class="topic-icon">üî¢</span>
                    <span class="extension-name">Variable Types</span>
                    <span class="extension-xp">+30 XP</span>
                </div>
                <div class="extension-item" onclick="showExtensionTopic('input-variables')">
                    <span class="extension-status" id="ext-status-input-variables"></span>
                    <span class="topic-icon">‚å®Ô∏è</span>
                    <span class="extension-name">User Input Variables</span>
                    <span class="extension-xp">+35 XP</span>
                </div>
                <div class="extension-item" onclick="showExtensionTopic('f-strings')">
                    <span class="extension-status" id="ext-status-f-strings"></span>
                    <span class="topic-icon">üìù</span>
                    <span class="extension-name">F-String Formatting</span>
                    <span class="extension-xp">+40 XP</span>
                </div>
                <div class="extension-item" onclick="showExtensionTopic('global-local')">
                    <span class="extension-status" id="ext-status-global-local"></span>
                    <span class="topic-icon">üåç</span>
                    <span class="extension-name">Global vs Local</span>
                    <span class="extension-xp">+45 XP</span>
                </div>
                <div class="extension-item" onclick="showExtensionTopic('variable-swapping')">
                    <span class="extension-status" id="ext-status-variable-swapping"></span>
                    <span class="topic-icon">üîÑ</span>
                    <span class="extension-name">Variable Swapping</span>
                    <span class="extension-xp">+50 XP</span>
                </div>
            </div>
            
            <ul class="task-list" style="margin-top: 0;">&nbsp;
            
            <div class="daily-challenge">
                <h3>üåü Challenge</h3>
                <p>Master variables by completing all tasks without hints for bonus 250 XP!</p>
            </div>
            
            <div class="settings-panel">
                <div class="section-title">Settings</div>
                <div class="setting-item">
                    <span>Dyslexic Font</span>
                    <div class="toggle-switch" onclick="toggleDyslexicFont()" id="dyslexicToggle">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
                <div class="setting-item">
                    <span>Audio Instructions</span>
                    <div class="toggle-switch" onclick="toggleAudio()" id="audioToggle">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
                <div class="setting-item">
                    <span>Live Syntax Check</span>
                    <div class="toggle-switch active" onclick="toggleSyntaxCheck()" id="syntaxToggle">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 20px;">
                <button onclick="downloadProgress()" style="width: 100%; margin: 5px 0;">
                    üì• Save Progress
                </button>
                <button onclick="resetSection()" style="width: 100%; margin: 5px 0; background: #ef4444;">
                    üîÑ Reset Section
                </button>
            </div>
        </aside>

        <div class="worksheet-container">
            <div id="taskContent">
                <!-- Task content will be dynamically loaded here -->
            </div>
        </div>
    </div>
    
    <div class="overlay" id="overlay"></div>
    <div class="achievement-popup" id="achievementPopup">
        <div class="achievement-icon" id="achievementIcon">üèÜ</div>
        <div class="achievement-title" id="achievementTitle">Achievement Unlocked!</div>
        <div class="achievement-desc" id="achievementDesc">You've earned a new badge!</div>
        <div class="achievement-xp" id="achievementXP">+50 XP</div>
    </div>

    <script>
        // Global variables
        let pyodide = null;
        let editors = {};
        let currentTask = 1;
        let taskProgress = {};
        let currentTheme = 'monokai';
        let userProfile = {
            level: 1,
            xp: 0,
            xpToNextLevel: 500,
            streak: 0,
            badges: [],
            hintsUsed: {},
            attemptsBeforeSuccess: {},
            totalTime: 0,
            lastLogin: new Date().toDateString()
        };
        let taskStartTime = {};
        let codeHistory = {};
        let hintLevel = {};
        let settings = {
            dyslexicFont: false,
            audioEnabled: false,
            syntaxCheckEnabled: true
        };
        // Assessment-specific variables
let assessmentProgress = {
    q1: false,
    q2: false,
    q3: false,
    q4: false,
    q5: false,
    q6: false
};
        
        // XP values for different actions
        const XP_VALUES = {
            taskComplete: { 1: 75, 2: 75, 3: 100, 4: 100, 5: 100, 6: 100, 7: 125, 8: 125, 9: 150, 10: 200 },
            noHints: 25,
            firstTry: 50,
            dailyChallenge: 250,
            perfectWeek: 500
        };
        
        // Badge definitions
        const BADGES = {
            'variable-master': { icon: 'üì¶', name: 'Variable Master', desc: 'Created your first variables' },
            'name-ninja': { icon: 'ü•∑', name: 'Naming Ninja', desc: 'Fixed all variable naming errors' },
            'combination-expert': { icon: 'üîó', name: 'Combination Expert', desc: 'Mastered string combination' },
            'challenge-champion': { icon: 'üèÜ', name: 'Challenge Champion', desc: 'Completed the challenge task' },
            'perfect-variables': { icon: '‚≠ê', name: 'Perfect Variables', desc: 'Completed all tasks without hints' }
        };

        // Task definitions based on curriculum
        const tasks = {
            1: {
                id: "bb362a92-5c6e-4b35-a24d-837fa536dfc2",
                title: "02.01 Variables",
                type: "example",
                xp: 75,
                instructions: `
                    <h3>Variables</h3>
                    <p>A <strong>variable</strong> stores information in a computer's memory.</p>
                    <p>This information can be accessed anywhere in the program.</p>
                    <p>In this program, the variable <code>a</code> stores the text <code>"Welcome to Python"</code>.</p>
                    
                    <h3>Practice with variables</h3>
                    <p>Create the following three variables then print out the information they store:</p>
                    <ul>
                        <li><code>name</code>: stores your full name</li>
                        <li><code>food</code>: stores your favourite food</li>
                        <li><code>hobby</code>: stores your favourite hobby</li>
                    </ul>
                    
                    <h3>Example</h3>
                    <pre>variable_name = "value"
print(variable_name)</pre>
                `,
                starterCode: `a = "Welcome to Python"
print(a)`,
                hints: [
                    "Create a variable by typing: variable_name = \"value\"",
                    "Remember to print each variable: print(variable_name)",
                    "You need to create 3 variables: name, food, and hobby"
                ],
                smartHints: {
                    'missing_name': "You need to create a variable called 'name'",
                    'missing_food': "Don't forget to create the 'food' variable",
                    'missing_hobby': "You still need to create the 'hobby' variable",
                    'missing_prints': "Remember to print each variable after creating it"
                },
                checks: [
                    {
                        name: "Example variable works",
                        test: (code, output) => output.includes("Welcome to Python")
                    },
                    {
                        name: "Created name variable",
                        test: (code, output) => code.includes('name =') && code.includes('print(name)')
                    },
                    {
                        name: "Created food variable", 
                        test: (code, output) => code.includes('food =') && code.includes('print(food)')
                    },
                    {
                        name: "Created hobby variable",
                        test: (code, output) => code.includes('hobby =') && code.includes('print(hobby)')
                    }
                ]
            },
            2: {
                id: "6271365f-875f-4137-947c-7323f0acec78",
                title: "02.02 Another way to think of variables",
                type: "practice",
                xp: 75,
                instructions: `
                    <h3>Variables as Containers</h3>
                    <p>A variable is like a container for information.</p>
                    <p>The value on the right side of the equal sign gets stored into the named container on the left side of the equal sign.</p>
                    <p>When you use the variable's name, it is replaced by the value stored in it.</p>
                    
                    <h3>Task</h3>
                    <p>Change the car manufacturer name and run the program</p>
                `,
                starterCode: `car = "Toyota"
print(car)`,
                hints: [
                    "Change 'Toyota' to a different car manufacturer like 'Ford', 'BMW', or 'Honda'",
                    "Make sure to keep the quotation marks around the new name",
                    "The variable name 'car' stays the same, only change the value"
                ],
                smartHints: {
                    'still_toyota': "You need to change 'Toyota' to a different car manufacturer",
                    'missing_quotes': "Make sure your new car name is in quotation marks",
                    'syntax_error': "Check your syntax - make sure you have quotes and no typos"
                },
                checks: [
                    {
                        name: "Changed the car value",
                        test: (code, output) => !output.includes("Toyota") && code.includes('car =')
                    },
                    {
                        name: "Program runs successfully",
                        test: (code, output) => output.length > 0 && !output.includes("Error")
                    }
                ]
            },
            3: {
                id: "e3951567-1b2e-4bed-80cd-ec18e401ff36",
                title: "02.03 Why use variables?",
                type: "practice", 
                xp: 100,
                instructions: `
                    <h3>Why use variables?</h3>
                    <p>Variables allow you to access the same value in multiple instructions, making it easier to change the information your program uses.</p>
                    
                    <h3>Task</h3>
                    <p>Alter the value of the variables <code>first</code>, <code>chorus</code>, and <code>second</code> to change the song.</p>
                `,
                starterCode: `first = "Python's the way"
chorus = "uh huh uh huh"
second = "I like it"

print(first)
print(chorus)
print(second)
print(chorus)

print(first)
print(chorus)
print(second)
print(chorus)

print(first)
print(chorus)
print(second)
print(chorus)`,
                hints: [
                    "Change the text inside the quotes for 'first', 'chorus', and 'second'",
                    "Notice how changing the variable once changes it everywhere it's used",
                    "Try making your own song lyrics!"
                ],
                smartHints: {
                    'unchanged_first': "Try changing the 'first' variable to your own lyrics",
                    'unchanged_chorus': "Change the 'chorus' variable to make your own song",
                    'unchanged_second': "Don't forget to change the 'second' variable too"
                },
                checks: [
                    {
                        name: "Changed first variable",
                        test: (code, output) => !output.includes("Python's the way")
                    },
                    {
                        name: "Changed chorus variable",
                        test: (code, output) => !output.includes("uh huh uh huh")
                    },
                    {
                        name: "Changed second variable",
                        test: (code, output) => !output.includes("I like it")
                    },
                    {
                        name: "All variables used multiple times",
                        test: (code, output) => {
                            const lines = output.split('\n').filter(line => line.length > 0);
                            return lines.length >= 12;
                        }
                    }
                ]
            },
            4: {
                id: "ab209726-195d-403a-8257-47316f059f89",
                title: "02.04 Naming variables",
                type: "practice",
                xp: 100,
                instructions: `
                    <h3>Variable Naming Rules</h3>
                    <p>Variable names cannot have spaces, start with a number, or contain punctuation other than the underscore (_).</p>
                    
                    <h4>Valid variable names:</h4>
                    <pre>variable = "..."
camelCase = "..."
with_underscores = "..."
number1 = "..."</pre>
                    
                    <p>There are also certain names that are reserved by Python, like print. In general, if a name is colored in blue, it is a keyword and should not be used as a variable name.</p>
                    
                    <h3>Task - Fix the variable names</h3>
                    <p>Can you fix the variable names in the code?</p>
                `,
                starterCode: `first line = "Oh, when the saints go marching in"
2nd_line = "Oh, how I want to be in that number"
line3 = "When the saints go marching in."

print(first line)
print(first_line)
print(2nd_line)
print(Line3)`,
                hints: [
                    "Variable names cannot have spaces - use underscores instead",
                    "Variable names cannot start with numbers - put letters first",
                    "Check that variable names match exactly when printing (case-sensitive)",
                    "Change 'first line' to 'first_line', '2nd_line' to 'second_line', etc."
                ],
                smartHints: {
                    'space_in_name': "Variable names cannot have spaces - use underscores instead",
                    'number_start': "Variable names cannot start with numbers",
                    'case_mismatch': "Variable names are case-sensitive - check your spelling",
                    'undefined_variable': "Make sure your variable names match when you print them"
                },
                checks: [
                    {
                        name: "Fixed space in variable name",
                        test: (code, output) => code.includes('first_line =') && !code.includes('first line =')
                    },
                    {
                        name: "Fixed number at start",
                        test: (code, output) => code.includes('second_line =') && !code.includes('2nd_line =')
                    },
                    {
                        name: "Fixed case mismatch",
                        test: (code, output) => code.includes('print(line3)') && !code.includes('print(Line3)')
                    },
                    {
                        name: "All lines print correctly",
                        test: (code, output) => {
                            return output.includes("Oh, when the saints") && 
                                   output.includes("Oh, how I want") && 
                                   output.includes("When the saints go marching in.");
                        }
                    }
                ]
            },
            5: {
                id: "7b3516a3-da06-45ac-b15a-8bee75af0b81",
                title: "02.05 Combining values",
                type: "practice",
                xp: 100,
                instructions: `
                    <h3>Combining values</h3>
                    <p>You can combine two values with the <code>+</code> operator.</p>
                    
                    <h3>Task</h3>
                    <p>Notice that the output does not include spaces. Can you fix this?</p>
                    
                    <h4>Hint:</h4>
                    <p>To add spaces, you can:</p>
                    <ul>
                        <li>Add a space inside one of the strings: <code>"hello "</code></li>
                        <li>Add a separate space: <code>a + " " + b</code></li>
                    </ul>
                `,
                starterCode: `a = "hello"
b = "world"

print(a + b)
print(a + "there!")`,
                hints: [
                    "The output shows 'helloworld' - you need to add a space between them",
                    "Try changing 'hello' to 'hello ' (with a space after)",
                    "Or use: print(a + ' ' + b) to add a space in the middle",
                    "Fix both print statements to include proper spacing"
                ],
                smartHints: {
                    'no_spaces': "The output is missing spaces between words",
                    'first_line_fixed': "Good! Now fix the second line too",
                    'almost_done': "You're close! Make sure both lines have proper spacing"
                },
                checks: [
                    {
                        name: "Added space in first output",
                        test: (code, output) => {
                            const lines = output.split('\n');
                            return lines[0] && (lines[0].includes('hello world') || lines[0].includes('hello  world'));
                        }
                    },
                    {
                        name: "Added space in second output", 
                        test: (code, output) => {
                            const lines = output.split('\n');
                            return lines[1] && (lines[1].includes('hello there') || lines[1].includes('hello  there'));
                        }
                    },
                    {
                        name: "Used string concatenation",
                        test: (code, output) => code.includes('+') && (code.includes('" "') || code.includes("' '") || code.includes('hello ') || code.includes('hello  '))
                    }
                ]
            },
            6: {
                id: "5c3c9e02-8b31-4c52-9ff2-ef9ec87a334e",
                title: "02.06 Changing a variable's value",
                type: "practice",
                xp: 100,
                instructions: `
                    <h3>Changing a variable's value</h3>
                    <p>The information stored in a variable can be changed anywhere in your code.</p>
                    <p>When a new value is written into a variable, the old value is replaced and cannot be recovered.</p>
                    
                    <h3>Task</h3>
                    <p>Change the values in the variables <code>name</code> and <code>action</code> on line 1 and 2 to alter the output.</p>
                    <p>Notice that the name variable is overwritten on line 7</p>
                `,
                starterCode: `name = "George"
action = "code"

print(name + " likes to " + action)

# Change the name
name = "Janet"
print(name + " likes to " + action)`,
                hints: [
                    "Change 'George' to a different name of your choice",
                    "Change 'code' to a different activity like 'sing', 'dance', 'read', etc.",
                    "Notice how the second print uses the new name 'Janet'"
                ],
                smartHints: {
                    'unchanged_name': "Try changing 'George' to a different name",
                    'unchanged_action': "Change 'code' to a different activity",
                    'good_changes': "Great! You can see how variables can be changed"
                },
                checks: [
                    {
                        name: "Changed initial name",
                        test: (code, output) => !code.includes('name = "George"')
                    },
                    {
                        name: "Changed action",
                        test: (code, output) => !code.includes('action = "code"')
                    },
                    {
                        name: "Both outputs show correctly",
                        test: (code, output) => {
                            const lines = output.split('\n').filter(line => line.length > 0);
                            return lines.length >= 2 && lines[0].includes('likes to') && lines[1].includes('likes to');
                        }
                    },
                    {
                        name: "Second output shows Janet",
                        test: (code, output) => {
                            const lines = output.split('\n').filter(line => line.length > 0);
                            return lines.length >= 2 && lines[1].includes('Janet');
                        }
                    }
                ]
            },
            7: {
                id: "26dd370f-b64b-41d9-870c-275d5c0f8e7a",
                title: "02.07 Print the phrase",
                type: "practice",
                xp: 125,
                instructions: `
                    <h3>Task</h3>
                    <p>Combine the variables to print the following phrase:</p>
                    <p><strong>"The <code>subject</code> goes to the <code>place</code> to <code>activity</code>."</strong></p>
                    <p>Don't forget spaces between words and the period at the end of the sentence!</p>
                    
                    <h3>Reminder</h3>
                    <pre>a = "Hello"
b = " there"
print(a + b)</pre>
                `,
                starterCode: `subject = "surfer"
place = "beach"  
activity = "surf"

`,
                hints: [
                    "You need to create a print statement that combines all variables",
                    "Use: print('The ' + subject + ' goes to the ' + place + ' to ' + activity + '.')",
                    "Don't forget the spaces and the period at the end",
                    "The output should be: 'The surfer goes to the beach to surf.'"
                ],
                smartHints: {
                    'no_print': "You need to add a print statement to combine the variables",
                    'missing_variables': "Make sure you use all three variables: subject, place, and activity",
                    'missing_spaces': "Don't forget spaces between words",
                    'missing_period': "Remember to add a period at the end"
                },
                checks: [
                    {
                        name: "Used all three variables",
                        test: (code, output) => code.includes('subject') && code.includes('place') && code.includes('activity') && code.includes('print(')
                    },
                    {
                        name: "Correct sentence structure",
                        test: (code, output) => output.includes("goes to the") && output.includes("to ")
                    },
                    {
                        name: "Includes period at end",
                        test: (code, output) => output.includes(".")
                    },
                    {
                        name: "Complete sentence",
                        test: (code, output) => output.includes("The surfer goes to the beach to surf.")
                    }
                ]
            },
            8: {
                id: "c28b7cfe-9028-46bb-af4a-e193e7a56536",
                title: "02.08 Mad libs",
                type: "practice",
                xp: 125,
                instructions: `
                    <h3>Mad Libs</h3>
                    <p>You can use variables to create stories that change based on the user's preference, like Mad Libs.</p>
                    <p>To the left is an example of a Mad Libs story.</p>
                    
                    <h3>Task</h3>
                    <p>Add your own values to each of the variables to complete the story.</p>
                `,
                starterCode: `place = ""
person = ""
animal = ""
adjective = ""

print(person + " went to the " + place + " to see the " + adjective + " " + animal + ".")
print("At the " + place + ", " + person + " had a great time.")`,
                hints: [
                    "Fill in each variable with interesting values",
                    "place could be 'zoo', 'park', 'circus', etc.",
                    "person could be a name like 'Sarah', 'Mike', etc.",
                    "animal could be 'elephant', 'monkey', 'tiger', etc.",
                    "adjective could be 'funny', 'huge', 'colorful', etc."
                ],
                smartHints: {
                    'empty_variables': "You need to fill in all the empty variables",
                    'missing_place': "Don't forget to add a value for the 'place' variable",
                    'missing_person': "Add a name for the 'person' variable",
                    'missing_animal': "What animal should they see?",
                    'missing_adjective': "Add a describing word for the 'adjective' variable"
                },
                checks: [
                    {
                        name: "Added place value",
                        test: (code, output) => !code.includes('place = ""') && code.includes('place =')
                    },
                    {
                        name: "Added person value",
                        test: (code, output) => !code.includes('person = ""') && code.includes('person =')
                    },
                    {
                        name: "Added animal value",
                        test: (code, output) => !code.includes('animal = ""') && code.includes('animal =')
                    },
                    {
                        name: "Added adjective value",
                        test: (code, output) => !code.includes('adjective = ""') && code.includes('adjective =')
                    },
                    {
                        name: "Story makes sense",
                        test: (code, output) => {
                            const lines = output.split('\n').filter(line => line.length > 0);
                            return lines.length >= 2 && lines[0].includes('went to the') && lines[1].includes('had a great time');
                        }
                    }
                ]
            },
            9: {
                id: "62ad4036-af53-4225-bfcf-7bc01285a56e",
                title: "02.09 Challenge - Variables",
                type: "challenge",
                xp: 150,
                instructions: `
                    <h3>Challenge</h3>
                    <p>Write a program that:</p>
                    <ul>
                        <li>Stores the names of 3 of your friends</li>
                        <li>Prints out the sentence "My best friends are <strong>friend1</strong>, <strong>friend2</strong> and <strong>friend3</strong>"</li>
                        <li>You've decided that friend3 is not your friend anymore. Change the name in the friend3 variable and then print out the same sentence again</li>
                    </ul>
                    
                    <h3>Requirements:</h3>
                    <ul>
                        <li>Use exactly 3 variables: friend1, friend2, friend3</li>
                        <li>Print the sentence twice (before and after changing friend3)</li>
                        <li>Use proper punctuation and spacing</li>
                    </ul>
                `,
                starterCode: ``,
                hints: [
                    "Start by creating three variables: friend1, friend2, friend3",
                    "Use string concatenation to build the sentence with commas and 'and'",
                    "Print the sentence, then change friend3, then print again",
                    "Example: print('My best friends are ' + friend1 + ', ' + friend2 + ' and ' + friend3)"
                ],
                smartHints: {
                    'no_variables': "Start by creating three friend variables",
                    'missing_print': "You need to print the sentence using the variables",
                    'no_change': "Don't forget to change friend3 and print the sentence again",
                    'wrong_format': "Make sure your sentence format matches the example"
                },
                checks: [
                    {
                        name: "Created three friend variables",
                        test: (code, output) => code.includes('friend1 =') && code.includes('friend2 =') && code.includes('friend3 =')
                    },
                    {
                        name: "Printed sentence correctly first time",
                        test: (code, output) => output.includes("My best friends are") && output.includes(" and ")
                    },
                    {
                        name: "Changed friend3 variable",
                        test: (code, output) => {
                            const friend3Lines = code.split('\n').filter(line => line.includes('friend3 ='));
                            return friend3Lines.length >= 2;
                        }
                    },
                    {
                        name: "Printed sentence second time",
                        test: (code, output) => {
                            const lines = output.split('\n').filter(line => line.includes('My best friends are'));
                            return lines.length >= 2;
                        }
                    },
                    {
                        name: "Both sentences show different friend3",
                        test: (code, output) => {
                            const lines = output.split('\n').filter(line => line.includes('My best friends are'));
                            return lines.length >= 2 && lines[0] !== lines[1];
                        }
                    }
                ]
            },
            10: {
                id: "assessment-section-2",
                title: "Section 2 Assessment",
                type: "assessment",
                xp: 200,
                instructions: `
                    <h3>üéØ Section 2 Assessment</h3>
                    <p>Excellent work completing all the variable tasks! Now let's test your understanding with some questions and challenges.</p>
                    <p>This assessment covers:</p>
                    <ul>
                        <li>What variables are and why we use them</li>
                        <li>Variable naming rules</li>
                        <li>String concatenation</li>
                        <li>Changing variable values</li>
                        <li>Practical coding challenges</li>
                    </ul>
                `,
                starterCode: ``,
                assessmentQuestions: [
                    {
                        id: "q1",
                        type: "text-input",
                        question: "Define what a variable is in terms of a computer program",
                        hint: "Think about what variables store and how they work in memory...",
                        keywords: ["store", "memory", "information", "data", "value", "container", "hold"]
                    },
                    {
                        id: "q2",
                        type: "text-input",
                        question: "Give 2 examples of variables you might need in a game of 'Minecraft'",
                        hint: "Think about things that change in the game like health, score, position...",
                        keywords: ["health", "score", "position", "inventory", "level", "blocks", "coordinates", "hunger", "experience"]
                    },
                    {
                        id: "q3",
                        type: "multiple-choice",
                        question: "Which of these is NOT a rule for naming variables in Python?",
                        options: [
                            "Cannot start with a number",
                            "Cannot contain spaces",
                            "Must be written in capital letters",
                            "Cannot use Python keywords like 'print'"
                        ],
                        correct: 2,
                        explanation: "Variables can be in lowercase, uppercase, or mixed case - they don't have to be capitals."
                    },
                    {
                        id: "q4",
                        type: "code",
                        question: "Complete the code to multiply num1 and num2 together and print the answer",
                        starterCode: `num1 = 4
num2 = 3
# Add your code here`,
                        check: (code) => {
                            return code.includes('num1 * num2') && code.includes('print(');
                        }
                    },
                    {
                        id: "q5",
                        type: "code",
                        question: "Write code to print the full name 'Steve Smith' with a space in between using the given variables",
                        starterCode: `first_name = "Steve"
last_name = "Smith"
# Add your code here`,
                        check: (code) => {
                            return code.includes('first_name') && code.includes('last_name') && 
                                   code.includes('+') && code.includes('print(');
                        }
                    },
                    {
                        id: "q6",
                        type: "code", 
                        question: "Using the given variables, write code to print 'I like pizza but do not like football'",
                        starterCode: `food = "pizza"
sport = "football"
# Add your code here`,
                        check: (code) => {
                            return code.includes('food') && code.includes('sport') && 
                                   code.includes('like') && code.includes('but do not like') && code.includes('print(');
                        }
                    }
                ],
                simulations: [
                    {
                        id: "variable-detective",
                        title: "üîç Variable Detective",
                        description: "Find and fix variable naming errors before time runs out!"
                    },
                    {
                        id: "string-builder",
                        title: "üîß String Builder",
                        description: "Build complex sentences using variable concatenation"
                    },
                    {
                        id: "memory-matcher",
                        title: "üß† Memory Matcher",
                        description: "Match variable names with their values in this memory game"
                    },
                    {
                        id: "variable-race",
                        title: "üèÅ Variable Race",
                        description: "Create variables as fast as you can in this speed challenge"
                    }
                ]
            }
        };

        // Extension progress tracking
        let extensionProgress = {
            'variable-types': { completed: false, xp: 30 },
            'input-variables': { completed: false, xp: 35 },
            'f-strings': { completed: false, xp: 40 },
            'global-local': { completed: false, xp: 45 },
            'variable-swapping': { completed: false, xp: 50 }
        };

        const extensionChecks = {
            'variable-types': {
                check: (code, output) => {
                    return code.includes('int(') && code.includes('float(') && 
                           output.includes('25') && output.includes('3.14');
                },
                hint: "Make sure to convert strings to int and float, then print them"
            },
            'input-variables': {
                check: (code, output) => {
                    return code.includes('input(') && code.includes('name') && 
                           code.includes('age') && code.includes('Hello');
                },
                hint: "Use input() to get user data and store it in variables"
            },
            'f-strings': {
                check: (code, output) => {
                    return code.includes('f"') && code.includes('{') && code.includes('}');
                },
                hint: "Use f-strings with curly braces to embed variables: f'Hello {name}'"
            },
            'global-local': {
                check: (code, output) => {
                    return code.includes('global ') && code.includes('def ') && 
                           output.includes('10') && output.includes('20');
                },
                hint: "Create a function that uses both global and local variables"
            },
            'variable-swapping': {
                check: (code, output) => {
                    return (code.includes('a, b = b, a') || 
                           (code.includes('temp') && code.includes('a = b') && code.includes('b = temp'))) &&
                           output.includes('10') && output.includes('20');
                },
                hint: "Swap the values so a becomes 20 and b becomes 10"
            }
        };

        // Initialize CodeMirror editors
        function initializeEditor(taskNum) {
            const textarea = document.getElementById(`code${taskNum}`);
            if (!textarea) return null;
            
            const editor = CodeMirror.fromTextArea(textarea, {
                mode: 'python',
                theme: currentTheme,
                lineNumbers: true,
                indentUnit: 4,
                autoCloseBrackets: true,
                matchBrackets: true,
                indentWithTabs: false,
                viewportMargin: Infinity,
                lint: settings.syntaxCheckEnabled ? pythonLinter : false,
                gutters: settings.syntaxCheckEnabled ? ["CodeMirror-lint-markers"] : ["CodeMirror-linenumbers"],
                extraKeys: {
                    "Tab": function(cm) {
                        cm.replaceSelection("    ", "end");
                    },
                    "Ctrl-Space": "autocomplete",
                    "Ctrl-C": function(cm) { return false; },
                    "Ctrl-X": function(cm) { return false; },
                    "Ctrl-V": function(cm) { return false; },
                    "Cmd-C": function(cm) { return false; },
                    "Cmd-X": function(cm) { return false; },
                    "Cmd-V": function(cm) { return false; }
                }
            });
            
            editors[taskNum] = editor;
            
            // Disable right-click and drag/drop
            editor.getWrapperElement().addEventListener('contextmenu', function(e) {
                e.preventDefault();
                return false;
            });
            
            editor.on('drop', function(cm, e) {
                e.preventDefault();
                return false;
            });
            
            // Track code changes
            editor.on('change', function() {
                saveProgress(taskNum);
                checkForCommonMistakes(taskNum);
                
                // Add to history
                if (!codeHistory[taskNum]) codeHistory[taskNum] = [];
                codeHistory[taskNum].push({
                    code: editor.getValue(),
                    timestamp: new Date()
                });
                
                // Keep only last 20 versions
                if (codeHistory[taskNum].length > 20) {
                    codeHistory[taskNum].shift();
                }
            });
            
            editor.setSize("100%", "300px");
            editor.refresh();
            
            return editor;
        }

        // Python linter for live syntax checking
        function pythonLinter(text, options) {
            const errors = [];
            const lines = text.split('\n');
            
            lines.forEach((line, i) => {
                // Check for missing closing parenthesis
                const openParens = (line.match(/\(/g) || []).length;
                const closeParens = (line.match(/\)/g) || []).length;
                if (openParens > closeParens) {
                    errors.push({
                        from: CodeMirror.Pos(i, line.length),
                        to: CodeMirror.Pos(i, line.length),
                        message: "Missing closing parenthesis )",
                        severity: "error"
                    });
                }
                
                // Check for unclosed quotes
                const quotes = line.match(/"/g) || [];
                if (quotes.length % 2 !== 0) {
                    errors.push({
                        from: CodeMirror.Pos(i, line.length),
                        to: CodeMirror.Pos(i, line.length),
                        message: "Unclosed string - missing \"",
                        severity: "error"
                    });
                }
                
                // Check for common typos
                if (line.includes('prin(') && !line.includes('print(')) {
                    const col = line.indexOf('prin(');
                    errors.push({
                        from: CodeMirror.Pos(i, col),
                        to: CodeMirror.Pos(i, col + 4),
                        message: "Did you mean 'print'?",
                        severity: "warning"
                    });
                }
            });
            
            return errors;
        }

        // Load Pyodide
        async function initializePyodide() {
            const outputElements = document.querySelectorAll('.output-content');
            outputElements.forEach(el => {
                if (el) el.innerHTML = '<span class="loading">Loading Python environment...</span>';
            });
            
            try {
                pyodide = await loadPyodide({
                    indexURL: "https://cdn.jsdelivr.net/pyodide/v0.24.1/full/"
                });
                
                outputElements.forEach(el => {
                    if (el) el.innerHTML = '<span class="success">Python ready! Click "Run" to execute your code.</span>';
                });
            } catch (error) {
                outputElements.forEach(el => {
                    if (el) el.innerHTML = '<span class="error">Failed to load Python. Please refresh.</span>';
                });
                console.error('Failed to load Pyodide:', error);
            }
        }

        // Load task content
        function loadTaskContent(taskNum) {
            const task = tasks[taskNum];
            const taskContent = document.getElementById('taskContent');

            if (task.type === 'assessment') {
                taskContent.innerHTML = `
                    <div class="task-header">
                        <div class="task-header-left">
                            <h2>${task.title}</h2>
                            <span class="task-type assessment">Assessment</span>
                        </div>
                        <div class="task-badges">
                            <span class="task-xp">+${task.xp} XP</span>
                        </div>
                    </div>
                    
                    <div class="instructions">
                        ${task.instructions}
                    </div>
                    
                    <div class="assessment-container">
                        <!-- Question 1: Text Input -->
                        <div class="assessment-question">
                            <h4>Question 1: ${task.assessmentQuestions[0].question}</h4>
                            <textarea class="text-answer" id="textAnswer1" rows="3" 
                                placeholder="Write your answer here..."></textarea>
                            <button onclick="checkTextAnswer(10, 0)" class="check-btn">Check Answer</button>
                            <div id="feedback-q1" class="feedback-box"></div>
                        </div>
                        
                        <!-- Question 2: Text Input -->
                        <div class="assessment-question">
                            <h4>Question 2: ${task.assessmentQuestions[1].question}</h4>
                            <textarea class="text-answer" id="textAnswer2" rows="3" 
                                placeholder="Example: health = 100, player_name = 'Steve'"></textarea>
                            <button onclick="checkTextAnswer(10, 1)" class="check-btn">Check Answer</button>
                            <div id="feedback-q2" class="feedback-box"></div>
                        </div>
                        
                        <!-- Question 3: Multiple Choice -->
                        <div class="assessment-question">
                            <h4>Question 3: ${task.assessmentQuestions[2].question}</h4>
                            <div class="mc-options">
                                ${task.assessmentQuestions[2].options.map((opt, i) => `
                                    <label class="mc-option">
                                        <input type="radio" name="q3" value="${i}">
                                        <span>${opt}</span>
                                    </label>
                                `).join('')}
                            </div>
                            <button onclick="checkMCAnswer(10, 2)" class="check-btn">Check Answer</button>
                            <div id="feedback-q3" class="feedback-box"></div>
                        </div>
                        
                        <!-- Question 4: Code -->
                        <div class="assessment-question">
                            <h4>Question 4: ${task.assessmentQuestions[3].question}</h4>
                            <div class="code-section">
                                <div class="editor-container">
                                    <textarea id="assessCode4">${task.assessmentQuestions[3].starterCode}</textarea>
                                </div>
                                <button onclick="runAssessmentCode('assessCode4')" class="run-btn">‚ñ∂ Run</button>
                                <button onclick="checkAssessmentCode(10, 3, 'assessCode4')" class="check-btn">‚úì Check</button>
                                <div class="output-panel">
                                    <div class="output-header">Output</div>
                                    <div class="output-content" id="output-assessCode4">Ready to run...</div>
                                </div>
                            </div>
                            <div id="feedback-q4" class="feedback-box"></div>
                        </div>
                        
                        <!-- Question 5: Code -->
                        <div class="assessment-question">
                            <h4>Question 5: ${task.assessmentQuestions[4].question}</h4>
                            <div class="code-section">
                                <div class="editor-container">
                                    <textarea id="assessCode5">${task.assessmentQuestions[4].starterCode}</textarea>
                                </div>
                                <button onclick="runAssessmentCode('assessCode5')" class="run-btn">‚ñ∂ Run</button>
                                <button onclick="checkAssessmentCode(10, 4, 'assessCode5')" class="check-btn">‚úì Check</button>
                                <div class="output-panel">
                                    <div class="output-header">Output</div>
                                    <div class="output-content" id="output-assessCode5">Ready to run...</div>
                                </div>
                            </div>
                            <div id="feedback-q5" class="feedback-box"></div>
                        </div>
                        
                        <!-- Question 6: Code -->
                        <div class="assessment-question">
                            <h4>Question 6: ${task.assessmentQuestions[5].question}</h4>
                            <div class="code-section">
                                <div class="editor-container">
                                    <textarea id="assessCode6">${task.assessmentQuestions[5].starterCode}</textarea>
                                </div>
                                <button onclick="runAssessmentCode('assessCode6')" class="run-btn">‚ñ∂ Run</button>
                                <button onclick="checkAssessmentCode(10, 5, 'assessCode6')" class="check-btn">‚úì Check</button>
                                <div class="output-panel">
                                    <div class="output-header">Output</div>
                                    <div class="output-content" id="output-assessCode6">Ready to run...</div>
                                </div>
                            </div>
                            <div id="feedback-q6" class="feedback-box"></div>
                        </div>
                        
                        <!-- Interactive Games -->
                        <div class="simulations-section">
                            <h3>üéÆ Interactive Games</h3>
                            <div class="simulation-grid">
                                ${task.simulations.map(sim => `
                                    <div class="simulation-card" onclick="startSimulation('${sim.id}')">
                                        <h4>${sim.title}</h4>
                                        <p>${sim.description}</p>
                                        <button class="play-btn">Play ‚Üí</button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <!-- Progress Summary -->
                        <div class="assessment-progress">
                            <h3>Your Progress</h3>
                            <div class="progress-items">
                                <div class="progress-item" id="prog-q1">‚ùì Q1</div>
                                <div class="progress-item" id="prog-q2">‚ùì Q2</div>
                                <div class="progress-item" id="prog-q3">‚ùì Q3</div>
                                <div class="progress-item" id="prog-q4">‚ùì Q4</div>
                                <div class="progress-item" id="prog-q5">‚ùì Q5</div>
                                <div class="progress-item" id="prog-q6">‚ùì Q6</div>
                            </div>
                            <button onclick="submitAssessment(10)" class="submit-btn" id="submitBtn" disabled>
                                Submit Assessment
                            </button>
                        </div>
                    </div>
                    
<div id="gameModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeGame()">&times;</span>
        <div id="gameContent"></div>
    </div>
</div>
                `;
                
                setTimeout(() => {
                    initializeAssessmentEditors();
                }, 100);
            } else {
                taskContent.innerHTML = `
                    <div class="task-header">
                        <div class="task-header-left">
                            <h2>${task.title}</h2>
                            <span class="task-type ${task.type}">${task.type === 'example' ? 'Example' : task.type === 'challenge' ? 'Challenge' : 'Practice'}</span>
                        </div>
                        <div class="task-badges">
                            <span class="task-xp">+${task.xp} XP</span>
                        </div>
                    </div>
                    
                    <div class="instructions">
                        ${task.instructions}
                        <div class="audio-controls">
                            <button class="audio-btn" id="playAudioBtn${taskNum}" onclick="toggleAudioInstructions(${taskNum})" title="Read instructions aloud">
                                üîä
                            </button>
                            <button class="audio-btn" id="stopAudioBtn${taskNum}" onclick="stopAudio()" title="Stop audio" style="display: none;">
                                ‚èπÔ∏è
                            </button>
                        </div>
                    </div>
                    
                    <div class="code-section">
                        <div class="editor-header">
                            <div class="editor-title">Python Code Editor</div>
                        </div>
                        
                        <div class="editor-container">
                            <textarea id="code${taskNum}">${task.starterCode}</textarea>
                        </div>
                        
                        <div class="controls">
                            <button onclick="runCode(${taskNum})" id="runBtn${taskNum}" class="run-btn">
                                ‚ñ∂ Run
                            </button>
                            <button onclick="checkCode(${taskNum})" id="checkBtn${taskNum}" class="check-btn">
                                ‚úì Check
                            </button>
                            <button onclick="showHint(${taskNum})" class="hint-btn">
                                üí° Hint
                            </button>
                            <button onclick="resetCode(${taskNum})" class="reset-btn">
                                ‚Üª Reset
                            </button>
                        </div>
                        
                        <div class="hint-box" id="hint${taskNum}"></div>
                        
                        <div class="output-section">
                            <div class="output-panel">
                                <div class="output-header">
                                    <span>Output</span>
                                    <span class="execution-info" id="execInfo${taskNum}"></span>
                                </div>
                                <div class="output-content" id="output${taskNum}">
                                    <span class="success">Ready to run your code...</span>
                                </div>
                            </div>
                            
                            <div class="output-panel" id="checkPanel${taskNum}" style="display: none;">
                                <div class="output-header">
                                    <span>Check Results</span>
                                </div>
                                <div class="output-content" id="checkOutput${taskNum}">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="next-task-section" id="nextSection${taskNum}">
                        <h3>üéâ Well done! You've completed this task.</h3>
                        <button class="next-btn" onclick="nextTask()">
                            Continue to Next Task ‚Üí
                        </button>
                    </div>
                `;
            }
        }

        // Initialize assessment editors
        function initializeAssessmentEditors() {
            ['assessCode4', 'assessCode5', 'assessCode6'].forEach(id => {
                const textarea = document.getElementById(id);
                if (textarea) {
                    const editor = CodeMirror.fromTextArea(textarea, {
                        mode: 'python',
                        theme: currentTheme,
                        lineNumbers: true,
                        indentUnit: 4,
                        autoCloseBrackets: true,
                        matchBrackets: true
                    });
                    editors[id] = editor;
                    editor.setSize("100%", "150px");
                }
            });
        }

        // Run assessment code
        async function runAssessmentCode(editorId) {
            if (!pyodide) {
                const outputElement = document.getElementById(`output-${editorId}`);
                if (outputElement) {
                    outputElement.innerHTML = '<span class="error">Python environment not ready. Please wait...</span>';
                }
                return;
            }
            
            const code = editors[editorId].getValue();
            const outputElement = document.getElementById(`output-${editorId}`);
            
            if (!outputElement) {
                console.error(`Output element not found: output-${editorId}`);
                return;
            }
            
            outputElement.innerHTML = '<span class="loading">Running...</span>';
            
            try {
                pyodide.runPython(`
import sys
from io import StringIO
output_buffer = StringIO()
old_stdout = sys.stdout
sys.stdout = output_buffer
                `);
                
                pyodide.runPython(code);
                
                pyodide.runPython(`
sys.stdout = old_stdout
output_text = output_buffer.getvalue()
output_buffer.close()
                `);
                
                const output = pyodide.globals.get('output_text');
                outputElement.textContent = output || 'No output';
                
            } catch (error) {
                outputElement.innerHTML = `<span class="error">Error: ${error.message}</span>`;
            }
        }

        // Check assessment code
        function checkAssessmentCode(taskNum, questionIndex, editorId) {
            const editor = editors[editorId];
            const code = editor.getValue();
            const question = tasks[taskNum].assessmentQuestions[questionIndex];
            const feedbackEl = document.getElementById(`feedback-q${questionIndex + 1}`);
            
            if (question.check(code)) {
                feedbackEl.innerHTML = '<span class="success">‚úì Correct! Well done!</span>';
                feedbackEl.className = 'feedback-box success';
                assessmentProgress[`q${questionIndex + 1}`] = true;
                document.getElementById(`prog-q${questionIndex + 1}`).textContent = `‚úì Q${questionIndex + 1}`;
                document.getElementById(`prog-q${questionIndex + 1}`).classList.add('completed');
            } else {
                feedbackEl.innerHTML = '<span class="error">Not quite right. Check your code and try again.</span>';
                feedbackEl.className = 'feedback-box error';
            }
            
            checkAssessmentComplete();
        }

        // Check text answers
        function checkTextAnswer(taskNum, questionIndex) {
            const answer = document.getElementById(`textAnswer${questionIndex + 1}`).value.toLowerCase();
            const question = tasks[taskNum].assessmentQuestions[questionIndex];
            const feedbackEl = document.getElementById(`feedback-q${questionIndex + 1}`);
            
            if (answer.length < 10) {
                feedbackEl.innerHTML = '<span class="error">Please write a more detailed answer</span>';
                feedbackEl.className = 'feedback-box error';
                return;
            }
            
            const keywordCount = question.keywords.filter(keyword => 
                answer.includes(keyword.toLowerCase())
            ).length;
            
            if (keywordCount >= 1) {
                feedbackEl.innerHTML = '<span class="success">‚úì Good answer!</span>';
                feedbackEl.className = 'feedback-box success';
                assessmentProgress[`q${questionIndex + 1}`] = true;
                document.getElementById(`prog-q${questionIndex + 1}`).textContent = `‚úì Q${questionIndex + 1}`;
                document.getElementById(`prog-q${questionIndex + 1}`).classList.add('completed');
            } else {
                feedbackEl.innerHTML = `<span class="warning">Your answer could include more relevant details. ${question.hint}</span>`;
                feedbackEl.className = 'feedback-box warning';
            }
            
            checkAssessmentComplete();
        }

        // Check multiple choice answers
        function checkMCAnswer(taskNum, questionIndex) {
            const question = tasks[taskNum].assessmentQuestions[questionIndex];
            const selected = document.querySelector('input[name="q3"]:checked');
            const feedbackEl = document.getElementById('feedback-q3');
            
            if (!selected) {
                feedbackEl.innerHTML = '<span class="error">Please select an answer</span>';
                feedbackEl.className = 'feedback-box error';
                return;
            }
            
            if (parseInt(selected.value) === question.correct) {
                feedbackEl.innerHTML = '<span class="success">‚úì Correct! ' + question.explanation + '</span>';
                feedbackEl.className = 'feedback-box success';
                assessmentProgress.q3 = true;
                document.getElementById('prog-q3').textContent = '‚úì Q3';
                document.getElementById('prog-q3').classList.add('completed');
            } else {
                feedbackEl.innerHTML = '<span class="error">Not correct. Think about the rules for naming variables.</span>';
                feedbackEl.className = 'feedback-box error';
            }
            
            checkAssessmentComplete();
        }

        // Check if assessment is complete
        function checkAssessmentComplete() {
            const allComplete = Object.values(assessmentProgress).every(v => v === true);
            const submitBtn = document.getElementById('submitBtn');
            if (submitBtn) {
                submitBtn.disabled = !allComplete;
            }
        }

        // Submit assessment
        function submitAssessment(taskNum) {
            if (confirm('Submit your assessment?')) {
                taskProgress[taskNum] = {
                    completed: true,
                    timestamp: new Date().toISOString()
                };
                
                awardXP(tasks[taskNum].xp);
                showAchievement('üèÜ', 'Assessment Complete!', 'You finished Section 2 - Variables!', 200);
                
                updateProgress();
                saveAllProgress();
            }
        }

        // Switch between tasks
        function switchTask(taskNum) {
            currentTask = taskNum;
            
            // Update sidebar active state
            document.querySelectorAll('.task-item').forEach((item, index) => {
                item.classList.toggle('active', index + 1 === taskNum);
            });
            
            // Destroy existing editors to prevent memory leaks
            Object.keys(editors).forEach(key => {
                if (editors[key] && editors[key].toTextArea) {
                    editors[key].toTextArea();
                    delete editors[key];
                }
            });
            
            // Load new task content
            loadTaskContent(taskNum);
            
            // Initialize editor after DOM update
            setTimeout(() => {
                if (tasks[taskNum].type !== 'assessment') {
                    const editor = initializeEditor(taskNum);
                    loadProgress(taskNum);
                    
                    if (editor) {
                        editor.refresh();
                        setTimeout(() => {
                            editor.refresh();
                            editor.focus();
                            editor.setCursor(editor.lineCount(), 0);
                        }, 100);
                    }
                }
            }, 50);
            
            // Record task start time
            taskStartTime[taskNum] = new Date();
        }

        // Run code
        async function runCode(taskNumber) {
            if (!pyodide) {
                document.getElementById(`output${taskNumber}`).innerHTML = 
                    '<span class="error">Python environment not ready. Please wait...</span>';
                return;
            }
            
            const code = editors[taskNumber].getValue();
            const outputElement = document.getElementById(`output${taskNumber}`);
            const execInfoElement = document.getElementById(`execInfo${taskNumber}`);
            const runButton = document.getElementById(`runBtn${taskNumber}`);
            
            runButton.disabled = true;
            runButton.textContent = '‚è≥ Running...';
            outputElement.innerHTML = '';
            
            const startTime = performance.now();
            
            // Increment attempts
            if (!userProfile.attemptsBeforeSuccess[taskNumber]) {
                userProfile.attemptsBeforeSuccess[taskNumber] = 0;
            }
            userProfile.attemptsBeforeSuccess[taskNumber]++;
            
            try {
                // Capture output
                pyodide.runPython(`
import sys
from io import StringIO
output_buffer = StringIO()
old_stdout = sys.stdout
sys.stdout = output_buffer
                `);
                
                // Run user code
                try {
                    pyodide.runPython(code);
                } catch (userError) {
                    outputElement.innerHTML = `<span class="error">Error: ${userError.message}</span>`;
                    showErrorHelp(taskNumber, userError.message);
                    return;
                } finally {
                    // Restore stdout
                    pyodide.runPython(`
sys.stdout = old_stdout
output_text = output_buffer.getvalue()
output_buffer.close()
                    `);
                }
                
                const output = pyodide.globals.get('output_text');
                
                if (output) {
                    outputElement.textContent = output;
                } else {
                    outputElement.innerHTML = '<span style="color: #9ca3af;">No output. Use print() to display text.</span>';
                }
                
                // Show execution time
                const endTime = performance.now();
                const execTime = (endTime - startTime).toFixed(2);
                if (execInfoElement) {
                    execInfoElement.textContent = `Executed in ${execTime}ms`;
                }
                
                // Auto-save progress
                saveProgress(taskNumber);
                
            } catch (error) {
                outputElement.innerHTML = `<span class="error">System Error: ${error.message}</span>`;
            } finally {
                runButton.disabled = false;
                runButton.textContent = '‚ñ∂ Run';
                
                // Cleanup
                try {
                    pyodide.runPython(`
if 'output_buffer' in locals():
    output_buffer.close()
if 'output_text' in locals():
    del output_text
                    `);
                } catch (cleanupError) {
                    // Ignore cleanup errors
                }
            }
        }

        // Check code
        async function checkCode(taskNumber) {
            const checkPanel = document.getElementById(`checkPanel${taskNumber}`);
            const checkOutput = document.getElementById(`checkOutput${taskNumber}`);
            const checkButton = document.getElementById(`checkBtn${taskNumber}`);
            
            checkPanel.style.display = 'block';
            checkButton.disabled = true;
            checkButton.textContent = '‚è≥ Checking...';
            
            // First run the code
            await runCode(taskNumber);
            
            const code = editors[taskNumber].getValue();
            const output = document.getElementById(`output${taskNumber}`).textContent;
            const task = tasks[taskNumber];
            
            let checkResults = '';
            let allPassed = true;
            let xpEarned = 0;
            
            for (const check of task.checks) {
                const passed = check.test(code, output);
                allPassed = allPassed && passed;
                checkResults += `<div class="test-result ${passed ? 'test-pass' : 'test-fail'}">
                    ${passed ? '‚úì' : '‚úó'} ${check.name}
                </div>`;
            }
            
            checkOutput.innerHTML = checkResults;
            
            if (allPassed) {
                // Calculate XP
                xpEarned = task.xp;
                
                // Bonus XP for not using hints
                if (!userProfile.hintsUsed[taskNumber] || userProfile.hintsUsed[taskNumber] === 0) {
                    xpEarned += XP_VALUES.noHints;
                    checkOutput.innerHTML += '<div class="test-result test-pass">üåü No hints bonus! +25 XP</div>';
                }
                
                // Bonus XP for first try
                if (userProfile.attemptsBeforeSuccess[taskNumber] === 1) {
                    xpEarned += XP_VALUES.firstTry;
                    checkOutput.innerHTML += '<div class="test-result test-pass">‚ö° First try bonus! +50 XP</div>';
                }
                
                // Mark as completed
                taskProgress[taskNumber] = {
                    completed: true,
                    code: code,
                    timestamp: new Date().toISOString(),
                    attempts: userProfile.attemptsBeforeSuccess[taskNumber],
                    hintsUsed: userProfile.hintsUsed[taskNumber] || 0
                };
                
                // Award XP
                awardXP(xpEarned);
                
                // Check for badges
                checkBadges();
                
                // Update progress
                updateProgress();
                saveAllProgress();
                
                // Show next task button
                document.getElementById(`nextSection${taskNumber}`).style.display = 'block';
                
                checkOutput.innerHTML += `<div class="test-result test-pass xp-gained">üéâ Task Complete! +${xpEarned} XP</div>`;
                
            } else {
                checkOutput.innerHTML += '<div class="test-result test-fail">Keep trying! Click "Hint" if you need assistance.</div>';
            }
            
            checkButton.disabled = false;
            checkButton.textContent = '‚úì Check';
        }

        // Show hint
        function showHint(taskNumber) {
            const hintBox = document.getElementById(`hint${taskNumber}`);
            const hints = tasks[taskNumber].hints;
            
            if (!hintLevel[taskNumber]) hintLevel[taskNumber] = 0;
            if (!userProfile.hintsUsed[taskNumber]) userProfile.hintsUsed[taskNumber] = 0;
            
            if (hintLevel[taskNumber] < hints.length) {
                hintBox.style.display = 'block';
                hintBox.innerHTML = `<strong>Hint ${hintLevel[taskNumber] + 1}:</strong> ${hints[hintLevel[taskNumber]]}`;
                hintLevel[taskNumber]++;
                userProfile.hintsUsed[taskNumber]++;
            } else {
                hintBox.innerHTML = '<strong>All hints shown!</strong> Try reviewing the instructions above.';
            }
        }

        // Check for common mistakes and show smart hints
        function checkForCommonMistakes(taskNumber) {
            const code = editors[taskNumber].getValue();
            const task = tasks[taskNumber];
            
            if (!task.smartHints) return;
            
            // Check patterns and show inline hints
            for (const [pattern, hint] of Object.entries(task.smartHints)) {
                if (checkCodePattern(code, pattern)) {
                    // Could show inline hint notification here
                    break;
                }
            }
        }

        // Check code patterns for smart hints
        function checkCodePattern(code, pattern) {
            switch (pattern) {
                case 'missing_name':
                    return !code.includes('name =');
                case 'missing_food':
                    return !code.includes('food =');
                case 'missing_hobby':
                    return !code.includes('hobby =');
                case 'missing_prints':
                    return code.includes('name =') && !code.includes('print(name)');
                case 'still_toyota':
                    return code.includes('Toyota');
                case 'missing_quotes':
                    return code.includes('=') && !code.includes('"');
                case 'unchanged_first':
                    return code.includes("Python's the way");
                case 'unchanged_chorus':
                    return code.includes("uh huh uh huh");
                case 'unchanged_second':
                    return code.includes("I like it");
                case 'space_in_name':
                    return code.includes('first line =');
                case 'number_start':
                    return code.includes('2nd_line =');
                case 'case_mismatch':
                    return code.includes('print(Line3)');
                case 'no_spaces':
                    return code.includes('a + b') && !code.includes('" "');
                case 'unchanged_name':
                    return code.includes('name = "George"');
                case 'unchanged_action':
                    return code.includes('action = "code"');
                case 'no_print':
                    return !code.includes('print(');
                case 'missing_variables':
                    return !code.includes('subject') || !code.includes('place') || !code.includes('activity');
                case 'empty_variables':
                    return code.includes('= ""');
                case 'no_variables':
                    return !code.includes('friend1 =');
                default:
                    return false;
            }
        }

        // Show error help
        function showErrorHelp(taskNumber, errorMessage) {
            let helpMessage = '<strong>Error Help:</strong><br>';
            
            if (errorMessage.includes('SyntaxError')) {
                helpMessage += '‚Ä¢ Syntax error means Python doesn\'t understand your code format<br>';
                helpMessage += '‚Ä¢ Check for missing quotes, parentheses, or colons<br>';
            } else if (errorMessage.includes('NameError')) {
                helpMessage += '‚Ä¢ NameError means Python doesn\'t recognize a word you used<br>';
                helpMessage += '‚Ä¢ Check your spelling, especially for variable names<br>';
            } else if (errorMessage.includes('IndentationError')) {
                helpMessage += '‚Ä¢ IndentationError means your spacing is wrong<br>';
                helpMessage += '‚Ä¢ Make sure lines start at the beginning (no spaces)<br>';
            }
            
            showNotification('üêõ Error Help', helpMessage, 'error');
        }

        // Reset code
        function resetCode(taskNumber) {
            if (confirm('Reset to the starter code? Your current work will be saved in history.')) {
                editors[taskNumber].setValue(tasks[taskNumber].starterCode);
                document.getElementById(`output${taskNumber}`).innerHTML = '<span class="success">Code reset.</span>';
                document.getElementById(`checkPanel${taskNumber}`).style.display = 'none';
                document.getElementById(`hint${taskNumber}`).style.display = 'none';
                hintLevel[taskNumber] = 0;
                saveProgress(taskNumber);
            }
        }

        // Award XP
        function awardXP(amount) {
            userProfile.xp += amount;
            
            // Check for level up
            while (userProfile.xp >= userProfile.xpToNextLevel) {
                userProfile.xp -= userProfile.xpToNextLevel;
                userProfile.level++;
                userProfile.xpToNextLevel = userProfile.level * 500;
                
                showAchievement('üéâ', 'Level Up!', `You reached level ${userProfile.level}!`, 100);
            }
            
            updateUserStats();
        }

        // Check for badges
        function checkBadges() {
            // Variable Master badge
            if (taskProgress[1] && taskProgress[1].completed && !userProfile.badges.includes('variable-master')) {
                userProfile.badges.push('variable-master');
                showAchievement('üì¶', 'Variable Master!', 'You created your first variables!', 50);
            }
            
            // Naming Ninja badge
            if (taskProgress[4] && taskProgress[4].completed && !userProfile.badges.includes('name-ninja')) {
                userProfile.badges.push('name-ninja');
                showAchievement('ü•∑', 'Naming Ninja!', 'You fixed all variable naming errors!', 75);
            }
            
            // Combination Expert badge
            if (taskProgress[5] && taskProgress[5].completed && !userProfile.badges.includes('combination-expert')) {
                userProfile.badges.push('combination-expert');
                showAchievement('üîó', 'Combination Expert!', 'You mastered string combination!', 75);
            }
            
            // Challenge Champion badge
            if (taskProgress[9] && taskProgress[9].completed && !userProfile.badges.includes('challenge-champion')) {
                userProfile.badges.push('challenge-champion');
                showAchievement('üèÜ', 'Challenge Champion!', 'You completed the challenge task!', 100);
            }
            
            // Perfect Variables badge
            const practicalTasksCompleted = Object.keys(tasks).filter(key => parseInt(key) <= 9).every(key => taskProgress[key] && taskProgress[key].completed);
            const noHintsUsed = Object.keys(tasks).filter(key => parseInt(key) <= 9).every(key => !userProfile.hintsUsed[key] || userProfile.hintsUsed[key] === 0);
            
            if (practicalTasksCompleted && noHintsUsed && !userProfile.badges.includes('perfect-variables')) {
                userProfile.badges.push('perfect-variables');
                showAchievement('‚≠ê', 'Perfect Variables!', 'You completed all tasks without hints!', 250);
            }
            
            updateBadgeDisplay();
        }

        // Show achievement popup
        function showAchievement(icon, title, description, xp) {
            const popup = document.getElementById('achievementPopup');
            const overlay = document.getElementById('overlay');
            
            document.getElementById('achievementIcon').textContent = icon;
            document.getElementById('achievementTitle').textContent = title;
            document.getElementById('achievementDesc').textContent = description;
            document.getElementById('achievementXP').textContent = `+${xp} XP`;
            
            overlay.classList.add('show');
            popup.classList.add('show');
            
            // Award XP
            awardXP(xp);
            
            // Hide after 3 seconds
            setTimeout(() => {
                overlay.classList.remove('show');
                popup.classList.remove('show');
            }, 3000);
        }

        // Update badge display
        function updateBadgeDisplay() {
            userProfile.badges.forEach(badgeId => {
                const badgeElement = document.getElementById(`badge-${badgeId}`);
                if (badgeElement) {
                    badgeElement.classList.add('earned');
                }
            });
        }

        // Update user stats
        function updateUserStats() {
            document.getElementById('userLevel').textContent = userProfile.level;
            document.getElementById('userXP').textContent = userProfile.xp;
            document.getElementById('userStreak').textContent = userProfile.streak;
            
            const xpPercentage = (userProfile.xp / userProfile.xpToNextLevel) * 100;
            document.getElementById('xpFill').style.width = `${xpPercentage}%`;
        }

        // Show notification function
        function showNotification(title, message, type = 'info') {
            // Remove any existing notifications
            const existing = document.querySelector('.notification');
            if (existing) existing.remove();
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="notification-icon">
                    ${type === 'warning' ? '‚ö†Ô∏è' : type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}
                </div>
                <div class="notification-content">
                    <h4>${title}</h4>
                    <p>${message}</p>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Trigger animation
            setTimeout(() => notification.classList.add('show'), 10);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }, 3000);
        }

        // Update progress to include extensions
        function updateProgress() {
            const completedTasks = Object.values(taskProgress).filter(t => t.completed).length;
            const completedExtensions = Object.values(extensionProgress).filter(e => e.completed).length;
            const totalTasks = Object.keys(tasks).length;
            const totalExtensions = Object.keys(extensionProgress).length;
            
            document.getElementById('progressText').textContent = 
                `${completedTasks}/${totalTasks} tasks, ${completedExtensions}/${totalExtensions} extensions completed`;
            
            // Update progress bar to include extensions
            const totalItems = totalTasks + totalExtensions;
            const totalCompleted = completedTasks + completedExtensions;
            document.getElementById('progressBar').style.width = `${(totalCompleted / totalItems) * 100}%`;
            
            // Update status indicators
            for (let i = 1; i <= totalTasks; i++) {
                const statusElement = document.getElementById(`status${i}`);
                if (taskProgress[i] && taskProgress[i].completed) {
                    statusElement.classList.add('completed');
                    statusElement.textContent = '‚úì';
                    document.querySelectorAll('.task-item')[i - 1].classList.add('completed');
                }
            }
        }
                
            
        

        // Toggle settings
        function toggleDyslexicFont() {
            settings.dyslexicFont = !settings.dyslexicFont;
            document.body.classList.toggle('dyslexic-font', settings.dyslexicFont);
            document.getElementById('dyslexicToggle').classList.toggle('active', settings.dyslexicFont);
            saveSettings();
        }
        
        function toggleAudio() {
            settings.audioEnabled = !settings.audioEnabled;
            document.getElementById('audioToggle').classList.toggle('active', settings.audioEnabled);
            
            if (!settings.audioEnabled) {
                stopAudio();
            }
            
            saveSettings();
        }
        
        function toggleSyntaxCheck() {
            settings.syntaxCheckEnabled = !settings.syntaxCheckEnabled;
            document.getElementById('syntaxToggle').classList.toggle('active', settings.syntaxCheckEnabled);
            
            // Recreate editors with new settings
            Object.keys(editors).forEach(key => {
                if (editors[key] && editors[key].toTextArea) {
                    const code = editors[key].getValue();
                    editors[key].toTextArea();
                    delete editors[key];
                }
            });
            
            setTimeout(() => {
                if (tasks[currentTask].type !== 'assessment') {
                    initializeEditor(currentTask);
                    loadProgress(currentTask);
                }
            }, 100);
            
            saveSettings();
        }

        // Audio control variables
        let currentUtterance = null;
        let isPlaying = false;
        
        // Toggle audio instructions
        function toggleAudioInstructions(taskNumber) {
            if (!settings.audioEnabled) {
                showNotification('üîä Audio Disabled', 'Enable audio in settings to use this feature', 'warning');
                return;
            }
            
            if (isPlaying) {
                stopAudio();
            } else {
                playAudioInstructions(taskNumber);
            }
        }
        
        // Play audio instructions
        function playAudioInstructions(taskNumber) {
            const task = tasks[taskNumber];
            const text = task.instructions.replace(/<[^>]*>/g, ''); // Strip HTML
            
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
                currentUtterance = new SpeechSynthesisUtterance(text);
                currentUtterance.rate = 0.9;
                
                currentUtterance.onstart = () => {
                    isPlaying = true;
                    const playBtn = document.getElementById(`playAudioBtn${taskNumber}`);
                    const stopBtn = document.getElementById(`stopAudioBtn${taskNumber}`);
                    if (playBtn) playBtn.style.display = 'none';
                    if (stopBtn) stopBtn.style.display = 'block';
                };
                
                currentUtterance.onend = () => {
                    isPlaying = false;
                    const playBtn = document.getElementById(`playAudioBtn${taskNumber}`);
                    const stopBtn = document.getElementById(`stopAudioBtn${taskNumber}`);
                    if (playBtn) playBtn.style.display = 'block';
                    if (stopBtn) stopBtn.style.display = 'none';
                };
                
                speechSynthesis.speak(currentUtterance);
            }
        }
        
        function stopAudio() {
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
                isPlaying = false;
                
                // Reset all audio buttons
                for (let i = 1; i <= Object.keys(tasks).length; i++) {
                    const playBtn = document.getElementById(`playAudioBtn${i}`);
                    const stopBtn = document.getElementById(`stopAudioBtn${i}`);
                    if (playBtn) playBtn.style.display = 'block';
                    if (stopBtn) stopBtn.style.display = 'none';
                }
            }
        }

        // Next task
        function nextTask() {
            if (currentTask < Object.keys(tasks).length) {
                switchTask(currentTask + 1);
            } else {
                // Check for daily challenge completion
                const allCompleted = Object.keys(tasks).filter(key => parseInt(key) <= 9).every(key => taskProgress[key] && taskProgress[key].completed);
                const noHintsUsed = Object.keys(tasks).filter(key => parseInt(key) <= 9).every(key => !userProfile.hintsUsed[key] || userProfile.hintsUsed[key] === 0);
                
                if (allCompleted && noHintsUsed) {
                    showAchievement('üåü', 'Daily Challenge Complete!', 'You completed all tasks without hints!', 250);
                }
                
                alert('Congratulations! You have completed all tasks in Section 2 - Variables.');
            }
        }

        // Save/Load functions
        function saveProgress(taskNumber) {
            if (!editors[taskNumber]) return;
            
            const code = editors[taskNumber].getValue();
            const progress = {
                code: code,
                timestamp: new Date().toISOString()
            };
            
            const allProgress = JSON.parse(localStorage.getItem('pythonWorksheetSection2Progress') || '{}');
            allProgress[taskNumber] = progress;
            localStorage.setItem('pythonWorksheetSection2Progress', JSON.stringify(allProgress));
        }

        function loadProgress(taskNumber) {
            const allProgress = JSON.parse(localStorage.getItem('pythonWorksheetSection2Progress') || '{}');
            
            if (allProgress[taskNumber] && editors[taskNumber]) {
                editors[taskNumber].setValue(allProgress[taskNumber].code);
            }
        }
        
        function saveAllProgress() {
            localStorage.setItem('pythonWorksheetSection2TaskProgress', JSON.stringify(taskProgress));
            localStorage.setItem('pythonWorksheetSection2UserProfile', JSON.stringify(userProfile));
        }
        
        function saveSettings() {
            localStorage.setItem('pythonWorksheetSection2Settings', JSON.stringify(settings));
        }

        // Download progress
        function downloadProgress() {
            let documentContent = `Python Programming - Section 2: Variables
Student: Level ${userProfile.level} (${userProfile.xp} XP)
Date: ${new Date().toLocaleDateString()}
=====================================\n\n`;
            
            for (let i = 1; i <= Object.keys(tasks).length; i++) {
                const task = tasks[i];
                const completed = taskProgress[i] && taskProgress[i].completed;
                
                documentContent += `${task.title}${completed ? ' ‚úì' : ' (Not completed)'}\n`;
                documentContent += '-'.repeat(task.title.length + (completed ? 2 : 16)) + '\n\n';
                
                let code = '';
                if (editors[i]) {
                    code = editors[i].getValue();
                } else if (localStorage.getItem('pythonWorksheetSection2Progress')) {
                    const progress = JSON.parse(localStorage.getItem('pythonWorksheetSection2Progress'));
                    if (progress[i]) code = progress[i].code;
                } else {
                    code = task.starterCode || '';
                }
                
                documentContent += code + '\n\n';
                
                if (completed) {
                    documentContent += `Completed on: ${new Date(taskProgress[i].timestamp).toLocaleDateString()}\n`;
                    documentContent += `Attempts: ${taskProgress[i].attempts || 'N/A'}\n`;
                    documentContent += `Hints used: ${taskProgress[i].hintsUsed || 0}\n`;
                }
                
                documentContent += '\n' + '='.repeat(50) + '\n\n';
            }
            
            const completedCount = Object.values(taskProgress).filter(t => t.completed).length;
            documentContent += `\nSummary\n-------\n`;
            documentContent += `Tasks completed: ${completedCount}/${Object.keys(tasks).length}\n`;
            documentContent += `Total XP earned: ${userProfile.xp}\n`;
            documentContent += `Current level: ${userProfile.level}\n`;
            documentContent += `Badges earned: ${userProfile.badges.map(b => BADGES[b]?.name || b).join(', ') || 'None'}\n`;
            
            const blob = new Blob([documentContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `python_section2_variables_${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // Reset section
        function resetSection() {
            if (confirm('Reset all progress in this section? This cannot be undone!')) {
                localStorage.removeItem('pythonWorksheetSection2Progress');
                localStorage.removeItem('pythonWorksheetSection2TaskProgress');
                localStorage.removeItem('pythonWorksheetSection2UserProfile');
                localStorage.removeItem('pythonWorksheetSection2Settings');
                
                taskProgress = {};
                userProfile = {
                    level: 1,
                    xp: 0,
                    xpToNextLevel: 500,
                    streak: 0,
                    badges: [],
                    hintsUsed: {},
                    attemptsBeforeSuccess: {},
                    totalTime: 0,
                    lastLogin: new Date().toDateString()
                };
                hintLevel = {};
                codeHistory = {};
                
                location.reload();
            }
        }

        // Game functions
        function startSimulation(simId) {
            const modal = document.getElementById('gameModal');
            const content = document.getElementById('gameContent');
            
            modal.style.display = 'block';
            
            switch(simId) {
                case 'variable-detective':
                    content.innerHTML = createVariableDetectiveGame();
                    startVariableDetective();
                    break;
                case 'string-builder':
                    content.innerHTML = createStringBuilderGame();
                    startStringBuilder();
                    break;
                case 'memory-matcher':
                    content.innerHTML = createMemoryMatcherGame();
                    startMemoryMatcher();
                    break;
                case 'variable-race':
                    content.innerHTML = createVariableRaceGame();
                    startVariableRace();
                    break;
            }
        }

        function closeGame() {
            const modal = document.getElementById('gameModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function createVariableDetectiveGame() {
            return `
                <h2>üîç Variable Detective</h2>
                <p>Find and fix variable naming errors before time runs out!</p>
                <div class="game-timer">Time: <span id="gameTimer">60</span>s</div>
                <div class="game-score">Score: <span id="gameScore">0</span></div>
                <div id="variableChallenges"></div>
            `;
        }

        function startVariableDetective() {
            const challenges = [
                { code: 'first name = "John"', fix: 'first_name = "John"', hint: 'Variable names cannot have spaces' },
                { code: '2nd_place = "Silver"', fix: 'second_place = "Silver"', hint: 'Variable names cannot start with numbers' },
                { code: 'Print = "Hello"', fix: 'message = "Hello"', hint: 'Cannot use Python keywords as variable names' },
                { code: 'my-score = 100', fix: 'my_score = 100', hint: 'Use underscores instead of hyphens' },
                { code: 'user@name = "Alice"', fix: 'user_name = "Alice"', hint: 'No special characters except underscore' }
            ];
            
            let score = 0;
            let timeLeft = 60;
            let currentChallenge = 0;
            
            function showChallenge() {
                if (currentChallenge < challenges.length) {
                    document.getElementById('variableChallenges').innerHTML = `
                        <div class="game-challenge">
                            <p>Fix this variable name:</p>
                            <pre>${challenges[currentChallenge].code}</pre>
                            <input type="text" id="fixInput" placeholder="Type the corrected code" autocomplete="off">
                            <button id="checkBtn" onclick="checkVariableFix(${currentChallenge})">Check</button>
                            <div id="variableFeedback"></div>
                        </div>
                    `;
                    
                    const input = document.getElementById('fixInput');
                    input.focus();
                    input.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            checkVariableFix(currentChallenge);
                        }
                    });
                } else {
                    endVariableGame();
                }
            }
            
            window.checkVariableFix = function(index) {
                const input = document.getElementById('fixInput');
                if (input.value === challenges[index].fix) {
                    score += 100;
                    document.getElementById('gameScore').textContent = score;
                    document.getElementById('variableFeedback').innerHTML = '<span class="success">Correct!</span>';
                    currentChallenge++;
                    setTimeout(() => {
                        showChallenge();
                    }, 1000);
                } else {
                    document.getElementById('variableFeedback').innerHTML = 
                        `<span class="error">Not quite. Hint: ${challenges[index].hint}</span>`;
                    input.select();
                }
            };
            
            function endVariableGame() {
                document.getElementById('variableChallenges').innerHTML = `
                    <h3>Game Over!</h3>
                    <p>Final Score: ${score}</p>
                    <p>You fixed ${currentChallenge} variable naming errors!</p>
                    <button onclick="closeGame()">Close</button>
                `;
            }
            
            const timerInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('gameTimer').textContent = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    endVariableGame();
                }
            }, 1000);
            
            showChallenge();
        }

        function createStringBuilderGame() {
            return `
                <h2>üîß String Builder</h2>
                <p>Build the target sentence using string concatenation!</p>
                <div class="game-score">Score: <span id="stringScore">0</span></div>
                <div id="stringChallenge"></div>
            `;
        }

        function startStringBuilder() {
            const challenges = [
                {
                    target: "Hello World",
                    variables: ['greeting = "Hello"', 'word = "World"'],
                    solution: 'greeting + " " + word'
                },
                {
                    target: "I am 16 years old",
                    variables: ['pronoun = "I"', 'verb = "am"', 'age = "16"', 'unit = "years old"'],
                    solution: 'pronoun + " " + verb + " " + age + " " + unit'
                },
                {
                    target: "Python is awesome!",
                    variables: ['language = "Python"', 'verb = "is"', 'adjective = "awesome!"'],
                    solution: 'language + " " + verb + " " + adjective'
                }
            ];
            
            let score = 0;
            let currentChallenge = 0;
            
            function showStringChallenge() {
                if (currentChallenge < challenges.length) {
                    const challenge = challenges[currentChallenge];
                    document.getElementById('stringChallenge').innerHTML = `
                        <div class="game-challenge">
                            <h4>Target: "${challenge.target}"</h4>
                            <p>Available variables:</p>
                            ${challenge.variables.map(v => `<code>${v}</code>`).join('<br>')}
                            <p>Build the target using concatenation:</p>
                            <input type="text" id="stringInput" placeholder="e.g., var1 + var2" autocomplete="off">
                            <button onclick="checkStringBuilder(${currentChallenge})">Check</button>
                            <div id="stringFeedback"></div>
                        </div>
                    `;
                    document.getElementById('stringInput').focus();
                } else {
                    document.getElementById('stringChallenge').innerHTML = `
                        <h3>Congratulations!</h3>
                        <p>You completed all string building challenges!</p>
                        <p>Final Score: ${score}</p>
                        <button onclick="closeGame()">Close</button>
                    `;
                }
            }
            
            window.checkStringBuilder = function(index) {
                const input = document.getElementById('stringInput').value;
                const challenge = challenges[index];
                
                if (input === challenge.solution || input.replace(/\s/g, '') === challenge.solution.replace(/\s/g, '')) {
                    score += 150;
                    document.getElementById('stringScore').textContent = score;
                    document.getElementById('stringFeedback').innerHTML = '<span class="success">Perfect!</span>';
                    currentChallenge++;
                    setTimeout(showStringChallenge, 1500);
                } else {
                    document.getElementById('stringFeedback').innerHTML = 
                        '<span class="error">Not quite right. Remember to use + to concatenate and add spaces!</span>';
                }
            };
            
            showStringChallenge();
        }

        function createMemoryMatcherGame() {
            return `
                <h2>üß† Memory Matcher</h2>
                <p>Match variable names with their values!</p>
                <div class="game-score">Score: <span id="memoryScore">0</span></div>
                <div id="memoryGrid" class="game-grid"></div>
                <div id="memoryFeedback"></div>
            `;
        }

        function startMemoryMatcher() {
            const pairs = [
                { name: 'player_name', value: '"Alice"' },
                { name: 'high_score', value: '9500' },
                { name: 'is_winner', value: 'True' },
                { name: 'game_level', value: '3' },
                { name: 'user_age', value: '16' },
                { name: 'favorite_color', value: '"blue"' }
            ];
            
            let score = 0;
            let flippedCards = [];
            let matchedPairs = 0;
            
            // Create shuffled cards
            const cards = [];
            pairs.forEach((pair, index) => {
                cards.push({ type: 'name', content: pair.name, pairId: index });
                cards.push({ type: 'value', content: pair.value, pairId: index });
            });
            
            // Shuffle cards
            for (let i = cards.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [cards[i], cards[j]] = [cards[j], cards[i]];
            }
            
            function renderGrid() {
                const grid = document.getElementById('memoryGrid');
                grid.innerHTML = cards.map((card, index) => `
                    <div class="game-card" data-index="${index}" onclick="flipCard(${index})">
                        <div class="card-content" style="display: none;">${card.content}</div>
                        <div class="card-back">?</div>
                    </div>
                `).join('');
            }
            
            window.flipCard = function(index) {
                const cardElement = document.querySelector(`[data-index="${index}"]`);
                const card = cards[index];
                
                if (flippedCards.length < 2 && !cardElement.classList.contains('selected')) {
                    cardElement.classList.add('selected');
                    cardElement.querySelector('.card-content').style.display = 'block';
                    cardElement.querySelector('.card-back').style.display = 'none';
                    flippedCards.push({ index, card });
                    
                    if (flippedCards.length === 2) {
                        setTimeout(checkMatch, 1000);
                    }
                }
            };
            
            function checkMatch() {
                const [first, second] = flippedCards;
                
                if (first.card.pairId === second.card.pairId) {
                    // Match!
                    score += 100;
                    matchedPairs++;
                    document.getElementById('memoryScore').textContent = score;
                    
                    document.querySelector(`[data-index="${first.index}"]`).classList.add('matched');
                    document.querySelector(`[data-index="${second.index}"]`).classList.add('matched');
                    
                    if (matchedPairs === pairs.length) {
                        document.getElementById('memoryFeedback').innerHTML = `
                            <h3>Congratulations!</h3>
                            <p>You matched all pairs! Final Score: ${score}</p>
                            <button onclick="closeGame()">Close</button>
                        `;
                    }
                } else {
                    // No match
                    const firstCard = document.querySelector(`[data-index="${first.index}"]`);
                    const secondCard = document.querySelector(`[data-index="${second.index}"]`);
                    
                    firstCard.classList.remove('selected');
                    secondCard.classList.remove('selected');
                    firstCard.querySelector('.card-content').style.display = 'none';
                    secondCard.querySelector('.card-content').style.display = 'none';
                    firstCard.querySelector('.card-back').style.display = 'block';
                    secondCard.querySelector('.card-back').style.display = 'block';
                }
                
                flippedCards = [];
            }
            
            renderGrid();
        }

        function createVariableRaceGame() {
            return `
                <h2>üèÅ Variable Race</h2>
                <p>Create variables as fast as you can! Type the variable assignments:</p>
                <div class="game-timer">Time: <span id="raceTimer">30</span>s</div>
                <div class="game-score">Variables Created: <span id="raceScore">0</span></div>
                <div id="raceChallenge"></div>
            `;
        }

        function startVariableRace() {
            const prompts = [
                { instruction: 'Create a variable "name" with value "Sarah"', answer: 'name = "Sarah"' },
                { instruction: 'Create a variable "age" with value 17', answer: 'age = 17' },
                { instruction: 'Create a variable "city" with value "London"', answer: 'city = "London"' },
                { instruction: 'Create a variable "score" with value 450', answer: 'score = 450' },
                { instruction: 'Create a variable "is_student" with value True', answer: 'is_student = True' },
                { instruction: 'Create a variable "grade" with value "A"', answer: 'grade = "A"' },
                { instruction: 'Create a variable "temperature" with value 23.5', answer: 'temperature = 23.5' },
                { instruction: 'Create a variable "game_title" with value "Python Quest"', answer: 'game_title = "Python Quest"' }
            ];
            
            let score = 0;
            let timeLeft = 30;
            let currentPrompt = 0;
            
            function showPrompt() {
                if (currentPrompt < prompts.length && timeLeft > 0) {
                    const prompt = prompts[currentPrompt];
                    document.getElementById('raceChallenge').innerHTML = `
                        <div class="game-challenge">
                            <p><strong>${prompt.instruction}</strong></p>
                            <div class="speed-input">
                                <input type="text" id="raceInput" placeholder="Type your variable assignment" autocomplete="off">
                                <button onclick="checkRaceAnswer()">Submit</button>
                            </div>
                            <div id="raceFeedback"></div>
                        </div>
                    `;
                    
                    const input = document.getElementById('raceInput');
                    input.focus();
                    input.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            checkRaceAnswer();
                        }
                    });
                }
            }
            
            window.checkRaceAnswer = function() {
                const input = document.getElementById('raceInput');
                const userAnswer = input.value.trim();
                const correctAnswer = prompts[currentPrompt].answer;
                
                if (userAnswer === correctAnswer) {
                    score++;
                    document.getElementById('raceScore').textContent = score;
                    document.getElementById('raceFeedback').innerHTML = '<span class="success">Correct!</span>';
                    currentPrompt++;
                    setTimeout(showPrompt, 500);
                } else {
                    document.getElementById('raceFeedback').innerHTML = 
                        `<span class="error">Try again! Expected: ${correctAnswer}</span>`;
                    input.select();
                }
            };
            
            function endRace() {
                document.getElementById('raceChallenge').innerHTML = `
                    <h3>Time's Up!</h3>
                    <p>You created ${score} variables in 30 seconds!</p>
                    <p>${score >= 6 ? 'Excellent speed!' : score >= 4 ? 'Good job!' : 'Keep practicing!'}</p>
                    <button onclick="closeGame()">Close</button>
                `;
            }
            
            const timerInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('raceTimer').textContent = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    endRace();
                }
            }, 1000);
            
            showPrompt();
        }
        // Extension section functions
        function toggleExtension() {
            const section = document.getElementById('extensionSection');
            const arrow = document.getElementById('extensionArrow');
            
            if (section.style.display === 'none' || section.style.display === '') {
                section.style.display = 'block';
                arrow.textContent = '‚ñº';
            } else {
                section.style.display = 'none';
                arrow.textContent = '‚ñ∂';
            }
        }

        function showExtensionTopic(topic) {
            const taskContent = document.getElementById('taskContent');
            const extensionContentContainer = document.getElementById('extensionContentContainer'); // Assuming you'll wrap extension content

            if (!extensionContentContainer) {
                // Create container if it doesn't exist, or ensure worksheet-container can host it
                // For simplicity, let's assume taskContent's parent can be used or taskContent itself is cleared
                console.warn("Extension content container not found. Displaying in taskContent.");
            }

            // Hide task content and show extension content
            taskContent.style.display = 'none';
            // If using a dedicated extension container:
            // extensionContentContainer.style.display = 'block';
            // extensionContentContainer.innerHTML = getExtensionContent(topic);
            
            // For now, let's reuse taskContent for extension display
            taskContent.innerHTML = getExtensionContent(topic);
            taskContent.style.display = 'block'; // Ensure it's visible

            // Update active states - remove active from tasks
            document.querySelectorAll('.task-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.extension-item').forEach(item => item.classList.remove('active'));
            
            // Add active to clicked extension item
            // Find the clicked item, e.g., by matching onclick text or a data attribute
            document.querySelectorAll('.extension-item').forEach(item => {
                if (item.getAttribute('onclick') && item.getAttribute('onclick').includes(`showExtensionTopic('${topic}')`)) {
                    item.classList.add('active');
                }
            });
            
            // Destroy any existing non-assessment, non-extension editors
            Object.keys(editors).forEach(key => {
                if (editors[key] && !key.startsWith('assess') && !key.startsWith('ext-')) {
                    editors[key].toTextArea();
                    delete editors[key];
                }
            });
            
            // Initialize CodeMirror for extension textareas
            setTimeout(() => {
                taskContent.querySelectorAll('textarea.extension-code[id]').forEach(textarea => {
                    const editorId = textarea.id;
                    if (editors[editorId]) { // Destroy if exists
                        editors[editorId].toTextArea();
                        delete editors[editorId];
                    }
                    const editor = CodeMirror.fromTextArea(textarea, {
                        mode: 'python',
                        theme: currentTheme,
                        lineNumbers: true,
                        indentUnit: 4,
                        autoCloseBrackets: true,
                        matchBrackets: true,
                        readOnly: textarea.hasAttribute('readonly')
                    });
                    editor.setSize("100%", textarea.hasAttribute('readonly') ? "auto" : "150px");
                    editor.refresh();
                    editors[editorId] = editor; 
                });
            }, 100);
        }

        function getExtensionContent(topic) {
            // Placeholder content for Section 2 extension topics
            const topicsData = {
                'variable-types': {
                    title: 'Variable Types (int, float, str, bool)',
                    content: `<h3>Understanding Variable Types</h3><p>Python automatically determines the type of a variable. Common types include integers (<code>int</code>), floating-point numbers (<code>float</code>), strings (<code>str</code>), and booleans (<code>bool</code>).</p><pre>age = 25  # int\nprice = 19.99  # float\nname = "Alice"  # str\nis_student = True  # bool</pre><h4>Try it:</h4><p>Create variables of different types and print them along with their type using <code>type()</code>.</p><textarea class="extension-code" id="ext-var-types"># Example:\nmy_number = 10\nprint(my_number, type(my_number))</textarea><button onclick="runExtensionCode('ext-var-types')" class="run-btn">‚ñ∂ Run</button><button onclick="checkExtensionComplete('variable-types', 'ext-var-types')" class="check-btn">‚úì Check</button><div class="output-panel"><div class="output-header">Output</div><div class="output-content" id="output-ext-var-types"></div></div><div id="feedback-ext-var-types"></div>`
                },
                'input-variables': {
                    title: 'Getting User Input into Variables',
                    content: `<h3>User Input</h3><p>The <code>input()</code> function allows you to get text input from the user. This input is always a string, so you might need to convert it using <code>int()</code> or <code>float()</code> if you expect a number.</p><pre>user_name = input("Enter your name: ")\nuser_age_str = input("Enter your age: ")\nuser_age_int = int(user_age_str)</pre><h4>Try it:</h4><p>Ask the user for their favorite color and a number, then print a message using both.</p><textarea class="extension-code" id="ext-input-vars"># Your code here</textarea><button onclick="runExtensionCode('ext-input-vars')" class="run-btn">‚ñ∂ Run</button><button onclick="checkExtensionComplete('input-variables', 'ext-input-vars')" class="check-btn">‚úì Check</button><div class="output-panel"><div class="output-header">Output</div><div class="output-content" id="output-ext-input-vars"></div></div><div id="feedback-ext-input-vars"></div>`
                },
                'f-strings': {
                    title: 'F-String Formatting',
                    content: `<h3>Formatted String Literals (F-Strings)</h3><p>F-strings provide a concise and convenient way to embed expressions inside string literals for formatting.</p><pre>name = "Bob"\nage = 30\nmessage = f"Hello, {name}. You are {age} years old."\nprint(message)</pre><h4>Try it:</h4><p>Create variables for an item and its price, then print them in a sentence using an f-string.</p><textarea class="extension-code" id="ext-f-strings">item = "laptop"\nprice = 1200.50\n# Your f-string print statement here</textarea><button onclick="runExtensionCode('ext-f-strings')" class="run-btn">‚ñ∂ Run</button><button onclick="checkExtensionComplete('f-strings', 'ext-f-strings')" class="check-btn">‚úì Check</button><div class="output-panel"><div class="output-header">Output</div><div class="output-content" id="output-ext-f-strings"></div></div><div id="feedback-ext-f-strings"></div>`
                },
                'global-local': {
                    title: 'Global vs Local Variables',
                    content: `<h3>Scope of Variables</h3><p>Variables defined inside a function are local to that function. Variables defined outside are global. To modify a global variable inside a function, you need the <code>global</code> keyword.</p><pre>x = 10  # global\n\ndef my_func():\n  y = 5  # local\n  global x\n  x = x + y\n  print(f"Inside function: x={x}, y={y}")\n\nmy_func()\nprint(f"Outside function: x={x}")</pre><h4>Try it:</h4><p>Experiment with global and local variables.</p><textarea class="extension-code" id="ext-global-local"># Your code here</textarea><button onclick="runExtensionCode('ext-global-local')" class="run-btn">‚ñ∂ Run</button><button onclick="checkExtensionComplete('global-local', 'ext-global-local')" class="check-btn">‚úì Check</button><div class="output-panel"><div class="output-header">Output</div><div class="output-content" id="output-ext-global-local"></div></div><div id="feedback-ext-global-local"></div>`
                },
                'variable-swapping': {
                    title: 'Variable Swapping Techniques',
                    content: `<h3>Swapping Values</h3><p>How can you swap the values of two variables?</p><p><strong>Method 1 (Using a temporary variable):</strong></p><pre>a = 5\nb = 10\ntemp = a\na = b\nb = temp</pre><p><strong>Method 2 (Pythonic way):</strong></p><pre>a = 5\nb = 10\na, b = b, a</pre><h4>Try it:</h4><p>Swap the values of two variables and print them before and after.</p><textarea class="extension-code" id="ext-var-swap">a = "apple"\nb = "banana"\n# Your swapping code here\nprint(f"After swap: a={a}, b={b}")</textarea><button onclick="runExtensionCode('ext-var-swap')" class="run-btn">‚ñ∂ Run</button><button onclick="checkExtensionComplete('variable-swapping', 'ext-var-swap')" class="check-btn">‚úì Check</button><div class="output-panel"><div class="output-header">Output</div><div class="output-content" id="output-ext-var-swap"></div></div><div id="feedback-ext-var-swap"></div>`
                }
            };
            const topicData = topicsData[topic];
            if (topicData) {
                return `<div class="task-header"><div class="task-header-left"><h2>${topicData.title}</h2></div></div><div class="instructions">${topicData.content}</div>`;
            }
            return '<p>Topic not found</p>';
        }

        async function runExtensionCode(editorId) {
            if (!pyodide) {
                alert('Python environment not ready');
                return;
            }
            
            const outputDiv = document.getElementById(`output-${editorId}`);
            let code;

            if (editors[editorId]) {
                code = editors[editorId].getValue();
            } else {
                const textarea = document.getElementById(editorId);
                if (textarea) code = textarea.value;
                else {
                    if(outputDiv) outputDiv.innerHTML = '<span class="error">Editor not found.</span>';
                    return;
                }
            }
            
            if(outputDiv) outputDiv.innerHTML = '<span class="loading">Running...</span>';
            
            try {
                pyodide.runPython(`
import sys
from io import StringIO
output_buffer = StringIO()
old_stdout = sys.stdout
sys.stdout = output_buffer
                `);
                pyodide.runPython(code);
                pyodide.runPython(`
sys.stdout = old_stdout
output_text = output_buffer.getvalue()
output_buffer.close()
                `);
                const output = pyodide.globals.get('output_text');
                if(outputDiv) outputDiv.innerHTML = `<pre>${output || 'No output'}</pre>`;
            } catch (error) {
                if(outputDiv) outputDiv.innerHTML = `<span class="error">Error: ${error.message}</span>`;
            }
        }

        async function checkExtensionComplete(topic, editorId) {
            const feedbackDiv = document.getElementById(`feedback-${editorId}`);
            let code;
            if (editors[editorId]) {
                code = editors[editorId].getValue();
            } else {
                const textarea = document.getElementById(editorId);
                 if (textarea) code = textarea.value;
                else {
                    if(feedbackDiv) feedbackDiv.innerHTML = '<div class="test-result test-fail">Editor not found.</div>';
                    return;
                }
            }
            
            const outputDiv = document.getElementById(`output-${editorId}`);
            const output = outputDiv ? (outputDiv.textContent || '') : '';
            
            const check = extensionChecks[topic];
            if (check && check.check(code, output)) {
                if (!extensionProgress[topic].completed) {
                    extensionProgress[topic].completed = true;
                    const xpEarned = extensionProgress[topic].xp;
                    if(feedbackDiv) feedbackDiv.innerHTML = `<div class="test-result test-pass">‚úì Excellent work! <span class="xp-gained">+${xpEarned} XP</span></div>`;
                    awardXP(xpEarned);
                    updateExtensionStatus(topic);
                    checkExtensionBadges();
                    saveExtensionProgress();
                     if (Object.values(extensionProgress).filter(e => e.completed).length === 1 && !userProfile.badges.includes('extension-explorer')) {
                        showAchievement('üöÄ', 'Extension Explorer!', 'You completed your first extension activity!', 20); // Example XP
                        userProfile.badges.push('extension-explorer'); // Add a generic badge if not specific ones
                    }
                } else {
                    if(feedbackDiv) feedbackDiv.innerHTML = `<div class="test-result test-pass">‚úì Correct! Already completed.</div>`;
                }
            } else {
                if(feedbackDiv) feedbackDiv.innerHTML = `<div class="test-result test-fail">Not quite right. ${check ? check.hint : 'Try again!'}</div>`;
            }
        }

        function updateExtensionStatus(topic) {
            const statusElement = document.getElementById(`ext-status-${topic}`);
            if (statusElement) {
                statusElement.classList.add('completed');
                statusElement.textContent = '‚úì';
            }
            document.querySelectorAll('.extension-item').forEach(item => {
                if (item.getAttribute('onclick') && item.getAttribute('onclick').includes(`showExtensionTopic('${topic}')`)) {
                    item.classList.add('completed');
                }
            });
        }

        function checkExtensionBadges() {
            // This function can be expanded if specific extension badges are added to the BADGES object
            // For now, it's a placeholder or can trigger generic extension completion achievements
            const completedCount = Object.values(extensionProgress).filter(e => e.completed).length;
            if (completedCount > 0 && !userProfile.badges.includes('extension-explorer')) {
                 // userProfile.badges.push('extension-explorer'); // Example
                 // showAchievement('üöÄ', 'Extension Explorer', 'Completed an extension!', 25);
            }
            if (completedCount === Object.keys(extensionProgress).length && !userProfile.badges.includes('extension-master')) {
                // userProfile.badges.push('extension-master'); // Example
                // showAchievement('üåü', 'Extension Master', 'Completed all extensions!', 100);
            }
            updateBadgeDisplay(); // Refresh badge display in header
        }

        function saveExtensionProgress() {
            localStorage.setItem('pythonWorksheetSection2ExtensionProgress', JSON.stringify(extensionProgress));
        }
        // Disable copy/paste globally for the page
        document.addEventListener('DOMContentLoaded', function() {
            // Disable text selection on the page (except in editors)
            document.addEventListener('selectstart', function(e) {
                if (e.target && e.target.closest && e.target.closest('.CodeMirror')) {
                    e.preventDefault();
                }
            });
            
            // Disable copy keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if ((e.ctrlKey || e.metaKey) && (e.key === 'c' || e.key === 'x' || e.key === 'v')) {
                    if (e.target.closest('.CodeMirror')) {
                        return; // Allow in CodeMirror
                    }
                    e.preventDefault();
                    return false;
                }
            });
            
            // Disable right-click context menu
            document.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                return false;
            });
        });
        
        // Initialize everything
        window.addEventListener('load', () => {
            // Load saved data
            const savedTaskProgress = localStorage.getItem('pythonWorksheetSection2TaskProgress');
            if (savedTaskProgress) {
                try {
                    taskProgress = JSON.parse(savedTaskProgress);
                } catch (e) {
                    console.error('Failed to parse task progress:', e);
                }
            }
            
            const savedUserProfile = localStorage.getItem('pythonWorksheetSection2UserProfile');
            if (savedUserProfile) {
                try {
                    userProfile = JSON.parse(savedUserProfile);
                } catch (e) {
                    console.error('Failed to parse user profile:', e);
                }
            }
            
            const savedSettings = localStorage.getItem('pythonWorksheetSection2Settings');
            if (savedSettings) {
                try {
                    settings = JSON.parse(savedSettings);
                    
                    // Apply settings
                    if (settings.dyslexicFont) {
                        document.body.classList.add('dyslexic-font');
                        document.getElementById('dyslexicToggle').classList.add('active');
                    }
                    if (settings.audioEnabled) {
                        document.getElementById('audioToggle').classList.add('active');
                    }
                    if (!settings.syntaxCheckEnabled) {
                        document.getElementById('syntaxToggle').classList.remove('active');
                    }
                } catch (e) {
                    console.error('Failed to parse settings:', e);
                }
            }
            
            // Load extension progress
            const savedExtensionProgress = localStorage.getItem('pythonWorksheetSection2ExtensionProgress');
            if (savedExtensionProgress) {
                try {
                    extensionProgress = JSON.parse(savedExtensionProgress);
                    // Update extension status indicators
                    Object.keys(extensionProgress).forEach(topic => {
                        if (extensionProgress[topic].completed) {
                            updateExtensionStatus(topic);
                        }
                    });
                } catch (e) {
                    console.error('Failed to parse extension progress:', e);
                }
            }
            
            // Check for daily streak
            const today = new Date().toDateString();
            if (userProfile.lastLogin !== today) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                
                if (userProfile.lastLogin === yesterday.toDateString()) {
                    userProfile.streak++;
                    if (userProfile.streak === 5 && !userProfile.badges.includes('streak')) {
                        userProfile.badges.push('streak');
                        showAchievement('üî•', '5-Day Streak!', 'You\'ve been coding for 5 days straight!', 100);
                    }
                } else {
                    userProfile.streak = 1;
                }
                
                userProfile.lastLogin = today;
                saveAllProgress();
            }
            
            // Initialize displays
            updateProgress();
            updateUserStats();
            updateBadgeDisplay();
            
            // Initialize first task
            switchTask(1);
            
            // Initialize Pyodide
            initializePyodide();
        });
        
        // Make functions globally available for onclick handlers
        window.switchTask = switchTask;
        window.runCode = runCode;
        window.checkCode = checkCode;
        window.showHint = showHint;
        window.resetCode = resetCode;
        window.nextTask = nextTask;
        window.toggleDyslexicFont = toggleDyslexicFont;
        window.toggleAudio = toggleAudio;
        window.toggleSyntaxCheck = toggleSyntaxCheck;
        window.toggleAudioInstructions = toggleAudioInstructions;
        window.stopAudio = stopAudio;
        window.downloadProgress = downloadProgress;
        window.resetSection = resetSection;
        window.runAssessmentCode = runAssessmentCode;
        window.checkAssessmentCode = checkAssessmentCode;
        window.checkTextAnswer = checkTextAnswer;
        window.checkMCAnswer = checkMCAnswer;
        window.submitAssessment = submitAssessment;
        window.toggleExtension = toggleExtension;
        window.showExtensionTopic = showExtensionTopic;
        window.runExtensionCode = runExtensionCode;
        window.checkExtensionComplete = checkExtensionComplete;
        window.startSimulation = startSimulation;
        window.closeGame = closeGame;        window.switchTask = switchTask;
        window.runCode = runCode;
        window.checkCode = checkCode;
        window.showHint = showHint;
        window.resetCode = resetCode;
        window.nextTask = nextTask;
        window.toggleDyslexicFont = toggleDyslexicFont;
        window.toggleAudio = toggleAudio;
        window.toggleSyntaxCheck = toggleSyntaxCheck;
        window.toggleAudioInstructions = toggleAudioInstructions;
        window.stopAudio = stopAudio;
        window.downloadProgress = downloadProgress;
        window.resetSection = resetSection;
        window.runAssessmentCode = runAssessmentCode;
        window.checkAssessmentCode = checkAssessmentCode;
        window.checkTextAnswer = checkTextAnswer;
        window.checkMCAnswer = checkMCAnswer;
        window.submitAssessment = submitAssessment;
        window.toggleExtension = toggleExtension;
        window.showExtensionTopic = showExtensionTopic;
        window.runExtensionCode = runExtensionCode;
        window.checkExtensionComplete = checkExtensionComplete;
        window.startSimulation = startSimulation;
        window.closeGame = closeGame;

    </script>
</body>
</html>