<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Year 9 Python Course - Section 5: Mathematical Operators</title>
    
    <!-- External Dependencies (Required - DO NOT MODIFY VERSIONS) -->
    <!-- CodeMirror CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/solarized.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldgutter.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/lint/lint.min.css">

    <!-- Sound Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    
    <!-- Pyodide -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    
    <!-- CodeMirror JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/python-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldgutter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/brace-fold.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/indent-fold.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/lint/lint.min.js"></script>
    
    <!-- Font for dyslexia support -->
    <link href="https://fonts.googleapis.com/css2?family=OpenDyslexic:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* CSS Variables for Mathematical Operators Theme */
        :root {
            --primary-color: #f97316; /* Orange for math */
            --primary-dark: #ea580c;
            --primary-light: #fb923c;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --xp-color: #8b5cf6;
            --bg-primary: #fff7ed;
            --bg-secondary: white;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        /* Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        body.dyslexic-font {
            font-family: 'OpenDyslexic', sans-serif;
        }

        /* Header Styles */
        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 1.5rem 0;
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '+ - × ÷ % ^';
            position: absolute;
            font-size: 150px;
            opacity: 0.1;
            right: -50px;
            top: -20px;
            transform: rotate(-15deg);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 1;
        }

        .header-left h1 {
            font-size: 2rem;
            margin-bottom: 0.25rem;
            font-weight: 700;
        }

        .header-left p {
            font-size: 1.1rem;
            opacity: 0.95;
        }

        /* User Stats */
        .user-stats {
            display: flex;
            gap: 2rem;
            background: rgba(255, 255, 255, 0.15);
            padding: 1rem 1.5rem;
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }

        .stat-item {
            text-align: center;
            min-width: 80px;
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        .xp-bar {
            width: 100px;
            height: 6px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
            margin-top: 0.5rem;
            overflow: hidden;
        }

        .xp-fill {
            height: 100%;
            background: var(--xp-color);
            transition: width 0.5s ease;
            border-radius: 3px;
        }

        /* Progress Section */
        .progress-section {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem 2rem 1rem 2rem;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: white;
            transition: width 0.5s ease;
            border-radius: 5px;
        }

        .badges-preview {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .badge {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            filter: grayscale(100%);
            opacity: 0.5;
        }

        .badge.earned {
            filter: grayscale(0%);
            opacity: 1;
            background: rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
        }

        .badge:hover {
            transform: scale(1.1);
        }

        /* Main Container */
        .main-container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 2rem;
            min-height: calc(100vh - 300px);
        }

        /* Sidebar */
        .sidebar {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--shadow-md);
            height: fit-content;
            position: sticky;
            top: 2rem;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--primary-light);
        }

        .task-list {
            list-style: none;
            margin-bottom: 1.5rem;
        }

        .task-item {
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .task-item:hover {
            background: var(--bg-primary);
            border-color: var(--primary-light);
        }

        .task-item.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .task-item.completed {
            border-left: 4px solid var(--success-color);
        }

        .task-xp {
            font-size: 0.75rem;
            opacity: 0.7;
            font-weight: 500;
        }

        /* Extension Toggle */
        .extension-toggle {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: var(--primary-light);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 1rem;
        }

        .extension-toggle:hover {
            background: var(--primary-color);
        }

        .extension-icon {
            font-size: 1.25rem;
        }

        .extension-arrow {
            margin-left: auto;
            transition: transform 0.3s ease;
        }

        .extension-arrow.open {
            transform: rotate(90deg);
        }

        .extension-section {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--bg-primary);
            border-radius: 8px;
        }

        /* Content Area */
        .content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: var(--shadow-md);
            min-height: 600px;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
        }

        .task-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .task-type {
            display: inline-block;
            padding: 0.25rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
            text-transform: uppercase;
        }

        .task-type.example { background: #dbeafe; color: #1e40af; }
        .task-type.practice { background: #d1fae5; color: #065f46; }
        .task-type.challenge { background: #fef3c7; color: #92400e; }
        .task-type.assessment { background: #ede9fe; color: #5b21b6; }

        /* Instructions */
        .instructions {
            margin-bottom: 2rem;
            line-height: 1.8;
        }

        .instructions h3 {
            color: var(--primary-color);
            margin: 1.5rem 0 0.75rem 0;
            font-size: 1.2rem;
        }

        .instructions pre {
            background: #f3f4f6;
            padding: 1rem;
            border-radius: 8px;
            overflow-x: auto;
            margin: 1rem 0;
            border-left: 4px solid var(--primary-color);
        }

        .instructions ul, .instructions ol {
            margin: 0.5rem 0 0.5rem 2rem;
        }

        .instructions li {
            margin: 0.5rem 0;
        }

        .instructions .why-matters,
        .instructions .common-mistake {
            margin: 1.5rem 0;
        }

        /* Code Editor */
        .editor-container {
            margin: 1.5rem 0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }

        .editor-header {
            background: var(--text-primary);
            color: white;
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .editor-title {
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .editor-actions {
            display: flex;
            gap: 0.5rem;
        }

        .editor-btn {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 0.4rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .editor-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .editor-btn.run {
            background: var(--success-color);
            border-color: var(--success-color);
        }

        .editor-btn.run:hover {
            background: #059669;
        }

        .CodeMirror {
            height: 300px;
            font-size: 1rem;
        }

        /* Output Panel */
        .output-panel {
            margin-top: 1rem;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }

        .output-header {
            background: #f9fafb;
            padding: 0.75rem 1rem;
            font-weight: 500;
            border-bottom: 1px solid var(--border-color);
        }

        .output-content {
            padding: 1rem;
            font-family: 'Courier New', monospace;
            min-height: 100px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            line-height: 1.5;
        }

        .output-content .type-indicator {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 0.75rem;
            vertical-align: super;
            margin-left: 0.5rem;
        }

        .output-content.error {
            color: var(--error-color);
        }

        /* Control Buttons */
        .controls {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: #f3f4f6;
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        /* Hints */
        .hint-box {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            display: none;
        }

        .hint-box.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        .hint-header {
            font-weight: 600;
            color: #92400e;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Checks */
        .checks-container {
            margin-top: 2rem;
            padding: 1.5rem;
            background: #f9fafb;
            border-radius: 8px;
        }

        .check-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
            padding: 0.5rem;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .check-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .check-icon.pending {
            background: #e5e7eb;
            color: #6b7280;
        }

        .check-icon.passed {
            background: var(--success-color);
            color: white;
        }

        .check-icon.failed {
            background: var(--error-color);
            color: white;
        }

        /* Achievement Notification */
        .achievement {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: white;
            padding: 1.5rem 2rem;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 1rem;
            opacity: 0;
            transform: translateX(400px);
            transition: all 0.5s ease;
            z-index: 1000;
            border-left: 4px solid var(--xp-color);
        }

        .achievement.show {
            opacity: 1;
            transform: translateX(0);
        }

        .achievement-icon {
            font-size: 2.5rem;
        }

        .achievement-content h3 {
            margin-bottom: 0.25rem;
            color: var(--text-primary);
        }

        .achievement-xp {
            color: var(--xp-color);
            font-weight: 600;
        }

        /* Why This Matters Box */
        .why-matters {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #f59e0b;
            border-radius: 8px;
            padding: 1rem;
            margin: 1.5rem 0;
            position: relative;
            overflow: hidden;
        }

        .why-matters::before {
            content: '💡';
            position: absolute;
            font-size: 60px;
            opacity: 0.1;
            right: 10px;
            top: -10px;
        }

        .why-matters h4 {
            color: #92400e;
            margin: 0 0 0.5rem 0;
            font-size: 1.1rem;
        }

        .why-matters p {
            color: #78350f;
            margin: 0;
            position: relative;
            z-index: 1;
        }

        /* Common Mistake Box */
        .common-mistake {
            background: #fee2e2;
            border: 2px solid #ef4444;
            border-radius: 8px;
            padding: 1rem;
            margin: 1.5rem 0;
            position: relative;
        }

        .common-mistake h4 {
            color: #991b1b;
            margin: 0 0 0.5rem 0;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .common-mistake p {
            color: #7f1d1d;
            margin: 0.5rem 0;
        }

        .common-mistake pre,
        .common-mistake code {
            background: #fef2f2;
            border-left: 4px solid #ef4444;
            padding: 0.75rem;
            margin: 0.5rem 0;
            color: #991b1b;
        }

        /* Number Type Indicator */
        .type-indicator {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
            margin-left: 0.5rem;
        }

        .type-indicator.int {
            background: #dbeafe;
            color: #1e40af;
        }

        .type-indicator.float {
            background: #d1fae5;
            color: #065f46;
        }

        /* Assessment & Worksheet Styles */
        .worksheet-section {
            margin-top: 2rem;
        }
        .worksheet-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
        }
        .worksheet-question {
            background-color: #f9fafb;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .worksheet-question h4 {
            margin: 0 0 1rem 0;
            font-weight: 600;
        }
        .worksheet-answer {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
        }
        .worksheet-answer:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
        }
        .worksheet-code {
            background: #f3f4f6;
            padding: 1rem;
            border-radius: 8px;
            overflow-x: auto;
            margin: 1rem 0;
            border-left: 4px solid var(--primary-light);
            font-family: 'Courier New', monospace;
        }

        /* Accessibility Features */
        .accessibility-menu {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            padding: 1rem;
            display: none;
            z-index: 999;
        }

        .accessibility-toggle {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 56px;
            height: 56px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s ease;
            z-index: 998;
        }

        .accessibility-toggle:hover {
            transform: scale(1.1);
            background: var(--primary-dark);
        }

        /* Animations */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .main-container {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                position: static;
                margin-bottom: 2rem;
            }
            
            .header-content {
                flex-direction: column;
                gap: 1.5rem;
                text-align: center;
            }
            
            .user-stats {
                width: 100%;
                justify-content: center;
            }
        }

        @media (max-width: 640px) {
            .header-left h1 {
                font-size: 1.5rem;
            }
            
            .content {
                padding: 1rem;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .achievement {
                right: 1rem;
                left: 1rem;
                top: auto;
                bottom: 5rem;
            }
        }

        /* Loading State */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 200px;
            color: var(--text-secondary);
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60% { content: '...'; }
            80%, 100% { content: ''; }
        }

        /* Game Selection Screen Styles */
        .game-selection-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }
        
        .game-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-sm);
        }
        
        .game-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-md);
        }
        
        .game-card h3 {
            margin-top: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-primary);
        }
        
        .game-card p {
            flex-grow: 1;
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
            font-size: 0.95rem;
        }
        
        .play-btn {
            background-color: var(--success-color);
            color: white;
            text-decoration: none;
            text-align: center;
            justify-content: center;
            width: 100%;
        }
        
        .play-btn:hover {
            background-color: #059669;
        }
        
        .game-card.disabled {
            opacity: 0.6;
            background: #f8fafc;
        }
        
        .game-card.disabled:hover {
            transform: none;
            box-shadow: var(--shadow-sm);
        }
        
        .game-card.disabled .play-btn {
            background-color: var(--text-secondary);
            cursor: not-allowed;
        }

        /* Game Modal Styles */
        .game-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            transition: opacity 0.3s ease;
        }
        
        .game-modal {
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 2rem;
            width: 90%;
            max-width: 500px;
            text-align: center;
            box-shadow: var(--shadow-lg);
            position: relative;
            transform: scale(0.95);
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .game-modal-overlay.show {
            display: flex;
            opacity: 1;
        }
        
        .game-modal-overlay.show .game-modal {
            transform: scale(1);
            opacity: 1;
        }
        
        .game-modal h2 {
            margin-top: 0;
            color: var(--primary-dark);
        }
        
        .game-modal .close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
        }
        
        .game-stats {
            display: flex;
            justify-content: space-around;
            font-size: 1.25rem;
            margin: 1.5rem 0;
        }
        
        .game-problem {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 1.5rem 0;
            color: var(--text-primary);
            background: white;
            padding: 1rem;
            border-radius: 8px;
            border: 2px solid var(--border-color);
        }
        
        .game-input {
            width: 100%;
            padding: 1rem;
            font-size: 1.5rem;
            text-align: center;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .game-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.2);
        }
        
        .game-input.correct {
            border-color: var(--success-color);
            background-color: #d1fae5;
            animation: pulse-green 0.3s;
        }
        
        .game-input.incorrect {
            border-color: var(--error-color);
            background-color: #fee2e2;
            animation: shake 0.3s;
        }
        
        .game-feedback {
            min-height: 1.5rem;
            margin-top: 1rem;
            color: var(--error-color);
            font-weight: 500;
        }
        
        .game-final-score strong {
            font-size: 2rem;
            color: var(--primary-color);
        }
        
        @keyframes pulse-green {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Mini Game Icon */
        .game-icon {
            font-size: 1.1rem;
        }

        /* Extension content styles */
        .extension-header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
        }

        .extension-content {
            line-height: 1.8;
        }

        .concept-section {
            margin-bottom: 2rem;
        }

        .example-box {
            background: #f9fafb;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-left: 4px solid var(--primary-color);
        }

        .example-box h4 {
            margin-top: 0;
            color: var(--primary-color);
        }

        .try-it {
            margin-top: 2rem;
        }

        .try-it h4 {
            color: var(--primary-dark);
            margin-bottom: 1rem;
        }

        .extension-editor-container {
            margin: 1rem 0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }
    </style>
</head>
<body oncopy="return false" oncut="return false" onpaste="return false">
    <!-- Header with gradient background -->
    <div class="header">
        <div class="header-content">
            <div class="header-left">
                <h1>Year 9 Python Programming</h1>
                <p>Section 5 - Mathematical Operators</p>
            </div>
            <div class="user-stats">
                <div class="stat-item">
                    <div class="stat-value" id="userLevel">1</div>
                    <div class="stat-label">Level</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="userXP">0</div>
                    <div class="stat-label">XP</div>
                    <div class="xp-bar">
                        <div class="xp-fill" id="xpFill" style="width: 0%"></div>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="userStreak">0</div>
                    <div class="stat-label">Day Streak</div>
                </div>
            </div>
        </div>
        
        <!-- Progress bar and badges -->
        <div class="progress-section">
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar"></div>
            </div>
            <p style="margin: 5px 0 0 0; font-size: 14px; color: white;">
                Progress: <span id="progressText">0/18 tasks completed</span>
            </p>
            <div class="badges-preview">
                <div class="badge" id="badge-calculator" title="Calculator Master - Complete all basic arithmetic tasks">🧮</div>
                <div class="badge" id="badge-precision" title="Precision Expert - Complete all float-related tasks">🎯</div>
                <div class="badge" id="badge-modulus" title="Modulus Master - Complete all modulus tasks">🔢</div>
                <div class="badge" id="badge-wizard" title="Math Wizard - Complete the final challenge without hints">🚀</div>
                <div class="badge" id="badge-perfect" title="Perfect Score - Complete 5 tasks without using hints">⭐</div>
                <div class="badge" id="badge-mental" title="Mental Math Master - Complete 3 tasks on first try">🧠</div>
                <div class="badge" id="badge-predictor" title="Type Predictor - Correctly identify int vs float in 5 tasks">🔮</div>
                <div class="badge" id="badge-scholar" title="Math Scholar - Complete the final assessment">🎓</div>
                <div class="badge" id="badge-champion" title="Section Champion - Complete all tasks and extensions">🏆</div>
            </div>
        </div>
    </div>

    <!-- Main content area -->
    <div class="main-container">
        <!-- Sidebar navigation -->
        <aside class="sidebar">
            <div class="section-title">Section 5 - Mathematical Operators</div>
            <ul class="task-list" id="taskList">
                <!-- Task items will be dynamically generated -->
            </ul>
            
            <!-- Extension activities toggle -->
            <div class="extension-toggle" onclick="toggleExtension()">
                <span class="extension-icon">🚀</span>
                <span class="extension-text">Extension Activities</span>
                <span class="extension-arrow" id="extensionArrow">▶</span>
            </div>
            <div class="extension-section" id="extensionSection" style="display: none;">
                <div class="task-item" onclick="showExtensionTopic('compound-interest')">
                    <span>Compound Interest Calculator</span>
                    <span class="task-xp">50 XP</span>
                </div>
                <div class="task-item" onclick="showExtensionTopic('even-odd')">
                    <span>Even/Odd Checker</span>
                    <span class="task-xp">30 XP</span>
                </div>
                <div class="task-item" onclick="showExtensionTopic('advanced-calc')">
                    <span>Advanced Calculator</span>
                    <span class="task-xp">50 XP</span>
                </div>
                <div class="task-item" onclick="showExtensionTopic('number-properties')">
                    <span>Number Properties Explorer</span>
                    <span class="task-xp">40 XP</span>
                </div>
                <div class="task-item" onclick="showExtensionTopic('unit-converter')">
                    <span>Unit Converter</span>
                    <span class="task-xp">50 XP</span>
                </div>
                <div class="task-item" onclick="showExtensionTopic('compound-operators')">
                    <span>Compound Assignment Operators</span>
                    <span class="task-xp">30 XP</span>
                </div>
                <div class="task-item" onclick="showExtensionTopic('math-patterns')">
                    <span>Math Curiosities</span>
                    <span class="task-xp">40 XP</span>
                </div>
                <div class="task-item" onclick="showGameScreen()">
                    <span class="game-icon">🎮</span>
                    <span>Mini Games</span>
                </div>
            </div>
        </aside>
        
        <!-- Main content area -->
        <main class="content">
            <div id="taskContent">
                <div class="loading">Loading Python environment</div>
            </div>
            <div id="extensionContent" style="display: none;">
                <!-- Extension content loads here -->
            </div>
            <div id="gameContent" style="display: none;">
                <!-- Game selection screen loads here -->
            </div>
        </main>
    </div>

    <!-- Game Modal HTML -->
    <div class="game-modal-overlay" id="gameModalOverlay">
        <div class="game-modal" id="gameModal">
            <button class="close-btn" onclick="closeGameModal()">&times;</button>
            <div id="gameStartScreen">
                <h2>Arithmetic Ace 🚀</h2>
                <p>Solve as many math problems as you can in 60 seconds!</p>
                <button class="btn btn-primary" onclick="startGame()">Start Game</button>
            </div>
            <div id="gamePlayScreen" style="display: none;">
                <div class="game-stats">
                    <div>Time: <strong id="gameTimer">60</strong></div>
                    <div>Score: <strong id="gameScore">0</strong></div>
                </div>
                <div class="game-problem" id="gameProblem"></div>
                <input type="number" class="game-input" id="gameInput" placeholder="Type your answer...">
                <div class="game-feedback" id="gameFeedback"></div>
            </div>
            <div id="gameOverScreen" style="display: none;">
                <h2>Time's Up!</h2>
                <p class="game-final-score">Your score: <strong><span id="finalScore">0</span></strong></p>
                <p>High Score: <span id="highScore">0</span></p>
                <button class="btn btn-primary" onclick="startGame()">Play Again</button>
                <button class="btn btn-secondary" onclick="closeGameModal()">Back to Games</button>
            </div>
        </div>
    </div>

    <!-- Achievement notification -->
    <div class="achievement" id="achievementPopup">
        <div class="achievement-icon" id="achievementIcon">🏆</div>
        <div class="achievement-content">
            <h3 id="achievementTitle">Achievement Unlocked!</h3>
            <p id="achievementMessage">You've completed a task!</p>
            <p class="achievement-xp">+<span id="achievementXP">50</span> XP</p>
        </div>
    </div>

    <!-- Accessibility Menu -->
    <button class="accessibility-toggle" onclick="toggleAccessibility()" title="Accessibility Options">
        ♿
    </button>
    
    <div class="accessibility-menu" id="accessibilityMenu">
        <h3>Accessibility Options</h3>
        <label>
            <input type="checkbox" onchange="toggleDyslexicFont(this.checked)">
            Dyslexic-friendly font
        </label>
        <br>
        <label>
            <input type="checkbox" onchange="toggleHighContrast(this.checked)">
            High contrast mode
        </label>
    </div>

    <script>
        // Global variables
        let pyodide = null;
        let editors = {};
        let extensionEditors = {};
        let currentTask = 1;
        let userProgress = {
            completedTasks: {},
            hintsUsed: {},
            xp: 0,
            level: 1,
            streak: 0,
            lastVisit: new Date().toDateString(),
            badges: {},
            perfectTasks: 0,
            firstTryTasks: 0,
            taskAttempts: {},
            assessmentAnswers: {}
        };

        // Badge definitions
        const BADGES = {
            'calculator': { 
                icon: '🧮', 
                name: 'Calculator Master', 
                desc: 'Complete all basic arithmetic tasks',
                check: () => [1, 2, 3, 4].every(t => userProgress.completedTasks[t])
            },
            'precision': { 
                icon: '🎯', 
                name: 'Precision Expert', 
                desc: 'Complete all float-related tasks',
                check: () => [5, 6, 7].every(t => userProgress.completedTasks[t])
            },
            'modulus': { 
                icon: '🔢', 
                name: 'Modulus Master', 
                desc: 'Complete all modulus tasks',
                check: () => [10, 11, 12].every(t => userProgress.completedTasks[t])
            },
            'wizard': { 
                icon: '🚀', 
                name: 'Math Wizard', 
                desc: 'Complete the final challenge without hints',
                check: () => userProgress.completedTasks[17] && !userProgress.hintsUsed[17]
            },
            'perfect': { 
                icon: '⭐', 
                name: 'Perfect Score', 
                desc: 'Complete 5 tasks without using hints',
                check: () => userProgress.perfectTasks >= 5
            },
            'mental': { 
                icon: '🧠', 
                name: 'Mental Math Master', 
                desc: 'Complete 3 tasks on first try',
                check: () => userProgress.firstTryTasks >= 3
            },
            'predictor': { 
                icon: '🔮', 
                name: 'Type Predictor', 
                desc: 'Correctly identify int vs float in 5 tasks',
                check: () => {
                    const floatTasks = [4, 5, 6, 7, 14];
                    return floatTasks.filter(t => userProgress.completedTasks[t]).length >= 3;
                }
            },
            'scholar': { 
                icon: '🎓', 
                name: 'Math Scholar', 
                desc: 'Complete the final assessment',
                check: () => userProgress.completedTasks[18]
            },
            'champion': { 
                icon: '🏆', 
                name: 'Section Champion', 
                desc: 'Complete all tasks and extensions',
                check: () => Object.keys(userProgress.completedTasks).length >= 18 && 
                           Object.values(extensionProgress).filter(e => e.completed).length >= 7
            }
        };

        // Task definitions
        const tasks = {
            1: {
                id: "5a1b2c3d-4e5f-6g7h-8i9j-0k1l2m3n4o5p",
                title: "5.1 Addition and Subtraction",
                type: "example",
                xp: 50,
                instructions: `
                    <h3>Addition and Subtraction</h3>
                    <p>Integers can be added with the <code>+</code> operator and subtracted with the <code>-</code> operator.</p>
                    
                    <h3>Your Task</h3>
                    <p>Add another calculation to the code. Check it works correctly and then move on.</p>
                    
                    <h3>Example</h3>
                    <pre>print(10 + 5)   # Outputs: 15
print(10 - 5)   # Outputs: 5</pre>
                `,
                starterCode: `a = 15
b = 10

print(1 + 1)

print(a + b)
print(a - b)`,
                hints: [
                    "Try adding another print statement with a different calculation",
                    "You could try something like print(a + 5) or print(b - 3)",
                    "Add a line like: print(a + b - 5)"
                ],
                checks: [
                    {
                        name: "Code runs without errors",
                        test: (code, output) => !output.toLowerCase().includes('error')
                    },
                    {
                        name: "Contains at least 4 print statements",
                        test: (code, output) => (code.match(/print\s*\(/g) || []).length >= 4
                    },
                    {
                        name: "Uses addition or subtraction",
                        test: (code, output) => code.includes('+') || code.includes('-')
                    }
                ]
            },
            2: {
                id: "6b2c3d4e-5f6g-7h8i-9j0k-1l2m3n4o5p6q",
                title: "5.2 100th Birthday Calculator",
                type: "practice",
                xp: 75,
                instructions: `
                    <h3>Task - 100th Birthday</h3>
                    <p>Assuming a person was born in a given birthYear, print the year that person will turn 100 using <code>+</code>.</p>
                    
                    <h3>Your Task</h3>
                    <p>Calculate and print the year when someone born in 1999 will turn 100.</p>
                    
                    <h3>Expected Output</h3>
                    <pre>2099</pre>
                `,
                starterCode: `birthYear = 1999`,
                hints: [
                    "You need to add 100 to the birth year",
                    "Use a print statement to display the result",
                    "Try: print(birthYear + 100)"
                ],
                checks: [
                    {
                        name: "Calculates 100th birthday correctly",
                        test: (code, output) => output.trim().includes('2099')
                    },
                    {
                        name: "Uses the birthYear variable",
                        test: (code, output) => code.includes('birthYear')
                    },
                    {
                        name: "Uses addition operator",
                        test: (code, output) => code.includes('+')
                    }
                ]
            },
            3: {
                id: "7c3d4e5f-6g7h-8i9j-0k1l-2m3n4o5p6q7r",
                title: "5.3 Multiplication and Division",
                type: "example",
                xp: 50,
                instructions: `
                    <h3>Multiplication</h3>
                    <p>Numbers can be multiplied with the <code>*</code> operator and divided with the <code>/</code> operator.</p>
                    
                    <h3>Your Task</h3>
                    <ul>
                        <li>Display the result of b multiplied by d</li>
                        <li>Display the result of d divided by c</li>
                    </ul>
                    
                    <h3>Note</h3>
                    <p>In Python, we use <code>*</code> for multiplication (not ×) and <code>/</code> for division (not ÷)</p>
                `,
                starterCode: `a = 15
b = 10
c = 7
d = 4

print(a * b)
print(a / b)
print(a * b / d)`,
                hints: [
                    "You need to add two more print statements",
                    "First, multiply b by d: print(b * d)",
                    "Then divide d by c: print(d / c)"
                ],
                checks: [
                    {
                        name: "Multiplies b by d",
                        test: (code, output) => output.includes('40')
                    },
                    {
                        name: "Divides d by c",
                        test: (code, output) => output.includes('0.571') || output.includes('0.57')
                    },
                    {
                        name: "Uses multiplication and division",
                        test: (code, output) => code.includes('*') && code.includes('/')
                    }
                ]
            },
            4: {
                id: "8d4e5f6g-7h8i-9j0k-1l2m-3n4o5p6q7r8s",
                title: "5.4 Distance Calculator",
                type: "practice",
                xp: 100,
                instructions: `
                    <h3>How many miles did the car go?</h3>
                    <p>Given an average <code>speed</code> in miles per hour and a <code>time</code> in <em>minutes</em>, determine the distance the car travels (distance = speed × time).</p>
                    
                    <h3>Your Task</h3>
                    <ol>
                        <li>Calculate and print the distance traveled (should be 35 miles)</li>
                        <li>Calculate how much fuel was used if the car gets 28 miles per gallon</li>
                        <li>Print both results</li>
                    </ol>
                    
                    <h3>Important Note</h3>
                    <p>You'll need to convert minutes to hours first!</p>
                    
                    <div class="why-matters">
                        <h4>🌟 Why This Matters</h4>
                        <p>This type of calculation is used in GPS apps to estimate arrival times and fuel consumption!</p>
                    </div>
                `,
                starterCode: `speed = 70
time = 30
mpg = 28  # miles per gallon`,
                hints: [
                    "Remember that speed is in miles per hour, but time is in minutes",
                    "To convert minutes to hours, divide by 60",
                    "The formula is: distance = speed * (time / 60)",
                    "For fuel: fuel_used = distance / mpg"
                ],
                smartHints: {
                    '2100': "That's the result without converting minutes to hours. Divide time by 60 first!",
                    '35.0': "Correct distance! Now calculate the fuel consumption",
                    '1.25': "Perfect! That's the correct fuel consumption"
                },
                checks: [
                    {
                        name: "Calculates distance correctly",
                        test: (code, output) => output.includes('35')
                    },
                    {
                        name: "Calculates fuel consumption", 
                        test: (code, output) => output.includes('1.25')
                    },
                    {
                        name: "Converts minutes to hours",
                        test: (code, output) => code.includes('60') || code.includes('0.5')
                    },
                    {
                        name: "Uses division for fuel calculation",
                        test: (code, output) => code.includes('/ mpg') || code.includes('/mpg') || code.includes('/ 28') || code.includes('/28')
                    }
                ]
            },
            5: {
                id: "9e5f6g7h-8i9j-0k1l-2m3n-4o5p6q7r8s9t",
                title: "5.5 Understanding Floats",
                type: "example",
                xp: 50,
                instructions: `
                    <h3>Floats</h3>
                    <p>A <strong>float</strong> is a real number with decimal precision. Use a float when you need an exact numeric result that is not rounded down to the nearest integer.</p>
                    
                    <h3>Example</h3>
                    <pre>3.14159265</pre>
                    
                    <h3>The float() Function</h3>
                    <p>The <code>float</code> function converts its input to a float output.</p>
                    
                    <h3>Your Task</h3>
                    <p>Run the code to see how floats work, then experiment by converting other numbers to floats.</p>
                `,
                starterCode: `circumference = 22.0
diameter = 7

print(circumference / diameter)

x = 2

print( float(x) )`,
                hints: [
                    "Try converting different numbers to floats",
                    "Add a line like: print(float(10))",
                    "You could also try: y = 5 and then print(float(y))"
                ],
                checks: [
                    {
                        name: "Code runs without errors",
                        test: (code, output) => !output.toLowerCase().includes('error')
                    },
                    {
                        name: "Uses float() function",
                        test: (code, output) => code.includes('float(')
                    },
                    {
                        name: "Produces decimal output",
                        test: (code, output) => output.includes('.')
                    }
                ]
            },
            6: {
                id: "0f6g7h8i-9j0k-1l2m-3n4o-5p6q7r8s9t0u",
                title: "5.6 Celsius to Fahrenheit",
                type: "practice",
                xp: 100,
                instructions: `
                    <h3>Celsius to Fahrenheit</h3>
                    <p>Given a temperature <code>c</code> in degrees Celsius, print the temperature in degrees Fahrenheit.</p>
                    
                    <h3>Your Task</h3>
                    <p>Convert 13°C to Fahrenheit. Your answer must be a float.</p>
                    
                    <h3>Formula</h3>
                    <p>°C to °F - Divide by 5, then multiply by 9, then add 32</p>
                    
                    <h3>Reminder</h3>
                    <pre>x = 2
print( float(x) )</pre>
                `,
                starterCode: `c = 13`,
                hints: [
                    "Follow the formula step by step: (c / 5) * 9 + 32",
                    "Make sure to use float() to ensure decimal output",
                    "Try: f = float(c / 5 * 9 + 32) and then print(f)"
                ],
                checks: [
                    {
                        name: "Converts temperature correctly",
                        test: (code, output) => output.includes('55.4')
                    },
                    {
                        name: "Output is a float",
                        test: (code, output) => output.includes('.')
                    },
                    {
                        name: "Uses the formula correctly",
                        test: (code, output) => code.includes('5') && code.includes('9') && code.includes('32')
                    }
                ]
            },
            7: {
                id: "1g7h8i9j-0k1l-2m3n-4o5p-6q7r8s9t0u1v",
                title: "5.7 College Admissions Calculator",
                type: "practice",
                xp: 125,
                instructions: `
                    <h3>College Admissions</h3>
                    <p>A given <code>college</code> gets a certain number of <code>applicants</code> every year.</p>
                    <p>The college accepts a <code>percentage</code> of its applicants. Print out the number of applicants the college accepts as <em>"<strong>college</strong> accepts <strong>number</strong> applicants"</em>.</p>
                    
                    <h3>Important</h3>
                    <ul>
                        <li>Make sure <strong>number</strong> prints without the decimal place</li>
                        <li>You do NOT need a period at the end of the phrase</li>
                    </ul>
                `,
                starterCode: `college = "Stanford"
percentage = 0.05
applicants = 50000`,
                hints: [
                    "First calculate how many students are accepted: applicants * percentage",
                    "Use int() to remove decimal places",
                    "Combine strings using + or use print with multiple arguments"
                ],
                smartHints: {
                    '2500.0': "You have the right number but need to remove the decimal. Use int()",
                    'Stanford accepts 2500.0 applicants': "Almost there! Just need to convert to integer"
                },
                checks: [
                    {
                        name: "Calculates accepted students correctly",
                        test: (code, output) => output.includes('2500')
                    },
                    {
                        name: "Formats output correctly",
                        test: (code, output) => output.includes('Stanford accepts 2500 applicants')
                    },
                    {
                        name: "No decimal in output",
                        test: (code, output) => !output.includes('2500.0')
                    }
                ]
            },
            8: {
                id: "2h8i9j0k-1l2m-3n4o-5p6q-7r8s9t0u1v2w",
                title: "5.8 Exponents",
                type: "example",
                xp: 50,
                instructions: `
                    <h3>Exponents</h3>
                    <p>The exponent operator <code>**</code> takes the number on the left side of the operator and raises it to the power of the number on the right side.</p>
                    
                    <h3>Your Task</h3>
                    <p>Raise 4 to the power of 6 and print the answer.</p>
                    
                    <h3>Example</h3>
                    <pre>2 ** 3 = 8  (2 × 2 × 2)
5 ** 2 = 25 (5 × 5)</pre>
                `,
                starterCode: `x = 3

# x squared
print(x ** 2)

# 5 to the power of 3
print(5 ** 3)`,
                hints: [
                    "Use the ** operator to calculate exponents",
                    "You need to calculate 4 to the power of 6",
                    "Add: print(4 ** 6)"
                ],
                checks: [
                    {
                        name: "Calculates 4^6 correctly",
                        test: (code, output) => output.includes('4096')
                    },
                    {
                        name: "Uses exponent operator",
                        test: (code, output) => code.includes('**')
                    },
                    {
                        name: "Uses the numbers 4 and 6",
                        test: (code, output) => code.includes('4') && code.includes('6')
                    }
                ]
            },
            9: {
                id: "3i9j0k1l-2m3n-4o5p-6q7r-8s9t0u1v2w3x",
                title: "5.9 Cube Calculator",
                type: "practice",
                xp: 100,
                instructions: `
                    <h3>Cube Calculations</h3>
                    <p>Given the side length of a cube in the variable <code>length</code>, print the cube's volume and its surface area.</p>
                    
                    <h3>Formulas</h3>
                    <ul>
                        <li>Volume of a cube = length³ (length ** 3)</li>
                        <li>Surface area = 6 × (length²)</li>
                    </ul>
                    
                    <h3>Note</h3>
                    <p>The surface area is the sum of the areas of all 6 faces of the cube.</p>
                `,
                starterCode: `length = 7`,
                hints: [
                    "First calculate the volume using length ** 3",
                    "For surface area, each face is length ** 2, and there are 6 faces",
                    "Volume: print(length ** 3), Surface area: print(6 * length ** 2)"
                ],
                checks: [
                    {
                        name: "Calculates volume correctly (343)",
                        test: (code, output) => output.includes('343')
                    },
                    {
                        name: "Calculates surface area correctly (294)",
                        test: (code, output) => output.includes('294')
                    },
                    {
                        name: "Uses exponent operator",
                        test: (code, output) => code.includes('**')
                    }
                ]
            },
            10: {
                id: "4j0k1l2m-3n4o-5p6q-7r8s-9t0u1v2w3x4y",
                title: "5.10 Modulus Operator",
                type: "example",
                xp: 75,
                instructions: `
                    <h3>Modulus</h3>
                    <p>The modulus operator <code>%</code> returns the remainder after dividing the first number by the second number.</p>
                    
                    <h3>Examples</h3>
                    <ul>
                        <li><code>5 % 3 = 2</code> (5 ÷ 3 = 1 remainder 2)</li>
                        <li><code>10 % 5 = 0</code> (10 ÷ 5 = 2 remainder 0)</li>
                        <li><code>12 % 13 = 12</code> (12 ÷ 13 = 0 remainder 12)</li>
                    </ul>
                    
                    <h3>Your Task</h3>
                    <p>Use modulus to divide 18 by 4 and return the remainder.</p>
                `,
                starterCode: `print(5 % 3)
print(10 % 5)
print(12 % 13)`,
                hints: [
                    "The modulus operator % gives the remainder of division",
                    "18 divided by 4 is 4 with a remainder",
                    "Add: print(18 % 4)"
                ],
                checks: [
                    {
                        name: "Calculates 18 % 4 correctly",
                        test: (code, output) => output.includes('2')
                    },
                    {
                        name: "Uses modulus operator",
                        test: (code, output) => code.includes('%')
                    },
                    {
                        name: "Uses 18 and 4",
                        test: (code, output) => code.includes('18') && code.includes('4')
                    }
                ]
            },
            11: {
                id: "5k1l2m3n-4o5p-6q7r-8s9t-0u1v2w3x4y5z",
                title: "5.11 Divisibility Checker",
                type: "practice",
                xp: 100,
                instructions: `
                    <h3>Divisibility</h3>
                    <p>Two numbers <code>a</code> and <code>b</code> are divisible if the result of <code>a % b</code> is 0.</p>
                    
                    <h3>Note</h3>
                    <p>If the remainder after dividing <code>a</code> by <code>b</code> is zero, then <code>a</code> is divisible by <code>b</code>.</p>
                    
                    <h3>Your Task</h3>
                    <p>Use modulus <code>%</code> to check whether 23456 is divisible by 4.</p>
                `,
                starterCode: `# 10 is divisible by 5
print(10 % 5)

# 5 is not divisible by 2
print(5 % 2)`,
                hints: [
                    "If a number is divisible by another, the remainder is 0",
                    "Calculate 23456 % 4 and see if it equals 0",
                    "Add: print(23456 % 4)"
                ],
                smartHints: {
                    '0': "Correct! 23456 is divisible by 4 because the remainder is 0"
                },
                checks: [
                    {
                        name: "Checks divisibility of 23456 by 4",
                        test: (code, output) => {
                            const lines = output.trim().split('\n');
                            return lines.some(line => line.trim() === '0');
                        }
                    },
                    {
                        name: "Uses modulus operator",
                        test: (code, output) => code.includes('%')
                    },
                    {
                        name: "Uses 23456 and 4",
                        test: (code, output) => code.includes('23456') && code.includes('4')
                    }
                ]
            },
            12: {
                id: "6l2m3n4o-5p6q-7r8s-9t0u-1v2w3x4y5z6a",
                title: "5.12 Candy Distribution",
                type: "challenge",
                xp: 125,
                instructions: `
                    <h3>Candy Challenge</h3>
                    <p>You have a certain amount of <code>candy</code> and a certain number of <code>friends</code>.</p>
                    
                    <h3>Your Task</h3>
                    <ol>
                        <li>Calculate how many candies each friend gets (they all get the same amount)</li>
                        <li>Calculate how much candy you have left for yourself</li>
                        <li>Print both results</li>
                    </ol>
                    
                    <h3>Example</h3>
                    <p>If you have 10 candies and 3 friends, each friend gets 3 candies (9 total), leaving 1 for you.</p>
                    
                    <h3>Hint</h3>
                    <p>To get whole candies per friend, use division and then <code>int()</code> to remove decimals.</p>
                    
                    <div class="common-mistake">
                        <h4>⚠️ Common Mistake</h4>
                        <p><code>10 / 3 = 3.333...</code> but you can't give someone 0.333 of a candy!</p>
                        <p>Use <code>int(10 / 3)</code> to get 3 candies per person.</p>
                    </div>
                `,
                starterCode: `candy = 10
friends = 3`,
                hints: [
                    "First find out how many candies each friend gets using division",
                    "Use int() to convert the division result to whole candies",
                    "For leftover candy, use the modulus operator (%)",
                    "candies_per_friend = int(candy / friends), leftover = candy % friends"
                ],
                checks: [
                    {
                        name: "Calculates candies per friend",
                        test: (code, output) => {
                            return output.includes('3') && !output.includes('3.3');
                        }
                    },
                    {
                        name: "Calculates leftover candy correctly",
                        test: (code, output) => output.includes('1')
                    },
                    {
                        name: "Uses modulus operator for remainder",
                        test: (code, output) => code.includes('%')
                    },
                    {
                        name: "Uses int() or shows whole number per friend",
                        test: (code, output) => code.includes('int(') || !output.includes('3.3')
                    }
                ]
            },
            13: {
                id: "7m3n4o5p-6q7r-8s9t-0u1v-2w3x4y5z6a7b",
                title: "5.13 Order of Operations",
                type: "example",
                xp: 75,
                instructions: `
                    <h3>Order of Operations</h3>
                    <p>Python follows PEMDAS for order of operations:</p>
                    <ul>
                        <li><strong>P</strong>arentheses (brackets)</li>
                        <li><strong>E</strong>xponents</li>
                        <li><strong>M</strong>ultiplication, <strong>M</strong>odulus, and <strong>D</strong>ivision</li>
                        <li><strong>A</strong>ddition and <strong>S</strong>ubtraction</li>
                    </ul>
                    
                    <h3>Your Task</h3>
                    <ol>
                        <li>Run the code and look at the results</li>
                        <li>Remove the brackets from line 3 and run again</li>
                        <li>Observe how the result changes</li>
                    </ol>
                `,
                starterCode: `print(2 + 2 * 2)

print(2 - (6 + 8))

print(32 / 4 ** 2)`,
                hints: [
                    "Parentheses change the order of operations",
                    "Without parentheses: 2 - 6 + 8 = 4",
                    "With parentheses: 2 - (6 + 8) = 2 - 14 = -12"
                ],
                checks: [
                    {
                        name: "Code runs without errors",
                        test: (code, output) => !output.toLowerCase().includes('error')
                    },
                    {
                        name: "Modified the parentheses",
                        test: (code, output) => {
                            return !code.includes('(6 + 8)') || output.includes('4');
                        }
                    },
                    {
                        name: "Contains arithmetic operations",
                        test: (code, output) => code.includes('+') && code.includes('*')
                    }
                ]
            },
            14: {
                id: "8n4o5p6q-7r8s-9t0u-1v2w-3x4y5z6a7b8c",
                title: "5.14 Fahrenheit to Celsius",
                type: "practice",
                xp: 125,
                instructions: `
                    <h3>Temperature Converter</h3>
                    <p>Given a temperature <code>f</code> in degrees Fahrenheit, print the temperature in degrees Celsius.</p>
                    
                    <h3>Your Task</h3>
                    <p>Convert 55°F to Celsius. Your answer must be a float.</p>
                    
                    <h3>Formula</h3>
                    <p>°F to °C - Deduct 32, then multiply by 5, then divide by 9</p>
                    
                    <h3>Important</h3>
                    <p>Remember to use parentheses to ensure correct order of operations!</p>
                `,
                starterCode: `f = 55`,
                hints: [
                    "Follow the formula step by step: subtract 32 first",
                    "Use parentheses: (f - 32) * 5 / 9",
                    "Make sure to use float() for decimal output"
                ],
                smartHints: {
                    '12.777': "Correct! You can round if needed, but the exact answer is good",
                    '12.78': "Perfect! You've got the right answer", 
                    '12.8': "Very close! Make sure you're following the exact formula",
                    '23': "Make sure you're subtracting 32 BEFORE multiplying"
                },
                checks: [
                    {
                        name: "Converts temperature correctly",
                        test: (code, output) => output.includes('12.77') || output.includes('12.78')
                    },
                    {
                        name: "Output is a float",
                        test: (code, output) => output.includes('.')
                    },
                    {
                        name: "Uses correct formula",
                        test: (code, output) => code.includes('32') && code.includes('5') && code.includes('9')
                    }
                ]
            },
            15: {
                id: "9o5p6q7r-8s9t-0u1v-2w3x-4y5z6a7b8c9d",
                title: "5.15 Incrementing Variables",
                type: "example",
                xp: 75,
                instructions: `
                    <h3>Incrementing</h3>
                    <p>A variable's value can be used in calculating its new value.</p>
                    
                    <p>When assigning a value to a variable with the <code>=</code> operator, a computer first calculates the right side of the <code>=</code> sign, and stores the result in the variable on the left of the <code>=</code> sign.</p>
                    
                    <h3>Your Task</h3>
                    <p>Increment the variable <code>x</code> one more time so that it prints 4.</p>
                `,
                starterCode: `x = 1
print(x)

x = x + 1   # x = 2
print(x)

x = x + 1   # x = 3
print(x)`,
                hints: [
                    "You need to increment x one more time",
                    "Add another line that increases x by 1",
                    "Add: x = x + 1 and then print(x)"
                ],
                checks: [
                    {
                        name: "Increments x to 4",
                        test: (code, output) => output.includes('4')
                    },
                    {
                        name: "Uses increment pattern",
                        test: (code, output) => code.includes('x = x + 1') || code.includes('x = x+1')
                    },
                    {
                        name: "Prints all values",
                        test: (code, output) => output.includes('1') && output.includes('2') && output.includes('3') && output.includes('4')
                    }
                ]
            },
            16: {
                id: "0p6q7r8s-9t0u-1v2w-3x4y-5z6a7b8c9d0e",
                title: "5.16 Height Tracker",
                type: "practice",
                xp: 100,
                instructions: `
                    <h3>Tracking Changes</h3>
                    <p>A programmer is 60 inches tall and grows at different rates each year.</p>
                    
                    <h3>Your Task</h3>
                    <p>The programmer's height changes by:</p>
                    <ul>
                        <li>4 inches in the first year</li>
                        <li>6 inches in the second year</li>
                        <li>3 inches in the third year</li>
                    </ul>
                    <p>Change the code to reflect these different growth amounts.</p>
                `,
                starterCode: `height = 60
print(height)

height = height + 5
print(height)

height = height + 5
print(height)

height = height + 5
print(height)`,
                hints: [
                    "Change each increment to match the specified growth",
                    "First year: +4, Second year: +6, Third year: +3",
                    "Change the 5s to 4, 6, and 3 respectively"
                ],
                checks: [
                    {
                        name: "Tracks height correctly",
                        test: (code, output) => {
                            const values = output.trim().split('\n');
                            return values[0] === '60' && values[1] === '64' && 
                                   values[2] === '70' && values[3] === '73';
                        }
                    },
                    {
                        name: "Uses correct increments",
                        test: (code, output) => code.includes('4') && code.includes('6') && code.includes('3')
                    },
                    {
                        name: "Maintains increment pattern",
                        test: (code, output) => code.includes('height = height +')
                    }
                ]
            },
            17: {
                id: "1q7r8s9t-0u1v-2w3x-4y5z-6a7b8c9d0e1f",
                title: "5.17 Math Operators Challenge",
                type: "challenge",
                xp: 200,
                instructions: `
                    <h3>Math Operators Challenge</h3>
                    <p>Write a program that:</p>
                    <ol>
                        <li>Asks the user to input 2 numbers (you will need 2 variables)</li>
                        <li>Adds these two numbers together and stores the answer in a variable called "answer"</li>
                        <li>Prints out "The answer is..." followed by the answer</li>
                        <li>Uses the modulus operator to divide the answer variable by 2 and prints the result</li>
                    </ol>
                    
                    <h3>Remember</h3>
                    <ul>
                        <li>Use <code>input()</code> to get user input</li>
                        <li>Convert input to integers using <code>int()</code></li>
                        <li>You may need to convert integers to strings for printing</li>
                    </ul>
                `,
                starterCode: ``,
                hints: [
                    "Start by getting two numbers: num1 = int(input('Enter first number: '))",
                    "Add them together: answer = num1 + num2",
                    "For printing, you can use: print('The answer is...', answer)",
                    "Finally, use modulus: print(answer % 2)"
                ],
                smartHints: {
                    'TypeError': "Make sure to convert input() to int() before doing math",
                    'NameError': "Make sure you've defined all variables before using them"
                },
                checks: [
                    {
                        name: "Gets two inputs from user",
                        test: (code, output) => (code.match(/input\s*\(/g) || []).length >= 2
                    },
                    {
                        name: "Stores result in 'answer' variable",
                        test: (code, output) => code.includes('answer')
                    },
                    {
                        name: "Prints 'The answer is...'",
                        test: (code, output) => code.toLowerCase().includes('the answer is')
                    },
                    {
                        name: "Uses modulus operator",
                        test: (code, output) => code.includes('%')
                    },
                    {
                        name: "Converts input to integers",
                        test: (code, output) => code.includes('int(')
                    }
                ]
            },
            18: {
                id: "2r8s9t0u-1v2w-3x4y-5z6a-7b8c9d0e1f2g",
                title: "Section 5 Assessment",
                type: "assessment",
                xp: 250,
                instructions: `
                    <div class="worksheet-section">
                        <h3 class="worksheet-title">📝 End of Section 5: Worksheet</h3>
                        
                        <div class="worksheet-question">
                            <h4>1. State the 2 symbols we use for multiplication and division in Python.</h4>
                            <textarea class="worksheet-answer" rows="2" placeholder="Write your answer here..."></textarea>
                        </div>
                        
                        <div class="worksheet-question">
                            <h4>2. Describe what type of number a float number is.</h4>
                            <textarea class="worksheet-answer" rows="3" placeholder="Write your answer here..."></textarea>
                        </div>
                        
                        <div class="worksheet-question">
                            <h4>3. Write a line of Python that would allow a user to input a decimal number into a variable called 'num'.</h4>
                            <textarea class="worksheet-answer" rows="2" placeholder="Write your code here..."></textarea>
                        </div>
                        
                        <div class="worksheet-question">
                            <h4>4. Describe what the following code is doing.</h4>
                            <div class="worksheet-code">result = 100 / (5 ** 2)
print(result)</div>
                            <textarea class="worksheet-answer" rows="3" placeholder="Explain the code here..."></textarea>
                        </div>

                        <div class="worksheet-question">
                            <h4>5. Describe what the modulus symbol (%) does in Python.</h4>
                            <textarea class="worksheet-answer" rows="3" placeholder="Write your answer here..."></textarea>
                        </div>

                        <div class="worksheet-question">
                            <h4>6. Explain how we can use modulus to find out if a number is even or odd.</h4>
                            <textarea class="worksheet-answer" rows="4" placeholder="Write your answer here..."></textarea>
                        </div>
                    </div>
                `,
                starterCode: ``,
                checks: [] 
            }
        };

        // Extension progress tracking
        const extensionProgress = {
            'compound-interest': { completed: false, xp: 50 },
            'even-odd': { completed: false, xp: 30 },
            'advanced-calc': { completed: false, xp: 50 },
            'number-properties': { completed: false, xp: 40 },
            'unit-converter': { completed: false, xp: 50 },
            'compound-operators': { completed: false, xp: 30 },
            'math-patterns': { completed: false, xp: 40 }
        };

        // Extension checks
        const extensionChecks = {
            'compound-interest': {
                check: (code, output) => {
                    return code.includes('**') && code.includes('rate') && 
                           code.includes('time') && output.includes('.');
                },
                hint: "Use the formula: final = principal * (1 + rate) ** time"
            },
            'even-odd': {
                check: (code, output) => {
                    return code.includes('%') && code.includes('2') && 
                           (output.toLowerCase().includes('even') || output.toLowerCase().includes('odd'));
                },
                hint: "Use number % 2 == 0 to check if a number is even"
            },
            'advanced-calc': {
                check: (code, output) => {
                    return code.includes('choice') && code.includes('if') && 
                           code.includes('+') && code.includes('-') && 
                           code.includes('*') && code.includes('/');
                },
                hint: "Create a menu with options for each operation"
            },
            'number-properties': {
                check: (code, output) => {
                    return code.includes('%') && code.includes('for') && 
                           output.toLowerCase().includes('divisible');
                },
                hint: "Use a loop to check divisibility by multiple numbers"
            },
            'unit-converter': {
                check: (code, output) => {
                    return code.includes('*') && code.includes('/') && 
                           code.includes('choice') && output.includes('.');
                },
                hint: "Create conversion factors for different units"
            },
            'compound-operators': {
                check: (code, output) => {
                    return (code.includes('+=') || code.includes('-=') || 
                            code.includes('*=') || code.includes('/=')) && 
                           output.includes('5.0');
                },
                hint: "Try using +=, -=, *=, or /= operators. The final result should be 5.0."
            },
            'math-patterns': {
                check: (code, output) => {
                    return code.includes('**') && code.includes('11') && 
                           (output.includes('121') || output.includes('1331'));
                },
                hint: "Calculate powers of 11 and look for patterns"
            }
        };

        // Extension topics content
        const extensionTopics = {
            'compound-interest': {
                title: 'Compound Interest Calculator',
                content: `
                    <div class="extension-header">
                        <h2>Compound Interest Calculator</h2>
                    </div>
                    
                    <div class="extension-content">
                        <div class="concept-section">
                            <h3>Understanding Compound Interest</h3>
                            <p>Compound interest is when you earn interest on both your initial investment and previously earned interest. It's one of the most powerful concepts in finance!</p>
                            
                            <div class="example-box">
                                <h4>The Formula</h4>
                                <p><strong>Final Amount = Principal × (1 + Rate)^Time</strong></p>
                                <p>Where:</p>
                                <ul>
                                    <li>Principal = Initial amount</li>
                                    <li>Rate = Interest rate (as a decimal)</li>
                                    <li>Time = Number of years</li>
                                </ul>
                            </div>
                            
                            <div class="example-box">
                                <h4>Example</h4>
                                <div class="extension-editor-container">
                                    <div class="editor-header">
                                        <div class="editor-title">Example Code</div>
                                    </div>
                                    <textarea id="example-compound-interest" readonly>
# Compound Interest Calculator
principal = 1000  # Starting amount
rate = 0.05      # 5% interest
time = 10        # 10 years

final_amount = principal * (1 + rate) ** time
print("After " + str(time) + " years, $" + str(principal) + " becomes $" + str(round(final_amount, 2)))

# Calculate the interest earned
interest_earned = final_amount - principal
print("Total interest earned: $" + str(round(interest_earned, 2)))
                                    </textarea>
                                </div>
                            </div>
                            
                            <div class="try-it">
                                <h4>Try it yourself!</h4>
                                <p>Create a compound interest calculator that asks the user for principal, rate, and time, then calculates the final amount.</p>
                                <div class="extension-editor-container">
                                    <div class="editor-header">
                                        <div class="editor-title">
                                            <span>Python Code Editor</span>
                                        </div>
                                        <div class="editor-actions">
                                            <button class="editor-btn run" onclick="runExtensionCode('compound-interest')">
                                                ▶ Run Code
                                            </button>
                                        </div>
                                    </div>
                                    <textarea id="ext-compound-interest">
# Your compound interest calculator
# Ask user for principal, rate, and time
# Calculate and display the final amount

</textarea>
                                </div>
                                <div class="output-panel">
                                    <div class="output-header">Output</div>
                                    <div class="output-content" id="output-ext-compound-interest"></div>
                                </div>
                                <div class="controls">
                                    <button onclick="checkExtensionComplete('compound-interest')" class="btn btn-success">✓ Check Solution</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `
            },
            'even-odd': {
                title: 'Even/Odd Checker',
                content: `
                    <div class="extension-header">
                        <h2>Even/Odd Number Checker</h2>
                    </div>
                    
                    <div class="extension-content">
                        <div class="concept-section">
                            <h3>Using Modulus to Check Even/Odd</h3>
                            <p>The modulus operator (%) is perfect for determining if a number is even or odd!</p>
                            
                            <div class="example-box">
                                <h4>How it Works</h4>
                                <p>A number is <strong>even</strong> if it divides by 2 with no remainder (number % 2 == 0)</p>
                                <p>A number is <strong>odd</strong> if it has a remainder of 1 when divided by 2 (number % 2 == 1)</p>
                            </div>
                            
                            <div class="example-box">
                                <h4>Example</h4>
                                <div class="extension-editor-container">
                                    <div class="editor-header">
                                        <div class="editor-title">Example Code</div>
                                    </div>
                                    <textarea id="example-even-odd" readonly>
# Check if a number is even or odd
number = 15

if number % 2 == 0:
    print(str(number) + " is even")
else:
    print(str(number) + " is odd")

# You can also do it in one line
result = "even" if number % 2 == 0 else "odd"
print(str(number) + " is " + result)
                                    </textarea>
                                </div>
                            </div>
                            
                            <div class="try-it">
                                <h4>Try it yourself!</h4>
                                <p>Create a program that asks the user for a number and tells them if it's even or odd.</p>
                                <div class="extension-editor-container">
                                    <div class="editor-header">
                                        <div class="editor-title">
                                            <span>Python Code Editor</span>
                                        </div>
                                        <div class="editor-actions">
                                            <button class="editor-btn run" onclick="runExtensionCode('even-odd')">
                                                ▶ Run Code
                                            </button>
                                        </div>
                                    </div>
                                    <textarea id="ext-even-odd">
# Even/Odd Checker
# Ask the user for a number
# Check if it's even or odd
# Print the result

</textarea>
                                </div>
                                <div class="output-panel">
                                    <div class="output-header">Output</div>
                                    <div class="output-content" id="output-ext-even-odd"></div>
                                </div>
                                <div class="controls">
                                    <button onclick="checkExtensionComplete('even-odd')" class="btn btn-success">✓ Check Solution</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `
            },
            'advanced-calc': {
                title: 'Advanced Calculator',
                content: `
                    <div class="extension-header">
                        <h2>Advanced Calculator</h2>
                    </div>
                    
                    <div class="extension-content">
                        <div class="concept-section">
                            <h3>Building a Menu-Driven Calculator</h3>
                            <p>Create a calculator that lets users choose which operation to perform!</p>
                            
                            <div class="example-box">
                                <h4>Example Menu Structure</h4>
                                <div class="extension-editor-container">
                                    <div class="editor-header">
                                        <div class="editor-title">Example Code</div>
                                    </div>
                                    <textarea id="example-advanced-calc" readonly>
# Simple Calculator Menu
print("Calculator Menu:")
print("1. Addition")
print("2. Subtraction")
print("3. Multiplication")
print("4. Division")
print("5. Exponent")
print("6. Modulus")

choice = input("Enter choice (1-6): ")
num1 = float(input("Enter first number: "))
num2 = float(input("Enter second number: "))

if choice == '1':
    result = num1 + num2
    print(str(num1) + " + " + str(num2) + " = " + str(result))
# Continue for other operations...
                                    </textarea>
                                </div>
                            </div>
                            
                            <div class="try-it">
                                <h4>Try it yourself!</h4>
                                <p>Create a complete calculator with all 6 operations. Include error handling for division by zero!</p>
                                <div class="extension-editor-container">
                                    <div class="editor-header">
                                        <div class="editor-title">
                                            <span>Python Code Editor</span>
                                        </div>
                                        <div class="editor-actions">
                                            <button class="editor-btn run" onclick="runExtensionCode('advanced-calc')">
                                                ▶ Run Code
                                            </button>
                                        </div>
                                    </div>
                                    <textarea id="ext-advanced-calc">
# Advanced Calculator
# Create a menu with all 6 operations
# Get user's choice and two numbers
# Perform the selected operation
# Handle division by zero error

</textarea>
                                </div>
                                <div class="output-panel">
                                    <div class="output-header">Output</div>
                                    <div class="output-content" id="output-ext-advanced-calc"></div>
                                </div>
                                <div class="controls">
                                    <button onclick="checkExtensionComplete('advanced-calc')" class="btn btn-success">✓ Check Solution</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `
            },
            'number-properties': {
                title: 'Number Properties Explorer',
                content: `
                    <div class="extension-header">
                        <h2>Number Properties Explorer</h2>
                    </div>
                    
                    <div class="extension-content">
                        <div class="concept-section">
                            <h3>Exploring Number Properties</h3>
                            <p>Use mathematical operators to discover interesting properties of numbers!</p>
                            
                            <div class="example-box">
                                <h4>Properties to Check</h4>
                                <ul>
                                    <li><strong>Divisibility:</strong> Check which numbers divide evenly</li>
                                    <li><strong>Prime Numbers:</strong> Only divisible by 1 and itself</li>
                                    <li><strong>Perfect Squares:</strong> Square root is a whole number</li>
                                    <li><strong>Factors:</strong> All numbers that divide evenly</li>
                                </ul>
                            </div>
                            
                            <div class="example-box">
                                <h4>Example: Finding Factors</h4>
                                <div class="extension-editor-container">
                                    <div class="editor-header">
                                        <div class="editor-title">Example Code</div>
                                    </div>
                                    <textarea id="example-number-properties" readonly>
# Find all factors of a number
number = 24
print("Factors of " + str(number) + ":")

for i in range(1, number + 1):
    if number % i == 0:
        print(i, end=" ")
print()  # New line

# Check if it's a perfect square
import math
sqrt = math.sqrt(number)
if sqrt == int(sqrt):
    print(str(number) + " is a perfect square!")
                                    </textarea>
                                </div>
                            </div>
                            
                            <div class="try-it">
                                <h4>Try it yourself!</h4>
                                <p>Create a program that analyzes a number and reports all its properties: factors, whether it's prime, even/odd, and if it's a perfect square.</p>
                                <div class="extension-editor-container">
                                    <div class="editor-header">
                                        <div class="editor-title">
                                            <span>Python Code Editor</span>
                                        </div>
                                        <div class="editor-actions">
                                            <button class="editor-btn run" onclick="runExtensionCode('number-properties')">
                                                ▶ Run Code
                                            </button>
                                        </div>
                                    </div>
                                    <textarea id="ext-number-properties">
# Number Properties Explorer
# Get a number from the user
# Find and display all its factors
# Check if it's prime
# Check if it's even or odd
# Check if it's a perfect square

</textarea>
                                </div>
                                <div class="output-panel">
                                    <div class="output-header">Output</div>
                                    <div class="output-content" id="output-ext-number-properties"></div>
                                </div>
                                <div class="controls">
                                    <button onclick="checkExtensionComplete('number-properties')" class="btn btn-success">✓ Check Solution</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `
            },
            'unit-converter': {
                title: 'Unit Converter',
                content: `
                    <div class="extension-header">
                        <h2>Unit Converter</h2>
                    </div>
                    
                    <div class="extension-content">
                        <div class="concept-section">
                            <h3>Converting Between Units</h3>
                            <p>Use mathematical operators to convert between different units of measurement!</p>
                            
                            <div class="example-box">
                                <h4>Common Conversions</h4>
                                <ul>
                                    <li><strong>Length:</strong> meters ↔ feet, km ↔ miles</li>
                                    <li><strong>Weight:</strong> kg ↔ pounds, grams ↔ ounces</li>
                                    <li><strong>Temperature:</strong> Celsius ↔ Fahrenheit ↔ Kelvin</li>
                                    <li><strong>Volume:</strong> liters ↔ gallons</li>
                                </ul>
                            </div>
                            
                            <div class="example-box">
                                <h4>Example: Length Converter</h4>
                                <div class="extension-editor-container">
                                    <div class="editor-header">
                                        <div class="editor-title">Example Code</div>
                                    </div>
                                    <textarea id="example-unit-converter" readonly>
# Length Unit Converter
print("Length Converter")
print("1. Meters to Feet")
print("2. Feet to Meters")
print("3. Kilometers to Miles")
print("4. Miles to Kilometers")

choice = input("Select conversion (1-4): ")
value = float(input("Enter value: "))

if choice == '1':
    result = value * 3.28084
    print(str(value) + " meters = " + str(round(result, 2)) + " feet")
elif choice == '2':
    result = value / 3.28084
    print(str(value) + " feet = " + str(round(result, 2)) + " meters")
# Continue for other conversions...
                                    </textarea>
                                </div>
                            </div>
                            
                            <div class="try-it">
                                <h4>Try it yourself!</h4>
                                <p>Create a multi-purpose unit converter that handles at least 3 different types of units (length, weight, temperature, etc.)</p>
                                <div class="extension-editor-container">
                                    <div class="editor-header">
                                        <div class="editor-title">
                                            <span>Python Code Editor</span>
                                        </div>
                                        <div class="editor-actions">
                                            <button class="editor-btn run" onclick="runExtensionCode('unit-converter')">
                                                ▶ Run Code
                                            </button>
                                        </div>
                                    </div>
                                    <textarea id="ext-unit-converter">
# Multi-Purpose Unit Converter
# Create a menu for different unit types
# Allow user to select conversion type
# Get value and perform conversion
# Display result with appropriate precision

</textarea>
                                </div>
                                <div class="output-panel">
                                    <div class="output-header">Output</div>
                                    <div class="output-content" id="output-ext-unit-converter"></div>
                                </div>
                                <div class="controls">
                                    <button onclick="checkExtensionComplete('unit-converter')" class="btn btn-success">✓ Check Solution</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `
            },
            'compound-operators': {
                title: 'Compound Assignment Operators',
                content: `
                    <div class="extension-header">
                        <h2>Compound Assignment Operators</h2>
                    </div>
                    
                    <div class="extension-content">
                        <div class="concept-section">
                            <h3>Shortcut Operators</h3>
                            <p>Python provides shortcut operators that make your code cleaner and more efficient!</p>
                            
                            <div class="example-box">
                                <h4>Instead of writing:</h4>
                                <pre>x = x + 5    # Add 5 to x
x = x - 3    # Subtract 3 from x
x = x * 2    # Multiply x by 2
x = x / 4    # Divide x by 4
x = x ** 2   # Square x
x = x % 3    # Get remainder of x / 3</pre>
                                
                                <h4>You can write:</h4>
                                <pre>x += 5     # Same as x = x + 5
x -= 3     # Same as x = x - 3
x *= 2     # Same as x = x * 2
x /= 4     # Same as x = x / 4
x **= 2    # Same as x = x ** 2
x %= 3     # Same as x = x % 3</pre>
                            </div>
                            
                            <div class="why-matters">
                                <h4>🌟 Why This Matters</h4>
                                <p>Professional programmers use these operators all the time - they make code shorter and easier to read!</p>
                            </div>
                            
                            <div class="try-it">
                                <h4>Try it yourself!</h4>
                                <p>Start with x = 10, then use compound operators to:</p>
                                <ol>
                                    <li>Add 5 to x</li>
                                    <li>Multiply the result by 2</li>
                                    <li>Subtract 10</li>
                                    <li>Divide by 4</li>
                                </ol>
                                <p>Print x after each operation. Final result should be 5.0</p>
                                <div class="extension-editor-container">
                                    <div class="editor-header">
                                        <div class="editor-title">
                                            <span>Python Code Editor</span>
                                        </div>
                                        <div class="editor-actions">
                                            <button class="editor-btn run" onclick="runExtensionCode('compound-operators')">
                                                ▶ Run Code
                                            </button>
                                        </div>
                                    </div>
                                    <textarea id="ext-compound-operators">
# Compound Operators Practice
x = 10
print("Starting value:", x)

# Add 5 to x using +=


# Continue with other operations...

</textarea>
                                </div>
                                <div class="output-panel">
                                    <div class="output-header">Output</div>
                                    <div class="output-content" id="output-ext-compound-operators"></div>
                                </div>
                                <div class="controls">
                                    <button onclick="checkExtensionComplete('compound-operators')" class="btn btn-success">✓ Check Solution</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `
            },
            'math-patterns': {
                title: 'Math Curiosities',
                content: `
                    <div class="extension-header">
                        <h2>Math Curiosities & Patterns</h2>
                    </div>
                    
                    <div class="extension-content">
                        <div class="concept-section">
                            <h3>Discover Amazing Math Patterns!</h3>
                            <p>Mathematics is full of surprising patterns. Let's explore some fascinating ones!</p>
                            
                            <div class="example-box">
                                <h4>Pattern 1: Powers of 11</h4>
                                <pre>11 ** 1 = 11
11 ** 2 = 121
11 ** 3 = 1331
11 ** 4 = 14641</pre>
                                <p>Notice anything special about these numbers?</p>
                            </div>
                            
                            <div class="example-box">
                                <h4>Pattern 2: Multiplying by 9</h4>
                                <pre>111111111 * 9 = ?
12345679 * 9 = ?</pre>
                            </div>
                            
                            <div class="example-box">
                                <h4>Pattern 3: Modulus Patterns</h4>
                                <pre>11 % 10 = 1
111 % 100 = 11
1111 % 1000 = 111</pre>
                            </div>
                            
                            <div class="try-it">
                                <h4>Try it yourself!</h4>
                                <p>Explore these patterns and find your own! Calculate:</p>
                                <ol>
                                    <li>Powers of 11 from 1 to 5</li>
                                    <li>111111111 * 111111111</li>
                                    <li>The pattern when you divide 1 by 7, 1 by 11, 1 by 13</li>
                                    <li>What happens with 12345679 * 9, * 18, * 27?</li>
                                </ol>
                                <div class="extension-editor-container">
                                    <div class="editor-header">
                                        <div class="editor-title">
                                            <span>Python Code Editor</span>
                                        </div>
                                        <div class="editor-actions">
                                            <button class="editor-btn run" onclick="runExtensionCode('math-patterns')">
                                                ▶ Run Code
                                            </button>
                                        </div>
                                    </div>
                                    <textarea id="ext-math-patterns">
# Math Curiosities Explorer
print("Powers of 11:")
# Calculate 11**1 through 11**5

print("\nSpecial Multiplication:")
# Try 111111111 * 111111111

print("\nDivision Patterns:")
# Calculate 1/7, 1/11, 1/13

print("\nMagic Number 12345679:")
# Multiply by 9, 18, 27, etc.

</textarea>
                                </div>
                                <div class="output-panel">
                                    <div class="output-header">Output</div>
                                    <div class="output-content" id="output-ext-math-patterns"></div>
                                </div>
                                <div class="controls">
                                    <button onclick="checkExtensionComplete('math-patterns')" class="btn btn-success">✓ Check Solution</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `
            }
        };

        // Initialize Pyodide
        async function initializePyodide() {
            try {
                pyodide = await loadPyodide({
                    indexURL: "https://cdn.jsdelivr.net/pyodide/v0.24.1/full/"
                });
                
                // Set up input handling
                pyodide.runPython(`
                    import sys
                    from js import prompt
                    
                    def custom_input(prompt_text=""):
                        return prompt(prompt_text)
                    
                    __builtins__.input = custom_input
                `);
                
                console.log("Pyodide loaded successfully");
                loadAllProgress();
                generateTaskList();
                switchTask(1);
            } catch (error) {
                console.error("Failed to load Pyodide:", error);
                document.getElementById('taskContent').innerHTML = `
                    <div class="error-message">
                        <h3>Failed to load Python environment</h3>
                        <p>Please refresh the page to try again.</p>
                    </div>
                `;
            }
        }

        // Initialize CodeMirror editor
        function initializeEditor(taskNumber) {
            const editorElement = document.getElementById(`editor-${taskNumber}`);
            if (!editorElement) return;

            if (editors[taskNumber]) {
                editors[taskNumber].toTextArea();
            }

            editors[taskNumber] = CodeMirror.fromTextArea(editorElement, {
                mode: 'python',
                theme: 'monokai',
                lineNumbers: true,
                autoCloseBrackets: true,
                matchBrackets: true,
                indentUnit: 4,
                tabSize: 4,
                indentWithTabs: false,
                lineWrapping: true,
                foldGutter: true,
                gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
                extraKeys: {
                    "Tab": function(cm) {
                        cm.replaceSelection("    ");
                    },
                    "Ctrl-Enter": function(cm) {
                        runCode(taskNumber);
                    },
                    "Cmd-Enter": function(cm) {
                        runCode(taskNumber);
                    }
                }
            });

            // Set initial value
            const task = tasks[taskNumber];
            const savedCode = localStorage.getItem(`mathops-code-${task.id}`);
            editors[taskNumber].setValue(savedCode || task.starterCode);
            
            // Auto-save
            editors[taskNumber].on('change', () => {
                localStorage.setItem(`mathops-code-${task.id}`, editors[taskNumber].getValue());
            });
        }

        // Generate task list in sidebar
        function generateTaskList() {
            const taskList = document.getElementById('taskList');
            taskList.innerHTML = '';
            
            for (let i = 1; i <= Object.keys(tasks).length; i++) {
                const task = tasks[i];
                const li = document.createElement('li');
                li.className = 'task-item';
                if (userProgress.completedTasks[i]) {
                    li.classList.add('completed');
                }
                if (i === currentTask) {
                    li.classList.add('active');
                }
                
                li.innerHTML = `
                    <span>${task.title}</span>
                    <span class="task-xp">${task.xp} XP</span>
                `;
                
                li.onclick = () => switchTask(i);
                taskList.appendChild(li);
            }
        }

        // Switch between tasks
        function switchTask(taskNum) {
            currentTask = taskNum;
            const task = tasks[taskNum];
            
            // Update active state in sidebar
            document.querySelectorAll('.task-item').forEach((item, index) => {
                item.classList.toggle('active', index === taskNum - 1);
            });
            
            // Route to the correct rendering function based on task type
            if (task.type === 'assessment') {
                renderAssessmentTask(taskNum);
            } else {
                renderRegularTask(taskNum);
            }
            
            // Hide extension content and game content
            document.getElementById('taskContent').style.display = 'block';
            document.getElementById('extensionContent').style.display = 'none';
            document.getElementById('gameContent').style.display = 'none';
        }

        // Render assessment task
        function renderAssessmentTask(taskNum) {
            const task = tasks[taskNum];
            const contentDiv = document.getElementById('taskContent');
            contentDiv.innerHTML = `
                <div class="task-header">
                    <h2 class="task-title">${task.title}</h2>
                    <span class="task-type ${task.type}">${task.type}</span>
                </div>
                ${task.instructions}
                <div class="controls">
                     <button class="btn btn-success" onclick="markAssessmentComplete(${taskNum})">
                        ✓ Mark as Complete
                    </button>
                    ${taskNum < Object.keys(tasks).length ? 
                        `<button class="btn btn-primary" onclick="switchTask(${taskNum + 1})">Next Task →</button>` : 
                        '<button class="btn btn-primary" onclick="exportProgress()">Export Progress Report</button>'}
                </div>
            `;
        }

        // Simple completion for assessment
        function markAssessmentComplete(taskNum) {
            if (!userProgress.completedTasks[taskNum]) {
                const task = tasks[taskNum];
                userProgress.completedTasks[taskNum] = true;
                awardXP(task.xp);
                updateProgress();
                generateTaskList();
                showAchievement('🎓', 'Assessment Complete!', `You've completed the assessment!`, task.xp);
                checkBadges();
            } else {
                alert("You have already completed this assessment.");
            }
        }
        
        // Render regular task
        function renderRegularTask(taskNum) {
            const task = tasks[taskNum];
            
            // Update main content
            document.getElementById('taskContent').innerHTML = `
                <div class="task-header">
                    <h2 class="task-title">${task.title}</h2>
                    <span class="task-type ${task.type}">${task.type}</span>
                </div>
                
                <div class="instructions">
                    ${task.instructions}
                </div>
                
                <div class="editor-container">
                    <div class="editor-header">
                        <div class="editor-title">
                            <span>Python Code Editor</span>
                        </div>
                        <div class="editor-actions">
                            <button class="editor-btn" onclick="resetCode(${taskNum})">
                                ↺ Reset
                            </button>
                            <button class="editor-btn run" onclick="runCode(${taskNum})">
                                ▶ Run Code
                            </button>
                        </div>
                    </div>
                    <textarea id="editor-${taskNum}"></textarea>
                </div>
                
                <div class="output-panel">
                    <div class="output-header">Output</div>
                    <div class="output-content" id="output-${taskNum}"></div>
                </div>
                
                <div class="hint-box" id="hint-${taskNum}">
                    <div class="hint-header">
                        <span>💡</span>
                        <span>Hint <span id="hintNumber-${taskNum}">1</span>/${task.hints.length}</span>
                    </div>
                    <p id="hintText-${taskNum}">${task.hints[0]}</p>
                </div>
                
                <div class="controls">
                    <button class="btn btn-secondary" onclick="showHint(${taskNum})">
                        💡 Show Hint
                    </button>
                    <button class="btn btn-success" onclick="checkCode(${taskNum})">
                        ✓ Check Solution
                    </button>
                    ${taskNum < Object.keys(tasks).length ? 
                        `<button class="btn btn-primary" onclick="switchTask(${taskNum + 1})">Next Task →</button>` : 
                        '<button class="btn btn-primary" onclick="exportProgress()">Export Progress Report</button>'}
                </div>
                
                <div class="checks-container" id="checks-${taskNum}" style="display: none;">
                    <h3>Solution Checks:</h3>
                    ${task.checks.map((check, index) => 
                        `<div class="check-item" id="check-${taskNum}-${index}">
                            <div class="check-icon pending" id="checkIcon-${taskNum}-${index}">?</div>
                            <span>${check.name}</span>
                        </div>`
                    ).join('')}
                </div>
            `;
            
            // Initialize editor after DOM is ready
            setTimeout(() => {
                initializeEditor(taskNum);
            }, 0);
        }

        // Run Python code
        async function runCode(taskNumber) {
            if (!pyodide || !editors[taskNumber]) return;
            
            const outputElement = document.getElementById(`output-${taskNumber}`);
            outputElement.textContent = 'Running...';
            outputElement.classList.remove('error');
            
            try {
                const code = editors[taskNumber].getValue();
                
                pyodide.runPython(`
                    import sys
                    from io import StringIO
                    sys.stdout = StringIO()
                    sys.stderr = StringIO()
                `);
                
                await pyodide.runPythonAsync(code);
                
                const stdout = pyodide.runPython("sys.stdout.getvalue()");
                const stderr = pyodide.runPython("sys.stderr.getvalue()");
                
                if (stderr) {
                    outputElement.textContent = stderr;
                    outputElement.classList.add('error');
                    
                    const task = tasks[taskNumber];
                    if (task.smartHints) {
                        for (const [pattern, hint] of Object.entries(task.smartHints)) {
                            if (stderr.includes(pattern) || stdout.includes(pattern)) {
                                showSmartHint(taskNumber, hint);
                                break;
                            }
                        }
                    }
                } else {
                    const lines = stdout.trim().split('\n');
                    let hasTypeIndicators = false;
                    const annotatedOutput = lines.map(line => {
                        const numMatch = line.trim().match(/^-?\d+\.?\d*$/);
                        if (numMatch) {
                            hasTypeIndicators = true;
                            const num = numMatch[0];
                            if (num.includes('.')) {
                                return `${line} <span class="type-indicator float">float</span>`;
                            } else {
                                return `${line} <span class="type-indicator int">int</span>`;
                            }
                        }
                        return line;
                    }).join('\n');
                    
                    if (hasTypeIndicators) {
                        outputElement.innerHTML = annotatedOutput;
                    } else {
                        outputElement.textContent = stdout || 'No output';
                    }
                    
                    const task = tasks[taskNumber];
                    if (task.smartHints) {
                        for (const [pattern, hint] of Object.entries(task.smartHints)) {
                            if (stdout.includes(pattern)) {
                                showSmartHint(taskNumber, hint);
                                break;
                            }
                        }
                    }
                }
                
                pyodide.runPython(`
                    sys.stdout = sys.__stdout__
                    sys.stderr = sys.__stderr__
                `);
                
            } catch (error) {
                outputElement.textContent = error.message;
                outputElement.classList.add('error');
            }
        }

        // Check code against criteria
        async function checkCode(taskNumber) {
            const task = tasks[taskNumber];
            const checksContainer = document.getElementById(`checks-${taskNumber}`);
            checksContainer.style.display = 'block';
            
            if (!userProgress.taskAttempts[taskNumber]) {
                userProgress.taskAttempts[taskNumber] = 0;
            }
            userProgress.taskAttempts[taskNumber]++;
            
            await runCode(taskNumber);
            
            const code = editors[taskNumber].getValue();
            const output = document.getElementById(`output-${taskNumber}`).textContent;
            
            let allChecksPassed = true;
            
            task.checks.forEach((check, index) => {
                const passed = check.test(code, output);
                const checkIcon = document.getElementById(`checkIcon-${taskNumber}-${index}`);
                
                if (passed) {
                    checkIcon.textContent = '✓';
                    checkIcon.className = 'check-icon passed';
                } else {
                    checkIcon.textContent = '✗';
                    checkIcon.className = 'check-icon failed';
                    allChecksPassed = false;
                }
            });
            
            if (allChecksPassed && !userProgress.completedTasks[taskNumber]) {
                userProgress.completedTasks[taskNumber] = true;
                
                if (userProgress.taskAttempts[taskNumber] === 1) {
                    userProgress.firstTryTasks++;
                }
                
                if (!userProgress.hintsUsed[taskNumber]) {
                    userProgress.perfectTasks++;
                }
                
                awardXP(task.xp);
                updateProgress();
                generateTaskList();
                
                showAchievement('✅', 'Task Complete!', `${task.title} completed successfully!`, task.xp);
                checkBadges();
            }
        }

        function showHint(taskNumber) {
            const task = tasks[taskNumber];
            const hintBox = document.getElementById(`hint-${taskNumber}`);
            const hintText = document.getElementById(`hintText-${taskNumber}`);
            const hintNumber = document.getElementById(`hintNumber-${taskNumber}`);
            
            if (!userProgress.hintsUsed[taskNumber]) {
                userProgress.hintsUsed[taskNumber] = 0;
            }
            
            const currentHint = userProgress.hintsUsed[taskNumber];
            if (currentHint < task.hints.length) {
                hintBox.classList.add('show');
                hintText.textContent = task.hints[currentHint];
                hintNumber.textContent = currentHint + 1;
                userProgress.hintsUsed[taskNumber]++;
                saveAllProgress();
            }
        }

        function showSmartHint(taskNumber, hintMessage) {
            const hintBox = document.getElementById(`hint-${taskNumber}`);
            const hintText = document.getElementById(`hintText-${taskNumber}`);
            const hintHeader = hintBox.querySelector('.hint-header');
            
            hintBox.classList.add('show');
            hintHeader.innerHTML = `<span>💡</span> <strong>Smart Hint</strong>`;
            hintText.innerHTML = hintMessage;
        }

        function resetCode(taskNumber) {
            if (confirm('Are you sure you want to reset your code?')) {
                const task = tasks[taskNumber];
                editors[taskNumber].setValue(task.starterCode);
                localStorage.removeItem(`mathops-code-${task.id}`);
            }
        }

        function awardXP(amount) {
            userProgress.xp += amount;
            
            const newLevel = Math.floor(userProgress.xp / 500) + 1;
            if (newLevel > userProgress.level) {
                userProgress.level = newLevel;
                showAchievement('🎉', 'Level Up!', `You've reached Level ${newLevel}!`, 0);
            }
            
            updateProgress();
            saveAllProgress();
        }

        function updateProgress() {
            document.getElementById('userLevel').textContent = userProgress.level;
            document.getElementById('userXP').textContent = userProgress.xp;
            document.getElementById('userStreak').textContent = userProgress.streak;
            
            const xpInCurrentLevel = userProgress.xp % 500;
            const xpPercent = (xpInCurrentLevel / 500) * 100;
            document.getElementById('xpFill').style.width = `${xpPercent}%`;
            
            const completedCount = Object.keys(userProgress.completedTasks).length;
            const totalTasks = Object.keys(tasks).length;
            const progressPercent = (completedCount / totalTasks) * 100;
            document.getElementById('progressBar').style.width = `${progressPercent}%`;
            document.getElementById('progressText').textContent = `${completedCount}/${totalTasks} tasks completed`;
            
            Object.keys(BADGES).forEach(badgeId => {
                const badgeElement = document.getElementById(`badge-${badgeId}`);
                if (badgeElement && BADGES[badgeId].check()) {
                    badgeElement.classList.add('earned');
                }
            });
        }

        function checkBadges() {
            Object.keys(BADGES).forEach(badgeId => {
                if (!userProgress.badges[badgeId] && BADGES[badgeId].check()) {
                    userProgress.badges[badgeId] = true;
                    const badge = BADGES[badgeId];
                    const badgeElement = document.getElementById(`badge-${badgeId}`);
                    if (badgeElement) {
                        badgeElement.classList.add('earned');
                    }
                    showAchievement(badge.icon, 'Badge Earned!', badge.name, 50);
                    awardXP(50);
                }
            });
        }

        function showAchievement(icon, title, message, xp) {
            const popup = document.getElementById('achievementPopup');
            document.getElementById('achievementIcon').textContent = icon;
            document.getElementById('achievementTitle').textContent = title;
            document.getElementById('achievementMessage').textContent = message;
            const xpElement = document.getElementById('achievementXP');
            
            if(xp > 0) {
                xpElement.parentElement.style.display = 'block';
                xpElement.textContent = xp;
            } else {
                 xpElement.parentElement.style.display = 'none';
            }
            
            popup.classList.add('show');
            setTimeout(() => {
                popup.classList.remove('show');
            }, 4000);
        }

        function saveAllProgress() {
            localStorage.setItem('mathops-progress', JSON.stringify(userProgress));
        }

        function loadAllProgress() {
            const saved = localStorage.getItem('mathops-progress');
            if (saved) {
                userProgress = JSON.parse(saved);
                
                const today = new Date().toDateString();
                const lastVisitDate = userProgress.lastVisit ? new Date(userProgress.lastVisit) : new Date(0);
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                
                if (today !== userProgress.lastVisit) {
                    if (yesterday.toDateString() === lastVisitDate.toDateString()) {
                        userProgress.streak++;
                    } else {
                        userProgress.streak = 1;
                    }
                    userProgress.lastVisit = today;
                }
            }
            updateProgress();
        }

        function toggleExtension() {
            const section = document.getElementById('extensionSection');
            const arrow = document.getElementById('extensionArrow');
            
            if (section.style.display === 'none') {
                section.style.display = 'block';
                arrow.classList.add('open');
            } else {
                section.style.display = 'none';
                arrow.classList.remove('open');
            }
        }

        function showExtensionTopic(topic) {
            const extensionContent = document.getElementById('extensionContent');
            const taskContent = document.getElementById('taskContent');
            const gameContent = document.getElementById('gameContent');
            
            extensionContent.innerHTML = extensionTopics[topic] ? extensionTopics[topic].content : '<p>Extension topic not found.</p>';
            extensionContent.style.display = 'block';
            taskContent.style.display = 'none';
            gameContent.style.display = 'none';
            
            document.querySelectorAll('.task-item').forEach(item => {
                item.classList.remove('active');
            });
            
            setTimeout(() => {
                initializeExtensionEditors(topic);
            }, 0);
        }

        function showGameScreen() {
            const taskContent = document.getElementById('taskContent');
            const extensionContent = document.getElementById('extensionContent');
            const gameContent = document.getElementById('gameContent');
            
            // Hide other content and show game content
            taskContent.style.display = 'none';
            extensionContent.style.display = 'none';
            gameContent.style.display = 'block';
            
            // Update sidebar active state
            document.querySelectorAll('.task-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Render game selection screen
            gameContent.innerHTML = `
                <div class="task-header">
                    <h2 class="task-title">Interactive Mini-Games</h2>
                </div>
                <div class="game-selection-container">
                    <div class="game-card">
                        <h3><span class="game-icon">🚀</span> Arithmetic Ace</h3>
                        <p>Solve as many math problems as you can in 60 seconds. A fast-paced test of your operator knowledge!</p>
                        <button class="btn play-btn" onclick="openGameModal()">Play →</button>
                    </div>
                    <div class="game-card disabled">
                        <h3><span class="game-icon">☄️</span> Modulus Mission</h3>
                        <p>Dodge asteroids by identifying even and odd numbers using the modulus operator. Coming soon!</p>
                        <button class="btn play-btn" disabled>Play →</button>
                    </div>
                    <div class="game-card disabled">
                        <h3><span class="game-icon">🧪</span> Potion Master</h3>
                        <p>Mix potions by correctly calculating recipe ratios with multiplication and division. Coming soon!</p>
                        <button class="btn play-btn" disabled>Play →</button>
                    </div>
                    <div class="game-card disabled">
                        <h3><span class="game-icon">🏗️</span> Equation Builder</h3>
                        <p>Drag and drop numbers and operators to form a target number. A true test of logic! Coming soon!</p>
                        <button class="btn play-btn" disabled>Play →</button>
                    </div>
                </div>
            `;
        }
        
        function initializeExtensionEditors(topic) {
            const exampleElement = document.getElementById(`example-${topic}`);
            if (exampleElement && !extensionEditors[`example-${topic}`]) {
                extensionEditors[`example-${topic}`] = CodeMirror.fromTextArea(exampleElement, {
                    mode: 'python',
                    theme: 'solarized',
                    lineNumbers: true,
                    readOnly: true,
                    lineWrapping: true
                });
            }
            
            const practiceElement = document.getElementById(`ext-${topic}`);
            if (practiceElement && !extensionEditors[`ext-${topic}`]) {
                extensionEditors[`ext-${topic}`] = CodeMirror.fromTextArea(practiceElement, {
                    mode: 'python',
                    theme: 'monokai',
                    lineNumbers: true,
                    autoCloseBrackets: true,
                    matchBrackets: true,
                    indentUnit: 4,
                    tabSize: 4,
                    indentWithTabs: false,
                    lineWrapping: true
                });
            }
        }
        
        async function runExtensionCode(topic) {
            if (!pyodide) return;
            
            const editor = extensionEditors[`ext-${topic}`];
            if (!editor) return;
            
            const outputElement = document.getElementById(`output-ext-${topic}`);
            outputElement.textContent = 'Running...';
            outputElement.classList.remove('error');
            
            try {
                const code = editor.getValue();
                
                pyodide.runPython(`
                    import sys
                    from io import StringIO
                    sys.stdout = StringIO()
                    sys.stderr = StringIO()
                `);
                
                await pyodide.runPythonAsync(code);
                
                const stdout = pyodide.runPython("sys.stdout.getvalue()");
                const stderr = pyodide.runPython("sys.stderr.getvalue()");
                
                if (stderr) {
                    outputElement.textContent = stderr;
                    outputElement.classList.add('error');
                } else {
                    outputElement.textContent = stdout || 'No output';
                }
                
                pyodide.runPython(`
                    sys.stdout = sys.__stdout__
                    sys.stderr = sys.__stderr__
                `);
                
            } catch (error) {
                outputElement.textContent = error.message;
                outputElement.classList.add('error');
            }
        }
        
        async function checkExtensionComplete(topic) {
            const editor = extensionEditors[`ext-${topic}`];
            if (!editor) return;
            
            const code = editor.getValue();
            const outputElement = document.getElementById(`output-ext-${topic}`);
            
            await runExtensionCode(topic);
            const output = outputElement.textContent;
            
            const check = extensionChecks[topic];
            if (check.check(code, output)) {
                if (!extensionProgress[topic].completed) {
                    extensionProgress[topic].completed = true;
                    awardXP(extensionProgress[topic].xp);
                    showAchievement('🌟', 'Extension Complete!', `${extensionTopics[topic].title} completed!`, extensionProgress[topic].xp);
                    saveAllProgress();
                    checkBadges();
                } else {
                    alert('You have already completed this extension!');
                }
            } else {
                alert(`Not quite right! Hint: ${check.hint}`);
            }
        }

        function toggleAccessibility() {
            const menu = document.getElementById('accessibilityMenu');
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
        }

        function toggleDyslexicFont(enabled) {
            document.body.classList.toggle('dyslexic-font', enabled);
            localStorage.setItem('mathops-dyslexic-font', enabled);
        }

        function toggleHighContrast(enabled) {
            alert('High contrast mode is not yet implemented.');
            localStorage.setItem('mathops-high-contrast', enabled);
        }

        function loadAccessibilityPreferences() {
            const dyslexicFont = localStorage.getItem('mathops-dyslexic-font') === 'true';
            if (dyslexicFont) {
                document.body.classList.add('dyslexic-font');
                const checkbox = document.querySelector('input[onchange*="toggleDyslexicFont"]');
                if (checkbox) checkbox.checked = true;
            }
        }
        
        function exportProgress() {
            const report = {
                date: new Date().toISOString(),
                section: "Mathematical Operators",
                level: userProgress.level,
                xp: userProgress.xp,
                completedTasks: Object.keys(userProgress.completedTasks).length,
                totalTasks: Object.keys(tasks).length,
                taskDetails: Object.keys(tasks).map(taskNum => ({
                    task: tasks[taskNum].title,
                    completed: !!userProgress.completedTasks[taskNum],
                    hintsUsed: userProgress.hintsUsed[taskNum] || 0,
                    attempts: userProgress.taskAttempts[taskNum] || 0
                })),
                badges: Object.keys(userProgress.badges).map(b => BADGES[b].name),
                perfectTasks: userProgress.perfectTasks,
                firstTryTasks: userProgress.firstTryTasks,
                streak: userProgress.streak,
                extensionsCompleted: Object.entries(extensionProgress)
                    .filter(([_, prog]) => prog.completed)
                    .map(([name, _]) => extensionTopics[name].title)
            };
            
            const dataStr = JSON.stringify(report, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `math-operators-progress-${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        // --- GAME LOGIC ---
        let gameTimerInterval;
        let gameScore = 0;
        let gameCurrentAnswer = 0;
        let gameHighScore = localStorage.getItem('mathops-highscore') || 0;
        const synth = window.Tone ? new Tone.Synth().toDestination() : null;

        function openGameModal() {
            const overlay = document.getElementById('gameModalOverlay');
            overlay.style.display = 'flex';
            setTimeout(() => overlay.classList.add('show'), 10);
            
            document.getElementById('gameOverScreen').style.display = 'none';
            document.getElementById('gamePlayScreen').style.display = 'none';
            document.getElementById('gameStartScreen').style.display = 'block';
        }

        function closeGameModal() {
            clearInterval(gameTimerInterval);
            const overlay = document.getElementById('gameModalOverlay');
            overlay.classList.remove('show');
            setTimeout(() => {
                overlay.style.display = 'none';
            }, 300);
        }

        function startGame() {
            gameScore = 0;
            let timeLeft = 60;
            document.getElementById('gameScore').textContent = gameScore;
            document.getElementById('gameTimer').textContent = timeLeft;
            document.getElementById('highScore').textContent = gameHighScore;
            document.getElementById('gameStartScreen').style.display = 'none';
            document.getElementById('gameOverScreen').style.display = 'none';
            document.getElementById('gamePlayScreen').style.display = 'block';
            
            const input = document.getElementById('gameInput');
            input.disabled = false;
            input.value = '';
            input.focus();
            input.onkeyup = (event) => { 
                if (event.key === 'Enter') checkAnswer(); 
            };
            
            generateProblem();
            
            gameTimerInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('gameTimer').textContent = timeLeft;
                if (timeLeft <= 0) endGame();
            }, 1000);
        }

        function generateProblem() {
            const level = Math.floor(gameScore / 5) + 1;
            let expression;
            let displayExpression;
            const basicOps = ['+', '-', '*'];
            let num1 = Math.floor(Math.random() * 9) + 2;
            let num2 = Math.floor(Math.random() * 9) + 2;

            if (level <= 2) {
                // Basic operations (+, -, *)
                const op = basicOps[Math.floor(Math.random() * basicOps.length)];
                expression = `${num1} ${op} ${num2}`;
                displayExpression = expression;
            } else if (level <= 4) {
                // Include /, //, %, **
                const advancedOps = ['/', '//', '%', '**'];
                const op = advancedOps[Math.floor(Math.random() * advancedOps.length)];
                
                if (op === '/') {
                    num1 = num2 * (Math.floor(Math.random() * 5) + 2);
                    expression = `${num1} / ${num2}`;
                } else if (op === '//') {
                    // Floor division
                    expression = `Math.floor(${num1} / ${num2})`;
                    displayExpression = `${num1} // ${num2}`;
                } else if (op === '%') {
                    // Modulus
                    expression = `${num1} % ${num2}`;
                } else if (op === '**') {
                    // Exponent
                    num1 = Math.floor(Math.random() * 3) + 2;
                    num2 = Math.floor(Math.random() * 2) + 2;
                    expression = `${num1} ** ${num2}`;
                }
                
                if (!displayExpression) displayExpression = expression;
            } else {
                // Complex expressions with all operators
                const allOps = ['+', '-', '*', '/', '%', '**', '//'];
                const op1 = allOps[Math.floor(Math.random() * allOps.length)];
                const op2 = basicOps[Math.floor(Math.random() * basicOps.length)];
                let num3 = Math.floor(Math.random() * 5) + 2;
                
                if (op1 === '//') {
                    expression = `(Math.floor(${num1} / ${num2})) ${op2} ${num3}`;
                    displayExpression = `(${num1} // ${num2}) ${op2} ${num3}`;
                } else {
                    expression = `(${num1} ${op1} ${num2}) ${op2} ${num3}`;
                    displayExpression = expression;
                }
            }
            
            try {
                // Calculate the answer
                gameCurrentAnswer = Math.round(new Function('return ' + expression)());
            } catch(e) { 
                generateProblem(); // Regenerate if the expression is invalid
                return; 
            }
            
            // Show the expression with Python operators as-is
            document.getElementById('gameProblem').textContent = displayExpression || expression;
        }

        function checkAnswer() {
            const input = document.getElementById('gameInput');
            const userAnswer = parseInt(input.value, 10);
            
            if (userAnswer === gameCurrentAnswer) {
                gameScore++;
                document.getElementById('gameScore').textContent = gameScore;
                input.value = '';
                if (synth) synth.triggerAttackRelease("C5", "8n");
                input.classList.add('correct');
                setTimeout(() => input.classList.remove('correct'), 300);
                generateProblem();
            } else {
                if (synth) synth.triggerAttackRelease("A3", "8n");
                input.classList.add('incorrect');
                setTimeout(() => input.classList.remove('incorrect'), 300);
            }
        }

        function endGame() {
            clearInterval(gameTimerInterval);
            
            if (gameScore > gameHighScore) {
                gameHighScore = gameScore;
                localStorage.setItem('mathops-highscore', gameHighScore);
                showAchievement('🎮', 'New High Score!', `You scored ${gameScore} points!`, 20);
            }
            
            document.getElementById('finalScore').textContent = gameScore;
            document.getElementById('highScore').textContent = gameHighScore;
            document.getElementById('gamePlayScreen').style.display = 'none';
            document.getElementById('gameOverScreen').style.display = 'block';
            document.getElementById('gameInput').disabled = true;
            
            // Award XP based on score
            const xpEarned = Math.floor(gameScore * 2);
            awardXP(xpEarned);
        }
        
        // Initialize on load
        window.addEventListener('load', () => {
            loadAccessibilityPreferences();
            initializePyodide();
        });

        // Prevent text selection (robust version)
        document.addEventListener('selectstart', function(e) {
            const target = e.target;
            // Allow selection in textareas, inputs, and CodeMirror editors
            if (target.nodeType === 1 && typeof target.closest === 'function') {
                if (target.tagName !== 'TEXTAREA' && target.tagName !== 'INPUT' && !target.closest('.CodeMirror')) {
                    e.preventDefault();
                }
            } else if (target.nodeType !== 1) {
                // If it's not an element (e.g., text node), prevent selection
                e.preventDefault();
            }
        });
    </script>
</body>
</html>