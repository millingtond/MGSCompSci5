
    }<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lesson 3: AI Bias & Ethics - Year 9 Computer Science</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        
        /* Improved text selection restrictions */
        .no-select {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        /* Allow selection in text inputs */
        input[type="text"], textarea {
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
            user-select: text !important;
        }
        
        /* Animations */
        .scale-balance {
            animation: balance 3s ease-in-out infinite;
        }
        
        @keyframes balance {
            0%, 100% { transform: rotate(-5deg); }
            50% { transform: rotate(5deg); }
        }
        
        .bias-glow {
            animation: biasGlow 2s ease-in-out infinite;
        }
        
        @keyframes biasGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(239, 68, 68, 0.5); }
            50% { box-shadow: 0 0 40px rgba(239, 68, 68, 0.8); }
        }
        
        .fairness-glow {
            animation: fairnessGlow 2s ease-in-out infinite;
        }
        
        @keyframes fairnessGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(34, 197, 94, 0.5); }
            50% { box-shadow: 0 0 40px rgba(34, 197, 94, 0.8); }
        }
        
        /* Flip card styles */
        .flip-card {
            background-color: transparent;
            width: 100%;
            height: 100%;
            perspective: 1000px;
            cursor: pointer;
        }
        
        .flip-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        
        .flip-card.flipped .flip-card-inner {
            transform: rotateY(180deg);
        }
        
        .flip-card-front, .flip-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .flip-card-back {
            transform: rotateY(180deg);
        }
        
        /* Improved drag and drop */
        .draggable {
            cursor: move;
            transition: all 0.3s ease;
            touch-action: none;
        }
        
        .draggable:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .draggable.dragging {
            opacity: 0.5;
            transform: scale(1.05);
        }
        
        .draggable.selected {
            border: 3px solid #10b981;
            transform: scale(1.05);
        }
        
        .drop-zone {
            min-height: 80px;
            transition: all 0.3s ease;
        }
        
        .drop-zone.drag-over {
            background-color: #fee2e2;
            border-color: #ef4444;
            transform: scale(1.02);
        }
        
        /* Data points */
        .data-point {
            transition: all 0.3s ease;
        }
        
        .data-point.biased {
            background-color: #fee2e2;
            border-color: #ef4444;
        }
        
        .data-point.fair {
            background-color: #dcfce7;
            border-color: #22c55e;
        }
        
        /* Animations */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .pulse-animation {
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes achievementPop {
            0% { 
                transform: scale(0) rotate(0deg); 
                opacity: 0; 
            }
            50% { 
                transform: scale(1.2) rotate(5deg); 
            }
            100% { 
                transform: scale(1) rotate(0deg); 
                opacity: 1; 
            }
        }
        
        .achievement-unlock {
            animation: achievementPop 0.5s ease-out;
        }
        
        /* XP animation */
        @keyframes xpFloat {
            0% {
                transform: translateY(0);
                opacity: 1;
            }
            100% {
                transform: translateY(-50px);
                opacity: 0;
            }
        }
        
        .xp-float {
            position: fixed;
            font-weight: bold;
            font-size: 20px;
            color: #f59e0b;
            pointer-events: none;
            animation: xpFloat 1s ease-out forwards;
            z-index: 1000;
        }
        
        /* Sound toggle button */
        .sound-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            cursor: pointer;
            z-index: 100;
            transition: all 0.3s ease;
        }
        
        .sound-toggle:hover {
            transform: scale(1.1);
        }
        
        /* Progress save indicator */
        .save-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 10px 20px;
            border-radius: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 100;
        }
        
        .save-indicator.show {
            opacity: 1;
        }
        
        /* Streak counter */
        .streak-counter {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        /* Leaderboard badge colors */
        .bg-gold-100 {
            background-color: #fef3c7;
        }

        .bg-silver-100 {
            background-color: #e5e7eb;
        }

        .bg-bronze-100 {
            background-color: #fed7aa;
        }
        
        /* Mobile-friendly buttons */
        @media (max-width: 768px) {
            .flip-card {
                min-height: 200px;
            }
            
            button {
                min-height: 44px;
            }
            
            .draggable {
                padding: 12px;
                margin: 4px;
            }
        }
        
        /* Loading screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to br, from-red-50, via-orange-50, to-yellow-50);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            transition: opacity 0.5s ease;
        }
        
        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        /* Hint system */
        .hint-bubble {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            padding: 10px 15px;
            border-radius: 12px;
            font-size: 14px;
            margin-top: 10px;
            position: relative;
        }
        
        .hint-bubble::before {
            content: 'üí°';
            position: absolute;
            top: -10px;
            left: 20px;
            font-size: 20px;
        }
        
        /* Particle effect container */
        #particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 999;
        }
        
        .particle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #f59e0b;
            border-radius: 50%;
            pointer-events: none;
            animation: particleFloat 2s ease-out forwards;
        }
        
        @keyframes particleFloat {
            0% {
                opacity: 1;
                transform: translate(0, 0) scale(1);
            }
            100% {
                opacity: 0;
                transform: translate(var(--x), var(--y)) scale(0);
            }
        }
        
        /* Completed button state */
        .completed-action {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-red-50 via-orange-50 to-yellow-50 min-h-screen p-4 md:p-8">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="text-center">
            <div class="text-6xl mb-4 scale-balance">‚öñÔ∏è</div>
            <h2 class="text-2xl font-bold text-gray-800">Loading AI Ethics Lab...</h2>
            <div class="mt-4 bg-white rounded-full p-2 max-w-xs mx-auto">
                <div class="bg-gray-200 rounded-full h-3">
                    <div class="bg-gradient-to-r from-red-500 to-orange-500 h-full rounded-full transition-all duration-1000" style="width: 0%" id="loadingBar"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Particle effects container -->
    <div id="particles"></div>

    <!-- Save indicator -->
    <div id="saveIndicator" class="save-indicator">
        <span>‚úÖ Progress saved!</span>
    </div>

    <!-- Sound toggle -->
    <div id="soundToggle" class="sound-toggle no-select" onclick="toggleSound()">
        <span id="soundIcon">üîä</span>
    </div>

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="text-center mb-8 relative">
            <div class="absolute inset-0 flex justify-center items-center opacity-10">
                <div class="text-[200px] scale-balance">‚öñÔ∏è</div>
            </div>
            <h1 class="text-4xl md:text-6xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-red-600 to-orange-600 mb-2 relative z-10">
                AI Bias & Ethics ‚öñÔ∏è
            </h1>
            <p class="text-gray-600 text-lg relative z-10">Become a fairness detective and fix biased AI!</p>
            
            <!-- XP Bar with Streak Counter -->
            <div class="mt-6 bg-white rounded-full p-2 shadow-lg max-w-md mx-auto relative z-10">
                <div class="flex items-center justify-between mb-2">
                    <span id="levelDisplay" class="text-sm font-bold text-gray-700 ml-3">Level 1 Ethics Explorer</span>
                    <div class="flex items-center gap-3 mr-3">
                        <div id="streakDisplay" class="streak-counter hidden">
                            üî• <span id="streakCount">0</span>
                        </div>
                        <span class="text-sm font-bold text-red-600"><span id="xpPoints">0</span> XP</span>
                    </div>
                </div>
                <div class="bg-gray-200 rounded-full h-3">
                    <div id="xpBar" class="bg-gradient-to-r from-red-500 to-orange-500 h-full rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>
        </header>

        <!-- Starter Task -->
        <section class="bg-white rounded-xl shadow-lg p-6 md:p-8 mb-6 relative overflow-hidden">
            <div class="absolute top-0 right-0 p-4">
                <span class="text-4xl">üïµÔ∏è</span>
            </div>
            <h2 class="text-2xl md:text-3xl font-bold text-red-600 mb-4">üïµÔ∏è Starter Task: Bias Detective Training</h2>
            <p class="text-gray-700 mb-6">Can you identify different types of AI bias and match them to their solutions?</p>
            
            <!-- Task Instructions -->
            <div class="bg-blue-50 p-4 rounded-lg mb-6">
                <p class="font-semibold text-blue-800 mb-2">üéØ Your Mission:</p>
                <ol class="text-sm text-gray-700 space-y-1 list-decimal list-inside">
                    <li>Read each AI scenario carefully</li>
                    <li>Identify what type of bias is shown</li>
                    <li>Match each bias to its correct solution</li>
                    <li>Complete the reflection questions</li>
                </ol>
            </div>
            
            <!-- Progress Tracker -->
            <div class="mb-6 bg-gray-100 rounded-lg p-3">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-semibold">Detective Progress</span>
                    <span class="text-sm"><span id="biasesIdentified">0</span>/4 biases identified</span>
                </div>
                <div class="bg-gray-200 rounded-full h-3">
                    <div id="detectiveProgress" class="bg-gradient-to-r from-red-500 to-orange-500 h-full rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>
            
            <!-- Interactive Bias Scenarios -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <!-- Scenario 1 -->
                <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg">
                    <div class="flex items-start gap-3 mb-3">
                        <span class="text-2xl">üëî</span>
                        <div class="flex-1">
                            <h3 class="font-bold text-blue-800">Job Application AI</h3>
                            <p class="text-sm text-gray-700 mt-1">An AI reviewing job applications only recommends male names for engineering roles</p>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-semibold">What type of bias is this?</label>
                        <select id="bias-type-1" class="w-full p-2 border rounded" onchange="checkBiasType(1, this.value)">
                            <option value="">Select bias type...</option>
                            <option value="gender">Gender Bias</option>
                            <option value="racial">Racial Bias</option>
                            <option value="age">Age Bias</option>
                            <option value="location">Location Bias</option>
                        </select>
                        <div id="bias-feedback-1" class="text-sm"></div>
                    </div>
                </div>
                
                <!-- Scenario 2 -->
                <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-lg">
                    <div class="flex items-start gap-3 mb-3">
                        <span class="text-2xl">üì∑</span>
                        <div class="flex-1">
                            <h3 class="font-bold text-purple-800">Photo Recognition AI</h3>
                            <p class="text-sm text-gray-700 mt-1">A face recognition system works poorly for people with darker skin tones</p>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-semibold">What type of bias is this?</label>
                        <select id="bias-type-2" class="w-full p-2 border rounded" onchange="checkBiasType(2, this.value)">
                            <option value="">Select bias type...</option>
                            <option value="representation">Representation Bias</option>
                            <option value="gender">Gender Bias</option>
                            <option value="economic">Economic Bias</option>
                            <option value="cultural">Cultural Bias</option>
                        </select>
                        <div id="bias-feedback-2" class="text-sm"></div>
                    </div>
                </div>
                
                <!-- Scenario 3 -->
                <div class="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-lg">
                    <div class="flex items-start gap-3 mb-3">
                        <span class="text-2xl">üè•</span>
                        <div class="flex-1">
                            <h3 class="font-bold text-green-800">Medical AI</h3>
                            <p class="text-sm text-gray-700 mt-1">A health AI gives different risk scores based on postal codes</p>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-semibold">What type of bias is this?</label>
                        <select id="bias-type-3" class="w-full p-2 border rounded" onchange="checkBiasType(3, this.value)">
                            <option value="">Select bias type...</option>
                            <option value="location">Location/Socioeconomic Bias</option>
                            <option value="age">Age Bias</option>
                            <option value="gender">Gender Bias</option>
                            <option value="racial">Racial Bias</option>
                        </select>
                        <div id="bias-feedback-3" class="text-sm"></div>
                    </div>
                </div>
                
                <!-- Scenario 4 -->
                <div class="bg-gradient-to-br from-orange-50 to-orange-100 p-4 rounded-lg">
                    <div class="flex items-start gap-3 mb-3">
                        <span class="text-2xl">üéµ</span>
                        <div class="flex-1">
                            <h3 class="font-bold text-orange-800">Music AI</h3>
                            <p class="text-sm text-gray-700 mt-1">A music recommendation AI only suggests English songs to everyone</p>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm font-semibold">What type of bias is this?</label>
                        <select id="bias-type-4" class="w-full p-2 border rounded" onchange="checkBiasType(4, this.value)">
                            <option value="">Select bias type...</option>
                            <option value="cultural">Cultural/Language Bias</option>
                            <option value="age">Age Bias</option>
                            <option value="economic">Economic Bias</option>
                            <option value="gender">Gender Bias</option>
                        </select>
                        <div id="bias-feedback-4" class="text-sm"></div>
                    </div>
                </div>
            </div>
            
            <!-- Solution Matching -->
            <div id="solutionMatching" class="hidden mb-6">
                <h3 class="font-bold text-lg mb-4">üîß Now match each bias to its solution:</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-yellow-50 p-4 rounded-lg">
                        <h4 class="font-semibold mb-3">Biases:</h4>
                        <div class="space-y-2">
                            <div class="bg-white p-2 rounded border" draggable="true" data-bias="gender">Gender Bias</div>
                            <div class="bg-white p-2 rounded border" draggable="true" data-bias="representation">Representation Bias</div>
                            <div class="bg-white p-2 rounded border" draggable="true" data-bias="location">Location Bias</div>
                            <div class="bg-white p-2 rounded border" draggable="true" data-bias="cultural">Cultural Bias</div>
                        </div>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg">
                        <h4 class="font-semibold mb-3">Solutions:</h4>
                        <div class="space-y-2">
                            <div class="solution-drop bg-white p-3 rounded border-2 border-dashed border-gray-300" data-solution="gender">
                                <p class="text-sm text-gray-600">Use balanced gender data in training</p>
                            </div>
                            <div class="solution-drop bg-white p-3 rounded border-2 border-dashed border-gray-300" data-solution="representation">
                                <p class="text-sm text-gray-600">Include diverse skin tones in dataset</p>
                            </div>
                            <div class="solution-drop bg-white p-3 rounded border-2 border-dashed border-gray-300" data-solution="location">
                                <p class="text-sm text-gray-600">Focus on relevant factors, not location</p>
                            </div>
                            <div class="solution-drop bg-white p-3 rounded border-2 border-dashed border-gray-300" data-solution="cultural">
                                <p class="text-sm text-gray-600">Include content from all cultures</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Reflection Questions -->
            <div id="starterReflection" class="hidden bg-gradient-to-r from-red-50 to-orange-50 p-6 rounded-lg">
                <h3 class="font-bold text-lg mb-4">üìù Reflection Time</h3>
                <div class="space-y-4">
                    <div>
                        <label class="font-semibold text-sm">1. Which type of bias do you think is most harmful? Why?</label>
                        <textarea class="w-full mt-2 p-3 border rounded-lg h-20" placeholder="Type your answer..."></textarea>
                    </div>
                    <div>
                        <label class="font-semibold text-sm">2. Have you ever experienced or witnessed AI bias in real life?</label>
                        <textarea class="w-full mt-2 p-3 border rounded-lg h-20" placeholder="Type your answer..."></textarea>
                    </div>
                    <div>
                        <label class="font-semibold text-sm">3. Why is it important for AI developers to think about bias?</label>
                        <textarea class="w-full mt-2 p-3 border rounded-lg h-20" placeholder="Type your answer..."></textarea>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="completeStarter()" class="bg-red-500 text-white px-6 py-2 rounded-lg hover:bg-red-600 transition-all flex-1">
                            Complete Starter Task
                        </button>
                        <button onclick="resetStarterTask()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-all">
                            Reset Task
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Task 1: Dataset Builder -->
        <section class="bg-white rounded-xl shadow-lg p-6 md:p-8 mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-orange-600 mb-4">üîß Task 1: Build a Fair Dataset</h2>
            <p class="text-gray-700 mb-6">Help fix a biased AI by building a fair and balanced training dataset!</p>
            
            <!-- Clear Instructions -->
            <div class="bg-orange-50 p-4 rounded-lg mb-6">
                <p class="font-semibold text-orange-800 mb-2">üéØ Your Mission:</p>
                <ol class="text-sm text-gray-700 space-y-1 list-decimal list-inside">
                    <li>Analyze the current biased dataset</li>
                    <li>Select diverse data points to create balance</li>
                    <li>‚ö†Ô∏è Avoid options that would create new biases!</li>
                    <li>Watch how fairness improves in real-time</li>
                    <li>Test your dataset and see the impact</li>
                </ol>
                <div class="mt-3 bg-yellow-100 p-3 rounded-lg">
                    <p class="text-sm font-semibold text-yellow-800">üí° Pro Tip: Not all options are good! Some will make the AI more biased.</p>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Current Dataset Analysis -->
                <div>
                    <h3 class="font-bold text-lg mb-4 text-red-600">‚ùå Current Biased Dataset</h3>
                    
                    <!-- Visual representation of bias -->
                    <div class="bg-red-50 p-4 rounded-lg mb-4">
                        <div class="relative h-64">
                            <canvas id="currentDataChart"></canvas>
                        </div>
                        <div class="mt-4 grid grid-cols-2 gap-2 text-sm">
                            <div class="bg-white p-2 rounded">
                                <span class="font-semibold text-red-600">80%</span> Male students
                            </div>
                            <div class="bg-white p-2 rounded">
                                <span class="font-semibold text-red-600">90%</span> Private schools
                            </div>
                            <div class="bg-white p-2 rounded">
                                <span class="font-semibold text-red-600">85%</span> Wealthy areas
                            </div>
                            <div class="bg-white p-2 rounded">
                                <span class="font-semibold text-red-600">95%</span> Math focus
                            </div>
                        </div>
                    </div>
                    
                    <!-- Impact Display -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-semibold mb-2">‚ö†Ô∏è Problems with this data:</h4>
                        <div class="space-y-2">
                            <div class="flex items-start gap-2">
                                <span class="text-red-500">‚ùå</span>
                                <p class="text-sm">Girls are underrepresented</p>
                            </div>
                            <div class="flex items-start gap-2">
                                <span class="text-red-500">‚ùå</span>
                                <p class="text-sm">Public school students ignored</p>
                            </div>
                            <div class="flex items-start gap-2">
                                <span class="text-red-500">‚ùå</span>
                                <p class="text-sm">Only values one type of intelligence</p>
                            </div>
                            <div class="flex items-start gap-2">
                                <span class="text-red-500">‚ùå</span>
                                <p class="text-sm">Discriminates by economic status</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Dataset Builder -->
                <div>
                    <h3 class="font-bold text-lg mb-4 text-green-600">‚úÖ Build Your Fair Dataset</h3>
                    
                    <div class="bg-green-50 p-4 rounded-lg">
                        <!-- Real-time fairness meter -->
                        <div class="mb-4">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-semibold">Dataset Fairness</span>
                                <span id="fairnessPercentage" class="font-bold text-green-600">0%</span>
                            </div>
                            <div class="bg-gray-200 rounded-full h-4">
                                <div id="fairnessProgress" class="bg-gradient-to-r from-red-500 via-yellow-500 to-green-500 h-full rounded-full transition-all duration-500" style="width: 0%"></div>
                            </div>
                            <div id="mistakeCounter" class="mt-2 text-sm text-red-600 hidden">
                                ‚ö†Ô∏è Biased choices made: <span id="mistakeCount">0</span>
                            </div>
                        </div>
                        
                        <!-- Data Selection with Good and Bad Options -->
                        <div class="mb-4">
                            <p class="text-sm font-semibold mb-2">Select data points to add (choose carefully!):</p>
                            <div class="grid grid-cols-2 gap-2">
                                <!-- Good options -->
                                <button onclick="addDataPoint('gender-balance', true)" class="data-option bg-white p-3 rounded border-2 border-gray-300 hover:border-gray-400 transition-all">
                                    <span class="text-lg">üë¶üëß</span>
                                    <p class="text-xs mt-1">Gender Balance</p>
                                </button>
                                <button onclick="addDataPoint('all-schools', true)" class="data-option bg-white p-3 rounded border-2 border-gray-300 hover:border-gray-400 transition-all">
                                    <span class="text-lg">üè´</span>
                                    <p class="text-xs mt-1">All Schools</p>
                                </button>
                                
                                <!-- Bad option -->
                                <button onclick="addDataPoint('top-students', false)" class="data-option bg-white p-3 rounded border-2 border-gray-300 hover:border-gray-400 transition-all">
                                    <span class="text-lg">üèÜ</span>
                                    <p class="text-xs mt-1">Top 10% Only</p>
                                </button>
                                
                                <!-- Good option -->
                                <button onclick="addDataPoint('diverse-areas', true)" class="data-option bg-white p-3 rounded border-2 border-gray-300 hover:border-gray-400 transition-all">
                                    <span class="text-lg">üåç</span>
                                    <p class="text-xs mt-1">Diverse Areas</p>
                                </button>
                                
                                <!-- Bad option -->
                                <button onclick="addDataPoint('english-only', false)" class="data-option bg-white p-3 rounded border-2 border-gray-300 hover:border-gray-400 transition-all">
                                    <span class="text-lg">üá¨üáß</span>
                                    <p class="text-xs mt-1">English Only</p>
                                </button>
                                
                                <!-- Good option -->
                                <button onclick="addDataPoint('all-subjects', true)" class="data-option bg-white p-3 rounded border-2 border-gray-300 hover:border-gray-400 transition-all">
                                    <span class="text-lg">üé®</span>
                                    <p class="text-xs mt-1">All Subjects</p>
                                </button>
                                
                                <!-- Bad option -->
                                <button onclick="addDataPoint('tech-access', false)" class="data-option bg-white p-3 rounded border-2 border-gray-300 hover:border-gray-400 transition-all">
                                    <span class="text-lg">üíª</span>
                                    <p class="text-xs mt-1">Computer Owners</p>
                                </button>
                                
                                <!-- Good option -->
                                <button onclick="addDataPoint('age-range', true)" class="data-option bg-white p-3 rounded border-2 border-gray-300 hover:border-gray-400 transition-all">
                                    <span class="text-lg">üìÖ</span>
                                    <p class="text-xs mt-1">All Ages</p>
                                </button>
                                
                                <!-- Bad option -->
                                <button onclick="addDataPoint('urban-only', false)" class="data-option bg-white p-3 rounded border-2 border-gray-300 hover:border-gray-400 transition-all">
                                    <span class="text-lg">üèôÔ∏è</span>
                                    <p class="text-xs mt-1">Cities Only</p>
                                </button>
                                
                                <!-- Good option -->
                                <button onclick="addDataPoint('cultures', true)" class="data-option bg-white p-3 rounded border-2 border-gray-300 hover:border-gray-400 transition-all">
                                    <span class="text-lg">üåè</span>
                                    <p class="text-xs mt-1">All Cultures</p>
                                </button>
                                
                                <!-- Bad option -->
                                <button onclick="addDataPoint('recent-only', false)" class="data-option bg-white p-3 rounded border-2 border-gray-300 hover:border-gray-400 transition-all">
                                    <span class="text-lg">üì±</span>
                                    <p class="text-xs mt-1">2024 Data Only</p>
                                </button>
                                
                                <!-- Good option -->
                                <button onclick="addDataPoint('abilities', true)" class="data-option bg-white p-3 rounded border-2 border-gray-300 hover:border-gray-400 transition-all">
                                    <span class="text-lg">‚ôø</span>
                                    <p class="text-xs mt-1">All Abilities</p>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Feedback Display -->
                        <div id="selectionFeedback" class="mb-4"></div>
                        
                        <!-- New Dataset Preview -->
                        <div class="bg-white p-3 rounded-lg mb-4">
                            <h4 class="font-semibold text-sm mb-2">Your New Dataset:</h4>
                            <div class="relative h-48">
                                <canvas id="newDataChart"></canvas>
                            </div>
                            <div id="datasetStats" class="mt-2 text-xs text-gray-600"></div>
                        </div>
                        
                        <!-- Test Dataset Button -->
                        <button onclick="testFairDataset()" class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition-all w-full font-semibold">
                            Test Dataset on AI
                        </button>
                        
                        <button onclick="resetDataset()" class="mt-2 bg-gray-400 text-white px-4 py-2 rounded-lg hover:bg-gray-500 transition-all w-full">
                            Start Over
                        </button>
                        
                        <div id="datasetResults" class="mt-4"></div>
                    </div>
                </div>
            </div>
            
            <!-- Impact Comparison -->
            <div id="impactComparison" class="hidden mt-6 bg-gradient-to-r from-orange-50 to-yellow-50 p-6 rounded-lg">
                <h3 class="font-bold text-lg mb-4">üìä See the Difference!</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="font-semibold mb-2">Before (Biased AI):</h4>
                        <div class="bg-white p-4 rounded-lg">
                            <p class="text-sm">‚úÖ Accepts: Rich boys good at math</p>
                            <p class="text-sm">‚ùå Rejects: Everyone else</p>
                            <p class="text-sm mt-2 text-red-600">Unfair to 85% of students!</p>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-semibold mb-2">After (Fair AI):</h4>
                        <div class="bg-white p-4 rounded-lg">
                            <p class="text-sm">‚úÖ Considers: All talents equally</p>
                            <p class="text-sm">‚úÖ Fair to: All backgrounds</p>
                            <p class="text-sm mt-2 text-green-600">Works for 100% of students!</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Reflection Questions -->
            <div id="task1Reflection" class="hidden bg-gradient-to-r from-orange-50 to-yellow-50 p-6 rounded-lg mt-6">
                <h3 class="font-bold text-lg mb-4">üìù Reflection Time</h3>
                <div class="space-y-4">
                    <div>
                        <label class="font-semibold text-sm">1. Why were some options (like "Top 10% Only") bad choices? How would they create new biases?</label>
                        <textarea class="w-full mt-2 p-3 border rounded-lg h-20" placeholder="Think about who gets excluded..."></textarea>
                    </div>
                    <div>
                        <label class="font-semibold text-sm">2. What could happen if we used the biased dataset in a real school?</label>
                        <textarea class="w-full mt-2 p-3 border rounded-lg h-20" placeholder="Consider the impact on different students..."></textarea>
                    </div>
                    <div>
                        <label class="font-semibold text-sm">3. How would you collect data fairly if you were building an AI?</label>
                        <textarea class="w-full mt-2 p-3 border rounded-lg h-20" placeholder="What steps would you take?"></textarea>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="completeTask1()" class="bg-orange-500 text-white px-6 py-2 rounded-lg hover:bg-orange-600 transition-all flex-1">
                            Complete Task 1
                        </button>
                        <button onclick="resetTask1()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-all">
                            Reset Task
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Task 2: Bias Challenge System -->
        <section class="bg-white rounded-xl shadow-lg p-6 md:p-8 mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-purple-600 mb-4">üéÆ Task 2: AI Bias Challenge Arena</h2>
            <p class="text-gray-700 mb-6">Complete challenges to understand and fix AI bias in real-world scenarios!</p>
            
            <!-- Progress and Score Display -->
            <div class="bg-gradient-to-r from-purple-100 to-pink-100 p-4 rounded-lg mb-6">
                <div class="flex flex-wrap justify-between items-center gap-4">
                    <div class="flex items-center gap-6">
                        <div class="text-center">
                            <p class="text-xs text-gray-600">Challenge Score</p>
                            <p class="text-2xl font-bold text-purple-700" id="challengeScore">0</p>
                        </div>
                        <div class="text-center">
                            <p class="text-xs text-gray-600">Challenges Complete</p>
                            <p class="text-2xl font-bold text-purple-700"><span id="challengesComplete">0</span>/4</p>
                        </div>
                        <div class="text-center">
                            <p class="text-xs text-gray-600">Current Streak</p>
                            <p class="text-2xl font-bold text-orange-600">üî• <span id="challengeStreak">0</span></p>
                        </div>
                    </div>
                    <div id="timerDisplay" class="hidden">
                        <p class="text-xs text-gray-600">Time Remaining</p>
                        <p class="text-2xl font-bold text-red-600" id="challengeTimer">2:00</p>
                    </div>
                </div>
            </div>
            
            <!-- Challenge Selection -->
            <div id="challengeSelection" class="mb-6">
                <h3 class="font-bold text-lg mb-4">Choose Your Challenge:</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Challenge 1: Pattern Detection -->
                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg hover:shadow-lg transition-all cursor-pointer" onclick="startChallenge('pattern')">
                        <div class="flex items-center gap-3 mb-2">
                            <span class="text-3xl">üïµÔ∏è</span>
                            <h4 class="font-bold text-blue-700">Pattern Detective</h4>
                        </div>
                        <p class="text-sm text-gray-600">Analyze AI decisions and spot hidden biases</p>
                        <div class="mt-3 flex items-center justify-between">
                            <span class="text-xs bg-blue-200 text-blue-800 px-2 py-1 rounded">Difficulty: Medium</span>
                            <span class="text-xs text-gray-500">‚≠ê 100 pts</span>
                        </div>
                    </div>
                    
                    <!-- Challenge 2: Real-World Case -->
                    <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-lg hover:shadow-lg transition-all cursor-pointer" onclick="startChallenge('realworld')">
                        <div class="flex items-center gap-3 mb-2">
                            <span class="text-3xl">üåç</span>
                            <h4 class="font-bold text-purple-700">Real-World Case</h4>
                        </div>
                        <p class="text-sm text-gray-600">Solve actual AI bias problems from companies</p>
                        <div class="mt-3 flex items-center justify-between">
                            <span class="text-xs bg-purple-200 text-purple-800 px-2 py-1 rounded">Difficulty: Hard</span>
                            <span class="text-xs text-gray-500">‚≠ê 150 pts</span>
                        </div>
                    </div>
                    
                    <!-- Challenge 3: Build Fair AI -->
                    <div class="bg-gradient-to-br from-orange-50 to-orange-100 p-4 rounded-lg hover:shadow-lg transition-all cursor-pointer" onclick="startChallenge('build')">
                        <div class="flex items-center gap-3 mb-2">
                            <span class="text-3xl">üèóÔ∏è</span>
                            <h4 class="font-bold text-orange-700">Fair AI Builder</h4>
                        </div>
                        <p class="text-sm text-gray-600">Design an AI system with zero bias</p>
                        <div class="mt-3 flex items-center justify-between">
                            <span class="text-xs bg-orange-200 text-orange-800 px-2 py-1 rounded">Difficulty: Hard</span>
                            <span class="text-xs text-gray-500">‚≠ê 150 pts</span>
                        </div>
                    </div>
                    
                    <!-- Challenge 4: Speed Round -->
                    <div class="bg-gradient-to-br from-red-50 to-red-100 p-4 rounded-lg hover:shadow-lg transition-all cursor-pointer" onclick="startChallenge('speed')">
                        <div class="flex items-center gap-3 mb-2">
                            <span class="text-3xl">‚ö°</span>
                            <h4 class="font-bold text-red-700">Speed Challenge</h4>
                        </div>
                        <p class="text-sm text-gray-600">Fix as many biases as possible in 60 seconds</p>
                        <div class="mt-3 flex items-center justify-between">
                            <span class="text-xs bg-red-200 text-red-800 px-2 py-1 rounded">Difficulty: Varies</span>
                            <span class="text-xs text-gray-500">‚≠ê Up to 200 pts</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Challenge Arena (Hidden until challenge starts) -->
            <div id="challengeArena" class="hidden">
                <!-- Pattern Detection Challenge -->
                <div id="patternChallenge" class="hidden">
                    <div class="bg-white p-6 rounded-lg border-2 border-purple-300">
                        <h3 class="font-bold text-xl mb-4">üïµÔ∏è Pattern Detective Challenge</h3>
                        <p class="text-gray-600 mb-4">Analyze these AI loan decisions and identify the bias pattern:</p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div class="bg-green-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-green-700 mb-3">‚úÖ Approved Loans:</h4>
                                <div class="space-y-2 text-sm" id="approvedList">
                                    <!-- Dynamically populated -->
                                </div>
                            </div>
                            <div class="bg-red-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-red-700 mb-3">‚ùå Rejected Loans:</h4>
                                <div class="space-y-2 text-sm" id="rejectedList">
                                    <!-- Dynamically populated -->
                                </div>
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="font-semibold">What type of bias do you see?</label>
                                <select id="biasTypeAnswer" class="w-full mt-2 p-2 border rounded">
                                    <option value="">Select the bias type...</option>
                                    <option value="gender">Gender Bias</option>
                                    <option value="age">Age Bias</option>
                                    <option value="location">Location/Postal Code Bias</option>
                                    <option value="name">Name/Ethnicity Bias</option>
                                    <option value="occupation">Occupation Bias</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="font-semibold">Explain the pattern you found:</label>
                                <textarea id="patternExplanation" class="w-full mt-2 p-3 border rounded h-20" 
                                    placeholder="Describe what the AI is doing wrong..."></textarea>
                            </div>
                            
                            <button onclick="checkPatternAnswer()" class="bg-purple-500 text-white px-6 py-3 rounded-lg hover:bg-purple-600 transition-all w-full">
                                Submit Answer
                            </button>
                        </div>
                        
                        <div id="patternFeedback" class="mt-4"></div>
                    </div>
                </div>
                
                <!-- Real-World Case Challenge -->
                <div id="realworldChallenge" class="hidden">
                    <div class="bg-white p-6 rounded-lg border-2 border-purple-300">
                        <h3 class="font-bold text-xl mb-4">üåç Real-World Case: The Resume Scanner</h3>
                        
                        <div class="bg-yellow-50 p-4 rounded-lg mb-4">
                            <p class="font-semibold text-yellow-800">üì∞ News Flash:</p>
                            <p class="text-sm text-gray-700 mt-1">
                                A major tech company discovered their AI resume scanner rejected 78% of qualified female candidates 
                                while accepting 65% of less-qualified male candidates. You've been hired to fix it!
                            </p>
                        </div>
                        
                        <div class="mb-6">
                            <h4 class="font-semibold mb-3">üìä Your Investigation Data:</h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="bg-white p-3 rounded border">
                                    <p class="text-xs text-gray-600">Training Data</p>
                                    <p class="font-semibold">85% male resumes</p>
                                </div>
                                <div class="bg-white p-3 rounded border">
                                    <p class="text-xs text-gray-600">Keywords Favored</p>
                                    <p class="font-semibold">"aggressive", "dominant"</p>
                                </div>
                                <div class="bg-white p-3 rounded border">
                                    <p class="text-xs text-gray-600">Penalized Words</p>
                                    <p class="font-semibold">"collaborative", "supportive"</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            <h4 class="font-semibold">Your Action Plan:</h4>
                            
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <label class="font-semibold text-sm">Step 1: Identify Root Causes (select all that apply)</label>
                                <div class="mt-2 space-y-2">
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" value="training-data">
                                        <span class="text-sm">Biased training data (mostly male resumes)</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" value="keywords">
                                        <span class="text-sm">Gender-coded keywords in evaluation</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" value="historical">
                                        <span class="text-sm">Historical hiring patterns reinforced</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" value="names">
                                        <span class="text-sm">Algorithm learned name-gender associations</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <label class="font-semibold text-sm">Step 2: Propose Solutions (rank in order of importance)</label>
                                <div class="mt-2 space-y-2" id="solutionsList">
                                    <div class="bg-white p-2 rounded border cursor-move" draggable="true" data-solution="balance-data">
                                        Balance training data 50/50 male/female
                                    </div>
                                    <div class="bg-white p-2 rounded border cursor-move" draggable="true" data-solution="remove-names">
                                        Remove names and gender indicators before processing
                                    </div>
                                    <div class="bg-white p-2 rounded border cursor-move" draggable="true" data-solution="neutral-keywords">
                                        Use gender-neutral keyword evaluation
                                    </div>
                                    <div class="bg-white p-2 rounded border cursor-move" draggable="true" data-solution="diverse-team">
                                        Have diverse team review AI decisions
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <label class="font-semibold text-sm">Step 3: Implementation Plan</label>
                                <textarea class="w-full mt-2 p-3 border rounded h-24" id="implementationPlan"
                                    placeholder="Describe how you would implement these changes..."></textarea>
                            </div>
                            
                            <button onclick="submitRealWorldSolution()" class="bg-purple-500 text-white px-6 py-3 rounded-lg hover:bg-purple-600 transition-all w-full">
                                Submit Solution
                            </button>
                        </div>
                        
                        <div id="realworldFeedback" class="mt-4"></div>
                    </div>
                </div>
                
                <!-- Build Fair AI Challenge -->
                <div id="buildChallenge" class="hidden">
                    <div class="bg-white p-6 rounded-lg border-2 border-orange-300">
                        <h3 class="font-bold text-xl mb-4">üèóÔ∏è Build a Fair Student Assessment AI</h3>
                        <p class="text-gray-600 mb-4">Design an AI that fairly evaluates students for university admission:</p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Decision Factors -->
                            <div>
                                <h4 class="font-semibold mb-3">Select Fair Evaluation Factors:</h4>
                                <div class="space-y-2">
                                    <!-- Good factors -->
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="factor-checkbox" value="grades" data-weight="20" data-good="true">
                                        <span class="text-sm">Academic Grades</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="factor-checkbox" value="activities" data-weight="15" data-good="true">
                                        <span class="text-sm">Extracurricular Activities</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="factor-checkbox" value="statement" data-weight="20" data-good="true">
                                        <span class="text-sm">Personal Statement</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="factor-checkbox" value="potential" data-weight="15" data-good="true">
                                        <span class="text-sm">Growth Potential</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="factor-checkbox" value="challenges" data-weight="10" data-good="true">
                                        <span class="text-sm">Challenges Overcome</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="factor-checkbox" value="community" data-weight="10" data-good="true">
                                        <span class="text-sm">Community Service</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="factor-checkbox" value="interview" data-weight="10" data-good="true">
                                        <span class="text-sm">Interview Performance</span>
                                    </label>
                                    
                                    <!-- Bad factors (no visual indication) -->
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="factor-checkbox" value="school-type" data-weight="0" data-good="false">
                                        <span class="text-sm">Private/Public School Type</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="factor-checkbox" value="postal-code" data-weight="0" data-good="false">
                                        <span class="text-sm">Home Postal Code</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="factor-checkbox" value="parent-job" data-weight="0" data-good="false">
                                        <span class="text-sm">Parent's Occupation</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="factor-checkbox" value="family-income" data-weight="0" data-good="false">
                                        <span class="text-sm">Family Income Level</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="factor-checkbox" value="legacy" data-weight="0" data-good="false">
                                        <span class="text-sm">Legacy Status (Family Alumni)</span>
                                    </label>
                                </div>
                                
                                <div class="mt-4 p-3 bg-yellow-50 rounded">
                                    <p class="text-sm font-semibold">Total Weight: <span id="totalWeight">0</span>%</p>
                                    <p class="text-xs text-gray-600">Must equal 100%</p>
                                </div>
                            </div>
                            
                            <!-- Safeguards -->
                            <div>
                                <h4 class="font-semibold mb-3">Add Fairness Safeguards:</h4>
                                <div class="space-y-2">
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="safeguard-checkbox" value="blind-review">
                                        <span class="text-sm">Blind review (hide names/photos)</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="safeguard-checkbox" value="context-aware">
                                        <span class="text-sm">Consider student's context</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="safeguard-checkbox" value="diverse-review">
                                        <span class="text-sm">Diverse review committee</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="safeguard-checkbox" value="bias-testing">
                                        <span class="text-sm">Regular bias testing</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="safeguard-checkbox" value="appeal-process">
                                        <span class="text-sm">Fair appeal process</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="safeguard-checkbox" value="transparency">
                                        <span class="text-sm">Transparent scoring criteria</span>
                                    </label>
                                </div>
                                
                                <div class="mt-4">
                                    <h5 class="font-semibold text-sm mb-2">Test Your AI:</h5>
                                    <button onclick="testFairAI()" class="bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600 transition-all w-full">
                                        Run Fairness Test
                                    </button>
                                </div>
                                
                                <div id="aiTestResults" class="mt-4"></div>
                            </div>
                        </div>
                        
                        <div id="buildFeedback" class="mt-4"></div>
                    </div>
                </div>
                
                <!-- Speed Challenge -->
                <div id="speedChallenge" class="hidden">
                    <div class="bg-white p-6 rounded-lg border-2 border-red-300">
                        <h3 class="font-bold text-xl mb-4">‚ö° Speed Bias Buster Challenge</h3>
                        <p class="text-gray-600 mb-4">Fix as many biased statements as possible in 60 seconds!</p>
                        
                        <div class="text-center mb-6">
                            <p class="text-4xl font-bold text-red-600" id="speedTimer">60</p>
                            <p class="text-sm text-gray-600">seconds remaining</p>
                        </div>
                        
                        <div id="speedQuestion" class="bg-gray-50 p-6 rounded-lg mb-4">
                            <!-- Dynamically populated -->
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <button onclick="speedAnswer('biased')" class="bg-red-500 text-white px-6 py-3 rounded-lg hover:bg-red-600 transition-all text-lg font-bold">
                                ‚ùå BIASED
                            </button>
                            <button onclick="speedAnswer('fair')" class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition-all text-lg font-bold">
                                ‚úÖ FAIR
                            </button>
                        </div>
                        
                        <div class="mt-6 text-center">
                            <p class="text-lg">Score: <span id="speedScore" class="font-bold text-2xl text-purple-600">0</span></p>
                            <p class="text-sm text-gray-600">Correct: <span id="speedCorrect">0</span> | Wrong: <span id="speedWrong">0</span></p>
                        </div>
                        
                        <div id="speedFeedback" class="mt-4"></div>
                    </div>
                </div>
                
                <!-- Back to challenges button -->
                <div class="mt-6 text-center">
                    <button onclick="backToChallenges()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-all">
                        Back to Challenges
                    </button>
                </div>
            </div>
            
            <!-- Leaderboard Section -->
            <div class="mt-6 bg-gradient-to-r from-yellow-50 to-orange-50 p-6 rounded-lg">
                <h3 class="font-bold text-lg mb-4">üèÜ Challenge Leaderboard</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="font-semibold mb-3">Your Best Scores:</h4>
                        <div class="space-y-2" id="personalScores">
                            <div class="bg-white p-3 rounded flex justify-between items-center">
                                <span>Pattern Detective</span>
                                <span class="font-bold text-blue-600">--</span>
                            </div>
                            <div class="bg-white p-3 rounded flex justify-between items-center">
                                <span>Real-World Case</span>
                                <span class="font-bold text-purple-600">--</span>
                            </div>
                            <div class="bg-white p-3 rounded flex justify-between items-center">
                                <span>Fair AI Builder</span>
                                <span class="font-bold text-orange-600">--</span>
                            </div>
                            <div class="bg-white p-3 rounded flex justify-between items-center">
                                <span>Speed Challenge</span>
                                <span class="font-bold text-red-600">--</span>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-semibold mb-3">Top Performers:</h4>
                        <div class="space-y-2" id="leaderboardDisplay">
                            <!-- Dynamic leaderboard -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Reflection Questions (Hidden until challenges complete) -->
            <div id="task2Reflection" class="hidden bg-gradient-to-r from-purple-50 to-pink-50 p-6 rounded-lg mt-6">
                <h3 class="font-bold text-lg mb-4">üìù Reflection Time</h3>
                <div class="space-y-4">
                    <div>
                        <label class="font-semibold text-sm">1. Which challenge taught you the most about AI bias? Why?</label>
                        <textarea class="w-full mt-2 p-3 border rounded-lg h-20" placeholder="Think about what surprised you..."></textarea>
                    </div>
                    <div>
                        <label class="font-semibold text-sm">2. In the real-world case, what was the most important fix? Explain your reasoning.</label>
                        <textarea class="w-full mt-2 p-3 border rounded-lg h-20" placeholder="Consider long-term impact..."></textarea>
                    </div>
                    <div>
                        <label class="font-semibold text-sm">3. How would you explain AI bias to someone who's never heard of it?</label>
                        <textarea class="w-full mt-2 p-3 border rounded-lg h-20" placeholder="Use simple language..."></textarea>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="completeTask2()" class="bg-purple-500 text-white px-6 py-2 rounded-lg hover:bg-purple-600 transition-all flex-1">
                            Complete Task 2
                        </button>
                        <button onclick="resetTask2()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-all">
                            Reset Task
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Task 3: Design Ethical AI -->
        <section class="bg-white rounded-xl shadow-lg p-6 md:p-8 mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-green-600 mb-4">üõ°Ô∏è Task 3: Design Your Ethical AI System</h2>
            <p class="text-gray-700 mb-6">You're the lead developer! Design an AI system that's fair, transparent, and ethical.</p>
            
            <!-- Clear Instructions -->
            <div class="bg-green-50 p-4 rounded-lg mb-6">
                <p class="font-semibold text-green-800 mb-2">üéØ Your Mission:</p>
                <ol class="text-sm text-gray-700 space-y-1 list-decimal list-inside">
                    <li>Choose your AI's purpose and users</li>
                    <li>Select ethical principles to follow</li>
                    <li>Design safety features and protections</li>
                    <li>Create your AI Ethics Charter</li>
                </ol>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- AI Design Canvas -->
                <div class="bg-gradient-to-br from-blue-50 to-green-50 p-6 rounded-lg">
                    <h3 class="font-bold text-lg mb-4">üé® AI Design Canvas</h3>
                    
                    <!-- Step 1: Choose Purpose -->
                    <div class="bg-white p-4 rounded-lg mb-4">
                        <h4 class="font-semibold mb-2">Step 1: What will your AI do?</h4>
                        <select id="aiPurpose" class="w-full p-2 border rounded" onchange="updateDesignCanvas()">
                            <option value="">Select AI purpose...</option>
                            <option value="education">Help students learn</option>
                            <option value="health">Assist with health decisions</option>
                            <option value="safety">Keep people safe online</option>
                            <option value="environment">Protect the environment</option>
                            <option value="accessibility">Help disabled people</option>
                        </select>
                    </div>
                    
                    <!-- Step 2: Ethical Principles -->
                    <div class="bg-white p-4 rounded-lg mb-4">
                        <h4 class="font-semibold mb-2">Step 2: Core Ethical Principles</h4>
                        <div class="space-y-2">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" class="ethics-checkbox w-4 h-4" data-good="true" onchange="updateEthicsDesign()">
                                <span class="text-sm">üåç Works fairly for everyone</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" class="ethics-checkbox w-4 h-4" data-good="false" onchange="updateEthicsDesign()">
                                <span class="text-sm">üí∞ Maximize profit above all</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" class="ethics-checkbox w-4 h-4" data-good="true" onchange="updateEthicsDesign()">
                                <span class="text-sm">üîí Protects user privacy</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" class="ethics-checkbox w-4 h-4" data-good="true" onchange="updateEthicsDesign()">
                                <span class="text-sm">üìñ Explains all decisions</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" class="ethics-checkbox w-4 h-4" data-good="false" onchange="updateEthicsDesign()">
                                <span class="text-sm">üéØ Track users without consent</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" class="ethics-checkbox w-4 h-4" data-good="true" onchange="updateEthicsDesign()">
                                <span class="text-sm">‚ôø Accessible to all abilities</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" class="ethics-checkbox w-4 h-4" data-good="false" onchange="updateEthicsDesign()">
                                <span class="text-sm">üîê Keep AI decisions secret</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" class="ethics-checkbox w-4 h-4" data-good="true" onchange="updateEthicsDesign()">
                                <span class="text-sm">üåê Works in all languages</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" class="ethics-checkbox w-4 h-4" data-good="true" onchange="updateEthicsDesign()">
                                <span class="text-sm">üë• Human oversight required</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" class="ethics-checkbox w-4 h-4" data-good="false" onchange="updateEthicsDesign()">
                                <span class="text-sm">‚ö° Speed over accuracy</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" class="ethics-checkbox w-4 h-4" data-good="true" onchange="updateEthicsDesign()">
                                <span class="text-sm">üö´ No harmful uses allowed</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" class="ethics-checkbox w-4 h-4" data-good="true" onchange="updateEthicsDesign()">
                                <span class="text-sm">üìä Regular bias testing</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Step 3: Safety Features -->
                    <div class="bg-white p-4 rounded-lg">
                        <h4 class="font-semibold mb-2">Step 3: Safety Features</h4>
                        <div class="space-y-2">
                            <button onclick="addSafetyFeature('age-check', true)" class="safety-feature w-full text-left p-2 border rounded hover:bg-blue-50 transition-all">
                                üë∂ Age verification system
                            </button>
                            <button onclick="addSafetyFeature('data-collection', false)" class="safety-feature w-full text-left p-2 border rounded hover:bg-blue-50 transition-all">
                                üìä Collect all user data
                            </button>
                            <button onclick="addSafetyFeature('report', true)" class="safety-feature w-full text-left p-2 border rounded hover:bg-blue-50 transition-all">
                                üö® Report problems button
                            </button>
                            <button onclick="addSafetyFeature('no-opt-out', false)" class="safety-feature w-full text-left p-2 border rounded hover:bg-blue-50 transition-all">
                                üîí No opt-out options
                            </button>
                            <button onclick="addSafetyFeature('limits', true)" class="safety-feature w-full text-left p-2 border rounded hover:bg-blue-50 transition-all">
                                ‚è±Ô∏è Usage time limits
                            </button>
                            <button onclick="addSafetyFeature('sell-data', false)" class="safety-feature w-full text-left p-2 border rounded hover:bg-blue-50 transition-all">
                                üí∞ Sell user patterns
                            </button>
                            <button onclick="addSafetyFeature('parent', true)" class="safety-feature w-full text-left p-2 border rounded hover:bg-blue-50 transition-all">
                                üë®‚Äçüë©‚Äçüëß Parent/teacher controls
                            </button>
                            <button onclick="addSafetyFeature('addictive', false)" class="safety-feature w-full text-left p-2 border rounded hover:bg-blue-50 transition-all">
                                üéÆ Addictive features
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- AI Preview & Testing -->
                <div>
                    <h3 class="font-bold text-lg mb-4">ü§ñ Your AI System Preview</h3>
                    
                    <!-- AI Card -->
                    <div id="aiPreview" class="bg-gradient-to-br from-green-100 to-blue-100 p-6 rounded-lg mb-4">
                        <div class="text-center mb-4">
                            <div class="text-6xl mb-2" id="aiIcon">ü§ñ</div>
                            <h4 class="text-xl font-bold" id="aiName">Your Ethical AI</h4>
                            <p class="text-sm text-gray-600" id="aiDescription">Design your AI to see preview</p>
                        </div>
                        
                        <!-- Ethics Score Display -->
                        <div class="bg-white p-4 rounded-lg">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-semibold">Ethics Score</span>
                                <span class="text-2xl font-bold text-green-600" id="ethicsScoreDisplay">0/8</span>
                            </div>
                            <div class="bg-gray-200 rounded-full h-4">
                                <div id="ethicsProgressBar" class="bg-gradient-to-r from-green-400 to-green-600 h-full rounded-full transition-all duration-500" style="width: 0%"></div>
                            </div>
                            <div id="ethicsBadges" class="flex flex-wrap gap-2 mt-3">
                                <!-- Ethics badges will appear here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ethical Dilemma Scenarios -->
                    <div class="space-y-3">
                        <h4 class="font-semibold">Test Your AI's Ethics:</h4>
                        
                        <div class="bg-orange-50 p-4 rounded-lg">
                            <p class="font-semibold text-orange-700 mb-2">Scenario 1: Privacy vs Safety</p>
                            <p class="text-sm text-gray-700 mb-3">
                                Your AI detects a student might be in danger. What should it do?
                            </p>
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="handleDilemma(1, 'alert')" class="bg-orange-100 hover:bg-orange-200 px-3 py-2 rounded text-sm transition-all">
                                    Alert authorities
                                </button>
                                <button onclick="handleDilemma(1, 'ask')" class="bg-orange-100 hover:bg-orange-200 px-3 py-2 rounded text-sm transition-all">
                                    Ask permission first
                                </button>
                            </div>
                            <div id="scenario1-feedback" class="mt-2 text-sm"></div>
                        </div>
                        
                        <div class="bg-purple-50 p-4 rounded-lg">
                            <p class="font-semibold text-purple-700 mb-2">Scenario 2: Fairness vs Performance</p>
                            <p class="text-sm text-gray-700 mb-3">
                                Your AI works better for some groups. Should you launch it?
                            </p>
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="handleDilemma(2, 'wait')" class="bg-purple-100 hover:bg-purple-200 px-3 py-2 rounded text-sm transition-all">
                                    Wait and improve
                                </button>
                                <button onclick="handleDilemma(2, 'launch')" class="bg-purple-100 hover:bg-purple-200 px-3 py-2 rounded text-sm transition-all">
                                    Launch with warnings
                                </button>
                            </div>
                            <div id="scenario2-feedback" class="mt-2 text-sm"></div>
                        </div>
                        
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <p class="font-semibold text-blue-700 mb-2">Scenario 3: Transparency vs Simplicity</p>
                            <p class="text-sm text-gray-700 mb-3">
                                How much should your AI explain its decisions to users?
                            </p>
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="handleDilemma(3, 'full')" class="bg-blue-100 hover:bg-blue-200 px-3 py-2 rounded text-sm transition-all">
                                    Full explanations
                                </button>
                                <button onclick="handleDilemma(3, 'simple')" class="bg-blue-100 hover:bg-blue-200 px-3 py-2 rounded text-sm transition-all">
                                    Simple summaries
                                </button>
                            </div>
                            <div id="scenario3-feedback" class="mt-2 text-sm"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Create Your AI Ethics Charter -->
            <div class="mt-6 bg-gradient-to-r from-green-50 to-blue-50 p-6 rounded-lg">
                <h3 class="font-bold text-lg mb-4">üìú Create Your AI Ethics Charter</h3>
                <p class="text-sm text-gray-700 mb-4">Based on your design, write the core rules your AI must follow:</p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="bg-white p-4 rounded-lg">
                        <h4 class="font-semibold mb-2">Your AI's Mission Statement</h4>
                        <textarea id="missionStatement" class="w-full p-2 border rounded h-24" 
                            placeholder="What is your AI's main purpose and who does it help?"></textarea>
                    </div>
                    <div class="bg-white p-4 rounded-lg">
                        <h4 class="font-semibold mb-2">Key Values</h4>
                        <textarea id="keyValues" class="w-full p-2 border rounded h-24" 
                            placeholder="What values guide your AI? (fairness, privacy, safety, etc.)"></textarea>
                    </div>
                </div>
                
                <div class="space-y-3">
                    <div class="bg-white p-3 rounded-lg">
                        <label class="font-semibold text-sm">Rule 1: Fairness</label>
                        <input type="text" id="rule1" class="w-full mt-1 p-2 border-2 border-green-200 rounded-md focus:border-green-400 focus:outline-none" 
                            placeholder="e.g., Our AI will treat all users equally regardless of...">
                    </div>
                    
                    <div class="bg-white p-3 rounded-lg">
                        <label class="font-semibold text-sm">Rule 2: Transparency</label>
                        <input type="text" id="rule2" class="w-full mt-1 p-2 border-2 border-blue-200 rounded-md focus:border-blue-400 focus:outline-none" 
                            placeholder="e.g., Our AI will always explain its decisions by...">
                    </div>
                    
                    <div class="bg-white p-3 rounded-lg">
                        <label class="font-semibold text-sm">Rule 3: Safety</label>
                        <input type="text" id="rule3" class="w-full mt-1 p-2 border-2 border-purple-200 rounded-md focus:border-purple-400 focus:outline-none" 
                            placeholder="e.g., Our AI will protect users by...">
                    </div>
                    
                    <div class="bg-white p-3 rounded-lg">
                        <label class="font-semibold text-sm">Rule 4: Accountability</label>
                        <input type="text" id="rule4" class="w-full mt-1 p-2 border-2 border-orange-200 rounded-md focus:border-orange-400 focus:outline-none" 
                            placeholder="e.g., Humans will always be able to...">
                    </div>
                </div>
                
                <div class="mt-4 flex gap-3">
                    <button onclick="generateCertificate()" class="bg-gradient-to-r from-green-500 to-blue-500 text-white px-6 py-3 rounded-lg hover:from-green-600 hover:to-blue-600 transition-all flex-1">
                        Generate AI Ethics Certificate
                    </button>
                    <button onclick="shareDesign()" class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-all">
                        Share Design
                    </button>
                </div>
            </div>
            
            <!-- Reflection Questions -->
            <div id="task3Reflection" class="bg-gradient-to-r from-green-50 to-blue-50 p-6 rounded-lg mt-6">
                <h3 class="font-bold text-lg mb-4">üìù Reflection Time</h3>
                <div class="space-y-4">
                    <div>
                        <label class="font-semibold text-sm">1. What was the hardest ethical decision you had to make? Why?</label>
                        <textarea class="w-full mt-2 p-3 border rounded-lg h-20" placeholder="Think about the dilemmas..."></textarea>
                    </div>
                    <div>
                        <label class="font-semibold text-sm">2. How would you ensure your AI stays ethical as it learns and grows?</label>
                        <textarea class="w-full mt-2 p-3 border rounded-lg h-20" placeholder="Consider ongoing monitoring..."></textarea>
                    </div>
                    <div>
                        <label class="font-semibold text-sm">3. Should there be laws about AI ethics? What would they include?</label>
                        <textarea class="w-full mt-2 p-3 border rounded-lg h-20" placeholder="Think about government regulation..."></textarea>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="completeTask3()" class="bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600 transition-all flex-1">
                            Complete Task 3
                        </button>
                        <button onclick="resetTask3()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-all">
                            Reset Task
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Extension: AI Rights & Future -->
        <section class="bg-gradient-to-r from-purple-100 to-blue-100 rounded-xl shadow-lg p-6 md:p-8 mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-purple-700 mb-4">ü§ñ Extension: The Future of AI Ethics</h2>
            <p class="text-gray-700 mb-6">Think about these big questions as AI gets smarter!</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="font-bold text-purple-600 mb-3">üß† AI Rights?</h3>
                    <p class="text-sm text-gray-700 mb-4">
                        If AI becomes as smart as humans, should it have rights?
                    </p>
                    <textarea class="w-full p-3 border-2 border-purple-200 rounded-md focus:border-purple-400 focus:outline-none h-24" 
                        placeholder="What do you think?" oninput="saveProgress()"></textarea>
                </div>
                
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="font-bold text-blue-600 mb-3">‚öñÔ∏è AI Judges?</h3>
                    <p class="text-sm text-gray-700 mb-4">
                        Should AI be allowed to make legal decisions?
                    </p>
                    <textarea class="w-full p-3 border-2 border-blue-200 rounded-md focus:border-blue-400 focus:outline-none h-24" 
                        placeholder="Pros and cons?" oninput="saveProgress()"></textarea>
                </div>
                
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="font-bold text-green-600 mb-3">üè• AI Doctors?</h3>
                    <p class="text-sm text-gray-700 mb-4">
                        Would you trust an AI to diagnose your illness?
                    </p>
                    <textarea class="w-full p-3 border-2 border-green-200 rounded-md focus:border-green-400 focus:outline-none h-24" 
                        placeholder="Why or why not?" oninput="saveProgress()"></textarea>
                </div>
                
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="font-bold text-orange-600 mb-3">üéØ Your AI Law</h3>
                    <p class="text-sm text-gray-700 mb-4">
                        If you could make one law about AI, what would it be?
                    </p>
                    <textarea class="w-full p-3 border-2 border-orange-200 rounded-md focus:border-orange-400 focus:outline-none h-24" 
                        placeholder="Your law..." oninput="saveProgress()"></textarea>
                </div>
            </div>
        </section>

        <!-- Achievement Gallery -->
        <section class="bg-gradient-to-r from-yellow-100 to-orange-100 rounded-xl shadow-lg p-6 md:p-8 mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-orange-700 mb-4">üèÜ Your Ethics Achievements</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div id="achieve-spotter" class="achievement-unlock bg-white p-4 rounded-lg text-center shadow opacity-50 transition-all duration-300">
                    <span class="text-3xl">üëÅÔ∏è</span>
                    <p class="font-bold text-sm mt-2">Bias Spotter</p>
                    <p class="text-xs text-gray-600">Found all biases</p>
                </div>
                <div id="achieve-fixer" class="achievement-unlock bg-white p-4 rounded-lg text-center shadow opacity-50 transition-all duration-300">
                    <span class="text-3xl">üîß</span>
                    <p class="font-bold text-sm mt-2">Bias Fixer</p>
                    <p class="text-xs text-gray-600">Fixed biased data</p>
                </div>
                <div id="achieve-ethical" class="achievement-unlock bg-white p-4 rounded-lg text-center shadow opacity-50 transition-all duration-300">
                    <span class="text-3xl">‚öñÔ∏è</span>
                    <p class="font-bold text-sm mt-2">Ethical Designer</p>
                    <p class="text-xs text-gray-600">Designed fair AI</p>
                </div>
                <div id="achieve-detective" class="achievement-unlock bg-white p-4 rounded-lg text-center shadow opacity-50 transition-all duration-300">
                    <span class="text-3xl">üïµÔ∏è</span>
                    <p class="font-bold text-sm mt-2">Master Detective</p>
                    <p class="text-xs text-gray-600">Solved all cases</p>
                </div>
            </div>
        </section>
        
        <!-- Progress Dashboard -->
        <section class="bg-white rounded-xl shadow-lg p-6 md:p-8 mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">üìä Your Progress Dashboard</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg">
                    <p class="text-sm text-gray-600">Total XP Earned</p>
                    <p class="text-2xl font-bold text-blue-700" id="dashboardXP">0</p>
                </div>
                <div class="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-lg">
                    <p class="text-sm text-gray-600">Tasks Completed</p>
                    <p class="text-2xl font-bold text-green-700" id="dashboardTasks">0/10</p>
                </div>
                <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-lg">
                    <p class="text-sm text-gray-600">Time Spent</p>
                    <p class="text-2xl font-bold text-purple-700" id="dashboardTime">0 min</p>
                </div>
            </div>
            <button onclick="exportProgress()" class="mt-4 bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-all">
                Export Progress Report
            </button>
        </section>
    </div>

    <script>
// ==================== GLOBAL STATE MANAGEMENT ====================
let gameState = {
    totalXP: 0,
    biasesFound: 0,
    cardsFlipped: [],
    achievements: {
        spotter: false,
        fixer: false,
        ethical: false,
        detective: false
    },
    streak: 0,
    soundEnabled: true,
    selectedItem: null,
    challengeStartTime: null,
    detectiveSolved: 0,
    tasksCompleted: 0,
    sessionStartTime: Date.now(),
    scenarios: [],
    completedActions: new Set() // Initialize as Set from the start
};

// Task-specific data
let starterProgress = {
    biasesIdentified: 0,
    correctAnswers: {},
    completed: false
};

let task1Data = {
    selectedPoints: [],
    goodChoices: [],
    badChoices: [],
    mistakes: 0,
    fairnessLevel: 0,
    completed: false
};

let task2Data = {
    currentScenario: 'loan',
    savedScenarios: [],
    completed: false
};

let task3Data = {
    aiPurpose: '',
    ethicalPrinciples: [],
    safetyFeatures: [],
    dilemmaResponses: {},
    goodPrinciples: 0,
    badPrinciples: 0,
    completed: false
};

// Challenge state management
let challengeState = {
    currentChallenge: null,
    challengeScore: 0,
    challengesComplete: 0,
    challengeStreak: 0,
    challengeScores: {
        pattern: 0,
        realworld: 0,
        build: 0,
        speed: 0
    },
    completedChallenges: new Set(), // Initialize as Set
    speedChallenge: {
        questions: [],
        currentQuestion: 0,
        correct: 0,
        wrong: 0,
        timer: null,
        timeRemaining: 60
    }
};

// ==================== INITIALIZATION ====================
document.addEventListener('DOMContentLoaded', function() {
    initializeLesson();
});

function initializeLesson() {
    // Ensure completedActions is initialized as a Set
    if (!gameState.completedActions || !(gameState.completedActions instanceof Set)) {
        gameState.completedActions = new Set();
    }
    
    // Initialize charts FIRST if Chart.js is loaded
    if (typeof Chart !== 'undefined') {
        initializeCharts();
    }
    
    // THEN load saved progress
    loadProgress();
    
    // Initialize drag and drop if elements exist
    if (document.querySelector('.draggable[draggable="true"]')) {
        initializeDragAndDrop();
    }
    
    // Initialize mobile support
    if ('ontouchstart' in window) {
        initializeMobileSupport();
    }
    
    // Update leaderboard
    updateLeaderboard();
    
    // Hide loading screen if it exists
    const loadingScreen = document.getElementById('loadingScreen');
    if (loadingScreen) {
        setTimeout(() => {
            const loadingBar = document.getElementById('loadingBar');
            if (loadingBar) {
                loadingBar.style.width = '100%';
            }
            setTimeout(() => {
                loadingScreen.classList.add('hidden');
            }, 500);
        }, 1000);
    }
    
    // Set up auto-save
    setInterval(saveProgress, 30000);
    
    // Set up copy protection
    setupCopyProtection();
}

// ==================== PROGRESS MANAGEMENT ====================
function saveProgress() {
    // Convert Set to Array for storage
    const completedActionsArray = Array.from(gameState.completedActions || new Set());
    const completedChallengesArray = Array.from(challengeState.completedChallenges || new Set());
    
    const progress = {
        gameState: {
            ...gameState,
            completedActions: completedActionsArray // Save as array
        },
        starterProgress: starterProgress,
        task1Data: task1Data,
        task2Data: task2Data,
        task3Data: task3Data,
        challengeState: {
            ...challengeState,
            completedChallenges: completedChallengesArray // Save as array
        },
        principles: {
            rule1: document.getElementById('rule1')?.value || '',
            rule2: document.getElementById('rule2')?.value || '',
            rule3: document.getElementById('rule3')?.value || '',
            rule4: document.getElementById('rule4')?.value || '',
            mission: document.getElementById('missionStatement')?.value || '',
            values: document.getElementById('keyValues')?.value || ''
        },
        textareas: {}
    };
    
    // Save all textarea content
    document.querySelectorAll('textarea').forEach((textarea, index) => {
        progress.textareas[index] = textarea.value;
    });
    
    localStorage.setItem('lesson3Progress', JSON.stringify(progress));
    showSaveIndicator();
}

function loadProgress() {
    const saved = localStorage.getItem('lesson3Progress');
    if (saved) {
        try {
            const progress = JSON.parse(saved);
            
            // Restore game state
            gameState = {
                ...gameState,
                ...progress.gameState,
                // Ensure completedActions is always a Set
                completedActions: new Set(progress.gameState?.completedActions || [])
            };
            starterProgress = progress.starterProgress || starterProgress;
            task1Data = progress.task1Data || task1Data;
            task2Data = progress.task2Data || task2Data;
            task3Data = progress.task3Data || task3Data;
            
            // Restore challenge state
            if (progress.challengeState) {
                challengeState = {
                    ...challengeState,
                    ...progress.challengeState,
                    // Ensure completedChallenges is always a Set
                    completedChallenges: new Set(progress.challengeState?.completedChallenges || [])
                };
                updateChallengeDisplay();
            }
            
            // Ensure arrays are properly initialized
            task1Data.goodChoices = task1Data.goodChoices || [];
            task1Data.badChoices = task1Data.badChoices || [];
            task1Data.selectedPoints = task1Data.selectedPoints || [];
            
            // Update UI
            updateXPDisplay();
            updateAchievements();
            updateStarterProgress();
            
            // Restore Task 1 button states
            if (task1Data.goodChoices) {
                task1Data.goodChoices.forEach(choice => {
                    const button = document.querySelector(`[onclick="addDataPoint('${choice}', true)"]`);
                    if (button) {
                        button.classList.add('border-green-400', 'bg-green-50');
                        button.disabled = true;
                        button.classList.add('completed-action');
                    }
                });
            }
            if (task1Data.badChoices) {
                task1Data.badChoices.forEach(choice => {
                    const button = document.querySelector(`[onclick="addDataPoint('${choice}', false)"]`);
                    if (button) {
                        button.classList.add('border-red-400', 'bg-red-50');
                        button.disabled = true;
                        button.classList.add('completed-action');
                    }
                });
            }
            
            // Restore Task 3 states
            if (task3Data.aiPurpose) {
                const aiPurpose = document.getElementById('aiPurpose');
                if (aiPurpose) aiPurpose.value = task3Data.aiPurpose;
            }
            
            if (task3Data.ethicalPrinciples && task3Data.ethicalPrinciples.length > 0) {
                // Re-check the checkboxes based on saved principles
                document.querySelectorAll('.ethics-checkbox').forEach(cb => {
                    const principleText = cb.nextElementSibling.textContent;
                    if (task3Data.ethicalPrinciples.includes(principleText)) {
                        cb.checked = true;
                    }
                });
                updateEthicsDesign();
            }
            
            if (task3Data.safetyFeatures && task3Data.safetyFeatures.length > 0) {
                // Handle both old (string array) and new (object array) formats
                task3Data.safetyFeatures.forEach(feature => {
                    let featureName, isGood;
                    if (typeof feature === 'string') {
                        // Old format - convert to new
                        featureName = feature;
                        isGood = ['age-check', 'report', 'limits', 'parent'].includes(feature);
                    } else {
                        // New format
                        featureName = feature.name;
                        isGood = feature.isGood;
                    }
                    
                    const button = document.querySelector(`[onclick="addSafetyFeature('${featureName}', ${isGood})"]`);
                    if (button) {
                        button.classList.add(isGood ? 'bg-blue-100' : 'bg-gray-100');
                        button.disabled = true;
                        button.classList.add('completed-action');
                    }
                });
                
                // Convert old format to new if needed
                if (task3Data.safetyFeatures.some(f => typeof f === 'string')) {
                    task3Data.safetyFeatures = task3Data.safetyFeatures.map(f => {
                        if (typeof f === 'string') {
                            return {
                                name: f,
                                isGood: ['age-check', 'report', 'limits', 'parent'].includes(f)
                            };
                        }
                        return f;
                    });
                }
                
                // Update AI preview after restoring Task 3
                updateAIPreview();
                
                // Restore dilemma responses if any
                if (task3Data.dilemmaResponses) {
                    Object.keys(task3Data.dilemmaResponses).forEach(num => {
                        const feedback = document.getElementById(`scenario${num}-feedback`);
                        const choice = task3Data.dilemmaResponses[num];
                        if (feedback && choice) {
                            // Show the feedback for already answered dilemmas
                            const feedbackTexts = {
                                1: {
                                    alert: "Good intention to help! But remember to balance safety with privacy rights.",
                                    ask: "Respecting privacy is important! Consider having clear consent policies."
                                },
                                2: {
                                    wait: "Ethical choice! It's better to ensure fairness before launch.",
                                    launch: "Transparency is good, but fixing bias should be the priority."
                                },
                                3: {
                                    full: "Great for transparency! Make sure explanations are understandable.",
                                    simple: "Good for usability! But offer detailed explanations as an option."
                                }
                            };
                            
                            feedback.innerHTML = `<p class="text-${choice === 'wait' && num === '2' ? 'green' : 'blue'}-600">${feedbackTexts[num][choice]}</p>`;
                        }
                    });
                }
            }
            
            // Update fairness display
            if (task1Data.goodChoices || task1Data.badChoices) {
                updateFairnessDisplay();
            }
            
            // Show mistake counter if needed
            if (task1Data.mistakes > 0) {
                const mistakeCounter = document.getElementById('mistakeCounter');
                const mistakeCount = document.getElementById('mistakeCount');
                if (mistakeCounter && mistakeCount) {
                    mistakeCounter.classList.remove('hidden');
                    mistakeCount.textContent = task1Data.mistakes;
                }
            }
            
            // Restore text inputs
            if (progress.principles) {
                Object.keys(progress.principles).forEach(key => {
                    let input;
                    if (key === 'mission') {
                        input = document.getElementById('missionStatement');
                    } else if (key === 'values') {
                        input = document.getElementById('keyValues');
                    } else if (key.startsWith('rule')) {
                        input = document.getElementById(key);
                    } else {
                        // Handle legacy numbered keys (1-7)
                        const num = parseInt(key);
                        if (!isNaN(num)) {
                            const elementId = num <= 3 ? `rule${num}` : `rule${num - 3}`;
                            input = document.getElementById(elementId);
                        }
                    }
                    if (input && progress.principles[key]) {
                        input.value = progress.principles[key];
                    }
                });
            }
            
            // Restore mission statement and key values if stored in textareas
            if (progress.textareas) {
                const textareas = document.querySelectorAll('textarea');
                Object.keys(progress.textareas).forEach(index => {
                    if (textareas[index]) {
                        textareas[index].value = progress.textareas[index];
                    }
                });
            }
            
            saveProgress();
        } catch (e) {
            console.error('Error loading progress:', e);
        }
    }
}

function showSaveIndicator() {
    const indicator = document.getElementById('saveIndicator');
    if (indicator) {
        indicator.classList.add('show');
        setTimeout(() => indicator.classList.remove('show'), 2000);
    }
}

// ==================== XP & ACHIEVEMENTS ====================
function addXP(points, actionId = null) {
    // Ensure completedActions is a Set
    if (!gameState.completedActions || !(gameState.completedActions instanceof Set)) {
        gameState.completedActions = new Set(gameState.completedActions || []);
    }
    
    // Prevent duplicate XP for the same action
    if (actionId && gameState.completedActions.has(actionId)) {
        return;
    }
    
    if (actionId) {
        gameState.completedActions.add(actionId);
    }
    
    gameState.totalXP += points;
    updateXPDisplay();
    createXPFloat(points);
    playSound('xp');
    
    // Update level
    const level = getLevel();
    const levelDisplay = document.getElementById('levelDisplay');
    if (levelDisplay) {
        levelDisplay.textContent = level;
    }
    
    // Update streak
    gameState.streak++;
    updateStreak();
    
    saveProgress();
}

function updateXPDisplay() {
    const xpPoints = document.getElementById('xpPoints');
    const xpBar = document.getElementById('xpBar');
    const dashboardXP = document.getElementById('dashboardXP');
    
    if (xpPoints) xpPoints.textContent = gameState.totalXP;
    if (xpBar) {
        const percentage = Math.min((gameState.totalXP / 500) * 100, 100);
        xpBar.style.width = percentage + '%';
    }
    if (dashboardXP) dashboardXP.textContent = gameState.totalXP;
}

function getLevel() {
    if (gameState.totalXP >= 300) return 'Level 4 Ethics Master';
    if (gameState.totalXP >= 200) return 'Level 3 Fairness Champion';
    if (gameState.totalXP >= 100) return 'Level 2 Ethics Guardian';
    return 'Level 1 Ethics Explorer';
}

function createXPFloat(points) {
    const float = document.createElement('div');
    float.className = 'xp-float';
    float.textContent = `+${points} XP`;
    float.style.left = (Math.random() * window.innerWidth) + 'px';
    float.style.top = (Math.random() * window.innerHeight) + 'px';
    document.body.appendChild(float);
    setTimeout(() => float.remove(), 1000);
}

function unlockAchievement(name) {
    if (!gameState.achievements[name]) {
        gameState.achievements[name] = true;
        const achieveElement = document.getElementById(`achieve-${name}`);
        if (achieveElement) {
            achieveElement.classList.remove('opacity-50');
            achieveElement.classList.add('achievement-unlock');
            addXP(50, `achievement-${name}`);
            playSound('achievement');
            createParticles(achieveElement.getBoundingClientRect());
        }
        saveProgress();
    }
}

function updateAchievements() {
    Object.keys(gameState.achievements).forEach(key => {
        if (gameState.achievements[key]) {
            const element = document.getElementById(`achieve-${key}`);
            if (element) element.classList.remove('opacity-50');
        }
    });
}

function updateStreak() {
    const streakDisplay = document.getElementById('streakDisplay');
    const streakCount = document.getElementById('streakCount');
    
    if (streakDisplay && streakCount) {
        if (gameState.streak > 2) {
            streakDisplay.classList.remove('hidden');
            streakCount.textContent = gameState.streak;
            
            // Bonus XP for streaks
            if (gameState.streak % 5 === 0) {
                addXP(20, `streak-bonus-${gameState.streak}`);
                showNotification(`üî• ${gameState.streak} streak bonus!`, 'success');
            }
        }
    }
}

// ==================== VISUAL EFFECTS ====================
function createParticles(rect) {
    const container = document.getElementById('particles');
    if (!container) return;
    
    const colors = ['#f59e0b', '#ef4444', '#10b981', '#6366f1'];
    
    for (let i = 0; i < 20; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.style.left = rect.left + rect.width / 2 + 'px';
        particle.style.top = rect.top + rect.height / 2 + 'px';
        particle.style.background = colors[Math.floor(Math.random() * colors.length)];
        particle.style.setProperty('--x', (Math.random() - 0.5) * 200 + 'px');
        particle.style.setProperty('--y', (Math.random() - 0.5) * 200 + 'px');
        container.appendChild(particle);
        setTimeout(() => particle.remove(), 2000);
    }
}

// ==================== SOUND SYSTEM ====================
function playSound(type) {
    if (!gameState.soundEnabled) return;
    
    // Create audio context on first interaction
    if (!window.audioContext) {
        window.audioContext = new (window.AudioContext || window.webkitAudioContext)();
    }
    
    const sounds = {
        xp: { frequency: 880, duration: 100 },
        achievement: { frequency: 1318, duration: 200 },
        correct: { frequency: 659, duration: 150 },
        wrong: { frequency: 293, duration: 200 }
    };
    
    const sound = sounds[type];
    if (sound && window.audioContext) {
        try {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = sound.frequency;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + sound.duration / 1000);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + sound.duration / 1000);
        } catch (e) {
            console.error('Sound playback error:', e);
        }
    }
}

function toggleSound() {
    gameState.soundEnabled = !gameState.soundEnabled;
    const soundIcon = document.getElementById('soundIcon');
    if (soundIcon) {
        soundIcon.textContent = gameState.soundEnabled ? 'üîä' : 'üîá';
    }
    saveProgress();
}

// ==================== NOTIFICATIONS ====================
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `fixed top-20 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300`;
    
    const colors = {
        success: 'bg-green-500 text-white',
        warning: 'bg-yellow-500 text-white',
        error: 'bg-red-500 text-white',
        info: 'bg-blue-500 text-white'
    };
    
    notification.className += ' ' + colors[type];
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// ==================== STARTER TASK FUNCTIONS ====================
function checkBiasType(num, answer) {
    const correct = {
        1: 'gender',
        2: 'representation', 
        3: 'location',
        4: 'cultural'
    };
    
    const feedback = document.getElementById(`bias-feedback-${num}`);
    if (!feedback) return;
    
    if (answer === correct[num]) {
        feedback.innerHTML = '<span class="text-green-600">‚úÖ Correct!</span>';
        if (!starterProgress.correctAnswers[num]) {
            starterProgress.correctAnswers[num] = true;
            starterProgress.biasesIdentified++;
            updateStarterProgress();
            addXP(10, `bias-identify-${num}`);
            playSound('correct');
        }
    } else if (answer) {
        feedback.innerHTML = '<span class="text-red-600">‚ùå Try again!</span>';
        playSound('wrong');
    }
    
    // Show solution matching when all identified
    if (starterProgress.biasesIdentified === 4) {
        const solutionMatching = document.getElementById('solutionMatching');
        const starterReflection = document.getElementById('starterReflection');
        if (solutionMatching) solutionMatching.classList.remove('hidden');
        if (starterReflection) starterReflection.classList.remove('hidden');
    }
}

function updateStarterProgress() {
    const progress = (starterProgress.biasesIdentified / 4) * 100;
    const biasesIdentifiedEl = document.getElementById('biasesIdentified');
    const detectiveProgressEl = document.getElementById('detectiveProgress');
    
    if (biasesIdentifiedEl) biasesIdentifiedEl.textContent = starterProgress.biasesIdentified;
    if (detectiveProgressEl) detectiveProgressEl.style.width = progress + '%';
}

function completeStarter() {
    if (!starterProgress.completed) {
        starterProgress.completed = true;
        addXP(50, 'starter-complete');
        showNotification('Great job completing the Bias Detective Training!', 'success');
        gameState.tasksCompleted++;
        unlockAchievement('spotter');
        saveProgress();
    }
}

function resetStarterTask() {
    // Reset progress
    starterProgress = {
        biasesIdentified: 0,
        correctAnswers: {},
        completed: false
    };
    
    // Reset all select elements
    for (let i = 1; i <= 4; i++) {
        const select = document.getElementById(`bias-type-${i}`);
        const feedback = document.getElementById(`bias-feedback-${i}`);
        if (select) select.value = '';
        if (feedback) feedback.innerHTML = '';
    }
    
    // Hide solution matching and reflection
    const solutionMatching = document.getElementById('solutionMatching');
    const starterReflection = document.getElementById('starterReflection');
    if (solutionMatching) solutionMatching.classList.add('hidden');
    if (starterReflection) starterReflection.classList.add('hidden');
    
    // Clear textareas
    const textareas = document.querySelectorAll('#starterReflection textarea');
    textareas.forEach(textarea => textarea.value = '');
    
    updateStarterProgress();
    saveProgress();
    showNotification('Starter task reset!', 'info');
}

// ==================== TASK 1 FUNCTIONS ====================
function addDataPoint(type, isGood) {
    // Check if already selected
    if (task1Data.goodChoices.includes(type) || task1Data.badChoices.includes(type)) {
        return;
    }
    
    const button = document.querySelector(`[onclick="addDataPoint('${type}', ${isGood})"]`);
    const feedbackDiv = document.getElementById('selectionFeedback');
    
    if (!button || !feedbackDiv) return;
    
    if (isGood) {
        // Good choice
        task1Data.goodChoices.push(type);
        button.classList.add('border-green-400', 'bg-green-50');
        button.disabled = true;
        button.classList.add('completed-action');
        
        feedbackDiv.innerHTML = `
            <div class="bg-green-100 p-3 rounded-lg mb-2">
                <p class="text-sm text-green-700">‚úÖ Good choice! This helps make the dataset more fair.</p>
            </div>
        `;
        
        updateFairnessDisplay();
        addXP(5, `data-point-${type}`);
        playSound('correct');
    } else {
        // Bad choice - trap option
        task1Data.badChoices.push(type);
        task1Data.mistakes++;
        button.classList.add('border-red-400', 'bg-red-50');
        button.disabled = true;
        button.classList.add('completed-action');
        
        // Show mistake counter
        const mistakeCounter = document.getElementById('mistakeCounter');
        const mistakeCount = document.getElementById('mistakeCount');
        if (mistakeCounter && mistakeCount) {
            mistakeCounter.classList.remove('hidden');
            mistakeCount.textContent = task1Data.mistakes;
        }
        
        // Explain why it's wrong
        const explanations = {
            'top-students': 'This excludes students who might be struggling but have potential!',
            'english-only': 'This discriminates against non-English speakers!',
            'tech-access': 'This excludes students without computers at home!',
            'urban-only': 'This ignores rural students who deserve equal opportunities!',
            'recent-only': 'This might miss important historical patterns and exclude older data!'
        };
        
        feedbackDiv.innerHTML = `
            <div class="bg-red-100 p-3 rounded-lg mb-2">
                <p class="text-sm text-red-700">‚ùå Careful! ${explanations[type]}</p>
                <p class="text-xs text-gray-600 mt-1">Remember: Fair AI should include everyone, not exclude groups.</p>
            </div>
        `;
        
        playSound('wrong');
        updateFairnessDisplay();
    }
    
    saveProgress();
}

function updateFairnessDisplay() {
    // Calculate fairness: good choices increase it, bad choices decrease it
    const goodPoints = task1Data.goodChoices.length * 16.67; // Each good choice adds ~17%
    const badPenalty = task1Data.badChoices.length * 10; // Each bad choice reduces by 10%
    
    task1Data.fairnessLevel = Math.max(0, Math.min(100, goodPoints - badPenalty));
    
    const fairnessPercentage = document.getElementById('fairnessPercentage');
    const fairnessProgress = document.getElementById('fairnessProgress');
    
    if (fairnessPercentage) fairnessPercentage.textContent = Math.round(task1Data.fairnessLevel) + '%';
    if (fairnessProgress) fairnessProgress.style.width = task1Data.fairnessLevel + '%';
    
    // Update dataset stats
    const stats = document.getElementById('datasetStats');
    if (stats) {
        stats.innerHTML = `
            <p>‚úÖ Fair choices: ${task1Data.goodChoices.length}</p>
            <p>‚ùå Biased choices: ${task1Data.badChoices.length}</p>
        `;
    }
    
    // Update chart visualization only if charts are ready
    if (typeof Chart !== 'undefined' && window.newDataChart) {
        updateDataCharts();
    }
}

function resetDataset() {
    task1Data = {
        selectedPoints: [],
        goodChoices: [],
        badChoices: [],
        mistakes: 0,
        fairnessLevel: 0,
        completed: task1Data.completed // Preserve completion status
    };
    
    // Reset all buttons
    document.querySelectorAll('.data-option').forEach(button => {
        button.classList.remove('border-green-400', 'bg-green-50', 'border-red-400', 'bg-red-50', 'completed-action');
        button.disabled = false;
    });
    
    // Hide mistake counter
    const mistakeCounter = document.getElementById('mistakeCounter');
    if (mistakeCounter) mistakeCounter.classList.add('hidden');
    
    // Clear feedback
    const selectionFeedback = document.getElementById('selectionFeedback');
    const datasetResults = document.getElementById('datasetResults');
    if (selectionFeedback) selectionFeedback.innerHTML = '';
    if (datasetResults) datasetResults.innerHTML = '';
    
    // Reset displays
    updateFairnessDisplay();
    saveProgress();
}

function testFairDataset() {
    const results = document.getElementById('datasetResults');
    if (!results) return;
    
    if (task1Data.goodChoices.length >= 4 && task1Data.badChoices.length < 3) {
        results.innerHTML = `
            <div class="bg-green-100 p-4 rounded-lg">
                <p class="font-bold text-green-700">‚úÖ Success! Your dataset is fair!</p>
                <p class="text-sm mt-2">The AI can now recognize talent in all students equally.</p>
                ${task1Data.mistakes > 0 ? '<p class="text-xs text-gray-600 mt-1">You made ' + task1Data.mistakes + ' mistakes but learned from them!</p>' : ''}
            </div>
        `;
        
        const impactComparison = document.getElementById('impactComparison');
        const task1Reflection = document.getElementById('task1Reflection');
        if (impactComparison) impactComparison.classList.remove('hidden');
        if (task1Reflection) task1Reflection.classList.remove('hidden');
        
        if (!task1Data.completed) {
            addXP(40, 'dataset-test-success');
            unlockAchievement('fixer');
        }
    } else if (task1Data.badChoices.length >= 3) {
        results.innerHTML = `
            <div class="bg-red-100 p-4 rounded-lg">
                <p class="font-bold text-red-700">‚ùå Too many biased choices!</p>
                <p class="text-sm mt-2">Your dataset would make the AI even more unfair. Try again!</p>
                <p class="text-xs text-gray-600 mt-1">Hint: Remove options that exclude groups of people.</p>
            </div>
        `;
    } else {
        results.innerHTML = `
            <div class="bg-orange-100 p-4 rounded-lg">
                <p class="font-bold text-orange-700">‚ö†Ô∏è Dataset needs more diversity</p>
                <p class="text-sm mt-2">Add more fair data points to make it balanced.</p>
                <p class="text-xs text-gray-600 mt-1">You need at least 4 good choices to create a fair dataset.</p>
            </div>
        `;
    }
}

function completeTask1() {
    if (!task1Data.completed) {
        task1Data.completed = true;
        addXP(60, 'task1-complete');
        showNotification('Excellent work building a fair dataset!', 'success');
        gameState.tasksCompleted++;
        saveProgress();
    }
}

function resetTask1() {
    // Keep completion status but reset choices
    const wasCompleted = task1Data.completed;
    
    task1Data = {
        selectedPoints: [],
        goodChoices: [],
        badChoices: [],
        mistakes: 0,
        fairnessLevel: 0,
        completed: wasCompleted
    };
    
    // Reset all buttons
    document.querySelectorAll('.data-option').forEach(button => {
        button.classList.remove('border-green-400', 'bg-green-50', 'border-red-400', 'bg-red-50', 'completed-action');
        button.disabled = false;
    });
    
    // Hide mistake counter
    const mistakeCounter = document.getElementById('mistakeCounter');
    if (mistakeCounter) mistakeCounter.classList.add('hidden');
    
    // Clear feedback
    const selectionFeedback = document.getElementById('selectionFeedback');
    const datasetResults = document.getElementById('datasetResults');
    if (selectionFeedback) selectionFeedback.innerHTML = '';
    if (datasetResults) datasetResults.innerHTML = '';
    
    // Hide impact comparison and reflection
    const impactComparison = document.getElementById('impactComparison');
    const task1Reflection = document.getElementById('task1Reflection');
    if (impactComparison) impactComparison.classList.add('hidden');
    if (task1Reflection) task1Reflection.classList.add('hidden');
    
    // Clear textareas
    const textareas = document.querySelectorAll('#task1Reflection textarea');
    textareas.forEach(textarea => textarea.value = '');
    
    // Reset displays
    updateFairnessDisplay();
    saveProgress();
    showNotification('Task 1 reset!', 'info');
}

// ==================== TASK 2 CHALLENGE FUNCTIONS ====================
function startChallenge(type) {
    challengeState.currentChallenge = type;
    
    // Hide challenge selection
    const challengeSelection = document.getElementById('challengeSelection');
    if (challengeSelection) challengeSelection.classList.add('hidden');
    
    // Show challenge arena
    const challengeArena = document.getElementById('challengeArena');
    if (challengeArena) challengeArena.classList.remove('hidden');
    
    // Hide all challenges
    document.querySelectorAll('[id$="Challenge"]').forEach(el => {
        if (el.id !== 'challengeArena') el.classList.add('hidden');
    });
    
    // Show specific challenge
    const specificChallenge = document.getElementById(type + 'Challenge');
    if (specificChallenge) specificChallenge.classList.remove('hidden');
    
    // Initialize challenge based on type
    switch(type) {
        case 'pattern':
            initializePatternChallenge();
            break;
        case 'realworld':
            initializeRealWorldChallenge();
            break;
        case 'build':
            initializeBuildChallenge();
            break;
        case 'speed':
            initializeSpeedChallenge();
            break;
    }
    
    playSound('correct');
}

// Pattern Detective Challenge
function initializePatternChallenge() {
    const patterns = [
        {
            approved: [
                { name: 'John Smith', age: 35, job: 'Engineer', location: 'London' },
                { name: 'Michael Brown', age: 42, job: 'Manager', location: 'Manchester' },
                { name: 'David Wilson', age: 28, job: 'Developer', location: 'Birmingham' }
            ],
            rejected: [
                { name: 'Aisha Patel', age: 34, job: 'Engineer', location: 'London' },
                { name: 'Fatima Khan', age: 41, job: 'Manager', location: 'Manchester' },
                { name: 'Priya Singh', age: 29, job: 'Developer', location: 'Birmingham' }
            ],
            bias: 'name',
            explanation: 'The AI is biased based on names - approving Western names and rejecting ethnic names'
        },
        {
            approved: [
                { name: 'Emma', age: 25, job: 'Designer', location: 'City Center' },
                { name: 'Sophie', age: 31, job: 'Analyst', location: 'Suburbs' },
                { name: 'James', age: 29, job: 'Teacher', location: 'Downtown' }
            ],
            rejected: [
                { name: 'Margaret', age: 58, job: 'Designer', location: 'City Center' },
                { name: 'Barbara', age: 62, job: 'Analyst', location: 'Suburbs' },
                { name: 'Robert', age: 55, job: 'Teacher', location: 'Downtown' }
            ],
            bias: 'age',
            explanation: 'The AI is biased against older applicants - rejecting anyone over 50'
        }
    ];
    
    // Randomly select a pattern
    const pattern = patterns[Math.floor(Math.random() * patterns.length)];
    
    // Display approved list
    const approvedList = document.getElementById('approvedList');
    if (approvedList) {
        approvedList.innerHTML = pattern.approved.map(p => 
            `<div class="bg-white p-2 rounded">
                <strong>${p.name}</strong>, ${p.age}, ${p.job}, ${p.location}
            </div>`
        ).join('');
    }
    
    // Display rejected list
    const rejectedList = document.getElementById('rejectedList');
    if (rejectedList) {
        rejectedList.innerHTML = pattern.rejected.map(p => 
            `<div class="bg-white p-2 rounded">
                <strong>${p.name}</strong>, ${p.age}, ${p.job}, ${p.location}
            </div>`
        ).join('');
    }
    
    // Store correct answer
    challengeState.patternAnswer = pattern;
}

function checkPatternAnswer() {
    const biasType = document.getElementById('biasTypeAnswer').value;
    const explanation = document.getElementById('patternExplanation').value;
    const feedback = document.getElementById('patternFeedback');
    
    if (!biasType || !explanation.trim()) {
        showNotification('Please select a bias type and explain the pattern', 'warning');
        return;
    }
    
    // Check if already completed
    if (challengeState.completedChallenges.has('pattern-' + challengeState.patternAnswer.bias)) {
        showNotification('You have already completed this pattern!', 'info');
        return;
    }
    
    let score = 0;
    let feedbackHTML = '';
    
    // Check bias type
    if (biasType === challengeState.patternAnswer.bias) {
        score += 50;
        feedbackHTML += '<p class="text-green-600 font-semibold">‚úÖ Correct bias type identified!</p>';
    } else {
        feedbackHTML += `<p class="text-red-600">‚ùå The bias was actually: ${challengeState.patternAnswer.bias} bias</p>`;
    }
    
    // Check explanation quality
    if (explanation.length > 20) {
        score += 50;
        feedbackHTML += '<p class="text-green-600">‚úÖ Good explanation!</p>';
    }
    
    feedbackHTML += `<p class="mt-2 text-gray-700"><strong>Answer:</strong> ${challengeState.patternAnswer.explanation}</p>`;
    feedbackHTML += `<p class="mt-2 font-bold">Score: ${score}/100</p>`;
    
    if (feedback) feedback.innerHTML = feedbackHTML;
    
    if (score > 0) {
        challengeState.completedChallenges.add('pattern-' + challengeState.patternAnswer.bias);
        challengeState.challengeScore += score;
        challengeState.challengeScores.pattern = Math.max(challengeState.challengeScores.pattern, score);
        
        if (score >= 50) {
            challengeState.challengeStreak++;
            addXP(score, 'pattern-challenge-' + Date.now());
        } else {
            challengeState.challengeStreak = 0;
        }
    }
    
    updateChallengeDisplay();
    
    // Show next button
    setTimeout(() => {
        if (feedback) {
            feedback.innerHTML += `
                <button onclick="backToChallenges()" class="mt-4 bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                    Back to Challenges
                </button>
            `;
        }
    }, 1000);
}

// Real-World Case Challenge
function initializeRealWorldChallenge() {
    // Initialize drag and drop for solutions
    initializeSolutionsDragDrop();
}

function initializeSolutionsDragDrop() {
    const solutions = document.querySelectorAll('#solutionsList .bg-white');
    let draggedElement = null;
    
    solutions.forEach(solution => {
        solution.addEventListener('dragstart', function(e) {
            draggedElement = this;
            this.style.opacity = '0.5';
        });
        
        solution.addEventListener('dragend', function(e) {
            this.style.opacity = '';
        });
        
        solution.addEventListener('dragover', function(e) {
            e.preventDefault();
            const afterElement = getDragAfterElement(this.parentElement, e.clientY);
            if (afterElement == null) {
                this.parentElement.appendChild(draggedElement);
            } else {
                this.parentElement.insertBefore(draggedElement, afterElement);
            }
        });
    });
}

function getDragAfterElement(container, y) {
    const draggableElements = [...container.querySelectorAll('.bg-white:not(.dragging)')];
    
    return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        
        if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
        } else {
            return closest;
        }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
}

function submitRealWorldSolution() {
    // Check if already completed
    if (challengeState.completedChallenges.has('realworld')) {
        showNotification('You have already completed this challenge!', 'info');
        return;
    }
    
    const feedback = document.getElementById('realworldFeedback');
    const checkedCauses = document.querySelectorAll('input[type="checkbox"]:checked');
    const solutions = document.querySelectorAll('#solutionsList .bg-white');
    const implementationPlan = document.getElementById('implementationPlan').value;
    
    let score = 0;
    let feedbackHTML = '<div class="bg-purple-50 p-4 rounded-lg">';
    
    // Check root causes (all should be selected)
    if (checkedCauses.length === 4) {
        score += 30;
        feedbackHTML += '<p class="text-green-600">‚úÖ All root causes identified!</p>';
    } else {
        feedbackHTML += '<p class="text-orange-600">‚ö†Ô∏è Some root causes missed</p>';
    }
    
    // Check solution order (ideal order is stored in data attributes)
    const solutionOrder = Array.from(solutions).map(s => s.dataset.solution);
    const idealOrder = ['remove-names', 'balance-data', 'neutral-keywords', 'diverse-team'];
    
    let orderScore = 0;
    solutionOrder.forEach((sol, idx) => {
        if (sol === idealOrder[idx]) orderScore += 10;
    });
    
    score += orderScore;
    feedbackHTML += `<p class="text-blue-600">Solution prioritization: ${orderScore}/40 points</p>`;
    
    // Check implementation plan
    if (implementationPlan.length > 50) {
        score += 30;
        feedbackHTML += '<p class="text-green-600">‚úÖ Detailed implementation plan!</p>';
    } else {
        feedbackHTML += '<p class="text-orange-600">‚ö†Ô∏è Implementation plan needs more detail</p>';
    }
    
    feedbackHTML += `<p class="mt-3 font-bold text-lg">Total Score: ${score}/100</p>`;
    
    if (score >= 70) {
        feedbackHTML += '<p class="text-green-600 mt-2">üéâ Excellent solution! You\'ve shown deep understanding of bias mitigation.</p>';
        challengeState.completedChallenges.add('realworld');
        addXP(score, 'realworld-challenge');
        challengeState.challengeStreak++;
    }
    
    feedbackHTML += '</div>';
    
    if (feedback) feedback.innerHTML = feedbackHTML;
    
    challengeState.challengeScore += score;
    challengeState.challengeScores.realworld = Math.max(challengeState.challengeScores.realworld, score);
    
    updateChallengeDisplay();
}

// Build Fair AI Challenge
function initializeBuildChallenge() {
    // Set up factor checkboxes
    const factorCheckboxes = document.querySelectorAll('.factor-checkbox');
    factorCheckboxes.forEach(cb => {
        cb.addEventListener('change', updateFactorWeights);
    });
}

function updateFactorWeights() {
    const selectedFactors = document.querySelectorAll('.factor-checkbox:checked');
    let totalWeight = 0;
    let hasBiased = false;
    
    selectedFactors.forEach(cb => {
        if (cb.dataset.good === 'false') {
            hasBiased = true;
        } else if (cb.dataset.weight) {
            totalWeight += parseInt(cb.dataset.weight);
        }
    });
    
    const totalWeightEl = document.getElementById('totalWeight');
    if (totalWeightEl) {
        totalWeightEl.textContent = totalWeight;
        totalWeightEl.style.color = totalWeight === 100 ? '#10b981' : '#ef4444';
    }
    
    if (hasBiased) {
        showNotification('‚ö†Ô∏è Warning: You selected a biased factor!', 'warning');
    }
}

function testFairAI() {
    const selectedFactors = document.querySelectorAll('.factor-checkbox:checked');
    const selectedSafeguards = document.querySelectorAll('.safeguard-checkbox:checked');
    const testResults = document.getElementById('aiTestResults');
    
    if (!testResults) return;
    
    let score = 0;
    let issues = [];
    let strengths = [];
    
    // Check for biased factors
    let hasBiased = false;
    let goodFactors = 0;
    selectedFactors.forEach(cb => {
        if (cb.dataset.good === 'false') {
            hasBiased = true;
            issues.push(`‚ùå Biased factor: ${cb.nextElementSibling.textContent}`);
        } else {
            goodFactors++;
        }
    });
    
    if (!hasBiased && goodFactors >= 4) {
        score += 40;
        strengths.push('‚úÖ No biased factors selected');
    }
    
    // Check safeguards
    if (selectedSafeguards.length >= 4) {
        score += 30;
        strengths.push('‚úÖ Strong safeguards in place');
    } else {
        issues.push('‚ö†Ô∏è Need more safeguards (at least 4)');
    }
    
    // Check weight balance
    const totalWeight = document.getElementById('totalWeight').textContent;
    if (totalWeight === '100' && !hasBiased) {
        score += 30;
        strengths.push('‚úÖ Balanced evaluation weights');
    } else if (totalWeight !== '100') {
        issues.push('‚ùå Weights don\'t add up to 100%');
    }
    
    let resultsHTML = `<div class="bg-${score >= 70 ? 'green' : 'orange'}-50 p-3 rounded">`;
    resultsHTML += '<h6 class="font-semibold mb-2">AI Fairness Test Results:</h6>';
    
    if (strengths.length > 0) {
        resultsHTML += strengths.map(s => `<p class="text-sm text-green-700">${s}</p>`).join('');
    }
    
    if (issues.length > 0) {
        resultsHTML += issues.map(i => `<p class="text-sm text-red-700">${i}</p>`).join('');
    }
    
    resultsHTML += `<p class="mt-2 font-bold">Fairness Score: ${score}/100</p>`;
    resultsHTML += '</div>';
    
    testResults.innerHTML = resultsHTML;
    
    if (score >= 70) {
        const buildFeedback = document.getElementById('buildFeedback');
        if (buildFeedback) {
            buildFeedback.innerHTML = `
                <div class="bg-green-100 p-4 rounded-lg mt-4">
                    <p class="font-bold text-green-700">üéâ Congratulations! You built a fair AI system!</p>
                    <button onclick="completeBuildChallenge(${score})" class="mt-2 bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                        Complete Challenge
                    </button>
                </div>
            `;
        }
    }
}

function completeBuildChallenge(score) {
    if (!challengeState.completedChallenges.has('build')) {
        challengeState.completedChallenges.add('build');
        challengeState.challengeScore += score;
        challengeState.challengeScores.build = Math.max(challengeState.challengeScores.build, score);
        addXP(score, 'build-challenge');
        challengeState.challengeStreak++;
        updateChallengeDisplay();
    }
    
    setTimeout(() => backToChallenges(), 1000);
}

// Speed Challenge
function initializeSpeedChallenge() {
    challengeState.speedChallenge = {
        questions: generateSpeedQuestions(),
        currentQuestion: 0,
        correct: 0,
        wrong: 0,
        timer: null,
        timeRemaining: 60
    };
    
    startSpeedTimer();
    showSpeedQuestion();
}

function generateSpeedQuestions() {
    return [
        { text: "An AI only recognizes light-skinned faces accurately", answer: "biased" },
        { text: "An AI evaluates candidates based on their skills and experience only", answer: "fair" },
        { text: "A loan AI gives lower rates to people from certain neighborhoods", answer: "biased" },
        { text: "An AI translator works equally well for all languages", answer: "fair" },
        { text: "A hiring AI prefers resumes with male names", answer: "biased" },
        { text: "An AI provides the same quality of service to all users", answer: "fair" },
        { text: "A medical AI gives different diagnoses based on patient's accent", answer: "biased" },
        { text: "An educational AI adapts to each student's learning style", answer: "fair" },
        { text: "An AI assumes all users speak English", answer: "biased" },
        { text: "An AI includes accessibility features for disabled users", answer: "fair" },
        { text: "A recommendation AI only suggests content from Western countries", answer: "biased" },
        { text: "An AI asks users about their preferences instead of assuming", answer: "fair" }
    ].sort(() => Math.random() - 0.5);
}

function startSpeedTimer() {
    const timerEl = document.getElementById('speedTimer');
    
    challengeState.speedChallenge.timer = setInterval(() => {
        challengeState.speedChallenge.timeRemaining--;
        
        if (timerEl) {
            timerEl.textContent = challengeState.speedChallenge.timeRemaining;
            if (challengeState.speedChallenge.timeRemaining < 10) {
                timerEl.classList.add('text-red-600', 'pulse-animation');
            }
        }
        
        if (challengeState.speedChallenge.timeRemaining <= 0) {
            endSpeedChallenge();
        }
    }, 1000);
}

function showSpeedQuestion() {
    const questionEl = document.getElementById('speedQuestion');
    const currentQ = challengeState.speedChallenge.questions[challengeState.speedChallenge.currentQuestion];
    
    if (questionEl && currentQ) {
        questionEl.innerHTML = `
            <p class="text-lg font-semibold mb-2">Statement ${challengeState.speedChallenge.currentQuestion + 1}:</p>
            <p class="text-xl">"${currentQ.text}"</p>
        `;
    }
}

function speedAnswer(answer) {
    const currentQ = challengeState.speedChallenge.questions[challengeState.speedChallenge.currentQuestion];
    
    if (answer === currentQ.answer) {
        challengeState.speedChallenge.correct++;
        playSound('correct');
        createParticles({ left: window.innerWidth / 2, top: window.innerHeight / 2, width: 0, height: 0 });
    } else {
        challengeState.speedChallenge.wrong++;
        playSound('wrong');
    }
    
    // Update display
    const speedCorrect = document.getElementById('speedCorrect');
    const speedWrong = document.getElementById('speedWrong');
    const speedScore = document.getElementById('speedScore');
    
    if (speedCorrect) speedCorrect.textContent = challengeState.speedChallenge.correct;
    if (speedWrong) speedWrong.textContent = challengeState.speedChallenge.wrong;
    if (speedScore) speedScore.textContent = challengeState.speedChallenge.correct * 10;
    
    // Next question
    challengeState.speedChallenge.currentQuestion++;
    
    if (challengeState.speedChallenge.currentQuestion < challengeState.speedChallenge.questions.length) {
        showSpeedQuestion();
    } else {
        endSpeedChallenge();
    }
}

function endSpeedChallenge() {
    clearInterval(challengeState.speedChallenge.timer);
    
    const score = challengeState.speedChallenge.correct * 10;
    const accuracy = (challengeState.speedChallenge.correct / (challengeState.speedChallenge.correct + challengeState.speedChallenge.wrong) * 100).toFixed(1);
    
    const feedback = document.getElementById('speedFeedback');
    if (feedback) {
        feedback.innerHTML = `
            <div class="bg-red-100 p-4 rounded-lg">
                <h5 class="font-bold text-lg mb-2">Challenge Complete!</h5>
                <p>Final Score: <span class="text-2xl font-bold">${score}</span> points</p>
                <p>Accuracy: ${accuracy}%</p>
                <p>Questions Answered: ${challengeState.speedChallenge.correct + challengeState.speedChallenge.wrong}</p>
                ${score >= 80 ? '<p class="text-green-600 font-bold mt-2">üèÜ Outstanding performance!</p>' : ''}
                <button onclick="backToChallenges()" class="mt-4 bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                    Back to Challenges
                </button>
            </div>
        `;
    }
    
    if (!challengeState.completedChallenges.has('speed')) {
        challengeState.completedChallenges.add('speed');
        challengeState.challengeScore += score;
        challengeState.challengeScores.speed = Math.max(challengeState.challengeScores.speed, score);
        if (score > 0) addXP(score, 'speed-challenge');
    }
    
    updateChallengeDisplay();
}

// Back to challenges
function backToChallenges() {
    // Hide challenge arena
    const challengeArena = document.getElementById('challengeArena');
    if (challengeArena) challengeArena.classList.add('hidden');
    
    // Show challenge selection
    const challengeSelection = document.getElementById('challengeSelection');
    if (challengeSelection) challengeSelection.classList.remove('hidden');
    
    // Reset any active timers
    if (challengeState.speedChallenge.timer) {
        clearInterval(challengeState.speedChallenge.timer);
    }
    
    // Update completed count
    const completedChallenges = Object.values(challengeState.challengeScores).filter(s => s > 0).length;
    challengeState.challengesComplete = completedChallenges;
    
    // Show reflection if enough challenges complete
    if (completedChallenges >= 3) {
        const task2Reflection = document.getElementById('task2Reflection');
        if (task2Reflection) task2Reflection.classList.remove('hidden');
    }
    
    updateChallengeDisplay();
    updateLeaderboard();
}

// Update challenge display
function updateChallengeDisplay() {
    // Update score displays
    const challengeScore = document.getElementById('challengeScore');
    const challengesComplete = document.getElementById('challengesComplete');
    const challengeStreak = document.getElementById('challengeStreak');
    
    if (challengeScore) challengeScore.textContent = challengeState.challengeScore;
    if (challengesComplete) challengesComplete.textContent = challengeState.challengesComplete;
    if (challengeStreak) challengeStreak.textContent = challengeState.challengeStreak;
    
    // Update personal scores
    const personalScores = document.getElementById('personalScores');
    if (personalScores) {
        personalScores.innerHTML = `
            <div class="bg-white p-3 rounded flex justify-between items-center">
                <span>Pattern Detective</span>
                <span class="font-bold text-blue-600">${challengeState.challengeScores.pattern || '--'}</span>
            </div>
            <div class="bg-white p-3 rounded flex justify-between items-center">
                <span>Real-World Case</span>
                <span class="font-bold text-purple-600">${challengeState.challengeScores.realworld || '--'}</span>
            </div>
            <div class="bg-white p-3 rounded flex justify-between items-center">
                <span>Fair AI Builder</span>
                <span class="font-bold text-orange-600">${challengeState.challengeScores.build || '--'}</span>
            </div>
            <div class="bg-white p-3 rounded flex justify-between items-center">
                <span>Speed Challenge</span>
                <span class="font-bold text-red-600">${challengeState.challengeScores.speed || '--'}</span>
            </div>
        `;
    }
}

// Update leaderboard
function updateLeaderboard() {
    const leaderboardDisplay = document.getElementById('leaderboardDisplay');
    if (!leaderboardDisplay) return;
    
    const yourTotalScore = challengeState.challengeScore;
    
    // Create leaderboard entries
    const leaderboard = [
        { name: 'AI Ethics Master', score: 550, medal: 'ü•á' },
        { name: 'You', score: yourTotalScore, medal: yourTotalScore >= 550 ? 'ü•á' : yourTotalScore >= 400 ? 'ü•à' : 'ü•â' },
        { name: 'Bias Buster', score: 420, medal: 'ü•â' }
    ];
    
    // Sort by score
    leaderboard.sort((a, b) => b.score - a.score);
    
    // Display leaderboard
    leaderboardDisplay.innerHTML = leaderboard.map((entry, index) => {
        const bgColor = entry.name === 'You' ? 'bg-yellow-50' : 
                       index === 0 ? 'bg-gold-100' : 
                       index === 1 ? 'bg-silver-100' : 'bg-bronze-100';
        
        return `
            <div class="${bgColor} p-3 rounded flex items-center gap-3">
                <span class="text-2xl">${entry.medal}</span>
                <span>${entry.name} - ${entry.score} pts</span>
            </div>
        `;
    }).join('');
}

// Complete Task 2
function completeTask2() {
    if (!task2Data.completed) {
        task2Data.completed = true;
        addXP(100, 'task2-complete');
        showNotification('Outstanding work on the AI Bias Challenges!', 'success');
        gameState.tasksCompleted++;
        unlockAchievement('detective');
        saveProgress();
    }
}

function resetTask2() {
    // Keep completion status but reset challenges
    const wasCompleted = task2Data.completed;
    
    // Reset challenge state
    challengeState = {
        currentChallenge: null,
        challengeScore: 0,
        challengesComplete: 0,
        challengeStreak: 0,
        challengeScores: {
            pattern: 0,
            realworld: 0,
            build: 0,
            speed: 0
        },
        completedChallenges: new Set(), // Ensure it's a Set
        speedChallenge: {
            questions: [],
            currentQuestion: 0,
            correct: 0,
            wrong: 0,
            timer: null,
            timeRemaining: 60
        }
    };
    
    task2Data.completed = wasCompleted;
    
    // Hide reflection
    const task2Reflection = document.getElementById('task2Reflection');
    if (task2Reflection) task2Reflection.classList.add('hidden');
    
    // Clear textareas
    const textareas = document.querySelectorAll('#task2Reflection textarea');
    textareas.forEach(textarea => textarea.value = '');
    
    // Update displays
    updateChallengeDisplay();
    updateLeaderboard();
    saveProgress();
    showNotification('Task 2 challenges reset!', 'info');
}

// ==================== TASK 3 FUNCTIONS ====================
function updateDesignCanvas() {
    const purpose = document.getElementById('aiPurpose');
    if (purpose && purpose.value) {
        task3Data.aiPurpose = purpose.value;
        updateAIPreview();
    }
}

function updateEthicsDesign() {
    const checkboxes = document.querySelectorAll('.ethics-checkbox:checked');
    task3Data.ethicalPrinciples = [];
    task3Data.goodPrinciples = 0;
    task3Data.badPrinciples = 0;
    
    checkboxes.forEach(cb => {
        const principleText = cb.nextElementSibling.textContent;
        task3Data.ethicalPrinciples.push(principleText);
        
        if (cb.dataset.good === 'true') {
            task3Data.goodPrinciples++;
        } else {
            task3Data.badPrinciples++;
        }
    });
    
    // Calculate score based only on good principles (max 8)
    const score = Math.min(task3Data.goodPrinciples, 8);
    const ethicsScoreDisplay = document.getElementById('ethicsScoreDisplay');
    const ethicsProgressBar = document.getElementById('ethicsProgressBar');
    
    if (ethicsScoreDisplay) ethicsScoreDisplay.textContent = score + '/8';
    if (ethicsProgressBar) ethicsProgressBar.style.width = (score / 8 * 100) + '%';
    
    updateAIPreview();
    
    // Achievement for perfect ethics score
    if (score === 8 && task3Data.badPrinciples === 0) {
        unlockAchievement('ethical');
    }
    
    // Warn about bad principles
    if (task3Data.badPrinciples > 0) {
        showNotification('‚ö†Ô∏è Some of your chosen principles might harm users!', 'warning');
    }
}

function addSafetyFeature(feature, isGood) {
    // Check if feature already added
    const alreadyAdded = task3Data.safetyFeatures.some(f => f.name === feature);
    
    if (!alreadyAdded) {
        task3Data.safetyFeatures.push({ name: feature, isGood: isGood });
        const button = document.querySelector(`[onclick="addSafetyFeature('${feature}', ${isGood})"]`);
        if (button) {
            if (isGood) {
                button.classList.add('bg-blue-100');
            } else {
                button.classList.add('bg-gray-100');
            }
            button.disabled = true;
            button.classList.add('completed-action');
        }
        updateAIPreview();
        
        if (isGood) {
            addXP(5, `safety-feature-${feature}`);
        } else {
            showNotification('‚ö†Ô∏è This feature might harm users!', 'warning');
        }
    }
}

function updateAIPreview() {
    const icons = {
        education: 'üìö',
        health: 'üè•',
        safety: 'üõ°Ô∏è',
        environment: 'üåç',
        accessibility: '‚ôø'
    };
    
    const aiIcon = document.getElementById('aiIcon');
    const aiName = document.getElementById('aiName');
    const aiDescription = document.getElementById('aiDescription');
    
    if (task3Data.aiPurpose && aiIcon && aiName && aiDescription) {
        aiIcon.textContent = icons[task3Data.aiPurpose];
        aiName.textContent = `Ethical ${task3Data.aiPurpose.charAt(0).toUpperCase() + task3Data.aiPurpose.slice(1)} AI`;
        
        // Show good principles and good safety features count
        const goodSafetyCount = task3Data.safetyFeatures.filter(f => f.isGood).length;
        aiDescription.textContent = `Designed with ${task3Data.goodPrinciples} ethical principles and ${goodSafetyCount} safety features`;
        
        // Update badges
        updateEthicsBadges();
    }
}

function updateEthicsBadges() {
    const badgesContainer = document.getElementById('ethicsBadges');
    if (!badgesContainer) return;
    
    const badges = [];
    if (task3Data.goodPrinciples >= 3) badges.push('üåü Ethical');
    
    // Count good safety features
    const goodSafetyFeatures = task3Data.safetyFeatures.filter(f => f.isGood).length;
    if (goodSafetyFeatures >= 2) badges.push('üõ°Ô∏è Safe');
    
    if (task3Data.ethicalPrinciples.some(p => p.includes('Works fairly for everyone'))) badges.push('‚öñÔ∏è Fair');
    if (task3Data.ethicalPrinciples.some(p => p.includes('Protects user privacy'))) badges.push('üîí Private');
    
    badgesContainer.innerHTML = badges.map(badge => 
        `<span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">${badge}</span>`
    ).join('');
}

function handleDilemma(num, choice) {
    const feedbackEl = document.getElementById(`scenario${num}-feedback`);
    if (!feedbackEl) return;
    
    // Check if already answered
    if (task3Data.dilemmaResponses[num]) {
        showNotification('You already answered this dilemma!', 'info');
        return;
    }
    
    const feedback = {
        1: {
            alert: "Good intention to help! But remember to balance safety with privacy rights.",
            ask: "Respecting privacy is important! Consider having clear consent policies."
        },
        2: {
            wait: "Ethical choice! It's better to ensure fairness before launch.",
            launch: "Transparency is good, but fixing bias should be the priority."
        },
        3: {
            full: "Great for transparency! Make sure explanations are understandable.",
            simple: "Good for usability! But offer detailed explanations as an option."
        }
    };
    
    feedbackEl.innerHTML = `<p class="text-${choice === 'wait' && num === 2 ? 'green' : 'blue'}-600">${feedback[num][choice]}</p>`;
    task3Data.dilemmaResponses[num] = choice;
    addXP(10, `dilemma-${num}-${choice}`);
    playSound('correct');
}

function generateCertificate() {
    const principles = [
        document.getElementById('rule1')?.value,
        document.getElementById('rule2')?.value,
        document.getElementById('rule3')?.value,
        document.getElementById('rule4')?.value
    ];
    
    if (principles.every(p => p && p.trim())) {
        showNotification('üéì Ethics Certificate Generated!', 'success');
        addXP(25, 'certificate-generated');
        // In a real implementation, this would generate a downloadable certificate
    } else {
        showNotification('Please fill in all four principles', 'warning');
    }
}

function shareDesign() {
    showNotification('Design sharing feature coming soon!', 'info');
}

function completeTask3() {
    if (!task3Data.completed) {
        task3Data.completed = true;
        addXP(80, 'task3-complete');
        showNotification('Fantastic ethical AI design!', 'success');
        gameState.tasksCompleted++;
        saveProgress();
    }
}

function resetTask3() {
    // Keep completion status but reset design
    const wasCompleted = task3Data.completed;
    
    task3Data = {
        aiPurpose: '',
        ethicalPrinciples: [],
        safetyFeatures: [],
        dilemmaResponses: {},
        goodPrinciples: 0,
        badPrinciples: 0,
        completed: wasCompleted
    };
    
    // Reset AI purpose
    const aiPurpose = document.getElementById('aiPurpose');
    if (aiPurpose) aiPurpose.value = '';
    
    // Uncheck all ethics checkboxes
    document.querySelectorAll('.ethics-checkbox').forEach(cb => {
        cb.checked = false;
    });
    
    // Reset all safety feature buttons
    document.querySelectorAll('.safety-feature').forEach(button => {
        button.classList.remove('bg-blue-100', 'bg-gray-100', 'completed-action');
        button.disabled = false;
    });
    
    // Clear dilemma feedback
    for (let i = 1; i <= 3; i++) {
        const feedback = document.getElementById(`scenario${i}-feedback`);
        if (feedback) feedback.innerHTML = '';
    }
    
    // Clear charter inputs
    const missionStatement = document.getElementById('missionStatement');
    const keyValues = document.getElementById('keyValues');
    const rule1 = document.getElementById('rule1');
    const rule2 = document.getElementById('rule2');
    const rule3 = document.getElementById('rule3');
    const rule4 = document.getElementById('rule4');
    
    if (missionStatement) missionStatement.value = '';
    if (keyValues) keyValues.value = '';
    if (rule1) rule1.value = '';
    if (rule2) rule2.value = '';
    if (rule3) rule3.value = '';
    if (rule4) rule4.value = '';
    
    // Clear task 3 reflection textareas
    const textareas = document.querySelectorAll('#task3Reflection textarea');
    textareas.forEach(textarea => textarea.value = '');
    
    // Reset AI preview
    const aiIcon = document.getElementById('aiIcon');
    const aiName = document.getElementById('aiName');
    const aiDescription = document.getElementById('aiDescription');
    const ethicsScoreDisplay = document.getElementById('ethicsScoreDisplay');
    const ethicsProgressBar = document.getElementById('ethicsProgressBar');
    
    if (aiIcon) aiIcon.textContent = 'ü§ñ';
    if (aiName) aiName.textContent = 'Your Ethical AI';
    if (aiDescription) aiDescription.textContent = 'Design your AI to see preview';
    if (ethicsScoreDisplay) ethicsScoreDisplay.textContent = '0/8';
    if (ethicsProgressBar) ethicsProgressBar.style.width = '0%';
    
    updateAIPreview();
    updateEthicsDesign();
    
    saveProgress();
    showNotification('Task 3 reset!', 'info');
}

// ==================== CHART INITIALIZATION ====================
function initializeCharts() {
    // Only proceed if Chart.js is available
    if (typeof Chart === 'undefined') {
        console.log('Chart.js not loaded, skipping chart initialization');
        return;
    }
    
    try {
        // Initialize current data chart
        const currentDataCanvas = document.getElementById('currentDataChart');
        if (currentDataCanvas) {
            const ctx = currentDataCanvas.getContext('2d');
            window.currentDataChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Boys', 'Girls', 'Private Schools', 'Public Schools', 'Wealthy Areas', 'Other Areas'],
                    datasets: [{
                        data: [80, 20, 90, 10, 85, 15],
                        backgroundColor: [
                            '#ef4444', '#fca5a5',
                            '#ef4444', '#fca5a5', 
                            '#ef4444', '#fca5a5'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
        
        // Initialize new data chart
        const newDataCanvas = document.getElementById('newDataChart');
        if (newDataCanvas) {
            const ctx = newDataCanvas.getContext('2d');
            window.newDataChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Gender Balance', 'School Diversity', 'Geographic Diversity', 'Subject Variety'],
                    datasets: [{
                        data: [0, 0, 0, 0],
                        backgroundColor: [
                            '#10b981', '#34d399',
                            '#10b981', '#34d399'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
    } catch (error) {
        console.error('Error initializing charts:', error);
    }
}

function updateDataCharts() {
    // Check if chart exists and has been properly initialized
    if (window.newDataChart && window.newDataChart.data && window.newDataChart.data.datasets) {
        const dataValues = [];
        
        // Map good choices to chart segments
        if (task1Data.goodChoices.includes('gender-balance')) dataValues.push(25); else dataValues.push(0);
        if (task1Data.goodChoices.includes('all-schools')) dataValues.push(25); else dataValues.push(0);
        if (task1Data.goodChoices.includes('diverse-areas')) dataValues.push(25); else dataValues.push(0);
        if (task1Data.goodChoices.includes('all-subjects')) dataValues.push(25); else dataValues.push(0);
        
        window.newDataChart.data.datasets[0].data = dataValues;
        window.newDataChart.update();
    }
}

// ==================== DRAG AND DROP ====================
function initializeDragAndDrop() {
    const draggables = document.querySelectorAll('.draggable[draggable="true"]');
    const dropZones = document.querySelectorAll('.drop-zone');
    
    if (draggables.length === 0) return;
    
    // Desktop drag and drop
    draggables.forEach(draggable => {
        draggable.addEventListener('dragstart', function(e) {
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
            e.dataTransfer.setData('fair', this.dataset.fair || '');
            this.classList.add('dragging');
        });

        draggable.addEventListener('dragend', function(e) {
            this.classList.remove('dragging');
        });
    });

    dropZones.forEach(zone => {
        zone.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('drag-over');
        });

        zone.addEventListener('dragleave', function(e) {
            this.classList.remove('drag-over');
        });

        zone.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            
            const placeholder = this.querySelector('.text-gray-400');
            if (placeholder) {
                this.innerHTML = '';
            }
            
            const newItem = document.createElement('div');
            newItem.className = 'draggable bg-white p-2 rounded border-2 border-green-300 text-sm m-1 inline-block';
            newItem.innerHTML = e.dataTransfer.getData('text/html');
            newItem.dataset.fair = e.dataTransfer.getData('fair');
            this.appendChild(newItem);
            
            updateBiasMeter();
        });
    });
}

// ==================== MOBILE SUPPORT ====================
function initializeMobileSupport() {
    const draggables = document.querySelectorAll('.draggable');
    const dropZone = document.getElementById('fairDataset');
    
    if (draggables.length === 0 || !dropZone) return;
    
    draggables.forEach(draggable => {
        draggable.addEventListener('click', function() {
            if (gameState.selectedItem) {
                gameState.selectedItem.classList.remove('selected');
            }
            
            if (gameState.selectedItem === this) {
                gameState.selectedItem = null;
            } else {
                this.classList.add('selected');
                gameState.selectedItem = this;
            }
        });
    });
    
    dropZone.addEventListener('click', function() {
        if (gameState.selectedItem && !this.contains(gameState.selectedItem)) {
            const placeholder = this.querySelector('.text-gray-400');
            if (placeholder) {
                this.innerHTML = '';
            }
            
            const newItem = gameState.selectedItem.cloneNode(true);
            newItem.classList.remove('selected');
            this.appendChild(newItem);
            
            gameState.selectedItem.classList.remove('selected');
            gameState.selectedItem = null;
            
            updateBiasMeter();
        }
    });
}

function updateBiasMeter() {
    const dataset = document.getElementById('fairDataset');
    if (!dataset) return;
    
    const items = dataset.querySelectorAll('.draggable').length;
    const maxItems = 6;
    const fairness = (items / maxItems) * 100;
    const biasLevel = 100 - fairness;
    
    const biasMeter = document.getElementById('biasMeter');
    if (biasMeter) {
        biasMeter.style.left = biasLevel + '%';
    }
}

// ==================== COPY PROTECTION ====================
function setupCopyProtection() {
    document.addEventListener('copy', function(e) {
        if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
            e.preventDefault();
            showNotification('Copying is disabled for this lesson', 'warning');
        }
    });
    
    document.addEventListener('cut', function(e) {
        if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
            e.preventDefault();
            return false;
        }
    });
    
    document.addEventListener('paste', function(e) {
        if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
            e.preventDefault();
            showNotification('Paste is disabled. Please type your answer.', 'warning');
            return false;
        }
    });
    
    document.addEventListener('contextmenu', function(e) {
        e.preventDefault();
        return false;
    });
    
    document.addEventListener('keydown', function(e) {
        // Prevent Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
        if ((e.ctrlKey || e.metaKey) && (e.keyCode === 65 || e.keyCode === 67 || e.keyCode === 86 || e.keyCode === 88)) {
            if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                e.preventDefault();
                return false;
            }
        }
    });
}

// ==================== UTILITY FUNCTIONS ====================
function exportProgress() {
    const report = {
        student: 'Student Progress Report - AI Bias & Ethics',
        date: new Date().toLocaleDateString(),
        level: getLevel(),
        totalXP: gameState.totalXP,
        achievements: Object.keys(gameState.achievements).filter(a => gameState.achievements[a]),
        tasksCompleted: gameState.tasksCompleted,
        challengeScores: challengeState.challengeScores,
        principles: [
            document.getElementById('rule1')?.value,
            document.getElementById('rule2')?.value,
            document.getElementById('rule3')?.value,
            document.getElementById('rule4')?.value
        ].filter(p => p && p.trim()),
        timeSpent: Math.floor((Date.now() - gameState.sessionStartTime) / 60000) + ' minutes'
    };
    
    const reportText = JSON.stringify(report, null, 2);
    const blob = new Blob([reportText], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `AI_Ethics_Progress_${new Date().toISOString().split('T')[0]}.txt`;
    a.click();
    
    showNotification('Progress report exported!', 'success');
}

function updateDashboard() {
    const dashboardXP = document.getElementById('dashboardXP');
    const dashboardTasks = document.getElementById('dashboardTasks');
    const dashboardTime = document.getElementById('dashboardTime');
    
    if (dashboardXP) dashboardXP.textContent = gameState.totalXP;
    if (dashboardTasks) dashboardTasks.textContent = `${gameState.tasksCompleted}/10`;
    if (dashboardTime) {
        const timeSpent = Math.floor((Date.now() - gameState.sessionStartTime) / 60000);
        dashboardTime.textContent = `${timeSpent} min`;
    }
}

// Update dashboard periodically
setInterval(updateDashboard, 5000);
    </script>
</body>
</html>